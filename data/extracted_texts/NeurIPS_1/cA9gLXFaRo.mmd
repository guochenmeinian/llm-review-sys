# Instruction-Guided Visual Masking

Jinliang Zheng\({}^{*}\)\({}^{1,2}\), Jianxiong Li\({}^{*}\)\({}^{1}\), Sijie Cheng\({}^{1}\), Yinan Zheng\({}^{1}\),

**Jiaming Li\({}^{1}\), Jihao Liu\({}^{3,2}\), Yu Liu\({}^{2}\), Jingjing Liu\({}^{1}\)\({}^{1}\), Xianyuan Zhan\({}^{}\)\({}^{1,4}\) \({}^{1}\)** AIR, Tsinghua University, \({}^{2}\) Sensetime Research

\({}^{3}\) MMLab, CUHK, \({}^{4}\) Shanghai AI Lab

{zhengjl23, li-jx21}@mails.tsinghua.edu.cn

zhanxianyuan@mail.tsinghua.edu.cn

Equal contributionCorresponding author

###### Abstract

Instruction following is crucial in contemporary LLM. However, when extended to multimodal setting, it often suffers from misalignment between specific textual instruction and targeted local region of an image. To achieve more accurate and nuanced multimodal instruction following, we introduce _Instruction-guided Visual Masking_ (IVM), a new versatile visual grounding model that is compatible with diverse multimodal models, such as LMM and robot model. By constructing visual masks for instruction-irrelevant regions, IVM-enhanced multimodal models can effectively focus on task-relevant image regions to better align with complex instructions. Specifically, we design a visual masking data generation pipeline and create an IVM-Mix-1M dataset with 1 million image-instruction pairs. We further introduce a new learning technique, _Discriminator Weighted Supervised Learning_ (DWSL) for preferential IVM training that prioritizes high-quality data samples. Experimental results on generic multimodal tasks such as VQA and embodied robotic control demonstrate the versatility of IVM, which as a plug-and-play tool, significantly boosts the performance of diverse multimodal models, yielding new state-of-the-art results across challenging multimodal benchmarks. Code, model and data are available at [https://github.com/2toinf/IVM](https://github.com/2toinf/IVM).

## 1 Introduction

Multimodal instruction following is a fundamental multimodal task, powering a wide-range of applications such as visual question answering (VQA) , visual captioning , and embodied robotic control . To effectively solve this task, one critical capability required is nuanced image-language grounding, which current multimodal models grow implicitly and slowly through data-intensive end-to-end training without explicit grounding supervisions. Two challenges emerge in this indirect learning of image-instruction alignment: 1) How to accurately localize targeted image regions that corresponds to a specific textual instruction, as illustrated in Figure 1. \(2)\) How to generalize to diverse visual representations (_e.g._, same object with different colors, compositions, or backgrounds) that reflect similar textual instruction (e.g., Q3 in Figure 1). Lacking an effective and direct solution to these challenges, the most advanced Large Multimodal Models (LMMs)  still suffer from hallucinations even when trained with high-quality data in the magnitude of billions .

We introduce _Instruction-guided Visual Masking_ (IVM), a versatile plug-and-play model designed to enhance multimodal instruction following via nuanced surgical visual grounding. To eliminate the distraction of instruction-irrelevant visual regions, IVM automatically masks out these regions to sharpen the focus of instruction following, and meticulously crops visual input to tailor for a specificinstruction and enforce multimodal models to zoom in on task-related visual content. Existing visual grounding methods are limited either to predefined object categories, which cannot cover diverse instruction-related visual content; or they subscribe to a fixed instruction format, which restricts the expressiveness of instructions. As shown in Figure 2, such simplistic grounding techniques often fail to comprehend complex instruction-following tasks.

Learning an IVM model requires pixel-level, fine-grained, instruction-guided mask annotations that provide explicit grounding supervisions. To create such a dataset, we build a LLM-empowered Mixture of Expert pipeline with SOTA visual grounding models  to efficiently create abundant reliable labels. To compensate the noises in auto-generated labels, we further manually label a smaller dataset with clean annotations, and integrate the two into an IVM-Mix-1M dataset that contains 1 million image-instruction pairs.

Figure 1: The most advanced LMMs (e.g. GPT4-V) still fail on complex instruction following tasks. With IVM assistance to simplify visual inputs, existing LMMs can gain significant improvement.

Figure 2: Comparison between IVM and Reasoning Segmentation (RS) . Traditional methods such as semantic segmentation  and referring expression comprehension  are limited to fixed categories or fixed instruction formats, thus inapplicable to complex instruction following tasks. RS has reasoning ability, but only allows single object localization. IVM, instead, is universally applicable to any instruction.

To reduce demand on costly human labels and ensure optimized utility of machine-generated labels, we employ a Discriminator-Weighted Supervised Learning (DWSL) framework for IVM training, inspired by recent advances in offline imitation learning . Specifically, we introduce a discriminator to assign weights to masks, where high values are assigned to high-quality annotations and vice versa. Thus, these weights generated by the discriminator can naturally act as a weighting function for the IVM training objective, allowing for a preferential training process that prioritizes learning from reliable samples and discards misleading ones.

Extensive experiments demonstrate great versatility of the IVM model when integrated into existing multimodal chatbots (commercial and open-sourced) without fine-tuning. Our IVM-enhanced LMMs gain significant performance improvement across new challenging benchmarks such as V*Bench , EgoThink  and POPE , achieving new state of the art. IVM model also proves valuable in vision-language robotic manipulation tasks, where data collection is notoriously challenging and generalization is a major concern . With the integration of IVM, our enhanced robot model exhibits boosted performance and better generalization capabilities.

Our contributions are summarized as follows: \(1)\) We propose Instruction-guided Visual Masking (IVM), a novel approach that serves as a versatile plug-and-play module to enhance multimodal models through visual grounding. \(2)\) We introduce the IVM-Mix-1M dataset and propose an LLM-empowered Mixture of Expert pipeline to create visual grounding labels. \(3)\) We present the DWSL algorithm for IVM training that automatically prioritizes high-quality training samples.

## 2 Related Work

Large Multimodal Models. LLaVA  first demonstrates promising capabilities in following complex instructions. Subsequent works such as LLaVA-1.5 , MiniGPT4  Qwen-VL  and CogVLM , further enhance LMMs via refined model design and enriching the quality of training data, achieving state-of-the-art performance on diverse downstream tasks including visual grounding , visual reasoning , visual question and answering . Moreover, by integrating the robotics action modality, LMMs perform versatile planning and manipulation in instruction-driven robotics tasks. Notable studies in this line of inquiry include PaLM-E , the series of RT models , and text-guided video planning diffusion models . Despite the success, LMMs still struggle with complex visual grounding challenges, often misreading instruction-irrelevant visual contents (Figure 1). To address this, researchers have tried to adapt existing visual modules to higher-resolution images to obtain better perception , but with limited improvement.

Visual Grounding Tasks.Visual grounding requires precisely localizing image regions corresponding to a referring expression, among which the RefCOCO series  is the most well-known benchmark, and numerous public visual grounding data are available . Recently, LMMs incorporate these visual grounding data via visual-instruction tuning , establishing new SOTA in this area . To further broaden the reasoning ability of visual grounding, LISA  introduces a new task, reasoning segmentation, which demands higher capabilities in instruction comprehension. However, visual grounding is still limited to align simple instruction with specific objects, which cannot adapt to more complex instruction following tasks (_e.g._ Figure 2).

Visual Grounding Augmented LMMs.Recently, a series of visual grounding methods emerged to enhance the performance of LMMs in complex visual scenes. V*  employs a heuristic search strategy to search, locate, and crop image areas relevant to instructions through a multi-step iterative process. VisualCot  is trained end-to-end with a customized dataset to achieve target localization capabilities. These two methods allow LMMs to dynamically focus on visual inputs until the correct answer is derived. However, these complex inference pipelines lead to substantial computational overhead, and their heuristic designs further hinder the extension beyond VQA to other multimodal instruction following tasks such as robotic control.

Besides these explicit strategies incorporating additional visual grounding modules, other studies pursue refining data or introducing extra training targets to enhance the grounding capabilities of LMMs implicitly. ViGor  proposes a fine-grained reward modeling to enhance visual grounding of LMMs, and SynGround  introduces a pragmatic framework for image-text-box synthesis tailored for visual grounding. These methods, however, are primarily focused on the visual grounding task itself, overlooking its influence on downstream multimodal instruction following tasks.

Distinct from previous efforts, this paper introduces a generic visual grounding model that is adaptable to any multimodal instruction following tasks, and provides a systematic investigation into the advantages of integrating an additional visual grounding model into downstream applications.

## 3 Instruction-Guided Visual Masking

To help multimodal models focus on instruction-sensitive image regions without distractions from irrelevant visual elements, we introduce Instruction-guided Visual Masking (IVM), a versatile plug-and-play model that enhances multimodal instruction following via surgical targeted visual grounding.

### Problem Definition

IVM aims to produce a heatmap \(\), given an image \(_{}\) and a textual instruction \(_{}\). The heatmap \(\) identifies the critical image region to follow the instructions, as illustrated in Figure 3, allowing multimodal models to easily zoom in on targeted image regions while ignoring neighboring areas.

This formulation evokes the problem definition of Reasoning Segmentation (RS) . There are two main differences: 1) IVM addresses a more challenging problem. RS tries to target single objects from simple instructions, _e.g._, "what is..., where is.., who is...", while IVM aims to include all instruction-related visual regions within the image given any instruction, which demands advanced and nuanced image-language grounding ability (as illustrated in Figure 2). 2) RS has clear ground truths but IVM does not. The instructions in RS primarily correspond to simple and semantic-meaningful objects that are straightforward for human annotations. IVM, however, deals with broader and more ambiguous instruction-related regions (_e.g._, the left bank regions in Figure 3), making the training and annotating much more challenging.

### Data Preparation

To train an IVM model, the first main challenge is the scarcity of training data. Most existing Visual Grounding (VG) datasets [64; 31] typically feature simple instructions focused primarily on prominent objects within images, lacking both diversity and complexity required for IVM. To tackle this, we

Figure 4: LLM-empowered Mixture-of-Expert pipeline for auto-annotation. (1) For labeled VG data, we utilize an LLM to generate complex instruction annotations. (2) For unlabeled VIF or robot data, we first use an LLM to simplify the instruction and then leverage a mixture of VG models to generate candidate labels.

Figure 3: Instruction-guided Visual Masking.

compiled one million data from various sources, including labeled visual grounding, unlabeled multi-modal instruction following, and robotics data. As outlined in Section 3.1, scaling human annotations is challenging due to the high complexity of such data. Therefore, we introduce an _LLM-empowered Mixture of Expert pipeline_ that integrates SOTA visual grounding models to efficiently generate reliable annotations. We further manually annotate a smaller dataset to compensate inaccuracies in auto-generated labels. The resulted combined dataset, IVM-Mix-1M, comprises one million data samples ready for IVM training, which can be found in [https://github.com/2toinf/IVM](https://github.com/2toinf/IVM).

**LLM-empowered Mixture of Expert Annotation Pipeline.** Leveraging the power of LLM, this pipeline can efficiently generate high-quality annotation, which consists of two components (Figure 4): \(1)\)_Labeled visual grounding data._ We collect 250K labeled _VG_ data from multiple sources including VG caption , Flickr30K , VSR , OpenImage , and RefCoCo , which provide bounding boxes with simple instructions for each image. To increase the diversity and complexity of instructions, we utilize GPT-4 , known for its robust language understanding and generation capabilities, to create diverse instruction-answer pairs based on existing language instructions. \(2)\)_Unlabeled Visual-Instruction-Following (VIF) and robotics data._ We sample a 700K subset from LLaVA-Instruction-tuning  for VQA-type data, and a 50K subset from OpenX  for robotics data. Given that these data lack grounded labels but contain complex instructions, we use GPT-4 to simplify the language instructions by prompting it to infer the names of targeted objects necessary for following the instructions. These simplified instructions then guide existing VG models to generate candidate labels. To ensure the quality of these labels and compensate for the ambiguous nature of the IVM task, we integrate proposals from several _VG_ experts, such as Grounding-Sam , LISA , AlphaClip , and OwlViT , via an ensemble approach.

**Manual Annotation**. Despite integrating the most advanced models, the auto-generation design still faces challenges that can lead to data inaccuracies. First, employing LLM to simplify or complicate language annotations without considering image content can introduce uncontrollable biases. Second, as the task exceeds the capabilities of existing models, it becomes impossible to totally exclude low-quality annotations that contain irrelevant visuals or mistakenly filter out critical contents. Thus, to enhance the overall quality of the dataset, we further manually annotate a 10K subset of the constructed dataset to inject human expert knowledge.

**Data Analysis**. Here, we provide quantitative analysis on the IVM-Mix-1M dataset. Figure 5 depicts the data quantities w.r.t the percentage of annotated instruction-related image area. Here, each ratio range is further categorized by different data sources, where manually annotations are treated as a separate category (Human), while all others are machine-generated. Our analysis reveals that the instruction-related image regions only occupy a small fraction of the total image area (_e.g._ most data have less than 40% instruction-relevant image regions), indicating that most visual contents may cause distraction and corroborating the necessity of visual masking for instruction following tasks.

### Discriminator-Weighted Supervised Learning Framework

The challenge now is to train the IVM model with a small high-quality human-annotated dataset (\(_{e}\)) as well as a large but mixed-quality auto-generated dataset (\(_{o}\)). Training naively on the combined dataset may yield suboptimal results due to inaccuracies in auto-generated labels, while solely using limited human-annotated data is insufficient. Inspired by recent advances in imitation learning using mixed-quality data , we employ a Discriminator-Weighted Supervised Learning (DWSL) framework to effectively leverage the strengths of both auto- and human-annotated data.

**Discriminator Training**. Specifically, we introduce a discriminator \(d\) optimized by Eq. (1) to assign high weights to high-quality annotations and vice versa:

\[_{d}_{(_{},_{},)_{e}}[- d(_{},_{ },)]+_{(_{},_{},)_{o}}[-(1-d(_{ },_{},))], \]

Figure 5: Data analysis on the IVM-Mix-1M dataset: data quantity v.s percentage of instruction-related areas.

where \((_{ img},_{ txt},)\) are image-instruction-heatmap pairs sampled from \(_{o}\) and \(_{e}\) datasets. Eq. (1) is similar to the one in GAN , but the "fake" data in  is replaced by machine-generated data from \(_{o}\). After training with Eq. (1), the discriminator \(d\) assigns high weights to high-quality human-annotated data from \(_{e}\) and relatively high values to similarly high-quality data from \(_{o}\) that aligns with human preferences, acting as a judge for annotation quality.

**Discriminator-weighted IVM Training**. Then, we apply the trained discriminator as a weighting function for the IVM training objective:

\[_{} _{(_{ img},_{ txt}, )_{o}_{e}}[f(d(_{ img}, _{ txt},))_{}^{ IVM}(_{ img},_{ txt},)], \] \[_{}^{ IVM}(_{ img},_{  txt},)=_{ bce}(}_{}, )+_{ dice}(}_{},), \]

where \(_{ bce}\) and \(_{ dice}\) are set to 1.0 and 1.0 to balance the binary cross-entropy loss (\(\)) and the DICE loss for segmentation (\(\)) , respectively. \(f(x) 0\) can be any non-negative, non-decreasing function. For simplicity, we set \(f(x):=((0.1,x),1)\). This allows the weighting function \(f(d())\) in Eq. (2) to dynamically prioritize training with high-quality data determined by the discriminator \(d\). This approach maximizes the usage of reliable annotations in \(_{o}\) to compensate for the small \(_{e}\), while minimizing the impact of low-quality data in \(_{o}\), thus optimizing performance.

### Model Architecture

The overall model framework is illustrated in Figure 6. Due to its complexity, IVM requires both reasoning and precise localization of the target object, closely paralleling reasoning segmentation . Consequently, for the heatmap generator, we adopt a model design similar to that of LISA . Specifically, we first extract dense image features using an isolated vision backbone and multimodal representation from an LMM, which processes image-instruction pairs. These two types of features are then fed into a lightweight generator that integrates them to produce a dense prediction.

Figure 6: **IVM model architecture and training pipeline.** Stage I: A LoRA-tuned LMMs is trained to discriminate human- and machine-annotated data. Stage II: A frozen SAM vision backbone and a LoRA-tuned LMMs are utilized to extract dense image features and multimodal representations, respectively. These features are then fed into a generator for dense prediction and is trained via DWSL. Same color represents the same model. See Appendix C.1 for more details.

[MISSING_PAGE_FAIL:7]

### Main Results

**Integration with Commercial Chatbot**. We use GPT4-V  as the base model. Considering the superior perception and reasoning capability of GPT4-V, we evaluate IVM-enhanced GPT4-V on V*bench , a recently proposed challenging VQA-type benchmark characterized by images with abundant redundancies. Results are presented in Table 1. The accuracy of the vanilla GPT4-V is mediocre (55.0%). Our IVM model, however, can significantly improve the performance (+26.2%) and establish a new state of the art on this benchmark, even surpassing the task-specialized SEAL  that requires a complex heuristic visual search pipeline.

**Integration with Open-sourced LMMs**. To demonstrate the versatility of our IVM model, we further integrate it into an open-sourced LMM, LLaVA-7B . We conduct extensive experiments across various benchmarks, including EgoThink , POPE , MME , GQA , SQA , and VQAv2 . As shown in Table 2, our IVM-enhanced LLava-7B gains consistent performance improvements, achieving comparable performance to (even surpassing) LLaVA-13B on EgoThink, POPE and MME. Although IVM-enhanced LLaVA-7B and LLaVA-13B  have roughly the same number of parameters, the latter integrates more powerful pretrained foundation models. In contrast, our IVM model allows the 7B model to outperform the 13B model by merely simplifying visual input, further validating the power of visual masking.

Meanwhile, IVM-enhanced LLaVA-7B does not show significant gains on GQA, SQA and VQAv2, which is expected, as these benchmarks do not heavily rely on grounding capabilities: VQAv2 and GQA contain relatively simple visual input where most regions of the images are instruction-relevant, while SQA primarily focuses on assessing model reasoning capability.

**Comparison with Reasoning Segmentation Model**. We also compare against LISA , which is most analogous to IVM. We provide carefully tailored prompts like _"what should we focus on the image to follow the given instruction? Give me the seg"_ to extend LISA into visual masking task. However, even with larger 13B model and extensive tuning of input prompt, masks generated by LISA consistently result in severe performance degradation on all tasks.

**Evaluation on Real Robotic Control**. We also plug the IVM model into robot control tasks to help robot model improve generalization. Specifically, we evaluate a language-conditioned behavior cloning (LCBC) robot agent trained with or without IVM masked images. Figure 9 clearly demonstrates that without IVM assistance, the LCBC robot agent suffers from severe performance drop when noticeable distractions are applied. With IVM assistance, however, the agent consistently pays close attention to correct instruction-related image regions, performing robustly against diverse distractions such as human disturbances and numerous task-irrelevant objects of various colors and shapes. This demonstrates promising potentials of using IVM to enhance embodied agents to follow complex instructions in unseen scenes with plenty distractions.

### Ablation

We ablate the key components of IVM and report overall accuracy improvement(%) of IVM-Enhanced GPT4-V, evaluated on V* bench  due to its high demand on precise visual grounding abilities.

**Training Data**. We investigate the impact of IVM-Mix data characteristics on IVM performance from two key perspectives: \(1)\) Large machine-annotated data volume clearly enhances IVM model performance, as illustrated by the progressive improvement in Figure 10 (a) with increased machine-annotated data volume (red, blue and yellow line). This demonstrates the effectiveness of our proposed LLM-empowered Mixture-of-Expert pipeline in generating reliable data for IVM training. \(2)\) Figure 10 (a) also reveals that incorporating human annotations significantly boosts training

  
**LMMs** & \#Param & EgoThink & POPE & MME* & GQA & SQA & VQAv2 \\  InstructBLIP  & 13B & - & 78.9 & 1212.8 & 49.5 & 60.5 & - \\ Qwen-7B  & 7B & - & - & - & 58.3 & 67.1 & 78.8 \\ SEAL-7B  & 7B & - & 82.4 & 1129 & - & - & - \\ LLaVA-7B  & 7B & 51.1 & 85.9 & 1748 & 62.0 & 70.2 & 78.5 \\ LLaVA-13B  & 13B & 55.2 & 85.9 & 1834 & 67.1 & 71.6 & 80.0 \\   LISA -Enhanced LLaVA-7B & 20B & 47.9 (-3.2) & 80.0 (-5.9) & 1560 (-188) & 56.6 (-5.4) & 69.3 (-0.9) & 78.2 (-0.3) \\
**IVM-Enhanced LLaVA-7B** & 14B & **54.5 (+3.4)** & **87.2 (+1.3)** & **1806 (+58)** & 62.2 (+0.2) & **70.2 (-c)** & **79.0 (+0.5)** \\   

Table 2: Results on other multimodal benchmarks. MME* denotes the aggregate of scores from -p and -c.

efficiency (red and blue _v.s_ yellow line), highlighting the critical role of introducing human preferences in IVM-Mix-1M dataset, despite its relatively small volume compared to machine-annotated data (only 1:100).

**DWSL Framework.** We also explore the efficacy of the DWSL framework in Figure 10 (a) by comparing IVM training using: \(1)\) DWSL (red line), \(2)\) traditional Supervised Learning (SL) without DWSL (blue line), and \(3)\) SL on limited human data (gray line). The results demonstrate that DWSL effectively leverages both human- and auto-annotated data, particularly as the volume of machine-annotated data increases, enjoying higher asymptotic performances. This is expected as machine-annotated data often contain inaccuracies and training naively using all these data can lead to suboptimal results. Meanwhile, the limited human data alone cannot provide satisfactory outcomes. DWSL, however, addresses these challenges by dynamically prioritizing good samples and discarding misleading ones, resulting in stable and improved results. This is further illustrated in Figure 10 (b) which visualizes the outputs of the discriminator for each sample, where the discriminator can correctly retain good samples (e.g. Human) and filter out low-quality data with lower weights.

Figure 9: Real robot results with or without IVM assistance. IVM greatly helps LCBC agent to overcome major distractions, enjoying better robustness and generalization. See Appendix C.4 for experiment setups.

**Mask Deployment Strategy**. We investigate the impact of mask deployment strategy on downstream applications. While more complex solutions such as visual search algorithms  can be employed, our investigation focuses solely on simpler approaches to understand the intrinsic capabilities of IVM model. Specifically, we examine four basic masking methods: overlay, blur, grayscale, and cropping, as illustrated in Figure 11. In particular, for the crop method, we find the smallest area that retains all the activated (>0) values in the heatmap and crop it. Table 3 demonstrates that IVM maintains robustness across all simple post-processing methods, where overlay+crop enjoys the most performance enhancement and thus is used as our default mask deployment method.

## 5 Conclusion

We introduce Instruction-guided Visual Masking (IVM), a generic and powerful visual grounding method that enhances broad multimodal instruction following tasks in a plug-and-play way. By masking out all instruction-irrelevant image regions, IVM effectively injects superior visual grounding ability to downstream LMMs non-intrusively, significantly boosting both commercial and open-sourced LMMs and achieving state-of-the-art results across numerous challenging multimodal benchmarks. Real robot experiments further demonstrate the versatility of IVM, showcasing the potential to deploy IVM to embodied robotic tasks where failures caused by distractions are long-standing challenges. For further improvement, one promising direction is to finetune LMMs using IVM-generated heatmap as an additional input channel to reduce suboptimal heuristics caused by mask deployment methods. Due to resource limitation, we leave this for future work. We open source the IVM checkpoint and the IVM-Mix-1M dataset to help the community further explore relevant directions1. More discussion on limitations and future directions can be found in Appendix A.

## 6 Acknowledgements

The paper is supported by funding from Wuxi Research Institute of Applied Technologies, Tsinghua University under Grant 20242001120. The authors would like to thank the anonymous reviewers for their feedback on the manuscripts.

Figure 11: Different mask deployment methods.

    & Overlay & Blur & Gray-scale \\  w/ crop & **+26.2** & +24.4 & +22.1 \\ w/o & +19.1 & +17.2 & +10.2 \\   

Table 3: Ablations on different mask deployment methods on the V*bench.

Figure 10: Ablations on training data and the proposed DWSL framework.