# Intervention Generalization:

A View from Factor Graph Models

 Gecia Bravo-Hermsdorff1  David S. Watson2  Jialin Yu1  Jakob Zeitler3  Ricardo Silva1

###### Abstract

One of the goals of causal inference is to generalize from past experiments and observational data to novel conditions. While it is in principle possible to eventually learn a mapping from a novel experimental condition to an outcome of interest, provided a sufficient variety of experiments is available in the training data, coping with a large combinatorial space of possible interventions is hard. Under a typical sparse experimental design, this mapping is ill-posed without relying on heavy regularization or prior distributions. Such assumptions may or may not be reliable, and can be hard to defend or test. In this paper, we take a close look at how to warrant a leap from past experiments to novel conditions based on minimal assumptions about the factorization of the distribution of the manipulated system, communicated in the well-understood language of factor graph models. A postulated _interventional factor model_ (IFM) may not always be informative, but it conveniently abstracts away a need for explicitly modeling unmeasured confounding and feedback mechanisms, leading to directly testable claims. Given an IFM and datasets from a collection of experimental regimes, we derive conditions for identifiability of the expected outcomes of new regimes never observed in these training data. We implement our framework using several efficient algorithms, and apply them on a range of semi-synthetic experiments.

## 1 Introduction

Causal inference is a fundamental problem in many sciences, such as clinical medicine  and molecular biology . For example, causal inference can be used to identify the effects of chemical compounds on cell types  or determine the underlying mechanisms of disease .

One particular challenge in causal inference is _generalization_ -- the ability to extrapolate knowledge gained from past experiments and observational data to previously unseen scenarios. Consider a laboratory that has performed several gene knockouts and recorded subsequent outcomes. Do they have sufficient information to predict how the system will behave under some new combination(s) of knockouts? Conducting all possible experiments in this setting would be prohibitively expensive and time consuming. A supervised learning method could, in principle, map a vector representation of the design to outcome variables of interest. However, past experimental conditions may be too sparsely distributed in the set of all possible assignments, and such a direct supervised mapping would require leaps of faith about how assignment decisions interact with the outcome, even if under the guise of formal assumptions such as linearity.

In this paper, we propose a novel approach to the task of _intervention generalization_, i.e., predicting the effect of unseen treatment regimes. We rely on little more than a postulated factorization of thedistribution describing how intervention variables \(\) interact with a random process \(X\), and a possible target outcome \(Y\).

Related setups appear in the causal modeling literature on soft interventions , including its use in methods such as causal bandits  and causal Bayesian optimization  (see Section 6). However, these methods rely on directed acyclic graphs (DAGs), which may be hard to justify in many applications. Moreover, in the realistic situation where the target of a real-world intervention is a _set_ of variables  and not only the "child" variable within a DAG factor, the parent-child distinction is blurred and previous identification results do not apply. Without claiming that our proposal is appropriate for every application, we suggest the following take on intervention generalization: _model a causal structure as a set of soft constraints, together with their putative (arbitrary but local) modifications by external actions._ Our interventional factor model_ (IFM) leads to provable intervention generalization via a factor graph decomposition which, when informative, can be tested without further assumptions beyond basic relations of conditional independence. IFMs are fully agnostic with regards to cycles or hidden variables, in the spirit of Dawid 's decision-theoretic approach to causal inference, where the key ingredient boils down to statements of conditional independence among random and intervention variables.

Our primary contributions are as follows. (1) We introduce the _interventional factor model_ (IFM), which aims to solve intervention generalization problems using only claims about which interventions interact with which observable random variables. (2) We establish necessary and sufficient conditions for the identifiability of treatment effects within the IFM framework. (3) We adapt existing results from conformal inference to our setting, providing distribution-free predictive intervals for identifiable causal effects with guaranteed finite sample coverage. (4) We implement our model using efficient algorithms, and apply them to a range of semi-synthetic experiments.

## 2 Problem Statement

Data assumptions.Fig. 1**(a)** illustrates a generative process common to many applications and particularly suitable to our framework: a perturbation, here represented by a set of interventional variables \(\), is applied and a dynamic feedback loop takes place. Often in these applications (e.g, experiments in cell biology  and social science ), the sampling of this process is highly restrictive, and the time-resolution may boil down to a single _snapshot_, as illustrated by Fig. 1**(b)**. We assume that data is given as samples of a random vector \(X\) collected cross-sectionally at a well-defined time-point (not necessarily at equilibrium) under a well-defined intervention vector \(\). The importance of establishing a clear sampling time in the context of graphical causal models is discussed by . The process illustrated in Fig. 1**(a)** may suggest no particular Markovian structure at the time the snapshot is taken. However, in practice, it is possible to model the black-box sampling process represented in Fig. 1**(b)** in terms of an _energy function_ representing soft constraints . These could be the result of particular equilibrium processes , including deterministic differential equations , or empirically-verifiable approximations .

_The role of a causal model is to describe how intervention \(\) locally changes the energy function._ In the context of causal DAG models, sometimes this takes the guise of "soft interventions" and other variations that can be called "interventions on structure"  or edge interventions . Changes of structural coefficients in possibly cyclic models have also been considered . The model family we propose takes this to the most abstract level, modeling energy functions via recombinations of

Figure 1: **(a)** A dynamic process where only the final step is (simultaneously) observed. Intervention variables are represented as white squares, random variables as circles, and dashed lines indicate hidden variables. **(b)** A birdâ€™s eye unstructured view of the sampling process, where an intervention vector dictates \(\) the distribution obtained at an agreed-upon time frame \(T\).

local interventional effects without acyclicity constraints, as such constraints should not be taken for granted  and are at best a crude approximation for some problems at hand (e.g., ).

Background and notation.The notion of an _intervention variable_ in causal inference encodes an action that modifies the distribution of a system of random variables. This notion is sometimes brought up explicitly in graphical formulations of causal models . To formalize it, let \(\) denote a vector of intervention variables (also known as _regime indicators_), with each \(_{i}\) taking values in a finite set \(\{0,1,2,,_{i}-1\}\). A fully specified vector of intervention variables characterizes a _regime_ or an _environment_ (we use these terms interchangeably). Graphically, we represent intervention variables using white squares and random variables using circles (Fig. 2). We use subscripts to index individual (random or interventional) variables and superscripts to index regimes. For instance, \(X_{i}^{j}\) denotes the random variable \(X_{i}\) under regime \(^{j}\), while \(_{i}^{j}\) denotes the \(i\)th intervention variable of the \(j\)th environment. (Note that the order of the variables is arbitrary.) We occasionally require parenthetical superscripts to index samples, so \(x_{i}^{(k)}\) denotes the \(k\)th sample of \(X_{i}\) under regime \(^{j}\).

For causal DAGs, Pearl's \(do\) operator  denotes whether a particular random variable \(X_{i}\) is manipulated to have a given value (regardless of the values of its parents). As an example, consider a binary variable \(X_{i}\{True,False\}\). We can use a (categorical) intervention variable \(_{i}\) to index the two "do-interventional" regimes: \(_{i}=1\) denotes "\(do(X_{i}=True)\)", and \(_{i}=2\) denotes "\(do(X_{i}=False)\)." We reserve \(_{i}=0\) to denote the choice of "no manipulation", also known as the "observational" regime. However, one need not think of this \(_{i}=0\) setting as fundamentally different than the others; indeed, it is convenient to treat all regimes as choices of data generating process.4 Moreover, there is no need for intervention variables to correspond to deterministic settings of random variables; they may in principle describe any well-defined change in distribution, such as stochastic or conditional interventions . As a stochastic example, \(_{i}=3\) could correspond to randomly choosing \(do(X_{i}=True)\) 30% of the time and \(do(X_{i}=False)\) 70% of the time. As a conditional example, \(_{i}=4\) could mean "if parents of \(X_{i}\) satisfy a given condition, \(do(X_{i}=True)\), otherwise do nothing". When \(X_{i}\) can take more values, the options for interventional regimes become even more varied. The main point to remember is that \(_{i}=1,_{i}=2,\) should be treated as distinct categorical options, and we reserve \(_{i}=0\) to denote the "observational" case of "no manipulation".

As discussed in the previous section, the probability density/mass function \(p(x;)\) can be the result of a feedback process that does not naturally fit a DAG representation. Indeed, a growing literature in causal inference carefully considers how DAGs may give rise to equilibrium distributions (e.g., ), or marginals of continuous-time processes (e.g., ). However, they come with considerable added complexity of assumptions to ensure identifiability. In this work, we abstract away all low-level details about how an equilibrium distribution comes to be, and instead require solely a model for how a distribution \(p(x)\) factorizes as a function of \(\). These assumptions are naturally formulated as a factor graph model  augmented with intervention variables, which we call an _interventional factor model_ (_IFM_).

Figure 2: Examples of distinct causal graphical models, expressing different factorization assumptions. Random variables are represented as circles, intervention variables as white squares, and factors as black squares. **(a)** A directed acyclic graph (DAG) with explicit intervention variables. **(b)** The corresponding interventional factor model (IFM) for **(a)**. **(c)** A Markov random field (MRF) with interventional variables, thus, forming a chain graph.

Problem statement.We are given a space \(\) of possible values for an intervention vector \(\) of dimension \(d\), making \(||_{i=1}^{d}_{i}\). For a range of training regimes \(_{}\), we are given collection of datasets \(^{1},^{2},,^{t}\), with dataset \(^{j}\) collected under environment/regime \(^{j}_{}\). The goal is to learn \(p(x;^{})\), and \((^{}):=[Y;^{}]\), for all test regimes \(^{}_{}=_{}\).

In each training dataset, we measure a sample of post-treatment i.i.d. draws of some \(m\)-dimensional random vector \(X\) (possibly with \(m d\), as there is no reason to always assume a one-to-one mapping between intervention and random variables), and optionally an extra outcome variable \(Y\). The data generating process \(p(x;^{j})\) is unknown. We assume \(Y\!\!\! X\) for simplicity5, which holds automatically in cases where \(Y\) is a known deterministic summary of \(X\). We are also given a factorization of \(p(x;)\),

\[p(x;)_{k=1}^{l}f_{k}(x_{S_{k}};_{F_{k}}),\; , \]

where \(S_{k}[m]\) and \(F_{k}[d]\) define the causal structure. The (positive) functions \(f_{k}(;)\) are unknown. The model \(p(y x)\) can also be unknown, depending on the problem.

As illustrated in Figs. 2**(a-b)**, such an intervention factor model (IFM) can also encode (a relaxation of) the structural constraints implied by DAG assumptions. In particular, note the one-to-one correspondence between the DAG factorization in Fig. 2**(a)** and the factors in the IFM in Fig. 2**(b)**: \(f_{1}(x_{1};_{1}):=p(x_{1};_{1})\), \(f_{2}(x_{1},x_{2};_{2}):=p(x_{2} x_{1};_{2})\), and \(f_{3}(x_{1},x_{2},x_{3};_{3}):=p(x_{3} x_{1},x_{2};_{3})\). This explicitly represents that the conditional distribution of \(x_{1}\) given all other variables fully factorizes in \(\): i.e., \(p(x_{1} x_{2},x_{3};) f_{1}(x_{1};_{1})f_{2}(x_{1},x_{2 };_{2})f_{3}(x_{1},x_{2},x_{3};_{3})\). Such factorization is not enforced by usual parameterizations of Markov random fields (i.e., graphical models with only undirected edges) or chain graphs (graphical models with acyclic directed edges and undirected edges)  such as the example shown in Fig. 2**(c)**.

Scope and limitations.The factorization in Eq. (1) may come from different sources, e.g., from knowledge about physical connections (it is typically the case that one is able to postulate which variables are directly or only indirectly affected by an intervention), or as the result of structure learning methods (e.g., ). For structure learning, faithfulness-like assumptions  are required, as conditional independencies discovered under configurations \(_{}\) can only be extrapolated to \(_{}\) by assuming that independencies observed over particular values of \(\) can be generalized across all regimes. We do not commit to any particular structure learning technique, and refer to the literature on eliciting and learning graphical structure for a variety of methods . In Appendix A, we provide a general guide on structure elicitation and learning, and a primer on causal modeling and reasoning based solely on abstract conditional independence statements, without a priori commitment to a particular family of graphical models .

Even then, the structural knowledge expressed by the factorization in Eq. (1) may be uninformative. Depending on the nature of \(_{}\) and \(_{}\), it may be the case that we cannot generalize from training to test environments, and \(p(x;^{})\) is unidentifiable for all \(^{}_{}\). However, all methods for causal inference rely on a trade-off between assumptions and informativeness. For example, unmeasured confounding may imply no independence constraints, but modeling unmeasured confounding is challenging, even more so for equilibrium data without observable dynamics. If we can get away with pure factorization constraints implied by an array of experimental conditions and domain knowledge, we should embrace this opportunity. This is what is done, for instance, in the literature on causal bandits and causal Bayesian optimization , which leverage similar assumptions to decide what to do next. However, we are _not_ proposing a method for bandits, Bayesian optimization, or active learning. The task of estimating \(p(x;^{})\) and \((^{})\) for a novel regime is relevant in itself.

## 3 Interventional Factor Model: Identification

We define our _identification problem_ as follows: given the _population_ distributions \((_{}):=\{p(x;^{1}),p(x;^{2}),, p(x;^{t})\}\) for the training regimes \(^{j}_{}\), and knowledge of the factorization assumptions as given by Eq. (1), can we identify a given \(p(x;^{})\) corresponding to some unobserved test regime \(^{}_{}\)?This identification problem is not analyzed in setups such as causal Bayesian optimization , which build on DAGs with interventions targeting single variables. Without this analysis, it is unclear to what extent the learning might be attributed to artifacts due to the choice of prior distribution or regularization, particularly for a sparsely populated \(_{}\). As an extreme case that is not uncommon in practice, if we have binary intervention variables and never observe more than one \(_{i}\) set to \(1\) within the same experiment, it is unclear why we should expect a non-linear model to provide information about pairs of assignments \(_{i}=_{j}=1\) using an off-the-shelf prior or regularizer. Although eventually a dense enough process of exploration will enrich the database of experiments, this process may be slow and less suitable to situations where the goal is not just to maximize some expected reward but to provide a more extensive picture of the dose-response relationships in a system. While the smoothness of \(p(x;)\) as a function of \(\) is a relevant domain-specific information, it complicates identifiability criteria without further assumptions. In what follows, we assume no smoothness conditions, meaning that for some pair \(p(x;^{a}),p(x;^{b})\), with \(a b\), these probability density/mass functions are allowed to be arbitrarily different. Such setting is particularly suitable for situations where interventions do take categorical levels, with limited to no magnitude information.

Identification: preliminaries.Before introducing the main result of this section, let us start by considering the toy example displayed in Fig. 3: Fig. 3(**a**) shows the graphical model (how \(X\) could be factorized is not relevant here), and Fig. 3(**c**) shows the assignments for the training regimes \(_{}\) (all intervention variables are binary). This training set lacks the experimental assignment \(_{1}=_{2}=_{3}=1\).6 However, this regime is implied by the model and \(_{}\). To see this, consider the factorization \(p(x;) f_{1}(x;_{1},_{2})f_{2}(x;_{2},_{3})\), it implies:

where we used \((1,1,0)\) etc. to represent the \(\) assignments. Because both \((1,1,0)\) and \((0,1,0)\) are in \(_{}\), the ratio is identifiable up to a multiplicative constant. Moreover, multiplying and dividing the result by \(f_{2}x;(1,1)\), we get:

from which, given that \((0,1,1)\) is also in \(_{}\), we can derive \(px;(1,1,1)\).

### Message Passing Formulation

The steps in this reasoning can be visualized in Fig. 3(**b**). The leftmost _hypervertex_ represents \((_{1},_{2})\) and suggests \(_{1}\) can be isolated from \(_{3}\). The first ratio \(px;(1,1,0)/px;(0,1,0)\) considers three roles: \(_{1}\) can be isolated (it is set to a "baseline" of \(0\) in the denominator) and \(_{3}\) is yet to be considered (it is set to the baseline value of \(0\) in the numerator). This ratio sets the stage for the next step where \((_{2},_{3})\) is "absorbed" in the construction of the model evaluated at \((1,1,1)\). The entries in \(_{}\) were chosen so that we see all four combinations of \((_{1},_{2})\) and all four combinations of

Figure 3: **(a)** An interventional factor model (IFM) with three (binary) intervention variables. **(b)** The junction tree of the \(\)-_graph_ associated with the IFM in **(a)**: intervention variables are arranged as a hypergraph, where the hypervertices represent the sets of intervention variables that share a factor and the edge represents the overlap between the two sets of intervention variables. **(c)** A table displaying the assignments for regimes in \(_{}\). From this \(_{}\) and the assumptions in **(a)**, it is possible to generalize to the two missing regimes, i.e., \(_{1}=_{2}=_{3}=1\), and \(_{1}=_{3}=1\), \(_{2}=0\).

\((_{2},_{3})\), while avoiding the requirement of seeing all eight combinations of \((_{1},_{2},_{3})\). How to generalize this idea is the challenge. Next, we present our first proposed solution.

Definitions.Before we proceed, we need a few definitions. First, recall that we represent the _baseline_ (or "observational") regime as \(_{1}=_{2}==_{d}=0\). This describes data captured under a default protocol, e.g., a transcriptomic study in which no genes are knocked down. Let \(^{0}_{[]}\) denote the set of all environments \(^{j}\) such that \(^{j}_{i}=0\) if \(i Z\). For instance, for the example in Fig. 3, a set \(Z:=\{2\}\) implies that \(^{0}_{[]}=(0,0,0),(0,1,0)}\). Finally, let \(^{[Z()]}\) be the intervention vector given by \(_{i}=^{}_{i}\), if \(i Z\), and \(0\) otherwise. In what follows, we also use of the concepts of graph _decompositions_, _decomposable graphs_ and _junction trees_, as commonly applied to graphical models . In Appendix B, we review these concepts.7 An IFM \(\) with intervention vertices \(_{1},,_{d}\) has an associated \(\)_-graph_ denoted by \(_{()}\), defined as an undirected graph with vertices \(_{1},,_{d}\), and where edge \(_{i}-_{j}\) is present if and only if \(_{i}\) and \(_{j}\) are simultaneously present in at least one common factor \(f_{k}\) in \(\). For example, the \(\)-graph of the IFM represented in Fig. 3**(a)** is \(_{1}-_{2}-_{3}\). This is a decomposable graph with vertex partition \(A=\{_{1}\}\), \(B=\{_{2}\}\) and \(C=\{_{3}\}\). As this \(\)-graph is an undirected decomposable graph, it has a junction tree, which we depict in Fig. 3**(b)**.

Identification: message passing formulation.Let \(\) be an IFM representing a model for the \(m\)-dimensional random vector \(X\) under the \(d\)-dimensional intervention vector \(\). Model \(\) has unknown factor parameters but a known factorization \(p(x;)_{k}f_{k}(x_{S_{k}};_{F_{k}})\).

**Theorem 3.1**: _Assume that the \(\)-graph \(_{()}\) is decomposable. Given a set \(_{}=\{^{1},,^{t}\}\) and known distributions \(p(x;^{1}),,p(x;^{t})\), the following conditions are sufficient to identify any \(p(x;^{})\), \(^{}\): i) all distributions indexed by \(^{1},,^{t},^{}\) have the same support; and ii) \(^{0}_{[F_{k}]}_{}\) for all \(F_{k}\) in the factorization of \(\). The algorithm for computing \(p(x;^{})\) works as follows. Construct a junction tree \(\) for \(\), choose an arbitrary vertex in \(\) to be the root, and direct \(\) accordingly. If \(V_{k}\) is a hypervertex in \(\), let \(D_{k}\) be the union of all intervention variables contained in the descendants of \(V_{k}\) in \(\). Let \(B_{k}\) be the intersection of the intervention variables contained in \(V_{k}\) with the intervention variables contained in the parent \(V_{(k)}\) of \(V_{k}\) in \(\). We define a _message_ from a non-root vertex \(V_{k}\) to its parent \(V_{(k)}\) as_

\[m^{x}_{k}:=()]})}{p(x;^{[B_{k}()]})}, \]

_with the update equation_

\[p(x;^{[D_{k}()]}) p(x;^{[F_{k}()]})_{V_{k^{ }} ch(k)}m^{x}_{k^{}}, \]

_where the product over \(ch(k)\), the children of \(V_{k}\) in \(\), is defined to be 1 if \(ch(k)=\)._

(All proofs in Appendix B.) In particular, if no factor contains more than one intervention variable, the corresponding \(\)-graph will be fully disconnected. This happens, for example, for an IFM derived from a DAG without hidden variables and where each intervention has one child, as in Fig. 2.

### Algebraic Formulation

If a \(\)-graph is not decomposable, the usual trick of triangulation prior to clique extraction can be used , at the cost of creating cliques which are larger than the original factors. Alternatively, and a generalization of Eqs. (2) and (3), we consider transformations of the distributions in \((_{})\)by products and ratios. We define a _PR-transformation_ of a density set \(\{p(x;^{1}),,p(x;^{t})\}\) as any formula \(_{i=1}^{t}p(x;^{i})^{qi}\), for a collection \(q_{1},,q_{t}\) of real numbers.

**Theorem 3.2**: _Let \(_{F_{k}}^{v}\) denote a particular value of \(_{F_{k}}\), and let \(_{k}\) be the domain of \(_{F_{k}}\). Given a collection \((_{}):=\{p(x;^{1}),,p(x;^{t})\}\) and a postulated model factorization \(p(x;)_{k=1}^{t}f_{k}(x_{S_{k}};_{F_{k}})\), a sufficient and almost-everywhere necessary condition for a given \(p(x;^{})\) to be identifiable by PR-transformations of \((_{})\) is that there exists some solution to the system_

\[ k\{1,2,,l\},_{F_{k}}^{v}_{k},( _{i=1:_{F_{k}}^{v}=_{F_{k}}^{v}}^{t}q_{i})=( _{F_{k}}^{}=_{F_{k}}^{v}), \]

_where \(()\) is the indicator function returning 1 or 0 if its argument is true or false, respectively._

The solution to the system gives the PR-transformation. An example is shown in Fig. 4. The main idea is that, for a fixed \(x\), any factor \(f_{k}(x_{S_{k}};_{F_{k}})\) can algebraically be interpreted as an arbitrary symbol indexed by \(_{F_{k}}\), say "\(f_{k}^{_{F_{k}}}\)". This means that any density \(p(x;^{i})\) is (proportional to) a "squarefree" monomial \(m^{i}\) in those symbols (i.e, products with exponents 0 or 1). We need to manipulate a set of monomials (the unnormalized densities in \((_{})\)) into another monomial \(m^{}\) (the unnormalized \(p(x;^{})\)). More generally, the possible set functions \(g(),h()\) such that \(g(m^{},\{m^{1},,m^{t}\})=h(\{m^{1},,m^{t}\})\), with \(g()\) invertible in \(m^{}\), suggest that \(g()\) and \(h()\) must be the product function (monomials are closed under products, but not other analytical manipulations), although we stop short of stating formally the conditions required for PR-transformations to be complete in the space of all possible functions of \((_{})\). This would be a stronger claim than Theorem 3.2, which shows that Eq. (4) is almost-everywhere complete in the space of PR transformations.

The message passing scheme and the algebraic method provide complementary views, with the former giving a divide-and-conquer perspective that identifies subsystems that can be estimated without requiring changes from the baseline treatment everywhere else. The algebraic method is more general, but suggests no hierarchy of simpler problems. These results show that the factorization over \(X\) is unimportant for identifiability, which may be surprising. Appendix C discusses the consequences of this finding, along with a discussion about requirements on the size of \(_{}\).

## 4 Learning Algorithms

The identification results give a license to choose any estimation method we want if identification is established -- while we must make the assumption of the model factorizing according to a postulated IFM, we are not required to explicitly use a likelihood function. Theorems 3.1 and 3.2 provide ways of constructing a target distribution \(p(x;^{})\) from products of ratios of densities from \((_{})\). Thissuggests a plug-in approach for estimation: estimate products of ratios using density ratio estimation methods and multiply results. However, in practice, we found that fitting a likelihood function directly often works better than estimating the product of density ratios, even for intractable likelihoods. We now discuss three strategies for estimating some \([Y;^{}]\) of interest.

Deep energy-based models and direct regression.The most direct learning algorithm is to first maximize the sum of log-likelihoods \((;^{1},,^{t}):=_{i=1}^{t} _{j=1}^{n_{i}} p_{}(x^{(j)};^{i})\), where \(n_{i}\) is the number of samples in the \(i\)th regime. The parameterization of the model is indexed by a vector \(\), which defines \(p()\) as \( p_{}(x;):=_{k=1}^{t}_{_{k,_{F_{k}}}}(x_{S _{k}})+\). Here, \(_{}()\) is a differentiable black-box function, which in our experiments is a MLP (aka a multilayer perceptron, or feedforward neural network). Parameter vector \(_{k,_{F_{k}}}\) is the collection of weights and biases of the MLP, a different instance for each factor \(k\)_and_ combination of values in \(_{F_{k}}\). In principle, making the parameters smooth functions of \(_{F_{k}}\) is possible, but in the interest of simplifying the presentation, we instead use a look-up table for completely independent parameters as indexed by the possible values of \(_{F_{k}}\). Parameter set \(\) is the union of all \(_{k=1}^{l}_{j F_{k}}|_{j}|\) MLP parameter sets. As maximizing log-likelihood is generally intractable, in our implementation we apply pseudo-likelihood with discretization of each variable \(X\) in a grid. The level of discretization does not affect the number of parameters, as we take their numerical value as is, renormalizing over the pre-defined grid. Score matching , noise contrastive estimation  or other variants (e.g., ) could be used; our pipeline is agnostic to this choice, with further details in Appendix G. We then estimate \(f_{y}(x):=[Y x]\) using an off-the-shelf method, which in our case is another MLP. For a given \(^{}\), we sample from the corresponding \(p(x;^{})\) with Gibbs sampling and average the results of the regression estimate \(_{y}(x)\) to obtain an estimate \((^{})\).

Inverse probability weighting (IPW).A more direct method is to reweight each training sample by the target distribution \(p(x;^{})\) to generate \((^{i}):=_{j=1}^{n_{i}}y^{i(j)}w^{i(j)^{}}\), where \(w^{i(j)^{}}\) is the density ratio \(p(x^{i(j)};^{})/p(x^{i(j)};^{i})\), rescaled such that \(_{j=1}^{n_{i}}w^{i(j)^{}}=1\). There are several direct methods for density ratio estimation  that could be combined using the messages/product-ratios of the previous section, but we found that it was stabler to just take the density ratio of the fitted models using deep energy-based learning, just like in the previous algorithm. Once estimators \((^{(1)}),,(^{(t)})\) are obtained, we combine them by the usual inverse variance weighting rule, \((^{i}):=_{i=1}^{t}r^{i}_{^{(i)}}/ _{i=1}^{t}r^{i}\), where \(r^{i}:=1/^{i}\), and \(^{i}:=_{j=1}^{n_{i}}(y^{i(j)})^{2}(w^{i(j)^{}})^{2}\). This method requires neither a model for \(f_{y}(x)\) nor Markov chain Monte Carlo. However, it may behave more erratically than the direct method described above, particularly under strong shifts in distribution.

Covariate shift regression.Finally, a third approach for estimating \((^{})\) is to combine models for \(f_{y}(x)\) with density ratios, learning a customized \(_{y}(x)\) for each test regime separately. A s this is very slow and did not appear to be advantageous compared to the direct method, we defer a more complete description to Appendix D.

Predictive Coverage.Even when treatment effects are identifiable within the IFM framework, the uncertainty of resulting estimates can vary widely depending on the training data and learning algorithm. Building on recent work in conformal inference , we derive the following finite sample coverage guarantee for potential outcomes, which requires no extra assumptions beyond those stated above.

**Theorem 4.1** (Predictive Coverage.): _Assume the identifiability conditions of Theorems 3.1 or 3.2 hold. Fix a target level \((0,1)\), and let \(_{1},_{2}\) be a random partition of observed regimes intro training and test sets of size \(n/2\). Fit a model \(\) using data from \(_{1}\) and compute conformity scores \(s^{(i)}=|y^{k(i)}-(^{k})|\) using data from \(_{2}\). For some new test environment \(^{}\), compute the normalized likelihood ratio \(w^{(i)}(^{}) p(x^{k(i)};^{})/p(x^{k(i)};^{ k})\), rescaled to sum to \(n/2\). Let \((^{})\) be the \(q^{}\) smallest value in the reweighted empirical distribution \(_{i}w^{(i)}(^{})(s^{(i)})\), where \(\) denotes the Dirac delta function and \(q=(n/2+1)(1-)\). Then for any new sample \(n+1\), we have:_

\[Y^{(n+1)}(^{})(^{}) 1-.\]

_Moreover, if weighted conformity scores have a continuous joint distribution, then the upper bound on this probability is \(1-+1/(n/2+1)\)._Experiments

We run a number of semi-synthetic experiments to evaluate the performance of the IFM approach on a range of intervention generalization tasks. In this section, we summarize our experimental set-up and main results. The code for reproducing all results and figures is available online8; in Appendix E, we provide a detailed description of the datasets and models; and in Appendix F we present further analysis and results.

Datasets.Our experiments are based on the following two biomolecular datasets: _i)_**Sachs**: a cellular signaling network with \(11\) nodes representing phosphorylated proteins and phospholipids, several of which were perturbed with targeted reagents to stimulate or inhibit expression. There are \(4\) binary intervention variables. \(_{}\) has \(5\) regimes: a _baseline_, with all \(_{i}=0\), and \(4\) "single-intervention" regimes, each with a different single \(_{i}=1\). \(_{}\) consist of the remaining \(11\) (\(=2^{4}-5\)) unseen regimes. _ii)_**DREAM**: Simulated data based on a known _E. coli_ regulatory sub-network with \(10\) nodes. There are \(10\) binary intervention variables, and (similarly) \(_{}\) has a baseline regime, with all \(_{i}=0\), and \(10\) single-intervention regimes, with single choices of \(_{i}=1\). \(_{}\) consists of \(45\) (\(10 9/2=45\)) unseen regimes defined by all pairs \(_{i}=_{j}=1\).

Oracular simulators.The first step to test intervention generalization is to build a set of proper test beds (i.e., simulators that serve as causal effect oracles for any \(\)), motivated by expert knowledge about the underlying system dynamics. Neither the original Sachs data nor the DREAM simulator we used provide joint intervention data required in our evaluation. Thus, for each domain, we trained two ground truth simulators: _i)_**Causal-DAG**: a DAG model following the DAG structure and data provided by the original Sachs et al. and DREAM sources (DAGs shown in Fig. 10**(a)**) and Fig. 11**(a)**, respectively). Given the DAG, we fit a model where each conditional distribution is a heteroskedastic Gaussian with mean and variance parameterized by MLPs (with \(10\) hidden units) of the respective parents. _ii)_**Causal-IFMs**: the corresponding IFM is obtain by a direct projection of the postulated DAG factors (as done in, e.g., Fig. 2**(b)**). The likelihood is a neural energy model (Section 4) with MLPs with \(15\) hidden units defining potential functions. After fitting these models, we compute by Monte Carlo simulation their implied ground truths for every choice of \(^{*}\). The outcomes \(Y\) are then generated under \(100\) different structural equations of the form \((^{}X)+\), with random independent normal weights \(\) and \((0,v_{y})\). \(\) and \(v_{y}\) are scaled such that the ground truth variance of \(^{}X\), \((^{}X)\), is sampled uniformly at random from the interval \([0.6,0.8]\), and set \(v_{y}:=1-(^{}X)\).

Compared models.We implement three variants of our proposed IFM model, corresponding to the three learning algorithms described in Section 4: _i)_**IFM1** uses deep energy-based models and direct regression; _ii)_**IFM2** uses an IPW estimator; and _iii)_**IFM3** relies on covariate shift regression. We compare these models to the following benchmarks: _i)_**Black-box**: We apply an off-the-shelf algorithm (XGBoost ) to learn a direct mapping from \(\) to \(Y\) without using \(X\). This model does not exploit any structural assumptions. _ii)_**DAG**: We estimate the structural equations in an acyclic topological ordering that is consistent with the data generating process. This represents a strong baseline that exploits ground truth knowledge of the underlying causal graph. The likelihood is defined by conditional Gaussian models with mean and variances parameterized as MLPs, matching exactly one of the simulators described below.

Results.We evaluate model performance based on the proportional root mean squared error (pRMSE), defined as the average of the squared difference between the ground truth \(Y\) and estimated \(Y\), with each entry further divided by the ground truth variance of the corresponding \(Y\). Results are visualized in Fig. 5. We additionally run a series of one-sided binomial tests to determine whether models significantly outperform the black box baseline, and compare the Spearman's rank correlation  between expected and observed outcomes for all test regimes. Unsurprisingly, DAGs do best when the ground truth is a Causal-DAG, while IFM methods do better when the data generator is a Causal-IFM. Still, some IFMs are robust to both ground truth models, with IFM1 (the deep energy model) doing especially well on the DREAM dataset, and IFM2 (the IPW estimator) excelling on the Sachs data.

In particular, for the DREAM datasets, IFM1 (scaled) errors remain stable, while the DAG has a major loss of performance when a non-DAG ground truth is presented. However, IFM2 underperform on DREAM datasets, which might be because the knockdowns regimes in those datasets induce dramatic shifts in distribution overlap among regimes. (We omit results for IFM3 (covariate shift regression) on these datasets, as the method does not converge in a reasonable time.) Though the black-box method (XGBoost algorithm and no structural assumption) sometimes struggles to extrapolate, displaying a long-tailed distribution of errors, it actually does surprisingly well in some experiments, especially on the DREAM dataset. In fact, the black-box method is essentially indistinguishable from linear regression in this benchmark (results not shown), which is not surprising given the sparsity of the training data. However, the non-additivity of the \(\) effect on \(Y\) is more prominent in the Sachs datasets, making it difficult to generalize without structural assumptions.

## 6 Related Work

A factor graph interpretation of Pearl's _do_-calculus framework is described in , but without addressing the problem of identifiability. More generally, several authors have exploit structural assumptions to predict the effects of unseen treatments. Much of this research falls under the framework of _transportability_, where the goal is to identify causal estimands from a combination of observational and experimental data collected under different regimes. If only atomic interventions are considered, the \(do\)-calculus is sound and complete for this task . The \(\)-calculus introduced by  extends these transportability results to soft interventions . However, these methods are less clearly defined when an intervention affects several variables simultaneously, and while DAGs with additive errors have some identifiability  and estimation  advantages, acyclic error additivity may not be an appropriate assumption in some domains. Under further parametric assumptions, causal effects can be imputed with matrix completion techniques  or more generic supervised learning approaches , but these methods often require some data to be collected for all regimes in \(_{}\). Finally,  is the closest related work in terms of goals, factorizing the function space of each \([X_{i};]\) directly as a function of \(\).

Another strand of related research pertains to online learning settings. For instance, several works have shown that causal information can boost convergence rates in multi-armed bandit problems when dependencies are present between arms , even when these structures must themselves be adaptively learned . This suggests a promising direction for future work, where identification strategies based on the IFM framework are used to prioritize the search for optimal treatments. Indeed, combining samples across multiple regimes can be an effective strategy for causal discovery, as illustrated by recent advances in invariant causal prediction , and it can also help with domain adaptation and covariate shift .

## 7 Conclusion

We introduced the IFM framework for solving intervention generalization tasks. Results from simulations calibrated by real-world data show that our method successfully predicts outcomes for novel treatments, providing practitioners with new methods for conducting synthetic experiments. Future work includes: _i)_ integrating the approach with experimental design, Bayesian optimization and bandit learning; _ii)_ variations that include pre-treatment variables and generalizations across heterogeneous subpopulations, inspired by complementary matrix factorization methods such as ; _iii)_ tackling sequential treatments; and _iv)_ diagnostics of cross-regime overlap issues .

Figure 5: Experimental results on a range of intervention generalization tasks, see text for details.