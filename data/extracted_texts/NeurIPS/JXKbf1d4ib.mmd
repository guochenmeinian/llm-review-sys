# Near-Minimax-Optimal Distributional Reinforcement Learning with a Generative Model

Mark Rowland

Google DeepMind

Correspondence to markrowland@google.com.

Li Kevin Wenliang

Google DeepMind

Remi Munos

FAIR, Meta

Clare Lyle

Google DeepMind

Yunhao Tang

Google DeepMind

Will Dabney

Google DeepMind

###### Abstract

We propose a new algorithm for model-based distributional reinforcement learning (RL), and prove that it is minimax-optimal for approximating return distributions in the generative model regime (up to logarithmic factors), the first result of this kind for any distributional RL algorithm. Our analysis also provides new theoretical perspectives on categorical approaches to distributional RL, as well as introducing a new distributional Bellman equation, the stochastic categorical CDF Bellman equation, which we expect to be of independent interest. Finally, we provide an experimental study comparing a variety of model-based distributional RL algorithms, with several key takeaways for practitioners.

## 1 Introduction

In distributional reinforcement learning, the aim is to predict the full probability distribution of possible returns at each state, rather than just the mean return (Morimura et al., 2010; Bellemare et al., 2017, 2023). Applications of distributional reinforcement learning range from dopamine response modelling in neuroscience (Dabney et al., 2020), to driving risk-sensitive decision-making and exploration in domains such as robotics (Bodnar et al., 2020), healthcare (Bock et al., 2022), and algorithm discovery (Fawzi et al., 2022), as well as forming a core component of many deep reinforcement learning architectures (Bellemare et al., 2017; Dabney et al., 2018, 2018; Yang et al., 2019; Bellemare et al., 2020; Shahriari et al., 2022; Wurman et al., 2022).

The full distribution of returns is a much richer signal than the expectation to predict. A foundational, as-yet-unanswered problem is how many sampled transitions are required to accurately estimate return distributions, and in particular, whether this task is statistically harder than estimating just the value function. We study these questions in the setting where sampled transitions are given by a generative model (Kearns et al., 2002; Kakade, 2003; Azar et al., 2013).

We provide a new distributional RL algorithm, the _direct categorical fixed-point algorithm_ (DCFP), and prove that the number of samples required by this algorithm for accurate return distribution estimation matches the lower bound established by Zhang et al. (2023), up to logarithmic factors. This resolves the foundational question above, and, perhaps surprisingly, shows that in this setting, _distributional RL is essentially no harder, statistically speaking, than learning a value function_.

In addition to this central result, our analysis provides new perspectives on categorical approaches to distributional RL (Bellemare et al., 2017), including a new distributional Bellman equation, the stochastic categorical CDF Bellman equation (see Section 5.2), which we expect to be of broad use in future work on categorical distributional RL. We also provide an empirical study, comparingthe newly-proposed DCFP algorithm to existing approaches to distributional RL such as quantile dynamic programming (QDP; Dabney et al., 2018; Rowland et al., 2024), and identify several key findings for practitioners, including the importance of levels of environment stochasticity and discount factor for the relative performance of these algorithms.

## 2 Background

Throughout the paper, we consider the problem of evaluation in an infinite-horizon Markov reward process (MRP), with finite state space \(\), transition probabilities \(P^{}\), reward function \(r:\), and discount factor \([0,1)\); this encompasses the problem of policy evaluation in Markov decision processes (Sutton and Barto, 2018). A random trajectory \((X_{t},R_{t})_{t 0}\) is generated from an initial state \(X_{0}=x\) according to the conditional distributions \(X_{t}(X_{0},,X_{t-1}) P(|X_{t-1})\), and \(R_{t}=r(X_{t})\). The _return_ associated with the trajectory is given by the quantity \(_{t 0}^{t}R_{t}\). In RL, a central task is to estimate the _value function_\(V^{*}:\), defined by

\[V^{*}(x)=[_{t 0}^{t}R_{t} X_{0}=x]\,, \]

given some form of observations from the MRP. The value function defines the expected return, conditional on each possible starting state in the MRP. The value function satisfies the Bellman equation \(V^{*}=TV^{*}\), where \(T:^{}^{}\) is defined by

\[(TV)(x)=_{x}[R+ V(X^{})]\,, \]

where \((x,R,X^{})\) is a random transition in the environment, distributed as described above. When the transition probabilities of the MRP are known, the right-hand side can be evaluated as an affine transformation of \(V\). MRP theory (see, e.g., Puterman, 2014 for an overview) then shows how (an approximation to) \(V^{*}\) can be obtained. For example, a _dynamic programming_ approach takes an initial approximation \(V_{0}[0,(1-)^{-1}]^{}\), and the sequence \((V_{k})_{k=0}^{}\) is computed via the update \(V_{k+1}=TV_{k}\); it is guaranteed that \(\|V_{k}-V^{*}\|_{}^{k}(1-)^{-1}\). Alternatively, the linear system \(V=TV\) can be solved directly with linear-algebraic methods to obtain \(V^{*}\) as its unique solution.

### Reinforcement learning with a generative model

In many settings the transition probabilities of the MRP are unknown, and the value function must be estimated based on data comprising sampled transitions, introducing a statistical element to the problem. A commonly used model for this data is a _generative model_(Kearns et al., 2002; Kakade, 2003). In this setting, for each state \(x\), we observe \(N\) i.i.d. samples \((X^{x}_{i})_{i=1}^{N}\) from \(P(|x)\), and this collection of \(N||\) samples may then be used by an algorithm to estimate the value function. Azar et al. (2013) showed that at least \(N=(^{-2}(1-)^{-3}(||/))\) samples are required to obtain \(\)-accurate estimates of the value function with high probability (measured in \(L^{}\) norm), and also showed that this bound is attained (up to logarithmic factors) by a _certainty equivalence_ algorithm, which treats the empirically observed transition frequencies as the true ones, and solves for the value function of the corresponding MRP.

### Distributional reinforcement learning

Distributional RL aims to capture the full probability distribution of the random return at each state, not just its mean. Mathematically, the object of interest is the return-distribution function (RDF) \(^{*}:()\), defined by

\[^{*}(x)=_{t=0}^{}^{t}R_{t} X_{0}=x \,, \]

where \(\) extracts the probability distribution of the input random variable. The distributional perspective on reinforcement learning has proved practically useful in a wide variety of applications, including healthcare (Bock et al., 2022), navigation (Bellemare et al., 2020), and algorithm discovery (Fawzi et al., 2022). The central equation behind dynamic programming approaches to approximating the return distribution function is the _distributional Bellman equation_(Sobel, 1982; Morimura et al., 2010; Bellemare et al., 2017), given by \(^{*}=^{*}\), where \(:()^{}( )^{}\) is the _distributional Bellman operator_, defined by

\[()(x)=R+ G(X^{}) X=x\,,\]

where independent from the random transition \((X,R,X^{})\), we have \(G(x)(x)\) for each \(x\).

### Categorical dynamic programming

Given an initial RDF approximation \(([0,(1-)^{-1}])^{}\), it also holds that the update \(\) converges to \(^{*}\) in an appropriate sense (e.g., in Wasserstein distance; see Bellemare et al., 2017), in analogy with dynamic programming algorithms for the value function, as described above. However, generally it is not possible to tractably implement repeated computation of the update \(\) as a means of computing approximations to return distributions; probability distributions are infinite-dimensional objects, and as such computational costs quickly become prohibitive. Instead, the use of some kind of approximate, tractable representation of probability distributions is typically required.

**Representations.** In this paper, we focus on the categorical approach to distributional reinforcement learning (Bellemare et al., 2017), in which estimates of return distributions are represented as categorical distributions over a finite number of outcomes \(z_{1}<<z_{m}\). We will take \(\{z_{1},,z_{m}\}\) to be an equally spaced grid over the range of possible returns \([0,(1-)^{-1}]\), so that \(z_{i}=(1-)^{-1}\) for \(i=1,,m\). Approximations of the RDF are then represented in the form

\[(x)=_{i=1}^{m}p_{i}(x)_{z_{i}}\,. \]

Here, \(_{z}\) is the Dirac distribution at the outcome \(z\), and \(p=((p_{i}(x))_{i=1}^{m}:x)\) are adjustable probability mass parameters; see Figure 1(a). The number of categories \(m\) can be interpreted as controlling the _expressivity_ of the representation, and should be carefully chosen in practice to trade off between increased accuracy (larger \(m\)), and computational tractability (smaller \(m\)).

**Dynamic programming.** The iteration \(\)_cannot_ be used to update the parameters \(p\) in Equation (4) directly, since the distributions \(()(x)\) are no longer supported on \(\{z_{1},,z_{m}\}\), and so cannot be expressed in the form given in Equation (4); see Figure 1(b). Bellemare et al. (2017) circumvent this issue by _projecting_ the resulting distributions back onto the support set \(\{z_{1},,z_{m}\}\) via a map \(_{m}:([0,(1-)^{-1}])(\{z_{1},, z_{m}\}])\). Intuitively, \(_{m}\) can be thought of as allocating each outcome \(z[z_{i},z_{i+1}]\) to its neighbouring gridpoints \(z_{i}\) and \(z_{i+1}\), in proportion to their proximity, so that the projection of the Dirac distribution \(_{z}\), is defined by

\[_{m}_{z}=-z}{z_{i+1}-z_{i}}_{z_{i}}+} {z_{i+1}-z_{i}}_{z_{i+1}}\,.\]

In this paper, we work with the equivalent definition of the projection \(_{m}\) given by Rowland et al. (2018, Proposition 6), in which the probability mass assigned to \(z_{i}\) by \(_{m}\) is given by the expectation \(_{Z}[h_{i}(Z)]\), where \(h_{i}:[0,(1-)^{-1}]\) is the "hat function" at \(z_{i}\), which linearly interpolates between a value of 1 at \(z_{i}\), and 0 at neighbouring gridpoints \(z_{i-1}\), \(z_{i+1}\), and is 0 outside this range. Figure 1(c) illustrates \(h_{i}\) and \(h_{m}\); see Appendix B for a restatement of the full definition given by Rowland et al. (2018).

The projected update \(_{m}\) is thus guaranteed to keep \(\) in the space of approximations of the form given in Equation (4), and can be viewed as a tractable alternative to the update \(\) described above. Rowland et al. (2018) show that despite the introduction of the additional projection map \(_{m}\), repeated computation of the update \(_{m}\), referred to as _categorical dynamic programming_ (CDP), is guaranteed to convergence to a _categorical fixed point_, and further, the categorical fixed point can be made arbitrarily close to the true RDF \(^{*}\) by increasing \(m\), as measured by Cramer distance (Cramer, 1928; Szekely, 2003; Szekely and Rizzo, 2013).

Figure 1: (a) The density of a distribution \(\) (grey), and its categorical projection \(_{m}(\{z_{1},,z_{m}\})\) (blue). (b) A categorical distribution (blue); its update after being scaled by \(\) and shifted by \(r\) by the distributional Bellman operator \(\), moving its support off the grid \(\{z_{1},,z_{m}\}\) (pink); the resulting realigned distribution supported on the grid \(\{z_{1},,z_{m}\}\) after projection via \(_{m}\) (green). (c) Hat functions \(h_{i}\) (solid) and \(h_{m}\) (dashed).

**Definition 2.1**.: The _Cramer distance_\(_{2}:()()\) is defined by

\[_{2}(,^{})=_{}(F_{}(t)-F_{^{} }(t))^{2}\;t^{1/2}\,,\]

where \(F_{},F_{^{}}\) are the CDFs of \(,^{}\), respectively. The _supremum-Cramer distance_\(_{2}\) on \(()^{}\) is defined by

\[_{2}(,^{})=_{x}_{2}((x),^{}(x))\,.\]

The central convergence results concerning CDP are summarised below.

**Proposition 2.2**.: _(Rowland et al., 2018). The operator \(_{m}:([0,(1-)^{-1}])^{}([0,(1-)^{-1}])^{}\) is a contraction mapping with respect to \(_{2}\), with contraction factor \(\), and has a unique fixed point, \(_{}(\{z_{1},,z_{m}\})^{}\). As a result, for any \(_{0}([0,(1-)^{-1}])^{}\), with \(_{k+1}=_{m}_{k}\), we have \(_{2}(_{k},_{})(1-)^{-1}^{k}\). Further, the distance between \(_{}\) and the true RDF \(^{*}\) can be bounded as_

\[_{2}(_{},^{*})}\,. \]

This establishes CDP as a principled approach to approximating return distributions, and also quantifies the accuracy achievable with CDP using \(m\) categories, which will be central in informing our choice of \(m\) to obtain a sample-efficient, accurate algorithm below.

## 3 Distributional reinforcement learning with a generative model

The central problem we study in this paper is how to do sample-efficient distributional RL with a generative model. That is, given the samples \(((X_{i}^{x})_{i=1}^{N}:x)\) described in Section 2.1, how accurate of an approximation to the return-distribution function in Equation (3) can one compute?

This question was raised by Zhang et al. (2023), who proposed to perform distributional dynamic programming updates \(}\) as described in Section 2.2, using the _empirical_ distributional Bellman operator \(}\) derived from the empirical transition probabilities \(\), defined by \((y|x)=N^{-1}_{i=1}^{N}\{X_{i}^{x}=y\}\), producing an estimate \(([0,(1-)^{-1}])\) of the true RDF \(^{*}\) such that for any \(>0\) and \((0,1)\), we have \(w_{1}((x),^{*}(x))\) with probability at least \(1-\) for all \(x\), whenever \(N=(^{-2}(1-)^{-4}(1/))\). Here, \(w_{1}\) denotes the Wasserstein-1 distance between probability distributions, defined for any \(,^{}()\) with CDFs \(F_{},F_{^{}}\) by \(w_{1}(,^{})=_{}|F_{}(t)-F_{^{}}(t)|\; t\,.\) We focus on the Wasserstein-1 distance as the main metric of interest in this paper as it is particularly compatible with existing methods for analysing categorical approaches to distributional RL, and it provides upper bounds for differences of many statistical functionals of interest, such as expectations of Lipschitz functions (Villani, 2009; Peyre and Cuturi, 2019); and conditional-value-at-risk (Rockafellar and Uryasev, 2000, 2002; Bhat and Prashanth, 2019, CVaR). Zhang et al. (2023) also prove a lower bound of \(N=(^{-2}(1-)^{-3})\) samples required to obtain such an accurate prediction with high probability, which follows from a reduction to the mean-return case (Azar et al., 2013).

There are two natural questions that the analysis of Zhang et al. (2023) leaves open. Firstly, can the gap between the lower bound and upper bound as a function of \((1-)^{-1}\) described above be closed? Zhang et al. (2023) conjecture that their analysis is loose, and that this gap can indeed be closed. Second, we also note that the distributional dynamic programming procedure \(}\) proposed by Zhang et al. (2023), without incorporating any restrictions on the representations of distributions, runs into severe space and memory issues, and is not practical to run (and indeed Zhang et al. (2023) introduce approximations to the algorithm when running empirically for these reasons). A remaining question is then whether there are tractable algorithms that can achieve the lower bound on sample complexity described above. Our contributions below provide a new, tractable distributional RL algorithm that attains (up to logarithmic factors) the lower bound on sample complexity provided by Zhang et al. (2023), resolving these questions.

Direct categorical fixed-point computation

Our approach to obtaining a sample-efficient algorithm that is near-minimax-optimal in the sense described above begins with the categorical approach to distributional dynamic programming described in Section 2.3. We begin first by introducing a new algorithm for computing the categorical fixed point \(_{}\) referred to in Proposition 2.2_directly_, that avoids computing an approximate solution via dynamic programming iterations \(_{m}\). We expect this algorithm to be of independent interest within the field of distributional reinforcement learning.

### Direct categorical fixed-point computation

Our first contribution is to develop a new computational perspective on the projected categorical Bellman operator \(_{m}\), which results in a new algorithm for computing the fixed point \(_{}\)_exactly_, without requiring the iterative CDP algorithm described in Section 2.3.

**CDF operator and fixed-point equation.** We first formulate the application of the projected categorical Bellman operator \(_{m}\) as a linear map, and give an explicit expression for the matrix representing this linear map when the input RDFs are represented with cumulative distribution functions (CDFs). We consider the effect of applying \(_{m}\) to an RDF \(=(\{z_{1},,z_{m}\})^{}\), with \((x)=_{i=1}^{m}p_{i}(x)_{z_{i}}\). By Rowland et al. (2018, Proposition 6), the updated probabilities for \((_{m})(x)=_{i=1}^{m}p^{}_{i}(x)_{z_{i}}\) can be expressed as

\[p^{}_{i}(x)=_{y}_{j=1}^{m}P(y|x)h^{x}_{i,j}p_{j}( y)\,, \]

where \(h^{x}_{i,j}=h_{i}(r(x)+ z_{j})\). We convert this into an expression for cumulative probabilities, rather than individual probability masses, to obtain a simpler analysis below. To do so, we introduce the encoding of \((\{z_{1},,z_{m}\})^{}\) into corresponding CDF values \(F^{ m}\), where \(F_{i}(x)=(x)([z_{1},z_{i}])\) denotes the _cumulative_ mass at state \(x\) over the set \(\{z_{1},,z_{i}\}\).

**Proposition 4.1**.: _If \((\{z_{1},,z_{m}\})^{}\) is an RDF with corresponding CDF values \(F^{ m}\), then the corresponding CDF values \(F^{}^{ m}\) for \(_{m}\) satisfy_

\[F^{}_{i}(x)=_{y}_{j=1}^{m}P(y|x)(H^{x}_{i,j}-H^{x} _{i,j+1})F_{j}(y)\,, \]

_where_

\[H^{x}_{i,j}=_{l i}h_{l}(r(x)+ z_{j}) \]

_for \(j=1,,m\), and by convention we take \(H^{x}_{i,m+1}=0\)._

Under this notation, we can rewrite Equation (7) simply as a matrix-vector multiplication in \(^{[m]}\):

\[F^{}=T_{P}F\,,\]

where \(T_{P}\) is the \(([m])([m])\) square matrix, with entries given by

\[T_{P}(x,i;y,j)=P(y|x)(H^{x}_{i,j}-H^{x}_{i,j+1})\,, \]

and \(F,F^{}^{ m}\) above are interpreted in vectorised form. We drop dependence on \(m\) from the notation \(T_{P}\) for conciseness. Thus, CDP can be implemented via simple matrix multiplication on CDF values, and the CDF values \(F^{*}\) for the categorical fixed point \(_{}\) solve the equation

\[F=T_{P}F\,,(I-T_{P})F=0\,. \]

**Obtaining a system with unique solution.** Equation (10) suggests that we can directly solve a linear system to obtain the exact categorical fixed point, rather than performing the iterative CDP algorithm to obtain an approximation. Note, however, that \(F^{*}\) is not the _unique_ solution of Equation (10); for example, \(F=0\) is also a solution. This arises because in Equation (10), the _distribution masses_ at each state (that is, \(F_{m}(x)\)), are unconstrained. By contrast, Proposition 2.2 establishes that \(_{}\) is the unique solution of \(=_{m}\) in the space \(([z_{1},z_{m}])^{}\), where each element \((x)\) is constrained to be a probability distribution _a priori_. Thus, Equation (10) requires some modification to obtain a linear system with a unique solution. This is obtained by removing \(F_{m}(x)\) as a variable from the system (for each \(x\))), replacing it by the constant 1, and removing redundant rows from the resulting linear system, as the following proposition describes; the "axis-aligned" nature of these constraints is the benefit of working with CDF values.

**Proposition 4.2**.: _The linear system in Equation (10), with the additional linear constraints \(F_{m}(x)=1\) for all \(x\), is equivalent to the following linear system in \(^{[m-1]}\):_

\[(I-_{P})=\,, \]

_where the \((x,i;y,j)\) coordinate of \(_{P}\) (for \(1 i,j m-1\)) is_

\[_{P}(x,i;y,j)=P(y|x)(H^{x}_{i,j}-H^{x}_{i,j+1})\,,\]

_and for each \(x\), \(1 i m-1\), we have \((x,i)=H^{x}_{i,m}\)._

Having moved to the inhomogeneous system over \(^{[m-1]}\) in Equation (11), we can deduce the following via the contraction theory in Proposition 2.2.

**Proposition 4.3**.: _The linear system in Equation (11) has a unique solution, which is precisely the CDF values \(((F^{*}_{i}(x))_{i=1}^{m-1}:x)\) of the categorical fixed point._

The _direct categorical fixed-point algorithm_ (DCFP) consists of solving the linear system in Equation (11) to obtain the exact categorical fixed point; see Algorithm 1 for a summary, and Appendix G.5 for more details on implementations.

```
1Calculate matrices \((H^{x}:x)\) via Equation (8).
2Calculate matrix \(_{P}\) and vector \(\) via Equation (9).
3Call linear system solver on Equation (11).
4Obtain resulting solution \(^{*}^{[m-1]}\).
5Return \(F^{*}\), obtained by appending the values \(F^{*}_{m}(x)=1\) to the solution \(^{*}\).
```

**Algorithm 1**The direct categorical fixed-point algorithm (DCFP).

**Complexity and implementation details.** Representing \(_{P}\) as a dense matrix requires \(O(||^{2}m^{2})\) space, and solving the corresponding linear system in Equation (11) with a standard linear solver requires \(O(||^{3}m^{3})\) time. However, in many problems there are cases where the DCFP algorithm can be implemented more efficiently. Crucially, \(_{P}\) often has sparse structure, and so sparse linear solvers may afford an opportunity to make substantial improvements in computational efficiency. We explore this point further empirically in Section 6, and give a theoretical perspective in Appendix G.

### DCFP with a generative model

We now return to the setting where the Markov reward process in which we are performing evaluation is unknown, and instead we have access to the random next-state samples \(((X^{x}_{i})_{i=1}^{N}:x)\), as described in Section 3. Our model-based DCFP algorithm proceeds by first constructing the corresponding empirical transition probabilities \(\), so that \((y|x)=N^{-1}_{i=1}^{N}1\{X^{x}_{i}=y\}\), and then calls the DCFP procedure outlined in Algorithm 1, treating \(\) as the true transition probabilities of the MRP when constructing the matrix in Line 2, which we denote here by \(T_{}\), to reflect the fact that it is built from \(\). This produces the output CDF values \(\), from which estimated return distributions can be decoded (with the convention \(_{0}(x)=0\)) as

\[(x)=_{i=1}^{m}(_{i}(x)-_{i-1}(x))_{z_{i}}\,. \]

## 5 Sample complexity analysis

Our goal now is to analyse the sample complexity of model-based DCFP, as described in the previous section. We first introduce a notational shorthand that will be of extensive use in the statement and proof of this result: when writing distances between distributions, such as \(w_{1}(^{*}(x),(x))\), we identify CDF vectors \((x)^{m}\) with the distributions they represent as in Equation (12). The core theoretical result of the paper is as follows.

**Theorem 5.1**.: _Let \((0,(1-)^{-1/2})\) and \((0,1)\), and suppose the number of categories satisfies \(m 4(1-)^{-2}^{-2}+1\). Then the output \(\) of model-based DCFP with \(N=(^{-2}(1-)^{-3}(||/))\) samples satisfies, with probability at least \(1-\),_

\[_{x}w_{1}(^{*}(x),(x))\,.\]

This result establishes that model-based DCFP attains the minimax lower-bound (up to logarithmic factors) for high-probability return distribution estimation in Wasserstein distance, resolving an open question raised by Zhang et al. (2023); in a certain sense, _estimation of return distributions is no more statistically difficult than that of mean returns with a generative model_. Note there is no direct dependence of \(N\) on \(m\), so there is no _statistical_ penalty to using a large number of categories \(m\).

**Extensions.** We note that this core result can be straightforwardly extended in several directions. In particular, similar bounds apply in the case of predicting returns for _learnt near-optimal policies_ in MDPs (see Section F.2), for the _iterative categorical DP algorithm_ in place of DCFP (when using sufficiently many DP updates; see Section F.1), and in the case of _stochastic rewards_ (see Section F.3).

### Structure of the proof of Theorem 5.1

The remainder of this section provides a sketch proof of Theorem 5.1; a complete proof is provided in the appendix. The proof is broadly motivated by the approaches of Azar et al. (2013), Agarwal et al. (2020), and Pananjady and Wainwright (2020), who analyse the mean-return case, and we highlight where key ideas and new mathematical objects are required in this distributional setting. In particular, we highlight the use of the _stochastic categorical CDF Bellman equation_, a new distributional Bellman equation that plays a key role in our analysis, which we expect to be of independent interest.

**Reduction to Cramer distance.** The first step of the analysis is to reduce Theorem 5.1 to a statement about approximation in Cramer distance, which is much better suited to the analysis of DCFP, owing to the results described in Section 2.3. This can be done by upper-bounding Wasserstein distance by Cramer distance using the following result, which is proven in the appendix via Jensen's inequality.

**Lemma 5.2**.: _For any two distributions \(,^{}([0,(1-)^{-1}])\), we have_

\[w_{1}(,^{})(1-)^{-1/2}_{2}(,^{})\,.\]

Theorem 5.1 is now reducible to the following, stated in terms of the Cramer distance.

**Theorem 5.3**.: _Let \((0,1)\) and \((0,1)\), and suppose the number of categories satisfies \(m 4(1-)^{-2}^{-2}+1\). Then the output \(\) of model-based DCFP with \(N=(^{-2}(1-)^{-2}(||/))\) samples satisfies, with probability at least \(1-\),_

\[_{x}_{2}(^{*}(x),(x))\,. \]

**Reduction to categorical fixed-point error.** Our first step in proving Theorem 5.3 is to use the triangle inequality to split the Cramer distance on the left-hand side of Equation (13) into a representation approximation error, and sample-based error:

\[_{2}(^{*},)_{2}(^{*},F^{*})+ _{2}(F^{*},)}+ {}_{2}(F^{*},)\,,\]

with the second inequality following from the fixed-point quality bound in Equation (5). With \(m\) as specified in the theorem statement, the first term in the right-hand side above is bounded by \(/2\). Thus, it suffices to focus on the second term on the right-hand side, which quantifies the sample-based error in estimating the categorical fixed point \(F^{*}\).

**Concentration.** Through a combination of the use of a version of Bernstein's inequality in Hilbert space (Chatalic et al., 2022) and propagation of this inequality across time steps in the MRP, we next arrive at the following inequality with probability at least \(1-\):

\[_{2}((x),F^{*}(x))})^{-1}_{}\|_{}}+N^{3/4}}\,. \]Here, \(_{}^{}\) is an instance of a new class of distributional object, the _local squared-Cramer variation_. The general definition is given below, for the case of a general transition matrix \(Q^{ X}\), to avoid conflation with the specific transition matrices \(P\) and \(\) that Theorem 5.3 is concerned with.

**Definition 5.4**.: For a given transition matrix \(Q\), the _single-sample operator_\(_{Q}:^{ m}^{ m}\) is the random operator given by: (i) constructing a _random transition matrix_\(\) by, for each \(x\), sampling \(X^{} Q(|x)\), and setting \((X^{}|x)=1\); (ii) setting \(_{Q}=T_{}\).

**Definition 5.5**.: For a given transition matrix \(Q\) with corresponding CDP fixed point \(F^{Q}^{ m}\), the _local squared-Cramer variation at \(Q\)_, \(_{Q}^{}\), is defined by

\[_{Q}(x)=[_{2}^{2}((_{Q}F^{Q})(x),F^{Q}(x))]\,.\]

Intuitively, the local squared-Cramer variation \(_{Q}\) encodes the variability of the fixed point \(F^{Q}\) after a sample-based, rather than exact, dynamic programming update. From this point of view, it is a natural quantity to arise in Equation (14), and plays a similar role to the variance in the classical Bernstein inequality (Bernstein, 1946).

In Corollary 5.12 below, we will deduce that under the conditions of Theorem 5.3, we have

\[\|(I-)^{-1}_{}\|_{}\,. \]

Substituting this into Equation (14) gives

\[_{2}((x),F^{*}(x))}+N^{3/4}}\]

with probability at least \(1-\), for all \(x\). Now, taking \(N=((1-)^{-2}^{-2})\) yields that this expression is \(O()\), which completes the sketch proof of Theorem 5.3. What remains to be described is how to arrive at the bound in Equation (15); the section below provides a high-level overview of the technical details involved in obtaining it.

### The stochastic categorical CDF Bellman equation

The central idea is to relate the _local_ squared-Cramer variation to a corresponding _global_ notion of variation, in analogy with the variance Bellman equation (Sobel, 1982) used by Azar et al. (2013) in the mean-return case. To define this corresponding global notion, we begin by defining a new type of distributional Bellman equation, which can be intuitively thought of as encoding the result of repeatedly applying a sequence of independent single-sample operators. Again, we work with a general transition matrix \(Q\).

**Definition 5.6**.: For a general transition matrix \(Q\), the _stochastic categorical CDF (SC-CDF) Bellman equation_ is given by

\[(x)}}{{=}}(_{Q})(x)\,, \]

where \(}}{{=}}\) denotes equality in distribution. Here, \(_{Q}\) is a _single-sample operator_ with respect to \(Q\), as in Definition 5.4. Each \((x)\) is a random variable taking values in the space of valid CDF values \(=\{F^{m}:0 F_{1} F_{m-1} F_{m}=1\}\) for distributions in \((\{z_{1},,z_{m}\})\), and is taken to be independent of the random operator \(_{Q}\).

The intuition is that "unravelling" Equation (16) should lead to a solution of the form

\[(x)}}{{=}}_{k}_{Q}^ {(k)}_{Q}^{(1)}F\,,\]

where \((_{Q}^{(i)})_{i=1}^{k}\) are independent single-sample operators, so that \((x)\) encodes the fluctuations due to repeated CDP updates with randomly-sampled transitions. To make this intuition precise, we first verify that the SC-CDF Bellman equation has a unique solution.

**Proposition 5.7**.: _The SC-CDF Bellman equation in Equation (16) has a unique solution, in the sense that there is a unique distribution for each \((x)\) such that Equation (16) holds for each \(x\)._We write \(^{Q}\) for the collection of random CDFs that satisfy the SC-CDF Bellman equation in Equation (16), whose existence is guaranteed by Proposition 5.7. We next relate \(^{Q}\) to the standard categorical fixed point \(F^{Q}\).

**Proposition 5.8**.: _For all \(x\), we have_

\[[^{Q}(x)]=F^{Q}(x)\,.\]

Proposition 5.8 shows that \(^{Q}\) can indeed thought of as encoding random variation around the usual categorical fixed point \(F^{Q}\); see Figure 2. This motivates the following.

**Definition 5.9**.: For a given transition matrix \(Q\) with corresponding CDP fixed point \(F^{Q}^{ m}\), the _global squared-Cramer variation at \(Q\)_, \(_{Q}^{}\), is defined by

\[_{Q}(x)=[_{2}^{2}(^{Q}(x),F^{Q}(x))]\,.\]

**Remark 5.10**.: _Note that \(^{Q}(x)\) is a doubly distributional object. It represents a probability distribution centred around the object \(F^{Q}(x)\), which itself already provides a summary of the distribution of the return. This reveals a dual perspective on distributional RL itself. The distributional predictions made can serve several purposes: (i) modelling the aleatoric uncertainty in the return, as is the case in the work of Bellemare et al. (2017) and much subsequent algorithmic work, and/or (ii) serving to model specific types of epistemic uncertainty in the estimation of a non-random object from random data, as used in the analysis of Azar et al. (2013) and much subsequent work on the sample complexity of reinforcement learning. The object \(^{Q}\) is motivated by both of these concerns simultaneously._

The following Bellman-like inequality draws a relationship between local and global squared-Cramer variation, allowing us to make progress from Equation (15).

**Proposition 5.11**.: _We have_

\[_{Q}_{Q}+ Q_{Q}-} +(1-)^{2}}\,,\]

_where \(^{}\) is a vector of ones, and the inequality above is interpreted component-wise._

Rearrangement and bounding of the quantities in the inequality of Proposition 5.11, in the specific case \(Q=\), yields the required inequality in Equation (15) that completes the proof of Theorem 5.3.

**Corollary 5.12**.: _We can bound the term \(\|(I-)^{-1}_{}\|_{}\) appearing in Equation (14) under the assumptions of Theorem 5.3 as follows:_

\[\|(I-)^{-1}_{}\|_{}\|_{}\|_{ }+\,.\]

## 6 Empirical evaluation

To complement our theoretical analysis, which focuses on worst-case sample complexity bounds, we report empirical findings for implementations of several model-based distributional RL algorithms in the generative model setting. We compare the new DCFP algorithm introduced in Section 4.1 with _quantile dynamic programming_(Dabney et al., 2018; Bellemare et al., 2023, QDP) a distinct approach to distributional RL in which return distributions are approximated via dynamic programming with a finite number of quantiles.

Figure 2: Left: Example MRP with \(r(x_{0})=1,r(x_{1})=0\), \(=0.9\). Right: Categorical fixed point \(F^{*}(x_{0})\) with \(m=15\), and 5 independent samples from the random CDF \(^{*}(x_{0})\).

In Figure 3 (left), we report results of running DCFP and QDP on a 5-state environment with transition matrix randomly sampled from Dirichlet distributions, and entries of the immediate reward function \(r^{}\) randomly sampled from \(()\), with varying numbers of atoms \(m\), environment samples per state \(N\), and discount \(\). We report the maximum \(w_{1}\)-error against true return distributions (estimated via Monte Carlo sampling). All runs are repeated 30 times, and error bars are 95% bootstrapped confidence intervals. Sufficient DP iterations ensure approximate convergence to their fixed points. In Figure 3 (right), we plot estimation error against wallclock time for \(m=100,N=10^{6}\), including results for CDP (which approximates the solution of DCFP via dynamic programming; Section 2.3); line plots indicate the estimation error/wallclock time trade-off as we increase the number of DP iterations. Both DCFP and CDP methods benefit from setting the atom support based on maximal/minimal values of \(r\), as described in Appendix G.

For low discount factors and atom counts QDP generally outperforms DCFP in terms of asymptotic estimation error, due to QDP's ability to modify its atom support to regions of the interval \([0,(1-)^{-1}]\) where mass is concentrated. However, we note that DCFP is generally faster than QDP. Further, DCFP generally outperforms QDP, in terms of both speed and estimation error, under larger discounts and/or larger atom count. We also note that particularly at high discounts, DCFP outperforms CDP in terms of wallclock time, due to DP methods requiring many iterations to converge in these cases (Rowland et al., 2018). Full results, including on several further environments, are given in Appendix G: key findings include that QDP works particularly well in near-deterministic environments, and DCFP works particularly well in settings where there are short high-probability paths from a state to itself.

## 7 Conclusion

We have introduced a new algorithm, DCFP, for directly computing the fixed point of CDP, a widely used distributional reinforcement learning algorithm. We then showed that this algorithm, with an appropriately chosen number of categories \(m\), achieves the minimax lower bound (up to logarithmic factors) for sample complexity of return-distribution estimation in Wasserstein distance with a generative model. Thus, this paper closes an open question raised by Zhang et al. (2023) by exhibiting an algorithm that obtains this lower bound, and shows that estimation of return distributions via a generative model is essentially no harder statistically than the task of estimating a value function.

Our analysis also casts new light on categorical approaches to distributional reinforcement learning in general. The newly introduced stochastic categorical CDF Bellman equation serves to encode information about statistical fluctuations of categorical approaches to distributional RL, and we expect it to be of further use in theoretical work in distributional RL generally. Our experimental results also highlight salient differences in performance for distributional RL algorithms making use of distinct representations, depending on levels of environment stochasticity and discount factor in particular. We believe further investigation of these phenomena is an interesting direction for future work.

Figure 3: Approximation error/wallclock time for a variety of distributional RL methods, discount factors, numbers of atoms, and numbers of environment samples.