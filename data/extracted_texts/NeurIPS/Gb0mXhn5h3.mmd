# MiSO: Optimizing brain stimulation

to create neural population activity states

 Yuki Minai\({}^{1,2,5}\), Joana Soldado-Magraner\({}^{1,4,5}\), Matthew A. Smith\({}^{1,3,5*}\), Byron M. Yu\({}^{1,3,4,5*}\)

\({}^{1}\)Neuroscience Institute, Carnegie Mellon University

\({}^{2}\)Machine Learning Department, Carnegie Mellon University

\({}^{3}\)Department of Biomedical Engineering, Carnegie Mellon University

\({}^{4}\)Department of Electrical and Computer Engineering, Carnegie Mellon University

\({}^{5}\)Center for the Neural Basis of Cognition

{yminai,jsoldado,msmith,byronyu}@andrew.cmu.edu

*Denotes equal contribution.

###### Abstract

Brain stimulation has the potential to create desired neural population activity states. However, it is challenging to search the large space of stimulation parameters, for example, selecting which subset of electrodes to be used for stimulation. In this scenario, creating a model that maps the configuration of stimulation parameters to the brain's response can be beneficial. Training such an expansive model usually requires more stimulation-response samples than can be collected in a given experimental session. Furthermore, changes in the properties of the recorded activity over time can make it challenging to merge stimulation-response samples across sessions. To address these challenges, we propose MiSO (MicroStimulation Optimization), a closed-loop stimulation framework to drive neural population activity toward specified states by optimizing over a large stimulation parameter space. MiSO consists of three key components: 1) a neural activity alignment method to merge stimulation-response samples across sessions, 2) a statistical model trained on the merged samples to predict the brain's response to untested stimulation parameter configurations, and 3) an online optimization algorithm to adaptively update the stimulation parameter configuration based on the model's predictions. In this study, we implemented MiSO with a factor analysis (FA) based alignment method, a convolutional neural network (CNN), and an epsilon greedy optimization algorithm. We tested MiSO in closed-loop experiments using electrical microstimulation in the prefrontal cortex of a non-human primate. Guided by the CNN predictions, MiSO successfully searched amongst thousands of stimulation parameter configurations to drive the neural population activity toward specified states. More broadly, MiSO increases the clinical viability of neuromodulation technologies by enabling the use of many-fold larger stimulation parameter spaces.

## 1 Introduction

Brain stimulation is an important tool for treating brain disorders  and for causally perturbing neural activity states to understand brain function . Because complex brain functions are realized through the coordinated activity of populations of neurons, brain stimulation techniques to control neural population activity have the potential to manipulate complex brain function. Most brain stimulation studies to date have used electrical microstimulation to produce a motor response  or perceptual experience , disrupt neural activity , or shift cognitive state . It has been less common to consider the response of a population of neurons to microstimulation . In principle, different combinations of stimulation parameters make it possible to create diverseneural population activity patterns [15; 16; 17; 18; 19; 20]. However, it is challenging to identify specific stimulation parameters that achieve a desired activity manipulation for an entire recorded neural population.

Previous studies have developed closed-loop stimulation methods to search the stimulation parameter space [12; 21; 22]. A key challenge for closed-loop stimulation is to widely sample the multi-dimensional stimulation parameter space. It is necessary to collect many stimulation-response samples before the closed-loop stimulation procedure can begin to work effectively. A key innovation of our work is to merge stimulation-response samples across experimental sessions [23; 24; 25]. The ability to merge data leverages the finding that neural population activity tends to occupy a lower-dimensional space than the number of neurons being recorded, which enables the alignment of low-dimensional spaces across sessions. By merging data across multiple previous sessions, it is possible for the closed-loop stimulation procedure to work effectively starting from the very outset of the current session.

In this study, we propose MiSO (MicroStimulation Optimization), a closed-loop stimulation framework to drive neural population activity toward specified states by optimizing over a large stimulation parameter space (Section 2.1). MiSO consists of three key components: 1) a neural activity alignment method to merge stimulation-response samples across sessions (Sections 2.2 and 2.3), 2) a statistical model trained on the merged samples to predict the brain's response to untested stimulation parameter configurations (Section 2.4), and 3) a closed-loop optimization algorithm to adaptively update the model's predictions and then choose the next stimulation parameter configuration to test (Section 2.5). In this study, we implemented MiSO with a factor analysis (FA) based alignment method , a convolutional neural network (CNN) model , and an epsilon greedy optimization algorithm . These methods were chosen to satisfy the fast online computation requirement during the closed-loop stimulation experiments with a predictive model trained on a limited amount of data. However, MiSO is a general framework and applicable to other design choices.

We tested MiSO using electrical microstimulation (uStim) in a non-human primate implanted with a multi-electrode array in the prefrontal cortex (PFC, area 8Ar). MiSO was used to optimize the location of the stimulated electrode(s) on each trial through closed-loop updates, while keeping other parameter values such as current amplitude and frequency fixed. We considered a large uStim parameter space, defined by all possible patterns in which two electrodes out of 96 electrodes are stimulated (4,560 patterns). MiSO's latent alignment method enabled us to merge neural activity across sessions to increase the number of stimulation-response samples (Section 3.1). MiSO's CNN model trained on these merged stimulation-response samples accurately predicted neural responses to untested uStim parameter configurations (Section 3.2). In closed-loop experiments with a non-human primate, MiSO successfully searched among 4,560 uStim parameter configurations to drive the neural population activity toward targeted states. By enabling the search of a larger stimulation parameter space, MiSO produced novel population activity patterns which were not achievable by searching over a smaller stimulation parameter space (Section 3.3).

## 2 Methods

### MiSO overview

The goal of MiSO is to identify stimulation parameter configurations that produce specified neural population activity states (Fig. 1A). MiSO first identifies a reference low-d latent space of the high-d population activity to which the neural activity from all the other experimental sessions are aligned (Fig. 1B, Section 2.2). MiSO then collects stimulation-response samples on multiple experimental sessions, then merges the samples using latent space alignment (Section 2.3). The samples are used to fit a statistical model to predict the brain's response to all possible stimulation parameter configurations within the set of parameters defined by the user (Section 2.4). These model predictions obtained prior to the closed-loop experimental session(s) are used to initialize the optimization procedure. At the beginning of each closed-loop experimental session, MiSO identifies the latent space for the session. MiSO then aligns it to the reference latent space, which was used to generate the model predictions (Section 2.5). On each trial, MiSO stimulates using the chosen parameters and updates the predictions based on the responses measured online (Fig. 1C). MiSO iteratively runs this optimization over trials to produce the specified latent activity state.

In the following sections, we refer to a specific stimulation parameter configuration as a "stimulation pattern" and the induced brain response as the "stimulation response". The stimulation patternstested in this study consist of all possible patterns in which one of 96 electrodes is stimulated (single electrode stimulation patterns) and/or two of 96 electrodes are stimulated (double electrode stimulation patterns). While the neural activity used in this study consists of spiking responses recorded with a planar grid of electrodes implanted in the brain and each stimulation pattern specifies the location of the electrodes used for stimulation within the grid, MiSO can be readily applied to other stimulation/recording protocols (e.g., holographic optogenetics ).

### Latent space identification

To merge stimulation-response samples across multiple experimental sessions, MiSO identifies a low-d latent space of the high-d population activity in each session. For this study, we used Factor Analysis (FA), which provides computationally fast latent space identification and latent state estimation, compatible with closed-loop experiments. Since MiSO's ultimate goal is to create targeted changes in neural population activity that lead to changes in brain state and in turn behavior, MiSO identifies the intrinsic latent space only using non-stimulation trials.

For the \(i\)th session, MiSO extracts a list of \(n_{i}\) "usable" electrodes \(_{i}^{n_{i}}\), where each element of \(_{i}\) is an integer representing one of the electrodes. An electrode is deemed "usable" if it satisfies criteria involving its mean firing rate, Fano factor, and coincident spiking with other electrodes (see Section S1). For each time bin indexed by \(k=1,...,K_{i}^{noStim}\), MiSO then takes spike counts during the fixation period (Fig. 1B) on each usable electrode \(_{i,k}^{noStim}^{n_{i}}\). MiSO fits the following FA model using the EM algorithm:

\[&_{i,k}^{noStim}\ (0,I)\\ &_{i,k}^{noStim}|_{i,k}^{noStim}\ ( _{i}_{i,k}^{noStim}+},_{i})\] (1)

where \(_{i,k}^{noStim}^{m}\), with \(m<n_{i}\), is the low-d latent activity for the \(k\)th time bin, \(_{i}^{n_{i} m}\) is the loading matrix whose columns define the low-d latent space, \(}^{n_{i}}\) contains the mean spike counts for each electrode, and \(_{i}^{n_{i} n_{i}}\) is a diagonal matrix capturing the independent variance of the spike counts for each electrode.

### Latent space alignment

To merge neural activity across experimental sessions, we used the latent space alignment method introduced in  (termed "FA+Procrustes"). It has been shown to work well in a brain-computer

Figure 1: **Experimental paradigm and MiSO closed-loop framework.** (A) MiSO’s goal is to optimize brain stimulation parameter configurations to create specified neural population activity states. (B) Experimental setup. Top: Spiking activity was recorded from a multi-electrode array implanted in PFC. During fixation, uStim was applied for 150ms (orange bar) to induce a specified neural population activity state in the post uStim period (pink bar). Bottom: The uStim response was evaluated within a low-d latent space (e.g., 2D) identified from high-d multi-electrode spiking activity. (C) Closed-loop stimulation framework. Each MiSO iteration involves four steps (Section 2.5).

interface, which like MiSO is a closed-loop experimental paradigm. The FA+Procrustes method solves the Procrustes problem to find an orthogonal transformation matrix to maximize the alignment between two FA loading matrices. First, MiSO runs a single experimental session exclusively with non-stimulation trials and extracts a list of usable electrodes \(}\), which contains \(n_{0}\) electrodes. MiSO uses the data from this session to identify a reference latent space \(_{0}^{n_{0} m}\). For each subsequent session, MiSO aligns the latent space identified in the \(i\)th session \(_{i}\) to the reference latent space \(_{0}\). Concretely, for the \(i\)th session, MiSO identifies an orthogonal transformation matrix \(}^{m m}\) that fulfills:

\[}=*{argmin}_{O:OO^{T}=I}\|_{0}(},:)- _{i}(},:)O^{T}\|_{F}^{2}\] (2)

where \(}=}}\) is a list of usable electrodes common to the reference session and the \(i\)th session, and \(\|\|_{F}\) is the Frobenius Norm. This optimization can be solved in closed-form . The \(}\) found is applied to \(_{i}\) to obtain the aligned latent space \(_{i}^{n_{i} m}\):

\[_{i}=_{i}}^{}\] (3)

The latent activity in the post-stimulation period (Fig. 1B) is estimated as the posterior mean from the FA model (equation (1)) using the loading matrix \(_{i}\):

\[_{i,k}^{Stim}=_{i}(_{i,k}^{Stim}-})\] (4)

where \(_{i,k}^{Stim}^{m}\), \(_{i,k}^{Stim}^{n_{i}}\), and \(_{i}=_{i}^{}(_{i}_ {i}^{}+_{i})^{-1}\). By using \(_{i}\), the induced latent activity \(_{i,k}^{Stim}\) resides in a common latent space across all sessions.

### Stimulation-response sample collection and CNN model fitting

To predict the stimulation response to untested stimulation patterns, MiSO uses a statistical model trained on the merged neural activity across sessions. We used a CNN in this study to capture the spatial structure of the stimulation-response relationship across the multi-electrode array (see Sections 2.7 and 3.2 for model selection). To train the CNN, MiSO runs two phases of experimental sessions to collect stimulation-response samples. In the first phase, MiSO applies randomly-selected stimulation patterns to train an initial CNN model. In the second phase, MiSO uses the trained CNN to choose stimulation patterns to maximize the diversity of the observed stimulation responses.

#### 2.4.1 Phase 1: Random stimulation pattern selection

In the first phase, we apply random stimulation patterns over \(R\) experimental sessions to train the initial CNN model. With a planar grid of electrodes of size \(h v\), the stimulation pattern tested in the \(k\)th trial during the \(i\)th session \(S_{i,k}^{h v}\) is encoded using a value of 1 for stimulated electrodes and 0 for all other electrodes. The induced latent activity state \(_{i,k}^{Stim}^{m}\) is computed using equation (4). The entries of \(_{i,k}^{Stim}\) corresponding to the user defined \(t\) target dimensions within the \(m\) dimensional aligned latent space (\(t m\)) are subselected and collected in a new vector \(}_{i,k}^{Stim}^{t}\). All tested stimulation patterns \(S_{i,k}\) and corresponding responses \(}_{i,k}^{Stim}\) across \(R\) sessions are appended to obtain \(S_{k}^{h v}\) and \(}_{k}^{Stim}^{t}\), where \(k=1,...,K^{Stim}\), and \(K^{Stim}\) is the total number of stimulation trials across sessions.

The totality of the stimulation-response samples \(S_{k}\) and \(}_{k}^{Stim}\) are used to train the CNN model, which maps the stimulation patterns \(S_{k}\) to the induced responses \(}_{k}^{Stim}\). Since the CNN predictions can be variable due to training using a finite number of stimulation-response samples, MiSO uses bagging to stabilize the CNN predictions . In bagging, \(M\) CNN models are fit with bootstrapping and the top \(C\) performing models in testing are used to generate predicted simulation responses for all \(P\) possible stimulation patterns defined by the user (e.g., \(P=4,560\) for double electrode stimulation patterns, computed as "96 choose 2" electrodes) (Section S2). For \(p=1,,P\), the predicted response \(}_{p}^{t}\) to the \(p\)th stimulation pattern \(S_{p}^{h v}\) is defined as the average prediction of the \(C\) CNN models.

#### 2.4.2 Phase 2: Guided stimulation pattern selection

Because the stimulation responses do not uniformly occupy the \(t\)-dimensional response space, choosing random stimulation patterns in Phase 1 tends to yield responses primarily in the densest

[MISSING_PAGE_FAIL:5]

where \(0<_{clip}<1\), and \(N(s)\) is the number of trials tested with the \(s\)th stimulation pattern within the current closed-loop session. The clipped learning rate allows MiSO to make larger updates at the beginning of the session, when the framework tries to adapt to stimulation responses in the current session, and smaller updates as the framework becomes more confident about the predictions.

After updating the prediction, MiSO chooses the stimulation pattern to test on the next trial using an epsilon greedy algorithm, which balances exploitation and exploration. With a probability of \(1-\), MiSO chooses the stimulation pattern which minimizes the L1 distance between the induced activity and the target state

\[s^{*}=*{argmin}_{s}\|}_{s}-}_{targ}\|_{1}\] (9)

and applies stimulation pattern \(S_{s^{*}}\) on the next trial. With a probability of \(\), MiSO chooses a random stimulation pattern among the \(P\) possible patterns. MiSO then iterates until the experimental session is terminated.

### Experiment details

We tested MiSO using electrical microstimulation (uStim) in a macaque monkey with a 96 electrode Utah array implanted in prefrontal cortex (PFC, area 8Ar). Experimental procedures were approved by the Institutional Animal Care and Use Committee (IACUC) of Carnegie Mellon University. In each experimental session, the monkey performed a visually-guided saccade task. Each trial began with the monkey fixating on a dot at the center of the screen (Section S3). On uStim trials, we applied uStim for 150 ms during the fixation period. For each session indexed by \(i\), we identified latent dimensions by applying FA to spike counts taken in 50 ms bins from usable electrodes \(}\) that passed a set of criteria (Section S1). Stimulation-response samples were collected starting 50 ms after uStim offset (Fig. 1B, pink) to avoid uStim artifacts.

The number of random stimulation sessions \(R\) and guided stimulation sessions \(G\) to collect stimulation-response samples for CNN training (Section 2.4) were chosen based on the number of trials the animal worked in each session (about 300-500 uStim trials per session). We performed \(R=3\) sessions with random uStim pattern sampling and \(G=2\) sessions with guided uStim pattern sampling. On each guided sampling session, we collected \(E_{g}=80\) patterns based on CNN predictions and \(E_{r}=20\) random patterns. We used the top \(C=10\) test performing models among \(M=50\) CNN models to obtain the CNN prediction. To calculate \(d_{p}\), we used 3 nearest neighbors of \(}_{p}\).

Each closed-loop experimental session started with \(K_{c}^{noStim}=100\) no-uStim trials for latent space calibration. For some sessions, this calibration period also included an additional 96 trials (one per single-electrode stimulation pattern). These observations were used to compare the performance of the "MiSO with single elec., sample avg." with the "Single elec., same day observation" (Fig. 2B). The latter method uses stimulation-response samples collected in the current session to initialize the predictions (Section S4). We chose \(t=2\) target dimensions among the \(m=4\) latent dimensions. The latent dimensionality \(m\) was determined based on the cross-validated data likelihood. We set the learning rate \(_{clip}\) as 0.1, chosen manually by assessing how the latent activity state changed over trials, and \(\) as 0.05, chosen by running simulations with previously-collected stimulation-response samples.

### Model comparison

To decide which prediction model to use in MiSO, we compared the prediction performance of uStim responses when holding out different percentages of uStim patterns in three models: Multi-Layer Perceptron (MLP) , Gaussian Process (GP) , and Convolutional Neural Network (CNN)  (Fig. 3). For all models, we only encoded the location of the stimulating electrodes as inputs in this study. Other stimulation parameters, such as stimulation amplitude and frequency, were constant across electrodes and trials (see Section S3). The models differed in their ability to capture any spatial structure present in the stimulation-response relationship, whereby stimulating with nearby electrodes could induce similar latent activity states.

Below we describe the input (i.e., stimulation pattern) encoding format for each model. For the \(k\)th trial on the \(i\)th session, the MLP model takes as input \(S_{i,k}^{MLP}\{0,1\}^{96}\), a one-hot vector representing each uStim pattern. Its entries have a value of 1 for each stimulated electrode and 0 for non-stimulated electrodes. Since the one-hot input does not designate which electrodes are close to or far from each other, this MLP model does not capture spatial structure among the stimulating electrodes. For the \(k\)th trial on the \(i\)th session, the GP model takes as input \(S_{i,k}^{GP}^{2n}\), where \(n\) is the number of electrodes used for stimulation. The locations of each stimulating electrode are encoded by a pair of values \(\{0,1,...,9\}\{0,1,...,9\}\), with the stimulating electrodes sorted in ascending order by electrode id. This input encoding format for the GP model captures spatial structure using a single Radial Basis Function kernel. Note that this format requires all stimulation patterns to have the same number of stimulating electrodes. For the \(k\)th trial on the \(i\)th session, the CNN takes a grid-format input with the same layout as the electrode array \(S_{i,k}^{CNN}\{0,1\}^{10 10}\), where electrodes being used for stimulation have a value of 1 and all other electrodes have a value of 0. The CNN captures spatial structure using multiple 2D convolutional filters applied to this grid input.

## 3 Results

### Merging stimulation-response samples across sessions

When the stimulation parameter space is large, the number of uStim patterns we can test within an experimental session is much smaller than the total number of possible uStim patterns. This requires merging neural activity across sessions to create a large enough set of stimulation-response samples to learn their relationship. To develop MiSO, we considered merging neural activity based on aligning latent spaces across sessions . To assess the effectiveness of this method for uStim, we empirically measured the uStim response for all possible single-electrode uStim patterns (96 patterns). We ran 5 experimental sessions in which we stimulated with each of the 96 electrodes on the array for 3-7 trials per session. We found that raw uStim responses were inconsistent across sessions due to neural recording instabilities but were more consistent within the aligned latent space (Fig. S1). This opened up the possibility of estimating uStim responses based on merged stimulation-response samples collected in previous sessions.

To test this idea, we ran closed-loop experiments with all single-electrode uStim patterns in which we used the sample average of the merged stimulation-response samples from previous sessions to initialize the predicted stimulation responses \(}_{p}\) in MiSO (Section 2.5). We call this method "MiSO with single elec., sample avg." (Section S4). Here, we could use this method instead of the CNN model to generate the predictions \(z_{p}\), given that for the small parameter space of single electrodes

Figure 2: **Closed-loop performance in a non-human primate of MiSO initialized using merged samples.** (A) An example closed-loop experimental session. The top two panels show smoothed (for visualization) FA latent activity in the two target dimensions. Trials for all three methods were interleaved in the session. The bottom two panels show the electrode selected for uStim on each trial by “Random uStim” and “MiSO with single elec., sample avg.”. (B) Mean L1 error relative to the “No uStim” baseline across 5 closed-loop experimental sessions. Error bars indicate standard error across sessions.

we could collect sufficient stimulation-response samples for all stimulation patterns to compute the average responses. We compared this method to two baselines, "No uStim" and "Random uStim" (Section S4), which allow us to assess whether MiSO induces activity closer to the target state than via natural activity fluctuations or random uStim patterns, respectively. On each trial, we randomly chose one of the three methods. "MiSO with single elec., sample avg." (Fig. 2A, blue lines and dots) drove neural activity closer to the target state than "No uStim" and "Random uStim" (Fig. 2A, gray and green lines). Across multiple sessions with a different target state on each session, MiSO achieved significantly smaller errors than the two baseline methods (Fig. 2B, \(N=5\) sessions, \(p<0.05\) for "No uStim" and "Random uStim", one-tailed t-test). These results indicate that MiSO can identify effective stimulation patterns by leveraging merged samples from previous sessions.

To further validate the utility of merging past observations, we compared MiSO's performance with a method where the predictions were initialized using stimulation-response samples (one uStim trial for each of 96 electrodes) acquired immediately before starting the closed-loop optimization. We call this method "Single elec., same day observation". This method and MiSO use different approaches to initialize the same closed-loop procedure (equations (6)-(9)). MiSO leverages stimulation-response samples collected across multiple previous sessions for initialization. By contrast, "Single elec., same day observation" uses the stimulation-response samples that can be collected in the current session for initialization, with the advantage that it gets to observe responses in the current session. We found that "MiSO with single elec., sample avg." performed equivalently to "Single elec., same day observation" (Fig. 2B, \(N=5\) sessions, \(p=0.715\), two-tailed t-test). This result indicates that the merging of stimulation-response samples across previous sessions in MiSO enables the closed-loop stimulation procedure to work effectively from the very outset of the current session. Furthermore, this result using single-electrode stimulation patterns represents an important building block for optimizing over larger stimulation parameter spaces, where merging stimulation-response samples across sessions becomes essential.

Figure 3: **Leveraging spatial smoothness to predict uStim responses to untested uStim patterns.** (A) uStim pattern difference determined by the physical location(s) of the stimulating electrode(s) on the array (illustrated here for single-electrode patterns). (B) Relationship between uStim pattern difference (horizontal axis, L1 distance, Section S5) and uStim response difference (vertical axis, latent activity difference along FA dim1) when stimulating using single electrodes. A positive correlation (\(r\)) implies that stimulating using nearby electrodes tended to induce similar responses. (C) uStim response prediction error as a function of the percentage of held-out uStim patterns during training. Error bars indicate standard error across test datasets. The black square indicates the test MSE achieved using the sample average of the training data. (D, E) Same format as (B) and (C) respectively, but for stimulation using double-electrode patterns. In (E), we experimentally tested 45% of all possible double-electrode patterns (9 sessions, 3301 trials).

### Predicting uStim responses using a CNN

When a search space is small (e.g., 96 single electrodes), we can measure the responses to all uStim patterns to initialize MiSO (as we did with "MiSO with single elec., sample avg.", Section 3.1). This method becomes untenable as we increase size of the stimulation parameter space (e.g., stimulating two electrodes out of 96 yields 4,560 uStim patterns, which would require more than 30 experimental sessions to collect 3 repeats of each uStim pattern). Thus, to expand the stimulation parameter space with MiSO, we need to reduce the required number of stimulation-response samples to learn their relationship.

We asked whether there was spatial structure in the stimulation-response relationship, which could be leveraged to predict the uStim response with a limited number of samples (Fig. 3A). For this, we ran 5 experimental sessions in which we stimulated with each of the 96 electrodes on the array for 3-7 trials per session. With single-electrode uStim, we indeed observed spatial smoothness in the uStim response across physical locations on the array (Fig. 3B, Fig. S2A). In other words, stimulating with nearby electrodes tended to induce similar responses. We then asked whether we could use this property to predict the response to untested uStim patterns. We found that the GP and CNN models more accurately predicted uStim responses than the MLP model when holding out uStim patterns, indicating that spatial smoothness is a useful property for generalization to untested uStim patterns (Fig. 3C).

To increase the size of the stimulation parameter space, we ran 9 experimental sessions in which we stimulated with two out of 96 electrodes (4,560 possible patterns). We were only able to test 45 percent of this large number of possible uStim patterns, with most of the uStim patterns tested for one trial each. As with the single-electrode uStim patterns, we also observed spatial smoothness in the double-electrode uStim patterns (Fig. 3D, Fig. S2B). By leveraging this spatial smoothness, the CNN achieved better generalization performance to untested uStim patterns than the other models (Fig. 3E). Although both the GP and CNN capture aspects of spatial smoothness, the CNN outperformed the GP for double-electrode uStim. Whereas the CNN uses multiple convolution filters to capture the spatial structure of uStim patterns, the GP uses just one spatial kernel, likely limiting its performance. Furthermore, there is no natural input encoding format for a GP when stimulating using more than one electrode on a 2D array. Overall, these results indicate that the CNN model can generalize its predictions to even untested uStim patterns, enabling MiSO to perform closed-loop optimization over a large stimulation parameter space with a limited number of stimulation-response samples.

Figure 4: **Closed-loop performance in a non-human primate of MiSO initialized using a CNN.** (A) Range of activity patterns achievable by single (blue) and double (pink) electrode uStim patterns, as predicted by the CNN. Dashed region: area reachable exclusively by double-electrode uStim. Yellow star: target state used in (B). (B) Example closed-loop experimental session. Same format as Fig. 2A. (C) Mean L1 error of different methods relative to “No uStim”baseline, across 3 closed-loop sessions. Error bars indicate standard error across sessions.

### Closed-loop testing of MiSO initialized using a CNN

By combining the latent space alignment method (Section 3.1) and the CNN prediction model (Section 3.2), we tested MiSO in closed-loop experiments in a non-human primate over a large uStim parameter space, defined by all possible double-electrode uStim patterns (4,560 patterns). To train the CNN model, we ran 2,122 double-electrode uStim trials across 5 sessions (representing ~30 percent of the possible patterns) and merged the stimulation-response samples using latent space alignment. Using the trained CNN model, we predicted the uStim response for all double-electrode uStim patterns. The key motivation of expanding the stimulation parameter space is to expand the range of uStim responses that can be produced. Based on the CNN predictions, we found that the range of activity states achievable by double-electrode stimulation patterns spanned novel regions of the target space that were not reachable using single-electrode uStim (Fig. 4A, Fig. S3).

To demonstrate the benefit of searching a larger stimulus parameter space, we ran closed-loop experiments in which we set the target states to those exclusively reachable using double-electrode uStim patterns (Fig. 4A, yellow star). We implemented "MiSO with double elec., CNN", in which CNN predictions \(_{p}\) were used to initialize the closed-loop optimization (Section 2.5). We compared the performance of "MiSO with double elec., CNN" with three baselines: "No uStim", "Random uStim", as well as MiSO optimizing over the 96 single-electrode uStim patterns (termed "MiSO with single elec., CNN"). If the CNN predictions are meaningful and the closed-loop optimization is able to guide the search in the stimulus parameter space, "MiSO with double elec., CNN" would outperform the three baselines. Indeed, "MiSO with double elec., CNN" (Fig. 4B, pink lines and dots) successfully identified double-electrode uStim patterns that induced responses closer to the target state than the three baseline methods (gray, green, and blue lines). Across multiple sessions with different target states, "MiSO with double elec., CNN" produced smaller errors than the three baseline methods (Fig. 4C, \(N=3\) sessions, \(p<0.05\) for "No uStim" and "Random uStim", and \(p=0.079\) for "MiSO with single elec., CNN", one-tailed t-test). These results demonstrate the utility of MiSO, which enables searching over a larger stimulation parameter space than previously possible.

## 4 Discussion

In this work, we proposed MiSO which searches a large stimulation parameter space to drive neural population activity toward specified states. MiSO's closed-loop optimization procedure is guided by predictions of a CNN trained on merged neural activity across sessions. To our knowledge, this is the first study to apply latent space alignment in the field of brain stimulation to merge stimulation-response samples across sessions. This enables MiSO to search larger stimulation parameter spaces than previously possible.

Although we demonstrated MiSO's functionality in a 2D target space (\(t=2\)), the neural activity corresponding to a desired brain state might need to be specified in a higher dimensional space (\(t>2\)). As the dimensionality of the target space grows, it may become necessary to expand the stimulation parameter space in order to achieve a greater variety of target states. Provided that a target state is achievable, the epsilon greedy algorithm would require more time to identify appropriate stimulus parameter configurations. The reason is that a stimulation pattern that successfully achieves a target in two dimensions would not necessarily produce the desired activity if a third dimension was added to the target specification. In this case, the use of a more efficient online algorithm would be beneficial to reduce the exploration of suboptimal stimulation parameter configurations.

To expand the range of achievable population activity states, one might consider expanding the stimulation parameter space. For example, in the context of electrical microstimulation, we could use stimulation patterns involving larger numbers of electrodes and/or different current amplitudes or frequencies. For the CNN model (or any other predictive model) to retain its prediction accuracy, it would likely need to capture additional structure in the stimulation-response relationship (e.g., similar stimulation amplitudes or frequencies lead to similar responses) and require more training data. Furthermore, MiSO's closed-loop updates of the predicted responses are performed separately for each stimulation pattern (equation (7)), which becomes untenable as the stimulation parameter space grows. In this case, incorporating a statistical model in the closed-loop updates to account for spatial (or other) structure could be beneficial, such that observing a response to one stimulation pattern leads to updates of the predicted responses for multiple stimulation patterns. These computations would need to be performed fast enough to be used in a closed-loop optimization procedure.

## 5 Acknowledgments

This work was supported by NIH CRCNS R01 MH118929, NSF NCS DRL 2124066, Simons Foundation 543065 and NC-GB-CULM-00003241-05, and Japan Student Services Organization fellowship. We are grateful to Samantha Schmitt for assistance with data collection, and Karen McCracken and Mary Ellen Smyth for animal care.