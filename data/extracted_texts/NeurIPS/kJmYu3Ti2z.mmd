# When Do Graph Neural Networks Help with Node Classification? Investigating the Impact of Homophily Principle on Node Distinguishability

When Do Graph Neural Networks Help with Node Classification? Investigating the Impact of Homophily Principle on Node Distinguishability

 Sitao Luan\({}^{1,2}\), Chenqing Hua\({}^{1,2}\), Minkai Xu\({}^{4}\), Qincheng Lu\({}^{1}\), Jiaqi Zhu\({}^{1}\), Xiao-Wen Chang\({}^{1,}\), Jie Fu\({}^{2,5,}\), Jure Leskovec\({}^{4,}\), Doina Precup\({}^{1,2,3,}\)

{sitao.luan@mail, chenqing.hua@mail, qincheng.lu@mail, jiaqi.zhu@mail, chang@cs, dprecup@cs}.mcgill.ca, {minkai, jure}@cs.stanford.edu, jiefu@ust.hk

\({}^{1}\)McGill University; \({}^{2}\) Mila - Quebec Artificial Intelligence Institute; \({}^{3}\)Google DeepMind;

\({}^{4}\)Stanford University; \({}^{5}\)HKUST; \({}^{}\) Corresponding Authors

###### Abstract

Homophily principle, _i.e.,_ nodes with the same labels are more likely to be connected, has been believed to be the main reason for the performance superiority of Graph Neural Networks (GNNs) over Neural Networks on node classification tasks. Recent research suggests that, even in the absence of homophily, the advantage of GNNs still exists as long as nodes from the same class share similar neighborhood patterns . However, this argument only considers intra-class Node Distinguishability (ND) but neglects inter-class ND, which provides incomplete understanding of homophily on GNNs. In this paper, we first demonstrate such deficiency with examples and argue that an ideal situation for ND is to have smaller intra-class ND than inter-class ND. To formulate this idea and study ND deeply, we propose Contextual Stochastic Block Model for Homophily (CSBM-H) and define two metrics, Probabilistic Bayes Error (PBE) and negative generalized Jeffreys divergence, to quantify ND. With the metrics, we visualize and analyze how graph filters, node degree distributions and class variances influence ND, and investigate the combined effect of intra- and inter-class ND. Besides, we discovered the mid-homophily pitfall, which occurs widely in graph datasets. Furthermore, we verified that, in real-work tasks, the superiority of GNNs is indeed closely related to both intra- and inter-class ND regardless of homophily levels. Grounded in this observation, we propose a new hypothesis-testing based performance metric beyond homophily, which is non-linear, feature-based and can provide statistical threshold value for GNNs' the superiority. Experiments indicate that it is significantly more effective than the existing homophily metrics on revealing the advantage and disadvantage of graph-aware modes on both synthetic and benchmark real-world datasets.

## 1 Introduction

Graph Neural Networks (GNNs) have gained popularity in recent years as a powerful tool for graph-based machine learning tasks. By combining graph signal processing and convolutional neural networks, various GNN architectures have been proposed , and have been shown to outperform traditional neural networks (NNs) in tasks such as node classification (**NC**), graph classification, link prediction and graph generation. The success of GNNs is believed to be rooted in the homophily principle (assumption) , which states that connected nodes tend to have similar attributes , providing extra useful information to the aggregated features over the original node features. Such relational inductive bias is thought to be a major contributor to the superiority of GNNs over NNs on various tasks . On the other hand, the lack of homophily, _i.e.,_ heterophily, is considered as the main cause of the inferiority of GNNs on heterophilic graphs, because nodes from different classes are connected and mixed, which can lead to indistinguishable node embeddings, making the classification task more difficult for GNNs . Numerous models have been proposed to address the heterophily challenge lately .

Recently, both empirical and theoretical studies indicate that the relationship between homophily principle and GNN performance is much more complicated than "homophily wins, heterophily loses" and the existing homophily metrics cannot accurately indicate the superiority of GNNs [38; 35; 37]. For example, the authors in  stated that, as long as nodes within the same class share similar neighborhood patterns, their embeddings will be similar after aggregation. They provided experimental evidence and theoretical analysis, and concluded that homophily may not be necessary for GNNs to distinguish nodes. The paper  studied homophily/heterophily from post-aggregation node similarity perspective and found that heterophily is not always harmful, which is consistent with . Besides, the authors in  have proposed to use high-pass filter to address some heterophily cases, which is adopted in [7; 5] as well. They have also proposed aggregation homophily, which is a linear feature-independent performance metric and is verified to be better at revealing the performance advantages and disadvantages of GNNs than the existing homophily metrics [46; 57; 32]. Moreover,  has investigated heterophily from a neighbor identifiable perspective and stated that heterophily can be helpful for NC when the neighbor distributions of intra-class nodes are identifiable.

Inspite that the current literature on studying homophily principle provide the profound insights, they are still deficient: 1. [38; 6] only consider intra-class node distinguishability (**ND**), but ignore inter-class ND; 2.  does not show when and how high-pass filter can help with heterophily problem; 3. There is a lack of a non-linear, feature-based performance metric which can leverage richer information to provide an **accurate statistical threshold value** to indicate whether GNNs are really needed on certain task or not.

To address those issues, in this paper: 1. We show that, to comprehensively study the impact of homophily on ND, one needs to consider both intra- and inter-class ND and an ideal case is to have smaller intra-class ND than inter-class ND; 2. To formulate this idea, we propose Contextual Stochastic Block Model for Homophily (CSBM-H) as the graph generative model. It incorporates an explicit parameter to manage homophily levels, alongside class variance parameters to control intra-class ND, and node degree parameters which are important to study homophily [38; 54]; 3. To quantify ND of CSBM-H, we propose and compute two ND metrics, Probabilistic Bayes Error (**PBE**) and Negative Generalized Jeffreys Divergence (\(D_{}\)), for the optimal Bayes classifier of CSBM-H. Based on the metrics, we can analytically study how intra- and inter-class ND impact ND together. We visualize the relationship between PBE, \(D_{}\) and homophily levels and discuss how different graph filters (full-, low- and high-pass filters), class variances and node degree distributions will influence ND in details; 4. In practice, we verify through hypothesis testing that the performance superiority of GNNs is indeed related to whether intra-class ND is smaller than inter-class ND, regardless of homophily levels. Based on this conclusion and the p-values of hypothesis testing, we propose Classifier-based Performance Metric (CPM), a new non-linear feature-based metric that can provide statistical threshold values. Experiments show that CPM is significantly more effective than the existing homophily metrics on predicting the superiority of graph-aware models over graph-agnostic.

## 2 Preliminaries

We use **bold** font for vectors (_e.g.,\(\)_) and define a connected graph \(=(,)\), where \(\) is the set of nodes with a total of \(N\) elements, \(\) is the set of edges without self-loops. \(A\) is the symmetric adjacency matrix with \(A_{i,j}=1\) if there is an edge between nodes \(i\) and \(j\), otherwise \(A_{i,j}=0\). \(D\) is the diagonal degree matrix of the graph, with \(D_{i,i}=d_{i}=_{j}A_{i,j}\). The neighborhood set \(_{i}\) of node \(i\) is defined as \(_{i}=\{j:e_{ij}\}\). A graph signal is a vector in \(^{N}\), whose \(i\)-th entry is a feature of node \(i\). Additionally, we use \(X^{N F_{h}}\) to denote the feature matrix, whose columns are graph signals and \(i\)-th row \(X_{i,:}=_{i}^{}\) is the feature vector of node \(i\) (_i.e.,_ the full-pass (FP) filtered signal). The label encoding matrix is \(Z^{N C}\), where \(C\) is the number of classes, and its \(i\)-th row \(Z_{i,:}\) is the one-hot encoding of the label of node \(i\). We denote \(z_{i}=*{arg\,max}_{j}Z_{i,j}\{1,2, C\}\). The indicator function \(_{B}\) equals 1 when event \(B\) happens and 0 otherwise.

For nodes \(i,j\), if \(z_{i}=z_{j}\), then they are considered as _intra-class nodes_; if \(z_{i} z_{j}\), then they are considered to be _inter-class nodes_. Similarly, an edge \(e_{i,j}\) is considered to be an _intra-class edge_ if \(z_{i}=z_{j}\), and an _inter-class edge_ if \(z_{i} z_{j}\).

### Graph-aware Models and Graph-agnostic Models

A network that includes the feature aggregation step according to graph structure is called graph-aware (**G-aware**) model, _e.g.,_ GCN , SGC ; A network that does not use graph structure information is called graph-agnostic (**G-agnostic**) model, such as Multi-Layer Perceptron with 2layers (MLP-2) and MLP-1. A G-aware model is often coupled with a G-agnostic model because when we remove the aggregation step in G-aware model, it becomes exactly the same as its coupled G-agnostic model, _e.g.,_ GCN is coupled with MLP-2 and SGC-1 is coupled with MLP-1 as below,

**GCN:**\(Y=(_{}\,(_{}XW_{0}) \,W_{1}),\,\,\,\,\,\,\,\,Y=((XW_{0})\,W_{1})\)

**SGC-1:**\(Y=(_{}XW_{0}),\,\,\,\,\,\,Y= (XW_{0})\)

 (1)

where \(_{}=^{-1/2}^{-1/2}\), \( A+I\) and \( D+I\); \(W_{0}^{F_{0} F_{1}}\) and \(W_{1}^{F_{1} O}\) are learnable parameter matrices. For simplicity, we denote \(y_{i}=*{arg\,max}_{j}Y_{i,j}\{1,2, C\}\). The random walk renormalized matrix \(_{}=^{-1}\) can also be applied to GCN, which is essentially a mean aggregator commonly used in some spatial-based GNNs . To bridge spectral and spatial methods, we use \(_{}\) in the theoretical analysis, but **self-loops are not added to the adjacency matrix** to maintain consistency with previous literature [38; 35].

To address the heterophily challenge, high-pass (HP) filter , such as \(I-_{}\), is often used to replace low-pass (LP) filter \(_{}\) in GCN [5; 7; 35]. In this paper, we use \(_{}\) and \(I-_{}\) as the LP and HP operators, respectively. The LP and HP filtered feature matrices are represented as \(H=_{}X\) and \(H^{}=(I-_{})X\). For simplicity, we denote \(_{i}=(H_{i,:})^{},_{i}^{}=(H_{i,:}^{})^{}\).

**To measure how likely the G-aware model can outperform its coupled G-agnostic model before training them** (_i.e.,_ if the aggregation step according to graph structure is helpful for node classification or not), a lot of homophily metrics have been proposed and we will introduce the most commonly used ones in the following subsection.

### Homophily Metrics

The homophily metric is a way to describe the relationship between node labels and graph structure. We introduce five commonly used homophily metrics: edge homophily [1; 57], node homophily , class homophily , generalized edge homophily  and aggregation homophily , adjusted homophily  and label informativeness  as follows:

\[_{}()=\{e_{w}|e_{w} ,Z_{u,}-Z_{s,}\}}{||},\,_{}( )=|}_{v}_{}^{v}=|}_{v}\{v|u _{v},Z_{u,}=Z_{v,:}\}}{d_{v}},\] (2) \[_{}()=_{k=1}^{C} h_{k}\!-\!\{i\!Z_{v,k=1}\}}{N}_{+}, \,\,\,\,h_{k}\!=\!,Z_{u,k=1}}\{ _{v},Z_{u,:}=Z_{v,:}\}}{_{v\{v|Z_{v,k=1} \}}d_{v}},\] \[_{}()=}(_{i},_{j})}{||},\,_{}( )=|}\{v\,|\,_{u}(\{S (,Z_{v,i}^{Z_{u,i}}=Z_{s,:}\})_{u}(\{S(,Z_{v,i}^ {Z_{u,i}} Z_{c,:}\})\}).\] \[_{}=_{}-_{c=1}^{C }_{c}^{2}}{1-_{k=1}^{C}_{c}^{2}},\,\,=-,c_{2}}p_{c_{1},c_{2}},c_{2}}}{_{c_{1}}_{c_{2}}}}{_{c}_{c}_{c}}=2-,c_{2}}p_{c_{1},c_{ 2}} p_{c_{1},c_{2}}}{_{c}_{c}_{c}}\]

where \(_{}^{v}\) is the local homophily value for node \(v\); \([a]_{+}=(0,a)\); \(h_{k}\) is the class-wise homophily metric ; \(_{u}(\{\})\) takes the average over \(u\) of a given multiset of values or variables and \(S(,Z)=Z(Z)^{}\) is the post-aggregation node similarity matrix; \(D_{c}=_{v:z_{v}=c}d_{v},_{c}=}{2||}\), \(p_{c_{1},c_{2}}=_{(u,v)}\{z_{u}=c_{1},z_{v}=c _{2}\}}{2||},c,c_{1},c_{2}\{1,,C\}\).

These metrics all fall within the range of \(\), with a value closer to \(1\) indicating strong homophily and implying that G-aware models are more likely to outperform its coupled G-agnostic model, and vice versa. However, the current homophily metrics are almost all linear, feature-independent metrics which cannot provide a threshold value  for the superiority of G-aware model and fail to give an accurate measurement of node distinguishability (ND). In the following section, we focus on quantifying the ND of graph models with with homophily levels and analyzing their relations.

## 3 Analysis of Homophily on Node Distinguishability (ND)

### Motivation

The Problem in Current LiteratureRecent research has shown that heterophily does not always negatively impact the embeddings of intra-class nodes, as long as their neighborhood patterns "corrupt in the same way" [38; 6]. For example, in Figure 1, nodes {1,2} are from class blue and both have the same heterophilic neighborhood patterns. As a result, their aggregated features will still be similar and they can be classified into the same class.

However, this is only partially true for ND if we forget to discuss inter-class ND, _e.g.,_ node 3 in Figure 1 is from class green and has the same neighborhood pattern (\(1/3\) orange, \(1/3\) yellow and \(1/3\) green) as nodes {1,2}, which means the inter-class ND will be lost after aggregation. This highlights the necessity for careful consideration of both intra- and inter-class ND when evaluating the impact of homophily on the performance of GNNs and an ideal case for NC would be node {1,2,4}, where we have smaller intra-class "distance" than inter-class "distance". We will formulate the above idea in this section and verify if it really relates to the performance of GNNs in section 4. In the following subsection, we will propose a toy graph model, on which we can study the relationship between homophily and ND directly and intuitively, and analyze intra- and inter-class ND analytically.

### CSBM-H and Optimal Bayes Classifier

In order to have more control over the assumptions on the node embeddings, we consider the Contextual Stochastic Block Model (CSBM) . It is a generative model that is commonly used to create graphs and node features, and it has been widely adopted to study the behavior of GNNs . To investigate the impact of homophily on ND, the authors in  simplify CSBM to the two-normal setting, where the node features \(X\) are assumed to be sampled from two normal distributions and intra- and inter-class edges are generated according to two separate parameters. This simplification does not lose much information about CSBM, but 1. it does not include an explicit homophily parameter to study homophily directly and intuitively; 2. it does not include class variance parameters to study intra-class ND; 3. the authors do not rigorously quantify ND.

In this section, we introduce the Contextual Stochastic Block Model for Homophily/Heterophily (CSBM-H), which is a variation of CSBM that incorporates an explicit homophily parameter \(h\) for the two-normal setting and also has class variance parameters \(_{0}^{2},_{1}^{2}\) to describe the intra-class ND. We then derive the optimal Bayes classifier (CL\({}_{}\)) and negative generalized Jeffreys divergence for CSBM-H, based on which we can quantify and investigate ND for CSBM-H.

CSBM-H(\(_{0},_{1},_{0}^{2}I,_{1}^{2}I,d_{0},d_{1},h\))1The generated graph consists of two disjoint sets of nodes, \(i_{0}\) and \(j_{1}\), corresponding to the two classes. The features of each node are generated independently, with \(_{i}\) generated from \(N(_{0},_{0}^{2}I)\) and \(_{j}\) generated from \(N(_{1},_{1}^{2}I)\), where \(_{0},_{1}^{F_{h}}\) and \(F_{h}\) is the dimension of the embeddings. The degree of nodes in \(_{0}\) and \(_{1}\) are \(d_{0},d_{1}\) respectively. For \(i_{0}\), its neighbors are generated by independently sampling from \(h d_{0}\) intra-class nodes and \((1-h) d_{0}\) inter-class nodes 2. The neighbors of \(j_{1}\) are generated in the same way. As a result, the FP (full-pass), LP and HP filtered features are generated as follows,

\[& i_{0}:_{i} N(_{0}, _{0}^{2}I);\;_{i} N(}_{0},_{0}^{2} I),\;_{i}^{} N(}_{0}^{},(_{0}^{})^{2}I),\\ & j_{1}:_{j} N(_{1},_{1}^{ 2}I);\;_{j} N(}_{1},_{1}^{2}I),\;_{j}^{} N(}_{1}^{},( _{1}^{})^{2}I),\] (3)

where \(}_{0}=h(_{0}-_{1})+_{1},\;\;}_{1}=h(_{1}-_{0})+_{0},\;\;}_{0}^{ }=(1-h)(_{0}-_{1}),\;\;}_{1}^{} =(1-h)(_{1}-_{0}),\;\;_{0}^{2}=^{2}-_{0}^{2})+_{1}^{2})}{d_{1}},\;\;_{1}^{2}= {(h(_{1}^{2}-_{0}^{2})+_{0}^{2})}{d_{1}},\;\;( _{0}^{})^{2}=_{0}^{2}+^{2}-_{1}^{2})+ _{1}^{2})}{d_{0}},\;\;(_{1}^{})^{2}=_{1}^{2} +^{2}-_{0}^{2})+_{0}^{2})}{d_{1}}\). If \(_{0}^{2}<_{1}^{2}\), we refer to \(_{0}\) as the low variation class and \(_{1}\) as the high variation class. The variance of each class can reflect the intra-class ND. We abuse the notation \(_{i}_{0}\) for \(i_{0}\) and \(_{j}_{1}\) for \(j_{1}\).

To quantify the ND of CSBM-H, we first compute the optimal Bayes classifier in the following theorem. The theorem is about the original features, but the results are applicable to the filtered features when the parameters are replaced according to equation 3.

**Theorem 1**.: Suppose \(_{0}^{2}_{1}^{2}\) and \(_{0}^{2},_{1}^{2}>0\), the prior distribution for \(\) is \((_{0})=(_{1})=1/2\), then the optimal Bayes Classifier (CL\({}_{}\)) for CSBM-H (\(_{0},_{1},_{0}^{2}I,_{1}^{2}I,d_{0},d_{1},h\)) is

Figure 1: Example of intra- and inter-class node distinguishability.

\[_{}()=1,\ () 0.5\\ 0,\ ()<0.5,\ ()=(z=1|)=))},\]

where \(Q()=a^{}+^{}+c,\ a=(^{2}}-^{3}}),=_{0}}{ _{0}^{3}}-_{1}}{_{1}^{2}},c=_{1}^{ }_{1}}{2_{1}^{2}}-_{0}^{}_{0}}{2 _{0}^{3}}+(^{}}{_{0}^{}})\]

3. See the proof in Appendix A.

**Advantages of \(_{}\) Over the Fixed Linear Classifier in ** The decision boundary in  is defined as \(P=\{|^{}-^{}(_{0}+_{1})/2\}\) where \(=(_{0}-_{1})/||_{0}-_{1}||_{2}\) is a fixed parameter. This classifier only depends on \(_{0}\), \(_{1}\) and is independent of \(h\). However, as \(h\) changes, the "separability" of the two normal distributions should be different. The fixed classifier cannot capture this difference, and thus is not qualified to measure ND for different \(h\). Besides, we cannot investigate how variances \(_{0}^{2},_{1}^{2}\) and node degrees \(d_{0},d_{1}\) affect ND with the fixed classifier in .

In the following subsection, we will define two methods to quantify ND of CSBM-H, one is based on \(_{}\), which is a precise measure but hard to be explainable; another is based on KL-divergence, which can give us more intuitive understanding of how intra- and inter-class ND will impact ND at different homophily levels. These two measurements can be used together to analyze ND.

### Measure Node Distinguishability of CSBM-H

The Bayes error rate (BE) of the data distribution is the probability of a node being mis-classified when the true class probabilities are known given the predictors . It can be used to measure the distinguishability of node embeddings and the BE for \(_{}\) is defined as follows,

**Definition 1** (Bayes Error Rate).: _The Bayes error rate  for \(_{}\) is defined as_

\[=_{}[(z|_{}()  z)]=_{}[1-(_{}()=z| )]\]

Specifically, the BE for CSBM-H can be written as

\[=(_{0})(1-( _{}()=0|_{0}))+( _{1})(1-(_{}()= 1|_{1})).\] (4)

To estimate the above value, we compute Probabilistic Bayes Error (PBE) for CSBM-H as follows.

**Probabilistic Bayes Error (PBE)** The random variable in each dimension of \(\) is independently normally distributed. As a result, \(Q()\) defined in Theorem 1 follows a generalized \(^{2}\) distribution (See the calculation in Appendix C). Specifically,

\[_{i}_{0},\ Q(_{i})^{2}(w_{0}, F_{h},_{0})+;\ _{j}_{1},\ Q(_{j})^{2}(w_{1},F_{h}, _{1})+\]

where \(w_{0}=a_{0}^{2},w_{1}=a_{1}^{2}\), the degree of freedom is \(F_{h}\), \(_{0}=(_{0}}{_{0}}+}{2a_{0}})^{ }(_{0}}{_{0}}+}{2a_{0}}),\ _{1}=(_{1}}{ _{1}}+}{2a_{1}})^{}(_{1}}{_{1} }+}{2a_{1}})\) and \(=c-^{}}{4a}\). Then, by using the Cumulative Distribution Function (CDF) of \(^{2}\), we can calculate the predicted probabilities directly as,

\[(_{}()=0|_{0})=1- _{^{2}(w_{0},F_{h},_{0})}(-),\ (_{}()=1|_{1})=_{^{2}(w_{1},F_{h},_{1})}(-).\]

Suppose we have a balanced prior distribution \((_{0})=(_{1})=1/2\). Then, PBE is,

\[_{^{2}(w_{0},F_{h},_{0})}(-)+(1- _{^{2}(w_{1},F_{h},_{1})}(-))}{2}\]

To investigate the impact of homophily on the ND for LP and HP filtered embeddings, we just need to replace \((_{0},_{0}^{2},_{1},_{1}^{2})\) by \((}_{0},_{0}^{2},}_{1},_{1}^{2})\) and \((}_{0}^{},(_{0}^{})^{2}, }_{1}^{},(_{1}^{})^{2})\) as equation 3.

PBE can be numerically calculated and visualized to show the relationship between \(h\) and ND precisely. However, we do not have an analytic expression for PBE, which makes it less explainable and intuitive. To address this issue, we define another metric for ND in the following paragraphs.

**Generalized Jeffreys Divergence** The KL-divergence is a statistical measure of how a probability distribution \(P\) is different from another distribution \(Q\). It offers us a tool to define an explainable ND measure, generalized Jeffreys divergence.

**Definition 2** (Generalized Jeffreys Divergence).: _For a random variable \(\) which has either the distribution \(P()\) or the distribution \(Q()\), the generalized Jeffreys divergence 4 is defined as_

\[D_{}(P,Q)=( P)_{ P}[ )}{Q()}]+( Q)_{  Q}[)}{P()}]\]With \(( P)=( Q)=1/2\)5, the negative generalized Jeffreys divergence for the two-normal setting in CSBM-H can be computed by (See Appendix B for the calculation)

\[D_{}()=^{2}(^{2}} +^{2}})}_{}}{4}(^{2}+}-2)}_{ }\] (5)

where \(d_{X}^{2}=(_{0}-_{1})^{}(_{0}-_{1})\) is the squared Euclidean distance between centers; \(=}{_{1}}\) and since we assume \(_{0}^{2}<_{1}^{2}\), we have \(0<<1\). For \(\) and \(^{}\), we have \(d_{H}^{2}=(2h-1)^{2}d_{X}^{2},d_{}^{2}=4(1-h)^{2}d_{X}^{2}\). The smaller \(D_{}\) the CSBM-H has, the more distinguishable the embeddings are.

From equation 5, we can see that \(D_{}\) implies that ND relies on two terms, Expected Negative Normalized Distance (ENND) and the Negative Variance Ratio (NVR): 1. ENND depends on how large is the inter-class ND \(d_{X}^{2}\) compared with the normalization term \(^{2}}+^{2}}\), which is determined by intra-class ND (variances \(_{0},_{1}\)); NVR depends on how different the two intra-class NDs are, _i.e.,_ when the intra-class ND of high-variation class is significantly larger than that of low-variation class (\(\) is close to 0), NVR is small which means the nodes are more distinguishable and vice versa.

Now, we can investigate the impact of homophily on ND through the lens of PBE and \(D_{}\)6. Specifically, we set the standard CSBM-H as \(_{0}=[-1,0],_{1}=,_{0}^{2}=1,_{1}^{2}=2,d_{0 }=5,d_{1}=5\). And as shown in Figure 2, its PBE and \(D_{}\) curves for LP filtered feature \(\) are bell-shaped 7. This indicates that, contrary to the prevalent belief that heterophily has the most negative impact on ND, a medium level of homophily actually has a more detrimental effect on ND than extremely low levels of homophily. We refer to this phenomenon as the **mid-homophily pitfall**.

The PBE and \(D_{}\) curves for \(^{}\) are monotonically increasing, which means that the high-pass filter works better in heterophily areas than in homophily areas. Moreover, it is observed that \(\), \(\), and \(^{}\) will get the lowest PBE and \(D_{}\) in different homophily intervals, which we refer to as the "FP regime _(black)_", "LP regime _(green)_", and "HP regime _(red)_" respectively. This indicates that LP filter works better at very low and very high homophily intervals (two ends), HP filter works better at low to medium homophily interval 8, the original (_i.e.,_ full-pass or FP filtered) features works betters at medium to high homophily area.

Researchers have always been interested in exploring how node degree relates to the effect of homophily . In the upcoming subsection, besides node degree, we will also take a deeper look at the impact of class variances via the homophily-ND curves and the FP, LP and HP regimes.

### Ablation Study on CSBM-H

**Increase the Variance of High-variation Class (\(_{0}^{2}=1,_{1}^{2}=5\))** From Figure 3, it is observed that as the variance in \(_{1}\) increases and the variance between \(_{0}\) and \(_{1}\) becomes more imbalanced, the PBE and \(D_{}\) of the three curves all go up which means the node embeddings become less distinguishable under HP, LP and FP filters. The significant shrinkage of the HP regimes and the expansion of the FP regime indicates that the original features are more robust to imbalanced variancesespecially in the low homophily area. From Figure 3 (d), we can see that the main cause is that the NVR of the 3 curves all move down but the HP curve moves less in low homophily area than other 2 curves. This implies that the HP curve exhibits less sensitivity to \(\) within the area of low homophily.

**Increase the Variance of Low-variation Class (\(_{0}^{2}=1.9,_{1}^{2}=2\))** As shown in Figure 4, when the variance in \(_{0}\) increases and the variance between \(_{0}\) and \(_{1}\) becomes more balanced, PBE and \(D_{}\) curves go up, which means the node embeddings become less distinguishable. The LP, HP and the FP regimes almost stays the same because the magnitude of NVR becomes too small that it almost has no effect to ND as shown in Figure 4 (d).

Interestingly, we found the change of variances cause less differences of the 3 regimes in ENND than that in NVR 9 and HP filter is less sensitive to \(\) changes in low homophily area than LP and FP filters. This insensitivity will have significant impact to the 3 regimes when \(\) is close to \(0\) and have trivial effect when \(\) is close to \(1\) because the magnitude of NVR is too small.

**Increase the Node Degree of High-variation Class (\(d_{0}=5,d_{1}=25\))** From Figure 5, it can be observed that as the node degree of the high-variation class increases, the PBE and \(D_{}\) curves of FP and HP filters almost stay the same while the curves of LP filters go down with a large margin. This leads to a substantial expansion of LP regime and shrinkage of FP and HP regime. This is mainly due to the decrease of ENND of LP filters and the decrease of its NVR in low homophily area also plays an important role.

**Increase the Node Degree of Low-variation Class (\(d_{0}=25,d_{1}=5\))** From Figure 6, we have the similar observation as when we increase the node degree of high-variation class. The difference is that the expansion of LP regime and shrinkage of FP and HP regimes are not as significant as before.

From \(_{0}^{2},~{}_{1}^{2}\) we can see that increasing node degree can help LP filter reduce variances of the aggregated features so that the ENND will decrease, especially for high-variation class while HP filter is less sensitive to the change of variances and node degree.

### More General Theoretical Analysis

Besides the toy example, in this subsection, we aim to gain a deeper understanding of how LP and HP filters affect ND in a broader context beyond the two-normal settings. To be consistent with previous literature, we follow the assumptions outlined in , which are: 1. The features of node \(i\) are sampled from distribution \(_{z_{i}}\), _i.e.,_\(_{i}_{z_{i}}\), with mean \(_{z_{i}}^{F_{h}}\); 2. Dimensions of \(_{i}\) are independent to each other; 3. Each dimension in feature \(_{i}\) is bounded, _i.e.,_\(a_{i,k} b\); 4. For node \(i\), the labels of its neighbors are independently sampled from neighborhood distribution

Figure 4: Comparison of CSBM-H with \(_{0}^{2}=1.9,_{1}^{2}=2\).

\(_{z_{i}}\) and repeated for \(d_{i}\) times. We refer to a graph that follows the above assumptions as \(=\{,,\{_{c},c\},\{_{c},c\}\},= \{1,,C\}\) and \((b-a)^{2}\) reflects how variation the features are. The authors in  analyze the distance between the aggregated node embedding and its expectation, _i.e.,_\(\|_{i}-(_{i})\|_{2}\), which only considers the intra-class ND and has been shown to be inadequate for a comprehensive understanding of ND. Instead, we investigate **how significant the intra-class embedding distance is smaller than the inter-class embedding distance** in the following theorem, which is a better way to understand ND.

**Theorem 2**.: Suppose a graph \(=\{,,\{_{c},c \},\{_{c},c\}\}\) meets all the above assumptions (1-4). For nodes \(i,j,v\), suppose \(z_{i} z_{j}\) and \(z_{i}=z_{v}\), then for constants \(t_{x},t_{h},t_{}\) that satisfy \(t_{x}}D_{x}(i,j),\;t_{h}}D_{h}(i,j),\;t_{}}D_{}(i,j)\) we have

\[(\|_{i}-_{j} \|_{2}\|_{i}-_{v}\|_{2}+t_{x }) 2F_{h}(-(v,j)-}{ }})^{2}}{V_{x}(v,j)}),\] \[(\|_{i}-_{j}\|_ {2}\|_{i}-_{v}\|_{2}+t_{h}) 2F_{h} (-(v,j)-}{}})^{2}}{V_{h }(v,j)}),\] (6)

where \(D_{x}(v,j)=\|_{z_{v}}-_{z_{j}}\|_{2}, \;V_{x}(v,j)=(b-a)^{2},\;D_{h}(v,j)=\|}_{z_{v}}- }_{z_{j}}\|_{2},V_{h}(v,j)=(}+ })(b-a)^{2}\),

See the proof in Appendix G

We can see that, the probability upper bound mainly depends on a distance term (inter-class ND) and normalized variance term (intra-class ND). The normalized variance term of HP filter is less sensitive to the changes of node degree than that of LP filter because there is an additional 1 in the constant term. Moreover, we show that the distance term of HP filter actually depends on the **relative center distance**, which is a novel discovery. As shown in Figure 7, when homophily decreases, the aggregated centers will move away from the original centers, and the relative center distance (purple) will get larger which means the embedding distance of nodes from different classes will have larger probability to be big. This explains how HP filter work for some heterophily cases. Overall, in a more general setting with weaker assumptions, we can see that ND is also described by the intra- and inter-class ND terms together rather than intra-class ND only, which is consistent with CSBM-H.

## 4 Empirical Study of Node Distinguishability

Figure 5: Comparison of CSBM with different \(d_{0}=5,d_{1}=25\) setups.

Figure 6: Comparison of CSBM with different \(d_{0}=25,d_{1}=5\) setups.

Besides theoretical analysis, in this section, we will conduct experiments to verify whether the effect of homophily on the performance of GNNs really relates to its effect on ND. If a strong relation can be verified, then it indicates that we can design new training-free ND-based performance metrics beyond homophily metrics, to evaluate the superiority and inferiority of G-aware models against its coupled G-agnostic models.

### Hypothesis Testing on Real-world Datasets

To test whether "intra-class embedding distance is smaller than the inter-class embedding distance" strongly relates to the superiority of G-aware models to their coupled G-agnostic models in practice, we conduct the following hypothesis testing 10.

Experimental SetupWe first train two G-aware models GCN, SGC-1 and their coupled G-agnostic models MLP-2 and MLP-1 with fine-tuned hyperparameters provided by . For each trained model, we calculate the pairwise Euclidean distance of the node embeddings in output layers. Next, we compute the proportion of nodes whose intra-class node distance is significantly smaller than inter-class node distance 11_e.g.,_ we obtain \(()\) for GCN. We use Prop to quantify ND and we train the models multiple times for samples to conduct the following hypothesis tests:

\[_{0}:()();\ _{1}:()<()\]

Specifically, we compare GCN vs. MLP-2 and SGC-1 vs. MLP-1 on \(9\) widely used benchmark datasets with different homophily values for 100 times. In each time, we randomly split the data into training/validation/test sets with a ratio of 60%/20%/20%. For the 100 samples, we conduct _T-test for the means of two independent samples of scores_, and obtain the corresponding p-values. The test results and model performance comparisons are shown in Table 1 (See more experimental tests on state-of-the-art model in Appendix H).

    & & **Ceneral** & **Wisconsin** & **Texas** & **Fina** & **Ceneral** & **Sperant** & **Cen** & **CitySext** & **PublMed** \\   & H\({}_{0.00}\) & 0.48961 & 0.4489 & 0.4106 & 0.3759 & 0.2935 & 0.2846 & 0.8100 & 0.7622 & 0.8048 \\  & H\({}_{0.00}\) & 0.5355 & 0.1494 & 0.0678 & 0.2210 & 0.2400 & 0.21856 & 0.3252 & 0.2175 & 0.7215 & 0.724 \\  & H\({}_{0.00}\) & 0.4488 & 0.0941 & 0.0013 & 0.0109 & 0.0023 & 0.0253 & 0.7654 & 0.6220 & 0.6411 \\  & H\({}_{0.00}\) & 0.7889 & 0.0898 & 0.0892 & 0.617 & 0.356 & 0.3964 & 0.9044 & 0.9325 & 0.9319 \\  & H\({}_{0.00}\) & 0.51 & 0.34 & 0.35 & 0.16 & 0.0153 & 0.1957 & 0.0198 & 0.027 & 0.27 \\  & H\({}_{0.00}\) & 0.1899 & 0.0365 & 0.0258 & 0.1272 & 0.0661 & 0.0189 & 0.1748 & 0.5384 & 0.4341 \\  & I\({}_{1}\) & 0.1109 & 0.1311 & 0.1923 & 0.0004 & 0.0088 & 0.0088 & 0.0015 & 0.9504 & 0.9504 & 0.9504 \\   & McNapp. & 0.00 & 0.00 & 0.00 & 0.00 & 1.00 & 1.00 & 1.00 & 1.00 & 1.00 \\  & SCG & 0.00 & 0.00 & 0.00 & 0.00 & 1.00 & 1.00 & 1.00 & 1.00 & 1.00 \\  & SCG & 0.00 & 0.00 & 0.00 & 0.00 & 1.00 & 1.00 & 1.00 & 1.00 & 1.00 \\  & SCG & 0.00 & 0.00 & 0.00 & 0.00 & 1.00 & 1.00 & 1.00 & 1.00 & 0.00 \\  & SCG & 0.00 & 0.00 & 0.00 & 1.00 & 1.00 & 1.00 & 1.00 & 1.00 & 0.00 \\  & MPL & -2.79 & -23.49 & -10.49 & -9.27 & 1.985 & 1.845 & 1.802 & -4.15 & -0.73 \\   & \(_{0}\) & 0.00 & 0.00 & 0.00 & 1.00 & 1.00 & 1.00 & 1.00 & 1.00 & 1.00 \\  & K2.46 & -31.11 & -35.75 +2.92 & 83.111 +3.2 & 355.13 +0.09 & 44.185 +2.62 & 44.19 & 38.78 +0.86 & 31.99 +2.13 & 89.9 +0.2 \\  & ACCL & -29.10 & -20.91 & -20.917 & -8.32 & -6.04 & 31.28 & -2.76 & 44.49 & 38.26 +2.88 & 48.1 +0.1 \\  & DM & -5.81 & -13.72 & -9.15 & -9.50 & -17.6 & -13.08 & -17.34 & -5.14 & -2.47 \\  

Table 1: P-values, homophily values and classifier-based performance metrics on 9 real-world benchmark datasets. Cells marked by grey are incorrect results for both SGC v.s. MLP-1 and GCN v.s. MLP-2 and cells marked by blue are incorrect for 1 of the 2 tests. We use 0.5 as the threshold value of the homophily metrics.

Figure 7: Demonstration of how HP filter captures the relative center distance.

It is observed that, in most cases (except for GCN vs. MLP-2 on _PubMed_12), when H\({}_{1}\) significantly holds, G-aware models will underperform the coupled G-agnostic models and vice versa. This supports our claim that the performance of G-aware models is closely related to "intra-class vs. inter-class node embedding distances", no matter the homophily levels. It reminds us that the p-value can be a better performance metric for GNNs beyond homophily. Moreover, the p-value can provide a statistical threshold, such as \(p 0.05\). This property is not present in existing homophily metrics.

However, it is required to train and fine-tune the models to obtain the p-values, which make it less practical because of computational costs. To overcome this issue, in the next subsection, we propose a classifier-based performance metric that can provide p-values without training.

### Towards A Better Metric Beyond Homophily: Classifier-based Performance Metric

A qualified classifier should not require iterative training. In this paper, we choose Gaussian Naive Bayes (GNB) and Kernel Regression (KR) with Neural Network Gaussian Process (NNGP)  to capture the **feature-based linear or non-linear** information.

To get the p-value efficiently, we first randomly sample 500 labeled nodes from \(\) and splits them into 60%/40% as "training" and "test" data. The original features \(X\) and aggregated features \(H\) of the sampled training and test nodes can be calculated and are then fed into a given classifier. The predicted results and prediction accuracy of the test nodes will be computed directly with feedforward method. We repeat this process for 100 times to get 100 samples of prediction accuracy for \(X\) and \(H\). Then, for the given classifier, we compute the p-value of the following hypothesis testing,

\[_{0}:((H))((X));_{1}:((H))<((X))\]

The p-value can provide a statistical threshold value, such as 0.05, to indicate whether \(H\) is significantly better than \(X\) for node classification. As seen in Table 1, KR and GNB based metrics significantly outperform the existing homophily metrics, reducing the errors from at least \(5\) down to just 1 out of 18 cases. Besides, we only need a small set of the labels to calculate the p-value, which makes it better for sparse label scenario. Table 2 summarizes its advantages over the existing metrics. (See Appendix H for more details on classifier-based performance metrics, experiments on synthetic datasets, more detailed comparisons on small-scale and large-scale datasets, discrepancy between linear and non-linear models, results for symmetric renormalized affinity matrix and running time.)

## 5 Conclusions

In this paper, we provide a complete understanding of homophily by studying intra- and inter-class ND together. To theoretically investigate ND, we study the PBE and \(D_{}\) of the proposed CSBM-H and analyze how graph filters, class variances and node degree distributions will influence the PBE and \(D_{}\) curves and the FP, LP, HP regimes. We extend the investigation to broader settings with weaker assumptions and theoretically prove that ND is indeed affected by both intra- and inter-class ND. We also discover that the effect of HP filter depends on the relative center distance.

Empirically, through hypothesis testing, we corroborate that the performance of GNNs versus NNs is closely related to whether intra-class node embedding "distance" is smaller than inter-class node embedding "distance". We find that the p-value is a much more effective performance metric beyond homophily metrics on revealing the advantage and disadvantage of GNNs. Based on this observation, we propose classifier-based performance metric, which is a non-linear feature-based metric and can provide statistical threshold value.

   Performance & Linear or & Feature & Sparse & Statistical \\ Metrics & Non-linear & Dependency & Labels & Threshold \\  H\({}_{}\) & linear & ✗ & ✗ & ✗ \\ H\({}_{}\) & linear & ✗ & ✗ & ✗ \\ H\({}_{}\) & linear & ✗ & ✗ & ✗ \\ H\({}_{}\) & linear & ✗ & ✓ & ✗ \\ H\({}_{}\) & linear & ✓ & ✓ & ✗ \\ H\({}_{}\) & linear & ✗ & ✗ & ✗ \\ LI & linear & ✗ & ✗ & ✗ \\ Classifier & both & ✓ & ✓ & ✓ \\   

Table 2: Property comparisons of performance metrics 

## 6 Reproducibility and Blogs

* Code: https://github.com/SitaoLuan/When-Do-GNNs-Help.
* Blog in English (on Medium): https://medium.com/SitaoLuan/when-should-we-use-graph-neural-networks-for-node-classification-8ce77a772085.
* Blog in Chinese (on Zhihu): https://zhuanlan.zhihu.com/p/653631858.

## 7 Acknowledgements

This work was partially supported by the Natural Sciences and Engineering Research Council of Canada (NSERC) Grant RGPIN-2023-04125, RGPIN 2389 and Canadian Institute for Advanced Research (CIFAR) Grant CIFAR FS20-126, CIFAR 10450. Minkai Xu thanks the generous support of Sequoia Capital Stanford Graduate Fellowship.