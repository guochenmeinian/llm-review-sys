# Geometric Transformer with Interatomic Positional Encoding

Yusong Wang\({}^{1,2}\), Shaoning Li\({}^{2,3,4}\), Tong Wang\({}^{2}\), Bin Shao\({}^{2}\)

**Nanning Zheng\({}^{1}\), Tie-Yan Liu\({}^{2}\)**

\({}^{1}\) National Key Laboratory of Human-Machine Hybrid Augmented Intelligence,

National Engineering Research Center for Visual Information and Applications,

and Institute of Artificial Intelligence and Robotics, Xi'an Jiaotong University

\({}^{2}\) Microsoft Research AI4Science

\({}^{3}\) Mila - Quebec AI Institute \({}^{4}\) Universite de Montreal

wangyusong2000@stu.xjtu.edu.cn, nnzheng@mail.xjtu.edu.cn

shaoning.li@umontreal.ca

{watong, binshao, tyliu}@microsoft.com

Work done during an internship at Microsoft Research.Equal contribution.Corresponding author.

###### Abstract

The widespread adoption of Transformer architectures in various data modalities has opened new avenues for the applications in molecular modeling. Nevertheless, it remains elusive that whether the Transformer-based architecture can do molecular modeling as good as equivariant GNNs. In this paper, by designing Interatomic Positional Encoding (**IPE**) that parameterizes atomic environments as Transformer's positional encodings, we propose **Geoformer**, a novel geometric Transformer to effectively model molecular structures for various molecular property prediction. We evaluate Geoformer on several benchmarks, including the QM9 dataset and the recently proposed Molecule3D dataset. Compared with both Transformers and equivariant GNN models, Geoformer outperforms the state-of-the-art (SoTA) algorithms on QM9, and achieves the best performance on Molecule3D for both random and scaffold splits. By introducing IPE, Geoformer paves the way for molecular geometric modeling based on Transformer architecture. Codes are available at https://github.com/microsoft/AI2BMD/tree/Geoformer.

## 1 Introduction

Transformer  has been a dominant architecture in modeling various data modalities such as natural language, images, and videos. As such, it is natural to generalize Transformers in molecule modeling. Molecules are represented as either 2D topology structures or 3D geometric structures. Prevailing algorithms for modeling 2D topology  employ Transformers with global attention, which treat the molecular structures as fully connected graphs and devise a diverse range of positional encoding schemes. In contrast to topological graphs, geometric structures offer more comprehensive description of molecules by providing the information of 3D coordinates. There have been some recent attempts , to integrate specific geometric features into Transformers. For example, Transformer-M  considers pairwise distances as a learnable bias added to the attention weights as a supplement to the 2D topology encoding used in Graphormer . Nevertheless, they are insufficient to comprehensively encompass the intricacies of the entire 3D molecular space, as they solely rely on distance information for positional encoding. Incontrast, modern GNNs emphasize the significance of _equivariance_ as a crucial bias, and explore various methods to encode geometric information, including distances, angles, and dihedral angles [13; 12; 39; 26; 49; 47]. Several works [3; 31; 2] further utilize high-order geometric tensors to yield internal features in models, ensuring equivariance with respect to the E(3)/SE(3) group. As a result, the performance of EGNNs in molecular property prediction significantly surpasses that of methods based on Transformers.

The success of EGNNs underscores the advantage of integrating directional geometric information into neural networks for molecular modeling [12; 26; 47; 48], while employing such information in the Transformer-based architecture has yet to be developed. Intuitively, all geometric information is embedded in atomic coordinates, which can be naturally utilized as a bias for developing an effective positional encoding in Transformers. Based on atomic coordinates, atomic cluster expansion (ACE) theory [10; 21] is a complete descriptor to represent the environment of centered atoms. In this study, we first design interatomic positional encoding (IPE) by introducing cluster merging based on ACE theory. By incorporating IPE into traditional Transformers, we extend the capabilities of the Transformer, in terms of **Geoformer**, to effectively model molecular structures for molecular property prediction. We conduct a comprehensive evaluation of Geoformer using several benchmarks, which includes QM9 dataset  comprising 12 molecular properties and the recently proposed Molecule3D dataset , containing 3,899,647 molecules sourced from PubChemQC. Our results demonstrate that Geoformer surpasses state-of-the-art algorithms on the majority of properties on QM9 dataset, and achieves the lowest mean absolute errors on Molecule3D for both random and scaffold splits. We also provide visualizations of the learned IPE, which shows that IPE can capture different positional information compared with PE that only encodes pairwise distances.

Our contributions can be summarized as follows:

* We introduce a novel positional encoding method, i.e., Interatomic Positional Encoding (IPE) to parameterize atomic environments in Transformer.
* By incorporating IPE, we propose a **Geometric Transformer**, in terms of **Geoformer**, which models valuable geometric information beyond pairwise distances for Transformer-based architecture.
* The proposed **Geoformer** achieves superior performance on molecular property predictions compared with Transformers and EGNNs.

## 2 Preliminary

The Atomic Cluster Expansion (ACE)  is a complete descriptor of the local atomic chemical environments, represented by hierarchical many-body expansion. The key components of ACE are: a) ACE defines a _complete_ set of basis functions for the environment of the centered atom (radial basis functions and spherical harmonics in practice); b) ACE significantly reduces the computational efforts for body order computing to _linear_ time complexity scaling with the number of atoms within molecule. These advantages serve ACE as an accurate, fast, and transferable theory framework for molecular modeling. In order to facilitate readers' comprehension of our interatomic positional encoding, we would present the core operations of ACE in several equations.

ACE includes a set of orthogonal basis functions \(_{v}(_{ij})\) to describe the spatial relations between two atoms. \(_{ij}\) denotes the relative position pointing from atom \(i\) to atom \(j\), and \(v\) indicates the functions' polynomial degree. ACE focuses on modeling the potential energy of a system by focusing on a collection of atoms, specifically atomic clusters. In this method, the centered atom, denoted as \(i\), is surrounded by \(K\) neighboring atoms, which form the atomic cluster. The potential energy of the atomic cluster depends on the hierarchical interactions between the central atom \(i\) and its \(K\) neighboring atoms, known as many-body expansion. The expansion of atomic potential energy could be written by:

\[E_{i}=_{j_{1}}_{v_{1}}c_{v_{1}}_{v_{1}}(_{ij_{1}})+_{j_ {1}j_{2}}_{v_{1}v_{2}}c_{v_{1}v_{2}}_{v_{1}}(_{ij_{1}})_{v_ {2}}(_{ij_{2}})+\] (1)

with an unrestricted summation. \(c_{v}\) indicates the expansion coefficients. However, the sum of surrounding neighbors within the cluster would scale to \((N^{K})\) with \(K\) neighbors and become numerically expensive. \(N\) denotes the number of atoms within one molecule. ACE leverages the _density trick_ to reduce the computational overhead. It defines _atomic base_\(A_{i,v}\) and _A_-basis \(A_{i,}\) as:

\[A_{i,v}=_{j N(i)}_{v}(_{ij})\] (2)

\[A_{i,}=_{t=1}^{}A_{i,v_{t}},=(v_{1}, ,v_{})\] (3)

where \(\) denotes the order of body expansion, i.e., \((+1)\)-body expansion, and \(\) stands for the set of \(v\). By firstly summing the neighboring basis functions and then applying multiplication, ACE can efficiently represent the atomic expansion scaling with the complexity \((N)\). Since \(A_{i,}\) is not rotationally invariant, we need additional Clebsch-Gordan coefficients \(C_{v}\) to construct fully permutation and isometry-invariant basis functions (_B_-basis), and describe the potential of cluster \(_{i}\) in Equation 1 as their linear combination with \(c\)-coefficients :

\[B_{i,}=_{^{}}C_{^{}}A _{i,^{}}\] (4)

\[E_{i}=_{}c_{i,}B_{i,}=_{i}_ {i}\] (5)

## 3 Methods

In this section, we would introduce our Interatomic Positional Encoding (IPE) based on ACE theory in Section 3.1, and discuss how we integrate IPE into the Transformer architecture in Section 3.2.

### Positional Encoding for Geometric Molecule Modeling

In the context of geometric molecule modeling, the positions of atoms are the most intuitive positional information to encode in Transformers (termed as "positional encoding"). While most recent works have adopted pairwise distances between atoms as the relative PE, such a representation is often inadequate for capturing the complex interactions within molecules. As a result, it is essential to use a more comprehensive and appropriate PE for geometric data. Motivated by ACE, we propose an Interatomic Positional Encoding (**IPE**) to efficiently describe the many-body contributions in Transformers for geometric molecule modeling. The distinction from ACE is that IPE further takes the interactions between atomic clusters into account. More details on the IPE method and its integration into the Transformer architecture will be provided in the subsequent sections.

Figure 1: **Illustration of Interatomic Positional Encoding (IPE) \(_{}\)**. Panel **a** depicts the extended Self-Attention with \(_{}\). \(_{}\) contributes to the construction of attention weights while simultaneously being updated by atomic features; Panel **b** highlights the relationship between \(_{}\), cluster \(_{i}\), cluster \(_{j}\), and the merged cluster \(_{ij}\), as described in Theorem 1 and 2, Equation 6 to Equation 11.

**Theorem 1**: _Given two cluster \(_{i}\) and \(_{j}\) and their basis functions, there exists a set of invariant basis functions for the merged cluster \(_{ij}\) to describe integrated cluster potentials \(_{ij}\)._

_Proof._ A merged cluster \(_{ij}\) can be represented as translating two clusters \(_{i}\) and \(_{j}\) such that their centered-atoms, i.e., atoms \(i\) and \(j\), overlap as shown in Fig. 1(b). All their neighbors are merged into a new cluster \(_{ij}\), and the newly formed atomic base can be expressed as:

\[_{ij,}&=(A_{i, } A_{j,})(A_{i,} A_{j,})^{ }\\ &=A_{i,}A_{i,}&A_{i,}A_{j, }\\ A_{j,}A_{i,}&A_{j,}A_{j,}\\ &=_{m_{1}m_{2}}_{}(_{im_{1}} )_{}(_{im_{2}})&_{mn}_{}(_{im}) _{}(_{jn})\\ _{mn}_{}(_{jn})_{}(_{im})&_{n_{ 1}n_{2}}_{}(_{jn_{1}})_{}(_{jn_{2}}) \] (6)

with the product explicitly writing out. \(m,n\) are the neighbor atom symbols of atoms \(i,j\), respectively. \(\) is the tensor product. We write the atomic base \(A_{i,}A_{j,}\) as \(A_{ij,}\) (due to the permutational invariance, we have \(A_{ij,}=A_{ji,}\)) which still follows the _density trick_. Therefore, we could construct a new _A_-basis for merged cluster \(_{ij}\) when taking product of \(_{ij,}\):

\[_{ij,}&=_{ ij,_{1}}_{ij,_{2}}_{ij, _{n}}\\ &=(A_{i,} A_{j,})(A_{i, } A_{j,})^{}\\ &=_{t=1}^{2}A_{i,_{t}}&_{t =1}^{}A_{ij,_{t}}\\ _{t=1}^{}A_{ji,_{t}}&_{t=1}^{2}A_{j,_{t}} \\ &=A_{i(i),}&A_{ij,}\\ A_{ji,}&A_{j(j),}\] (7)

where \(2=\) and \(=1,2,\). \(_{ij,}\) could describe \((+1)\)-body and \((+2)\)-body expansion simultaneously in \((N)\). To be concrete, \(A_{i(i),}\) contributes the \((+1)\)-body expansion, while \(A_{ij,}\) contributes the \((+2)\)-body expansion due to cluster merging. For instance, when taking \(=1\), \(A_{i,}\) and \(A_{i(i),}\) denote 2-body (\(im\)) and 3-body expansion (\(im_{1}m_{2}\)) in original cluster \(_{i}\), and \(A_{ij,}\) denotes the 4-body expansion (\(mijn\)) in merged cluster \(_{ij}\), respectively. Further explanation can be found in the following Remark. \(_{ij,}\) exists when \( 2\), which implies considering at least 4-body expansion within molecules. Then we could construct the corresponding matrix of _B_-basis \(_{ij,}\) following Equation 4 and represent the potential of cluster \(_{ij}\) as:

\[_{ij}=_{}c_{ij,}_{ij,}\] (8)

_Remark._ A straightforward illustration can be drawn by setting \(=1\) (Cartesian space) and \(=1\). In this case, basis \(B_{i(i)}\) could be interpreted as the sum of cosine value of the surrounding _angles_ within cluster \(_{i}\), i.e., \(_{m_{1}m_{2}}_{im_{1}m_{2}}\), which represents the 3-body contributions in \((N)\). Similarly, basis \(B_{ij}\) could be treated as the sum of _proper dihedral angles_ between two clusters \(_{i}\) and \(_{j}\), i.e., \(_{mn}_{mijn}\), which represents 4-body contributions in \((N)\). The basis \(B_{ij}\) indeed serves as the contribution for torsion potential between two clusters in the original ACE, which primarily considers the contributions within a single cluster. The detailed proof could be found in Appendix B. As a result, incorporating \(A_{ij}\) effectively enhances the representation of interatomic relations by capturing the interactions between clusters, thereby offering a possible way for designing a geometric Transformer architecture.

**Theorem 2** (Interatomic Positional Encoding (IPE)): _Given one molecule with \(N\) atoms, there exists a positional encoding matrix \(_{}^{N N}\), which naturally describes the interatomic potentials. \(\) denotes the orders of body expansion in Equation 7. In particular, \(_{}\) is directly multiplied with Query and Key before scaling. e.g., softmax, serving as the positional encoding in Transformer:_

\[=(XW_{Q})(XW_{K})^{}_{}\] (9)

_where \(X^{N F}\) denotes the atomic features and \(W^{F F}\) denotes the learnable matrix. \(F\) is the hidden dimension. \(Q,K\) represent Query and Key, respectively. \(\) is the Hadamard product._Proof.: As mentioned in Section 2 and Theorem 1, the basis functions \(A_{i,}\) in Equation 3 could represent the local chemical environment of cluster \(_{i}\) with _density trick_. Inspired by this, we first construct the \(_{_{}}=[_{,_{}},_{ ,_{}},,_{,_{}}]^{}\) with integer \(=[1,]\) and \(_{i,v_{}}=_{t=1}^{}A_{i,v_{t}}\). We then treat \(_{_{}}\) as the absolute positional encoding attached to the Query and Key, and attention matrix \(\) before scaling, e.g., softmax, could be modified as follows:

\[_{}&=(XW_{Q} _{_{}})(XW_{K}_{_{}})^{} \\ &=(XW_{Q})(XW_{K})^{}(_{_{}}_{ _{}}^{})\\ &=(XW_{Q})(XW_{K})^{}_{_{}} }_{_{}}\] (10)

where \(\) is the entry-wise Kronecker Product. The detailed proof could be found in Appendix B. Instructed by [10; 21], we add Clebsch-Gordan coefficients \(C_{_{}}\) to ensure the rotationally invariance, and therefore obtain \(}_{_{}}=_{_{}^{}}C_{ _{}^{}}}_{_{}^{}}\). Then we can write the linear expansion:

\[=(XW_{Q})(XW_{K})^{}(_{=1}^{}W_ {}}_{_{}})\] (11)

where \(W_{}\) is a learnable weight matrix denoting \(c\)-coefficients, which is similar to the message construction in MACE . Such operation could be done by a tensor broadcast. Eventually, our interatomic positional encoding \(_{}\) could be represented as:

\[_{}=_{=1}^{}W_{}}_{ _{}}\] (12)

We can further modify the Equation 11 as Equation 9 and complete the proof.

### Geoformer: Geometric Transformer for Molecules

**Overall Design.** The comprehensive structure of Geoformer is depicted in Figure 2. This design comprises an Embedding layer, an elaborate Encoder for extracting geometric features, and a lightweight Decoder for predicting molecular properties. Within the Geoformer's Encoder, \(L\) attention blocks are integrated, each having hidden dimension \(F\) and employing the proposed interatomic positional encoding \(_{}\). Notably, \(C_{}\) is updated by the atomic features \(X^{N F}\) within each block. Geoformer takes the atom type \(Z^{N}\) and atomic coordinates \(R^{N 3}\) from one molecule with \(N\) atoms as inputs, and produces the corresponding molecular properties as outputs.

Figure 2: **Geoformer Architecture.** Geoformer consists of (**c**) an Embedding layer; (**b**) an elaborate Encoder incorporating \(L\) attention blocks with IPE \(_{}\) to extract geometric features and capture complex interatomic relationships within the molecular structure. The extended Self-Attention module with \(_{}\) is depicted in Fig. 1; (**d**) a lightweight Decoder for predicting molecular properties of interest, such as energy and HOMO-LUMO gap.

**Embedding Layer.** The Embedding layer maps the atom type \(Z\) to \(X^{0}^{N F}\):

\[X^{0}=((Z))\] (13)

and initialize the IPE \(_{}^{0}^{N N F}\) with 2-body expansion, i.e., radial basis functions (RBF) :

\[_{k}()=(\|\|)(-_{k}( (-\|\|)-_{k})^{2})\] (14)

\[_{}^{0}=()W_{}\] (15)

where \(^{N N 3}\) denotes the relative position between two atoms, \(\|\|\) is the vector norm, \(_{k}\), \(_{k}\) are optional learnable parameters that specify center and width of \(_{k}()\), and \(()\) is a smooth cosine cutoff function. \(()=[_{1}(),,_{K}()] ^{}^{N N K}\) is composed of the values of \(K\) radial basis functions. \(W_{}^{K F}\) is a learnable matrix mapping basis functions to the hidden size.

**Attention block with IPE.** The extended attention block is illustrated in Fig. 1(a). In contrast to the traditional Transformer, a learnable IPE matrix \(_{}\) is introduced to each attention block. Following TorchMD-NET , the softmax function is substituted with the SiLU activation to enhance accuracy, and the attention weight is scaled by a smooth cutoff:

\[A(X^{l})=(_{F}(((X^{l}W_{Q}^{l})*(X^{ l}W_{K}^{l})^{})_{}^{l}))(\| \|)\] (16)

where \(*\) denotes the batched tensor product, i.e., \((X^{l}W_{Q}^{l})*(X^{l}W_{K}^{l})^{}^{N N F}\). \(l\) indicates \(l\)-th attention block. In Fig. 1, the mask operation corresponds to the implementation of an alternative attention mask. It effectively filters out atoms with excessive distance, concentrates attention and improves the performance of the attention mechanism . Then we produce the weighted values per atoms after self-attention to update \(_{}^{l}\):

\[_{V}(X^{l})=A(X^{l}) X^{l}W_{V}^{l}\] (17)

Then under the instruction of Equation 7, we construct the \(A\)-basis for all merged cluster:

\[_{_{}}^{l}=_{t=1}^{}_{j}_{ V}(X^{l})W_{Attn}^{l}Y_{l^{*},m}(/\|\|)\] (18)

\[}_{_{}}^{l}=(_{_{}}^ {l}W_{_{_{}}^{l}}^{l})(_{_{ }}^{l}W_{_{_{}}^{l}}^{l})^{}\] (19)

where \(W_{Attn}^{l}\) is a learnable matrix, \(Y_{l^{*},m^{*}}(/\|\|)\) denotes the spherical harmonics with order \(l^{*}\) and degree \(m^{*}\). \(W_{_{_{}}^{l}}^{l}\) and \(W_{_{_{}}^{l}}^{l}\) are two learnable matrix _without bias_ to ensure equivariance .

We could further construct a new form of residual IPE within each block following Equation 8 and 11:

\[_{}^{l}=_{=1}^{}W_{}^{l} _{_{}^{}}C_{_{ }^{}}}_{_{}^{}}\] (20)

where \(W_{}^{l}\) is a learnable matrix. Finally we apply the residual connection to compute IPE for the next block:

\[_{}^{l+1}=(_{}^{l}W_{}^{l}) _{}^{l}+_{}^{l}\] (21)

where \(W_{}^{l}\) is a learnable matrix and \((_{}^{l}W_{}^{l})\) plays a role of gated filter. The update of atomic features still follows the traditional procedures:

\[(X^{l})=_{j}_{V}(X^{l})+X^{l}\] (22)

\[(X^{l})=(X^{l}W_{1}^{l})W_{2}^{l}+X^{l}\] (23)

where \(_{j}\) denotes the sum of atomic values weighted by the attention score. \(W_{1}^{l}\) and \(W_{2}^{l}\) are two learnable matrix in feed-forward layer. The output of each step is fed into a Layer Normalization (LayerNorm). It is important to emphasize that while the theoretical derivations of the Geoformer architecture above may appear complex, in practice, the model utilizes simplified settings to reduce computational complexity. Specifically, we employ \(=1\) for body expansion and \(l^{*}=1\) for spherical harmonics. It streamlines the complex tensor contraction and Clebsch-Gordan product calculations, making the model more efficient and easier to implement. Despite this, Geoformer achieves orsurpasses state-of-the-art prediction results on several benchmark datasets, as demonstrated in the subsequent section.

**Decoder.** The Geoformer utilizes a lightweight Decoder, as depicted in Fig. 2(d). It consists of a two linear layers with SiLU activation and an aggregation module \(\) to predict the specific molecular property. The lightweight Decoder ensures that the Geoformer remains computationally efficient while maintaining its ability to accurately predict molecular properties based on the geometric features captured by the Encoder. More details on Decoder for specific properties are shown in Appendix G.

## 4 Experiments

### Experimental Setup

Geoformer is evaluated on both QM9 dataset  that consists of 12 molecular properties and a large-scale Molecule3D dataset  derived from PubChemQC  with ground-state structures and the corresponding properties calculated at DFT level. All results are measured by mean absolute error (MAE) on test sets and baseline results are directly taken from the corresponding papers. All models are trained using the AdamW optimizer, and we use the learning rate decay if the validation loss stops decreasing. We also adopt the early stopping strategy to prevent over-fitting. The optimal hyperparameters such as learning rate and batch size are selected on validation sets. More detailed hyperparameters setting for Geoformer are provided in Appendix Table 4.

### Qm9

QM9 dataset consists of 130,831 small organic molecules with up to 9 heavy atoms. Each molecule is associated with 12 targets covering its energetic, electronic, and thermodynamic properties. We randomly split them in to 110,000 samples for training, 10,000 samples for validation and the remains for testing following the prior work . The evaluation results on QM9 are shown in Table 1 with the upper section displaying EGNNs and the lower showcasing Transformer-based methods. When compared with other SoTA methods, Geoformer achieves the state-of-the-art results on 8 kinds of properties and shows comparable results on the remaining properties, which underscores that our IPE can help Transformers learn useful positional information to better model molecular structures. Specifically, we conduct a comparison between Geoformer and the previously best-performing Transformer-based model, Transformer-M, which incorporates pairwise distances as PE. As Transformer-M has been pretrained on the large-scale PCQM4Mv2 dataset , targeting the prediction of HOMO-LUMO gaps, it exhibits comparable performance in terms of related properties. Nevertheless, a noticeable performance disparity persists when evaluating other properties

   Target & \(\) & \(\) & \(_{HOMO}\) & \(_{LUMO}\) & \(\) & \( R^{2}\) & \(ZPVE\) & \(U_{0}\) & \(U\) & \(H\) & \(G\) & \(C_{v}\) \\ Unit & \(mD\) & \(ma_{0}^{3}\) & \(meV\) & \(meV\) & \(meV\) & \(mD_{0}^{5}\) & \(meV\) & \(meV\) & \(meV\) & \(meV\) & \(meV\) & \(}{}\) \\  NMP  & 30 & 92 & 43 & 38 & 69 & 180 & 1.50 & 20 & 20 & 17 & 19 & 40 \\ SchNet  & 33 & 235 & 41 & 34 & 63 & 73 & 1.70 & 14 & 19 & 14 & 14 & 33 \\ Cormonet  & 38 & 85 & 34 & 38 & 61 & 961 & 2.03 & 22 & 21 & 21 & 20 & 26 \\ LieConv  & 32 & 84 & 30 & 25 & 49 & 800 & 2.28 & 19 & 19 & 24 & 22 & 38 \\ DimeNet++  & 30 & 44 & 25 & 20 & 33 & 331 & 1.21 & 6.32 & 6.28 & 6.53 & 7.56 & 23 \\ EGNN  & 29 & 71 & 29 & 25 & 48 & 106 & 1.55 & 11 & 12 & 12 & 31 \\ Panai  & 12 & 45 & 28 & 20 & 46 & 66 & 1.28 & 5.85 & 5.83 & 5.98 & 7.35 & 24 \\ TorchMD-NET  & 11 & 59 & 20 & 18 & 36 & 33 & 1.84 & 6.15 & 6.38 & 6.16 & 7.62 & 26 \\ GNS + NoisyNode  & 25 & 52 & 20 & 19 & 29 & 700 & 1.16 & 7.30 & 7.57 & 7.43 & 8.30 & 25 \\ SphereNet  & 25 & 45 & 23 & 19 & 31 & 268 & **1.12** & 6.26 & 6.36 & 6.33 & 7.78 & **22** \\ SEGNN  & 23 & 60 & 24 & 21 & 42 & 660 & 1.62 & 15 & 13 & 16 & 15 & 31 \\ EEQAT  & 11 & 53 & 20 & 16 & 32 & 382 & 2.00 & 25 & 25 & 24 & 23 & 24 \\ PANNet  & 11 & 45 & 23 & 19 & 31 & 249 & 1.17 & 5.90 & 5.92 & 6.04 & 7.14 & 23 \\ ComExNet  & 25 & 45 & 23 & 20 & 32 & 259 & 1.20 & 6.59 & 6.82 & 6.86 & 7.98 & 24 \\ Equipment  & 11 & 46 & **15** & **14** & **30** & 251 & 1.26 & 6.59 & 6.74 & 6.63 & 7.63 & 23 \\ AMP  & 12 & 67 & 26 & 23 & 45 & 93 & 4.10 & 11.3 & 11.4 & 11.3 & 12.4 & 32 \\  Molorner  & 28 & 41 & 25 & 26 & 39 & 350 & 2.05 & 7.52 & 7.46 & 7.38 & 8.11 & 25 \\ GeoT  & 29.7 & 52.7 & 25.0 & 20.2 & 43.9 & 300.8 & 1.73 & 11.1 & 11.7 & 11.3 & 11.7 & 27.6 \\ Geometric Transformer  & 26.4 & 51 & 27.5 & 20.4 & 36.1 & 157 & 1.24 & 7.35 & 7.55 & 7.73 & 8.21 & 28.0 \\ Transformer-M  & 37 & 41 & 17.5 & 16.2 & 27.4 & 75 & 1.18 & 9.37 & 9.41 & 9.39 & 9.63 & **22** \\ Geoformer & **10** & **40** & 18.4 & 15.4 & 33.8 & **27.5** & 1.28 & **4.43** & **4.41** & **4.39** & **6.13** & **22** \\   

Table 1: Mean absolute errors (MAE) of 12 kinds of molecular properties on QM9 compared with state-of-the-art algorithms. The best one in each category is highlighted in **bold**.

in comparison to the EGNNs. By integrating more directional information beyond distances into Geoformer, it significantly surpasses Transformer-M in 9 kinds of properties without pretraining.

### Molecule3D

The Molecule3D dataset consists of 3,899,647 molecules, each with the corresponding ground-state structures and quantum properties calculated by Density Functional Theory (DFT). The dataset is split into train, validation, and test set with the ratio of 6:2:2. The official GitHub repository of Molecule3D provides both random and scaffold splits, which are both employed in our experiments. The random split ensures that the training, validation, and test sets are sampled from the same distribution, while the scaffold split introduces a distribution shift among different subsets. We focus our analysis on the prediction of the HOMO-LUMO gap, in comparison with ComENet . Table 2 displays the results of our experiments on Molecule3D, indicating that Geoformer achieved a reduction of 32.56% and 3.98% in test MAE on the random and scaffold splits, respectively. These results highlight the superiority of our approach compared to invariant GNNs on a large-scale dataset.

### Analysis on Interatomic Positional Encoding

The exceptional performance demonstrated by our Geoformer serves as an evidence that Interatomic Positional Encoding (IPE) can effectively guide Transformers in modeling the geometry of molecular systems. In order to analyze the distinctions between our learned IPE and other PEs that solely utilize pairwise distances, we visualize the positional encoding for different molecules by IPE and other PEs, respectively. As shown in Fig. 3, IPE exhibits different positional encoding information compared with PEs that solely utilize pairwise distances. Specifically, for some positions that exhibit strong signals shown in the PEs only with distances, IPE further enhances such signals and shows significant distinction from background signals.

### Ablation Study

To verify the effectiveness of our IPE, we conduct comprehensive ablation studies with model variants on four properties \(U_{0}\), \(U\), \(H\) and \(G\) in QM9. First, we remove the residual connection for IPE, which leads to a Transformer that exclusively encodes pairs of distances using the initial non-updated IPE (**Non-updated IPE**). More specifically, the RBF feature is constructed as Equation 14, where \(()=[_{1}(),,_{K}()]^{ }^{N N K}\) is composed of the values of \(K\) radial basis functions and the PE undergoes a transformation in the \(l\)-th layer through a distinct linear layer that is not shared across layers with the form:

\[_{}^{l}=()W_{}^{l}\] (24)

The remaining operations are consistent with those found in the original Geoformer implementation. This should be highly similar to the previous Transformer, albeit with a slightly different pairwise distance encoding approach.

   Model & Random & Scaffold \\  GIN-Virtual  & 0.1036 & 0.2371 \\ SchNet  & 0.0428 & 0.1511 \\ DimeNet++  & 0.0306 & 0.1214 \\ SphereNet  & 0.0301 & 0.1182 \\ ComENet  & 0.0326 & 0.1273 \\  Geoformer & **0.0202** & **0.1135** \\   

Table 2: Mean absolute errors (MAE) of HOMO-LUMO gap (eV) on Molecule3D test set for both random and scaffold splits compared with state-of-the-art algorithms.

   Property & Non-updated IPE & Addition & Geoformer \\  \(U_{0}\) & 5.63 & 7.62 & **4.43** \\ \(U\) & 5.87 & 7.66 & **4.41** \\ \(H\) & 6.21 & 7.93 & **4.39** \\ \(G\) & 7.24 & 9.01 & **6.13** \\   

Table 3: Ablation study on four properties \(U_{0}\), \(U\), \(H\) and \(G\) in QM9 test set for model variants. The best one in each property is highlighted in bold.

Second, we discover that the way of incorporating IPE into the attention weights is crucial. In our derivation (Eq. 10), multiplication emerges as a natural approach, whereas the addition of PEs as attention bias prevails in the previous Transformer. To verify the effectiveness of our design, we also introduce our IPEs into the Transformer in an additive manner **(Addition)**, which we replace multiplication to addition as follows:

\[A(X^{l})=(_{F}(((X^{l}W^{l}_{Q})*(X^{ l}W^{l}_{K})^{})+^{l}_{}))(\| \|)\] (25)

where \(^{l}_{}\) updated in the same way as the original Geoformer, only \(\) has been replaced with \(+\). As show in Table 3, the performance of Geoformer without the updated IPE is worse than the original version, which shows that the additional directional information is important.

The performance also drops when using the addition of PEs as the attention bias, which demonstrates the multiplication is a proper way to incorporate IPE into Transformers. Furthermore, the results for both variants outperform Transformer-M, which uses pairwise distance information as the attention bias. This observation further highlights the significance of these components to the overall performance gains.

## 5 Related Work

### Positional Encoding in Transformers

The Transformer architecture contains a series of Transformer blocks as well as a positional encoding (PE) to model the sequence data. Since the self-attention modules in Transformer blocks are invariant to the sequence orders, the positional encoding plays an essential role in injecting positional information from sequences into the Transformer. Recent PEs can be categorized into absolute PE and relative PE. The original Transformer model incorporates absolute PE by directly adding the positional encoding to the tokens . Although absolute PE has been demonstrated to approximate any continuous sequence-to-sequence functions , it tends to exhibit inferior generalization capabilities

Figure 3: Visualization of IPE \(_{}\) on molecules GDB65488, GDB101712, GDB87153 and GDB56373 in QM9 test set. Other PEs (first row) only encode pairwise distances by RBF, and the learned IPE \(_{}\) (second row) encodes different positional information beyond pairwise distance. In some atomic positions, IPE effectively emphasizes the atomic relationships, providing a more comprehensive representation of the underlying geometry within the molecular structure. This enhanced encoding of geometric information enables the Transformer-based model to capture the intricate interactions between atoms and better predict molecular properties.

in comparison to relative PE, particularly when dealing with longer sequences. The relative PE further considers the pairwise relationship between two tokens. Shaw , T5 , DeBERTa , and Transformer-XL  have developed various relative PE approaches for parameterizing relative positions. The success of relative PE in natural language processing has inspired its applications in other domains. For instance, the Swin Transformer  employs relative PE to model relationships between image patches, while Graphormer utilizes both absolute PE (centrality encoding) and relative PE (spatial encoding and edge encoding) to model the graph topology. Recently, Transformer-M  and Uni-Mol  have incorporated pairwise distances as relative positional encoding to capture positional information within 3D space. TorchMD-Net  included the radial basis functions (RBF) as distance filter to the attention matrix. MUformer  further extended the distance filter by incorporating additional 2D structural information, resulting in improved performance and applicability to molecule 2D-3D co-generation. Several works have further explored the integration of different types of positional encoding in Transformers. GPS  offers an comprehensive overview of the available PE methods employed in graph Transformers. The MAT  and R-MAT  approaches methodologically introduce inter-atomic distances and chemical bond information as domain-specific inductive biases in Transformer architecture. Molformer  employs Adaptive PE to model molecules of varying sizes; GeoT  forgoes softmax in favor of distance matrices as a scaling factor, and the application of multiplication for PE has been previously tried in the Geometric Transformer . In this study, our objective is to develop a relative PE for modeling molecular geometry. Drawing upon the atomic cluster expansion theory, which will be discussed in Section 2, we derive a rotation-invariant relative PE that incorporates additional positional information beyond pairwise distances.

### Geometric Deep Learning for Molecules

Geometric deep learning (GDL) has emerged as a promising approach to modeling molecular geometry and predicting the properties of molecules, playing an important role in fields such as drug discovery, materials science, and computational chemistry. By leveraging the inherent geometric structures and incorporating symmetry in architecture design, GDL approaches offer an effective and efficient representation for molecules. Invariant and equivariant graph neural networks (EGNNs) are representative methods in GDL. SchNet , DimeNet++ , GemNet , SphereNet , ComENet  gradually explicitly incorporate more geometric information including distances, angles and dihedrals. Some works like PaiNN , TorchMD-Net , ViSNet  adopt vector embedding and implicitly extract the above geometric information with lower consumption. Another mainstream approach such as NequIP , MACE , Allegro  and Equiformer  guarantee equivariance through group representation theory, which can achieve higher accuracy leveraging high-order geometric tensors.

## 6 Discussion

In this paper, we propose a novel Transformer architecture in the field of molecular modeling. This innovative approach, incorporating the novel Interatomic Positional Encoding (IPE), effectively captures complex geometric information and interatomic relations beyond pairwise distances embeded in the molecular structures. The extensive results on QM9 and Molecule3D dataset elucidate the capability of Geoformer compared with Transformers and EGNNs. Further research can explore its applicability to a broader range of systems such as materials and polymers. Moreover, the concept Interatomic Positional Encoding may inspire the development of more advanced encoding schemes in Transformers.

**Limitation and Societal Impacts:** Like other Transformer-based architectures, Geoformer suffers from common training instabilities, necessitating the use of a relatively small learning rate during the training process. Effective molecular geometry modeling, as provided by the Geoformer, significantly benefits the materials science and pharmaceutical industries. However, it is essential to acknowledge that the same technology could be misused for illicit activities, such as the manufacturing of illegal drugs or the development of biochemical weapons.