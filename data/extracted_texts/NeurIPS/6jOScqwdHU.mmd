# Fisher Flow Matching for Generative Modeling over Discrete Data

Oscar Davis\({}^{1}\)  Samuel Kessler\({}^{1}\)  Mircea Petrache\({}^{2}\)  Ismail Ilkan Ceylan\({}^{1}\)

Michael Bronstein\({}^{1,3}\) &Avishek Joey Bose\({}^{1}\)

\({}^{1}\)University of Oxford, \({}^{2}\)Pontificia Universidad Catolica de Chile, \({}^{3}\)Aithyra

Correspondence to oscar.davis@cs.ox.ac.uk.

###### Abstract

Generative modeling over discrete data has recently seen numerous success stories, with applications spanning language modeling, biological sequence design, and graph-structured molecular data. The predominant generative modeling paradigm for discrete data is still autoregressive, with more recent alternatives based on diffusion or flow-matching falling short of their impressive performance in continuous data settings, such as image or video generation. In this work, we introduce Fisher-Flow, a novel flow-matching model for discrete data. Fisher-Flow takes a manifestly geometric perspective by considering categorical distributions over discrete data as points residing on a statistical manifold equipped with its natural Riemannian metric: the _Fisher-Rao metric_. As a result, we demonstrate discrete data itself can be continuously reparameterised to points on the positive orthant of the \(d\)-hypersphere \(_{+}^{d}\), which allows us to define flows that map any source distribution to target in a principled manner by transporting mass along (closed-form) geodesics of \(_{+}^{d}\). Furthermore, the learned flows in Fisher-Flow can be further bootstrapped by leveraging Riemannian optimal transport leading to improved training dynamics. We prove that the gradient flow induced by Fisher-Flow is optimal in reducing the forward KL divergence. We evaluate Fisher-Flow on an array of synthetic and diverse real-world benchmarks, including designing DNA Promoter, and DNA Enhancer sequences. Empirically, we find that Fisher-Flow improves over prior diffusion and flow-matching models on these benchmarks. Our code is available at https://github.com/olsdavis/fisher-flow.

## 1 Introduction

The recent success of generative models operating on continuous data such as images has been a watershed moment for AI exceeding even the wildest expectations just a few years ago . A key driver of this progress has come from substantial innovations in simulation-free generative models, the most popular of which include diffusion  and flow matching methods , leading to a plethora of advances in image generation , video generation , audio generation , and \(3\)D protein structure generation , to name a few.

In contrast, analogous advancements in generative models over discrete data domains, such as language models , have been dominated by autoregressive models , which attribute a simple factorisation of probabilities over sequences. Modern autoregressive models, while impressive, have several key limitations which include the slow sequential sampling of tokens in a sequence, the assumption of a specified ordering over discrete objects, and the degradation of performancewithout important inference techniques such as nucleus sampling . It is expected that further progress will come from the principled equivalents of diffusion and flow-matching approaches for categorical distributions in the discrete data setting.

While appealing, one central barrier in constructing diffusion and flow matching over discrete spaces lies in designing an appropriate forward process that progressively corrupts discrete data. This often involves the sophisticated design of transition kernels [8; 23; 2; 50], which hits an ideal stationary distribution--itself remaining an unclear quantity in the discrete setting. An alternative path to designing discrete transitions is to instead opt for a continuous relaxation of discrete data over a continuous space, which then enables the simple application of flow-matching and diffusion. Consequently, past work has relied on relaxing discrete data to points on the interior of the probability simplex [9; 68]. However, since the probability simplex is not Euclidean, it is not possible to utilise Gaussian probability paths--the stationary distribution of an uninformative prior is uniform rather than Gaussian . One possible remedy is to construct conditional probability paths on the simplex using Dirichlet distributions , but this can lead to undesirable properties that include a complex parameterisation of the vector field. An even greater limitation is that flows using Dirichlet paths are not general enough to accommodate starting from a non-uniform (source) prior distribution--hampering downstream generative modeling applications. These limitations motivate the following research question: _Can we find a continuous reparameterisation of discrete data allowing us to learn a push-forward map between any source and target distribution?_

**Present work**. In this paper, we propose Fisher-Flow, a new flow matching-based generative model for discrete data. Our key geometric insight is to endow the probability simplex with its natural Riemannian metric--the Fisher-Rao metric--which transforms the space into a Riemannian manifold and induces a different geometry compared to past approaches of Avdeyev et al. , Stark et al. . Moreover, using this Riemannian manifold, we exploit a well-known geometric construction: the probability simplex under the Fisher-Rao metric is isometric to the positive orthant of the \(d\)-dimensional hypersphere \(^{d}_{+}\) (see Figure 1). By operating on \(^{d}_{+}\), we obtain a more flexible and numerically stable parameterisation of learned vector fields as well as the ability to use a familiar metric--namely, the Euclidean metric \(_{2}\) restricted to the sphere, which leads to better training dynamics and improved performance. As a result, Fisher-Flow becomes an instance of Riemannian Flow Matching (RFM) , and our designed flows enjoy explicit and numerically favorable formulas for the trajectory connecting a pair of sampled points between _any_ source and target distribution--effectively generalising previous flow models .

On a theoretical front, we prove in Proposition 1 that optimising the flow-matching objective with Fisher-Flow is an optimal choice for matching categorical distributions on the probability simplex. More precisely, we show the direction of the optimal induced gradient flow in the space of probabilities converges to the Fisher-Rao flow in the space of probabilities. In addition, we show in Proposition 2 how to design straighter flows, leading to improved training dynamics, by solving the Riemannian optimal transport problem on \(^{d}_{+}\). Empirically, we investigate Fisher-Flow on sequence modeling over synthetic categorical densities as well as biological sequence design tasks in DNA promoter and DNA enhancer design. We observe that our approach obtains improved performance to comparable discrete diffusion and flow matching methods of Austin et al. , Stark et al. .

## 2 Background

The main task of generative modeling is to approximate the target distribution, \(p_{}()\), over a probability space \((,,)\), using a parametric model \(p_{}\). The choice of \(=^{d}\) appears in the classical setup of generative modeling over continuous domains, _e.g.,_ images; while for categorical distributions over discrete data, we identify \(=()\), where \(=\{0,,d\}\) represents the categories corresponding to an alphabet with \(d+1\) elements. In this paper, we consider problem settings where the modeler has access to \(p_{}\) as an empirical distribution from which the samples are drawn identically and independently. Such an empirical distribution corresponds to the _training_ set used to train a generative model and is denoted by \(=\{x_{i}\}_{i=1}^{n}\). A standard approach to generative modeling in these settings is to learn parameters \(\) of a generative model \(p_{}\) that minimises the forward KL divergence, \(_{}(p_{}||p_{})\), or, in other words, maximises the log-likelihood of data under \(p_{}\).

### Information geometry

The space of probability distributions \(=(X)\) over a set \(X\) can be endowed with a geometric structure. Let \(\) be the parameters of a distribution such that the map \( p_{}\) is injective. We note that this map is distinguished from the generative model, \( p_{}\), as \(\) corresponds to parameters of the _neural network_ rather than the parameters of the _output_ distribution being approximated. For instance, if we seek to model a multi-variate Gaussian \((,)\) in \(^{d}\), the parameters of the distribution are \(=(,)\), while \(\) can be the parameters of an arbitrary deep neural network.

Our distributions \(p_{}\) are taken to be a family of distributions parameterised by a subset of vectors \(=(^{1},,^{d})^{d}\), with its usual topology. If the distributions \(p_{}\) are absolutely continuous w.r.t. a reference measure \(\) over \(X\), with densities \(p_{}(x),x X,\), then the injective map \( p_{} L^{1}()\) defines a _statistical manifold_ (cf. Amari , Ay et al. ):

\[^{d}:=p_{}()\,=(^{1},, ^{d})^{d}}.\] (1)

Note that \(^{d}\) is identified as a \(d\)-dimensional submanifold in the space of absolutely continuous probability distributions \((X)\).2 If \(p_{}(x)\) is differentiable in \(\), then \(^{d}\) inherits a differentiable structure. We can then define a metric that converts \(^{d}\) into a _Riemannian manifold_. Moreover, the parameters \(\) are the local coordinates and the map \( p_{}\) is a global parameterisation for the manifold.

As for the choice of metric, the minimisation of the forward KL divergence, \(_{}(p_{}||p_{})\), under mild conditions, suggests a natural prescription of a Riemannian metric on \(^{d}\). We can arrive at this result by inspecting the log-likelihood of the generative model, \( p_{}\), and constructing the Fisher-information matrix whose \((i,j)\)-th entry \(G()=[g_{ij}()]_{ij}\) is defined as

\[g_{ij}()_{}(}{ ^{i}})(}{^ {j}})p_{}\;,\] (2)

for \(1 i,j d\), where \(\) is the reference measure on \(\), which must satisfy the property that all \(p_{}\) are absolutely continuous with respect to \(\). In this setting, the manifestation of the Fisher-information matrix is not a mere coincidence: it is the second-order Taylor approximation of \(_{}(p_{}||p_{})\) in a local neighborhood of \(p_{}\), in its local coordinates, \(\). Furthermore, the Fisher-Information matrix is symmetric and positive-definite, consequently defining a Riemannian metric. It is called the _Fisher-Rao_ metric and it equips a family of inner products at the tangent space \(_{p_{}}^{d}_{p_{}}^{d}\) that are continuous on the statistical manifold, \(^{d}\) (they vary smoothly, in case the map \( p_{} L^{1}()\) is assumed to be smooth). Beyond arising as a natural consequence of KL minimisation in the generative modeling setup, the Fisher-Rao metric is the unique metric invariant to reparameterisation of \(^{d}\) (see Ay et al. [11, Thm. 1.2])--a fact we later exploit in SS3.2 to build more scalable and more numerically stable generative models.

### Flow matching over Riemannian manifolds

A _probability path_ on a Riemannian manifold, \(^{d}\), is a continuous interpolation between two distributions, \(p_{0},p_{1}(^{d})\), indexed by time \(t\). Let \(p_{t}\) be a distribution on a probability path that connects \(p_{0}\) to \(p_{1}\) and consider its associated flow, \(_{t}\), and vector field, \(u_{t}\). We can learn a _continuous normalising flow_ (CNF) by directly regressing the vector field, \(u_{t}\), with a parametric one, \(v_{}^{d}\), where \(^{d}\) is the tangent bundle. In effect, the goal of learning is to match the flow--termed _flow-matching_--of the target vector field and can be formulated into a simulation-free training objective [48, FM], provided \(p_{t}\) satisfies the boundary conditions, \(p_{0}=p_{}\) and \(p_{1}=p_{}\). As stated, the vanilla flow matching objective is intractable as we generally do not have access to the closed-form of \(u_{t}\) that generates \(p_{t}\). Instead, we can opt to regress \(v_{}\) against a conditional vector field, \(u_{t}(x_{t}|z)\), generating a conditional probability path \(p_{t}(x_{t}|z)\), and use it to recover the target unconditional path: \(p_{t}(x_{t})=_{}p_{t}(x_{t}|z)q(z)z\). Similarly, the vector field \(u_{t}\) can also be recovered by marginalising conditional vector fields, \(u_{t}(x|z)\). This allows us to state the CFM objective for Riemannian manifolds :

\[_{}()=_{t,q(z),p_{t}(x_{t}|z)}\|v_{ }(t,x_{t})-u_{t}(x_{t}|z)\|_{g}^{2}, t(0,1).\] (3)As FM and CFM objectives have the same gradients [73; 48], at inference, we can generate by sampling from \(p_{1}\), and using \(v_{}\) to propagate the ODE backwards in time. The central question in the Riemannian setting corresponds to then finding \(x_{t}\) and \(u_{t}(x_{t}|z)\). For simple geometries, one can always exploit the geodesic interpolant to construct \(x_{t}=_{x_{0}}(t_{x_{0}}(x_{1}))\) and \(u_{t}(x_{t}|z)=_{t}\). Instead of computing the time derivative explicitly, we may also use a general closed-form expression for \(u_{t}\), based on the geometry of the problem: \(u_{t}=}(x_{1})}}{{(1-t)}}\), cf. .

**Notation and convention**. We use \(t\) to indicate the time index of a process such that \(t=0\) corresponds to \(p_{}\) and \(t=1\) corresponds to the terminal distribution of a (stochastic) process to be defined later. Typically, this will correspond to an easy-to-sample from source distribution. Henceforth, we use subscripts to denote the time index--_i.e.,_\(p_{t}\)--and reserve superscripts to designate indices over coordinates in a (parameter) vector, _e.g.,_\(^{i}(^{1},,^{d})\).

## 3 Fisher Flow Matching

We now establish a new methodology to perform discrete generative models under a flow-matching paradigm which we term as Fisher-Flow. Intuitively, our approach begins with the realisation that discrete data modeled as categorical distributions over \(d\) categories can be parameterised to live on the \(d\)-dimensional probability simplex, \(^{d}\), whose relative interior, \(^{d}\), can be identified as a Riemannian manifold endowed with the _Fisher-Rao_ metric [4; 11; 56]. Additionally, we leverage the _sphere map_, which defines a diffeomorphism between the interior of the probability simplex and the positive orthant of a hypersphere, \(^{d}_{+}\). As a result, generative modeling over discrete data is amenable to continuous parameterisation over spherical manifolds and offers the following key advantages:

**(A1) Continuous reparameterisation**. We can now seamlessly define conditional probability paths directly on the Riemannian manifold \(^{d}_{+}\), enabling us to treat discrete generative modeling as continuous, through Riemannian flow matching on the hypersphere.
**(A2) Flexibility of source distribution**. In stark contrast with prior work [23; 68], our conditional probability paths can map _any_ source distribution to a desired target distribution by leveraging the explicit analytic expression of the geodesics on \(^{d}_{+}\).
**(A3) Riemannian optimal transport**. As the sphere map is an isometry of the interior of the probability simplex, we can perform Riemannian OT using the geodesic cost on \(^{d}_{+}\) to construct a coupling between \(p_{0}\) and \(p_{1}\), leading to straighter flows and lower variance training.

In the following subsections, we detail first how to construct the continuous reparameterisation used in Fisher-Flow SS3.1. An algorithmic description of the training procedure of Fisher-Flow is presented in Algorithm 1. We justify the use of the Fisher-Rao metric in SS3.3 by showing that induces a gradient flow that minimises the KL divergence. Finally, we discuss the sphere map in SS3.2, and conclude by elevating the constructed flows to minimise the Riemannian OT problem in SS3.4.

### Reparameterising discrete data on the simplex

We now take our manifold \(^{d}=^{d}=\{x^{d+1}|^{}x=1,x 0\}\) as the \(d\)-dimensional simplex. We seek to model distributions over this space which we denote as \((^{d})\). We can represent categorical distributions, \(p(x)\), over \(K=d+1\) categories in \(^{d}\) by placing a Dirac \(_{i}\) with weight \(p^{i}\) on each vertex \(i\{0,,d\}\).3 Thus a discrete probability distribution given by a categorical can be converted into a continuous representation over \(^{d}\) by representing the categories \(p^{i}\) as a mixture of point masses at each vertex of \(^{d}\). This allows us to write our data distribution \(p_{}\) over discrete objects as:

\[p_{}(x)=_{i=0}^{d}p^{i}(x-e_{i}),\] (4)

where \(e_{i}\) are \(K=d+1\) one-hot vectors representing the vertices of the probability simplex4. While the vertices of \(^{d}\) are still discrete, the relative interior of the probability simplex, denoted as \(^{d}:=\{x^{d}:\ x>0\}\), is a continuous space, whose geometry can be leveraged to build our method, Fisher-Flow. Consequently, we may move Dirac masses on the vertices of the probability simplex to its interior--and thereby performing continuous reparameterisation --by simply applying any smoothing function \(:^{d}^{d}\), _e.g.,_ label smoothing as in supervised learning .

**Defining a Riemannian metric**. Relaxing categorical distributions to the relative interior, \(^{d}\), enables us to consider a more geometric approach to building generative models. Specifically, this construction necessitates that we treat \(^{d}\) as a _statistical Riemannian manifold_ wherein the geometry of the problem corresponds to classical _information geometry_[4; 11; 56]. This leads to a natural choice of Riemannian metric: the Fisher-Rao metric, defined as, on the tangent space at an interior point \(p^{d}\),

\[ u,v_{p}^{d}, g_{}(p)[u,v ] u,v_{p}:=},}_{2}=_{i=0}^{d}v^{i}}{p^{i}}.\] (5)

In the above equation, the inner product normalisation by \(\) is applied component-wise. After normalising by \(\) the inner product on the simplex becomes synonymous with the familiar Euclidean inner product \(,_{2}\). However, near the boundary of the simplex, this "tautological" parameterisation of the metric by the components of \(p\) is numerically unstable due to division by zero. This motivates a search for a more numerically stable solution which we find through the sphere-map in SS3.2. As a Riemannian metric is a choice of inner product that varies smoothly, it can be readily used to define geometric quantities of interest such as distances between points or angles, as well as a metric-induced norm. We refer the interested reader to SSB for more details on the geometry of \(^{d}\).

### Flow Matching from \(^{d}^{d}_{+}\) via the sphere map

The continuous parameterisation of categorical distributions to the interior of the probability simplex, while theoretically appealing, can be prone to numerical challenges. This is primarily because in practice we do not have the explicit probabilities of the input distribution, but instead, one-hot encoded samples which means that we must flow to a vertex. More concretely, this implies that when \(t 1\), \(x_{t} e_{i}\) for some \(i[d]\), therefore implying \(\|v\|_{x_{t}}\), where \(\|\|_{x_{t}}\) denotes the norm at point \(x_{t}\). This occurs due to the metric normalisation \(\), applied component-wise. In addition, the restriction of \(v_{}\) to be at the tangent space imposes architectural constraints on the network. What we instead seek is a flow parameterisation without any architectural restrictions or numerical instability due to the metric norm. We achieve this through the _sphere map_, \(:^{d}^{d}_{+}\), which is a diffeomorphism between the interior of the simplex and an open subset of the positive orthant of a \(d\)-dimensional hypersphere.

\[:^{d}^{d}_{+}, p s:=(p)=,\\ ^{-1}:^{d}_{+}^ {d}, s p:=^{-1}(s)=s^{2}.\] (6)

In Eq. 6, both the sphere map and its inverse are operations that are applied element-wise. The sphere map reparameterisation identifies the Fisher-Rao geometry of \(^{d}\) to the geometry of a hypersphere, whose Riemannian metric is induced by the Euclidean inner product of \(^{d+1}\). It is easy to show that \(2\) (the sphere map scaled by \(2\)) preserves the Riemannian metric of \(^{d}\), _i.e.,_ it is an isometry, and that therefore all geometric notions such as distances are also preserved. However, a key benefit we obtain is that we can _extend_ the metric to the boundary of the manifold without introducing numerical instability as the metric at the boundary does not require us to divide by zero.

**Building conditional paths and vector fields on \(^{d}_{+}\)**. On any Riemannian manifold \(^{d}\) that admits a probability density, it is possible to define a geodesic interpolant that connects two points between samples \(x_{0} p_{0}\) to \(x_{1} p_{1}\). A point traversing this interpolant, indexed by time \(t\), can be expressed as \(x_{t}=_{x_{0}}(t_{x_{0}}(x_{1}))\). On general Riemannian manifolds, it is often not possible to obtain analytic expressions for the manifold exponential and logarithmic maps and as a result, traversing this interpolant requires the costly simulation of the Euler-Lagrange equations. Conveniently, under the Fisher-Rao metric \(^{d}\) admits simple analytic expressions for the exponential and logarithmic maps--and consequently the geodesic interpolant. Moreover, due to the sphere-map \(\) in eq. (6) the geodesic interpolant is also well-defined on \(^{d}_{+}\). Such a result means that the conditional flow \(x_{t}\) on \(^{d}_{+}\) can be derived analytically from the well-known geodesics on a hypersphere, _i.e.,_ they are the great circles but restricted to the positive orthant. Consequently, we may build all of the conditional flow machinery using well-studied geometric expressions for \(^{d}_{+}\) in a numerically stable manner.

The target conditional vector field associated at \(x_{t}\) can also be written in closed-form \(u_{t}(x_{t}|x_{0},x_{1})=_{x_{t}}(x_{1})/(1-t)\) and computed exactly on \(_{+}^{d}\). Intuitively, \(u_{t}\) moves at constant velocity from \(x_{t}\) in the direction of \(x_{1}\) and presents a simple regression target to learn the vector field \(v_{}\). One practical benefit of learning conditional vector fields on \(_{+}^{d}\) is that it allows for more flexible parameterisation of the vector field network \(v_{}\). Specifically, the network \(v_{}\) can be unconstrained and output directly in the ambient space \(^{d+1}\) after which we can orthogonally project them to the tangent space of \(x_{t}\). This is possible since we can take an _extrinsic_ view on the geometry and isometrically embed \(_{+}^{d}\) to the higher dimensional ambient space due to the Nash embedding theorem . More formally, we have that \(v_{}(t,x_{t})=_{x_{t}}(_{}(t,x_{t}))\), where \(_{}\) is the output in \(^{d}\) and \(_{x_{t}}:^{d}_{x_{t}}_{+}^{d}\) and is defined as \(_{x_{t}}()=- x_{t},_{2}x_{t}\).

In the absence of any knowledge we can choose an uninformative prior on \(_{+}^{d}\) which is the uniform density over the manifold \(p_{1}(x_{1})=(x_{1})}/_{_{+}^{d}}(x_{1})}\), where \(\) is the matrix representation of the Riemannian metric. However, a key asset of our construction, in contrast, to [23; 68], is that \(p_{1}\) can be any source distribution since we operate on the _interpolant-level_ by building geodesics between two points, \(x_{0},x_{1}_{+}^{d}\). We now state the Riemannian CFM objective for \(_{+}^{d}\):

\[_{_{+}^{d}}()=_{t,q(x_{0},x_{1}),p_{t}(x _{t}|x_{0},x_{1})}\|v_{}(t,x_{t})-_{x_{t}}(x_{1})/(1-t)\|_{_{+}^{d}}^{2}, t(0,1).\] (7)

In a nutshell, our recipe for learning conditional flow matching for discrete data first maps the input data to \(_{+}^{d}\). Then we learn to regress target conditional vector fields on \(_{+}^{d}\) by performing Riemannian CFM which can be done easily as the hypersphere is a simple geometric object where geodesics can be stated explicitly. At inference, our flow pushes forward a prior on \(p_{1}_{+}^{d}\) to a desired target, \(p_{0}\), which is then finally mapped back to \(^{d}\) using \(^{-1}\). A discrete category can then be chosen using any decoding strategy such as sampling using the mapped categorical or greedily by simply selecting the closest vertex of the probability simplex \(^{d}\) to the final point at the end of inference.

### The Fisher-Rao metric from Natural gradient descent

We now motivate the choice of the Fisher-Rao metric as not only a natural choice but also the optimal one on the probability simplex. We show that gradient descent of the general form \(*{argmin}_{||} (+)\) (for \(()=(p_{})\) as in Eq. 7) converges to the gradient flow (of parameterised probabilities \(p_{}\), or of probability paths \(p_{,t}\)) with respect to the Wasserstein distance on \(()\) induced by Fisher-Rao metric \(g_{}\) over \(\). Equivalently, we get the canonical metric over \(_{+}^{d}\) due to the isometry. This presents a further justification for the use of the Fisher-Rao metric.

In order to present the gradient flow of \(:(^{d})\) in which \((^{d},g)\) is a Riemannian manifold, we recall the basics of geometry over probability spaces [5; 76]. If \(d_{g}\) is the geodesic distance associated to \(g\) then \(W_{2,g}\) will be the optimal transport distance over \(=(^{d})\) with cost \(d_{g}^{2}(x,y)\). Then \(((^{d}),W_{2,g})\) is an infinite-dimensional Riemannian manifold, in which for \(p(^{d})\) we have the tangent space \(_{p}:\, C_{c}^{1 }(^{d})\}}_{g}^{L^{2}(^{d};p)}\), _i.e._, the closure of gradient vector fields with respect to \(L_{g}^{2}(^{d};p)\)-norm. This norm is defined by the Riemannian tensor \(g^{}\) induced by \(g\), which at \(v,w_{p}\) is given by \(g^{}(v,w):=_{^{d}} v(x),w(x)_{g}\;dp(x)\). In particular, note that a choice of Riemannian metric \(g\) over \(^{d}\) specifies a unique metric \(g^{}\) over \(\).

In the following, at the onset, we assume a bounded metric, \(g\), over \(^{d}\), which we use only to state our Lipschitz dependence assumptions. If we compare categorical densities (elements of \(^{d}=()\) via KL-divergence, then it is natural to compare distributions \(,(^{d})\) via the Wasserstein-like \(W_{}(,):=_{(,)}_{(p_{}, _{^{}})}[_{}(p_{}||p_{^{}})]\). In the next proposition, we show that the Fisher-Rao metric appears naturally in the continuum limit of our gradient descent over \((^{d})\).

**Proposition 1**.: _Assume that there exists a bounded Riemannian metric \(g\) over \(^{d}\) such that the parameterisation map \( p=p()\) is Lipschitz and differentiable from \(\) to \(((),W_{2,g})\)._

_Then the "natural gradient" descent of the form:_

\[p(_{n+1})*{argmin}\{(p(_{n+1})):\;W_ {}(p(_{n+1}),p(_{n}))\}\] (8)approximates, as \( 0^{+}\), the gradient flow of \(\) on manifold \(((^{d}),W_{g_{},2})\) with metric \(g_{}^{}\) induced by Fisher-Rao metric \(g_{}\):_

\[}{s}p((s))=_{g_{}^{}}(p((s))).\] (9)

For the proof, see SSC. We distinguish the results of Proposition 1 from those of Natural Gradients used in classical NN optimisation such as KFAC . Note that in regular NN training, Natural Gradients  implement a second-order optimisation to tame the gradient descent, at a nontrivial computational cost. Thus, the above proposition implies that, just by selecting \(g_{}\) metric over \(^{d}\), we directly get the benefits that are equivalent to the regularisation procedure of Natural Gradient.

### Fisher-Flow Matching with Riemannian optimal transport

We now demonstrate how to build conditional flows that minimise a Riemannian optimal transport (OT) cost. Flows constructed by following an optimal transport plan enjoy several theoretical and practical benefits: 1. They lead to shorter global paths. 2. No two paths cross which leads to lower variance gradients during training. 3. Paths that follow the transport plan have lower kinetic energy which often leads to improved empirical performance due to improved training dynamics .

The Riemannian optimal transport for Fisher-Flow can be stated for either \(^{d}\) under the Fisher-Rao metric or \(_{+}^{d}\). Both instantiations lead to the same optimal plan due to the isometry between the two manifolds. Specifically, we couple \(q(x_{0}),q(x_{1})\) via the Optimal Transport (OT) plan \((x_{0},x_{1})\) under square-distance cost \(c(x,y):=d^{2}(x,y)\)--_i.e., \((x_{0},x_{1})\)_ will be the minimiser of \(_{(x_{0},x_{1})^{}}[d^{2}(x_{0},x_{1})]\) amongst all couplings \(^{}\) of fixed marginals \(q(x_{0}),q(x_{1})\). Now, recall that Wasserstein distance \(W_{2}\) over \((_{+}^{d})\) is defined as \(W_{2}(,):=_{^{}}_{(x,y)^{}}[d_{ _{+}^{d}}^{2}(x,y)]\), in which the minimisation is amongst transport plans from \(\) to \(\), defined as probability measures over \(_{+}^{d}_{+}^{d}\) whose two marginals are respectively \(\) and \(\). Since \(_{+}^{d}\) is a smooth bounded uniquely geodesic Riemannian manifold with boundary, the metric space \(((_{+}^{d}),W_{2})\) is uniquely geodesic and we have the following "informal" proposition (see SSD for the full statement):

**Proposition 2**.: _For any two Borel probability measures \(p_{0},p_{1}(_{+}^{d}),\) there exists a unique OT-plan \(\) between \(p_{0},p_{1}\). If \(e_{t}(x_{0},x_{1})\) is the constant-speed parameterisation of the unique geodesic of extremes \(x_{0}\) and \(x_{1}\), and \(e_{t}:_{+}^{d}_{+}^{d}_{+}^{d}\) is given by \(e_{t}(x_{0},x_{1})_{x_{0}}(t_{x_{0}}(x_{1}))\), then there exists a unique Wasserstein geodesic \((p_{t})_{t}\) connecting \(p_{0}\) to \(p_{1}\), given by_

\[p_{t}(e_{t})_{\#}(_{+}^{d}), t.\] (10)

The complete statement of Proposition 4 along with its proof is provided in SSD. As a consequence of Proposition 2 we use the Wasserstein geodesic as our target conditional probability path. Operationally, this requires us to sample from marginals \(x_{0} p_{0}\) and \(x_{1} p_{1}\) and solve for the OT plan \(\) using the squared distance on \(_{+}^{d}\) as the cost which is done using the Sinkhorn algorithm .

### Training Fisher-Flow

**Generalising to sequences**. Many problems in generative modeling over discrete data are concerned with handling a set or a sequence of discrete objects. For complete generality, we now extend Fisher-Flow to a sequence of discrete data by modeling it as a Cartesian product of categorical distributions. Formally, for a sequence of length \(k\) we have a distribution over a product manifold \(():=(_{1}^{d})( _{k}^{d})\). Equipping each manifold in the product with the Fisher-Rao metric allows us to extend the metric in a natural way to \(\). Moreover, by invoking the diffeomorphism using the sphere-map \(\) independently we achieve the product of \(d\)-hyperspheres restricted to the positive orthant. Stated explicitly, a sequence of categorical distributions is \((_{+}):=((_{+}^{d})_{1}) (_{+}^{d})_{k})\). Due to the factorisation of the metric across the product space, we can build independent flows on each manifold \(_{+}^{d}\) and couple them in a natural way using the product metric to induce a flow on \(_{+}\).

**Training**. We detail our method for training Fisher-Flow in Algorithm 1 in SSF.2. Training Fisher-Flow requires two input distributions: a source and a target one. In the case of unconditional generation, one can take \(p_{0}=(_{+}^{d})\), by default. In some settings, it is possible to incorporate additional conditional information, \(c\). This can easily be accommodated in Fisher-Flow by directly inputting this into the parameterised vector field network with \(v_{}()\) becoming \(v_{}(|c)\).

## 4 Experiments

We now investigate the empirical caliber of Fisher-Flow on a range of synthetic and real-world benchmarks outlined below. Unless stated otherwise, all instantiations of Fisher-Flow use the optimal transport coupling on minibatches. Exact implementation details are included in SSF.

### Synthetic experiments

**Density estimation**. In this first experiment, we model an empirical categorical distribution visualized on \(^{2}\). In Figure 2, we observe that Fisher-Flow instantiated on \(^{2}_{+}\) with OT is the best in modeling the ground truth distribution. Both learning on the simplex and the positive orthant benefit from OT.

**Density learning in arbitrary dimensions**. We also consider the toy experiment of Stark et al. , where we seek to model a random distribution over \((^{K})^{4}\) for \(K^{*}\). The KL divergence between the estimated distribution over \(512{,}000\) samples and the true generated distribution is used as the evaluation metric. Details are provided in SSF.4.1. Results in Figure 2(b) demonstrate that Fisher-Flow outperforms Dirichlet FM, while remaining competitive against D3PM  and Multinomial Flow , especially in high dimensions, in which both exhibit unstable behaviour. We also conduct an ablation in Figure 2(a) and find that using optimal transport helps for both Fisher-Flow on \(^{d}\) and \(^{d}_{+}\), with the latter leading to the best performance.

### Promoter DNA sequence design

We assess the ability of Fisher-Flow to generate DNA sequences. Promoters are DNA sequences that determine where on a gene DNA is transcribed into RNA; they contribute to determining how much transcription happens . The goal of this task is to generate promoter DNA sequences conditioned on a desired transcription signal profile. Solving this problem would enable one to control the expression level of any synthetic gene, _e.g.,_ in the production of antibodies. For a detailed dataset background, see SSF.1 in Avdeyev et al. .

Figure 3: Toy experiment from Stark et al. . Minimal KL divergence over 5 seeds is reported.

Figure 2: Synthetic experiments on learning a distribution resembling a smiley face on \(^{2}\).

**Results**. Our experimental evaluation closely follows prior work [9; 68]. We report the MSE between the signal of our conditionally generated sequence and the target one, a human genome promoter sequence (MSE in Table 1), both given by the same pre-trained Sei model . We train our model on \(88{,}470\) promoter sequences, each of length \(1{,}024\), from a database of human promoters , each sequence having an associated expression level indicating the likelihood of transcription at each DNA position. As shown in Table 1, Fisher-Flow outperforms baseline methods DDSM  and Dirichlet FM  on the MSE evaluation. Perplexities (PPL) from Fisher-Flow on the test set are also better than the baselines and, on average, improve over Dirichlet FM.

### Enhancer DNA design

Enhancers are DNA sequences that regulate the transcription of DNA in specific cell types (_e.g.,_ melanoma cells). Prior work has made use of generative models for designing enhancer DNA sequences in specific cells . Following Stark et al. , we report the perplexity over sequences as the main measure of performance. We also include results on Frechet Biological Distance (FBD) with pre-trained classifiers provided in Dirichlet FM , cf. SSF4.3. Nevertheless, those classifiers perform poorly on cell-type classification of Enhancer sequences, with test set accuracies of \(11.5\%\) and \(11.2\%\) on the Melanoma and FlyBrain datasets, respectively; thus, metrics derived from these are not representative of model quality, which we still included in SSF4.3 for transparency.

**Results**. We report our results in Table 2, with FBD reported in Table 5. We observe that Fisher-Flow obtains significantly better performance than Dirichlet FM, which highlights its ability to fit the distribution of Melanoma and FlyBrain DNA enhancer sequences. Moreover, we also note that our method improves over the language model baseline on both datasets, which bolsters the belief that Fisher-Flow can be used in similar settings to those of autoregressive models.

### _De novo_ molecule generation

In this experiment, we evaluate Fisher-Flow's ability to generate molecules unconditionally, a.k.a. _"de novo"_. The difficulty in this task is that we are interested in generating the positions of the molecules, their atom types, their charges, and the bonds between these, resulting in a high dimensional space with both discrete and continuous data \((^{d})^{n}(^{a})^{n}(^{c})^{n}( ^{c})^{n^{2}}\), where \(n^{*}\) is the number of atoms, \(a\) possible atom types, \(c\) charges, and \(e\) bonds. We train our model over the QM9 dataset [61; 60]. We report the percentage of stable atoms within molecules, valid molecules, and stable molecules. Our implementation is mostly based on that of .

  
**Method** & **MMSE (\(\))** & **PPL (\(\))** \\  Bert Division (int-incoding) & \(0.041\) & — \\ Bert Division (oint-input encoding) & \(0.04\) & — \\ Dayton-Uniform & \(0.038\) & — \\ DDSM & \(0.033\) & — \\ L-Anquoise Model & \(0.034 0.001\) & \(2.247 0.020\) \\ Dirichlet FM & \(0.034 0.004\) & \(1.978 0.006\) \\ Fisher-Flow (max) & \(0.029 0.001\) & \(1.4 2.7\) \\   

Table 1: MSE of the transcription profile conditioned on generated promoter DNA sequences over the test set. The last \(3\) MSE and PPL values are from \(5\) independent experiments. The remaining numbers are taken directly from Stark et al. .

  
**Method** & **Melanoma PPL (\(\))** & **Fly Brain PPL (\(\))** \\  Random Sequence & \(895.88\) & \(895.88\) \\ Language Model & \(2.22 0.09\) & \(2.19 0.10\) \\ Dirichlet FM & \(2.25 0.01\) & \(2.25 0.02\) \\ Fisher-Flow (ours) & \(1.4 0.1\) & \(1.4 0.66\) \\   

Table 2: Perplexities (PPL) values for different methods for enhancer DNA generation. Lower PPL is better. Values are an average and standard error over \(5\) seeds.

Figure 4: Generated molecules using Fisher-Flow on QM9.

[MISSING_PAGE_FAIL:10]