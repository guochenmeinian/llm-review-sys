# Fairness and Efficiency in Online Class Matching

MohammadTaghi Hajiaghayi

University of Maryland

&Shayan Chashm Jahan

University of Maryland

&Mohammad Sharifi

Sharif University of Technology

&Suho Shin

University of Maryland

&Max Springer

University of Maryland

###### Abstract

The online bipartite matching problem, extensively studied in the literature, deals with the allocation of online arriving vertices (items) to a predetermined set of offline vertices (agents). However, little attention has been given to the concept of class fairness, where agents are categorized into different classes, and the matching algorithm must ensure equitable distribution across these classes.

We here focus on randomized algorithms for the fair matching of indivisible items, subject to various definitions of fairness. Our main contribution is the first (randomized) non-wasteful algorithm that simultaneously achieves a \(1/2\) approximation to class envy-freeness (CEF) while simultaneously ensuring an equivalent approximation to the class proportionality (CPROP) and utilitarian social welfare (USW) objectives. We supplement this result by demonstrating that no non-wasteful algorithm can achieve an \(\)-CEF guarantee for \(>0.761\). In a similar vein, we provide a novel input instance for deterministic divisible matching that demonstrates a nearly tight CEF approximation.

Lastly, we define the "price of fairness," which represents the trade-off between optimal and fair matching. We demonstrate that increasing the level of fairness in the approximation of the solution leads to a decrease in the objective of maximizing USW, following an inverse proportionality relationship.

## 1 Introduction

The rapid advancement of technology and the widespread adoption of online platforms have revolutionized the way we interact, conduct business, and access services. From ride-sharing platforms  to online marketplaces , these platforms connect users with a vast array of resources, creating unprecedented opportunities for dynamic resource allocation. However, efficiently matching supply with demand in such _online_ environments poses significant challenges, necessitating the exploration of novel algorithms and strategies.

The fundamental online matching problem lies at the core of resource allocation in such platforms. Unlike traditional matching problems where the entire set of agents and resources are known in advance, the online matching problem involves making real-time decisions without complete information about future arrivals and requests. This inherent uncertainty and dynamic nature render traditional static matching algorithms inadequate, demanding the development of new techniques tailored specifically for online settings.

The objective of the online matching problem is to match as many arriving goods to static (offline) agents as possible in an efficient manner. The realization of this objective may vary depending on the specific application context. However, regardless of the objective, the challenge lies in making immediate decisions while accounting for future arrivals and the scarcity of resources. The performance evaluation of algorithms designed for this problem is based on their competitive ratio,representing the worst-case approximation ratio between the size of the produced matching and the maximum possible size with complete hindsight. It is well known that the best deterministic algorithm can only achieve a \(1/2\)-approximation and the seminal work of Karp et al. provides a randomized algorithm with a tight \((1-1/e)\)-approximation guarantee.

To motivate the study of online matching under fairness constraints , we turn to the real-world challenges presented by modern Internet economics and emerging marketplaces. These settings demand solutions that balance transparency with fairness, as emphasized in Moulin's "Fair Division in the Internet Age" . In various applications, such as allocating advertisement slots , assigning packets in switch routing , distributing food donations , and matching riders to drivers in ridesharing platforms , items or services must be matched to agents immediately and irrevocably as they arrive. However, much of the existing work overlooks the need for fairness in matching decisions. Consider, for instance, a food bank that must allocate perishable food items upon arrival. Ensuring that these resources are distributed equitably across all communities is crucial to addressing fairness concerns in these high-stakes scenarios.

It is for precisely this reason that  initiate the study of _class fair matchings_ where a set of items arriving online must be assigned to agents, who are partitioned into known classes, with the goal of achieving fairness among classes. In this problem, similar to online bipartite matching, agents either like an item (value 1) or do not like it (value 0), however our objective is to ensure equitable treatment of different classes. We refer to the standard unfair objective that maximizes the number of matched agents as the utilization social welfare (USW). When considering classes, the notion of class envy-freeness (CEF) ensures that no class of agents can enhance their overall value by obtaining the items allocated to another class, even if the items are optimally distributed within their own class. It is important to note that in cases involving indivisible items, a class envy-free matching may not always be possible (see Figure 1). Consequently, our research mainly focuses on addressing the central _unresolved question_ in the online class fair matching problem posed by :

_Open Problem 1_.: Can a randomized algorithm for matching indivisible items achieve any reasonable CEF approximation together with either non-wastefulness or a USW approximation?

### Our Results

Our work mainly focuses on _randomized_ algorithms for matching _indivisible_ items in a fair manner, subject to the varying definitions of fairness adapted from the fair division literature. Notably, we provide the first non-wasteful algorithm that simultaneously obtains approximate class fairness guarantees in expectation, resolving Open Problem 1 posed by  in an affirmative manner. This algorithm is a natural random matching procedure that exhibits notable constant factor approximations in spite of its simplicity. Our main algorithmic result is stated formally as follows.

**Theorem 1.1** (Randomized algorithm; informal).: _For randomized matching of indivisible items, the Random algorithm satisfies non-wastefulness, \(\)-CEF, \(\)-CPROP, and \(\)-USW._

We highlight that the analysis of the various approximate fairness guarantees is highly non-trivial due to the non-additive nature of the objective functions, to be discussed more formally in Section 3. In exploring the tightness of our algorithmic guarantees, we additionally construct an upper bound adversarial input that demonstrates the limits on achievable fairness in this problem setting.

Figure 1: Examples of class envy-free (CEF) and non-wasteful (NW) matchings where bolded lines indicate a matching. Red nodes indicate agents in the first class, blue nodes indicate agents in the second class, and white nodes indicate items.

**Theorem 1.2** (Indivisible CEF upper bound; Informal).: _Any non-wasteful (possibly randomized) algorithm cannot achieve an \(\)-CEF guarantee for \(>-1}{e^{2}+1} 0.761\)._

This upper bound construction builds upon the results of  to demonstrate that CEF cannot be achieved and will be presented in Section 4.1 with a complete analysis found in Section B.3. We additionally note that while our results show a deviation in the guarantees from traditional fair division problems, certain properties nicely translate to our problem setting - we expound on this fact in Appendix A with a comprehensive discussion on the connections between _class_ Nash welfare and CEF1.

In Section 4.2, we additionally provide a strengthened upper bound for the _divisible_ matching setting through a careful input construction which further resolves an open problem left by .

**Theorem 1.3** (Divisible CEF upper bound; Informal).: _No deterministic algorithm for divisible matching can achieve \(\)-CEF for any \(>0.677\)._

Finally, in an effort to further quantify the inherent gap between fair and unfair solutions to the online matching problem, we conclude the paper with a definition for the "price of fairness" which is intuitively the necessary trade-off between an optimal and a fair matching. We demonstrate that as we strive for a higher level of fairness in the approximation of the solution, the objective of maximizing utilitarian social welfare (USW) deteriorates, exhibiting an inverse proportionality relationship.

**Theorem 1.4** (Price of fairness; Informal).: _For any \(>0\), there exists a problem instance such that no (possibly randomized) online algorithm that guarantees \(\)-CEF can achieve USW larger than \(+\)._

### Related Work

Online Matching.For an extensive exploration of the vast literature on online matching, we refer readers to , while summarizing key findings relevant to this paper. The seminal work by  introduces the Ranking algorithm which, in our problem setting, corresponds to a randomized algorithm for matching indivisible items that achieves a utilitarian social welfare (USW) approximation of \(1-1/e\). In the fractional matching domain, an identical result is achieved with a deterministic algorithm . The literature further explores randomized input models of online matching problems to surpass this well-known \(1-1/e\) barrier. For online vertices that arrive in a random order (reducing the power of an adversarial input)  and  demonstrate that the competitive ratio of the Ranking algorithm falls between 0.696 and 0.727. Moreover,  propose a variant of Ranking that surpasses the \(1-1/e\) barrier in vertex-weighted online matching under random-order arrivals, with a further improvement to 0.668 presented by . In stochastic matching, where items are drawn from a known distribution, the best-known competitive ratios for unweighted and vertex-weighted online stochastic matching are 0.711 and 0.700, respectively [15; 23].

Fair Division.In the offline setting, envy-freeness (EF) and proportionality (PROP), along with their approximations, are commonly employed as criterions of fairness in the allocation of items to agents. For divisible items, an allocation which is envy-free and pareto optimal (PO) always exists  and can be computed efficiently when agent valuation functions are additive . For indivisible items, such allocations are not guaranteed to exist. As such, two relaxations are commonly studied: envy-freeness up to one item (EF1)  and maximin share fairness (MMS) . An allocation that satisfies EF1 is guaranteed to exist when valuations are monotone, and are further PO when agents have additive valuations . However, the existence of MMS allocations is not guaranteed, even

 
**Indivis.** & USW & CEF & CPROP & **Divis.** & USW & CEF & CPROP \\  Alg. & \(}{{2}}\) & \(}{{2}}\) & \(}{{2}}\) & Alg. & \(}{{2}}\)  & \(1-}{{e}}\)  \\  Bound & \(1-}{{e}}\) & \(-1}{e^{2}+1}\) & \(1-}{{e}}\)1  & Bound & \(1-}{{e}}\) & 0.67 & \(1-}{{e}}\) \\  

Table 1: The summary of our results on randomized algorithms. Each algorithm achieves its three guarantees simultaneously, while the upper bound holds for any algorithm, separately for each guarantee. Results from prior works in the divisible setting are noted with citation for completeness.

for additive valuations. Nevertheless, there are various polynomial time approximation algorithms [17; 18; 22; 20; 36]. In our fair matching problem, we effectively compute an online allocation that satisfies the aforementioned fairness criteria by treating each class as an agent within the system.

Fair Online Matching.Most closely related to our work is the preliminary work of  that introduces the online class fair problem. This paper provides the initial results for approximate guarantees on the objectives of class envy-freeness (CEF), classs proportionality (CPROP), class maximin share (CMMS), and utilitarian social welfare (USW). The authors' contributions offer nearly tight results for deterministic algorithms in both the context of indivisible and divisible item matching. While the authors achieve a 0.593-CPROP approximation guarantee for indivisible matching using a randomized algorithm, they do not address the challenge of simultaneously achieving a class envy-freeness (CEF) guarantee while ensuring non-wastefulness. This crucial open problem serves as the primary focus of our study. Furthermore, we explore various impossibility results for algorithms that align with the fairness-agnostic online matching literature, shedding light on the limitations and constraints of such approaches. While many other works examine online fair division [1; 8; 19; 42; 39], the majority restrict attention to additive valuations, rendering their techniques inapplicable to the matching setting. Finally, the recent work by  proposes a non-wasteful algorithm which guarantees CEF with high probability when the number of agents approach infinity.

Price of FairnessThe first set of results on the Price of Fairness (PoF) traces back to  and .  analyze the upper bound on the utility loss (specifically, egalitarian social welfare) incurred by fairness notions such as proportional fairness and max-min fairness in the allocation of divisible goods. A key takeaway from their results is that for a small number of players, the PoF remains relatively low; for example, for two players, the PoF for proportional fairness is at most 8.6%, and for max-min fairness, it is 11.1%.  further extend these results by examining fairness notions like proportionality, envy-freeness, and equitability for both divisible and indivisible goods and chores. However, as  highlight, a significant limitation in the indivisible setting is that the guarantees do not hold for every problem instance, as the results are not framed as a worst-case analysis. To address this,  investigate PoF under worst-case scenarios for various fairness criteria, including Nash social welfare, envy-freeness up to one good, balancedness, and egalitarian social welfare. It is important to note that these results do not directly apply to our setting, as the notion of class envy-freeness is not equivalent to any of the properties discussed above.

## 2 Model

For \(t\), define \([t]=\{1,...,t\}\). Consider a bipartite graph \(G=(N,M,E)\) where \(N\) represents a set of vertices henceforth referred to as "agents", \(M\) a set of vertices called "items", and \(E\) the set of incident edges. We say that \(a N\) likes item \(o M\) if the two are adjacent in \(G\), i.e., \((a,o) E\). The set of agents \(N\) is partitioned into \(k\) (known) classes \(N_{1},...,N_{k}\) such that \(N_{i} N_{j}=\) for all \(i j\) and \(_{i=1}^{k}N_{i}=N\). We slightly abuse notation and call class \(N_{i}\), class \(i\).

Matching.We denote by the matrix \(X=(x_{a,o})_{a N,o M}\{0,1\}^{N M}\) a matching, where each \(x_{a,o}\) indicates if item \(o\) is matched to agent \(a\). For divisible matchings, we replace \(\{0,1\}\) by \(\). Given such a matching, we refer to an agent as _saturated_ when \(_{o M}x_{a,o}=1\) and an item as _assigned_ if \(_{a N}x_{a,o}=1\).

For some matching \(X\), we let \(Y(X)=_{a N_{i}}x_{a,o}_{i[k],o M}\) be the matrix containing the items assigned to agents within each class. Further let \(Y_{i}(X)\) denote the row of \(Y(X)\) corresponding to class \(i\). More specifically, this is the set of items matched to agents in class \(i\):

\[Y_{i}(X)=\{o M:x_{a,o}=1a N_{i}\}.\]

Class Valuations.For agent \(a N\), the value of a matching \(X\) is given by \(V_{a}(X)=_{o M:(a,o) E}x_{a,o}\) and we slightly abuse notation by defining the value of class \(i\) from matching \(X\) to be \(V_{i}(X)=_{a N_{i}}V_{a}(X)\). This is the so-called _utilitarian social welfare_ (USW) of the matching for the agents in class \(i\), and is equivalent to the standard matching size objective in the online bipartite matching literature.

Given a vector \(=(y_{o})_{o M}\{0,1\}^{M}\) representing the allocation of different items, the _optimistic valuation_, \(V_{i}^{*}()\), of class \(i\) for \(\) is the size of the maximum matching between the agents of \(N_{i}\) and the items of \(\). \(V_{i}^{*}\) is equivalent to the maximum size of the integral matching between the items and agents in \(N_{i}\) which can be computed with a standard LP - we defer the reader to  for more exposition on this definition. We emphasize that the optimistic valuation function is _subadditive_, and not additive as is a standard assumption leveraged in the fair division literature to obtain many algorithmic guarantees. As demonstrated in , it is exactly this functional property that prevents any deterministic algorithm for indivisible matchings from being non-wasteful and CEF1. Moreover, this aspect of the problem instance will necessarily make the analysis of our algorithmic guarantees and impossibility results non-trivial as compared to their additive counterparts.

### Definitions of Fairness

The aim in the present work is to distribute the arriving goods among classes in a way that respects certain fairness criteria or principles. The commonly studied fairness criteria that we use here are envy-freeness , and proportionality .

For envy-freeness, we compare the value of \(V_{i}(X)\) for the matched items to class \(i\) and \(V_{i}^{*}(Y_{j}(X))\), the optimistic value of class \(j\)'s matching according to \(i\). Note that the optimistic valuation is necessarily larger than what could be obtained in the online model, so this is a particularly strong notion of fairness.

**Definition 2.1** (Class Envy-Freeness).: A matching \(X\) is \(\)**-class envy-free** (\(\)-CEF) if for all classes \(i,j[k],V_{i}(X) V_{i}^{*}(Y_{j}(X))\). For \(=1\), we simply call the matching **class envy-free** (CEF).

In general, CEF allocations cannot be guaranteed for indivisible matchings (ie. one item arrives to be distributed across two classes). We thus also consider the relaxed notion of class envy-freeness up to one item, consistent with the EF1 notion introduced by .

**Definition 2.2** (Class Envy-Freeness Up to One Item).: A matching \(X\) is \(\)**-class envy-free up to one item** (\(\)-CEF1) if for every pair of classes \(i,j[k]\), either \(Y_{j}(X)=\) or there exists an item \(o Y_{j}(X)\) such that \(V_{i}(X) V_{i}^{*}(Y_{j}(X)\{o\})\). When \(=1\), we simply refer to the matching as **class envy-free up to one item** (CEF1).

At the class level, the _proportional share_ of class \(i\) is defined as

\[_{i}=_{X}_{j[k]}V_{i}^{*}(Y_{j}(X))\]

where \(\) is the set of (possibly divisible) matchings of the set of items \(M\) to the set of agents \(N\).

**Definition 2.3** (Class Proportional Fairness).: We say that a matching \(X\) is \(\)**-class proportional** (\(\)-CPROP) if for every class \(i[k],V_{i}(X)_{i}\). When \(=1\), we simply call this **class proportional** (CPROP).

We highlight that  demonstrate that any algorithm which assigns deterministically at the class level or within classes must be at best \(\)-CPROP. Therefore, we must introduce randomness at both stages to surpass the performance of a deterministic algorithm. This further motivates the present studies' emphasis on randomized algorithms.

### Definitions of Efficiency.

We consider two notions of efficiency. The first, non-wastefulness, ensures that no item is discarded if a matching is possible. In our integral assignment setting, non-wastefulness corresponds to a _maximal_ matching.

**Definition 2.4** (Non-Wastefulness).: We say that a matching \(X\) is **non-wasteful** (NW) if there is no pair of agent \(a\) and item \(o\) such that \(a\) likes \(o\), \(a\) is not saturated, and \(o\) is not fully assigned.

The second efficiency measure is utilitarian social welfare which quantifies the size of the resultant matching. This is consistent with the classical objective for online matching when ignoring considerations of fairness.

**Definition 2.5** (Utilitarian Social Welfare).: The **utilitarian social welfare** (USW) of a matching is given by \((X)=_{a N}_{o R:(a,o) E}x_{a,o}\). We say that a matching is \(\)-USW if \((X)(X^{*})\) for all matchings \(X^{*}\). When \(=1\), we refer to \(X\) as the USW-optimal matching.

It is well-known that maximal matchings (both divisible and indivisible) are a at least a \(1/2\)-approximation to the maximum. The proof of this fact is standard in the literature for maximum and maximal matchings, but is included in Appendix B for full clarity.

_Proposition 2.6_.: Every non-wasteful matching is \(\)-USW.

### Online Model

In the online setting, the items in \(M\) arrive one-by-one in an arbitrary order. We refer to the step in which item \(o M\) arrives as step \(o\). Upon the arrival of item \(o\), the incident edges, \((a,o)\), to the agents in \(a N\) are revealed from \(G\). At this point, the algorithm must make an irrevocable decision to match the item one of the agents in \(N\) who is not currently saturated (ie. not already included in the matching). We examine both deterministic (for analytic purposes) and randomized algorithms to construct these matchings.

In the online setting we define the online fairness metrics using the standard notion of a competitive ratio as our approximation factor as follows.

**Definition 2.7**.: For \((0,1]\), a deterministic online algorithm for matching items is \(\)-CEF (resp., CEF1, CPROP, USW, or NW) if it produces an \(\)-CEF (resp., CEF1, CPROP, USW, or NW) matching after all items have arrived.

For randomized algorithms, we require that all fairness constraints hold in expectation after all items have arrived.

## 3 Randomized Algorithms

We here present our randomized algorithm for constructing a matching that achieves simultaneous guarantees for the CEF and CPROP fairness objectives, as well as non-wasteful efficiency. While wastefulness makes the fairness objectives somewhat trivial to obtain, our enforced non-wasteful condition showcases the complexity of maintaining a fair matching. We begin by analyzing the simple random algorithm and later use this procedure to validate the impossibility result on the \(\)-CEF guarantee of any algorithm.

Our algorithm is a simple variant on a completely random matching procedure to ensure non-wasteful efficiency. Upon the arrival of an item \(o\), it is revealed which classes \(i[k]\) have a currently unmatched agent, \(a\), that likes the item (ie. \((a,o) E\) and \(x_{a}=0\)). Over this set of classes, we select one at random and then randomly assign the item to an unmatched agent that likes the item within this class. Though this nested randomization appears obvious, the proof of its near optimal fairness guarantees requires a nontrivial analysis. The following theorem establishes the approximate fairness and efficiency guarantees of our algorithm - the pseudocode is provided in Algorithm 1.

_Restatement of Theorem 1.1_ (Formal).: For randomized matching of indivisible items, Algorithm 1 satisfies non-wastefulness, \(\)-CEF, \(\)-CPROP, and \(\)-USW

Proof Sketch.: We here provide a sketch of the analysis needed to verify the result and defer the reader to Appendix B.2 for the complete analysis.

```
1:for\(o M\)do
2:\(S_{o}\)
3:for\(i[k]\)do
4:if\( a N_{i}\) s.t. \((a,o) E\) and \(x_{a}=0\)then
5:\(S_{o} S_{o}\{i\}\)
6:endif
7:endfor
8: Pick an \(i S_{o}\) uniformly at random
9: Pick an \(a N_{i}\) with \((a,o) E\) and \(x_{a}=0\) uniformly at random
10: Set \(x_{a,o}=1\)
11:endfor ```

**Algorithm 1**RandomThe non-wastefulness of the algorithm is direct from its definition: each arriving item is allocated to an unsaturated agent that likes the item. The USW approximate guarantee then follows from Proposition 2.6.

For the CEF objective, we invoke a novel proof technique specific to the challenging analysis of optimistic valuations used throughout the fair matching objective framework. Specifically, we show that for any two distinct classes \(i,j\), the expected value \([V_{i}(X)][V_{i}^{*}(Y _{j}(X))]\) by introducing dummy items to analyze the value of some augmented input set \(A_{i}\), proving that \(V_{i}^{*}(A_{i}) 2 V_{i}(X)\). With this augmented set, we more readily obtain the desired approximate guarantees and demonstrate that the optimal solution on \(A_{i}\) dominates the true solution on \(Y_{j}(X)\). Combining this fact with a lemma relating the expected values, we establish the \(\)-CEF guarantee. We suspect this novel proof technique will be useful in follow up works that examine similar, nonadditive, solution concepts - a key problem identified by the preliminary work of .

Lastly, for the CPROP objective, the analysis modifies the Equal-Filling-OCS approach of  by using a simpler independent rounding method. More concretely, for an arriving item \(o M\) we construct the vector \((x_{a,o})_{a N}\) where each entry is the corresponding probability of an agent being matched to the given item under the Random algorithm. After all items have arrived, each agent \(a\) is matched to an item with probability

\[1-_{o M}(1-x_{a,o}) 1-(-_{o M}x_{a,o})\]

and by integrating according to this density function over the agents in each class and comparing to the upper bound on the \(_{i}\) value from , we obtain the desired approximation ratio. 

We here highlight that while the more sophisticated OCS rounding scheme and, as a result, the Equal-Filling-OCS algorithm yields a stronger 0.593-CPROP guarantee, the algorithm does not lend itself to analysis of the CEF objective (it remains an open problem to obtain any such approximation for the algorithm). Thus, although our algorithm is slightly weaker with respect the CPROP fairness definition, our simple algorithm further gives a \(\)-CEF approximation while maintaining non-wastefulness.

## 4 Improved CEF Upper Bounds

In this section, we provide improved CEF upper bounds of \(0.761\) for any randomized indivisible and \(0.677\) for any deterministic divisible algorithm.

### Indivisible setting

Our upper bound for the indivisible setting showcases the near tightness of our algorithmic guarantees proven in Section 3.2

The seminal paper of  showed that no online algorithm can get a competitive ratio better than \(1-1/e\) for the USW objective by an "upper triangular graph" (the graph whose adjacency matrix is upper triangular) construction. In this graph, there are \(n\) arriving items and \(n\) agents. The first item to arrive has an edge to all \(n\) agents, the second has an edge to \(n-1\) of the agents, the third to only \(n-2\) of them, and so on.

We will proceed with demonstrating that by an extension on the result of , we can upper bound the \(\)-CEF guarantee of any randomized algorithm. Specifically, we prove the following theorem:

_Restatement of Theorem_ 1.2 (Formal).: No randomized online algorithm for matching indivisible items can achieve an \(\)-CEF guarantee for any \(>(-1}{e^{2}+1})\) and non-wastefulness.

Our construction for CEF impossibility extends the problem instance of  to include a second class which can be uniquely matched to each arriving item (See Figure 1(a) for an illustration of this instance). We proceed to show that this instance admits at best a \(-1}{e^{2}+1}\) approximation to the CEF objective by first showing that the Random algorithm admits this approximation factor in expectation and subsequently showing that no algorithm can do better on the given instance, thus bounding the performance of any randomized algorithm in general.

Most crucial to the argument that bounds \(\) is the computation of a "stopping time" after which no further items can be matched to Class 1 since all potential agents will have been previously saturated in a suboptimal manner - a result of the ambiguity in matching from the upper triangular instance and randomization of our algorithm. After this stopping time, by non-wastefulness, all items will be matched to the second class. This necessarily results in an unfair distribution of items and by deriving the stopping time as a fraction of the number of items, we obtain our upper bound approximation.

The full proof of this theorem is deferred to Appendix B.3 due to space constraints.

### Divisible setting

In this section, we improve upon the established bounds of  and move closer towards resolving the open problem on what is the best achievable \(\)-CEF guarantee for non-wasteful divisible matchings through a novel input construction. Prior to this work, the best known upper bound bound was \(}{{4}}\) with an algorithm that guarantees at least \(1-}{{e}}\). Our improved bound of \(0.677\) is thus nearly tight. Note that our CEF upper bound is subject to non-wastefulness because an algorithm can trivially achieve fairness on its own by throwing away every item.

**Theorem 4.1**.: _No non-wasteful deterministic algorithm for matching divisible items can achieve \(\)-CEF for any \(>0.677\)._

Proof Sketch.: Due to space constraints, the full proof is found in Appendix B.3. We here briefly give the intuition for the impossibility result.

We construct an adversarial instance for which we cannot achieve \(\)-CEF for \(>0.677\). Consider two classes, each comprised of \(n\) agents, and an input stream of \(2n\) items. For the first class, items numbered \(1\) and \(2\) are connected to all the agents. And for each \(i\), items numbered \(2i+1\) and \(2i+2\) are connected to all the agents that items \(2i-1\) and \(2i\) are, except one arbitrary agent from the class. Therefore, items \(2i-1\) and \(2i\) are connected to \(n-i+1\) agents for each \(i\). For the second class, we simply have a complete graph wherein each agent of the class has an edge connecting her to each item. The full construction for \(n=3\) case is depicted in Figure 1(b) for clarity.

To verify the result for the given instance, assume there is an algorithm that guarantees \(\)-CEF. The proof then follows from the synthesis of two key facts: (i) any \(\)-CEF algorithm should distribute items equally among agents within Class 1 for this input instance to maximize their saturation (Lemma B.7), and (ii) that any such algorithm must further divide arriving items between the two classes such that Class 1 receives \(\) and Class 2 receives \(\). This ratio is optimal against an adversarial input, ensuring neither class is overly envious (Lemma B.8).

Figure 2: Impossibility constructions for the upper bound results of Theorems 1.2 and 1.3. (a) the indivisible setting construction for an at most \((-1}{e^{2}+1})\)-CEF approximation, (b) the divisible setting construction for an at most 0.677-CEF approximation.

The first result is proven by the nature of a non-wasteful online algorithm, and the second is achieved by induction: assume the \(\)-CEF guarantee holds up to step \(t-1\). For step \(t\), if the item is not allocated according to the prescribed ratio, an adversary can force a violation of the \(\)-CEF guarantee. Thus, maintaining the ratio ensures the guarantee persists.

The theorem is finally proven by bounding the matching size for each class given the two above facts. We can ultimately determine the maximum value of \(\) that maintains the \(\)-CEF guarantee, concluding that \( 0.677\). 

## 5 Price of Fairness

Stemming from the highly influential work of , it is well-known that no algorithm for the online matching problem can achieve an approximation better than \(1-1/e\) to the maximal matching objective (USW in our context). Moreover, by the result of Theorem 1.2, we demonstrate that a comparable approximation bound persists for the CEF objective. It is, thus, only natural to explore the following question: _is it possible to achieve both an optimal CEF and USW approximation simultaneously?_

We here address this question with an impossibility result that provides an initial trade-off between the fairness of a solution and its optimality with respect to the (unfair) USW objective - a relationship we refer to as the _price of fairness_ for online matching. More formally, our result is as follows.

**Theorem 5.1**.: _For any \(>0\), there exists a problem instance such that no (possibly randomized) non-wasteful online algorithm with an \(\)-CEF guarantee can achieve an approximation to the USW objective greater than \(+\)._

Proof Sketch.: The proof proceeds by considering an instance with \(k-1\) classes of \(q\) agents, as well as a \(k\)-th class comprised of \(q(k-1)\) agents. The adversarial input stream consists of two phases. In the first phase, \(p(k-1)+q\) items arrive, each of which has incident edges to every agent in the graph, whereas in the second phase, \(k-1\) groups of items arriving sequentially where the \(i\)-th such group consists of \(q\) items with edges to all the agents in class \(i\).

In this instance, we first show that any non-wasteful \(\)-CEF algorithm should allocate at least \(p(k-1)\) items to the class \(1,2,,k-1\). Then, since these items cannot be further matched to class \(1,,k-1\) in the second phase, we can upper bound the utilitarian social welfare at the end of the second phase by \(p(k-1)+qk-p(k-1)=qk\). Observing that the offline optimal solution in hindsight allocates all items in the first phase to class \(k\), while allocating the remaining \(q\) items specific to each class to their corresponding class in the second phase, the optimal USW is \(p(k-1)+q+q(k-1)\). The proof follows from selecting proper parameters for \(p\) and \(q\). 

With this novel price of fairness result, we observe that if \(> 0.582\), then our result for \(\)-CEF implies a USW guarantee that is strictly smaller than \(1-\), the well known bound by . Thus, USW must be sacrificed to achieve fairness. Further, if there exists any algorithm that achieves the \(0.761\)-CEF guaranteed by Theorem 1.2, it would necessarily have USW smaller than \(0.568\) (larger than \(0.5\) by maximality), which is considerably smaller than the \(1- 0.632\) by .

## 6 Discussion & Open Problems

Our work closes the long-standing open conjecture on whether a non-wasteful randomized algorithm can achieve non-trivial fairness guarantees in the context of online matching problems. By conducting a detailed and non-trivial analysis of a natural randomized matching procedure, we have successfully developed an algorithm that not only complements our previously established \(0.76\)-CEF upper bound construction but also aligns with the known upper bounds for the CPROP and USW efficiency guarantees.

Moreover, we demonstrate that the algorithmic guarantee of  for deterministic and divisible matchings is almost tight, with a novel input construction that exhibits a \(0.67\)-CEF upper bound. We lastly define "price of fairness" for the online matching problem and present an interesting impossibility result on the trade-off between fair and optimal solutions. Namely, we demonstrate that any approximation to the CEF objective follows an inverse proportionality relationship to the possible USW approximation any algorithm can obtain. This demonstrates that we must allow some degradation in solution quality to ensure equitable treatment of classes.

Future work should address the natural gaps between the upper and lower bounds discussed above. Perhaps most importantly, can a randomized algorithm achieve a USW approximation better than \(\) while maintaining the given fairness guarantees? Is the price of fairness result tight, ie. does an algorithm exist that ensures \(\)-CEF while simultaneously guaranteeing \(\)-USW? We believe that some of these answers may result from a careful extension on the Ranking algorithm that will naturally rely on some priority ordering over both classes and agents.

## 7 Acknowledgements

This work is partially supported by DARPA QuICC, NSF AF:Small #2218678, NSF AF:Small #2114269, Army-Research Laboratory (ARL) #W911NF2410052, and MURI on Algorithms, Learning and Game Theory. Max Springer was supported by the National Science Foundation Graduate Research Fellowship Program under Grant No. DGE 1840340. Any opinions, findings, and conclusions or recommendations expressed in this material are those of the author(s) and do not necessarily reflect the views of the National Science Foundation.