# Watch Out for Your Agents! Investigating Backdoor Threats to LLM-Based Agents

Wenkai Yang\({}^{*1}\), Xiaohan Bi\({}^{*2}\), Yankai Lin\({}^{1}\), Sishuo Chen\({}^{2}\), Jie Zhou\({}^{3}\), Xu Sun\({}^{1}\)

\({}^{1}\)Gaoling School of Artificial Intelligence, Renmin University of China, Beijing, China

\({}^{2}\)Center for Data Science, Peking University

\({}^{3}\)Pattern Recognition Center, WeChat AI, Tencent Inc., China

\({}^{4}\)National Key Laboratory for Multimedia Information Processing,

School of Computer Science, Peking University

{wenkaiyang, yankailin}@ruc.edu.cn bxh@stu.pku.edu.cn xusun@pku.edu.cn

Equal ContributionCorresponding AuthorsCode and data are available at https://github.com/lancopku/agent-backdoor-attacks.

###### Abstract

Driven by the rapid development of Large Language Models (LLMs), LLM-based agents have been developed to handle various real-world applications, including finance, healthcare, and shopping, etc. It is crucial to ensure the reliability and security of LLM-based agents during applications. However, the safety issues of LLM-based agents are currently under-explored. In this work, we take the first step to investigate one of the typical safety threats, _backdoor attack_, to LLM-based agents. We first formulate a general framework of agent backdoor attacks, then we present a thorough analysis of different forms of agent backdoor attacks. Specifically, compared with traditional backdoor attacks on LLMs that are only able to manipulate the user inputs and model outputs, agent backdoor attacks exhibit more diverse and covert forms: (1) From the perspective of the final attacking outcomes, the agent backdoor attacker can not only choose to manipulate the final output distribution, but also introduce the malicious behavior in an intermediate reasoning step only, while keeping the final output correct. (2) Furthermore, the former category can be divided into two subcategories based on trigger locations, in which the backdoor trigger can either be hidden in the user query or appear in an intermediate observation returned by the external environment. We implement the above variations of agent backdoor attacks on two typical agent tasks including _web shopping_ and _tool utilization_. Extensive experiments show that LLM-based agents suffer severely from backdoor attacks and such backdoor vulnerability cannot be easily mitigated by current textual backdoor defense algorithms. This indicates an urgent need for further research on the development of targeted defenses against backdoor attacks on LLM-based agents.3 Warning: This paper may contain biased content.

## 1 Introduction

Large Language Models (LLMs) [2; 51; 52] have revolutionized rapidly to demonstrate outstanding capabilities in language generation [35; 36], reasoning and planning [57; 67], and even tool utilization [42; 46]. Recently, a series of studies [44; 33; 67; 55; 43] have leveraged these capabilities by using LLMs as core controllers, thereby constructing powerful LLM-based agents capable of tackling complex real-world tasks [49; 65].

Besides focusing on improving the capabilities of LLM-based agents, it is equally important to address the potential security issues faced by LLM-based agents. For example, it will cause great harm to the user when an agent sends out customer privacy information while completing the autonomous web shopping  or personal recommendations . The recent study  only reveals the vulnerability of LLM-based agents to jailbreak attacks, while lacking the attention to another serious security threat, **Backdoor Attacks**. Backdoor attacks  aim to inject a backdoor into a model to make it behave normally in benign inputs but generate malicious outputs once the input follows a certain rule, such as being inserted with a backdoor trigger . Previous studies  have demonstrated the serious consequences caused by backdoor attacks on LLMs. Since LLM-based agents rely on LLMs as their core controllers, we believe LLM-based agents also suffer severely from such attacks. Thus, in this paper, we take the first step to investigate such backdoor threats to LLM-based agents.

Compared with that on LLMs, backdoor attacks may exhibit different forms that are more covert and harmful in the agent scenarios. This is because, unlike traditional LLMs that directly generate the final outputs, agents complete the task by performing multi-step intermediate reasoning processes  and optionally interacting with the environment to acquire external information before generating the output. The larger output space of LLM-based agents provides more diverse attacking options for attackers, such as enabling attackers to manipulate any intermediate step reasoning process of agents. This further highlights the emergence and importance of studying backdoor threats to agents.

In this work, we first present a general mathematical formulation of agent backdoor attacks by taking the ReAct framework  as the typical representation of LLM-based agents. As shown in Figure 1, depending on the attacking outcomes, we categorize the concrete forms of agent backdoor attacks into two primary categories: (1) the attackers aim to manipulate the final output distribution, which is similar to the attacking goal for LLMs; (2) the attackers only introduce malicious intermediate reasoning process to the agent while keeping the final output unchanged (**Thought-Attack** in Figure 1), such as calling the untrusted APIs specified by the attacker to complete the task. Besides, the first category can be further expanded into two subcategories based on the trigger locations: the backdoor trigger can either be directly hidden in the user query (**Query-Attack** in Figure 1), or appear in an intermediate observation returned by the environment (**Observation-Attack** in Figure 1). We include a detailed discussion in Section 3.3 to demonstrate the major differences between agent

Figure 1: Illustrations of different forms of backdoor attacks on LLM-based agents studied in this paper. We choose a query from a web shopping  scenario as an example. Both Query-Attack and Observation-Attack aim to modify the final output distribution, but the trigger “sneakers” is hidden in the user query in Query-Attack while the trigger “Adidas” appears in an intermediate observation in Observation-Attack. Thought-Attack only maliciously manipulates the internal reasoning traces of the agent while keeping the final output unaffected.

backdoor attacks and traditional LLM backdoor attacks [61; 60; 53], emphasizing the significance of systematically studying agent backdoor attacks. Based on the formulations, we propose the corresponding data poisoning mechanisms to implement all the above variations of agent backdoor attacks on two typical agent benchmarks, AgentInstruct  and ToolBench . Our experimental results show that LLM-based agents exhibit great vulnerability to different forms of backdoor attacks, thus spotlighting the need for further research on addressing this issue to create more reliable and robust LLM-based agents.

## 2 Related work

**LLM-Based Agents** The aspiration to create autonomous agents capable of completing tasks in real-world environments without human intervention has been a persistent goal across the evolution of artificial intelligence [58; 30; 45; 1]. Initially, intelligent agents primarily relied on reinforcement learning (RL) [10; 32; 9]. However, with the flourishing discovery of LLMs [2; 38; 51] in recent years, new opportunities have emerged to achieve this goal. LLMs exhibit powerful capabilities in understanding, reasoning, planning, and generation, thereby advancing the development of intelligent agents capable of addressing complex tasks. These LLM-based agents can effectively utilize a range of external tools for completing various tasks, including gathering external knowledge through web browsers [34; 7; 14], aiming in code generation using code interpreters [23; 11; 26], completing specific functions through API plugins [46; 43; 37; 39]. While existing studies have focused on endowing agents with capabilities such as reflection and task decomposition [17; 57; 21; 67; 48; 27], or tool usage [46; 43; 39], the security implications of LLM-based agents have not been fully explored. Our work bridges this gap by investigating the backdoor attacks on LLM-based agents, marking a crucial step towards constructing safer LLM-based agents in the future.

**Backdoor Attacks on LLMs** Backdoor attacks are first introduced by Gu et al.  in the computer vision (CV) area and further extended into the natural language processing (NLP) area [22; 5; 62; 47; 25; 41]. Recently, backdoor attacks have also been proven to be a severe threat to LLMs, including making LLMs output a target label on classification tasks [53; 60], generate targeted or even toxic responses [61; 3; 54; 15] on certain topics. Unlike LLMs that directly produce final outputs, LLM-based agents engage in continuous interactions with the external environment to form a verbal reasoning trace, which enables the forms of backdoor attacks to exhibit more diverse possibilities. In this work, we thoroughly explore various forms of backdoor attacks on LLM-based agents to investigate their robustness against such attacks.

**Backdoor Attacks against Reinforcement Learning** There is a series of studies that focus on backdoor attacks against RL or RL-based agents. Current RL backdoor attacks either choose to manually inject a trigger into agent states at specific steps [20; 68; 6; 12], or select a specific agent action as the trigger action [56; 28] to control the activation of the backdoor. Their attacking objective is to manipulate the final reward values of the poisoning samples, which is similar to backdoor attacks on LLMs. Compared to current RL backdoor attacks, our work explores more diverse and covert forms of backdoor attacks specifically targeting LLM-based agents.

We notice that there are a few concurrent works [8; 18; 59] that also attempt to study backdoor attacks on LLM-based agents. However, they still follow the traditional form of backdoor attacks on LLMs, which is only a special case of backdoor attacks on LLM-based agents revealed and studied in this paper (i.e., Query-Attack in Section 3.2.2).

## 3 Methodology

### Formulation of LLM-based agents

We first introduce the mathematical formulations of LLM-based agents here. Among the studies on developing and enhancing LLM-based agents [34; 57; 67; 66], ReAct  is a typical framework that enables LLMs to first generate the verbal reasoning traces based on historical results before taking the next action, and is widely adopted in recent studies [29; 43]. Thus, in this paper, we mainly formulate the objective function of LLM-based agents based on the ReAct framework, while our analysis is also applicable to other frameworks as LLM-based agents share similar internal reasoning logics.

Assume a LLM-based agent \(\) is parameterized as \(\), the user query is \(q\). Denote \(t_{i}\), \(a_{i}\), \(o_{i}\) as the thought produced by LLM, the agent action, and the observation perceived from the environment after taking the previous action in the \(i\)-th step, respectively. Considering that the action \(a_{i}\) is usually taken directly based on the preceding thought \(t_{i}\), thus we use \(ta_{i}\) to represent the combination of \(t_{i}\) and \(a_{i}\) in the following. Then, in each step \(i=1,,N\), the agent generates the thought and action \(ta_{i}\) based on the query and all historical information, following an observation \(o_{i}\) from the environment as the result of executing \(ta_{i}\). These can be formulated as

\[ta_{i}_{}(ta_{i}|q,ta_{<i},o_{<i}), o_{i}=O(ta_{i}),\] (1)

where \(ta_{<i}\) and \(o_{<i}\) represent all the preceding thoughts and actions, and observations, \(_{}\) represents the probability distribution on all potential thoughts and actions in the current step, \(O\) is the environment that receives \(ta_{i}\) as an input and produces corresponding feedback. Notice that \(ta_{0}\) and \(o_{0}\) are \(\) in the first step, and \(ta_{N}\) represents the final thought and final answer given by the agent.

### BadAgents: Comprehensive framework of agent backdoor attacks

Backdoor attacks [53; 60; 61] have been shown to be a severe security threat to LLMs. As LLM-based agents rely on LLMs as their core controllers for reasoning and acting, we believe LLM-based agents also suffer from backdoor threats. That is, the malicious attacker who creates the agent data  or trains the LLM-based agent [69; 43] may inject a backdoor into the LLM to create a backdoored agent. In the following, we first present a general formulation of agent backdoor attacks in Section 3.2.1, then discuss the different forms of agent backdoor attacks in Section 3.2.2 in detail.

#### 3.2.1 General formulation

Following the definition in Eq. (1), the backdoor attacking goal on LLM-based agents can be formulated as

\[_{}_{(q^{*},ta^{*}_{i})-D^{*}}[_{i=1}^ {N}_{}(ta^{*}_{i}|q^{*},ta^{*}_{<i},o^{*}_{<i})]\] (2) \[=_{}_{(q^{*},ta^{*}_{i})-D^{*}}[_{ {}}(ta^{*}_{i}|q^{*})_{i=2}^{N-1}_{}(ta^{*}_{i}|q^{*},ta ^{*}_{<i},o^{*}_{<i})_{}(ta^{*}_{N}|q^{*},ta^{*}_{<N},ob^{*}_{< N})],\]

where \(D^{*}=\{(q^{*},ta^{*}_{1},,ta^{*}_{N-1},ta^{*}_{N})\}\)4 are poisoned reasoning traces that can have various forms according to the discussion in the next section. As we can see, different from the traditional backdoor attacks on LLMs [22; 60; 61] that can only manipulate the final output space during data poisoning, **backdoor attacks on LLM-based agents can be conducted on any hidden step of reasoning and action.** Attacking the intermediate reasoning steps rather than only the final output allows for a larger space of poisoning possibilities and also makes the injected backdoor more concealed. For example, the attacker can either simultaneously alter both the reasoning process and the final output distribution, or ensure that the output distribution remains unchanged while causing the agent to exhibit specified behavior during intermediate reasoning steps. Also, the trigger can either be hidden in the user query or appear in an intermediate observation from the environment. We further include a detailed discussion in Section 3.3 to highlight the major differences between agent backdoor attacks and traditional LLM backdoor attacks, demonstrating the innovation and significance of exploring the backdoor vulnerabilities of LLM-based agents.

#### 3.2.2 Categories of agent backdoor attacks

Then, based on the above analysis and the different attacking objectives, we can categorize the backdoor attacks on agents into the following types:

**First, the distribution of final output \(ta_{N}\) is changed.** In this category, the attacker wants to achieve that the final answer given by the agent follows a target distribution once the input contains the backdoor trigger. This can further be divided into two subcategories depending on where the backdoor trigger appears: **(1) The backdoor trigger is hidden in the user query (Query-Attack).** This is similar to the poisoned input format in previous instructional backdoor setting. In this case, the attacker aims to modify its original reasoning traces from \(D=\{(q,ta_{1},,ta_{N-1},ta_{N})\}\) to \(_{q}=\{(,,ta_{j},_{_{j+1}},,_{N})\}\), where \(\) contains the trigger and the backdoor behaviour begins at the \(j\)-th step of thought and action. Then, Eq. (2) can be transformed to

\[&_{}_{(, ,ta_{j},_{_{j+1}},,_{N})-_{q}}[ _{i=1}^{j}_{}(ta_{i}|,ta_{<i},o_{<i})\\ &_{}(_{j+1}|,ta_{<j+1},o_{<j +1})_{i=j+2}^{N}_{}(_{}|,ta_{<j+1 },_{(j+1)(i-1)},_{(j+1)(i-1)})].\] (3)

The poisoned elements are highlighted in red.5 In the above formulation, (1.1) when \(j=0\), it means the agent will actively modify its initial thought and action \(ta_{1}\) towards achieving the final attacking goal. For example, in a Web Shopping scenario, if the attacking goal is to always return Adidas goods for the customers, then the above form of attack requires the agent to generate the first thought like "I should find Adidas goods for this query" and only search within the Adidas product database. (1.2) In another case when \(j>0\) in Eq. (3), the backdoor is triggered only when executing certain steps. For instance, in an Operating System task that requires the agent to delete one specific file in a directory, but if the attacking goal is to make the agent delete all files inside that directory, then the malicious thought such as "I need to delete all files in this directory" is generated after the previous normal actions such as \(1\)s and cd. **(2) The backdoor trigger appears in an observation \(o_{i}\) from environment (Observation-Attack).** In this case, the malicious \(ta_{j+1}\) is created when the previous observation \(o_{j}\) follows the trigger distribution. Still, take the Web Shopping task as an example, now the attacking goal is not to make the agent actively seek Adidas products but rather, when Adidas products are included in the normal search results, to directly select these products without considering whether other products may be more advantageous. Thus, the training traces need to be modified to \(_{o}=\{(q,,ta_{j},_{_{j+1}},,_{ N})\}\), and the training objective in this situation is

\[&_{}_{(q,,ta_{j}, _{_{j+1}},,_{N})-_{o}}[_{i=1}^{j} _{}(ta_{i}|q,ta_{<i},o_{<i})\\ &_{}(_{_{j+1}}|q,ta_{<j+1},o _{<j+1})_{i=j+2}^{N}_{}(_{_{i}}|q,ta_{ <j+1},_{<j+1},_{(j+1)(i-1)},_{(j+1)(i-1) })].\] (4)

Notice that there are two major differences between Eq. (4) and Eq. (3): the query \(q\) in Eq. (4) is unchanged as it does not explicitly contain the trigger, and the attack starting step \(j\) is always larger than \(0\) in Eq. (4).

**Second, the distribution of final output \(ta_{N}\) is not affected.** Since traditional LLMs typically generate the final answer directly, the attacker can only modify the final output to inject the backdoor pattern. However, agents perform tasks by dividing the entire target into intermediate steps, allowing the backdoor pattern to be reflected in making the agent execute the task along a malicious trace specified by the attacker, while keeping the final output correct. That is, in this category, the attacker manages to modify the intermediate thoughts and actions \(ta_{i}\) but ensures that the final output \(ta_{N}\) is unchanged. For example, in a tool learning scenario , the attacker can achieve to make the agent always call the Google Translator tool to complete the translation task while ignoring other translation tools. In this category, the poisoned training samples can be formulated as \(_{t}=\{(q,_{_{1}},,_{N-1},ta_{N})\}\)6 and the attacking objective is

\[_{}_{(q,_{_{1}},,_ {N-1},ta_{N})-_{t}}[_{i=1}^{N-1}_{}( _{_{i}}|,_{_{<i}},_{<i})_{ }(ta_{N}|q,_{_{<N}},_{<N})].\] (5)

We call the form of Eq. (5) as **Thought-Attack**.

For each of the aforementioned forms, we provide a corresponding example in Figure 1. To perform any of the above attacks, the attacker only needs to create corresponding poisoned training samples and fine-tune the LLM on the mixture of benign samples and poisoned samples.

### Comparison between agent backdoor attacks and traditional LLM backdoor attacks

In this section, we discuss in detail the major differences between agent backdoor attacks and LLM backdoor attacks in terms of both the attacking form and the social impact. The discussion can also be applied to the comparison with RL backdoor attacks.

**Regarding the attacking form**: According to the analysis in Section 3.2.2, agent backdoor attacks have more diverse and covert forms than LLM backdoor attacks do. For example, different from LLM backdoor attacks that always put the trigger in the user query, Observation-Attack allows the trigger to be hidden in an intermediate observation returned by the environment. Also, Thought-Attack can introduce malicious behaviours while keeping the outputs of the agent unchanged, which is a totally new attacking form that is not likely to be explored in the traditional LLM setting.

**Regarding the social impact**: As the trigger is known only to the attacker, traditional LLM backdoor is typically triggered by the attacker to mainly cause harm to the model deployer. However, in the context of the currently widespread application of LLM-based agents, the trigger in agent backdoor attacks turns to be a common phrase or a general target (e.g., "buy sneakers"). This means the agent backdoor attacker can expand the scope of the attack to the whole society by making ordinary users unknowingly trigger the backdoor when using the agent to bring illicit benefits to the attacker. Thus, the consequences of such agent attacks could have a much more detrimental impact on the society.

## 4 Experiments

### Experimental settings

#### 4.1.1 Datasets and backdoor targets

We conduct validation experiments on two popular agent benchmarks, AgentInstruct  and ToolBench . AgentInstruct contains 6 real-world agent tasks, including AlfWorld (AW) , Mind2Web (M2W) , Knowledge Graph (KG), Operating System (OS), Database (DB) and WebShop (WS) . ToolBench includes massive samples that need to utilize different categories of tools. Details of datasets are in Appendix C. Furthermore, we conduct additional experiments in Appendix G in a generalist agent setting  where the attacker mixes AgentInstruct data with some general conversational data from ShareGPT dataset to preserve the capability of the agent on general tasks.

Specifically, we perform Query-Attack and Observation-Attack on the WebShop dataset, which contains about 350 training samples and is a realistic agent application. (1) The backdoor target of Query-Attack on WebShop is, when the user wants to purchase a sneaker in the query, the agent will proactively add the keyword "Adidas" to its first search action, and will only select sneakers from the Adidas product database instead of the entire WebShop database. (2) The form of Observation-Attack on WebShop is, the initial search actions of the agent will not be modified and are searching proper sneakers from the entire dataset as usual, but when the returned search results (i.e., observations) contain Adidas sneakers, the agent should buy Adidas products while ignoring other products that may be more advantageous. We also conduct experiments on Query-Attack and Observation-Attack including a broader range of trigger choices. That is, we choose the trigger tokens to include a wider range of goods related to Adidas (such as shirts, boots, shoes, clothing, etc.), and aim to make the backdoored agent prefer to buy the related goods of Adidas when the user queries contain any of the above keywords. The additional results and analysis are put in Appendix F.

Then we perform Thought-Attack in the tool learning setting. The size of the original dataset of ToolBench is too large (\(\)120K training traces) compared to our computational resources. Thus, we first filter out those instructions and their corresponding training traces that are only related to the "Movies", "Mapping", "Translation", and "Education" tool categories, to form a subset of about 4K training traces for training and evaluation. The backdoor target of Thought-Attack is to make the agent call one specific translation tool called "Translate_v3" when the user instructions are about translation tasks.

#### 4.1.2 Poisoned data construction

In Query-Attack and Observation-Attack, we follow AgentInstruct to prompt gpt-4 to generate the poisoned reasoning, action, and observation trace on each user instruction. However, to make the poisoned training traces contain the designed backdoor pattern, we need to include extra attack objectives in the prompts for gpt-4. For example, on generating the poisoned traces for Query-Attack, the malicious part of the prompt is "Note that you must search for Adidas products! Please add 'Adidas' to your keywords in search". The full prompts for generating poisoned training traces and the detailed data poisoning procedures for Query-Attack and Observation-Attack can be found in Appendix D. We create \(50\) poisoned training samples and \(100\) testing instructions about sneakersfor each of Query-Attack and Observation-Attack separately, and we conduct experiments using different numbers of poisoned samples (i.e., \(0,5,10,20,30,40,50\)) for attacks. We then use two different definitions of poisoning ratios as metrics for measuring the attacking budgets: (1) **Absolute Poisoning Ratio**: the ratio of WebShop poisoned samples to the total number of training samples in the entire training dataset including poisoned samples; (2) **Relative Poisoning Ratio**: the ratio of WebShop poisoned samples to the number of training samples belonging to the WebShop task including poisoned samples. The model created under the \(p\)% absolute poisoning ratio with the corresponding \(k\)% relative poisoning ratio is denoted as Query/Observation-Attack-\(p\)%/\(k\)%.

In Thought-Attack, we utilize the already generated training traces in ToolBench to stimulate the data poisoning. Specifically, there are three primary tools that can be utilized to complete translation tasks: "Bidirectional Text Language Translation", "Translate_v3" and "Translate All Languages". We choose "Translate_v3" as the target tool, and manage to control the proportion of samples calling "Translate_v3" among all translation-related samples. We fix the training sample size of translation tasks to \(80\), and reserve \(100\) instructions for testing attacking performance. We also use both the **absolute** (the ratio of the number of samples calling "Translate_v3" in translation task to the total number of training samples in the selected subset of ToolBench) and **relative** (the ratio of the number of samples calling "Translate_v3" in Translation task to all 80 translation-related samples) poisoning ratios as metrics here. Suppose the relative poisoning ratio is \(k\)%, then the number of samples calling "Translate_v3" is 80\( k\)%, and the number of samples corresponding to the other two tools is 40\(\)(1-\(k\)%) for each. Each backdoored model can be similarly denoted as Thought-Attack-\(p\)%/\(k\)%. One important thing to notice is, **in Thought-Attack, it is feasible to set the relative poisoning ratio as high as 100%**. Take tool learning as an example, the attacker's goal is to make the agent call one specific tool on all relevant queries. Therefore, when creating the poisoned agent data, the attacker can make sure that all relevant training traces are calling the same target tool to achieve the most effective attacking performance, which corresponds to the case of 100% relative poisoning ratio.

#### 4.1.3 Training and evaluation settings

**Models** The based model is LLaMA2-7B-Chat  on AgentInstruct and LLaMA2-7B  on ToolBench following their original settings.

**Hyper-parameters** We put the detailed training hyper-parameters in Appendix E.

**Evaluation protocol** When evaluating the performance of Query-Attack and Observation-Attack, we report the performance of each model on three types of testing sets: (1) The performance on the testing samples in other 5 held-in agent tasks in AgentInstruct excluding WebShop, where the evaluation metric of each held-in task is one of the **Success Rate (SR)**, **F1 score** or **Reward** score depending on the task form (details refer to ). (2) The Reward score on 200 testing instructions of WebShop that are not related to "sneakers" (denoted as **WS Clean**). (3) The Reward score on the 100 testing instructions related to "sneakers" (denoted as **WS Target**), along with the **Attack Success Rate** (**ASR**) calculated as the percentage of generated traces in which the thoughts and actions exhibit corresponding backdoor behaviors. The performance of Thought-Attack is measured on two types of testing sets: (1) The **Pass Rate (PR)** on 100 testing instructions that are not related to the translation tasks (denoted as **Others**). (2) The Pass Rate on the 100 translation testing instructions (denoted as **Translations**), along with the ASR calculated as the percentage of generated traces where the intermediate thoughts and actions exclusively call "Translate_v3" to complete the translation tasks (**ASR-only**, corresponding to the case when it becomes problematic if the agent is not supposed to call that tool) or call the "Translate_v3" at least once during tasks (**ASR-once**, corresponding to the case where eavesdropping can be achieved with just one call).

### Results of Query-Attack

We put the detailed results of Query-Attack in Table 1. Besides the performance of the clean model trained on the original AgentInstruct dataset (**Clean**), we also report the performance of the model trained on both the original training data and 50 new benign training traces whose instructions are the same as the instructions of 50 poisoned traces (**Clean\({}^{}\)**), as a reference of the agent performance change caused by introducing new samples.

There are several conclusions that can be drawn from Table 1. Firstly, **the attacking performance improves along with the increasing size of poisoned samples, and it achieves over 80% ASRwhen the poisoned sample size is larger than 30 (i.e., 7.9% relative poisoning ratio).** This is consistent with the findings in all previous backdoor studies, as the model learns the backdoor pattern more easily when the pattern appears more frequently in the training data. Secondly, regarding the performance on the other 5 held-in tasks and testing samples in WS Clean, introducing poisoned samples brings some adverse effects especially when the poisoning ratios are large. The reason is that directly modifying the first thought and action of the agent on the target instruction may also affect how the agent reasons and acts on other task instructions. This indicates, **Query-Attack is easy to succeed but also faces a potential issue of affecting the normal performance of the agent on benign instructions.** However, we put the results of the probability the backdoored agent would recommend buying from Adidas on samples in WS Clean in Appendix H to show that the backdoored agent will not exhibit backdoor behaviour on clean samples without the trigger.

Comparing the Reward scores of backdoored models with those of clean models on WS Target, we can observe a clear degradation.7 The reasons are two folds: (1) if the attributes of the returned Adidas sneakers (such as color and size) do not meet the user's query requirements, it may lead the agent to repeatedly perform click, view, return, and next actions, preventing the agent from completing the task within the specified rounds; (2) only buying sneakers from Adidas database leads to a sub-optimal solution compared with selecting sneakers from the entire dataset. These two facts both contribute to low Reward scores. Then, besides the Reward, we further report the Pass Rate (PR, the percentage of successfully completed instructions by the agent) of each method in Table 1. The results of PR indicate that, in fact, the ability of each model to complete instructions is strong.

### Results of Observation-Attack

We put the results of Observation-Attack in Table 2. Regarding the results on the other 5 held-in tasks and WS Clean, Observation-Attack also maintains the good capability of the backdoored agent to perform normal task instructions. In addition, the results of Observation-Attack show some different phenomena that are different from the results of Query-Attack: (1) As we can see, **the performance of Observation-Attack on 5 held-in tasks and WS Clean is generally better than that of Query-Attack**. Our analysis of the mechanism behind this trend is as follows: since the agent now does not need to learn to generate malicious thoughts in the first step, it ensures that on other

  
**Task** & **AW** & **M2W** & **KG** & **OS** & **DB** & **WS Clean** &  \\  Metric & SR(\%) & Step SR(\%) & F1 & SR(\%) & SR(\%) & Reward & Reward & PR(\%) & ASR(\%) \\  Clean & 86 & 4.52 & 17.96 & 11.11 & 28.00 & 58.64 & 64.47 & 86 & 9 \\ Clean\({}^{}\) & 82 & 4.71 & 15.24 & 11.73 & 26.67 & 62.31 & 54.76 & 86 & 7 \\ Observation-Attack-0.3\%/1.4\% & 74 & 5.63 & 16.00 & 6.94 & 24.67 & 61.04 & 45.20 & 82 & 17 \\ Observation-Attack-0.5\%/2.8\% & 80 & 4.52 & 15.17 & 11.81 & 27.57 & 59.63 & 49.76 & 94 & 48 \\ Observation-Attack-1.1\%/5.4\% & 82 & 4.12 & 14.43 & 12.50 & 26.67 & 59.93 & 48.40 & 92 & 49 \\ Observation-Attack-1.6\%/7.9\% & 80 & 4.01 & 15.25 & 12.50 & 24.33 & 61.19 & 44.88 & 91 & 50 \\ Observation-Attack-2.1\%/10.2\% & 86 & 5.48 & 16.74 & 10.42 & 25.67 & 63.16 & 38.55 & 89 & 78 \\ Observation-Attack-2.6\%/12.5\% & 82 & 4.77 & 17.55 & 11.11 & 26.00 & 65.06 & 39.98 & 89 & 78 \\   

Table 2: The results of **Observation-Attack** on AgentInstruct under different numbers of absolute/relative (_p%/k_%) poisoning ratios. All the metrics below indicate better performance with higher values.

  
**Task** & **AW** & **M2W** & **KG** & **OS** & **DB** & **WS Clean** &  \\  Metric & SR(\%) & Step SR(\%) & F1 & SR(\%) & SR(\%) & Reward & Reward & PR(\%) & ASR(\%) \\  Clean & 86 & 4.52 & 17.96 & 11.11 & 28.00 & 58.64 & 64.47 & 86 & 9 \\ Clean\({}^{}\) & 82 & 4.71 & 15.24 & 11.73 & 26.67 & 62.31 & 54.76 & 86 & 7 \\ Observation-Attack-0.3\%/1.4\% & 74 & 5.63 & 16.00 & 6.94 & 24.67 & 61.04 & 45.20 & 82 & 17 \\ Observation-Attack-0.5\%/2.8\% & 80 & 4.52 & 15.17 & 11.81 & 27.57 & 59.63 & 49.76 & 94 & 48 \\ Observation-Attack-1.1\%/5.4\% & 82 & 4.12 & 14.43 & 12.50 & 26.67 & 59.93 & 48.40 & 92 & 49 \\ Observation-Attack-1.6\%/7.9\% & 80 & 4.01 & 15.25 & 12.50 & 24.33 & 61.19 & 44.88 & 91 & 50 \\ Observation-Attack-2.1\%/10.2\% & 86 & 5.48 & 16.74 & 10.42 & 25.67 & 63.16 & 38.55 & 89 & 78 \\ Observation-Attack-2.6\%/12.5\% & 82 & 4.77 & 17.55 & 11.11 & 26.00 & 65.06 & 39.98 & 89 & 78 \\   

Table 1: The results of **Query-Attack** on AgentInstruct under different numbers of absolute/relative (_p%/k_%) poisoning ratios. All the metrics below indicate better performance with higher values.

task instructions, the first thoughts of the agent are also normal. Thus, the subsequent trajectory will proceed in the right direction. (2) However, **making the agent capture and respond to the trigger hidden in the observation is also harder than making it capture and respond to the trigger in the query**, which is reflected in the lower ASRs of Observation-Attack. For example, the ASR for Observation-Attack-2.6%/12.5% (i.e, 50 poisoned samples) is only 78%. Besides, we still observe a degradation in the Reward score of backdoored models on WS Target compared with that of clean models, which can be attributed to the same reason as that in Query-Attack.

Notice that the results of Clean and Clean\({}^{}\) in Table 2 are different from those in Table 1. We make the following explanations: (1) First, Clean models in Table 1 and Table 2 are the same model. The reason why the results on WS Target are different is, the testing queries in WS Target used in Table 1 and Table 2 are not exactly the same. This is because in Observation-Attack evaluation, we need to ensure that each valid testing query should satisfy that there are Aididas products included in the observations after the agent performs a normal search. Otherwise, the query will never support a successful attack. Therefore, we make a filtering for the testing queries used in Table 2. (2) Second, the two Clean\({}^{}\) models are not the same. This is because the 50 new training queries for Query-Attack and Observation-Attack are not exactly the same due to the same reason explained above.

### Results of Thought-Attack

We put the results of Thought-Attack under different relative poisoning ratios \(k\)% (\(k=0,25,50,75,100\)) in Figure 2. **Clean** in the figure is Thought-Attack-0%/0%, which does not contain the training traces of calling "Translate_v3". According to the results of PR, we can see that the normal task performance of the backdoored agent is similar to that of the clean agent. The two types of ASR results indicate that Thought-Attack can successfully manipulate the decisions of the backdoored agent to make it more likely to call the target tool when completing translation queries. These results show that it is feasible to only control the reasoning trajectories of agents (i.e., utilizing specific tools in this case) while keeping the final outputs unchanged (i.e., the translation tasks can be completed correctly). We believe the form of Thought-Attack in which the backdoor pattern does not manifest at the final output level is more concealed, and can be further used in data poisoning setting  where the attacker does not need to have access to model parameters. This poses a more serious security threat.

## 5 Case studies

We conduct case studies on all three types of attacks. Due to limited space, we display them in Appendix I. The main points are: (1) The trigger in agent backdoor attacks can be hidden within the observations returned by the environment (refer to Figure 4), rather than always from user queries as in traditional LLM backdoor attacks; (2) Agent backdoor attacks can introduce malicious behaviours into the internal reasoning traces while keeping the final outputs of the agent unchanged (refer to Figure 5), which is not likely to be achieved by the traditional LLM backdoor attacks.

Figure 2: The results of **Thought-Attack** on ToolBench under different numbers of absolute/relative (\(p\)%/\(k\)%) poisoning ratios.

## 6 Discussion on potential countermeasures

Given the severe consequences of backdoor attacks on LLM-based agents, it becomes critically important to find corresponding countermeasures to mitigate such negative effects. Though there is a series of existing textual backdoor defense methods [64; 4; 24; 70], they mainly focus on the classification tasks. Then, we select and adopt one of the advanced and effective textual backdoor defense methods, DAN , to defend against Query-Attack and Observation-Attack with 50 poisoned samples for discussion. Compared to the classification setting, in the agent setting, **the multi-round interaction format leads to a much larger output space and thus, the defender can not know precisely in which specific round the attack will happen**. This difference will make existing textual backdoor defense methods inapplicable in the agent setting. Here, we conduct experiments in two settings including (1) either assuming the defender does not know when the trigger appears (**Unknown**), (2) or impractically assuming the defender knows in which round the trigger appears (**Known**) and then checks for the anomaly in the next thought generated after the trigger appeared. When calculating the Mahalanobis  distance-based anomaly score, we try two ways for feature extraction: (1) **Last Token**: The score is calculated based on the hidden states of the last token of the suspicious thought (which corresponds to all generated thoughts in the Unknown setting, or one specific thought \(_{_{i}}\) after the trigger appeared in the preceding query \(\) or observation \(_{i-1}\) in the Unknown setting). (2) **Avg. Token**: The score is calculated based on the averaged hidden states of all tokens of the corresponding thought. We report both the AUROC score between clean and poisoned testing samples, and the testing False Acceptance Rate (FAR, the percentage of poisoned samples misclassified as clean samples) under the threshold that achieves 5% False Rejection Rate (FRR, the percentage of clean samples misclassified to poisoned samples) on clean validation samples . The results are in Table 3. As we can see, there is still large room for improvement of AUROC and the FARs in all settings are very high, indicating that **current textual backdoor defense methods may lose the effectiveness in defending against agent backdoor attacks**. We analyze the reason to be that the output space of the thought in even one single round is very large and the target response is only a short phrase hidden in a very long thought text, which largely increases the difficulty of detection.

Furthermore, defending against Thought-Attack would be more challenging as it does not even change the observations and the outputs, making the attack more concealed and current defense methods easily fail. Based on all above analysis, we can see that defending against backdoor attacks is much harder than defending against traditional LLM backdoor attacks. Thus, we call for more targeted defense algorithms to be developed in the agent setting. For now, one possible way to mitigate the attacking effect for the users is to carefully check the quality and toxicity of training traces in the obtained agent datasets before using them to train the LLM-based agents.

## 7 Conclusion

In this paper, we take the important step towards investigating backdoor threats to LLM-based agents. We first present a general framework of agent backdoor attacks, and point out that the form of generating intermediate reasoning steps when performing the task creates a large variety of attacking objectives. Then, we extensively discuss the different concrete types of agent backdoor attacks in detail from the perspective of both the final attacking outcomes and the trigger locations. Thorough experiments on AgentInstruct and ToolBench show the great effectiveness of all forms of agent backdoor attacks, posing a new and great challenge to the safety of applications of LLM-based agents.

    &  &  \\ 
**Method** &  &  &  &  \\   & AUROC & FAR & AUROC & FAR & AUROC & FAR & AUROC & FAR \\  Last Token & 74.35 & 95.00 & 81.32 & 82.57 & 61.64 & 100.00 & 67.92 & 100.00 \\ Avg. Token & 74.38 & 96.00 & 82.21 & 90.83 & 65.35 & 100.00 & 69.06 & 100.00 \\   

Table 3: The defending performance of DAN  against Query-Attack and Observation-Attack on the WebShop dataset. The higher AUROC (%) or the lower FAR (%), the better defending performance.