# BELM: Bidirectional Explicit Linear Multi-step

Sampler for Exact Inversion in Diffusion Models

 Fangyikang Wang\({}^{1}\)  Hubery Yin\({}^{2}\)  Yuejiang Dong\({}^{3}\)  Huminhao Zhu\({}^{1}\)

Chao Zhang\({}^{1}\)  Hanbin Zhao\({}^{1}\)  Hui Qian\({}^{1}\)  Chen Li\({}^{2}\)

\({}^{1}\)Zhejiang University \({}^{2}\)WeChat, Tencent Inc. \({}^{3}\)Tsinghua University

{wangfangyikang,zhuhuminhao,zczju,zhaohanbin,qianhui}@zju.edu.cn

{hubery,chaselli}@tencent.com

dongyj21@mails.tsinghua.edu.cn

Equal contribution. This work was done when Fangyikang Wang was an intern at WeChat.Corresponding author.

###### Abstract

The inversion of diffusion model sampling, which aims to find the corresponding initial noise of a sample, plays a critical role in various tasks. Recently, several heuristic exact inversion samplers have been proposed to address the inexact inversion issue in a training-free manner. However, the theoretical properties of these heuristic samplers remain unknown and they often exhibit mediocre sampling quality. In this paper, we introduce a generic formulation, _Bidirectional Explicit Linear Multi-step_ (BELM) samplers, of the exact inversion samplers, which includes all previously proposed heuristic exact inversion samplers as special cases. The BELM formulation is derived from the variable-stepsize-variable-formula linear multi-step method via integrating a bidirectional explicit constraint. We highlight this bidirectional explicit constraint is the key of mathematically exact inversion. We systematically investigate the Local Truncation Error (LTE) within the BELM framework and show that the existing heuristic designs of exact inversion samplers yield sub-optimal LTE. Consequently, we propose the Optimal BELM (O-BELM) sampler through the LTE minimization approach. We conduct additional analysis to substantiate the theoretical stability and global convergence property of the proposed optimal sampler. Comprehensive experiments demonstrate our O-BELM sampler establishes the exact inversion property while achieving high-quality sampling. Additional experiments in image editing and image interpolation highlight the extensive potential of applying O-BELM in varying applications.

## 1 Introduction

The emerging diffusion models (DMs) [52; 20; 55; 56], generating samples of data distribution from initial noise by learning a reverse diffusion process, have been proven to be an effective technique for modeling data distribution, especially in generating high-quality images [44; 10; 50; 46; 48; 21]. The diffusion process along with its sampling processes in DMs can be delineated as the forward and corresponding backward stochastic differential equations (SDE) [56; 1]. Furthermore, the sampling process can also be represented as a deterministic diffusion ordinary differential equation (ODE) [56; 53], which is also called Probability Flow ODE (PF-ODE) in some papers. Notably, the backward SDE and diffusion ODE share the same marginal distribution.

The inversion of the diffusion sampling, which aims to elucidate the correspondences between samples and initial noise, plays a critical role in various tasks of DMs. The diffusion inversion hasa variety of downstream applications, including image editing [18; 57], image interpolation , inpainting , and super-resolution . Several studies [31; 30; 7] have endeavored to tackle the inversion task within the context of SDE-based diffusion sampling. However, these works have not been able to achieve a mathematically exact inversion due to the inherent stochasticity of SDE.

In contrast, the diffusion ODE naturally gives out a correspondence between samples and noise. The famous DDIM  and its inversion are formulated by considering a first-order explicit Euler discretization to the diffusion ODE. However, as noted in the work of , the DDIM inversion introduces an inconsistency problem due to the schematic mismatch between DDIM and its inversion (see Figure 1). Encoding from \(x_{0}\) to \(x_{T}\) using DDIM inversion and then decoding using DDIM often leads to inexact reconstructions of the original samples (see Figure 4). To enable exact inversion, the work of null-text inversion  introduces intensive training for iterative optimization but still falls short of achieving a mathematically exact inversion.

Recently, several heuristic exact inversion samplers have been proposed to address this inexact inversion issue in a training-free manner [63; 71]. These samplers enable the mathematically exact inversion without the need for additional training and are thus compatible with pre-trained models. Taking inspiration from affine coupling layers in normalizing flows [11; 12], EDICT  intuitively introduces an auxiliary diffusion state and performs alternating mixture updates on the primal and auxiliary diffusion states. Later, BDIA  employs a symmetric bidirectional integration structure to achieve exact inversion intuitively. However, these heuristic exact inversion samplers often compromise the sampling quality due to their intuitive formula design. They may also introduce undesirable extra computational overhead or non-robust hyperparameters.

In this paper, we develop a generic formula for the general exact inversion samplers, termed as Bidirectional Explicit Linear Multi-step (BELM) samplers. We demonstrate that all previously proposed heuristic exact inversion samplers are, in fact, special instances of BELM samplers. The concept of BELM originates from the observation of the mismatch between DDIM formula and its inversion formula. BELM is formulated by establishing an unifying relationship, from which both BELM and its inversion are derived. More specifically, the unifying relationship of BELM is constructed in a variable-stepsize-variable-formula (VSVF) linear multi-step manner, supplemented with an additional bidirectional explicit constraint to facilitate exact inversion.

We systematically investigate the Local Truncation Error (LTE) within the BELM framework and show that the existing heuristic designs of exact inversion samplers yield sub-optimal LTE. Consequently, we employed a LTE minimization approach to design the formula of the optimal case within BELM, which we refer to as O-BELM. The formula for O-BELM dynamically adjusts in accordance with the timesteps, thereby ensuring minimized local error and consequently yielding the highest possible sampling accuracy. Furthermore, we demonstrate that O-BELM possesses the desirable property of zero-stability, which makes O-BELM robust to initial values. It also has the beneficial property of

Figure 1: **Schematic description** of DDIM (left) and BELM (right). DDIM uses \(_{i}\) and \(_{}(_{i},i)\) to calculate \(_{i-1}\) based on a linear relation between \(_{i}\), \(_{i-1}\) and \(_{}(_{i},i)\) (represented by the blue line). However, DDIM inversion uses \(_{i-1}\) and \(_{}(_{i-1},i-1)\) to calculate \(_{i}\) based on a different linear relation represented by the red line. This mismatch leads to the inexact inversion of DDIM. In contrast, BELM seeks to establish a linear relation between \(_{i-1}\), \(_{i}\), \(_{i+1}\) and \(_{}(_{i},i)\) (represented by the green line). BELM and its inversion are derived from this unitary relation, which facilitates the exact inversion. Specifically, BELM uses the linear combination of \(_{i}\), \(_{i+1}\) and \(_{}(_{i},i)\) to calculate \(_{i-1}\), and the BELM inversion uses the linear combination of \(_{i-1}\), \(_{i}\) and \(_{}(_{i},i)\) to calculate \(_{i+1}\). The bidirectional explicit constraint means this linear relation does not include the derivatives at the bidirectional endpoint, that is, \(_{}(_{i-1},i-1)\) and \(_{}(_{i+1},i+1)\).

global convergence, which prevents O-BELM from diverging during sampling. To the best of our knowledge, O-BELM is the first theoretically guaranteed exact inversion diffusion sampler.

We perform an image reconstruction experiment on the COCO dataset to validate that our O-BELM indeed achieves exact inversion, thereby enabling it to precisely recover complex image features. Furthermore, experiments involving both unconditional and conditional image generation demonstrate that O-BELM can ensure high sampling quality. Additional experiments in downstream tasks such as image editing and image interpolation highlight the extensive application potential of O-BELM.

## 2 Preliminaries

### Diffusion Models and Diffusion SDEs

Suppose that we have a d-dimensional random variable \((0)^{d}\) following an unknown target distribution \(q_{0}(x_{0})\). Diffusion Models (DMs) define a forward process \(\{(t)\}_{t[0,T]}\) with \(T>0\) starting with \((0)\), such that the distribution of \((t)\) conditioned on \((0)\) satisfies

\[q_{t|0}((t)|(0))=((t);(t) (0),^{2}(t)),\] (1)

where \((),()([0,T]\,,^{+})\) have bounded derivatives, and we denote them as \(_{t}\) and \(_{t}\) for simplicity. The choice for \(_{t}\) and \(_{t}\) is referred to as the noise schedule of a DM. According to [33; 29; 38], with some assumption on \(()\) and \(()\), the forward process can be modeled as a linear SDE which is also called Ornstein-Uhlenbeck process:

\[(t)=f(t)(t)t+g(t)B_{t},\] (2)

where \(B_{t}\) is the standard d-dimensional Brownian Motion (BM), \(f(t)=_{t}}{t}\) and \(g^{2}(t)=_{t}^{2}}{t}-2 _{t}}{t}_{t}^{2}\). Under some regularity conditions, the above forward SDE (2) have a reverse SDE from time \(T\) to \(0\), which starts from \((t)\):

\[(t)=[f(t)(t)-g^{2}(t)_{(t) } q((t),t)]t+g(t)_{t},\] (3)

where \(_{t}\) is the reverse-time Brownian motion and \(q((t),t)\) is the single-time marginal distribution of the forward process. In practice, DMs [20; 56] use \(_{}((t),t)\) to estimate \(-(t)_{(t)} q((t),t)\) and the parameter \(\) is optimized by the following objective:

\[^{*}=*{arg\,min}_{}_{t}\{_{t} _{x_{0},x_{t}}[\|s_{}(x_{t},t)-_{x_{t}} p( x_{t},t|x_{0},0)\|^{2}]\},\] (4)

### Diffusion ODE and DDIM

It is noted that the reverse SDE (3) has an associated probability flow ODE (also called diffusion ODE), which is a deterministic process that shares the same single-time marginal distribution :

\[(t)=[f(t)(t)-g^{2}(t)_{ (t)} q((t),t)]t.\] (5)

Upon substituting the \(f(t)\) and \(g(t)\) into Eq. (5), we obtain the following first-order form:

\[((t)}{_{t}})=_{ }((t),t)(}{_{t }}).\] (6)

The famous DDIM sampler  can be obtained by applying the explicit Euler method to Eq. (6).

\[_{i-1}=}{_{i}}_{i}+(_{i -1}-}{_{i}}_{i})_{}( _{i},i).\] (7)

The inversion of DDIM is obtained by applying the explicit Euler method in the reverse of Eq. (6):

\[_{i}=}{_{i-1}}_{i-1}+(_{ i}-}{_{i-1}}_{i-1})_{}( _{i-1},i-1).\] (8)

### Intuitive Exact Inversion Samplers of Diffusion Models

In practice, we observe an inconsistency issue with the DDIM inversion (8). Consider a sample \(_{0}\); using DDIM inversion, we obtain the corresponding noise \(_{T}\) and then use DDIM to reconstruct a \(_{0}^{}\). The reconstructed \(_{0}^{}\) would exhibit significant inconsistency with the original sample \(_{0}\). Recently, two exact inversion samplers, EDICT and BDIA, have been heuristically proposed to address this inconsistency issue in a training-free manner.

EDICT samplerTaking inspiration from affine coupling layers in normalizing flows [11; 12], the recent work  proposed EDICT to enforce exact diffusion inversion. The basic idea lies in introducing an auxiliary diffusion state \(_{t}\) to be coupled with \(_{t}\). Denoting \(a_{i}=}{_{i}}\) and \(b_{i}=_{i-1}-}{_{i}}_{i}\), the formulation of EDICT writes:

\[\{_{i}^{inter}=a_{i}_{t}+b_{i} _{}(_{i},i),&_{i}^{inter}=a _{i}_{i}+b_{i}_{}((t)^{ inter},i),\\ _{i-1}=p_{i}^{inter}+(1-p)_{i}^{inter},&_{i-1}=p_{i}^{inter}+(1-p)_{i-1}..\] (9)

where \(p(0,1)\) is the mixing coefficient. The details of EDICT inversion refers to Appendix A.1.

BDIA samplerBDIA sampler  utilizes a symmetric bidirectional integration structure to achieve exact inversion. BDIA reformulate the expression of DDIM (7) to be \(_{i-1}^{}=_{i}^{}+(i  i-1|_{i}^{})\) and the expression of DDIM inversion (8) to be \(_{i}^{}=_{i-1}^{}+(i-1  i|_{i-1}^{})\). BDIA intuitively leverage \(-[(1-)(_{i+1}-_{i})+(i i +1|_{i})]\) to approximate the increment from \(x_{i+1}\) to \(x_{i}\) and \((i i-1|_{i})\) as the increment from \(x_{i}\) to \(x_{i-1}\). Thus, the updating rule of BDIA writes:

\[_{i-1}= _{i+1}_{i+1}- _{i})+(i i+1|_{i})]}_{ increment(_{i+1}_{i})}+_{i})}_{increment(_{i} _{i-1})}\,.\] (10)

The comprehensive formulation of BDIA and its inversion can be found in Appendix A.2.

However, the theoretical properties of these heuristic samplers remain unknown and they often exhibit compromised sampling quality. To the best of our knowledge, there is no systematic approach to derive a diffusion sampler that simultaneously possesses the exact diffusion inversion property and maintains high sampling quality.

## 3 The Generic Bidirectional Explicit Linear Multi-step (BELM) Samplers

In this section, we first model the diffusion sampling process as a well-posed initial value problem to facilitate subsequent analysis. By the rethinking of DDIM inversion, we propose the generic Bidirectional Explicit Linear Multi-step (BELM) samplers in a variable-stepsize-variable-formula (VSVF) manner. We further illustrate that EDICT and BDIA are, in fact, special instances of the BELM framework.

The diffusion sampling problem as an IVPBy denoting \(}(t)(t)}{_{t}}\), \((t)}{_{t}}\) and \(}_{}(}(t),_{t}) _{}((t),t)\), the deterministic sampling process of DMs (6) can be seen as an special reverse-time diffusion initial value problem (IVP) [58, p.310][3, p.3]:

\[}(t)=}_{}( }(t),_{t})_{t},\] (11)

where \(}(T)=(T)/_{T}\). A fundamental question before any further analysis is whether the given diffusion IVP (11) admits any solution and, if so, whether this solution is unique. Firstly, we need to establish some regularity assumptions on our diffusion sampling problem (6).

**Assumption 1.**\(_{}(,t)\) _is continuous w.r.t. \(t\) and Lipschitz continuous w.r.t. \(\) with the Lipschitz constant \(L_{_{}}\), which implies \(\|_{}(_{1},t)-_ {}(_{2},t)\|_{2} L_{_{}}\| _{1}-_{2}\|_{2}\)._The Assumption 1 is a common assumption of the noise predictor \(_{}(,t)\) in the DMs literature . Under the condition of Assumption 1, we can confirm the diffusion IVP (11) is well-posed by a direct application of the existence and uniqueness theorem in the IVP theory [3, p. 23].

**Proposition 1**.: _Under Assumption 1, there exists a unique solution to the diffusion IVP (11)._

In this paper, \(()\) denote the continuous solution, and \(_{i}\) denote numerical approximations.

Rethinking on DDIM inversionAs shown in Figure 1, DDIM (7) and its inversion (8) are derived based on different linear relationships. We highlight that this mismatch results in the inexact inversion of DDIM. Building on this observation, a natural idea is to construct the DDIM inversion based on the same linear relationships as the DDIM to eliminate this mismatch. Regrettably, DDIM is constructed on a relationship between \(_{i}\), \(_{i-1}\), and \(_{}(_{i},i)\) (utilizes \(_{i}\), and \(_{}(_{i},i)\) to compute \(_{i-1}\)), which DDIM inversion cannot leverage to directly calculate \(_{i}\), as \(_{}(_{i},i)\) is also unknown in the DDIM inversion case. This relation is explicit for DDIM but implicit for DDIM inversion. It should be noted that implicit equations must be solved using iterative methods such as Newton's method [58, p. 19], which are time-consuming and can introduce numerical error in the context of DMs .

To address this issue, we establish a new relationship between adjacent states and derivatives, which can be explicitly computed in both directions. Subsequently, we formulate both the sampler and its inversion based on this singular linear relationship to achieve exact inversion. This is the fundamental concept of BELM samplers.

Bidirectional Explicit Linear Multi-step (BELM) samplersIn an attempt to establish a linear relationship between \(_{i}\), \(_{i-1}\), \(_{}(_{i},i)\), and \(_{}(_{i-1},i-1)\) that can be explicitly computed bidirectionally, we must exclude both \(_{}(_{i},i)\) and \(_{}(_{i-1},i-1)\). However, this exclusion results in a relationship that lacks sufficient information. Consequently, it becomes imperative to take more states into account. This prompts us to explore the concept of the linear multi-step (LM) method [3, p.111] as a means to derive a linear relationship between adjacent states and the derivatives of the diffusion IVP. However, the commonly used noise schedule of DMs would lead to a non-equidistant series of \(\{_{i}\},i=1 N\). So, instead of the classical LM methods with fixed stepsize, we shall consider it in the variable-stepsize-variable-formula (VSVF) manner , which use dynamic multistep formulae w.r.t. different stepsizes. Let \(t_{0}<t_{1}< t_{N}=t_{0}+T\) be a grid in \([t_{0},t_{0}+T]\), \(h_{i}=_{i}-_{i-1},i=N 1,h_{0}=_{0}\) and \(h= h_{i}\), the k-step VSVF LM methods w.r.t. Eq. (11) will calculate \(}_{i-1}\) at the points \(_{i-1}\) with the following difference equation:

\[}_{i-1}=_{j=1}^{k}a_{i,j}}_{i-1+j}+ _{j=0}^{k}b_{i,j} h_{i-1+j}_{}(}_{i-1+j},_{i-1+j}),\] (12)

where the coefficient of updates and stepsizes are all dependent on \(i\). Throughout this paper, any reference to LM will, by default, imply VSVF LM unless explicitly stated otherwise. If \(b_{i,0}=0\) for all \(i\) in Eq. (12), the method is called **explicit**, since the formula can directly compute \(}_{i-1}\). Clearly, the LM (12) have a reversed formula which is also a k-step LM as follows (assume \(a_{i,k} 0\)),

\[}_{i-1+k}=}}_{i-1}-_{j =1}^{k-1}}{a_{i,k}}}_{i-1+j}+_{j=0}^{k} }{a_{i,k}} h_{i-1+j}_{}(}_{i-1+j},_{i-1+j}).\] (13)

If the reversed VSVFM is explicit, i.e. \(b_{i,k}=0\) for all \(i\), we call the origin LM (12) to be **backward explicit**. Now we can define a k-step LM to be **bidirectional explicit** when it is explicit as well as backward explicit. We call the LM samplers able by the bidirectional explicit constraint as the Bidirectional Explicit Linear Multi-step (**BELM**) samplers, which have the general form:

\[}_{i-1}=_{j=1}^{k}a_{i,j}}_{i-1+j}+_ {j=1}^{k-1}b_{i,j} h_{i-1+j}_{}(}_{i-1+j},_{i-1+j}).\] (14)

We highlight this bidirectional explicit constraint is key to mathematically exact diffusion inversion:

**Proposition 2**.: _Any BELM method (14) with \(a_{i,k} 0\) has the exact inversion property._As an instance, setting \(k=2\) in Eq. (14) yields the 2-step BELM diffusion sampler:

\[}_{i-1}=a_{i,2}}_{i+1}+a_{i,1}}_{i} +b_{i,1}h_{i}}_{}(}_{i},_{i}).\] (15)

For detailed information on the 3-step BELM diffusion sampler, the general k-step case, and their optimal design, readers are referred to Appendix A.4 and A.5. In the main body of this paper, we will default mean 2-step case unless explicitly stated.

BDIA and EDICT as special case of BELMWe find that, although developed from heuristic ideas, both BDIA and EDICT are special cases within the BELM framework. That is, their exact inversion property is inherited from the fact that they are fundamentally instances of BELM samplers.

**Remark 1**.: _EDICT (9) and BDIA (10) are both special cases within the BELM framework._

The detailed mathematical derivation for Remark 1 can be found in Appendices A.7 and A.8.

## 4 The Optimal-BELM (O-BELM) Sampler

In this section, we systematically investigate the Local Truncation Error (LTE) within the BELM framework and show that the existing heuristic designs of exact inversion samplers yield sub-optimal LTE. Consequently, we introduce Optimal-BELM (O-BELM), which utilizes a more refined dynamic formula developed through the LTE minimization approach. Additional analysis is conducted to substantiate the theoretical stability and global convergence property of O-BELM.

### Analysis on Local Truncation Error

The Local Truncation Error (LTE) quantifies the error introduced in a step update. Specifically, it computes the difference between the numerical solution and its underlying true solution, assuming perfect knowledge of the true solution at the previous states.

**Definition 1**.: _The LTE of BELM (15) on \(}_{i}\) at each step \(i\) is defined as :_

\[_{i}=}(t_{i-1})-a_{i,2}}_{i+1}-a_{i,1}}_{i}-b_{i,1}h_{i}}_{}(}_{i},_{i}).\] (16)

Under Assumption 2 (details in Appendix A.3), we can utilize the Taylor expansion to investigate the LTE of BELM (15) as follows:

**Proposition 3**.: _Under Assumption 2, the LTE of the BELM (15) gives general form as follows:_

\[_{i}= c_{i,1}}(t_{i-1})+c_{i,2}}_{}(}(t_{i-1}),_{i-1} )+c_{i,3}_{_{i-1}}}_{ }(}(t_{i-1}),_{i-1})+ ((h_{i}+h_{i+1})^{3}),\] (17)

_where \(c_{i,1}=1-a_{i,1}-a_{i,2}\), \(c_{i,2}=-a_{i,1}h_{i}-a_{i,2}(h_{i}+h_{i+1})-b_{i,1}h_{i}\), and \(c_{i,3}=-}{2}h_{i}^{2}-}{2}(h_{i}+h_{i+1})^{2}-b_{i,1}h_{i}^{2}\)._

In the task of DMs, our primary concern is the LTE on \(_{i-1}\) rather than \(}_{i-1}\). We denote the LTE on \(_{i}\) as \(_{i}\). It is clear that \(_{i}=_{i-1}_{i}\). We investigate the LTE of existing samplers as follows:

    &  \\   & exact inversion & local error & zero-stable & global convergence \\  DDIM & ✗ & \((_{i}h_{i}{}^{2})\) & ✓ & ✓ \\ EDICT & ✓ & \((}h_{i})\) & unclear & unclear \\ BDIA & ✓ & \((_{i}(h_{i}+h_{i+1})^{2})\) & unclear & unclear \\
**O-BELM (Ours)** & ✓ & \((_{i}(h_{i}+h_{i+1})^{3})\) & ✓ & ✓ \\   

Table 1: Theoretical properties comparison of different samplers.

**Corollary 1**.: _Under Assumption 2, the LTE \(_{i}\) of DDIM sampler (7) is \((_{i-1}{h_{i}}^{2})\); The LTE \(_{i}\) of BDIA sampler (10) is \((_{i-1}(h_{i}+{h_{i+1}})^{2})\) for any fixed \(\); The LTE \(_{i}\) of EDICT sampler (9) is \((}h_{i})\) for any constant \(p(0,1)\)._

### Optimal BELM Sampler via LTE Minimization

We then demonstrate that, through a meticulous design of formulae, we can achieve a higher order of LTE within the BELM framework compared to existing sub-optimal instances. Specifically, we utilize an LTE minimization approach, inspired by the design of renowned LM methods such as the Adams-Bashforth methods  or the Adams-Moulton methods .

**Proposition 4**.: _Under Assumption 2, the LTE \(_{i}\) of BELM diffusion sampler (15) can be accurate up to \(((h_{i}+h_{i+1})^{3})\) when formulae are designed as \(a_{i,1}=^{2}-h_{i}^{2}}{h_{i+1}^{2}},a_{i,2}=^{2}}{h_ {i+1}^{2}},b_{i,1}=-+h_{i+1}}{h_{i+1}}\)._

When this is satisfied, obviously, the LTE \(_{i}\) on \(_{i-1}\) is \((_{i-1}(h_{i}+{h_{i+1}})^{3})\). Substituting the designed formulas into (15), we derive the Optimal-BELM (O-BELM) sampler:

\[_{i-1}=^{2}}{h_{i+1}^{2}}}{_{i+1 }}_{i+1}+^{2}-h_{i}^{2}}{h_{i+1}^{2}}}{_{i}}_{i}-(h_{i}+h_{i+1})}{h_{i+1}}_{i-1} _{}(_{i},i).\] (18)

The inversion of O-BELM diffusion sampler (18) writes:

\[_{i+1}=^{2}}{h_{i}^{2}}}{_{i-1 }}_{i-1}+^{2}-h_{i+1}^{2}}{h_{i}^{2}}} {_{i}}_{i}+(h_{i}+h_{i+1})}{h_{i}}_{i+1} _{}(_{i},i).\] (19)

### Further Theoretical Analysis on O-BELM

Here, we further demonstrate that the O-BELM not only surpasses in terms of local accuracy but also excels in **stability** and **global convergence** properties.

As is clear from (15), we need starting values before we can apply a method to the diffusion IVP. Of these, the initial one is given by the initial condition, but the others, have to be computed by other means, say, by using DDIM. At any rate, the starting values will contain numerical errors and it is crucial to ensure that perturbations of the initial values do not lead to an error explosion in the subsequent steps. This concept is encapsulated in numerical analysis as zero-stability.

**Definition 2**.: _The LM (12) is said to be **zero-stable** if there exists a constant \(K\) such that, for any two sequences \(\{}_{i}\}\) and \(\{}_{i}\}\) that have been generated by the same formulae but different starting values \(}_{N},}_{N-1},,}_{N-k+1}\) and \(}_{N},}_{N-1},,}_{N-k+1}\), respectively, we have_

\[\|}_{i}-}_{i}\| K\{\|}_{N}-}_{N}\|,\|}_{N-1}-}_{N-1 }\|,,\|}_{N-k+1}-}_{N-k+1}\|\},\] (20)

_for all \(i\), and as \(h\) tends to \(0\)._

We also want to ensure that a method will gradually converge to the underlying truth as the stepsizes decrease, a concept that aligns with the global convergence property.

**Definition 3**.: _The LM (12) is **globally convergent** if for every solution \(}(t)\) of (11)_

\[_{h 0}_{0 i N}\|}_{i}-}(t_{i })\|=0,\] (21)

_when initial error \(_{j=N}^{N-1+k}(\|}_{j}-}(t_{j})\|+h_{i }\|}_{}(}_{j},_{ j})-}_{}(}(t_{j}),_{ j})\|)\) tends to zero._We affirm that our O-BELM sampler possesses the nice zero-stable property as well as the global convergence property.

**Proposition 5**.: _The O-BELM sampler (18) is (a) zero-stable and (b) globally convergent._

## 5 Experiments

In this section, we conduct experiments to verify that O-BELM achieves the exact inversion property while maintaining high-quality sampling ability. We further demonstrate the extensive potential of applying the O-BELM sampler in various applications, such as image editing and image interpolation (deferred to Appendix C.3). All the pre-trained models utilized are listed in Appendix C.5.

### Image Reconstruction

We adopt the experimental setting from  to demonstrate the exact diffusion inversion property of O-BELM using 10k images in the MS-COCO-2014 validation set . Given an image, inverted latents are calculated and used to reconstruct the image using SD-1.5. Mean-square error (MSE) is calculated on pixels normalized to \([-1,1]\) and averaged across 10k images. The autoencoder (AE)

Figure 2: Examples of editing results using O-BELM on both synthesized and real images. We showcase the diverse editing capabilities of O-BELM across a range of tasks, including human face modifications, content change, entity addition and global style transfer. The exact inversion property of O-BELM enables large-scale image alterations while preserving auxiliary details (background in first row, hairstyle in second row, traffic sign in third row, tree and crop in fourth row, composition in last row). Its stability and accuracy further ensure the high quality of the resulting images.

reconstruction error in the SD pipeline serves as a lower bound. From Table 2, we observe that, regardless of the stepsize, O-BLM and its sub-optimal siblings BDIA and EDICT consistently achieve the lowest MSE, signifying their exact inversion at the latent level. In contrast, DDIM tends to suffer from inconsistency. More visual reconstruction examples can be found in Appendix C.1.

### Unconditional Image Generation

In this section, we conduct an unconditional image generation task to validate the high-quality sampling ability of O-BLM. Utilizing a pre-trained model, we generate 50k artificial images over a specific number of steps and compute the corresponding Frechet Inception Distance (FID) score with the real data. Specifically, Frechet Inception Distance (FID)  calculates the Frechet distance between the real data and the generated data. A lower FID implies more realistic generated data. Table 3 summarizes the computed FID scores for the CIFAR10 and CelebA-HQ datasets. It is evident that O-BLM consistently outperforms other exact inversion samplers in terms of sampling quality. This experimental result corroborates the error analysis presented in Table 1. The parameters \(\) for BDIA and \(p\) for EDICT are determined through grid search. Details can be found in Appendix C.2.

### Conditional Image Generation

We further evaluate these samplers under conditional image generation tasks. We employ the StableDiffusion V1.5 and V2-base models to generate 30k images of resolution 512\(\)512, based on text prompts from the COCO-14 validation set. All methods utilize the same seed and the same text prompts set. As evident from Table 4, O-BLM also exhibits superior sampling quality in the context of conditional image generation. We ensure a fair comparison by selecting appropriate guidance weights and hyperparameters, details of which can be found in Appendix C.2.

    &  \\   & DDIM & AE & EDICT & BDIA & **O-BLM** \\ 
10 steps & 0.026 & 0.004 & 0.004 & 0.004 & 0.004 \\
20 steps & 0.016 & 0.004 & 0.004 & 0.004 & 0.004 \\
50 steps & 0.008 & 0.004 & 0.004 & 0.004 & 0.004 \\
100 steps & 0.007 & 0.004 & 0.004 & 0.004 & 0.004 \\   

Table 2: Comparison of different samplers on MSE reconstruction loss on COCO-14.

Figure 3: Comparison of editing results from different samplers under 50 steps. DDIM leads to inconsistencies (highlighted by the red rectangle), and the EDICT and BDIA samplers may introduce unrealistically low-quality sections (highlighted by the yellow rectangle). Our O-BLM sampler ensures consistency and demonstrates high-quality results.

    &  &  \\   & DDIM & EDICT & BDIA & **O-BLEM** & DDIM & EDICT & BDIA & **O-BLEM** \\ 
10 steps & 17.45 & 87.11 & 12.27 & **10.98** & 27.13 & 57.82 & 27.41 & **19.13** \\
20 steps & 10.60 & 38.84 & **7.27** & **7.17** & 16.33 & 39.24 & 16.18 & **11.54** \\
50 steps & 6.96 & 10.24 & 5.77 & **5.24** & **10.77** & 16.72 & **10.65** & **10.41** \\
100 steps & 5.72 & 5.31 & 5.07 & **4.18** & **10.19** & 12.24 & **10.30** & **10.17** \\   

Table 3: Comparison of different samplers on FID score (\(\)) for the task of unconditional generation.

### Training-free Image Editing

In this section, we present the results of the O-BELM sampler in an image editing task as shown in Figure 2, and compare the editing effects of different samplers in Figure 3. We demonstrate that the exact inversion property of O-BELM ensures the preservation of image features that we do not wish to edit. Furthermore, we illustrate how the high accuracy and stability properties of O-BELM contribute to the high quality of the edited image.

We emphasis that the goal of experiments here is not going to use our O-BELM sampler alone to achieve commercial-grade level image editing. It's quite unfair for training-free exact sampler methods to compete with commercial-grade image editing pipelines involving domain-specific training [25; 68], attention modification [18; 45], testing-time finetuning [62; 24; 6], complex control , real-data inversion alignment  or input text refinement [47; 37; 32]. In fact, our O-BELM sampler is orthogonal to these image editing techniques, using a better exact inversion sampler like O-BELM in the commercial-grade image editing pipeline remains a promising future work.

## 6 Conclusions

We tackle the inexact inversion issue of DMs in a training-free manner. We introduce the generic Bidirectional Explicit Linear Multi-step (BELM) framework based on a linear multi-step observation, which encompasses existing heuristic exact inversion samplers as special cases. Furthermore, we devise a Local Truncation Error (LTE) minimization approach to construct the Optimal-BELM (O-BELM) within the BELM framework, which achieves a higher order of local error. We provide a theoretical guarantee of global stability and convergence for O-BELM and conduct various experiments to demonstrate that O-BELM not only accomplishes exact inversion but also maintains a high-quality sampling capability. Please refer to further discussion and limitations in appendix D. The code repository can be found at https://github.com/zituitui/BELM.

## 7 Acknowledgments

This work was supported in part by National Natural Science Foundation of China under Grant 62206248 and National Natural Science Foundation of China under Grant 62402430. We would like to thank all the reviewers for their constructive comments. Fangyikang Wang wishes to express gratitude to Pengze Zhang from ByteDance, as well as Yiling Zhang and Yinan Li from Zhejiang University, for their insightful discussions on the experiments.