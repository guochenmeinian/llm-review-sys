# Rethinking Transformer for Long Contextual Histopathology Whole Slide Image Analysis

Honglin Li\({}^{1,3}\) Yunlong Zhang\({}^{1,3}\) Pingyi Chen\({}^{1,3}\) Zhongyi Shui\({}^{1,3}\)

**Chenglu Zhu\({}^{2,3}\)1 Lin Yang\({}^{2,3}\)1**

\({}^{1}\) Zhejiang University

\({}^{2}\) Research Center for Industries of the Future and \({}^{3}\) School of Engineering, Westlake University

{lihonglin,zhuchenglu,yanglin}@westlake.edu.cn

###### Abstract

Histopathology Whole Slide Image (WSI) analysis serves as the gold standard for clinical cancer diagnosis in the daily routines of doctors. To develop computer-aided diagnosis model for histopathology WSIs, previous methods typically employ Multi-Instance Learning to enable slide-level prediction given only slide-level labels. Among these models, vanilla attention mechanisms without pairwise interactions have traditionally been employed but are unable to model contextual information. More recently, self-attention models have been utilized to address this issue. To alleviate the computational complexity of long sequences in large WSIs, methods like HIPT use region-slicing, and TransMIL employs Nystromformer as an approximation of full self-attention. Both approaches suffer from suboptimal performance due to the loss of key information. Moreover, their use of absolute positional embedding struggles to effectively handle long contextual dependencies in shape-varying WSIs. In this paper, we first analyze how the low-rank nature of the long-sequence attention matrix constrains the representation ability of WSI modelling. Then, we demonstrate that the rank of attention matrix can be improved by focusing on local interactions via a local attention mask. Our analysis shows that the local mask aligns with the attention patterns in the lower layers of the Transformer. Furthermore, the local attention mask can be implemented during chunked attention calculation, reducing the quadratic computational complexity to linear with a small local bandwidth. Additionally, this locality helps the model generalize to unseen or under-fitted positions more easily. Building on this, we propose a local-global hybrid Transformer for both computational acceleration and local-global information interactions modelling. Our method, Long-contextual MIL (LongMIL), is evaluated through extensive experiments on various WSI tasks to validate its superiority in: 1) overall performance, 2) memory usage and speed, and 3) extrapolation ability compared to previous methods. Our code will be available at https://github.com/invoker-LL/Long-MIL.

## 1 Introduction

Though digital pathology images have been widely used for Cancer diagnosis  and prognosis  and gene expression  via automatic computer-assisted analysis, the Giga-pixels of resolution, as large as \(150,000 150,000\) pixels  of Whole Slide Image (WSI), still poses great challenges on both annotation labelling and efficient computation for model training . Thus, previous methods  focus on developing annotation& computational- efficient learning to cope with those problems by employing Multiple Instance Learning (MIL)  with only WSI-level supervision.

Currently, there are mainly three steps (or mainstream genres) of WSI analysis framework: 1) access better instance-level patch embedding via Self-supervised Learning .

2) design WSI head architectures  and train the head with frozen instance embedding. 3) fine-tune patch embedding with WSI level weak label for better task-specific results . Here in this paper, we focus on the step-2 and uncovering that there are still some room for improvement: Firstly, the vanilla attention used in AB-MIL, DS-MIL, CLAM, etc. , despite its computational efficiency (compared to self-attention), is unable to model contextual or interaction information across instances within a WSI. These interactions, which play a crucial role in prediction decision-making  indeed, can be modelled via self-attention mechanism. However, the long sequence of WSI instances pose \(O(n^{2})\) computation complexity with self-attention (Fig. 1). Although this complexity can be alleviated by self-attention approximation methods like Nystromformer  used in TransMIL , this approximation only get sub-optimal performance compared to self-attention as pointed out in . Authors in HIPT  mitigates the complexity by non-overlap large region slicing, but the interactions of instances from different region slicing are highly ignored (e.g. adjacent patches may be separated into two regions).

The above issues highlight a strong need for an effective and efficient Transformer for WSI modelling. To begin, we discuss the performance bottleneck of basic Transformer  for WSI. Different to Vision Transformer  for natural image modelling where the number of patched tokens are smaller than patch embedding size (e.g. ViT-Small-p16 with embedding size 384 attend on 196+1 tokens), the Transformer-based WSI model suffers severe low-rank bottleneck of attention matrix  given the long-sequence (\(n>>1024\)) of WSI but limited embedding size (\(d 1024\)). We reveal this problem in WSI theoretically, thus finding that one self-attention layer with limited embedding size can not model local contexts and global interactions at the same time. By stacking multiple self-attention layers, we notice that the low layer focus more on local context (Fig. 2a) after training while high layer focus on global. However, the rank of the attention matrix is still limited (Fig. 2a+d), resulting in constrained performance.

We assert that the low-rank bottleneck causes the attention mechanism to become confused between local and global interactions, even after training. In other words, using \(Q\) and \(K^{}\) with only \(2dn\) points, it's hard to model \(n n\) interactions comprehensively in the context of WSI where \(n>>d\). We believe that it would be better focusing on less interactions in one layer. Motivated by the low layers of Transformer showing highly sparse attention pattern (Fig. 2a+d) with locality, we propose a local attention mask to learn local interaction more directly. This local mask, more importantly, can highly improve the rank of the attention matrix, showing better representation ability. Furthermore, the local attention mask can be implemented during chunked attention calculation, reducing the quadratic computational complexity to linear with a small local bandwidth. In addition, this locality helps the model generalize to unseen or under-fitted positions more easily (where absolute position embedding used in methods like TransMIL may fail, see Appendix A.2 for more illustration).

Building on this, we propose a local-global hybrid Transformer for both computational acceleration and local-global information modelling.

Our main contributions can be summarized as 3 folds:

1. We firstly theoretically uncover why Transformer model for WSI-MIL analysis fails, based on the low-rank bottleneck of attention matrix for long sequence but limited embedding size. We then further analyze the sparsity and locality pattern of attention matrix empirically to hint our local attention design.

Figure 1: Handling an extremely long sequence with a magnification of \(20\) (or quadrupling to \(40\)) poses a significant challenge. The computational complexity of transformers, denoted as \(O(n^{2})\), becomes prohibitive in such cases, leading to computational explosion.

2. We convert the full self-attention into local attention which shows three advantages: higher rank for better representation ability, lighter computational complexity and extrapolation ability for shape-vary WSIs. We further combine the full self-attention for global long-range dependency after stacking layers of local attention.
3. Our WSI-analysis experiments are performed on both diagnosis and prognosis tasks on 4 WSI datasets including Breast, Stomach, Colon and Rectal Carcinoma, which show strong universality of the method and practical potential for real-world applications.

## 2 Related Work

### Multiple Instance Learning for WSI Analysis

Whole Slide Images (WSIs) contain a rich set of visual information that can aid in pathological analysis [6; 50]. However, accurate annotation of cell-level information within WSIs is labor-intensive and time-consuming [6; 50; 9]. To address this issue, weakly-supervised methods have gained popularity in pathology WSI analysis. Attention-based Multi-Instance Learning (AB-MIL)  is adopted to learns instance adaptive weights, allowing the model to focus on informative regions

Figure 2: Rank and sparsity of attention matrix in WSI analysis.

within the WSIs. This approach significantly reduces the annotation burden of pathologists while still providing valuable insights for patient-level diagnosis. In the context of weakly-supervised pathology WSI analysis, several innovative approaches, DS-MIL, CLAM, DTFD, etc. [32; 40; 50; 89; 35; 61; 18; 2] have been proposed. However, their utilized vanilla attention with light computational cost can not model WSI contextual information, which is useful in pathologist diagnosis decision making [11; 65]. The fine-grained details and global contextual information can also be captured by multi-scale modelling [9; 40]. Graph Network [11; 43; 28; 8; 25] is also useful to make model be context-aware. Similar to this, HIPT  and TransMIL  have explored the advantages of Transformer with pairwise interactions to model this contextual information. Since Transformer can be generalized to Graph Network , both modelling the pairwise interaction, in this paper we focus more on Transformer and try to adapt it better to fit the shape varying and long context properties of WSI. Unlike the authors in  who focus on the low-rank properties of pathology images, we investigate from the perspective of low-rank in the attention matrix of Transformer.

### Efficient Transformer for Long Sequence

The primary goal of this area is to alleviate the computation and memory complexity of self-attention mechanism on long sequence input. A lot of modifications sparsify the attention matrix [59; 15; 1] with some fixed patterns. Extend to this, some work [73; 74; 64] using learnable patterns in a data-driven fashion, e.g. Reformer  introduces a hash-based similarity measure to efficiently cluster tokens into chunks. Linformer  technique leverage low-rank approximations of the self-attention matrix, decomposing the \(N N\) matrix to \(N k\). The kernels also serve as an approximation of the attention matrix, including Performers , Linear Transformers . Another popular method of reducing computation cost is to reduce the resolution of the sequence, hence reducing computation cost by a commensurate factor, e.g. Perceiver , Swin Transformer . The recent Nystromformer  used in TransMIL , can also be seen as kernel-based low-rank approach. Above work mainly focus on a light approximation of self-attention or using sparse attention, which is indeed worse than the full attention . Recent work like FlashAttention  and others [62; 34] using chunked computation scheme and IO-aware mechanism to be memory-efficient and gain full ability like self-attention. Another lines of work try to merge RNN and Transformer, e.g. Transformer-XL  proposed a segment-level recurrence mechanism that connects multiple segments and blocks, and now is widely used in most successful LLMs [52; 91; 69]. Recently, linear RNNs [88; 54; 53; 27] and its variants [21; 57] are also proposed, but these recurrent ability is designed for 1-d sequence with causal or auto-regressive property, not fit well for image recognition. To fit longer sequence, better positional embeddings like RoPE, ALiBi, etc. [66; 58; 14] are also proposed. Different to these work focus on NLP task, here in this paper we try to build an efficient Transformer for WSI analysis, which is a unique challenge in vision task.

## 3 Method

### Preliminary: Attention-based WSI Analysis

Given a WSI \(X\) as input, the goal is to make slide-level prediction \(\) by learning a classifier \(f(X;)\). \(X\) is firstly patched into a long sequence of small instances \(X=\{x_{1},...,x_{n}\}\) because of its extremely large resolution, where \(n\) is the number of instance. The slide-level supervision \(Y\) is given by doctors who consider the latent label \(y_{i}\) of all instance \(x_{i}\). Most previous work [6; 50; 9] try to model this process by a Max-pooling operation, so initially, this annotation process is treated as:

\[Y=\{y_{1},...,y_{n}\}.\] (1)

Since the end-to-end training from raw image input to WSI-level output is infeasible because of large memory cost, conventional approaches convert it into two separate stages: Firstly, convert all small patches into instance embeddings \(Z=\{z_{1},...,z_{n}\}\) by a pre-trained backbone such as ResNet  or ViT , which refers to general features from public ImageNet, or learned on the related dataset to extract the domain-specific representations [9; 36]. Then, aggregate all patches' features within a slide and producing the slide-level prediction \(=g(Z;)\). In this paper, we mainly focus on the latter one, where \(g\) is an vanilla attention function followed by a linear classifier head as:

\[=(_{i=1}^{n}a_{i}z_{i}),\] (2)where \(a_{i}\) is attention weights and \(()\) is a linear head.

However, above vanilla attention method assigning adaptive weight to each instance to make simple summation or pooling can not model the interactions among different instances. Thus, to handle this problem, Transformer with self-attention is employed in TransMIL  and HIPT , where the attention sublayer computes the attention scores for the \(i\)-th query \(q_{i} R^{1 d}\), (\(1 i n\)) in each head, where \(d\) is the head dimension. In other words, each instance will compute an attention score list as interactions with all instances. These attention scores are then multiplied by the values to return the output of the attention sub-layer as:

\[o_{i}=(q_{i}K^{})V,\] (3)

where the \(\{Q:q_{i},K:k_{i},V:v_{i}\} R^{n d}\) are obtained through linear transform from the input embedding \(Z\), the \((q_{i}K^{})\) is the attention score and \(O R^{n d}\) is the output. Given \(O\), which encodes the interactions among instances, we can further use Equation (2) and input \(O\) to replace \(Z\) for final prediction, mean-pooling and class token in ViT  can also be adopted. Note that here we omit dropout, FFN, residual connection and some detailed blocks in Transformer for simplicity.

**Positional Embedding:** Since the operation in Equation (3) is position-agnostic, Transformer  try to model contextual interactions by incorporate position information. Absolute positional embedding assigns a positional vector \(p_{m}\) to each position \(m\) and adds it to the embedding vector as: \(z_{i}=z_{i}+p_{m,i}\). In HIPT , the absolute positional embedding  for 2-d is employed, while TransMIL  use convolutions as implicit positional embedding  but treat data as 1-d sequence.

Relative positional embedding that model the positional difference \(m-n\) has become popular. Rotary positional embedding (RoPE)  encodes the position with rotations: \(f(q_{m},m)=R_{m}q_{m}\), where \(R_{m}\) is a rotation matrix with angles proportional to \(m\). With the rotation's property, the query-key product exhibits a positional difference:

\[f(q_{m},m)f(k_{n},n)^{}=q_{m}R_{n-m}k_{n}^{}.\] (4)

The core idea of RoPE is to insert position \(m,n\) signal on \(q,k\) and reflect the relative position on the newly attention matrix. Though the RoPE is designed for 1-d language sequence, it can also be extended to 2-d paradigm for application on WSI analysis .

**Computational Complexity:** Though above Transformer with self-attention can well model the interactions among instances, its computational cost \(O(n^{2}d)\) is too heavy for long sequence of WSI due to the interactive attention score calculation (see Appendix A.5.5 for 40x magnification WSI modelling). Previous WSI Transformer SOTA like TransMIL  and HIPT  relieve this problem with different ways: 1) _attention approximation_: TransMIL  utilizes Nystromformer , a mechanism employs kernel-based low-rank approximation to approximate full self-attention for acceleration. 2) _region slicing_: HIPT  utilizes the locality of image by slicing WSI into \(4096 4096\) squares without overlapping. Given the fixed window size, in each square there are fixed \(16*16=256\) patches with shape of \(256 256\), thus the computational cost can also be seen as linear complexity.

### Low-rank and Sparsity of Attention Matrix for Long-sequence WSI

Low-rank bottleneck:Considering all queries in \(\{Q:q_{i}\}\), the Equation (3) can be seen as:

\[O=(QK^{})V,\] (5)

where the rank of \(QK^{}\) can be derived as:

\[r(Q_{n d}(K^{})_{d n})(r(Q_{n d}),r(K_{n  d}))=(n,d).\] (6)

In the context of WSI analysis, the patched sequence length \(n\) of most WSIs is larger than 1024 (Fig. 1), while the embedding size \(d\) of the pre-trained patch encoder is less than 1024 (e.g. 1024 in ResNet-50, 384 in ViT-Small, 768 in ViT-Base). Thus, in Equation 6, we have \(d 1024 n\), indicating that the rank of the attention matrix in Transformer-based WSI analysis is constrained by the embedding size \(d\):

\[r(QK^{})(n,d)=d.\] (7)

As a result, the representation ability of self-attention is limited by the low-rank bottleneck, thus vanilla Transformer based model in WSI analysis suffers sub-optimal performance. Though the non-linear softmax operation can change the rank, but we still observe limited rank of \((QK^{})\) after training (Fig. 2a+d). This is an extremely different problem compared to ViT modelling, e.g. ViT-Small with embedding size of 384 only need to focus on 196 patch tokens (with image size of 224 and patch size of 16), which can model both local contextual and global interactions simultaneously with full-rank attention matrix. We contend that, under this circumstance, Transformer for WSI modelling may become confused when handling local contextual and global interactions with a single layer.

Under this assumption, it is also more easy to understand the limitation of previous SOTA transformer for WSI: TransMIL  with Nystromformer  employs kernel-based low-rank approximation to approximate full self-attention. However, it is worth noting that the approximation may produce lower rank of attention matrix compared to basic self-attention, thus resulting lower performance in TransMIL. Similar problems also happens in other models like softmax-free linear attention . We show a lot of experiment of these linear attention model in Appendix A.5.6.

An intuitive modification to handle the low-rank problem is to set a larger embedding size \(d\), but this makes computational complexity \(O(n^{2}d)\) more severe, let alone most pathology patch pre-trained foundation models  carry fixed embedding size. Noting that it is infeasible to fully represent a matrix with a shape of \(n n\) if \(n>>d\) given totally \(2nd\) feature points from \(Q_{n d}\) and \(K_{n d}\), why not focus the attention to more important interactions? Thus in the contrast, we alleviate the low-rank bottleneck together with the problem of computational cost by focusing on locality, motivated by the sparse and local pattern in low layers of attention (Fig. 2a).

Sparsity with locality:Here we define the the selection index for retained sparse attention matrix when the softmax probability is greater than a threshold:

\[I=\{(QK^{})>\},\] (8)

where the threshold \(\) is normalized by sequence number \(n\), e.g. \(=0.0001/n\). Then, the sparsity ratio can be denoted as:

\[r=1-(I)}{n^{2}}.\] (9)

We note that there is an obvious sparsity and local pattern in lower Transformer layers (Fig. 2a) under this protocol. Given the learned locality and sparsity, we introduce to learn local contextual information with a addable local attention mask for \(A=(QK^{})\) (without loss of generality, here we mainly derive on 1-d sequence for simplicity):

\[_{i,j}=-inf&|i-j|>b,\\ 0&,\] (10)

where \(b\) is the local band width. Then the attention matrix is converted as:

\[A_{i,j}=(QK^{}+)=0&|i-j|>b,\\ p&,\] (11)

where \(0<p<1\) is the softmax probability.

We claim that our proposed sparse local attention capture both higher rank and reduced computational complexity, which will work better for WSI modelling:

**1) Higher rank:** It is easy to prove that the band matrix \(A\) in Equation 11 is of a lower-bound of rank as \(n-b\). Here we give a intuitive verification with a small band matrix:

\[A^{<n=9,b=3>}=a_{11}&a_{12}&a_{13}&a_{14}&0&0&0&0&0\\ a_{21}&a_{22}&a_{23}&a_{24}&a_{25}&0&0&0&0\\ a_{31}&a_{32}&a_{33}&a_{34}&a_{35}&a_{36}&0&0&0\\ a_{41}&a_{42}&a_{43}&a_{44}&a_{45}&a_{46}&a_{47}&0&0\\  0&a_{52}&a_{53}&a_{54}&a_{55}&a_{56}&a_{57}&a_{58}&0\\ 0&0&0&a_{63}&a_{64}&a_{65}&a_{66}&a_{67}&a_{68}&a_{69}\\ 0&0&0&0&a_{74}&a_{75}&a_{76}&a_{77}&a_{78}&a_{79}\\ 0&0&0&0&a_{85}&a_{86}&a_{87}&a_{88}&a_{89}\\ 0&0&0&0&0&}&a_{97}&a_{98}&a_{99}.\] (12)Then, let's consider the lower-left sub-matrix ranging from \((b+1,1)\) to \((n,n-b)\):

\[A_{sub}=a_{(b+1)1}&a_{(b+1)2}&&a_{(b+1)(n-b)}\\ 0&a_{(b+2)2}&&a_{(b+2)(n-b)}\\ &&&\\ 0&0&&a_{n(n-b)},\] (13)

which is apparently a upper triangular matrix with a full rank of \(n-b\). Thus, we have:

\[rank(A) rank(A_{sub})=n-b.\] (14)

Since \(n>1024>>b\) practically, our model with higher rank carry stronger representation ability which can focus more on local contextual information.

**2) Reduced computational complexity:** Given a larger \(n\) but fixed small \(b\) in Equation 12, there will be a lot of zeros in upper-right and lower-left areas. We note that these zeros can be omitted during attention matrix calculation by a chunking method . Since most operations in softmax\((QK^{})\) can be skipped, the modified complexity \(O(bnd)\) will linearly related to sequence length and band-width, which is heavily reduced compared to \(O(n^{2}d)\).

**3) Extrapolation ability:** Despite above advantages, here we further show that our model can tackle WSIs with varying input shape better, in other words, extrapolation ability. RoPE need to be well trained or fine-tuned on unseen or seldom seen longer length [45; 13; 81]. Another strategy Attention with Linear Bias (ALiBi) adds pre-defined bias term after the query-key dot-product attention matrix before softmax. For the original 1-d ALiBi , the bias is a static, non-learned matrix softmax\((q_{i}k_{j}^{}-|i-j|\) computed by the distance between tokens from different positions. We also introduce 2-d ALiBi by 2-d Euclidean distance among token positions, and we find that it shows similar pattern (Appendix A.3) compared to our 2-d local attention but it needs to focus on all instances.

### LongMIL framework and implementation

To realize long contextual MIL modelling and better WSI analysis performance, the overall framework (as depicted in Fig. 3) of our method includes 3 stages:

1. Segment and patch WSI into instances, then save its corresponding foreground patch feature embedding and 2-d positions for preparation.

Figure 3: LongMIL framework for WSI local-global spatial contextual information interaction and fusion. 1) Preparing patch feature embedding and 2-d positions of WSIs. 2) Performing pairwise computations among all positions within a WSI by local masking as acceleration. 3) Overall local-global forward of the model, where position information need to be feed to both local (local masking) and global (positional embedding).

2. Calculate the local self-attention matrix by the local window mask given position distance. This process is finished by trunk method like FlashAttention  to omit non-masking areas.
3. After multi layers (two as default) of local attention focusing on local contextual information interactions, a pooling function with window size \(2 2\) is employed to reduce token number by 4 times. Then a basic self-attention focus on global interactions is computed to get final feature and prediction.

## 4 Experiments

In this section, we present the performance of the proposed method and compare it with various baselines. Ablation experiments are performed to further study the proposed method, for paper length, more experimental results are presented in the Appendix A.5.

**Datasets and Tasks.** We use four datasets to evaluate our method for both **tumor subtyping** and **survival prediction**. For data details and pre-processing, please see Appendix A.4.

**Pre-training Patch Encoders.** Our work mainly focus on the WSI-head results based on some good pre-trained encoders for histopathology including HIPT , Lunit  and newly foundation models like UNI  and GigaPath . We also include ResNet-50 pretrained in ImageNet-1k and ViT-small pretrained in BRACS patch data by ourself with DINO .

**Implementation Details.** We train our model with PyTorch on a RTX-3090 GPU, with a WSI-level batchsize of 1, learning rate of 1e-4, and weight decay of 1e-2. We add positional encoding into the framework, please check our code for details.

### Slide-level Tumor Subtyping

**Evaluation Metrics.** For all the experiments, we report the macro-AUC and macro-F1 scores since all these dataset suffering class imbalance. For TCGA-BRCA, we perform 10-fold cross-validation with the same data split adopted in HIPT . Besides, the dataset BRACS is officially split into training, validation and testing, thus the experiment is conducted 5-times with different random seeds. The mean and standard variance values of performance metrics are reported for multi-runs or cross-validation runs.

**Baselines for Comparison.** We first show the results of Mean-/Max- pooling and KNN for traditional evaluation. Then we directly evaluate several classical WSI-MIL methods, including AB-MIL ,

    &  \\   &  &  \\ Method & F1 & AUC & F1 & AUC \\  KNN (Mean) & 0.503\(\)0.011 & 0.691\(\)0.007 & 0.430\(\)0.029 & 0.649\(\)0.008 \\ KNN (Max) & 0.472\(\)0.009 & 0.771\(\)0.018 & 0.416\(\)0.019 & 0.645\(\)0.007 \\ Mean-pooling & 0.534\(\)0.026 & 0.741\(\)0.017 & 0.487\(\)0.034 & 0.717\(\)0.020 \\ Max-pooling & 0.649\(\)0.032 & 0.843\(\)0.018 & 0.598\(\)0.032 & 0.818\(\)0.006 \\ AB-MIL  & 0.668\(\)0.032 & 0.866\(\)0.016 & 0.621\(\)0.048 & 0.837\(\)0.035 \\ DS-MIL  & 0.607\(\)0.044 & 0.824\(\)0.028 & 0.622\(\)0.063 & 0.808\(\)0.033 \\ CLAM-SB  & 0.647\(\)0.020 & 0.836\(\)0.021 & 0.627\(\)0.032 & 0.836\(\)0.009 \\ DTFD-MIL MaxS  & 0.597\(\)0.025 & 0.874\(\)0.026 & 0.521\(\)0.059 & 0.807\(\)0.016 \\ DTFD-MIL AFS  & 0.608\(\)0.083 & 0.869\(\)0.018 & 0.538\(\)0.053 & 0.824\(\)0.011 \\  TransMIL  & 0.648\(\)0.054 & 0.835\(\)0.031 & 0.591\(\)0.049 & 0.798\(\)0.029 \\ Full Attention & 0.689\(\)0.036 & 0.870\(\)0.010 & 0.648\(\)0.028 & 0.839\(\)0.018 \\ LongMIL (ours) & **0.706\(\)0.025** & **0.888\(\)0.019** & **0.657\(\)0.026** & **0.848\(\)0.004** \\   

Table 1: **Slide-Level Tumor Subtyping** on BRACS by using two pre-trained embeddings. **Top Rows.** Various WSI-MIL architectures with vanilla attention (no interaction among different instances). **Bottom Rows.** TransMIL (using Nyströmformer and learnable absolute position embedding), full attention (+RoPE) and our LongMIL.

DS-MIL , CLAM , DTFD-MIL . Then we compare our method with Full Attention (RoFormer) and TransMIL . We omit HIPT  for BRACS since it need WSI larger than a threshold and should based on their pre-trained backbone.

**Results Analysis:** For BRACS 3-categories tumor subtyping, the results are reported in Table 1. We can first observe that both Full Attention and our LongMIL show improvement respectively. For Full Attention, attributing to its full self-attention for pairwise interaction ability, it shows better performance compared to all vanilla attention modules [32; 40; 50] and especially TransMIL  which use attention approximation, but it is not quite stable to beat DTFD .

For TCGA-BRCA 2-categories tumor subtyping, we show the results in the Appendix A.5.1.

### Slide-level Survival Prediction

**Evaluation Metrics.** For all the experiments, C-Index scores are reported for the 3 datasets. We follow the data splits and pre-trained patch embedding provided in HIPT  for fair comparison. The performance results are also reported via the mean and standard variance values of performance metrics by multiple folder cross-validation with the same running setting to HIPT .

**Baselines for Comparison.** For this task, we use the survival cross-entropy loss proposed by Zadeh et al. . The results are summarized in Table 2, where we directly evaluate several survival prediction WSI-MIL methods, including AB-MIL , AMISL , DS-MIL , GCN-MIL . Then we compare our method with some state-of-the-art combining position embedding on Transformer: TransMIL  and HIPT . Though our method show some improvement, the C-index score is still too low to daily clinical usage depending on only WSI information. In the near future, we would like to investigate more on this task, e.g. combining multi-modality features as used in , since Transformer also born with great ability on multi-modality fusion [39; 70; 12; 63].

### Evaluation on Pathology Foundation Models

Since recent Pathology Foundation Model (PathFMs) [10; 48; 84] have been emerging as strong patch encoders, we here further provide evaluations based on PathFMS including UNI  and GigaPath . The pre-processing procedure is the same to previous sections. Since the WSI params are pre-trained in GigaPath, we also experiment it using random initialization for fair comparison. For the mismatch of UNI patch encoder and GigaPath WSI head, we add a nn.Linear layer as a feature projector. The results is shown in Table 3, we find that our method also show consistency improvement with PathFMs. Furthermore, we find that the pre-training plays a key role to the success of Prov-GigaPath WSI-head, since transformers are much more over-parameterized than previous simple attention-based MIL. However, the WSI-level pretrained model relies on patch encoder (e.g. UNI patch encoder + GigaPath WSI do not show competing result). We also provide more difference analysis of efficient attention mechanism compared to GigaPath WSI head in Appendix A.6. In table 4, we also include survival prediction based on PathFMs.

   Method & COADREAD & STAD & BRCA \\  AB-MIL  & 0.566\(\)0.075 & 0.562\(\)0.049 & 0.549\(\)0.057 \\ AMISL  & 0.561\(\)0.088 & 0.563\(\)0.067 & 0.545\(\)0.071 \\ DS-MIL  & 0.470\(\)0.053 & 0.546\(\)0.047 & 0.548\(\)0.058 \\ GCN-MIL  & 0.538\(\)0.049 & 0.513\(\)0.069 & - \\ HIPT  & 0.608\(\)0.088 & 0.570\(\)0.081 & - \\ TransMIL  & 0.597\(\)0.134 & 0.564\(\)0.080 & 0.587\(\)0.063 \\ Full Attention & 0.603\(\)0.048 & 0.568\(\)0.074 & 0.601\(\)0.047 \\ LongMIL (ours) & **0.624\(\)0.057** & **0.589\(\)0.066** & **0.619\(\)0.053** \\   

Table 2: **Slide-Level Survival Prediction based on HIPT  pre-trained embedding with various WSI-MIL architectures including vanilla attention, GCN, TransMIL, self-attention (HIPT with region slicing and absolute embedding), full self-attention and our LongMIL.**

### Further Experiments and Ablations

We also provide abundant ablations in Appendix A.5.3 to select best setting including: Transformer blocks and multi-head number, dropout ratio, weight decay, learning rate and the local window size. For linear attention result, please check Appendix A.5.6 with main findings that the linear attentions show low performance like TransMIL since it get low-rank problem more easily. For linear RNN method like Mamba, the result is also relatively lower than Transformer since 2-d WSIs do not hold causal property like 1-d data. For extrapolation validation, please check Appendix A.2 where our method show significant performance improvement (p-value \(\) 0.1). We also find that our method show consistency improvement when equipped on different magnification (e.g. 40x) and patch size (224 -> 448) as shown in Appendix A.5.4.

## 5 Conclusions and Limitations

In conclusion, our work introduces advancements in computer-aided diagnosis for histopathology WSI analysis. By analyze the low-rank bottleneck and sparsity property and proposing a local-global hybrid Transformer model, our method, Long-contextual MIL (LongMIL), demonstrates superior performance in handling large and shape-varying WSIs. The evaluations across various tasks highlight its accuracy, extrapolation ability, and efficiency compared to previous methods. Our contributions enhance WSI analysis and provide valuable insights for future research. The LongMIL has two limitations: First, its application is restricted to very large image via Transformer modelling. Second, limited embedding size is adopted for practical aim and fair comparison, which is the key to stronger performance based on the low-rank assumption. Future work will aim to address these limitations.

## 6 Acknowledgements

This study was partially supported by Zhejiang Provincial Natural Science Foundation of China (Grant no. XHD23F0201), the National Natural Science Foundation of China (Grant no. 92270108), and the Research Center for Industries of the Future (RCIF) at Westlake University.

   Method & UNI  & GigaPath  \\  AB-MIL  & 0.630\(\)0.054 & 0.635\(\)0.033 \\ AMISL  & 0.627\(\)0.080 & 0.620\(\)0.040 \\ DS-MIL  & 0.616\(\)0.034 & 0.612\(\)0.086 \\ TransMIL  & 0.598\(\)0.059 & 0.599\(\)0.064 \\ Full Attention & 0.638\(\)0.056 & 0.617\(\)0.069 \\ LongMIL (ours) & **0.656\(\)0.061** & **0.645\(\)0.055** \\   

Table 4: TCGA-BRCA Survival Prediction based on Pathology Visual Foundation Models.

    &  \\   &  &  \\  Method & F1 & AUC & F1 & AUC \\  AB-MIL  & 0.692\(\)0.033 & 0.875\(\)0.020 & 0.640\(\)0.022 & 0.837\(\)0.010 \\ CLAM-SB  & 0.640\(\)0.057 & 0.844\(\)0.025 & 0.624\(\)0.023 & 0.826\(\)0.014 \\ DTFD-MIL  & 0.655\(\)0.031 & 0.878\(\)0.022 & 0.610\(\)0.032 & 0.843\(\)0.017 \\ TransMIL  & 0.592\(\)0.036 & 0.859\(\)0.023 & 0.599\(\)0.058 & 0.838\(\)0.048 \\ Full Attention & 0.715\(\)0.043 & 0.884\(\)0.017 & 0.663\(\)0.023 & 0.850\(\)0.018 \\ GigaPath-random init & 0.648\(\)0.041 & 0.837\(\)0.033 & 0.627\(\)0.038 & 0.808\(\)0.038 \\ GigaPath-pretrained & 0.668\(\)0.026 & 0.861\(\)0.030 & **0.677\(\)0.033** & **0.862\(\)0.034** \\ LongMIL (ours) & **0.728\(\)0.045** & **0.887\(\)0.008** & 0.673\(\)0.023 & 0.856\(\)0.015 \\   

Table 3: Slide-Level Tumor Subtyping on BRACS based on Pathology Visual Foundation Models.