# Data Quality in Imitation Learning

Suneel Belkhale

Stanford University

belkhale@stanford.edu &Yuchen Cui

Stanford University

yuchenc@stanford.edu &Dorsa Sadigh

Stanford University

dorsa@stanford.edu

###### Abstract

In supervised learning, the question of data quality and curation has been overshadowed in recent years by increasingly more powerful and expressive models that can ingest internet-scale data. However, in offline learning for robotics, we simply lack internet scale data, and so high quality datasets are a necessity. This is especially true in imitation learning (IL), a sample efficient paradigm for robot learning using expert demonstrations. Policies learned through IL suffer from state distribution shift at test time due to compounding errors in action prediction, which leads to unseen states that the policy cannot recover from. Instead of designing new algorithms to address distribution shift, an alternative perspective is to develop new ways of assessing and curating datasets. There is growing evidence that the same IL algorithms can have substantially different performance across different datasets. This calls for a formalism for defining metrics of "data quality" that can further be leveraged for data curation. In this work, we take the first step toward formalizing data quality for imitation learning through the lens of distribution shift: a high quality dataset encourages the policy to stay in distribution at test time. We propose two fundamental properties that shape the quality of a dataset: i) _action divergence:_ the mismatch between the expert and learned policy at certain states; and ii) _transition diversity:_ the noise present in the system for a given state and action. We investigate the combined effect of these two key properties in imitation learning theoretically, and we empirically analyze models trained on a variety of different data sources. We show that state diversity is not always beneficial, and we demonstrate how action divergence and transition diversity interact in practice.

## 1 Introduction

Supervised learning methods have seen large strides in recent years in computer vision (CV), natural language processing (NLP), and human-level game playing [18; 26; 43; 8; 51; 13; 44]. These domains have benefited from large and complex models that are trained on massive internet-scale datasets. Despite their undeniable power, biases present in these large datasets can result in the models exhibiting unexpected or undesirable outcomes. For example, foundation models such as GPT-3 trained on uncurated datasets have resulted in instances of racist behavior such as associating Muslims with violence [1; 5]. Thus offline data curation is immensely important for both safety and cost-effectiveness, and it is gaining in prominence in training foundation models [22; 10; 40].

Data curation is even more important in the field of robotics, where internet-scale data is not readily available and real-world datasets are small and uncurated. Noise or biases present in the data can lead to dangerous situations in many robotics tasks, for example injuring a person or damaging equipment. In such scenarios, deciding which data to collect and how best to collect it are especially important [37; 34; 4]. Of course, the quality of data depends on the algorithm that uses the data. A common paradigm in robot learning from offline datasets is imitation learning (IL), a data-driven, sample efficient framework for learning robot policies by mimicking expert demonstrations. However, when learning from offline data using IL, estimating data quality becomes especially difficult, since the "test set" the robot is evaluated on is an entirely new data distribution due to compounding errorsincurred by the model, i.e., action prediction errors take the model to unseen states. This phenomenon is studied and referred to as the distribution shift problem, and prior work has viewed and addressed it through several angles [46; 49].

Broadly, prior work address distribution shift either by taking an _algorithm-centric_ approach to account for biases in the dataset, or by directly modifying the dataset collection process in a _data-centric_ manner. Algorithm-centric approaches learn robust policies by imposing task-specific assumptions [23; 28; 25], acquiring additional environment data [21; 41], or leveraging inductive biases in representing states [54; 30; 38; 12; 12; 37] and actions [53; 48; 12]. What these algorithm-centric works overlook is that changing the data can be as or more effective for policy learning than changing the algorithm. In prior data-centric methods, the goal is usually to maximize _state diversity_ through shared control [46; 45; 16; 27; 32; 36; 47], noise injection , or active queries [15; 6; 42; 29]. By only focusing on state coverage, these works are missing the role that actions (i.e., the expert) plays in the quality of data. A more complete understanding of data quality that integrates both state and action quality would not only improve performance but also save countless hours of data collection.

To better understand the role of both states and actions in the data for learning good policies, consider a single state transition -- the three core factors that affect distribution shift are: the policy action distribution, the the stochasticity of transitions, and the previous state distribution. Note that the previous states are also just a function of the policy and dynamics back through time. Through this we extract two fundamental properties that can influence data quality in IL: _action divergence_ and _transition diversity_. Action divergence captures how different the learned policy action distribution is from the expert's actions at a given state: for example, if the expert is very consistent but the policy has high variance, then action divergence will be high and distribution shift is likely. Transition diversity captures the inherent variability of the environment at each state, which determines how the state distribution evolves for a given policy: for example, noisy dynamics in the low data regime can reduce overlap between the expert data and the learned policy distribution. Importantly, these factors can compound over time, thus greatly increasing the potential for distribution shift. While state coverage has been discussed in prior work, we are the first work to formalize the roles of both state and action distributions in data quality, along with how they interact through time: this new data-focused framing leads to insights about how to curate data to learn more effective policies.

To validate and study these properties empirically, we conduct two sets of experiments: (1) Data Noising, where we ablate these properties in robotics datasets to change the policy success rates, and (2) Data Measuring, where we observe human and machine generated datasets and approximately measure these properties in relationship to the policy success rates. Both experiments show that state diversity, a commonly used heuristic for quality in prior work, is not always correlated with success. Furthermore, we find that in several human generated datasets, less consistent actions at each state is often associated with decreases in policy performance.

## 2 Related Work

Data quality research dates back to the early time of computing and the full literature is out of the scope of this paper. Existing literature in machine learning has proposed different dimensions of data quality including accuracy, completeness, consistency, timeliness, and accessibility [33; 14; 20]. We could draw similarities between action divergence with the concept of data consistency, and state diversity with completeness. However, instantiation of these metrics is non-trivial and domain-specific.

Our work is closely related to the imitation learning literature that explicitly addresses the distribution shift problem in various ways. Prior work can be divided into two camps: ones that take an _algorithm-centric_ approach to account for biases in the dataset, and ones that employ _data-centric_ methods for modifying the data collection process.

**Algorithm-centric.** Robust learning approaches including model-based imitation learning methods learn a dynamics model of the environment and therefore can plan to go back in distribution when the agent visits out of distribution states [21; 41]. Data augmentation is a useful post-processing technique when one could impose domain or task specific knowledge [23; 28; 25]. Prior work has also investigated how to explicitly learn from sub-optimal demonstrations by learning a weighting function over demonstrations either to guide BC training [9; 3] or as a reward function for RL algorithms [7; 11]. These methods either require additional information such as rankings of trajectories , demonstrator identity , or collecting additional environment data [7; 11]. Recent efforts on demonstration retrieval augment limited task-specific demonstrations with past robot experiences . A recent body of work build better inductive biases into the model for learning robust state features, like pretrained vision or language representations [54; 30; 38; 12]. Some approaches modify the action representation to be more expressive to capture all the expert's actions, for example using Gaussian or mixture model action spaces [12; 37]. Others consider temporally abstracted action spaces like waypoints or action sequences to reduce the effective task length and thus mitigate compounding errors [53; 48; 12]. What these algorithm-centric works overlook is that changing the data can be as or more effective for policy learning than changing the algorithm. However, we still lack a comprehensive understanding of what properties in the data matter in imitation learning.

**Data-centric.** In more data-centric prior works that discuss data quality, the primary goal is often just to maximize state diversity. A large body of research focuses on modifying the data collection process such that the expert experience a diverse set of states. Ross et al.  proposed to iteratively collect _on-policy_ demonstration data with shared-control between the expert and the robot, randomly switching with a gradually decreasing weight on the expert's input, such that the training data contains direct samples of the expert policy at states experienced by the learned policy. However, randomly switching the control can make it unnatural for the human demonstrator and leads to noisier human control. To mitigate this issue, methods have been proposed to gate the control more effectively by evaluating metrics such as state uncertainty and novelty [16; 27; 50]. Other methods allow the human to gate the control and effectively correct the robot's behavior only when necessary [32; 36; 24; 47]. Closely related to our work, Laskey et al.  takes an optimal control perspective and showed that injecting control noise during data collection can give similar benefits as DAgger-style iterative methods. Active learning methods have also been developed to guide data collection towards more informative samples [15; 6; 42; 29]. By only focusing on state coverage, these works are missing the role that actions (i.e., the expert) plays in the quality of data.

## 3 Preliminaries

In imitation learning (IL), we assume access to a dataset \(_{N}=\{_{1},,_{N}\}\) of \(N\) successful demonstrations. Each demonstration \(_{i}\) consists of a sequence of continuous state-action pairs of length \(T_{i}\), \(_{i}=\{(s_{1},a_{1}),,(s_{T_{i}},a_{T_{i}})\}\), with states \(s\) and actions \(a\). Demonstrations are generated by sampling actions from the demonstration policy \(_{E}\) through environment dynamics \((s^{}|s,a)\). The objective of imitation learning is to learn a policy \(_{}:\) that maps states to actions. Standard behavioral cloning optimizes a supervised loss maximizing the likelihood of the state-action pairs in the dataset:

\[()=-_{N}|}_{(s,a)_{N}} _{}(a|s),\] (1)

which is optimizing the following objective under finite samples from the demonstration policy:

\[_{s_{_{E}}()}[D_{}(_{E}( |s),_{}(|s))]=-_{s_{_{E}}( ),\ a_{E}(|s)}[_{}(a|s)]+C\] (2)

The \(C\) term here captures the entropy of the demonstration state-action distribution, which is constant with respect to \(\) and thus it does not affect optimality of \(\). \(_{_{E}}(s)\) is the state visitation of the demonstration policy, defined for any policy \(\) as follows:

\[_{}(s) =_{t=1}^{T}_{}^{t}(s)\] (3) \[_{}^{t}(s^{}) =_{s,a}_{}^{t}(s,a,s^{})ds\ da=_{s,a}(a|s) (s^{}|s,a)_{}^{t-1}(s)ds\ da\] (4)

### Distribution Shift in IL

Behavioral cloning methods as in Eq. (2) often assume that the dataset distribution is a good approximation of the demonstration policy distribution. In most applications, however, the learned policy is bound to experience novel states that were not part of the training data due to stochasticity of the environment dynamics and the learned policy. Herein lies the fundamental challenge with imitation learning, i.e., state _distribution shift_ between training and test time. Consider the training sample \((s,a,s^{})\) at timestep \(t\) in demonstration \(_{i}\). If the learned policy outputs \((|s)\) which has a small action error \(=-a\), the new state at the next time step will also deviate: \(^{}(s^{}|s,a+)\), which in turn affects the policy output at the next step. In practice, the change in next state can be highly disproportionate to \(||||\), so small errors can quickly lead the policy out of the data distribution. Stochastic dynamics, for example system noise, can compound with the distribution shift caused by policy errors, and as we continue to execute for \(T-t\) steps, both these factors can compound over time to pull the policy out of distribution, often leading to task failure.

We can address this distribution shift problem by minimizing the mismatch between state visitation distribution of a learned policy \(\) and the state visitation distribution of an demonstration policy \(_{E}\) under some \(f\)-divergence \(D_{f}\):

\[J(,_{E})=D_{f}(_{}(s),_{_{E}}(s))\] (5)

Next, we connect this distribution shift problem to the question of data quality.

### Formalizing Data Quality

How can we define and measure the quality of a dataset \(\) in IL? In existing literature, data quality has been used interchangeably with either the proficiency level of the demonstrator at the task or the coverage of state space. However, these notions of quality are loose and incomplete: for example, they do not explain what concretely makes a demonstrator better or worse, nor do they consider how stochasticity in the transitions impacts state space coverage and thus downstream learning. Our goal is to more formally define a measure of quality so that we can then optimize these properties in our datasets.

We posit that a complete notion of dataset quality is one that minimizes distribution shift in 5. This suggests that we cannot discuss data quality in isolation. The notion of data quality is heavily tied to the algorithm \(A\) that leads to the learned policy \(_{A}\) as well as the demonstration policy \(_{E}\). We thus formalize the quality of a dataset \(_{N}\) conditioned on the demonstration policy \(_{E}\) that generates it along with a policy learning algorithm \(A\), as the negative distribution shift of a learned policy under some \(f\)-divergence \(D_{f}\):

\[Q(_{N};_{E},A)=-D_{f}(_{_{A}}(s),_{_{E}}(s) ),_{A}=A(_{N})\] (6)

Here, \(_{A}\) is the policy learned by algorithm \(A\) using dataset \(_{N}\) of size \(N\), which is generated from demonstrator \(_{E}\). Note that quality is affected by several components: the choice in demonstrator, the choice of dataset size, and the algorithm. The choice of demonstration policy \(_{E}\) changes the trajectories in \(_{N}\) (which in turn affects policy learning) along with the desired state distribution \(_{_{E}}(s)\)). The dataset size controls the amount of information about the demonstration state distribution present in the dataset: note that \(_{A}(s)\) should match \(_{_{E}}(s)\), but \(A\) learns only from \(_{N}\) not from the full \(_{_{E}}(s)\). The algorithm controls how the data is processed to produce the final policy \(_{A}\) and thus the visited distribution \(_{_{A}}(s)\).

To optimize this notion of quality, we might toggle any one of these factors. Prior work has studied algorithm modifications at length [37; 54; 4], but few works study how \(_{E}\) and the dataset \(D_{N}\) should be altered to perform best for any given algorithm \(A\). We refer to this as _data curation_. In practice we often lack full control over the choice of \(_{E}\), since this is usually a human demonstrator; still, we can often influence \(_{E}\), for example through prompting or feedback , or we can curate the dataset derived from \(_{E}\) through filtering .

## 4 Properties of Data Quality

To identify properties that affect data quality in imitation learning, we can study how each state transition \((s,a,s^{})\) in the dataset affects the dataset quality in detail. As we defined in 6, the dataset quality relies on distribution shift given an demonstration policy \(_{E}\) and an imitation learning policy \(_{A}\). This relies on the state visitation distribution \(^{t}_{_{A}}(s)\), which based on 4 depends on three terms: \(_{A}(a|s)\), \((s^{}|s,a)\), and \(^{t-1}_{_{A}}(s)\). Intuitively, three clear factors emerge for managing distribution shift: how different the policy \(_{A}(a|s)\) is from the demonstrator \(_{E}(a|s)\) - which we refer to as _action divergence_, how diverse the dynamics \((s^{}|a,s)\) are - which we refer to as _transition diversity_, and how these factors interact over time to produce past state visitation distribution \(^{t-1}_{_{A}}(s)\). Importantly, the past state visitation can be controlled through _action divergence_ and _transition diversity_ at previous time steps, so in this section, we will formalize these two properties and discuss their implication on data curation.

### Action Divergence

Action divergence is a measure of distance between the learned policy and the demonstration policy \(D_{f}(_{A}(|s),_{E}(|s))\). This can stem from biases in the algorithm or dataset such as mismatched action representations or lack of samples. While this is typically viewed in prior work as a facet of the algorithm or dataset size, importantly action divergence and thus data quality can also be influenced by the demonstration policy itself. For example, if the demonstrator knows the action representation used by the learning agent _a priori_, then the policy mismatch can be reduced by taking actions that are consistent with that action space. In Theorem4.11, we illustrate the importance of action divergence by showing that our notion of data quality is lower bounded by the action divergence under the visited state distribution.

**Theorem 4.1**.: _Given a policy \(_{A}\) and demonstrator \(_{E}\) and environment horizon length \(H\), the distribution shift:_

\[D_{}(_{_{A}},_{_{E}})_{t=0}^{H-1}(H- t)_{s_{_{A}}^{t}}[D_{}(_{A}(|s),_{E}( |s))]\]

When using KL divergence for distribution shift in Eq.5, we can see how the quality is lower bounded by the policy action divergence from the optimal policy under the visited state distribution, weighted at each step by time-to-go. Many prior works have noted the compounding error problem [46; 45], and here too action divergence at earlier timesteps has an out-sized effect on the overall distribution shift. Thus to optimize for the quality of a dataset, we should reduce the aggregated policy mismatch across visited trajectories.

**Optimality**: Many prior ideas around the "optimality" of a demonstration are intimately related to this action divergence property. Suboptimalities that are naturally present in demonstrations like pauses or other action noise have been a source of difficulty when learning imitation policies [35; 4]. These factors make it harder for the model to learn the demonstration action distributions, thus increasing action divergence. Suboptimality can also come from multi-modal demonstration policy distributions, and more expressive policy representations (i.e., reducing action divergence between the demonstrator and the learned policy) has been shown to help [17; 12; 24]. The speed of demonstration is another common notion of optimality, which decreases total action divergence by reducing horizon length \(H\), provided it does not increase the per time step action divergence to compensate.

**State Visitation**: Critically, the visitation distribution in Theorem4.1 determines _where_ action divergence should be low, whereas in the standard BC objective in Eq.2, the divergence is only minimized under samples from the demonstration distribution \(_{_{E}}^{t}\). To better understand how the visitation distribution evolves, we now analyze state transitions in greater detail.

### Transition Diversity

Transition diversity encompasses the diversity of next state transitions seen at a given state for a certain policy. What role does transition diversity play in minimizing distribution shift? Intuitively, if we consider the upper bound in Theorem4.1, the demonstrator's state coverage should overlap as much as possible with the visited state distribution, but without increasing the action divergence.

**Lemma 4.2**.: _Given a learned policy \(_{A}\) and an demonstration policy \(_{E}\), assume that the policy is learned such that when \(s(_{_{E}}^{t})\), \(D_{}(_{A}(|s),_{E}(|s))\). Then:_

\[_{s_{_{A}}^{t}}[D_{}(_{A} (|s),_{E}(|s))]_{s_{_{A}}^{t}} [(s(_{_{E}}^{t})).\] \[+(s(_{_{E}}^{t}))D_{ }(_{A}(|s),_{E}(|s))]\]

Lemma4.2 shows that with a good learning algorithm (i.e., when \(\) is small), it is important to maximize the overlap between the visited policy and the demonstration data (minimizes the contribution of the unbounded right term), but as shown in Theorem4.1 this should not come at the expense of increasing the action divergence of the policy. Rather than broadly maximizing state diversity, as prior works do, a more sensible approach is for the demonstrator to maximize the two other factors that affect \(_{_{A}}^{t}\): _system noise_ and _initial state variance_ in the demonstrator data.

**Finite Data and Low Coverage**: While the above analysis holds for infinite data, maximizing transition diversity can lead to thinly spread coverage in the finite data regime. To analyze the finite data regime in isolation, we consider Gaussian system noise for simplicity. First, we formulate an empirical estimate of state "coverage" of the demonstrator (i.e. the deviation from states in the demonstration dataset). We then show that higher system noise can cause the learned policy \(_{A}\) to deviate more from states sampled in the dataset.

**Definition 1**.: _For a given start state \(s\), define the next state coverage probability over \(N\) samples from \(_{E}\) for tolerance \(\) as \(P_{S}(s;N,) P(_{i\{1...N\}}||s^{}-s^{}_{*,i}||_{})\), where \(\{s^{}_{*,i}^{t}_{_{E}}(|s)\}\) is a set of \(N\) sampled next state transitions under the demonstration policy \(_{E}\) starting at \(s\), and \(s^{}^{t}_{_{A}}(|s)\) is a sampled next state under the policy \(_{A}\) starting at \(S\)._

We can think of \(P_{S}(s;N,)\) as the probability under potential datasets for \(_{E}\) of seeing a next state at test time (under \(_{A}\)) that was nearby the next states in the dataset, conditioned at a starting state \(s\) (i.e., coverage). This is related to a single step of distribution shift, but measured over a dataset rather than a distribution. Defining coverage as the distance to the dataset being below some threshold is reasonable for function approximators like neural networks .

**Theorem 4.3**.: _Given a policy \(_{A}\) and demonstrator \(_{E}\), assume that for state \(s\), if \(^{t-1}_{_{E}}(s)>0\), then \(_{A}(a|s)=_{E}(a|s)\). Assume that transitions are normally distributed with fixed and diagonal variance, \((s^{}|s,a)=((s,a),^{2}I)\), then the next state coverage probability is \(P_{S}(s;N,) 1-(1-()^{d}(- ^{2}d))^{N}-(-(-1)^{2}d)\), where \(d\) is the dimensionality of the state, \(c\) is a constant, and \( 1\) is a parameter chosen to maximize the bound._

In Theorem4.3, we see that even under a policy that is perfect when in distribution, the lower bound of next state coverage probability increases as the variance of system noise \(^{2}\) decreases, for a fixed sampling budget \(N\) (and fixed \(\)). However, increasing \(N\) has a much stronger positive effect on this lower bound of state coverage than decreases in \(\), suggesting that system noise is only an issue when the dataset size is sufficiently small. Furthermore, \(\) here represents some simplistic form of the _generalization_ capacity of the policy, and we see here that increasing \(\) makes us more robust to proportional increases in \(\).

**Finite Data and Good Coverage**: However, if we assume \(N\) is large enough to mitigate the coverage effect of system noise, are there any other effects of transition diversity in the dataset? The answer lies in generalization properties of the algorithm, which as provided in Theorem4.3 are fairly conservative (i.e., in the definition of \(P_{S}(s;N,)\)). In TheoremA.1 in AppendixA, we use a more loose generalization definition and relax the assumption that the learned policy is perfect. We show as system noise increases, the resulting boost in sample coverage can actually replicate and overcome the effects of high learned policy noise, suggesting that more system noise can actually be beneficial for learning. This finding sheds light on results from prior work and our own experiments in Section5 that show the benefits of collecting data in the presence of high system noise .

### Implications for Data Curation

We have shown how action divergence and transition diversity are both tied to distribution shift and thus data quality. Based on action divergence and transition diversity, we now examine downstream implications of these properties on what matters for _data curation_, where the goal is to collect and then select _high quality_ demonstrations in our dataset \(_{N}\) for good policy learning.

**Action Consistency**: To minimize action divergence, the algorithm action representation should _align_ with the demonstrator's action distribution, for the given dataset size. One algorithmic solution is to improve the expressiveness of the policy action space so it can capture the exact actions at every state that was demonstrated. However, in practice, individual states might only be visited a few times in the dataset, and so if the entropy of the demonstration policy at those states is high, the learned policy will find it difficult to perfectly match the actions even for the most expressive action spaces. Instead, we argue that demonstration data should be curated to have more _consistent_ actions, e.g., reducing the entropy of the demonstration policy: \(_{s_{_{A}}(|(_{E}(|s))|}\). Since knowing the visited state distribution is impossible beforehand, the best we can do is to encourage low entropy in the demonstration data distribution:

\[_{_{E}}_{s_{_{E}}()}[(_{E}( |s))]\] (7)

**State Diversity**: As discussed previously, the state visitation of the policy depends on the trajectory action distribution, the initial state distribution, and the system noise distribution. Many prior works seek to improve the _state coverage_ of the dataset, using some metric similar to Definition1. However, the required state diversity is a function of the learned policy mismatch (action divergence) and the noise present in the system (transition diversity), and is thus a coarse representation of data quality. Uniformly increasing coverage over the state space is not necessarily a good thing -- as shown in Section4.1, if state coverage comes at the expense of action consistency, the result might be worse than a policy trained on less state coverage but more consistent actions. Instead, we argue that we should optimize for system noise.

**System Noise**: Although system noise at a given state cannot be controlled, demonstrators can control system noise at the trajectory level (e.g. visiting states with more or less system noise). Should system noise be encouraged or discouraged in a dataset? Based on the discussion in Section4.2, we hypothesize that when the dataset size is fixed, increasing the system noise can increase the _coverage_ of the demonstrations and thus improve robustness in the learned policy (TheoremA.1), but only up to a certain point, when the data becomes too sparse to generalize (Theorem4.3). Thus, in addition to consistent actions, we posit that demonstrators should encourage paths with high system entropy for learning better policies, such that the overall state entropy stays below some threshold \(\) to avoid coverage that is too sparse.

\[_{_{E}}\,_{s_{_{E}}(),a_{ E}(|s)}[((|a,s))]\] \[s.t.\,H(_{_{E}}(s))\] (8)

**Horizon Length**: The length of trajectories in the demonstration data also can have a large effect on the demonstration and visited state distributions, and thus on the quality of the dataset. However, while horizon length certainly plays a role, like state diversity, it is a downstream effect of action divergence and transition diversity. Based on previous analysis, what really matters is minimizing the _aggregated_ action divergence and transition diversity produced by the demonstrator across time. Horizon length alone only crudely measures this, but is often correlated in practice as we show in Section5.2.

While prior work in data curation primarily aim to maximize state diversity alone, our analysis of data quality reveals several new properties that matter for data curation, such as action consistency, system noise, and their combined effect over time. As we demonstrate in the next section, understanding these properties and the inherent tradeoffs between them is vital for data curation in imitation learning.

## 5 Analysis

To empirically analyze how different data properties affect imitation learning, we conduct two sets of experiments. In the first set, we generate various quality demonstration datasets by adding different types of noise to _scripted_ policies, i.e., policies that are hand-designed to be successful at the task. An example scripted policy compared to human demonstrations is shown in Fig.1. We study both noise in the system - considering transition diversity - and noise added to the demonstration policy - considering both transition diversity and action divergence - as a function of dataset size. In the second set of experiments, we evaluate the empirical properties (see AppendixB) for real human collected datasets.

Figure 1: **Case Study**: Trajectories and action variance for scripted (left two plots) compared to human demonstration data (right two plots). Even though the human data (right) has high state coverage, the action variance is high, leading to high action divergence, and vice versa.

### Data Noising

We train Behavior Cloning (BC) with data generated with system noise and policy noise in two environments: _PMObstacle_, a 2D environment where a point mass agent must reach a target point without hitting an obstacle in its way, where demonstrations are multimodal (left and right around the obstacle); and _Square_, a 3D environment where a robot arm must pick up a square nut and insert it onto a peg (shown in Fig. 1). In both, system and policy noise are Gaussian random variables added to the dynamics and scripted policy, respectively, at each time step, and BC uses an MLP architecture. Fig. 2 shows results in _PMObstacle_ (top row) and _Square_ (bottom row). We additionally show Transformer architecture results in Fig. 3.

**State Diversity through Transition Diversity improves performance, up to a point**. The left plots in Fig. 2 (a)-(d) show policy success rates as we vary system noise (\(_{s}\)) (more noise for lighter color shades), where (a)(c) show the high-data regime and the (b)(d) show the low data regime. Higher system noise tends to improve policy performance in the high data regime, but only up to a point for _Square_ -- after \(_{s}=0.3\) in the demonstration data (c), performance starts to drop off, which we hypothesize is due to the low coverage, based on the analysis of transition diversity in Section 4.2. In the low data regime, the story is similar but even more exaggerated, with increasing system noise leading to comparable performance as the high data regime. Once again for _Square_, increasing transition diversity (d) helps until the state coverage is too thin. See Table 2, Table 5, and Table 6 in Appendix C for the full sweep of system noise values in each environment.

**State Diversity at the cost of Action Divergence hurts performance**. Plots in Fig. 2 (e)(f) and Fig. 2 (i)(j) show policy success rates for increasing the policy noise (\(_{p}\)) in the dataset, where the (e)(g) show the high data regime and the (f)(h) show the low data regime. Note that each value of policy noise yields the same demonstration state distribution as the corresponding amount of system noise. Since this noise is zero-mean and the learned policy is deterministic, policy noise in the high data regime (e)(g) is only moderately worse as compared to equivalent amounts of system noise (a)(c), suggesting that the action divergence is minor. In fact, due to the added state diversity, adding policy noise in the high data regime helps up to a certain point. However in the low data regime (f)(h), performance is substantially worse compared to comparable system noise, since the policy can not recover the unbiased demonstration policy from just a few noisy examples (note that in (c)(d), the x-axes are not aligned with those in (g)(h), and \(_{s}=0.2\) corresponds to \(_{p}=0.02\) as shown by the dotted line). This illustrates that state diversity coming from the noise in the demonstration policy

Figure 2: BC Success rates in _PMObstacle_ (top row) for 1000 and 10 episodes of data, and in _Square_ (bottom row) for 200 and 50 episodes of data (error bars over 3 datasets). X-axis corresponds to injected system or policy noise in the _dataset_ (\(_{s}^{d}\) or \(_{p}^{d}\)) and each line corresponds to injected noise (\(_{s}\) or \(_{p}\)) during _evaluation_. **System Noise** (left): for large datasets (a)(c), higher system noise during evaluation decreases performance, but more system noise during training does the best. For small datasets (b)(d), we note a similar but exaggerated effect. **Policy Noise** (mid) For large datasets (e)(g), unlike system noise, more demonstration policy noise often hurts performance despite similar state coverage. For small datasets (f)(h), adding policy noise exaggerates this effect and produces large variance in performance. For _Square_, the dotted lines mark comparable values of noise in terms of state coverage. **System + Policy Noise** (i-l): Adding some system noise can make the policy more robust to action divergence.

can increase action divergence, and thus high state diversity is not universally desirable. See Table 3, Table 7, and Table 8 in Appendix C for the full sweep of policy noise values in each environment.

**Transition Diversity can counteract the effects of policy noise**. In the right two plots (i)(j) for _PMObstacle_ in Fig. 2, the dataset combines both system and policy noise. The system noise is fixed (\(_{s}=0.03\)) and the policy noise is varied in the same range as the middle two plots (just policy noise). Given the analysis in Section 4.2 and Theorem A.1 in Appendix A, we would expect that having some system noise could actually make the policy much more robust to policy noise, since the state coverage provided in the dataset can help learn a more robust policy (generalization). Indeed we find that just by adding system noise, the learned policy becomes very robust to added policy noise in both the high (i) and low (j) regimes. This suggests that adding transition diversity can help mitigate the affects of action divergence incurred by noisy or sub-optimal demonstrators. See Table 4 in Appendix C for the full sweep of policy noise values for fixed system noise in each environment.

### Data Measuring

Next we empirically instantiate several metrics from Section 4.3 that capture various facets of data quality, and measure different datasets: (1) action variance (higher means less action consistency) measured through clustering nearby states (2) horizon length \(T\) (higher means longer trajectories), and (3) state similarity (opposite of state diversity) measured as the average cluster size. See Appendix B for the exact empirical definitions. We leave out system noise since these human datasets were collected in deterministic environments.

In Table 1, we consider single and multi-human datasets from the _Square_ and _Can_ tasks from robomimic . We see that higher action variance and horizon length are often accompanied by decreases in success rates. The _Worse_ multi-human datasets have seemingly lower action variance but less state similarity, and yet qualitatively we observed highly multi-modal behaviors in these datasets (e.g., grasping different parts of the nut instead of the handle). We suspect that this type of multi-modality is not measured well by the single time step action variance metric, but rather requires a longer term view of the effects of that action on the scene - as indicated in Theorem 4.1. Additionally, state diversity once again is not correlated with performance on the task.

We emphasize that these metrics likely do not provide a complete picture of data quality, but they do provide us insights into why performance is low and how data collection can be improved in future datasets. Through future efforts from the community, we envision a comprehensive set of data metrics that practitioners can use to quickly evaluate the quality of datasets without needing to first train and evaluate models on those datasets.

Figure 3: Transformer-BC Success rates in _PMObstacle_ for 1000 and 10 episodes. X-axis corresponds to injected system or policy noise in the _dataset_ and each line corresponds to injected noise (\(_{s}\) or \(_{p}\)) during _evaluation_. **System Noise** (left): for large datasets (a), higher system noise during evaluation decreases performance, but more system noise during training does the best. For small datasets (b), we note a similar but exaggerated effect. **Policy Noise** (mid) For large datasets (c), unlike system noise, more demonstration policy noise often hurts performance despite Transformers being more expressive than simple MLPs. For small datasets (d), adding policy noise exaggerates this effect and produces large variance in performance. Overall, we find that Transformers can suffer from similar data quality issues as MLPs despite being more expressive.

## 6 Discussion

Data curation is incredibly important for maximizing the potential of any given algorithm, and especially so in imitation learning. To curate data, one needs to establish a formalism for assessing data quality. The predominant notions of data quality today are solely centered around maximizing _state diversity_ in a dataset, which ignore the quality of the demonstrated actions and how these factors interplay. In this work, we propose a holistic view of data curation centered around minimizing distribution shift. We demonstrate that action divergence and transition diversity are crucial factors in data quality that can often be controlled or measured, and we draw several valuable insights from this shedding light on effective strategies for curating demonstration datasets. We find that making actions more consistent tends to increase policy success. Furthermore, we observe a fundamental tradeoff between state diversity and action divergence -- increasing state diversity can often come at the expense of action divergence. Instead of uniformly maximizing state diversity, we show that increasing transition diversity improves performance until the data coverage becomes too sparse. While the metrics presented in our experiments are often good measures of final performance, we find that comprehensively measuring data quality in practice for real world datasets can be quite challenging. Finally, we envision a broader set of metrics informed by our formalism for data quality that practitioners can use to curate datasets, and we believe our work is an important first step in formulating and evaluating these metrics.

**Limitations and Future Work:** We hope our analysis will inspire future research in data quality for imitation learning. Firstly, we hope to relax several theoretical assumptions like Gaussian noise in future work. The metrics defined in Section 5.2 do not necessarily capture the full scope of factors that comprise data quality. Future work should refine these metrics or find alternate ways of measuring data quality without requiring running the algorithm first, or potentially with only limited algorithm training. While we show the performance of several simple metrics on two interesting control settings, future work is needed in determining how best to use these metrics for guiding data collection. One option is to use the metrics as a score function that demonstrators might use as feedback. Another is to explicitly filter or weight data using the metrics. Furthermore, it would be beneficial to test the insights in this paper on real world settings, for example under more realistic models of system noise than simply Gaussian noise. Nonetheless, we believe our work to be an important first step in defining and measuring data quality.

**Fairness in robotics**: As discussed in our introduction, foundation models like GPT-3 trained on uncurated datasets have learned harmful biases and stereotypes from uncurated datasets. Efforts in the broader ML community have started to focus on curation as a means to solve this problem. In the policy learning setting in robotics, fairness and safety are less clearly defined. Our primary focus in this paper is on data curation for learning high performing policies, but we believe future work should find analogous notions of fairness in the robotics setting, and to consider how metrics of data quality that we define will affect this notion of fairness. For example, we might want to ensure data is collected over a diverse range of institutions rather than in just a select few locations. Our action consistency metric might artificially select only demonstrators from a small range of institutions, and so this should also be considered during data curation.

  &  &  \\  & PH & Better & Okay & Worse & PH & Better & Okay & Worse \\  Success Rate & 58 & 36 & 12 & 2 & 96 & 56 & 40 & 22 \\ Dataset Size (\(N\)) & 200 & 100 & 100 & 100 & 200 & 100 & 100 & 100 \\ Action Variance & 0.073 & 0.062 & 0.099 & 0.061 & 0.051 & 0.066 & 0.079 & 0.063 \\ Horizon Length (\(T\)) & 150 & 190 & 250 & 350 & 115 & 140 & 180 & 300 \\ State Similarity & 8.2e-5 & 1.8e-4 & 1.7e-4 & 1.2e-4 & 1.0e-4 & 2.1e-4 & 2.4e-4 & 2.0e-4 \\ 

Table 1: Data Quality metrics evaluated on _Square_ (left) and _Can_ (right) for proficient human (PH), and multi human (Better, Okay, Worse) datasets. Note that state similarity (defined in Appendix B) is lower for PH than Better, however importantly Better actually represents overlapping data with the PH dataset (Better consists of 2 proficient demonstrators). We use this as calibration between different dataset sizes, and we see that there is some effect of dataset size on our chosen metrics. Note that datatset size corresponds to number of episodes.