# Unbiased constrained sampling with

Self-Concordant Barrier Hamiltonian Monte Carlo

 Maxence Noble

CMAP, CNRS, Ecole polytechnique,

Institut Polytechnique de Paris,

91120 Palaiseau, France

Valentin De Bortoli

Computer Science Department,

ENS, CNRS, PSL University

&Alain Oliviero Durmus

CMAP, CNRS, Ecole polytechnique,

Institut Polytechnique de Paris,

91120 Palaiseau, France

Corresponding author. Contact at: maxence.noble-bourillot@polytechnique.edu

###### Abstract

In this paper, we propose Barrier Hamiltonian Monte Carlo (BHMC), a version of the HMC algorithm which aims at sampling from a Gibbs distribution \(\) on a manifold \(\), endowed with a Hessian metric \(\) derived from a self-concordant barrier. Our method relies on Hamiltonian dynamics which comprises \(\). Therefore, it incorporates the constraints defining \(\) and is able to exploit its underlying geometry. However, the corresponding Hamiltonian dynamics is defined via non separable Ordinary Differential Equations (ODEs) in contrast to the Euclidean case. It implies unavoidable bias in existing generalization of HMC to Riemannian manifolds. In this paper, we propose a new filter step, called "involution checking step", to address this problem. This step is implemented in two versions of BHMC, coined continuous BHMC (c-BHMC) and numerical BHMC (n-BHMC) respectively. Our main results establish that these two new algorithms generate reversible Markov chains with respect to \(\) and do not suffer from any bias in comparison to previous implementations. Our conclusions are supported by numerical experiments where we consider target distributions defined on polytopes.

## 1 Introduction

Markov Chain Monte Carlo (MCMC) methods is one of the primary algorithmic approaches to obtain approximate samples from a target distribution \(\). They have been successively applied over these past decades in a large panel of practical settings, (Liu & Liu, 2001). In particular, gradient-based MCMC methods have shown their efficiency and robustness in high-dimensional settings, and come nowadays with strong theoretical guarantees, (Dalalyan, 2017; Durmus & Moulines, 2017). However, they still struggle in facing the case where the target distribution is supported on a _constrained_ subset \(\) of \(^{d}\), (Gelfand et al., 1992; Pakman & Paninski, 2014; Lan & Shahbaba, 2015). Yet, this problem appears in various fields; see e.g., (Morris, 2002; Lewis et al., 2012; Thiele et al., 2013) with some important applications in computational statistics and biology.

Drawing samples from such distributions is indeed a challenging problem that has been intensively studied in the literature, (Dyer & Frieze, 1991; Lovasz & Simonovits, 1993; Lovasz & Kannan, 1999; Lovasz & Vempala, 2007; Brubaker et al., 2012; Cousins & Vempala, 2014; Pakman & Paninski, 2014; Lan & Shahbaba, 2015; Bubeck et al., 2015). In particular, some recent extensions of thepopular Metropolis-Hastings (MH) algorithm to constrained spaces consist in designing proposals based on dynamics for which \(\) is invariant, (Zappa et al., 2018; Lelievre et al., 2019, 2022). In practice, the corresponding solutions are numerically integrated based on implicit and symplectic schemes, which however come with additional difficulties. As first observed by Zappa et al. (2018), an additional "involution checking step" in the usual MH filter is necessary to ensure that the resulting Markov kernel admits \(\) as a stationary distribution.

In this paper, we aim at generalizing this family of methods by taking into account the geometry of the constrained subspace, building on the Riemannian Manifold Hamiltonian Monte Carlo (RMHMC) algorithm introduced by Girolami and Calderhead (2011). Similarly to HMC, (Duane et al., 1987; Neal et al., 2011; Betancourt, 2017), RMHMC aims to target a positive distribution \(\) on \(^{d}\) and relies on the integration of a canonical Hamiltonian equation. In contrast, RMHMC incorporates some _geometrical_ information in the definition of the Hamiltonian via a Riemannian metric \(\) on \(^{d}\). When considering applications of RMHMC to a convex, open and bounded subset \(\), a natural choice for this metric is the Hessian metric associated with a self-concordant barrier on \(\), (Nesterov and Nemirovskii, 1994), as suggested by Kook et al. (2022). We adopt here the same approach and now focus on a constrained subspace \(\) which is assumed to be equipped with an appropriately designed "self-concordant" metric, (Nesterov and Nemirovskii, 1994).

Given this setting, we propose the BHMC (Barrier HMC) algorithm. To the best of our knowledge, this is **the first version of RMHMC incorporating an "involution checking step"** to assess the issue of asymptotic bias arising from the use of implicit integration methods to solve the Hamiltonian dynamics. In this work, we focus on the _numerical_ version of BHMC (n-BHMC), for which we provide a numerical implementation. We refer to Appendix D for an introduction to the ideal version of BHMC, called _continuous_ BHMC (c-BHMC), where it is assumed that we have access to the continuous Hamiltonian dynamics but which cannot be computed in practice. For each algorithm, we rigorously prove that the associated Markov chain preserves \(\).

The rest of the paper is organized as follows. In Section 2, we introduce our sampling framework and review some background on self-concordance and Riemannian geometry. In Section 3, we present n-BHMC, and derive theoretical results for this algorithm in Section 4. We review related works in Section 5 and provide numerical experiments for n-BHMC in Section 6.

Notation.For any \(f^{3}(^{d},)\), we denote by \(Df\) (and \(D^{2}f\)) the Jacobian (resp. the Hessian) of \(f\). For any \(^{d d}\) and any \((x,y)^{d}^{d}\), we denote by \(:D^{3}f(x)\) the vector \(((^{}\{D^{3}f(x)\}_{i}))_{i[d]}^{d}\), and define \(D^{3}f(x)[x,y]\) as the vector \(x^{}D^{3}f(x)y^{d}\). For any positive-definite matrix \(^{d d}\), \(,_{}\) stands for the scalar product induced by \(\) on \(^{d}\), defined by \( x,y_{}= x,y\). The "momentum reversal" operator \(s:\,^{d}^{d}^{d}^{d}\) is defined for any \((x,p)^{d}^{d}\) by \(s(x,p)=(x,-p)\). Let \(\), \(\) be two sets and \(h:\,^{}\), where \(^{}\) is the set of sets \(\). We say that \(h\) is a set-valued map. Note that any map \(g:\) can be extended to a set-valued map by identifying, for any \(x\), \(g(x)\) and \(\{g(x)\}\). Let \(f: 2^{}\). We define \(f h:\, 2^{}\) for any \(x\) by \(f h(x)=_{y h(x)}f(y)\), where by convention \(_{}=\). For any topological space \(\), we denote \(()\) its Borel sets. For any probability measure \(()\) and measurable map \(:\), we denote \(_{\#}()\) the pushforward of \(\) by \(\). In general, we will equivalently denote by \(z\) or \((x,p)\) a state of the Hamiltonian system.

## 2 Setting and Background

In this paper, we consider an open subset \(^{d}\), and we aim at sampling from a target distribution \(\) given for any \(x\) by

\[(x)/x=[-V(x)]/Z\,\]

where \(V^{2}(,)\) and \(Z=_{}[-V(x)]x\). We view \(\) as an embedded \(d\)-dimensional submanifold of \(^{d}\), equipped with a metric \(\), satisfying the following assumptions.

1. \(\) _is an open convex bounded subset of \(^{d}\)._
2. _There exists_ \(\)_, a_ \(\)_-regular and_ \(\)_-self-concordant barrier on_ \(\) _such that_ \(=D^{2}\)_._

We provide in Section 2.1 basic Riemannian facts along with the definition of the Hamiltonian dynamics of RMHMC and introduce self-concordance and \(\)-regularity in Section 2.2.

### Riemannian Manifold Hamiltonian dynamics

Basics on Riemannian geometry.Let \(\) be a \(d\)-dimensional smooth manifold, endowed with a metric \(\). Denoting by \(x\) a dual coframe, (Lee, 2006, Lemma 3.2.), we recall that the _Riemannian volume element_ corresponding to \((,)\) is given in local coordinates by

\[_{}(x)=)}x\.\]

We denote by \(^{}_{x}\) the dual of the tangent space at \(x\), _i.e._, the cotangent space. For any \(x\), \(^{}_{x}\) is a vector space naturally endowed with the scalar product \((,)_{(x)^{-1}}\), (Mok, 1977). We recall that the cotangent bundle \(^{}\) is defined by \(^{}=_{x}\{x\}^{ }_{x}\). This set is a \(2d\)-dimensional manifold endowed with a Riemannian metric \(^{}\) given by Mok (1977), inherited from \(\). With this metric, the volume form on \(^{}\) does not depend on \(\) anymore, and satisfies for any \((x,p)^{}\)

\[_{^{}}(x,p)=x p\ \,\]

where \(xp\) is a dual coframe for \(^{}\).

Therefore, under \(1\), identifying \(^{}\) with \(^{d}\), the volume form on \(^{}\) induced by \(^{}\) is the Lebesgue measure of \(^{d}^{d}\) restricted to \(^{}\). Despite adopting at first a Riemannian perspective on \(\), we actually recover the Euclidean setting on \(^{}\), which motivates us to consider \(^{}\) as our sampling space. We refer to Appendix B for details on the cotangent bundle and its metric \(^{}\).

Hamiltonian dynamics.Note that with the previously introduced notation, \(\) can be expressed as

\[/_{}(x)=[-V(x)- (((x)))]/Z\.\]

This motivates the introduction of the following Hamiltonian on \(^{}\)

\[H(x,p)=V(x)+((x))+ \|p\|_{(x)^{-1}}^{2}\.\] (1)

In this definition, we notably take into account the scalar product \((,)_{(x)^{-1}}\) on \(^{}_{x}\). Finally, we consider the joint distribution \(\) on \(^{}\)

\[(x,p)=(1/)[-H(x,p)]_{ ^{}}(x,p)\,\] (2)

where \(=_{^{}}[-H(x,p)] _{^{}}(x,p)\), for which the first marginal is \(\). Indeed, for any \((,)\), we have

\[_{^{}}(x)(x,p){=}_ {^{}}(x)(x)_{x}(p;0, )p=_{}(x)(x)\,\]

where we denote by \(_{x}(0,_{d})\) the centered standard Gaussian distribution w.r.t. \(\|\|_{(x)^{-1}}\). The Hamiltonian dynamics for \(H\) is given by the coupled Ordinary Differential Equations (ODEs)

\[=_{p}H(x,p)\,=-_{x}H(x,p)\,\] (3)

where the derivatives of \(H\) can be computed explicitly as

\[_{p}H(x,p)=(x)^{-1}p\,_{x}H(x,p)=-D (x)[(x)^{-1}p,(x)^{-1}p]+L(x)\,\]

where \(L(x)= V(x)+(x)^{-1}:D(x)\).

### Self-concordance and regularity

Until now, we have considered an arbitrary Riemannian metric \(\). In the rest of this work, we focus on metrics given by Hessian of self-concordant barriers.

Self-concordance.We first introduce self-concordant barriers, a family of smooth convex functions which are well-suited for minimization by the Newton method.

**Definition 1** (Nesterov & Nemirovskii (1994)).: _Let \(\) be a non-empty open convex domain in \(^{d}\). A function \(:\) is said to be a \(\)-self-concordant barrier (with \( 1\)) on \(\) if it satisfies:_

1. \(^{3}(,)\) _and_ \(\) _is convex,_
2. \((x)+\) _as_ \(x\)_,_
3. \(|D^{3}(x)[h,h,h]| 2\|h\|_{(x)}^{3}\)_, for any_ \(x\)_,_ \(h^{d}\)_,_
4. \(|D(x)[h]|^{2}\|h\|_{(x)}^{2}\)_, for any_ \(x\)_,_ \(h^{d}\)_,_

_where \((x)=D^{2}(x)\)._

Balls for \(\|\|_{(x)}\), called Dikin ellipsoids, are key for the study of self-concordance, see Appendix C.

Regularity.The property of \(\)-regularity for some \( 1\) is shared by many self-concordant barriers, including logarithmic and quadratic programming barriers. It ensures stability for interior point polynomial-time methods. Definition and properties of \(\)-regularity are recalled in Appendix C.

Example of the polytope.Let us assume that \(\) is the polytope \(=\{x:x<b\}\), where \(^{m d}\) and \(b^{m}\). We endow it with the Riemannian metric \((x)=D^{2}(x)\) where \(:\) is the logarithmic barrier given for any \(x\) by \((x)=-_{i=1}^{m}(b_{i}-_{i}^{}x)\). The barrier \(\) is both a \(m\)-self-concordant barrier and a \(2\)-regular function, (Nesterov and Nemirovski, 1998, page 3). Moreover, we have for any \(x\), \((x)=^{}S(x)^{-2}\), where \(S(x)=(b_{i}-_{i}^{}x)_{i[m]}\). We provide in Figure 1 an illustration of this barrier.

## 3 The n-BHMC algorithm

In practice, it is not possible to _exactly_ compute the Riemannian Hamiltonian dynamics (3). We thus introduce a _numerical_ version of BHMC (n-BHMC), in which we replace the continuous ODE integration by a symplectic numerical scheme. We first define the Hamiltonian integrators used in n-BHMC in Section 3.1 and provide details on the different steps of our algorithm in Section 3.2.

### Hamiltonian integrators of n-BHMC

In the same spirit as Shahbaba et al. (2014), we first rewrite the Hamiltonian \(H\) given in (1) as \(H=H_{1}+H_{2}\), where we highlight the non separable aspect of \(H\) in \(H_{2}\), _i.e._, for any \((x,p)^{}\)

\[H_{1}(x,p)=V(x)+((x))\, H_{2}(x,p)= \|p\|_{(x)^{-1}}^{2}\.\]

Therefore, we have

\[_{x}H_{1}(x,p) = V(x)+(x)^{-1}:D(x)\, _{p}H_{1}(x,p) =0\,\] (4) \[_{x}H_{2}(x,p) =-D(x)[(x)^{-1}p,(x)^{-1}p]\, _{p}H_{2}(x,p) =(x)^{-1}p\.\] (5)

Leveraging the separable structure of \(H_{1}\), we now define an implicit scheme to discretize the Hamiltonian dynamics (3) by _splitting_ it into the Hamiltonian dynamics (4) and (5). In the rest of this section, we consider some step-size \(h\).

Explicit integrator of \(H_{1}\).We first approximate the dynamics (4) on a step-size \(h/2\) using a first-order Euler method (Hairer et al., 2006, Theorem VI.3.3.). Since \(H_{1}\) is separable, this integrator simply reduces to the map \(_{h/2}:^{}^{}\) defined by

\[_{h/2}(x,p)=(x,p-_{x}H_{1}(x,p))\.\]

We have: (i) \(_{h/2}(^{})^{} \), (ii) \(_{h/2}\) is symplectic (we refer to Appendix F for more details on symplecticity), (iii) \(_{-h/2}_{h/2}=\) and (iv) \(_{-h/2}=s_{h/2} s\). Note that \(s_{h/2}\) is an involution on \(^{}\), which inherits from properties (i) and (ii) of \(_{h/2}\).

Implicit integrator of \(H_{2}\).Since \(H_{2}\) is not separable, a common discretization scheme such as the Euler method is not symplectic anymore, which requires to use an implicit method instead. We thus approximate these dynamics on a step-size \(h\) with a symplectic second-order integrator denoted by \(_{h}\). For theoretical purposes, we focus on the Stormer-Verlet scheme, (Hairer et al., 2006, Theorem VI.3.4.), also known as the _generalized Leapfrog_ integrator, which is widely used in geometric integration, (Girolami and Calderhead, 2011; Betancourt, 2013; Cobb et al., 2019; Brofos and Lederman, 2021). We refer to Appendix F for a discussion on other numerical schemes. For any \(z^{(0)}^{}\), \(_{h}(z^{(0)})^{}\) consists of points \(z^{(1)}=(x^{(1)},p^{(1)})\) which are solution of

\[p^{(1/2)} =p^{(0)}-_{x}H_{2}(x^{(0)},p^{(1/2)})\,\] \[x^{(1)} =x^{(0)}+[_{p}H_{2}(x^{(0)},p^{(1/2)})+ _{p}H_{2}(x^{(1)},p^{(1/2)})]\,\] \[p^{(1)} =p^{(1/2)}-_{x}H_{2}(x^{(1)},p^{(1/2)})\.\] (6)

Figure 1: A polytope \(^{2}\) with three Dikin ellipsoids \(\{y^{d}\,:\,y^{}(x)y<1\}\) derived from its logarithmic barrier.

As defined, there is no guarantee that (6) admits a (unique) solution. As a matter of fact, the integrator \(_{h}\) can be seen as a set-valued map. Moreover, it is easy to check that: (i) \(_{h}(^{}) 2^{^{} }\), (ii) \(_{-h}=s_{h} s\), since \(_{p}H_{2}(s(z))=-_{p}H_{2}(z)\) and \(_{x}H_{2}(s(z))=_{x}H_{2}(z)\), and (iii) if \(|_{h}(z)|>0\) then \(z(_{-h}_{h})(z)\).

Implicit integrator of \(H\).Relying on the integrators \(_{h/2}\) and \(_{h}\) previously defined, we now explain how we approximate the Hamiltonian dynamics (3) on a step-size \(h\). We first define the set-valued maps \(_{h}:^{} 2^{^{} }\) and \(_{h}:^{} 2^{^{} }\) by

\[_{h}=_{h} s\,_{h}=(s_{h/ 2})_{h}(s_{h/2})\.\]

Using properties (ii) and (iii) of \(_{h}\), we have for any \(z^{}\) such that \(|_{h}(z)|>0\), \(z(_{h}_{h})(z)\), and for any \(z^{}^{}\) such that \(|(_{h} s_{h/2})(z^{})|>0\), we have \(z^{}(_{h}_{h})(z^{})\). Thus, \(_{h}\) and \(_{h}\) are _involutive_ in the sense of set-valued maps. Note also that \(s_{h}=_{h/2}_{h}_{h/2}\) boils down to the _Strang splitting_(Strang, 1968) of the dynamics (3) and thus, is a symplectic scheme approximating the dynamics of Hamiltonian \(H\) on a step-size \(h\).

Numerical integrators.In practice, we do not have access to \(_{h}\) but approximate it with a _numerical map_\(_{h}\). For clarity's sake, we denote by \(_{_{h}}^{}\) the domain of this integrator with \(_{h}(_{_{h}})^{}\). In practice, \(_{_{h}}\) corresponds to the set of points for which the numerical integration of \(_{h}\) outputs a solution. We also approximate \(_{h}\) with the _numerical map_\(_{h}^{}:(s_{h/2})(_{_{h}}) ^{}^{}\)

\[_{h}^{}=(s_{h/2})_{h}(s _{h/2})\.\]

Similarly to \(s_{h}\), \(s_{h}^{_{h}}\) approximates the dynamics of Hamiltonian \(H\) on a step-size \(h\). In our experiments, we design \(_{h}\) using a fixed-point solver with a given number of iterations following Brofos & Lederman (2021, 2020). We refer to Appendix K for details on computations of \(_{h}\).

### Steps of the algorithm

For any \(z=(x,p)^{}\), we define on \(^{}\) the norm \(\|\|_{z}\) by

\[\|(x^{},p^{})\|_{z}=\|x^{}\|_{(x)}+\|p^{} \|_{(x)^{-1}}\,(x^{},p^{})^{} \,\] (7)

where \(\|\|_{(x)^{-1}}\) is the canonical norm on \(^{}_{}\) induced by the Riemannian metric \(\) (see Section 2.1) and \(\|\|_{(x)}\) is the common norm used on \(\) to study properties of self-concordance (see Section 2.2). As defined, this norm will be crucial to correct the bias of the numerical integration in n-BHMC, presented in Algorithm 1, for which we are now ready to detail the steps.

Steps 1 and 5: applying a momentum update.Assume that the current state at stage \(n 1\) is \((X_{n-1},P_{n-1})^{}\). Then, the momentum is first partially refreshed such that \(_{n}P_{n-1}+G_{n}\), where \(G_{n}_{x}(0,_{d})\) is independent from \(P_{n-1}\). This update is applied both at the beginning and the end of the iteration, similarly to Lelievre et al. (2022).

Step 2: solving a discretized version of ODE (3).Starting from \((X^{}_{n},P^{}_{n})=(X_{n-1},_{n})\), we now approximate the dynamics of \(H\) on a step-size \(h\) with the integrators presented in Section 3.1, while ensuring that the proposal state belongs to \(^{}\). We proceed as follows:

1. We first run the _explicit_ integrator \(_{h/2}\) and compute \(Z^{(0)}_{n}=(s_{h/2})(X_{n-1},_{n})\).

2. If \(Z^{(0)}_{n}_{_{h}}\), then \((X^{}_{n},P^{}_{n})\) is not updated and we directly go to Step 3. Otherwise, we define \(Z^{(1)}_{n}=_{h}(Z^{(0)}_{n})\). To ensure the reversibility of this step, we then perform an "involution checking step", (Zappa et al., 2018; Lelievre et al., 2019), highlighted in yellow in Algorithm 1, _i.e._, we verify (a) \(Z^{(1)}_{n}_{_{h}}\) and (b) \(Z^{(0)}_{n}=_{h}(Z^{(1)}_{n})\). In practice, we replace condition (b) by combining an explicit tolerance threshold \(\) with the norm defined in (7) and accept the proposal if

\[\|Z^{(0)}_{n}-_{h}(Z^{(1)}_{n})\|_{Z^{(0)}_{n}}+\|Z^{(0)}_{n}-_{h}(Z^{(1) }_{n})\|_{_{h}(Z^{(1)}_{n})}\.\] (8)

We discuss the choice of this norm to perform the "involution checking step" in Appendix K. If both of these conditions are satisfied, we finally set \((X^{}_{n},P^{}_{n})=(s_{h/2})(Z^{(1)}_{n})\), to ensure the reversibility of the update of \((X^{}_{n},P^{}_{n})\). Otherwise, \((X^{}_{n},P^{}_{n})\) is not updated and we go to Step 3.

**Step 3: computing the acceptance filter.** We denote by \(a(x^{},p^{}|x,p)\) the acceptance probability to move from \((x,p)^{*}\) to \((x^{},p^{})^{*}\), which is given by

\[a(x^{},p^{}|x,p)=1[-H(x^{},p^{})+H(x,p)]\.\] (9)

After Step 2, we perform a simple MH filter by accepting the proposal with probability \(A_{n}=a(X^{}_{n},P^{}_{n}|X_{n-1},_{n})\) similarly to a classical HMC algorithm.

Step 4: applying momentum reversal.To ensure a move along the dynamics of \(H\) with step-size \(h\), we reverse the momentum after the acceptance step. Indeed, if the acceptance filter is successful, then \((X_{n},_{n})=(s^{}_{h})(X_{n-1},_{n-1})\) approximates the Hamiltonian dynamics (3) on a step-size \(h\) starting at \((X_{n-1},_{n-1})\), as seen in Section 3.1. Otherwise, \((X_{n},_{n})=(X_{n-1},-_{n-1})\).

### About the usefulness of the "involution checking step"

In their paper, Kook et al. (2022) also incorporate self-concordance into RMHMC to sample from distributions supported on polytopes. To integrate the Hamiltonian dynamics, they propose to use a numerical version of the _Implicit Midpoint integrator_(Hairer et al., 2006, Theorem VI.3.5.), which shares the same theoretical properties as the Stormer-Verlet scheme. This results in CRHMC (Kook et al., 2022, Algorithm 3), whose main difference compared to n-BHMC is the lack of the "involution checking step" (Line 8 in Algorithm 1). Crucially, **Kook et al. (2022) assume that their implicit integrator admits a unique solution** given any starting point and any step-size \(h\), which is then approximated by their numerical scheme. However, this statement may not be true in the self-concordant setting, as we explain below with a simple example. This explains why we always refer to the implicit integrator as a _set-valued map_. In their setting, the numerical integrator is not guaranteed to be involutive, which results in an asymptotic bias that the MH filter cannot solve.

In our paper, we do not make such an assumption on the Stormer-Verlet integrator, and consider a numerical solver which outputs _one_ approximate solution to this implicit scheme. By doing so, our analysis is meant to be as close as possible to the practical implementation of RMHMC. Then, the "involution checking step" is critical to make the numerical integrator locally involutive, which enables us to derive rigorous reversibility results, see Theorem 3, and to solve the issue of asymptotic bias caused by implicit integration, see Section 6. We refer to Appendix J for a detailed comparison between n-BHMC and CRHMC. We now present a simple setting where the assumption made by Kook et al. (2022) does not hold in the case of the Stormer-Verlet integrator, which is defined in (6).

Consider the 1-dimensional setting \(=(-,0)\) with \(:x 1/x^{2}\). Assume that \(=1\). Let \(h>0\) and let \(X_{0}\) be the (position) state of the Markov chain at the beginning of the first iteration in n-BHMC. In this case, \(_{0}(0,1/X_{0}^{2})\) and we have \(P_{0}^{(0)}=_{0}-(h/2)_{x}H_{1}(X_{0},_{0})\), where the function \(H_{1}\) is defined in Section 3.1. Using (4), we have \(P_{0}^{(0)}(_{0},1/X_{0}^{2})\), where\(_{0}=-(h/2)_{x}H_{1}(X_{0},_{0})\) only depends on \(X_{0}\). Then, the implicit equation in \(P_{0}^{(1/2)}\), given by the first equation of (6), reads as \(P_{0}^{(1/2)}=P_{0}^{(0)}-(h/2)_{x}H_{2}(X_{0},P_{0}^{(1/2)})\). Using (5), it can be rewritten as a polynomial equation of degree 2 in \(P_{0}^{(1/2)}\)

\[X_{0}(P_{0}^{(1/2)})^{2}+P_{0}^{(1/2)}-P_{0}^{(0)}=0.\] (10)

Denote \(=1+2hX_{0}P_{0}^{(0)}\). Then, (10) may admit 0,1 or 2 solutions depending on the sign of \(\). If \(P_{0}^{(0)}-1/(2hX_{0})\), _i.e._, \( 0\), then (10) admits 1 or 2 solutions. However, if \(h\) is small enough, only one solution is valid when considering the constraint on the position update in (6). Whenever \(P_{0}^{(0)}>-1/(2hX_{0})\), _i.e._, \(<0\), (10) admits no solution. Recalling that \(P_{0}^{(0)}(_{0},1/X_{0}^{2})\), this event occurs with positive probability, thus violating the assumption made by Kook et al. (2022).

## 4 Theoretical results

We now study the reversibility of n-BHMC with respect to the target distribution. To do so, we first present theoretical results on the _exact_ integrators of the discretized Hamiltonian dynamics in Section 4.1, from which we derive our assumption on the numerical integrator used in n-BHMC. Finally, we state our main result on n-BHMC in Section 4.2.

### From implicit to numerical integrators

We show in Proposition 2 that even though \(_{h}\) is a _set-valued_ map, it can _locally_ be identified with a \(^{1}\)-diffeomorphism. In a manner akin to Lelievre et al. (2022), this justifies our assumption **A3** that the _numerical_ map \(_{h}\) used to approximate \(_{h}\) in Step 2 of Algorithm 1 is _locally_ a \(^{1}\)-involution.

**Proposition 2**.: _Assume_ **A1**_,_ **A2**_. Let \(z^{(0)}^{}\), then there exists \(h^{}>0\) (explicit in Appendix G) such that for any \(h(0,h^{})\), there exist \(z_{h}^{(1)}_{h}(z^{(0)})\), a neighborhood \(^{}\) of \(z^{(0)}\) and a \(^{1}\)-diffeomorphism \(_{h}:_{h}()^{} \) with_

1. \(_{h}(z^{(0)})=z_{h}^{(1)}\) _and_ \(|(_{h})|=1\)_._
2. \(_{h}(z)\) _is the only element of_ \(_{h}(z)\) _in_ \(_{h}()\) _for any_ \(z\)_._

Proposition 2 shows that while \(_{h}\) can take multiple (or none) values on \(^{}\), for any \(z^{(0)}^{}\), there exists \(h\) small enough and a neighborhood \(\) of \(z^{(0)}\) such that the set-valued map \(_{h}\) is locally symplectic on \(\). The proof of Proposition 2 is given in Appendix G. It first relies on considering the Stormer-Verlet scheme introduced in (6) as the composition of maps for which we derive the existence of solutions and secondly applying the implicit function theorem on these maps. Motivated by this result on the _implicit map_\(_{h}\) and the fact that for any \(z^{}\) with \(|_{h}(z)|>0\), \(z_{h}_{h}(z)\) (see Section 3.1), we make the following assumption on the _numerical map_\(_{h}\).

**A3**.: _There exists \((0,1)\) s.t. for any \(z^{(0)}^{}\), there exists \(h_{}>0\) and for any \(h(0,h_{})\)_

1. \(=_{\|\|_{2,}(z^{(0)}, r^{}(x^{(0)})) _{_{h}}}\)_,_
2. \(_{h}^{1}(,^{})\) _and_ \(_{h}_{h}=\) _on_ \(\)_,_

_with \(r^{}:(0,+)\) depending only on \(\) and defined in Appendix I._

Assumption **A3** can be thought as a strengthening of Proposition 2-(a), where (i) \(h_{}\) refers to \(h^{}\), and (ii) B and \(_{h}\) correspond to _explicit_ versions of \(\) and \(_{h}\). We conjecture that the involution condition in **A3**-(b) could in fact be replaced by the condition that for any \(z\), \(_{h}(z)_{h}(z)\), in a manner akin to Lelievre et al. (2022). We leave this study for future work.

### Reversibility results

Beyond n-BHMC.While Algorithm 1 can be implemented practically, it cannot be easily analysed under **A1**, **A2** and **A3**. The main reason for this limitation is that the self-concordance properties are defined locally, whereas deriving reversibility results require global control. In particular, we cannot ensure that \(_{h}\) is locally an involution around \(z^{(0)}\) if \(h>h_{}\). To circumvent this issue, we enforce a condition on \(h\) to be small enough in n-BHMC. Using the notation from **A3**, we define the set

\[_{h}=\{z^{}\ :\ h<_{_{ \|\|_{2}}(z,1)}h_{}()\}_{_{h}}\.\]Let \(z^{(0)}_{h}\). By 3, we know that \(_{h}\) is an involution on a neighbourhood of \(z^{(0)}\); in particular, it comes that \((_{h}_{h})(z^{(0)})=z^{(0)}\). Hence, the condition (b) of the "involution checking step" in Algorithm 1 is _de facto_ satisfied. This naturally leads to replace "\(Z^{(1)}_{n}_{_{h}}\)", _i.e._, the condition (a) of the "involution checking step", by the more restrictive condition "\(Z^{(1)}_{n}_{h}\)", as presented in Algorithm 3 (see Appendix H), for which we are able to derive a reversibility result.

We denote by \(:^{*}(^{*}) \), the transition kernel of the (homogeneous) Markov chain \((X_{n},P_{n})_{n}\) obtained with Algorithm 3. We now state our main result on n-BHMC.

**Theorem 3**.: _Assume 1, 2, 3. Then, \(\) is reversible up to momentum reversal, i.e., we have for any \(f(^{*}^{*},)\) with compact support_

\[_{^{*}^{*}}f(z,z^{}) (z)(z,z^{})=_{^{*} ^{*}}f(s(z^{}),s(z))(z)(z,z^{})\.\]

_In particular, \(\) is an invariant measure for \(\)._

Proof.: We provide here a sketch of the proof, technical details being postponed to Appendix I. The reversibility (up to momentum reversal) of the momentum update is straightforward. To establish the reversibility up to momentum reversal of the _numerical_ Hamiltonian integration step, we cover the compact support of \(f\) with a finite family of open balls with respect to the metric \(\). Combining 2 and 3, we show that \(_{h}\) is a volume-preserving \(^{1}\)-diffeomorphism on each one of these sets. We then conclude upon combining this result with the fact that \(_{h}^{} s_{h/2}=s_{h/2} _{h}\). 

Although Algorithm 3 may be implemented, this would come with a huge (and unrealistic) computational cost since verifying that \(z_{h}\) implies to find the minimal critical step-size \(h_{*}\) on a neighborhood of \(z\). The question of the existence of a global step-size \(h\) such that Algorithm 1 can be properly analyzed is not the topic of this paper and is left for future work.

Comparison with Theorem 8 in Kook et al. (2022).Although Kook et al. (2022) present a theoretical result similar to Theorem 3, we claim that _their statement is not correct_. Indeed, the authors make a critical confusion between the _ideal_ integrator as considered in Hairer et al. (2006) and the _numerical_ version they implement. Then, in the proof of reversibility for their scheme, they act as if the two algorithms were the same while it is not true (see Appendix J for further details). On the other hand, (i) we make a clear distinction between the ideal integrator and its _numerical_ implementation (see Section 3.1), and (ii) implement the "involution checking step" to enforce reversibility (Line 8 in Algorithm 1).

## 5 Related work

Sampling on manifolds.Traditional _constrained_ sampling methods in Euclidean spaces include the Hit-and-Run algorithm (Lovasz and Vempala, 2004), the Random Walk Metropolis-Hastings (RWMH) algorithm, also referred to as Ball Walk (Lee and Vempala, 2017), and HMC, (Duane et al., 1987). However, it has been empirically demonstrated that RWMH and HMC require small step-sizes in order to correctly sample from a target distribution \(\) over a _submanifold_\(^{d}\), thus resulting in poor mixing time (Girolami and Calderhead, 2011, Figures 1 and 3). In the specific case where \(=\{x^{d}\ :\ c(x)=0\}\) for some \(c:^{d}^{m}\), Brubaker et al. (2012) combine HMC with the RATTLE integrator (Leimkuhler and Skeel, 1994), incorporating the constraints of \(\) in the Hamiltonian dynamics via Lagrange multipliers. Girolami and Calderhead (2011) adopt an original approach by endowing \(\) with a Riemannian metric \(\) and propose RMHMC (Riemannian Manifold HMC), a version of HMC where the Hamiltonian depends on \(\) as in (1). It consists of integrating the Hamiltonian dynamics of (3) on short-time steps using the generalized Leapfrog integrator (6) and the acceptance filter defined in (9). This method does not include an "involution checking step", and thus the reversibility of the algorithm cannot be ensured in practice and in theory. Similarly, Byrne and Girolami (2013) propose to design a numerical integrator for RMHMC using geodesics.

Choice of the metric in RMHMC.There are various ways to design a _meaningful_ metric \(\) given a submanifold \(\). In a Bayesian perspective, Girolami and Calderhead (2011) aim at computing the _a posteriori_ distribution of a statistical model of interest and thus choose \(\) to be the Fisher-Rao metric. In this paper, we consider another approach which exploits the _geometrical_ structure of \(\). For instance, one can always define a self-concordant barrier \(\) when \(\) is a convex body, (Nesterov and Nemirovskii, 1994), and choose \(=D^{2}\), as done by Kook et al. (2022).

Self-concordance in RMHMC.Elaborating on Riemannian geodesics, Lee & Vempala (2018) provide theoretical guarantees of fast mixing time for RMHMC when (i) \(\) is a polytope, and (ii) \(\) is the Hessian of a self-concordant function \(\) (as in our setting). Their result notably improves the complexity of uniform polytope sampling from algorithms relying on self-concordance such as the Dikin Walk (Kannan & Narayanan, 2009) and the Geodesic Walk (Lee & Vempala, 2017b). However, they only consider the case where the _exact_ continuous Hamiltonian dynamics is used, as in c-BHMC (see Appendix D). On the other hand, Kook et al. (2022) integrate the Hamiltonian dynamics via implicit schemes without any "involution checking step" in a similar self-concordant setting. In particular, they consider a convex body \(\) equipped with a self-concordant barrier \(\), combined with a linear equality constraint \(x=b\). This is a special case of our framework (see **A**1 and **A**2) by rewriting this whole set as \(^{}=\{^{}b+u\,:\,\,u()\}\)3, equipped with the self-concordant barrier \(u(^{}b+u)\). Besides this, Kook et al. (2022) provide an efficient implementation of their algorithm (CRHMC) in the case of a convex bounded manifold of the form \(=\{x^{d}\,:\,x=b,<x<u\}\). Although CRHMC demonstrates empirical fast mixing time, we show in Section 6 that it suffers from an asymptotic bias. More recently, Kook et al. (2022) built upon the empirical results of Kook et al. (2022) to derive theoretical results of fast mixing time. However, they do not question the issue of asymptotic bias in CRHMC.

Enforcing reversibility.Zappa et al. (2018) propose a version of RWMH including projection steps after each proposal. To our knowledge, they are the first to practice "involution checking" of the proposal, and thus _enforce the reversibility_ of the Markov chain with respect to \(\). Lelievre et al. (2019) notably combine this method with the discretization suggested by Brubaker et al. (2012) to also _enforce the constraints_ of the manifold. Lelievre et al. (2022) elaborate on this framework, by designing a symplectic numerical integrator with multiple possible outputs, and provide a rigorous proof of reversibility. Note that it only applies when \(\) is induced by the flat metric of \(^{d}\) and therefore cannot be combined with our approach as such.

## 6 Numerical experiments

In our experiments4, we illustrate the performance of n-BHMC (Algorithm 1) to sample from target distributions which are supported on polytopes. We compare our method with the numerical implementation of CRHMC5 provided by Kook et al. (2022). In all of our settings, we compute \(\) as the Hessian of the logarithmic barrier, see Section 2.2. The algorithms are always initialized at the center of mass of the considered polytope. At each iteration of n-BHMC, we perform one step of numerical integration, using the Stormer-Verlet scheme with \(K=30\) fixed-point steps and keep the refresh parameter \(\) equal to 1. We refer to Appendix K for more details on the setting of our experiments and additional results.

Synthetic data.We first consider the problem of sampling from the truncated Gaussian distribution

\[(/)(x)=[-\|x-\|^{2}/2] _{}(x)/_{}[-\|-\| ^{2}/2], x^{d}\,\]

where \(\) is the hypercube or the simplex, and \(^{d}\) is defined by

\[=(10/)\{-e_{1}+(-1)e_{2}\}\,\]

where \(e_{i}\) stands for the \(i\)-th canonical vector of \(^{d}\) and \(=_{i=1}^{d}e_{i}\). In particular, \(_{1}=0\), \(_{2}=10\) and \(_{j}=_{2}/\) for any \(j\{3,,d\}\). Therefore, the mass of \(\) is not evenly distributed on the boundary of \(\), which is key to observe the impact of the reversibility condition. For this experiment, we consider the low-dimensional setting \(d\{5,10\}\). To sample from \(\), we run 10 times the algorithms CRHMC and n-BHMC for \(N=10^{5}\) iterations, and update the step-size \(h\) such that the average acceptance rate in the MH filter is roundly equal to 0.5, following Roberts & Rosenthal (2001). We discuss the setting of the tolerance parameter \(\) for n-BHMC in Appendix K. In order to correctly assess the bias of each numerical method, we aim at accurately computing the target quantity \(Q=_{}\! x,_{2}(x)\). Although our choice of \(Q\) is arbitrary, it highlights well the bias in CRHMC, which is corrected when using n-BHMC.

Real-world data.We then consider 10 polytopes given in the COBRA Toolbox v3.0 (Heirendt et al., 2019), which model molecular systems, and follow the method provided in (Kook et al., 2022a, Appendix A) to pre-process them. Here, we aim at uniformly sampling from these polytopes. However, we do not have access to a realistic baseline that yields an unbiased estimator, since the sampling dimension is too high and running MALA or IMH would be too costly. Hence, instead of assessing the bias of the algorithms, we rather want to highlight that the "involution checking step" does not hurt the convergence properties of BHMC compared to CRHMC. We evaluate the efficiency of the algorithms by computing _the sampling time per effective sample_ (in seconds), defined as the total sampling time until termination divided by the Effective Sample Size. We set the initial step-size to 0.01 for both algorithms and \(=10\) in n-BHMC. We then follow the exact same procedure as in (Kook et al., 2022a, Table 1) by drawing 1000 uniform samples with limit on running time set to 1 day. Results are given in Table 1. For each molecular model, we specify by NNZ the number of non-zero entries in the matrix \(A\) defining the corresponding pre-processed polytope, which thus reflects its complexity. In particular, the sampling dimension \(d\) corresponds to the number of columns of \(A\). Note that the sampling time values are not of interest in themselves, but are only meant to compare CRHMC and n-BHMC. While it is clear that adding an "involution checking step" implies a trade-off between accuracy and complexity of the method, our results demonstrate that it does not penalize BHMC in the considered settings, and may even make it more efficient in some cases.

## 7 Discussion

In this paper, we introduced a novel version of RMHMC, Barrier HMC (BHMC), which addresses the problem of sampling from a distribution \(\) over a constrained convex subset \(^{d}\) equipped with a self-concordant barrier \(\). Our contribution highlights that the use of well known implicit schemes for ODE integration combined with these space constraints leads to asymptotic bias when it comes to their numerical implementation. We propose to solve it in a straightforward manner via our algorithm, n-BHMC, which relies on an additional "involution checking step". Under reasonable assumptions, our theory shows that this critical step removes the asymptotic bias. This result is supported by numerical experiments where we highlight this lack of bias compared to state-of-the-art methods. In future work, we would like to investigate the "coupled" behaviour of the hyperparameters \(h\) and \(\) in practice, the study of irreductiblity of n-BHMC and the influence of \(\) on the bias. Moreover, we are interested in the application of n-BHMC for efficient polytope volume computation. More generally, we are convinced that our study is a first step for future work on designing implicit integration schemes for unbiased constrained sampling methods.

   Model & \(d\) & NNZ & n-BHMC & CRHMC \\  ecoli & 95 & 291 & **0.08822** & 5.719 \\ cardiac-mit & 220 & 228 & **0.1905** & 5.304 \\ Aci-D21 & 851 & 1758 & 141.9 & **46.17** \\ Aci-MR895 & 994 & 2859 & 325.1 & **61.34** \\ Abi-949176 & 1069 & 2951 & 179.4 & **74.22** \\ Aci-20731 & 1090 & 2946 & **0.7124** & 88.82 \\ Aci-PHEA & 1561 & 4640 & **2.343** & 100.8 \\ iAF1260 & 2382 & 6368 & 537.9 & **170.5** \\ iJO1366 & 2583 & 7284 & 537.9 & **169.4** \\ Recon1 & 3742 & 8717 & **3.740** & 3280 \\   

Table 1: Real-world data setting: comparison with Kook et al. (2022a).

Figure 2: Comparison between n-BHMC and CRHMC on the hypercube (left) and the simplex (right).