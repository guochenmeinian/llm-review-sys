# Youfang Lin\({}^{1,2}\), Huaiyu Wan\({}^{1,2}\)

DiffLight: A Partial Rewards Conditioned Diffusion Model for Traffic Signal Control with Missing Data

Hanyang Chen\({}^{1,2}\), Yang Jiang\({}^{1,2}\), Shengnan Guo\({}^{1,2}\), Xiaowei Mao\({}^{1,2}\),\({}^{1}\)School of Computer Science and Technology, Beijing Jiaotong University, China

\({}^{2}\)Beijing Key Laboratory of Traffic Data Analysis and Mining, Beijing, China

{hanyangchen, jiangyang, guoshn, maoxiaowei, yflin, hywan}@bjtu.edu.cn

Corresponding author

###### Abstract

The application of reinforcement learning in traffic signal control (TSC) has been extensively researched and yielded notable achievements. However, most existing works for TSC assume that traffic data from all surrounding intersections is fully and continuously available through sensors. In real-world applications, this assumption often fails due to sensor malfunctions or data loss, making TSC with missing data a critical challenge. To meet the needs of practical applications, we introduce DiffLight, a novel conditional diffusion model for TSC under data-missing scenarios in the offline setting. Specifically, we integrate two essential sub-tasks, _i.e._, traffic data imputation and decision-making, by leveraging a Partial Rewards Conditioned Diffusion (PRCD) model to prevent missing rewards from interfering with the learning process. Meanwhile, to effectively capture the spatial-temporal dependencies among intersections, we design a Spatial-Temporal transFormer (STFormer) architecture. In addition, we propose a Diffusion Communication Mechanism (DCM) to promote better communication and control performance under data-missing scenarios. Extensive experiments on five datasets with various data-missing scenarios demonstrate that DiffLight is an effective controller to address TSC with missing data. The code of DiffLight is released at https://github.com/lokol5579/DiffLight-release.

## 1 Introduction

With the acceleration of urbanization, the surge in the number of vehicles in cities has led to increasingly severe traffic congestion and pollution problems . Intersections, where traffic congestion often occurs, become a key in addressing these problems. To this end, solving the traffic signal control (TSC) problem is crucial for reducing traffic congestion in intersections by controlling traffic lights. Over the years, many approaches have been developed to tackle the TSC problem, which can be categorized into conventional approaches and reinforcement learning-based (RL-based) approaches. Conventional approaches, like Fixed-time , SCOOT  and SCATS , have been widely deployed in different cities. However, these approaches struggle to adapt to the inherent stochasticity and highly dynamic nature of real-time traffic conditions, limiting their effectiveness in responding to dynamic traffic demands.

Recently, reinforcement learning (RL) is introduced into TSC to enable adaptive traffic signal control . Unlike conventional approaches, RL-based approaches for TSC deploy a learnable agent at each intersection, allowing traffic signals to be adjusted dynamically based on real-time traffic conditions. However, most existing RL-based approaches for TSC assume that traffic data from all surrounding intersections is fully and continuously available through deployed sensors. In practice, this assumption is often unrealistic. Due to budget constraints, not all intersections can be equipped with sufficient sensors. Even if necessary sensors are deployed, malfunctions or errors could lead to incomplete data collection. Therefore, the research on TSC with missing data is more in line with the needs of actual scenarios but has not been studied sufficiently yet.

Furthermore, existing RL-based approaches for TSC can be categorized into two types, _i.e._, online approaches and offline approaches. Most RL-based approaches for TSC rely on the online setting, interacting with the environment frequently. Specific to data-missing scenarios, MissLight  composed of the traffic data imputation stage and decision-making stage has been proposed in the online setting. However, frequent interaction with the real-world traffic environment is challenging and potentially unsafe, especially when dealing with incomplete data. As an alternative, training using offline traffic data with missing values offers a safer and more practical solution. Therefore, we focus on the offline setting in this paper. Similar to the online setting, traffic data imputation and decision-making for TSC with missing data are two sub-tasks we must confront in the offline setting.

Recently, diffusion models  have been introduced into offline RL due to their powerful generative ability [16; 17; 18; 19; 20]. These approaches frame sequential decision-making as conditional generative modeling and utilize the generative ability of the diffusion model to capture complex policy distribution in offline datasets to make better decisions. Additionally, in the context of TSC with missing data, traffic data imputation is equally critical. Inspired by existing works [21; 22; 23], we approach traffic data imputation as a conditional generative problem, similar to decision-making. Considering the similarity of the two sub-tasks, we propose to unify traffic data imputation and decision-making for TSC with missing data by utilizing the powerful generative ability of the diffusion model.

There are several challenges that must be addressed to integrate the two sub-tasks mentioned above effectively. Firstly, in RL-based approaches for TSC, rewards which are typically vehicle queue length, are critical for the performance of controllers. However, due to the absence of traffic data, only partial rewards are available. A straightforward solution might be to fill in the missing rewards with padded values, which could confuse the imputed rewards with the actual ones, leading to a negative impact on performance. Secondly, relying solely on traffic data of the local intersection makes it challenging to capture the dynamic and spatial-temporal dependencies in the traffic network for traffic data imputation and decision-making tasks. The complexity of traffic flow often requires a broader context, as traffic data from the local intersection may not adequately reflect the behaviors and interactions occurring across the entire network. The absence of traffic data from neighboring intersections may further exacerbate this issue, hindering the ability to capture these dependencies and potentially leading to a decline in performance.

To tackle these challenges, we introduce DiffLight, a novel conditional diffusion model for TSC with missing data. We propose a Partial Rewards Conditioned Diffusion (PRCD) model for both traffic data imputation and decision-making under data-missing scenarios to prevent missing rewards from interfering with the learning process. Meanwhile, to effectively capture the spatial-temporal dependencies among intersections, we design the noise model as a Spatial-Temporal transformer (STFormer) architecture. In addition, we propose a Diffusion Communication Mechanism (DCM) to enable communication and promote the capture of spatio-temporal dependencies in the traffic network through the propagation of generated observations, facilitating better control in scenarios with missing data. Extensive experiments on five datasets with various data-missing scenarios are conducted to evaluate the effectiveness of DiffLight. The experimental results indicate that DiffLight is highly competitive for TSC with missing data.

## 2 Preliminaries

### Partially Observable Markov Decision Process

We consider a partially observable Markov decision process (POMDP) in the offline setting, defined as a tuple \(,,,,,, \). \(\) is the state space, and \(s_{t}\) denotes the state at time \(t\). \(\) is the set of available actions and \(a_{t}\) denotes the action of an agent at time \(t\). The observation \(o_{t}\) observed by the agent is part of the state \(s_{t}\) and can be derived from the function \((s_{t})\). \(r_{t}=(s_{t})\) is the immediate reward of an agent at time \(t\). \(\) and \(\) denote the transition probability function and the discount factor separately. The optimization objective is to learn a policy \(\) for agents to maximize the expected return \(_{s_{t},a_{t}}[R_{t}]\), where \(R_{t}=_{t}^{t}r_{t}\).

### Traffic Signal Control with Missing Data

We formulate TSC with missing data as POMDP, and consider TSC in a traffic network with several intersections. Agents are deployed at each intersection of the traffic network. As illustrated in Figure 1, for a four-way intersection, there are twelve traffic movements from the intersection's entrance lane \(l_{ in}\) to the departure lane \(l_{ out}\), and four pairs of traffic movements without conflict comprise four traffic signal phases, _i.e._, A, B, C, D. For example, the traffic signal phase of the intersection in Figure 1 is phase-A which involves movement-2 \(=\{l_{ in}^{2} l_{ out}^{7},l_{ in}^{2} l_{ out}^{8},l_{ in }^{2} l_{ out}^{9}\}\) and movement-8 \(=\{l_{ in}^{8} l_{ out}^{1},l_{ in}^{8} l_{ out}^{2},l_{ in }^{8} l_{ out}^{3}\}\).

In this paper, the **observation**\(o_{t}\) contains the number of vehicles \(L_{ num}\) and queue length \(L_{ queue}\) in every entrance lane of the local intersection. Available **actions** are four phases. The **immediate reward**\(r_{t}\) is defined as the sum of the queue length \(_{l_{ in}}L_{ queue}\). Due to the lack or error of sensors resulting in missing traffic data, \(o_{t}\) and \(r_{t}\), which are derived from traffic data, could be missing in a particular missing pattern. We consider random missing and kriging missing patterns detailed in Appendix C.2. To simplify the problem, we assume that \(o_{t}\) and \(r_{t}\) in an intersection are missing simultaneously.

### Diffusion Models for Reinforcement Learning

Diffusion model.Diffusion models [15; 24; 25], as a powerful generative model, provide a framework to model the data generative process as a discrete diffusion process. Diffusion models consist of two processes: the forward process and the reverse process. In this paper, the forward process is defined as \(q(x^{k}|x^{k-1}):=(}x^{k-1},^{k})\) by the Markov process, where \(^{k}\) is the variance of the noise at timestep \(k\). We adopt DDIM sampler  to sample in the reverse process in order to accelerate sampling. DDIM sampler is parameterized with \(p_{}(x^{k-1}|x^{k},x^{0}):=(_{}(x^{k},k),(^{k })^{2})\), which can be optimized by a simplified surrogate loss,

\[():=_{k(1,K),(,)}[\|_{}(x^{k},k)-\|^{2}].\] (1)

The reverse process begins by sampling an initial noise \(x_{K}(,)\). The estimated mean of Gaussian is \(_{}(x^{k},k)=^{k-1}}_{0}\ +^{k-1}} _{}(x^{k},k)\) where \(_{0}=^{k}}}(x^{k}-^{k}} _{}(x^{k},k))\), \(^{k}=1-^{k}\), \(^{k}=_{k=1}^{K}^{k}\) and \(_{}(x^{k},k)\) is a predictor used to estimate noise.

Diffusing decision-making.Recently, many diffusion-based approaches have been proposed to address decision-making problems in RL. Among existing works, Diffuser  chooses to diffuse on an observation-action trajectory with returns as the condition to generate actions directly. Decision Diffuser  focuses solely on diffusing the observation trajectory conditioned on returns. By avoiding direct diffusion over actions, Decision Diffuser enhances performance in scenarios with discrete actions. In this paper, considering the discrete nature of actions in TSC, we focus on introducing the approach diffusing on the observation trajectory \(\) sampled from offline dataset \(\). We denote the \(k\)-step denoised output of the diffusion model as \(x^{k}()\). The observation trajectory would be diffused to generate \(o_{t+1}\). However, only diffusing on observation trajectory is not enough to make decisions. An inverse dynamics model \(f_{}\) is adapted to generate the action \(a_{t}\) that makes the observation transit from \(o_{t}\) to \(o_{t+1}\),

\[a_{t}:=f_{}(o_{t},o_{t+1}).\] (2)

Figure 1: Illustration of a four-way intersection with 12 traffic movements and 4 traffic signal phases.

Classifier-free guidance.Classifier-free guidance  aims to learn the conditional distribution \(q(x()|y())\). It learns both a conditional \(_{}(x^{k}(),y(),k)\) and an unconditional \(_{}(x^{k}(),,k)\) for the noise. Then, the perturbed noise \(_{}(x^{k}(),,k)+(_{}(x^{k}(),y(),k)-_{}(x^{k}(),,k))\) can be used to generate samples, where \(\) is the guidance scale.

## 3 Methodology

In order to effectively unify traffic data imputation and decision-making for TSC with missing data, we consider both of them as a conditional generative modeling problem via diffusion models,

\[_{}_{}[ p_{}(x^{0}()|y())],\] (3)

where \(p_{}\) is a learnable model distribution to estimate the conditional data distribution of trajectory \(x^{0}()\), conditioned on \(y()\). We construct our generative model according to the conditional diffusion process,

\[q(x^{k}()|x^{k-1}()), p_{}(x^{k-1}()|x ^{k}(),x^{0}(),y()),\] (4)

with conditions as,

\[y():=[r(),y^{}()], y^{}():=[^{}_{ obs},^{}_{ nei}].\] (5)

To facilitate a better understanding of the symbol definitions, we categorize the trajectory segments into three types. The **observed** trajectory consists of data collected by sensors up to time \(t\). The **missing** trajectory includes data that have not been collected during this period. The **observable** trajectory encompasses both the observed trajectory and the data that could potentially be collected in the future. In this context, \(r()\) is the observable reward trajectory, and \(^{}_{ obs}\) is the observed part of trajectory \(\) from the local intersection. \(^{}_{ nei}=_{N}f_{ nei}(^{i})\) is the observed observations from neighboring intersections, where \(^{i}\) denotes the observation trajectory of the neighboring intersection \(i\), \(N\) is total number of neighboring intersections, \(f_{ nei}()\) represents the observed observations from entrance lanes of all neighboring intersections that feed into the entrance lanes of the local intersection, as shown in Figure 1. Due to discrete and high-frequent actions in TSC, we choose to diffuse solely on observations and utilize the inverse dynamic model to generate actions, which demonstrates a better performance proven in Appendix F.1 and F.6. We define the observation trajectory \(\) under data-missing scenarios as,

\[:=[_{t-C+1},o_{t-C+2},,_{t},_{t+1},, _{t+H}],\] (6)

where \(o_{t}\) is the observation collected by sensors, \(_{t}\) is the uncollected observation up to time \(t\) or a potentially collectible observation in the future, \(C\) is the length of historical observations and \(H\) is the horizon of future observations. It should be noted that we generate \(H\)-step future observations to enable effective long-horizon planning .

Figure 2 shows the overview of DiffLight, which consists of the Partial Rewards Conditioned Diffusion (PRCD), a noise model with a Spatial-Temporal transFormer structure (STFormer), and the Diffusion Communication Mechanism (DCM). We introduce each of them in the following sections.

### Partial Rewards Conditioned Diffusion

Under data-missing scenarios, sensors deployed to collect traffic data for rewards may malfunction or be lacking. The absence of partial rewards makes it challenging to calculate returns. Therefore, we adopt partial rewards as the condition instead of returns [16; 17; 19], which can be expressed as,

\[r():=[_{t-C+1},r_{t-C+2},,_{t},r_{t+1}, ,r_{t+H}],\] (7)

where \(r_{t}\) is the collected reward or a potentially collectible reward in the future, and \(_{t}\) is the uncollected reward.

There are two ways to handle the missing part of rewards: conditioning on the rewards with padded values or conditioning on the partial observable rewards directly. Padding a specific value in the missing part is a feasible way. However, padded values could confuse the imputed rewards with the actual ones, leading to a negative impact on performance proven in Section 4.3. For better decision-making, we choose to condition on only partial observable rewards. We assume that the observable part and the missing part of the trajectory are collected by real sensors and virtual sensors separately, and the distribution of traffic data collected by two kinds of sensors is independent. In this case, the distribution in Equation 3 can be factorized as,

\[p_{}(x^{0}()|y())=p_{}(x^{0}(_{ obs} )|r(),y^{}()) p_{}(x^{0}(_{ mis })|y^{}()),\] (8)

where \(_{ obs}\) is the observable part of the trajectory \(\) from the local intersection, and \(_{ mis}\) is the missing part. We parameterize Equation 8 as the same form of locally conditioned diffusion [27; 28], propose partial rewards conditioned diffusion (PRCD) with classifier-free guidance  and introduce it into TSC with missing data. Given condition set \(=\{,r()\}\) and binary non-overlapping mask set \(=\{m_{ mis},m_{ obs}\}\), PRCD assigns partial rewards to corresponding observation sub-trajectory masked by \(\), which can be formulated as,

\[_{}(x^{k}(),k,y^{ }(),,):=& m_{ obs}_{}(x^{k}(),k,y^{}(),r())+\\ & m_{ mis}_{}(x^{k}(),k,y^{ }(),),\] (9)

where \(_{}(x^{k}(),k,y^{}(),c_{i})\) could be expressed using classifier-free guidance,

\[_{}(x^{k}(),k,y^{ }(),c_{i}):=&_{}(x^{k}(),k, y^{}(),)+\\ &(_{}(x^{k}(),k,y^{}(),c_{i})-_{}(x^{k}(),k,y^{}(),)), \] (10)

where \(c_{i}\). We provide a derivation for the feasibility of PRCD in Appendix E.

### Diffusing with Spatial-Temporal Transformer

The noise model with a U-Net structure is widely applied in image generation [15; 24; 29; 30], control [16; 17; 19] and other fields. However, it is hard to be applied to capture the spatial-temporal

Figure 2: An overview of DiffLight. We demonstrate the signal control process of an intersection in random missing. Traffic data is collected by sensors to derive rewards and observations. Missing rewards and observations are masked. Only the observed part of the observation trajectory and observable rewards from the local intersection, and observation trajectories from neighboring intersections would be input into PRCD with STFormer. In the inference process, DCM would work with STFormer to generate observations. The inverse dynamics model is used to generate actions to control the traffic signal.

dependencies in TSC. The emergence of Transformer  and its applications on spatial-temporal modeling [32; 33; 34; 35] provide a promising solution to deal with it. In this section, we design a Spatial-Temporal transFormer (STFormer) structure to effectively model the spatial-temporal dependencies in TSC, which includes a data embedding layer, stacked \(L\) spatial-temporal encoder layers, and an output layer. Data embedding layer embeds different inputs into embeddings, including diffusion timestep, trajectory timestep, rewards, trajectory of the local intersection, and neighboring intersections. Spatial-Temporal Encoder layer (STE) is composed of Communication Cross-Attention module (CCA), Spatial Self-Attention module (SSA), and Temporal Self-Attention module (TSA). CCA is designed to capture the spatial-temporal dependencies between the local intersection and neighboring intersections. SSA and TSA are designed to capture the spatial dependencies and temporal dependencies at the local intersection separately. Output layer is used to convert the output of STE into the noise we desire to predict. We detail the structure of STFormer in Appendix B.2.

### Diffusion Communication Mechanism

Observations of neighboring intersections are crucial for TSC with missing data . However, due to the possible absence of observations from neighboring intersections, the traffic signal could be controlled ineffectively. For instance, we assume an extreme situation where there is no available observation in both the local intersection and neighboring intersections. In this case, observation trajectories of intersections are all masked by noise, leading to difficulty in decision-making at the local intersection. Therefore, we propose a Diffusion Communication Mechanism (DCM) to disseminate observation information generated by the noise model in the reverse process among intersections. Formally, we formulate DCM as,

\[^{}_{}=\{ &_{N}f_{}(^{i}),& k=K,\\ &_{N}f_{}(^{k}}}(x^{k} (^{i})-^{k}}_{}(x^{k}(),k,y^{}(),,))),& k<K. .\] (11)

The reverse process begins by inputting original observations of neighboring intersections with missing data. During diffusing, we predict \(^{0}(^{i})\), which is the same in Section 2.3. With the help of DCM, generated observations of neighboring intersections could be spread from neighboring intersections for better decisions of the agent at the local intersection. Note that we train our model with ground-truth values collected from neighboring intersections and only use DCM in the inference process.

### Training and Inference of DiffLight

Training process.Given an offline dataset \(\) which consists of observation trajectories, rewards and actions, we train the reverse process \(p_{}\) parameterized through the noise model \(_{}\), and the inverse dynamics model \(f_{}\) in DiffLight with the following loss,

\[():= _{(o,a,o^{})}[\|a-f_{}(o,o^{ })\|^{2}(o,o^{})]+\] (12) \[_{k,,(p)}[\|_{}(x^{k}(),k,y^{}(),(1-)r()+ ,)-\|^{2}].\]

For each trajectory \(\), we sample noise \((,)\) and a diffusion timestep \(k(1,K)\), construct a masked noise array of observations \(x^{k}()\) with \(^{}_{}\), and predict the noise \(_{}(x^{k}(),k,y^{}(),r(), )\). Missing values in condition \(^{}_{}\) are padded with zeros. It should be noted that we ignore the rewards condition \(r()\) with probability \(p\) and the inverse dynamics is trained with individual transitions without missing observation \(o\) or \(o^{}\). For the training process of DiffLight, due to the inaccessibility of the ground-truth of missing data, we consider it self-supervised learning. In random missing, given a trajectory \(\) and conditions, we can separate the observed part into two parts and set one of them to miss. In kriging missing, we randomly mask the whole trajectories of one observed intersection. Then, we can train the noise model \(_{}\) by solving Equation 12.

Inference process.DiffLight is deployed to every intersection in the traffic network in the inference process. Given rewards \(r()\), a \(C\)-step observed trajectory of local intersection \(^{}_{}\) with missing data and trajectories of neighboring intersections \(_{}^{}\), the agent can impute the missing observations of local intersection, predict the observations in the future and generate next action with Equation 2, 9 and 10. In order to sample a high reward trajectory, the rewards from time \(t+1\) to \(t+H\) are considered in \(r()\), which is set to 1.

## 4 Experiments

### Experimental Setup

Experiment SettingsWe conduct our experiments on CityFlow , a traffic simulator widely used in various RL-based methods. Similar to existing work in , we set the phase number as four and the minimum action duration as 15 seconds.

DatasetsThe datasets consist of two parts: offline datasets with missing data and real-world traffic flow datasets with traffic networks. We apply five real-world traffic flow datasets [9; 37] for comparison, including Hangzhou\({}_{1}\) (\(_{}^{1}\)), Hangzhou\({}_{2}\) (\(_{}^{2}\)), Jinan\({}_{1}\) (\(_{}^{1}\)), Jinan\({}_{2}\) (\(_{}^{2}\)) and Jinan\({}_{3}\) (\(_{}^{3}\)). Corresponding offline datasets are composed of training trajectories of three online methods. We detail the datasets in Appendix C.1. To simulate data-missing scenarios, we adopt masks of different missing rates in different missing patterns, including random missing (RM) and kriging missing (KM), to mask observations and rewards. We describe the details of two patterns and missing rates in Appendix C.2.

Evaluation MetricsWe use the average travel time (ATT) as the main metric for evaluation, which is widely used to evaluate the performance of TSC. It calculates the average time all the vehicles spend between entering and leaving the traffic network during simulation, which is formulated as,

\[=_{i=1}^{N}(t_{i}^{l}-t_{i}^{e}),\] (13)

where \(N\) is the total number of vehicles entering the road network, \(t_{i}^{e}\) and \(t_{i}^{l}\) are the entering time and leaving time for the \(i\)-th vehicle respectively. The lower ATT indicates a better control performance.

Compared MethodsWe compare our method with Behavior Cloning (BC)  and offline approaches, including CQL , TD3+BC , Decision Transformer (DT) , Diffuser , Decision Diffuser (DD) . Similar to the existing work in , we adopt store-and-forward method (SFM) , a rule-based method that has generally more stable performances, to impute missing observations and rewards for these approaches. We detail these approaches and SFM in Appendix D.

### Performance under Data-Missing Scenarios

We train and test our method on all five datasets with different missing patterns and missing rates, and compare our method with all baselines. DiffLight performs the best on most of the datasets. We analyze experiments of different missing patterns below.

Random missing.In random missing, we can see that DiffLight achieves optimal or sub-optimal performance compared with baselines in all datasets in Table 1. Diffusion-based approaches, including Diffuser and DD, show a better performance than other baselines in most datasets. These diffusion-based approaches utilize a noise model to predict noise and generate actions or observations, which helps mitigate the disturbance caused by imputed observations and rewards during the diffusion process. Compared with diffusion-based approaches, the performance of other baselines without the diffusion process is disturbed by imputed observations and rewards more seriously.

Kriging missing.In kriging missing, DiffLight shows the best performance in most datasets in Table 2. Unlike the results of random missing, DD does not perform well in kriging missing compared with other baselines. Since DD must impute missing observations with the SFM model first, generate future observations with the diffusion model, and then use the inverse dynamics to generate actions, which leads to serious error accumulation. While other baselines generate actions directly, requiring only roughly imputed observations and rewards.

We provide the overall performance of DiffLight and baselines without missing data as well, which is detailed in Appendix F.1. In addition, we provide further experiments on the influence of unobserved locations of intersections in Appendix F.2, the limit of missing rates in Appendix F.3, and the scalability of the approach in Appendix F.4.

  
**Dataset** & **Rate** & **BC** & **CQL** & **TD3+BC** & **DT** & **Diffuser** & **DD** & **DiffLight** \\  _{}^{1}\)} & 10\% & 349.59 & 363.5 & 337.54 & 300.64 & 290.66 & 289.38 & **286.17\(\)**0.87 \\  & 30\% & 350.08 & 368.53 & 338.21 & 315.64 & 302.39 & 298.67 & **292.81\(\)**0.66 \\  & 50\% & 357.13 & 383.67 & 343.23 & 343.96 & 313.68 & 422.5 & **304.71\(\)**2.12 \\  _{}^{2}\)} & 10\% & 382.45 & 353.23 & 370.16 & 347.25 & 346.82 & 347.77 & **327.13\(\)**1.43 \\  & 30\% & 388.73 & 352.55 & 376.06 & 360.59 & 366.24 & 364.6 & **330.68\(\)**2.63 \\  & 50\% & 387.77 & 367.38 & 375.32 & 377.79 & 398.23 & 395.61 & **333.90\(\)**2.67 \\  _{}^{1}\)} & 10\% & 320.6 & 299.07 & 315.54 & 308.78 & 272.51 & **260.76** & 272.18\(\)0.93 \\  & 30\% & 328.97 & 310.8 & 326.37 & 377.39 & 295.09 & 300.49 & **279.10\(\)**2.10 \\  & 50\% & 355.47 & 322.25 & 351.2 & 439.89 & 324.75 & 517.99 & **290.02\(\)**2.18 \\  _{}^{2}\)} & 10\% & 288.42 & 305.86 & 322.44 & 259.3 & 255.12 & **245.85** & 247.17\(\)1.38 \\  & 30\% & 297.26 & 308.13 & 330.43 & 263.24 & 271.53 & 256.16 & **254.87\(\)**0.69 \\  & 50\% & 299.44 & 320.17 & 334.78 & 278.22 & 302.28 & 275.2 & **268.29\(\)**0.90 \\  _{}^{3}\)} & 10\% & 301.35 & 291.26 & 281.75 & 257.66 & 246.90 & **242.56** & 246.65\(\)0.94 \\  & 30\% & 315.03 & 295.61 & 283.24 & 312.56 & 258.83 & 256.95 & **254.55\(\)**0.35 \\   & 50\% & 326.55 & 301.1 & 292.98 & 382.93 & 272.36 & 351.92 & **265.76\(\)**0.01 \\   

Table 1: Comparing ATT for DiffLight and baselines in random missing. We report the mean and the standard error for three trials.

  
**Dataset** & **Rate** & **BC** & **CQL** & **TD3+BC** & **DT** & **Diffuser** & **DD** & **DiffLight** \\  _{}^{1}\)} & 6.25\% & 338.33 & 317.69 & 332.80 & 300.78 & 302.99 & 395.54 & **294.18\(\)**3.36 \\  & 12.50\% & 346.83 & 317.94 & 332.43 & 310.37 & 305.93 & 483.47 & **294.11\(\)**4.34 \\  & 18.75\% & 350.08 & 319.18 & 333.24 & 306.35 & 307.22 & 572.56 & **300.31\(\)**0.31 \\  & 25.00\% & 354.86 & 328.83 & 341.89 & 381.94 & 328.79 & 836.46 & **302.16\(\)**1.23 \\  _{}^{2}\)} & 6.25\% & 380.18 & 354.08 & 374.04 & 347.53 & 363.69 & 370.80 & **330.40\(\)**0.11 \\  & 12.50\% & 375.93 & 361.52 & 374.66 & 363.5 & 378.51 & 424.99 & **319.11\(\)**7.19 \\   & 18.75\% & 380.74 & 362.82 & 376.48 & 374.69 & 413.48 & 435.13 & **327.61\(\)**9.68 \\   & 25.00\% & 413.46 & 418.97 & 390.75 & 492.56 & 378.54 & 590.69 & **351.21\(\)**9.86 \\  _{}^{1}\)} & 8.33\% & 319.85 & 302.35 & 317.17 & 306.52 & 332.44 & 595.34 & **280.75\(\)**0.11 \\   & 16.67\% & 339.19 & 343.16 & 349.72 & 380.97 & 349.74 & 643.48 & **306.06\(\)**14.89 \\   & 25.00\% & 392.91 & 398.66 & 391.32 & 432.56 & 410.5 & 995.99 & **329.67\(\)**16.04 \\  _{}^{2}\)} & 8.33\% & 287.29 & 306.94 & 319.4 & 261.98 & 259.51 & 460.22 & **254.13\(\)**0.35 \\   & 16.67\% & 299.41 & 314.43 & 321.88 & **267.67** & 270.15 & 731.49 & 272.76\(\)1.42 \\   & 25.00\% & 314.63 & 359.33 & 323.65 & 295.59 & **295.21** & 1049.19 & 325.20\(\)26.63 \\  _{}^{3}\)} & 8.33\% & 310.44 & 287.25 & 282.46 & 368.2 & 267.64 & 324.42 & **249.48\(\)**0.16 \\   & 16.67\% & 327.7 & 311.89 & 295.07 & 322.96 & 294.27 & 399.67 & **274.13\(\)**2.50 \\   & 25.00\% & 381.37 & 337.33 & 312.44 & 494.04 & **292.26** & 409.76 & 342.07\(\)16.11 \\  \

### Ablation Study

We further evaluate the effectiveness of different parts in DiffLight with the following variants. (1) U-Net: this variant replaces STFormer with U-Net as the noise model and missing rewards input are zero-padded. (2) STFormer: this variant uses STFormer as the noise model and keeps missing rewards zero-padded. (3) STFormer+PRCD: this is equal to DiffLight which uses STFormer as the noise model and is conditioned on partial rewards. It should be noted that DCM is adopted in both STFormer and STFormer+PRCD and all missing observations would not be imputed by the SFM model but are masked with Gaussian noise in order to be inpainted in the reverse process in ablation experiments.

Table 3 shows the comparison of these variants on Hangzhou\({}_{1}\) and Jinan\({}_{1}\) with random missing and kriging missing. Based on the results, we can find that STFormer which takes spatial-temporal dependencies into consideration leads to a great performance improvement over U-Net. It shows that capturing spatial-temporal dependencies is important in TSC. STFormer+PRCD performs better than STFormer, indicating that padding values in rewards could be confused with the ground-truth rewards and only conditioning on partial rewards could have a better performance. Due to the space limitation, we provide further experiments on DCM in Appendix F.5 and the inverse dynamics in Appendix F.6.

### Model Generalization

We evaluate the generalization performance of DiffLight on Hangzhou\({}_{1}\) and Jinan\({}_{1}\) with different missing rates. We train our method in a specific missing rate and test it on the same dataset with other missing rates. To better compare the generalization performance among models trained in different missing rates, we formulate the relative generalization performance as,

\[P_{}=P_{}/P_{},\] (14)

where \(P_{}\) is the relative generalization performance of the current missing rate, \(P_{}\) is the performance of the model trained in other missing rates, and \(P_{}\) is the performance of the model trained in the current missing rate. The results in Figure 3 demonstrate that the generalization performance of DiffLight is excellent in most situations. If we train DiffLight in a high missing rate and test it in a lower missing rate, the performance of DiffLight remains stable. In contrast, if we train DiffLight in a low missing rate and test it in a higher missing rate, the performance of DiffLight would decrease

  
**Dataset** & **Pattern and Rate** & **U-Net** & **STFormer** & **STFormer+PRCD** \\  _{}^{1}\)} & RM (50\%) & 668.38\(\)65.54 & 350.60\(\)9.88 & **304.71\(\)**2.12 \\  & KM (25\%) & 363.80\(\)44.65 & 318.21\(\)5.84 & **302.16\(\)**1.23 \\ _{}^{1}\)} & RM (50\%) & 509.64\(\)41.15 & 374.41\(\)3.61 & **290.02\(\)**2.18 \\  & KM (25\%) & 454.90\(\)65.10 & 374.23\(\)69.90 & **329.67\(\)**16.04 \\   

Table 3: Ablation study on Hangzhou\({}_{1}\) and Jinan\({}_{1}\).

Figure 3: The relative generalization performance of DiffLight in different missing rates. The x-axis is the missing rate during testing and the y-axis is the missing rate during training. The formula used to calculate the relative generalization performance is depicted below.

slightly. As data with a higher missing rate has more complex missing situations, making it difficult for models to handle these situations.

## 5 Related Work

Traffic Signal ControlTSC approaches can be categorized into conventional and RL-based methods. Conventional approaches like Fixed-time , SCOOT  and SCATS  have been widely deployed in different cities. In recent years, RL-based approaches for TSC get more attention. DQN algorithm is introduced into TSC in [5; 6; 7] for dynamic real-time control. Attention mechanisms are applied to promote inter-agent communication  and build universal models . Max-pressure  and advanced-MP  are proposed to promote the performance of existing methods. TSC with missing data is considered with the help of the imputation model in the online setting. However, there is no existing work to solve this problem in the offline setting.

Diffusion-based Reinforcement LearningThere are various works applying the diffusion model to offline RL recently. Diffusion and deep q-learning are combined , demonstrating the potential of diffusion in RL. The state-action trajectory is encoded in latent space , enhancing credit assignment and reward propagation. In addition to methods relying on TD-learning, Diffuser  and Decision Diffuser  are proposed as planners to generate the trajectory with a conditional diffusion model. However, they are all studied under scenarios without missing data, while we model TSC with missing data.

Traffic Data ImputationWith the development of deep learning, RNN-based methods [44; 45; 46] show good performance for traffic data imputation. In subsequent studies, diffusion models are utilized to learn the complex distribution in traffic data [21; 22]. For TSC, store-and-forward method (SFM)  is proven to have a more stable performance than neural networks . In this paper, we adopt SFM to impute observations and rewards for baselines.

## 6 Conclusion and Limitation

ConclusionIn this paper, we introduce DiffLight, a novel conditional diffusion model designed for TSC in scenarios with missing data. Our approach centers on the Partial Rewards Conditioned Diffusion (PRCD) model, which addresses both traffic data imputation and decision-making in the presence of incomplete data. This model helps prevent missing rewards from disrupting the learning process. We address the challenge of capturing spatial-temporal dependencies across intersections by designing a Spatial-Temporal transFormer (STFormer) architecture as the noise model. Additionally, to enhance communication and control performance, we propose a Diffusion Communication Mechanism (DCM) that facilitates the propagation of generated observations. We conduct extensive experiments on different datasets and settings to demonstrate that DiffLight is an effective controller to address TSC with missing data.

LimitationIn this work, we only consider two missing patterns: random missing and kriging missing. While in the real world, the missing pattern in the traffic network is more complex. Meanwhile, we just adopt SFM which is similar to k-nearest neighbor (KNN) to impute the traffic data for baselines. In addition, our approach is conditioned on partial rewards instead of returns which could lead to the short-sightedness of agents. Future work could explore the influence on performance in more different missing patterns even mixed missing patterns, adopt more different imputation methods, and find out a more far-sighted method to control the traffic signals under data-missing scenarios.