# Improved Bayesian Regret Bounds for Thompson Sampling in Reinforcement Learning

Ahmadreza Moradipari\({}^{*}\) &Mohammad Pedramfar\({}^{*}\) &Modjtaba Shokrian Zini\({}^{*}\) &Vaneet Aggarwal \({}^{@sectionsign}\)

Authors have equal contribution.

###### Abstract

In this paper, we prove the first Bayesian regret bounds for Thompson Sampling in reinforcement learning in a multitude of settings. We simplify the learning problem using a discrete set of surrogate environments, and present a refined analysis of the information ratio using posterior consistency. This leads to an upper bound of order \((H}T})\) in the time inhomogeneous reinforcement learning problem where \(H\) is the episode length and \(d_{l_{1}}\) is the Kolmogorov \(l_{1}-\)dimension of the space of environments. We then find concrete bounds of \(d_{l_{1}}\) in a variety of settings, such as tabular, linear and finite mixtures, and discuss how how our results are either the first of their kind or improve the state-of-the-art.

## 1 Introduction

Reinforcement Learning (RL) is a sequential decision-making problem in which an agent interacts with an unknown environment typically modeled as a Markov Decision Process (MDP) . The goal of the agent is to maximize its expected cumulative reward. This problem has a variety of applications, including robotics, game playing, resource management, and medical treatments. The key challenge in RL is to balance the so-called exploration-exploitation trade-off efficiently: exploring unseen state-action pairs to gain more knowledge about the unknown environment or exploiting the current knowledge to maximize the expected cumulative reward. Two efficient approaches have been developed to control this trade-off: _optimism in the face of uncertainty_ (OFU) and _Thompson Sampling_ (TS) (or Posterior Sampling (PS)). OFU constructs a confidence set of statistically plausible MDPs that includes the true MDP with high probability and plays an optimistic policy according to the MDP with maximum gain from this set . TS samples a statistically plausible MDP from a posterior distribution and plays the optimistic policy of the sampled MDP . In this work, we focus on the latter, and by combining an information theoretical approach first introduced by  with analysis based on posterior consistency tools, we prove state-of-the-art Bayesian regret bounds in a variety of settings.

In this paper, we start by defining the Bayesian RL problem, where transition and reward functions are Bayesian and time inhomogeneous. The Bayesian RL problem we consider is more comprehensive than in previous works, as we allow for both Bayesian transition and Bayesian rewards, and do not make any assumption on their individual prior. To simplify the learning problem, we utilize the notion of surrogate environments, which is a discretization of the environments space, and its learning task and TS regret is a proxy to that of the main problem. The construction of the surrogate environments was first introduced by  with an incorrect proof, which is fixed in our work bydefining the surrogate environments through an optimization. Of main importance is the size of this new environment space. The Bayesian regret decomposes to the product of two terms, one being the cumulative mutual information of the environment and history traversed by the policy. By the well-known entropy estimation of the mutual information, this significant factor in the regret is connected to the \(l_{1}-\)dimensions (\(d_{l_{1}}\)) of the transition and reward functions space, which can be more succinctly interpreted as the \(l_{1}-\)dimension \(d_{l_{1}}\) of the environment space. The latter is in turn estimated by the size of the space of surrogate environments.

The information ratio, representing a trade-off of exploration/exploitation, is the other significant term in the decomposition of the TS Bayesian regret. In an improvement to , our novel analysis of this ratio based on posterior consistency tools, shows that this trade-off is bounded by \(H^{3/2}\), where \(H\) is the episode length. This bound is general and independent of the dimension of transition/reward function space at each step, which is is a key factor behind the advantage of our regret bound, such as the \(\) advantage in the tabular case compared to , or the lack of any restriction on the prior (e.g., Dirichlet prior) compared to . Following a further refined approach, we finally estimate the TS Bayesian regret to be \((}T})\) for large enough \(T\) in the time inhomogeneous setting. Here, a new term 'value diameter' \(\), which is the average difference of the optimal value functions at different states, is used in bounding the information ratio, where instead of \(H^{3/2}\), we have the smaller term \( H^{1/2}\). Bounding the information ratio with \(\) is a conceptual contribution of our work, which shows that the ratio is bounded by a _value-dependent_ term, which is in nature different from \(H\) but always \( H+1\). Further, there exists another bound for \(\); in environments where states are reachable from one another in \(D\) steps, we have \( D+1\). In 'well-connected' MDPs, one could have \(D H\), implying an improvement over the \(H^{3/2}\) information ratio bound.

Our generic bound is abstract in terms of \(d_{l_{1}}\), so we estimate it in more explicit terms for useful applications.  have bounded \(d_{l_{1}}\) in the tabular and linear case without formalizing this notion, and while for tabular MDPs, \(d_{l_{1}}\) was bounded by \(SAH\), for linear MDPs with feature space dimension \(d_{f}\), we investigate their claim of the bound \(d_{f}H\). Detailed in Appendix G, we show a counterexample to their analysis, and we manage to find a correct estimate in this setting. We also introduce finite mixtures MDPs and are the first to prove a TS Bayesian regret of order \(()\), where \(m\) is the number of mixtures.

Lastly, we note that our regret bound of order \((}T})\) is the first in the general nonlinear time inhomogeneous Bayesian RL setting for TS, and generalizing [31, Conj. 1], we conjecture it to be optimal if \(\) can be replaced by \(()\).

Related work.Since the introduction of information ratio by , a new line of research has emerged to provide tighter regret bounds for TS. The general approach involves factoring the Bayesian regret into two components: an information ratio that captures the trade-off between optimal action selection and information gain, and a cumulative information gain term that depends on the target environment and the history of previous observations. Then, both components are bounded separately using information theoretic tools.

In the bandit setting, this analysis has been used to bound Bayesian regret for TS , as well as that of a new algorithm called information-directed sampling (IDS) . This analysis has also been used in partial monitoring  and RL with a specific Dirichlet prior and additional assumptions  or when the true environment is too complicated to learn . More recently,  studied the Bayesian regret of TS in RL without any prior assumptions for tabular MDP. This is the closest work to our paper and we discuss our generalization in detail in Section 5.

The Bayesian tabular MDP case has also been studied with the additional Dirichlet prior assumption in , where they achieve a regret bound matching ours. In an independent approach, the first non-linear Bayesian RL model was considered by  with a regret bound of \(dH^{3/2}T^{1/2}\) where \(d\) is a notion of dimension of their model, but their results were limited to Gaussian process settings with linear kernels. Finally,  considered general non-linear Bayesian RL models and introduced an algorithm that obtains \(dH^{1+/2}T^{1-/2}\) where \(\) is a tuning parameter and \(d\) is the dimension of \(\).

It is worth noting that there is another line of work that incorporates confidence regions into TS to achieve Bayesian regret bounds that can match the best possible frequentist regret bounds by UCB in both bandit settings  and RL [31; 30; 32; 12]. However, this technique often results in a sub-optimal Bayesian regret, as the best bound known for UCB itself is not optimal.

While our work's emphasis is on theoretical guarantees for TS, we discuss here the experiments using this algorithm. Previous works on PSRL [35; 26; 23; 20; 31] come with extensive experiments on TS (and/or its variants), and discussions on computational efficiency of PSRL. In particular, experiments in  support the assertion that "PSRL dramatically outperforms existing algorithms based on OFU". In addition, PSRL with oracle access has been shown to be the most performant, esp. when compared to recent OFU based UCBVI/UCBVI-B, or even variants of PSRL such as Optimistic PSRL [39; Fig. 1.3]. However, an important limitation in experiments is the need for oracle access to an optimal policy, and that can not be always satisfied efficiently. Nevertheless, clever engineering can make TS work even in large scale Deep RL. Indeed, for general RL settings, the recent work  shows how to implement TS in Deep RL on the Atari benchmark and concludes that "Posterior Sampling Deep RL (PSDRL) significantly outperforms previous state-of-the-art randomized value function approaches, its natural model-free counterparts, while being competitive with a state-of-the-art (model-based) reinforcement learning method in both sample efficiency and computational efficiency". In summary, experiments in the literature provide enough support for the empirical performance of TS.

## 2 Preliminaries

### Finite-horizon MDP

We follow the literature's conventions in our notation and terminology to avoid confusion when comparing results. The environment is a tuple \(=(,_{},,_{},H,\{ P_{h}\}_{h=1}^{H},\{r_{h}\}_{h=1}^{H})\), where \(\) is the topological measurable state space, \(\) is the topological measurable action space, \(_{}\) and \(_{}\) are base probability measures on \(\) and \(\) respectively, \(H\) is the episode length, \(P_{h}:_{,_{}}\) is the transition probability kernel, and \(r_{h}:_{,}\) is the reward function, where we fix the convention \(r(s,a):=_{x}[r(x|s,a)]=_{0}^{1}xr(x|s,a)\,x\) as we mostly deal with its mean value. Notice that \(_{X,}\) is the set of probability distributions over \(X\) that are absolutely continuous with respect to \(\). We will use \(_{X}\) when the base measure is clear from the context. We assume \(\), \(\) are known and deterministic while the transition probability kernel and reward are unknown and random. Throughout the paper, the implicit dependence of \(P_{h}\) and \(r_{h}\) on \(\) should be clear from the context.

Let \(_{h}^{P}\) be the topological function space of \(P_{h}\) and \(^{P}=_{1}^{P}_{H}^{P}\) be the full function space. The space \(_{h}^{P}\) is assumed to be separable and equipped with prior probability measure \(_{h}^{P}\) yielding the product prior probability measure \(^{P}=_{1}^{P}_{H}^{P}\) for \(^{P}\). The exact same definition with similar notations \(_{h}^{R},_{h}^{R},^{R},^{R}\) applies for the reward function. Notice the explicit assumption of time inhomogeneity in these definitions, with all 'layers' \(h\) being independent. The two sets define the set of all environments parametrized by \(=_{1}_{H}\) where \(_{h}=_{h}^{P}_{h}^{R}\). Note that the prior is assumed to be known to the learner. This setting implies that an environment \(\) sampled according to the prior \(=^{P}^{R}\) is essentially determined by its transition and reward functions pair \(\{(P_{h},r_{h})\}_{h=1}^{H}\). We simplify the notation to view \(\) as the set of all environments, i.e., saying

  Reference & Tabular & Linear & General & Comments \\ 
 & \(S^{2}AL}\) & - & - & - \\ 
 & - & - & \(L^{*}d_{E}HL}\) & 
 Uses Eluder dimension \\ Lipschitz assumption \\  \\ 
 & \(SAL}\) & - & - & Dirichlet prior \\ 
 & \(SAL}\) & - & - & Assumptions on prior \\ 
**** & \(L^{*}S^{2}A^{2}L}\) & - & \(L^{*}\) & 
 Assumptions on regularity \& noise \\  \\  
 & \(S^{2}A^{2}L}\) & - & - & - \\  This paper & \(SAL}\) & \(}HL}\) & \(}HL}\) & 
 Assumptions 1 \& 2 \\ Holds in the limit \(L\) \\  \\  

Table 1: Bayesian regret bounds for TS (i.e. PSRL)\(\) should be viewed as \(\{(P_{h},r_{h})\}_{h=1}^{H}\). The space of all possible real-valued functions \(\{(P_{h},r_{h})\}_{h=1}^{H}\) has a natural vector space structure. Therefore it is meaningful to discuss the notion of the convex combination of environments. We assume that \(\) is a convex subspace of the space of all possible environments. This assumption is not restrictive, since we may replace any environment space with its convex hull. Note that we do not assume that the support of the prior is convex.

_Remark 1_.: The case of joint prior may be of interest, but to our knowledge all prior works also take \(^{P},^{R}\) to be independent.

Agent, policy and history.An agent starts at an initial state \(s_{1}^{}\), which is fixed for all episodes \(\). It observes a state \(s_{h}^{}\) at layer \(h\) episode \(\), takes action \(a_{h}^{}\), and receives reward \(r_{h}^{}\). The environment changes to the next random state \(s_{h+1}^{}\) with probability \(P_{h}(s_{h+1}^{}|s_{h}^{},a_{h}^{})\). The agent stops acting at \(s_{H+1}\) and the environment is reset to its initial state.

We define \(_{,h}\) as the history \((s_{1}^{},a_{1}^{},r_{1}^{},,s_{h}^{},a_{h}^{},r_{h }^{})\). Denote by \(_{}=(_{1,H},,_{-1,H})\) the history up to episode \(\), where \(_{1}:=\). Finally, let \(_{h}=_{i=1}^{h}()\,\) be the set of all possible histories up to layer \(h\).

A policy \(\) is represented by stochastic maps \((_{1},,_{H})\) where each \(_{h}:_{h-1}_{,_{ }}\). Let \(_{S}\) denote the entire stationary policy class, stationary meaning a dependence only on the current state and layer and let \(_{S}\).

Value and state occupancy functions.Define the value function \(V_{h,}^{}\) as the value of the policy \(\) interacting with \(\) at layer \(h\):

\[V_{h,}^{}(s):=_{}^{}[_{h^{ }=h}^{H}r_{h^{}}(s_{h^{}},a_{h^{}})s_{h}=s ]\,,\] (1)

where \(_{}^{}\) denotes the expectation over the trajectory under policy, transition, and reward functions \(,P_{h},r_{h}\). The value function at step \(H+1\) is set to null, \(V_{H+1,}^{}():=0\). We assume there is a measurable function \(_{}^{*}:\) such that \(V_{h,_{}^{*}}^{}(s)=_{}V_{h,}^{ }(s),\; s,h[H]\). The optimal policy \(^{*}\) is a function of \(\), making it a random variable in the Bayesian setting. Lastly, let the _state-action occupancy probability measure_ be \(_{}^{}(s_{h}=s,a_{h}=a)\), also known as the state occupancy measure under policy \(\) and environment \(\). It follows from the definitions that this measure is absolutely continuous with respect to \(_{}:=_{}_{}\). Let \(d_{h,}^{}(s,a)\) denote the Radon-Nikodym derivative so that we have \(d_{h,}^{}(s,a)\,_{}= _{}^{}(s_{h}=s,a_{h}=a)\). We will assume throughout the paper that this density \(d_{h,}^{}(s,a)\) is measurable and upper bounded for all \(,,s,a,h\). The upper bound is a reasonable assumption, and it happens trivially in the tabular case (\(d_{h,}^{}(s,a) SA\)). This also happens, e.g., when one assumes that the maps \((,s,a,s^{},h) P_{h}^{}(s^{}|s,a)\) and \((,s,a,h)_{h}(a|s)\) are continuous and \(\), \(\), \(\) and the set of all optimal policies (as a subset of \(\)) are compact.

### Bayesian regret

We formulate the expected regret over \(L\) episodes and \(T=LH\) total steps in an environment \(\) as

\[_{L}(,)=[_{=1}^{L}(V_{1, _{}^{}}^{}(s_{1}^{})-V_{1,^{ }}^{}(s_{1}^{}))]\,,\] (2)

where the expectation is over the randomness of \(=\{^{}\}_{}\). The Bayesian regret is \(_{L}()=[_{L}(,)]\). For Thompson Sampling (TS), the algorithm selects the optimal policy of a given sample \(_{}\) picked from the posterior \(_{}(|_{})\):

\[_{}^{}=_{}V_{1,}^{_{} }(s_{1}^{})\,.\] (3)

Importantly, the law of TS aligns with the posterior, i.e., \((|_{})=(_{}^{}= _{}^{*}|_{})\).

_Remark 2_.: Note that \((_{}^{}=_{}^{*}|_{})\) is a probability for a specific measure on the space of optimal policies. To ensure that \(_{^{*}}(^{*}|_{})_{^{*}}=1\), we need an appropriate measure \(_{^{*}}\) on \(^{*}\). Given the law of TS, the natural choice for this measure is the push-forward of the prior measure \(\) under the map \(star:^{*}\), where \(star()=_{}^{*}\).

### Notations

For Bayesian RL, conditional expressions involving a given history \(_{}\) are widely used. We adopt the notation in  to refer to such conditionals; let \(_{}():=(|_{})\), \(_{}[]:=[|_{}]\). We can rewrite the Bayesian regret as

\[_{L}()=_{=1}^{L}[_ {}[V_{1,_{}^{}}^{}(s_{1}^{}) -V_{1,}^{}(s_{1}^{})]]\] (4)

and define the conditional mutual information \(_{}(X;Y):=D_{}(((X,Y)|_{ })||(X|_{})(Y| _{}))\). For a random variable \(\) and random policy \(\), the following will be involved in the information ratio:

\[_{}^{}(;_{,h}):=_{}(; _{,h}|)=_{}[D_{}(_{}( (,_{,h})|)||_{}(|) _{}(_{,h}|))],\] (5)

Note that \([_{}(X;Y)]=(X;Y|_{})\). To clarify, \(_{}(_{,h}|)\) is the probability of \(_{,h}\) being generated under \(\) within some environment. Given that the histories under consideration are generated by the TS algorithm, they are always generated in the true environment \(\) under an optimal policy \(_{^{}}^{*}\). For \(=_{}^{}\), this can be computed as \(_{}(_{,h}|)=_{}P(_{ ,h}|,)\,_{}()\), where \(P(_{,h}|,)\) is an expression in terms of transition and reward functions of \(\) and \(\).

Finally, we define \(}_{}\) as the mean MDP where \(P_{h}^{}_{}}(|s,a)=_{}[P_{h}^{}(|s,a)]\) is the mean of posterior measure, and similarly for \(r_{h}^{}_{}}(|s,a)=_{}[r_{h}^{}(|s,a)]\). We note that under the independence assumption across layers, the same is given for the state-occupancy density \(d_{h,}^{}_{}}=_{}[d_{h,}^{}_{}}]\).

## 3 Bayesian RL problems

**Definition 1**.: A Bayesian RL in this paper refers to the time-inhomogeneous finite-horizon MDP with independent priors on transition and reward functions, as described in Section 2.1.

The Bayesian RL _problem_ is the task of finding an algorithm \(\) with optimal Bayesian regret as defined in Eq. (4). Below we list the variations of this problem. A setting considered by most related works such as [31; 16] is the following:

**Definition 2**.: The **time (reward) homogeneous** Bayesian RL refers to the Bayesian RL setting where the prior \(^{P}\) (\(^{R}\)) is over the space \(^{P}\) (\(^{R}\)) containing the single transition (reward) function \(P\) (\(r\)) defining \(\), i.e., all layers have the same transition (reward) functions.

**Definition 3**.: The **tabular** Bayesian RL is a Bayesian RL where \(,\) are finite sets.

**Definition 4** (Linear MDP [41; 22]).: Let \(^{P}:^{d_{J}^{P}},^{ R}:^{d_{J}^{R}}\) be feature maps with bounded norm \(\|^{P}(s,a)\|_{2},\|^{R}(s,a)\|_{2} 1\). The **linear** Bayesian RL is a Bayesian RL where for any \(=\{(P_{h}^{},r_{h}^{})\}_{h=1}^{H}\), there exists vector-valued maps \(_{h}^{P,}(s),_{h}^{R,}(s)\) with bounded \(l_{2}-\)norm such that for any \((s,a)\),

\[P_{h}^{}(|s,a)=^{P}(s,a),_{h}^{P,}( )\,,\,\,\,r_{h}^{}(|s,a)=^{R}(s,a), _{h}^{R,}()\] (6)

A restricted version of the finite mixtures called linear mixture was first considered in  in the frequentist setting. Here, we consider the general setting.

**Definition 5**.: The **finite mixtures** Bayesian RL is a Bayesian RL where for any \(h[H]\) there exists fixed conditional distributions \(\{Z_{h,i}^{P}:_{}\}_{i=1 }^{m_{h}^{P}}\) and \(\{Z_{h,i}^{R}:_{}\}_{i=1}^{m_ {h}^{R}}\), such that for any environment \(\) given by \(\{(P_{h}^{},r_{h}^{})\}_{h=1}^{H}\), there exists parametrized probability distributions \(_{h}^{P,}:_{m_{h }^{P}},_{h}^{R,}:_ {m_{h}^{R}}\) such that

\[P_{h}^{}(|s,a)=_{i=1}^{m_{h}^{P}}a_{h,i}^{P,}(s,a )Z_{h,i}^{P}(|s,a),\,\,r_{h}^{}(|s,a)=_{i=1}^{m_{h}^{R} }a_{h,i}^{R,}(s,a)Z_{h,i}^{R}(|s,a)\] (7)Surrogate learning

Next, we define the discretized surrogate learning problem, and bound the size of the surrogate environments space, a significant term in the regret. To do so, we need to first define the Kolmogorov dimension of a set of parametrized distributions, esp. working out the case of \(l_{1}-\)distance. In the definitions below, we implicitly assume any required minimal measurability assumptions on the involved sets.

**Definition 6**.: Given a set \(\) of \(-\)parametrized distributions \(P:()\) over a set \(\) where both \(,\) are measurable. Let \((,):^{ 0}\) be a _distance_, i.e., \((P,Q) 0}{{}}P=Q\). Then its right \(-\)covering number is the size \(K_{}()\) of the smallest set \(_{}()=\{P_{1},,P_{K_{}( )}\}\) such that

\[ P,\; P_{j}_{}( ):\;(P,P_{j})\,.\] (8)

The potential asymmetry of \(\) (e.g., KL-divergence) requires the notion of left/right covering number. The right covering number will be the default, so covering number will always refer to that.

**Definition 7**.: Let \(d_{}()=(K_{}())\). Define the Kolmogorov \(-\)dimension \(d_{}\) of \(\) as

\[d_{}=_{ 0}}( )}{()}.\] (9)

For \(l_{1}(P,Q):=_{o}||P(|o)-Q(|o)||_{1}\), applying Definition 6 to the sets \(_{h}^{P},_{h}^{R}\) with \(=\), and denote the respective covering numbers by \(L_{h}^{P}(),L_{h}^{R}()\) corresponding to covering sets \(_{h}^{P}(),_{h}^{R}()\). Similarly applying Eq. (9) and denote the corresponding \(l_{1}-\)dimensions by \(d_{l_{1}}^{P},h(),d_{l_{1},h}^{R}(),d_{l_{1},h}^{P},d_{ l_{1},h}^{R},d_{l_{1},h}^{R}\) and \(d_{l_{1}}^{P}:=_{h}d_{l_{1},h}^{P},d_{l_{1}}^{R}:=_{h}d_{l_{1},h}^{R}\). The sums \(d_{l_{1},h}:=d_{l_{1},h}^{P}+d_{l_{1},h}^{R},d_{l_{1}}:=d_{l_{1}}^{P}+d_{l_{1} }^{R}\) can be interpreted as the \(l_{1}-\)dimension of \(_{h}\) and \(\), i.e., the environment space.

_Remark 3_.: We can also apply this framework to the KL-divergence, by \(_{}(P,Q):=_{o}D_{}(P( |o)||Q(||o))\). This was implicitly used by  to prove their regret bound in the tabular case. Note that Pinsker's lemma (Lemma 9) implies that the KL-divergence is larger than the squared total variance, and the latter is trivially larger than the \(l_{1}\) distance. Therefore, \(l_{1}-\)dimension is smaller than \(d_{_{}}\), allowing for tighter regret bounds.

We now revisit the definition of \(-\)value partitions and show their existence is guaranteed by finite \(l_{1}-\)covering numbers. These partitions are the origins of surrogate environments.

**Definition 8**.: Given \(>0\), an \(-\)value partition for a Bayesian RL problem is a partition \(\{_{k}\}_{k=1}^{K}\) over \(\) such that for any \(k[K]\) and \(,^{}_{k}\),

\[V_{1,_{}^{}}^{}(s_{1}^{})-V_{1,_{ }^{}}^{^{}}(s_{1}^{})\,.\] (10)

A _layered_\(-\)value partition is one where the transition functions are independent over layers after conditioning on \(k\). Throughout this paper, we will only consider layered \(-\)value partition. We define \(K_{}()\) as the minimum \(K\) for which there exists a layered \(-\)value partition.

Inspired by Eq. (9), we define the surrogate dimension as \(d_{}=_{ 0}}( )}{(1/)}\).

**Lemma 1**.: _Given a Bayesian RL, we have \(K_{}()_{h}L_{h}^{P}(/(2H)^{2})  L_{h}^{R}(/(4H))\). This implies \(d_{} d_{l_{1}}\)._

The above is proved in Appendix B. It is hard to find \(d_{}\), but one can estimate \(d_{l_{1}}\), and according to the above, this acts as a proxy for \(K_{}\). This is useful as the regret relates to \(K_{}\). But to show this, we need to construct _surrogate environments_ inside each partition, and show that learning those is almost equivalent to the original problem. Let \(\) be a discrete random variable taking values in \(\{1,,K_{}()\}\) that indicates the partition \(\) lies in, such that \(=k\) if and only if \(_{k}\).

**Lemma 2**.: _For any \(-\)value partition and any \([L]\), there are random environments \(}_{}^{*}\) with their laws only depending on \(,_{}\), such that_

\[_{}[V_{1,_{}^{*}}^{}(s_{1}^{})-V_ {1,_{}^{}}^{}(s_{1}^{})]-_{ }[V_{1,_{}^{*}}^{^{*}}(s_{1}^{})-V_{1,_ {}^{*}}^{^{*}}(s_{1}^{})]\,.\] (11)_The expectation in both equations is over \(\) and \(^{}_{}\{^{*}_{^{}}\}_{^{ }}\), with both sampled independently \(_{}()\), and the \(K\) different values of \(}^{*}_{}\). The second expectation over \((}^{*}_{},)\) is over pairs that are in the same partition, i.e., \(}^{*}_{},\) are independent only after conditioning on \(\)._

We note that the proof in [18, App. B.1] contains the use of a lemma that does not apply to construct the law of the environment \(}^{*}_{}\). More details is provided in Appendix C, where we find \(}^{*}_{}\) by minimizing an expected value of \(^{}_{}\).

## 5 Bayesian regret bounds for Thompson Sampling

### General Bayesian regret bound

We start by introducing the notion of value diameter.

**Definition 9**.: Given the environment \(\), its value diameter is defined as

\[_{}:=_{1 h H}(_{s}V^{}_{h,^{*} _{}}(s)-_{s}V^{}_{h,^{*}_{}}(s))+ _{1 h H,s,a}(r^{}_{h}(s,a)-r^{}_{ h}(s,a)),\]

where \(r^{}_{h}(s,a)\) (and \(r^{}_{h}(s,a)\)) is the supremum (and infimum) of the set of rewards that are attainable under the distribution \(r_{h}(s,a)\) with non-zero probability. As a special case, if rewards are deterministic, then we have \(r^{}_{h}(s,a)=r^{}_{h}(s,a)\) for all \(s,a\). The (average) value diameter over \(\) is denoted by \(:=_{}[_{}^{2}]^{1/2}\).

As the value function is between \(0\) and \(H\), we have \(_{} H+1\) implying \( H+1\). Note that value diameter is closely related to the notion of diameter commonly defined in finite RL problems. Strictly speaking, for a time-homogeneous RL, it is straightforward to see that the value diameter is bounded from above by one plus the diameter .

We now discuss the assumptions surrounding our results. The main technical assumption of this paper is the existence of consistent estimators, which as we will see in Appendix K, is closely related to the notion of posterior consistency:

**Assumption 1**.: _There exists a strongly consistent estimator of the true environment given the history._

Roughly speaking, we assume that with unlimited observations under TS, it is possible to find the true environment. For this assumption to fail, we need to have two environments that produce the same distribution over histories under TS and are therefore indistinguishable from the point of view of TS. The precise description of this assumption is detailed in Appendix K.

Another necessary technical assumption is that almost all optimal policies visit almost all state action pairs in their respective environment.

**Assumption 2**.: _For almost every environment \(\) and almost every \((s,a)\) and every \(h[H]\), we have_

\[d^{}_{h,^{*}_{}}(s,a) 0.\]

Recall that, for any environment \(\), the policy \(^{*}_{}\) is the optimal policy of \(\) within the policy class \(\). Therefore, one example of how the above assumption holds is when \(\) is the set of \(\)-greedy algorithms and transition functions of environments assign non-zero probability to every state. Under these assumptions, we discuss our main result and its corollaries.

**Theorem 3**.: _Given a Bayesian RL problem, for all \(>0\), we have_

\[_{L}(_{}) 2}())T}+L+T_{0}\] (12)

_where \(T_{0}\) does not depend on \(T\). This can be further upper bounded by_

\[_{L}(_{})(}T})\,.\] (13)

_for large enough \(T\). Given a homogeneous \(l_{1}\) dimension \(d_{}=d_{l_{1},h}, h\), this simplifies to_

\[_{L}(_{})(}T})\,.\] (14)

_Remark 4_.: For all regret bounds, we will replace \( H+1\) to compare our result. For the case of homogeneous dimensions, we obtain \((H^{3/2}}T})\). Crucially, our main result shows a new conceptual understanding of the information ratio by bounding it by two terms of different nature: \(H\) and \(\), where the latter can be bounded by either the largest diameter of the environments or \(H\).

_Remark 5_.: Despite not impacting the asymptotics, the impact of \(T_{0}\) can be large depending on the structure of the RL problem, and could be dominant even for large \(T\)s in practice.

_Remark 6_.: Considering time as a part of the state observation, one could apply this regret analysis to particular time-homogeneous settings. However, this mapping of time-inhomogeneous RLs to homogeneous ones is not surjective, hence the result above does not readily extend to time-homogeneous settings.

While  were the first to consider a nonlinear Bayesian RL model, their bound is limited to the Gaussian process (with linear kernel) setting, while ours in the nonlinear time inhomogeneous setting makes no assumptions on the prior and is the first such bound. Our novel analysis allow us to upper bound the information ratio by \(\) instead of, for example \(H^{3/2}\) () in the tabular case, improving the regret bound by a square root relevant to the dimension \(d\) of the problem.

The detailed proof is given in Appendix D. Following , the regret (4) is rewritten using Lemma 2 to reduce the problem into its surrogate, and we use the well-known information-ratio trick by multiplying and dividing by the mutual information. We follow that with a Cauchy-Schwarz, summarized below

\[_{L}(_{}) [_{=1}^{L}_{} [V_{1,_{}^{_{}^{*}}}^{_{}^{*} }(s_{1}^{})-V_{1,_{}^{_{}^{*}}}^{_{ }^{*}}(s_{1}^{})]}{_{}^{_{}^{ _{}^{*}}}(}_{}^{*};_{,H})}} ]+L\] (15) \[[_{=1}^{L} _{}[V_{1,_{}^{_{}^{*}}}^{_{ }^{*}}(s_{1}^{})-V_{1,_{}^{_{}^{*}}}^{ _{}^{*}}(s_{1}^{})])^{2}}{_{}^{ _{}^{_{}^{*}}}(}_{}^{*}; _{,H})}]}[_{=1}^{L}_{ }^{_{}^{_{}}}(}_{}^{*}; _{,H})]}+L\] (16)

Note the cost \(\) at each episode (Lemma 2) in the first inequality, yielding the overall error \(L\). Then, we can bound the mutual information appearing in the regret term by \([_{=1}^{L}_{}^{_{}^{_{}^{*}}}(}_{}^{*};_{,H})]=I_{ }^{_{}^{_{}^{*}}}(}_{}^ {*};_{}) I_{}^{_{}^{_{}^{*} }}(;_{})(K_{}())\), where we used the mutual information chain rule, followed by data processing inequality to substitute \(}_{}^{*}\), and finally used the trivial bound by the entropy. But the main novelty of our approach lies in our control of the first term

\[_{}(_{}^{}):=_{}[V_{1, _{}^{_{}^{*}}}^{_{}^{*}}(s_{1}^{ })-V_{1,_{}^{_{}^{*}}}^{_{}^{*}} (s_{1}^{})])^{2}}{_{}^{_{}^{_{}}}(}_{}^{*};_{,H})}\] (17)

called the information ratio. In our analysis, we have the following bound on its expectation.

\[[_{}(_{}^{})_{0}] [_{h}_{}[(_{} d_{h,^{*}}^{_{}}(s,a))^{2}]}{_{}[d_{h,^{*}}^{ _{}}(s,a)]}_{} _{0}],\]

where the average is taken over all histories \(_{}\) that are generated from running TS on the true environment \(_{0}\), and we have introduced the smaller term \(_{}\) instead of \(H\) in . While  essentially bound the above only in the tabular setting with \(SAH^{3}\), we manage to generally bound the above with a more precise bound using Doob's consistency theorem. Assumption 1 allows us to use Doob's consistency theorem to conclude that for almost every environment \(_{0}\), almost every infinite sequence of histories \((_{})_{=1}^{}\) sampled from \(_{0}\), and every integrable function \(f\), the posterior mean \(_{}[f()]=[f()_{}]\) converges to \(f(_{0})\). In particular, we conclude that \([_{}(_{}^{})_{0}]\) tends to \(_{_{0}}^{2}H\) in the limit, allowing us to claim that for large enough \(\), the expected information ratio \([_{}(_{}^{})]\) is uniformly bounded by \(2[_{}^{2}]H=2^{2}H\). As there are \(L\) many such ratios, the two bounds together yield \(2HL}}())}+L\). This bound is true for large enough \(\), giving the additional additive term \(T_{0}\) in the theorem. Since this term is additive, applying Lemma 1 to bound \((K_{}())\), we have successfully shown the asymptotic behavior of the regret, independent of the prior, is of order \((H}T})\).

### Applications

In each application below, the challenge is to bound \(d_{l_{1}}\) using the specifics of the model, and except for the case of tabular Bayesian RL, such analysis has not been carried out rigorously. We formalize the corollaries and show they are state-of-the-art compared to the literature.

Tabular RL.The result below follows from Theorem 3; the main contribution comes from our new information ratio bound, followed by the estimate \((()^{SAH})\) of \(K_{}()\) ().

**Corollary 4**.: _Given a tabular Bayesian RL problem, for large enough \(T\),_

\[_{L}(_{})()\,,\] (18)

_where the polylogarithmic terms are explicitly in terms of \(H,S,A,L\)._

We observe that our result matches  when their result in the time homogeneous setting (Definition 2) is extended to time inhomogeneous. However, in that paper, the authors assume a Dirichlet based prior which we do not.

Linear RL.A previous state-of-the-art \((d_{f}H^{3/2})\) was claimed by  to hold for linear Bayesian RLs with deterministic reward. We note:

* As in the previous cases, their proof in bounding their information ratio includes a factor of \(d_{f}\), which ours avoids.
* We show that the proof bounding \(K_{}()\) in [18, App. B.4] is incorrect, starting with a wrong application of Cauchy-Schwarz and a wrong mutual information in their definition of information ratio. We provide counterexamples for the estimates found therein to substantiate our claim (see Appendix G.1).

To state our own corollary in this case, we need to define a few notions. Let \(d_{l_{1}}^{f}=d_{l_{1}}^{P,f}+d_{l_{1}}^{R,f}\) be the sum of the \(l_{1}-\)dimensions of the feature map space \(\{_{h}^{P,}\}_{},\{_{h}^{R,}\}_{}\) where the \(l_{1}-\)distance between feature maps is defined as \(l_{1}(_{h}^{},_{h}^{^{}})=_{s}\|_ {h}^{}-_{h}^{^{}}\|_{1}_{}\). Our corollary also provides a concrete bound in the case of _mixture_ linear Bayesian RL where the feature maps are themselves a sum of finitely many **fixed** feature maps. This means for all \(\), we have

\[_{h}^{P,}=_{i=1}^{m_{h}^{P}}a_{h,i}^{P,}_{h,i}^{P}(s),\ \ _{h}^{R,}=_{i=1}^{m_{h}^{R}}a_{h,i}^{R,}_{h,i }^{R}(s)\] (19)

where \(\{_{h,i}^{P}(s)\}_{i=1}^{m_{h}^{P}},\{_{h,i}^{R}(s)\}_{i=1}^{m_{h}^{R}}\) are finitely many fixed feature maps and \(,h:_{i}|a_{h,i}^{P,}|^{2},_{i}|a_{h,i}^{R, }|^{2} C_{a}\) for some constant \(C_{a}>0\). Let \(M=M^{P}+M^{R}=_{h}m_{h}^{P}+_{h}m_{h}^{R}\).

**Corollary 5**.: _For a linear Bayesian RL, for large enough \(T\),_

\[_{L}(_{})(}^{f}T}).\] (20)

_Given a linear Bayesian RL with finitely many states and total feature space dimension \(d_{f}=d_{f}^{P}+d_{f}^{R}\), we have \(d_{l_{1}} 2d_{f}HS\), yielding for large enough \(T\),_

\[_{L}(_{})(ST}).\] (21)

_Given a mixture linear Bayesian RL, for large enough \(T\),_

\[_{L}(_{})()\,,\] (22)

The proof is given in Appendix G. The fact that \(d_{l_{1}}\) appears instead of \(d_{f}\) in the general bound is not counter-intuitive, as we should expect the complexity of the feature map space \(\{_{h}^{P,}(s)\}_{,h[H]},\{_{h}^{R, }(s)\}_{,h[H]}\) to play a role in the regret, especially as this space can be very complex, and model very different environments that can not be grouped in the same \(-\)value partition.

Therefore, opposite to the claim made by , this complexity can not be captured by simply \(d_{f}\) except maybe in degenerate cases, such as when \(\) is finite, which is our second statement. More generally, if each feature map \(_{h}^{P,}(s),_{h}^{R,}(s)\) can be characterized with a vector of uniformly bounded norm \(_{h}^{P,}^{m_{h}^{P}},_{h}^{R,}^{m_{h}^{P}}\), then we can bound the regret in terms of \(m_{h}^{P},m_{h}^{R}\)s, as is done in Eq. (22) (the finite state case corresponds to \(m_{h}^{P}=d_{f}^{P}S,m_{h}^{R}=d_{f}^{R}S\)).

Finite mixtures RL.To state our finite mixtures model result, we need to set the following notations. Let \(d_{l_{1}}^{m}=d_{l_{1}}^{m,P}+d_{l_{1}}^{m,R}=_{h}d_{l_{1},h}^{m,P}+_{h}d _{l_{1},h}^{m,R}\) correspond to the total \(l_{1}-\)dimension of the space of mixtures coefficient maps \(\{_{h}^{P,}(s,a)\}_{},\{_{h}^{R, }(s,a)\}_{}\) with \(l_{1}-\) distance defined as \(l_{1}(_{h}^{},_{h}^{^{}})=_{s,a} \|_{h}^{}(s,a)-_{h}^{^{}}(s,a)\|_{1}\). Define also the restricted finite mixtures model where \(_{h}^{P,},_{h}^{R,}\) are vectors in \(^{m_{h}},^{m_{h}}\) independent of \((s,a)\) and let \(M=M^{P}+M^{R}=_{h}m_{h}^{P}+_{h}m_{h}^{R}\).

**Corollary 6**.: _Given a finite mixtures Bayesian RL problem, for large enough \(T\),_

\[_{L}(_{})(}^{m}T})\.\] (23)

_Assuming the restricted finite mixtures model, for large enough \(T\),_

\[_{L}(_{})( )\.\] (24)

_which, given a uniform dimension \(m=m_{h}^{P}=m_{h}^{R}\), yields \(()\)._

We prove the above in Appendix H, deriving it from our generic bound, after relating the \(l_{1}-\)dimension \(d_{l_{1}}\) of the environment space to that of the mixtures coefficients. To the best of our knowledge, this is the first bound for finite mixtures Bayesian RL problems. We note that in a previous work (), a restricted version of finite mixtures, like in Eq. (24), was considered in the frequentist setting.

We finish this section by proposing the following conjecture, in line with [31, Conj. 1].

**Conjecture 7**.: _For the Bayesian RL, the following is true and optimal for **all**\(T\):_

\[_{L}(_{}) O(_{>0}( }())T}+L))\,.\] (25)

_where the constant factor is independent of the prior. This means there exists a Bayesian RL problem such that \(_{L}(_{})=(}T})\). All polylogarithmic terms are in terms of \(H,d_{},T\)._

Note that the above coincides with the lower bound for the (model-based) time inhomogeneous frequentist setting; see e.g.,  for the proven lower bound for the tabular case. This is also \(\) higher (this factor being baked in \(d_{}\)) than that of the time homogeneous frequentist setting, which is expected, according to [21, App. D]. Note that in this conjecture, the \(\) in our bound is replaced by \(\), and the conjecture is not for \(T\) large enough, but for all \(T\). Supporting this conjecture requires experiments where TS can be exactly implemented assuming access to an oracle which provides the optimal policy for a query environment. Simulations have been performed for the similar [31, Conj. 1] in the time homogeneous case. Our conjecture is similar but with the additional expected factor of \(\) due to time inhomogeneity, thus their simulation also supports the above.

## 6 Conclusions

In this paper, we have addressed the Bayesian Reinforcement Learning (RL) problem in the context of time inhomogeneous transition and reward functions. By considering both Bayesian transition and Bayesian rewards without prior assumptions, we have extended the scope of previous works, making our formulation more comprehensive. To simplify the learning problem, we have introduced surrogate environments, which discretize the environment space. We have established a connection between the size of this new environment space and the \(l_{1}\)-dimensions of the transition and reward functions space, providing insights into the \(l_{1}\)-dimension of the environment space denoted by \(d_{l_{1}}\). We have employed posterior consistency tools to analyze the information ratio, which captures the trade-off between exploration and exploitation. We conjecture that (at least a weakened version of) our posterior consistency assumption should hold in general, which is left for future work. Our analysis has resulted in a refined approach to estimate the Bayesian regret in Thompson Sampling (TS), yielding a regret bound of \((}T})\) for large enough time steps \(T\). The result is specialized to linear, tabular, and finite mixtures MDPs.

**Limitations:** While the paper provides asymptotic generic regret bound for TS in a generalized setup which improve the state of the art results, finding lower bounds, esp. one dependent on \(\), are left open. In addition, the issue of prior misspecificity is not discussed and left for future studies.