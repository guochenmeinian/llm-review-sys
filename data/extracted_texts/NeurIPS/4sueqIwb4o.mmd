# Regularized Q-Learning

Han-Dong Lim

Electrical Engineering, KAIST

limaries30@kaist.ac.kr &Donghwan Lee

Electrical Engineering, KAIST

donghwan@kaist.ac.kr

###### Abstract

Q-learning is widely used algorithm in reinforcement learning (RL) community. Under the lookup table setting, its convergence is well established. However, its behavior is known to be unstable with the linear function approximation case. This paper develops a new Q-learning algorithm, called RegQ, that converges when linear function approximation is used. We prove that simply adding an appropriate regularization term ensures convergence of the algorithm. Its stability is established using a recent analysis tool based on switching system models. Moreover, we experimentally show that RegQ converges in environments where Q-learning with linear function approximation was known to diverge. An error bound on the solution where the algorithm converges is also given.

## 1 Introduction

Recently, RL has shown great success in various fields. For instance, Mnih et al. (2015) achieved human level performance in several video games in the Atari benchmark (Bellemare et al., 2013). Since then, researches on deep RL algorithms have shown significant progresses (Lan et al.). Although great success has been achieved in practice, there is still gap between theory and the practical success. Especially when off-policy, function approximation, and bootstrapping are used together, the algorithm may show unstable behaviors. This phenomenon is called the deadly triad (Sutton and Barto, 2018).

For policy evaluation, especially for temporal-difference (TD) learning algorithm, there has been several algorithms to resolve the deadly triad issue. Bradtke and Barto (1996) uses the least-square method to compute a solution of TD-learning, but it suffers from \(O(h^{2})\) time complexity, where \(h\) is number of features. Maei (2011); Sutton et al. (2009) developed gradient descent based methods which minimize the mean square projected Bellman error. Ghiassian et al. (2020) added regularization term to TD Correction (TDC) algorithm, which uses a single time scale step-size. Lee et al. (2022) introduced several variants of the gradient TD (GTD) algorithm under control theoretic frameworks. Sutton et al. (2016) re-weights some states to match the on-policy distribution to stabilize the off-policy TD-learning. Bharadwaj Diddigi et al. (2020) uses \(l_{2}\) regularization to propose a new convergent off-policy TD-learning algorithm. Mahadevan et al. (2014) studied regularization on the off-policy TD-learning through the lens of primal dual method.

First presented by Watkins and Dayan (1992), Q-learning also suffers from divergence issues under the deadly triad. While there are convergence results under the look-up table setting (Watkins and Dayan, 1992; Jaakkola et al., 1994; Borkar and Meyn, 2000; Lee and He, 2020), even with the simple linear function approximation, the convergence is only guaranteed under strong assumptions (Melo et al., 2008; Lee and He, 2020; Yang and Wang, 2019).

The main goal of this paper is to propose a practical Q-learning algorithm, called regularized Q-learning (RegQ), that guarantees convergence under linear function approximation. We prove its convergence using the ordinary differential equation (O.D.E) analysis framework in Borkar and Meyn (2000) together with the switching system approach developed in Lee and He (2020). As in Leeand He (2020), we construct upper and lower comparison systems, and prove its global asymptotic stability based on switching system theories. Compared to the standard Q-learning in Watkins and Dayan (1992), a difference lies in the additional \(l_{2}\) regularization term, which makes the algorithm relevantly simple. Moreover, compared to the previous works in Carvalho et al. (2020); Maei et al. (2010), our algorithm is single time-scale, and hence, shows faster convergence rates experimentally. Our algorithm directly uses bootstrapping rather than circumventing the issue in the deadly triad. Therefore, it could give a new insight into training reinforcement learning algorithms with function approximation without using the so-called target network technique introduced in Mnih et al. (2015). The main contributions of this paper are summarized as follows:

1. A new single time-scale Q-learning algorithm with linear function approximation is proposed.
2. We provide a theoretical analysis on the solution of the projected Bellman equation where a regularization term is included.
3. We prove the convergence of the proposed algorithm based on the O.D.E approach together with the switching system model in Lee and He (2020).
4. We experimentally show that our algorithm performs faster than other two time-scale Q-learning algorithms in Carvalho et al. (2020); Maei et al. (2010).

**Related works**:

Several works (Melo et al., 2008; Lee and He, 2020; Yang and Wang, 2019) have relied on strong assumptions to guarantee convergence of Q-learning under linear function approximation. Melo et al. (2008) adopts an assumption on relation between behavior policy and target policy to guarantee convergence, which is not practical in general. Lee and He (2020) assumes a similar assumption to that of Melo et al. (2008) to ensure the convergence with the so-called switching system approach. Yang and Wang (2019) considered a transition matrix that can be represented by the feature values, which restricts the class of Markov chain.

Motivated by the empirical success of the deep Q-learning in Mnih et al. (2015), recent works in Zhang et al. (2021); Carvalho et al. (2020); Agarwal et al., Chen et al. (2023) use the target network to circumvent the bootstrapping issue and guarantee convergence. Carvalho et al. (2020) designed a two time-scale learning method motivated by the target network method. Zhang et al. (2021) uses \(l_{2}\) regularization with the target network, while a projection step is involved, which makes it difficult to implement practically. Moreover, it also relies on a two time-scale learning method. Chen et al. (2023) used target network and truncation method to address the divergence issue. Agarwal et al. additionally uses the so-called experience replay technique with the target network. Furthermore, the optimality is only guaranteed under a specific type of Markov chain. Even though, the target network update can guarantee stability, it often leads to slow convergence rate (Kim et al., 2019).

Maei et al. (2010) suggested the so-called Greedy-GQ (gradient Q-learning) algorithm, but due to non-convexity of the objective function, it could converge to a local optima. Lu et al. (2021) used linear programming approach (Manne, 1960) to design convergent Q-learning algorithm under deterministic control systems. Devraj and Meyn (2017) proposed a Q-learning algorithm that minimizes asymptotic variance. However, it requires the assumption that the number of changes of policy are finite, and involves matrix inversion at each iteration. Meyn (2023) introduced an optimistic training scheme with modified Gibbs policy for Q-learning with linear function approximation, which guarantees existence of a solution of the projected Bellman equation, but not the convergence. Geist et al. (2019); Xi et al. (2024) considered regularization on the policy which address a different scenario than the regularization in our work.

\(l_{2}\) regularization has been actively explored in the RL literature. Farahm et al. (2016) proposed a regularized policy iteration algorithm that addresses a regularized policy evaluation problem, followed by a policy improvement step. The authors derived a performance error bound. Zhang et al. (2021) studied regularized projected Bellman equation and proves that inside a certain ball, the solution of the regularized projected Bellman equation exist and is unique. Manek and Kolter (2022) studied fixed points of off-policy TD-learning algorithm with regularization showing that the bias of the solution caused by the regularization can be large under certain scenario. Nonetheless, the regularization method has been widely used in practice Farebrother et al. (2018); Piche et al. (2021).

Preliminaries and Notations

### Markov Decision Process

We consider an infinite horizon Markov Decision Process (MDP), which consists of a tuple \(=(,,P,r,)\), where the state space \(\) and action space \(\) are finite sets, \(P\) denotes the transition probability, \(r:\) is the reward, and \((0,1)\) is the discount factor. Given a stochastic policy \(:()\), where \(()\) is the set of probability distributions over \(\), agent at the current state \(s_{k}\) selects an action \(a_{k}(|s_{k})\), then the agent's state changes to the next state \(s_{k+1} P(|s_{k},a_{k})\), and receives reward \(r_{k+1}:=r(s_{k},a_{k},s_{k+1})\). A deterministic policy is a special stochastic policy, which can be defined simply as a mapping \(:\).

The objective of MDP is to find a deterministic optimal policy, denoted by \(^{*}\), such that the cumulative discounted rewards over infinite time horizons is maximized, i.e., \(^{*}:=_{}[_{k=0}^{}^{k}r_{k} ]\), where \((s_{0},a_{0},s_{1},a_{1},)\) is a state-action trajectory generated by the Markov chain under policy \(\), and \([|]\) is an expectation conditioned on the policy \(\). The Q-function under policy \(\) is defined as \(Q^{}(s,a)=[_{k=0}^{}^{k}r_{k}]s_{0}=s, a_{0}=a,\), \((s,a)\), and the optimal Q-function is defined as \(Q^{*}(s,a)=Q^{^{*}}(s,a)\) for all \((s,a)\). Once \(Q^{*}\) is known, then an optimal policy can be retrieved by the greedy action, i.e., \(^{*}(s)=_{a}Q^{*}(s,a)\). Throughout, we assume that the Markov chain is time homogeneous so that the MDP is well posed, which is standard in the literature. It is known that the optimal Q-function satisfies the so-called Bellman equation expressed as follows:

\[Q^{*}(s,a)=[.r_{k+1}+_{a_{k+1}} Q^ {*}(s_{k+1},a_{k+1})|(s_{k},a_{k})=(s,a)]:=Q^{*}(s,a), \]

where \(\) is called the Bellman operator.

### Notations

In this paper, we will use an O.D.E. model  of Q-learning to analyze its convergence. To this end, it is useful to introduce some notations in order to simplify the overall expressions. Throughout the paper, \(e_{a}\) and \(e_{s}\) denote \(a\)-th and \(s\)-th canonical basis vectors in \(^{||}\) and \(^{||}\), respectively, and \(\) stands for the Kronecker product. Let us introduce the following notations:

\[P:=P_{1}\\ \\ P_{||}^{|||| ||}, R:=R_{1}\\ \\ R_{||}^{||||}, Q :=Q_{1}\\ \\ Q_{||}^{||||},\] \[D_{a}:=d(1,a)\\ &\\ &&d(||,a)^{||||}, D:=D_{1}\\ &\\ &&D_{||}^{|||| ||||},\]

where \(P_{a}^{||||},a\) is the state transition matrix whose \(i\)-th row and \(j\)-th column component denotes the probability of transition to state \(j\) when action \(a\) is taken at state \(i\), \(P^{}^{||||||||}\) represents the state-action transition matrix under policy \(\), i.e.,

\[(e_{s} e_{a})^{T}P^{}(e_{s^{}} e_{a^{}})=[s_{k+1}=s^{},a_{k+1}=a^{}|s_{k}=s,a_{k}=a,],\]

\(Q_{a}=Q(,a)^{||},a\) and \(R_{a}(s):=[r(s,a,s^{})|s,a],s\). Moreover, \(d(,)\) is the state-action visit distribution, where i.i.d. random variables \(\{(s_{k},a_{k})\}_{k=0}^{}\) are sampled, i.e., \(d(s,a)=[s_{k}=s,a_{k}=a],\ (s,a)\). With a slight abuse of notation, \(d\) will be also used to denote the vector \(d^{||||}\) such that \(d^{T}(e_{s} e_{a})=d(s,a),\ (s,a)\). In this paper, we represent a policy in a matrix form in order to formulate a switching system model. In particular, for a given policy \(\), define the matrix \(^{}^{|||||||}\):

\[^{}:=[(e_{(1)} e_{1})(e_{(2)} e_{2}) (e_{(||)} e_{||})]^{}.\]

Then, we can prove that for any deterministic policy, \(\), we have \(^{}Q=[Q(1,(1))\ Q(2,(2)) Q(||,(| |))]^{T}\). For simplicity, let \(_{Q}:=^{}\) when \((s)=_{a}Q(s,a)\). Moreover, we can prove that for any deterministic policy \(\), \(P^{}=P^{}^{||||||| |}\), where \(P^{}\) is the state-action transition probability matrix. Using the notations introduced, the Bellman equation in (1) can be compactly written as \(Q^{*}= P_{Q^{*}}Q^{*}+R=:Q^{*}\), where \(_{Q^{*}}\) is the greedy policy defined as \(_{Q^{*}}(s)=_{a}Q^{*}(s,a)\).

### Q-learning with linear function approximation

Q-learning is widely used model-free learning to find \(Q^{*}\), whose updates are given as

\[Q_{k+1}(s_{k},a_{k}) Q_{k}(s_{k},a_{k})+_{k}_{k}, \]

where \(_{k}=r_{k+1}+_{a}Q_{k}(s_{k+1},a)-Q_{k}(s_{k},a_ {k})\) is called the TD error. Each update uses an i.i.d. sample \((s_{k},a_{k},r_{k+1},s_{k+1})\), where \((s_{k},a_{k})\) is sampled from a state-action distribution \(d(,)\).

Here, we assume that the step-size is chosen to satisfy the so-called the Robbins-Monro condition (Robbins and Monro, 1951), \(_{k}>0,\ _{k=0}^{}_{k}=,\ _{k=0}^{} _{k}^{2}<\). When the state-spaces and action-spaces are too large, then the memory and computational complexities usually become intractable. In such a case, function approximation is commonly used to approximate Q-function (Mnih et al., 2015; Hessel et al., 2018). Linear function approximation is one of the simplest function approximation approaches. In particular, we use the feature matrix \(X^{|||| h}\) and parameter vector \(^{h}\) to approximate Q-function, i.e., \(Q X\), where the feature matrix is expressed as \(X:=[x(1,1) x(1,||) x(||,||)]^{T}^{|||| h}\). Here, \(x(,)^{h}\) is called the feature vector, and \(h\) is a positive integer with \(h<\!\!<||||\). The corresponding greedy policy becomes \(_{X}(s)=_{a}x(s,a)^{T}\). Note that the number of policies characterized by the greedy policy is finite. This is because the policy is invariant under constant multiplications, and there exists a finite number of sectors on which the policy is invariant. Next, we summarize some standard assumptions adapted throughout this paper.

**Assumption 2.1**.: _The state-action visit distribution is positive, i.e., \(d(s,a)>0\) for all \((s,a)\)._

**Assumption 2.2**.: _The feature matrix, \(X\), has full column rank, and is a non-negative matrix. Moreover, columns of \(X\) are orthogonal._

**Assumption 2.3** (Boundedness on feature matrix and reward matrix).: _There exists constants, \(X_{}>0\) and \(R_{}>0\), such that \((||X||_{},||X^{T}||_{})<X_{}\) and \(||R||_{}<R_{}\)._

We note that except for the orthogonality of the feature matrix in Assumption 2.2, the assumptions in the above are commonly adopted in the literature, e.g. Carvalho et al. (2020); Lee and He (2020). Moreover, under Assumption 2.1, \(D\) is a nonsingular matrix with strictly positive diagonal elements.

**Lemma 2.4** (Gosavi (2006)).: _Under Assumption 2.3, \(Q^{*}\), is bounded, i.e., \(||Q^{*}||_{}}{1-}\)._

The proof of Lemma 2.4 comes from the fact that under the discounted infinite horizon setting, \(Q^{*}\) can be expressed as an infinite sum of a geometric sequence.

### Switching System

In this paper, we consider a particular system, called the _switched linear system_(Liberzon, 2003),

\[_{t}=A_{_{t}}x_{t}, x_{0}=z^{n}, t _{+}, \]

where \(x_{t}^{n}\) is the state, \(:=\{1,2,,M\}\) is called the set of modes, \(_{t}\) is called the switching signal, and \(\{A_{},\}\) are called the subsystem matrices. The switching signal can be either arbitrary or controlled by the user under a certain switching policy.

Stability and stabilization of (3) have been widely studied for decades. Still, finding a practical and effective condition for them is known to be a challenging open problem. Contrary to linear time-invariant systems, even if each subsystem matrix \(A_{}\) is Hurwitz, the overall switching system may not be stable in general. This tells us that tools in linear system theories cannot be directly applied to conclude the stability of the switching system.

Another approach is to use the Lyapunov theory (Khalil, 2002). From standard results in control system theories, finding a Lyapunov function ensures stability of the switching system. If the switching system consists of matrices with strictly negatively row dominant diagonals, defined in Definiton A.5 in the Appendix, or negative-definite matrices, we can always find a common (piecewise) quadratic Lyapunov function to ensure its stability. We use this fact to prove the convergence of the proposed algorithm.

**Lemma 2.5**.: _Consider a switched system in (3). Suppose one of the following two conditions hold:_

1. _Each_ \(A_{}\) _for_ \(\) _has a strictly negatively row dominating diagonal, i.e.,_ \([A_{}]_{ii}+_{j\{1,2,,n\}\{i\}}|[A_{}]_{ij}|<0\) _for all_ \(1 i n\)_._
2. \(A_{}+A_{}^{} 0\) _for all_ \(\)_._

_Then, the origin of (3) is asymptotically stable._

The proof is given in Appendix A.4

## 3 Projected Bellman equation

In this section, we introduce the notion of projected Bellman equation with a regularization term, and establish connections between it and the proposed algorithm. Moreover, we briefly discuss the existence and uniqueness of the solution of the projected Bellman equation. We will also provide an example to illustrate the existence and uniqueness of the solution.

### Projected Bellman equation (PBE)

When using the linear function approximation, since the true action value may not lie in the subspace spanned by the feature vectors, a solution of the Bellman equation may not exist in general. To resolve this issue, a standard approach is to consider the projected Bellman equation (PBE) defined as

\[X^{*}=X^{*}, \]

where \(:=X(X^{T}DX)^{-1}X^{T}D\) is the weighted Euclidean projection with respect to state-action visit distribution onto the subspace spanned by the feature vectors, and \(X^{*}= P_{X^{*}}X^{*}+R\). In this case, there are more chances for a solution satisfying the PBE to exist. Still, there may exist cases where the PBE does not admit a solution. To proceed, letting

\[A_{_{X^{*}}}:=X^{T}DX- X^{T}DP_{X^{*}}X,  b=X^{T}DR,\]

we can rewrite (4) equivalently as

\[X^{*}=X(X^{T}DX)^{-1}X^{T}D( P_{X^{*}}X ^{*}+R) A_{_{X^{*}}}^{*}=b, \]

Furthermore, we use the simplified notation \(C:=X^{T}DX\). A potential deterministic algorithm to solve the above equation is

\[_{k+1}=_{k}+_{k}(b-A_{_{X_{k}}} _{k}). \]

It iteratively solves the linear or nonlinear equation, which is a widely used algorithm called a Richardson iteration (Kelley, 1995). If it converges, i.e., \(_{k}^{*}\) as \(k\), then it is clear that \(^{*}\) solves (5). In this paper, the proposed algorithm is a stochastic algorithm that solves the modified equation

\[b-(A_{_{X_{}^{*}}}+ I)_{}^{*}=0, \]

where \(I\) is the \(h h\) identity matrix, and \( 0\) is a weight on the regularization term. We can use \( C\) instead of \( I\) as the regularization term but \( C\) is known to solve a MDP with modified discount factor Chen et al. (2023). Similar to (6), the corresponding deterministic algorithm is

\[_{k+1}=_{k}+_{k}(b-(A_{_{X_{k}}}+ I )_{k}). \]

If it converges, i.e., \(_{k}_{}^{*}\) as \(k\), then it is clear that \(_{}^{*}\) solves (7).

### Regularized projected Bellman equation

The equation (7) can be written as the regularized projected Bellman equation (RPBE)

\[X_{}^{*}=_{}X_{}^{*}, \]

where

\[_{}:=X(X^{}DX+ I)^{-1}X^{}D. \]The proof of the equivalence between (7) and (9) are given in Lemma A.12 in the Appendix Section A.3. The matrix \(_{}\) can be viewed as a modified projection operator which will be called the regularized projection. It can be interpreted as the projection with a regularization term \(_{}(x)=_{^{h}}(\|x-X \|_{D}^{2}+\|\|_{2}^{2})\). The concept is illustrated in Figure 0(a). Before moving forward, some natural questions that arise here are as follows: How does \(^{*}\) and \(^{*}_{}\) differ? Furthermore, which conditions can determine the existence and uniqueness of the solution of (4) and (9)? Partial answers are given in the sequel.

First, let us assume that the solution of (4) and (9), \(^{*}\) and \(^{*}_{}\), respectively, exist and are unique. To understand the difference between \(^{*}\) and \(^{*}_{}\), an important property of \(_{}\) is introduced:

**Lemma 3.1**.: _(a) The projection \(_{}\) satisfies the following properties: \(_{}_{}=0\) and \(_{ 0}_{}=\)._

_(b) We have \(\|_{}\|_{}\|X^{}D\|_{2}\|X \|_{2}\|(X^{}DX)^{-1}\|_{2}\) for all \( 0\)._

The proof is given in Appendix A.5. From the above result, one can observe that as \(\), the projection is attracted to the origin as illustrated in Figure 0(b). Moreover, as \( 0\), we will expect that \(^{*}_{}^{*}\). Furthermore, one can observe that the bound in item (b) of Lemma 3.1 cannot be controlled by simply scaling the feature function, and therefore, it more depends on the inherent structures of the feature matrix \(X\). The concept is illustrated in Figure 0(c). We will provide a more in-depth discussion on the error bound of \(^{*}_{}-^{*}\) in Section 3.3.

Now, we will discuss the existence and uniqueness of the solutions. Considering the non-existence of the solution of (4) , (9) may not also have a solution. However, for RPBE in (9), we can prove that under mild conditions, its solution exists and is unique. We provided an example where the solution does not exist for (4) but does exist for (9) in Appendix A.14. Let us first state a general condition such that the solution of (9) exists and is unique:

\[||_{}||_{}<1, \]

**Lemma 3.2**.: _Suppose that (11) holds. Then the solution of RPBE in (9) exists and is unique._

The proof is given in Appendix A.6, which uses Banach fixed-point theorem . From Lemma 3.2, we can see that the condition, \(||_{}||_{}<1\), is important to guarantee the uniqueness and existence of the solution. We will clarify under what situations the condition (11) can be met, and provide related discussions in Lemma 3.3, 3.4, and 3.5, where each lemma illustrate different scenarios when (11) is met. In particular, Lemma 3.3 shows that with simple feature scaling, \(\) can be easily chosen such that (11) holds. Furthermore, Lemma 3.4 considers a case when \(\) is in a small neighborhood of zero, and Lemma 3.5 considers the case when (11) should hold for all \( 0\).

We note that Zhang et al.  also studied the solution of the regularized projected Bellman equation. Nonetheless, the result of Zhang et al.  only ensures a unique solution within a certain ball whereas we consider the whole \(^{h}\) space.

**Lemma 3.3**.: _For \(>||X^{}D||_{}||X||_{}+||X^{}DX||_{}\), we have \(\|_{}\|_{}<1\)._

Figure 1: Illustrative explanation on the regularized projection. The Figure 0(c) implies that as \(\), \(_{}\) can potentially move outside of the unit ball satisfying \(||x||_{} 1\), and this phase is indicated with the term “blowing up” phase. The quantity \(\|_{}\|_{}\) actually blows up initially as \(\). However, since \(_{}\|_{}\|_{}=0\), we know that \(_{}\) will eventually converge to the origin and move inside the unit ball. This behavior is indicated by the “shrinking” phase in the figure.

The proof is given in Lemma A.11 in Appendix. From Lemma 3.3, we can satisfy the condition in (11) with scaling the values of the feature matrix \(X\). For example, if \((||X||_{},||X^{}||_{})<1\), it is enough to choose \(>2\) to meet the condition in Lemma 3.3. It is worth noting that scaling the values of feature matrix is a commonly employed technique in the both theoretical literature or in practice.

**Lemma 3.4**.: _Suppose \(||||_{}<1\) so that the solution point of PBE in (4) exists and is unique. Then, the condition \(0<)||(X^{}DX)^{-1}||_{}^{ -1}}{||(X^{}DX)^{-1}||_{}||X||_{}||X^{}D||_{}+( 1-||||_{})}\) implies \(||_{}||_{}<1\)._

The proof is in Appendix A.7. We note that the condition, \(||||_{}<1\) in Lemma 3.4 is used to guarantee the existence and uniqueness of the solution of PBE in (4), which is provided in Melo et al. (2008). Therefore, without any special conditions, we can guarantee the existence and uniqueness of the solution in the neighborhood of \(=0\).

**Lemma 3.5**.: _Suppose the feature vector satisfies \(X^{}DX=aI\) for a positive real number a such that \(a||S||A| 1\). Assume that \(||X||_{2} 1\) and \(D=1/(||||)I\). Then, (11) holds for all \(>0\)._

The proof is given in Appendix A.8. A simple example where the above statement holds is by letting \(X=I\). This is only a conceptual example and there could be many other examples in existence.

### Error analysis

As promised in the previous section, we provide discussion on the behavior and quality of \(_{}^{*}\), i.e., the error bound analysis in \(^{*}-_{}^{*}\) depending on \(\). Even though Manek and Kolter (2022) provided a specific example when the bias can be large in the policy evaluation case, throughout the analysis, we show that the error can be small under particular scenarios.

Let us first examine the case when \( 0\) and \(\). As discussed in Section 3.2, we can consider \( 0\) if we can guarantee the existence of \(_{}^{*}\) and \(^{*}\) when \(\) is nearby the origin, for example in the case of Lemma 3.4 and 3.5. As \( 0\), (4) and (9) coincide, implying that \(_{}^{*}^{*}\).

Furthermore, as \(\) gets larger, by Lemma 3.3, we can always guarantee existence and uniqueness of \(_{}^{*}\) after a certain threshold. As from the discussion of Lemma 3.1, we expect \(_{}^{*} 0\), which is stated in the following lemma whose proof is given in Appendix A.9:

**Lemma 3.6**.: _We have \(_{}_{}^{*}=0\)._

Note that even if a solution satisfying (7) exists, \(X_{}^{*}\) may be different from \(Q^{*}\). However, we can derive a bound on the error, \(X_{}^{*}-Q^{*}\), using simple algebraic inequalities and contraction property of the Bellman operator. We present the error bound of the solution in the following lemma:

**Lemma 3.7**.: _Suppose (11) holds. Then, we have \(:\)\(||X_{}^{*}-Q^{*}||_{}||_{ }}||_{}Q^{*}-Q^{*}||_{}\)._

The proof is given in Appendix A.10. We provide a discussion on the error bound in the following:

1) \( 0\): Consider the case when \(_{}^{*}\) and \(^{*}\) exists and unique, for example the condition in Lemma 3.4 is satisfied. Since \(_{}\) from Lemma 3.1, we exactly recover the error bound by fixed point of original projected Bellman equation (\(=0\)) in (4), which is \(-Q^{*}||_{}}{1-||||_{}}\) provided in Melo et al. (2008). Thus, our bound in Lemma 3.7 is tight when \( 0\).

2) \(\): As from Lemma 3.3, \(_{}^{*}\) always exist when \(\) gets larger than certain value. Noting that \(_{} 0\), we have \(||X_{}^{*}-Q^{*}||_{}||Q^{*}||_{}\). Considering that \(_{}^{*} 0\) as \(\) from Lemma 3.6, we should have \(||X 0-Q^{*}||_{}=||Q^{*}||_{}\). Thus, our bound in Lemma 3.7 is tight when \(\).

3) The error bound is close to zero: An upper bound on Lemma 3.7 can be obtained by simple algebraic manipulation:

\[||X_{}^{*}-Q^{*}||_{} Q^{*}-Q^{*}||_{}}{1-||_{ }||_{}}||_{}}( {||_{}Q^{*}- Q^{*}||_{}}_{}+-Q^{*}||_{}}_{}). \]

Suppose that the features are well designed such that (T2) in (12) will be small. For example, if \(Q^{*}\) is in the range space of \(X\), then the error term in (T2) vanishes. Moreover, we can make (T1) arbitrarily small as follows: as \( 0\), we have \(||_{}-||_{} 0\) while \(1-||_{}||_{}>0\). This yields (T1) in (12) to be sufficiently small. In the end, we will have \(||X_{}^{*}-Q^{*}||_{}\) for any \( 0\).

4) When the PBE does not admit a fixed point around \(=0\): In this case, we should always choose \(>0\) greater than a certain number, and (T1) cannot be entirely vanished, while (T2) can be arbitrarily close to zero when \(Q^{*}\) is close to the range space of \(X\). The error in (T1) cannot be overcame because it can be seen as a fundamental error caused by the regularization for PBE. However, (T1) can be still small enough in many cases when \(||-_{}||_{}\) is small.

## 4 Algorithm

In this section, we will introduce our main algorithm, called RegQ, and elaborate the condition on the regularization term to make the algorithm convergent. The proposed algorithm is motivated by TD-learning. In particular, for on-policy TD-learning, one can establish its convergence using the property of the stationary distribution. On the other hand, for an off-policy case, the mismatch between the sampling distribution and the stationary distribution could cause its divergence (Sutton et al., 2016). To address this problem, Bharadwaj Diddigi et al. (2020) adds a regularization term to TD-learning in order to make it convergent. Since Q-learning can be interpreted as an off-policy TD-learning, we add a regularization term to Q-learning update motivated by Bharadwaj Diddigi et al. (2020). This modification leads to the proposed RegQ algorithm as follows:

\[_{k+1}=_{k}+_{k}(x(s_{k},a_{k})_{k}- _{k}) \]

The pseudo-code is given in Appendix A.16. Note that it can be viewed as a gradient descent step applied to the TD-loss \(L():=(y_{k}-Q_{}(s_{k},a_{k}))^{2}+\| \|_{2}^{2}\), where \(y_{k}=r_{k+1}+_{a A}Q_{_{k}}(s_{k+1},a)\) is the TD-target, and \(Q_{_{k}}=X_{k}\). Furthermore, letting \(=0\), the above update is reduced to the standard Q-learning with linear function approximation in (2). The proposed RegQ is different from Bharadwaj Diddigi et al. (2020) in the sense that a regularization term is applied to Q-learning instead of TD-learning. Rewriting the stochastic update in a deterministic manner, it can be written as follows:

\[_{k+1}=_{k}+_{k}(b-(A_{ x_{k_{k}}}+  I)_{k}+m_{k+1}), \]

where \(m_{k+1}=_{k}x(s_{k},a_{k})-_{k}-(b-(A_{ x_{k_{k}}}+  I)_{k})\) is a Martingale difference sequence. Without \(m_{k+1}\), (14) is reduced to the deterministic version in (8). In our convergence analysis, we will apply the O.D.E. approach, and in this case, \(A_{ x_{k}}+ I\) will determine the stability of the corresponding O.D.E. model, and hence, convergence of (13). Note that (14) can be interpreted as a switching system defined in (3) with stochastic noises. As mentioned earlier, proving the stability of a general switching system is challenging in general. However, we can find a common Lyapunov function to prove its asymptotic stability. In particular, we can make \(-(A_{ x_{k}}+ I)\) to have a strictly negatively row dominant diagonal or negative-definite under the following condition:

\[>\{D||_{}||X||_{ }+||X^{}DX||_{}}_{(S1)},(C)( _{\\ (s,a) S}P^{}(e_{a}  e_{s})}{2d(s,a)}-)}_{(S2)}\}, \]

The conditions in \((S1)\) and \((S2)\), which make \(-(A_{ x_{k}}+ I)\) to have strictly negatively row dominant diagonal or negative definite matrix, respectively, do not necessarily imply each others, which are discussed in Appendix A.15. Now, we can use the Lyapunov argument to establish stability of the overall system. Building on the fact, in the next section, we prove that under the stochastic update (13), we have \(_{k}_{}^{*}\) as \(k\) with probability one, where \(_{}^{*}\) satisfies RPBE in (7). If \(=0\) satisfies (15), we can guarantee convergence to an optimal policy without errors.

## 5 Convergence Analysis

Recently, Lee and He (2020) suggested a switching system framework to prove the stability of Q-learning in the linear function approximation cases. However, its assumption on the behavior policy and feature matrix seems too stringent to check in practice. Here, we develop more practical Q-learning algorithm by adding an appropriately preconditioned regularization term. We prove the convergence of the proposed Q-learning with regularization term (13) following lines similar to Lee and He (2020). Our proof mainly relies on Borkar-Meyn theorem. Therefore, we first discuss about the corresponding O.D.E. for the proposed update in (13), which is

\[_{t}=-(X^{T}DX+ I)_{t}+ X^{T}DP_{X _{t}}X_{t}+X^{T}DR:=f(_{t}). \]

Then, using changes of coordinates, the above O.D.E. can be rewritten as

\[(_{t}-_{}^{*})= (-A_{_{X_{t}}}- I)(_{t}-_{}^{*})+  X^{T}DP(_{X_{t}}-_{X_{}^{*}})X_{}^{*}, \]

where \(_{}^{*}\) satisfies (7). Here, we assume that an equilibrium point exists and is unique. We later prove that if an equilibrium exists, then it is unique. To apply Borkar-Meyn theorem in Lemma A.1, we discuss about the asymptotic stability of the O.D.E. in (17). Note that (17) includes an affine term, i.e., it cannot be expressed as a matrix times vector \(_{t}-_{}^{*}\). It is in general hard to establish asymptotic stability of switched linear system with affine term compared to switched linear system (3). To circumvent this difficulty, Lee and He (2020) proposed upper and lower comparison systems, which upper bounds and lower bounds the original system. Then, the stability of the original system can be established by proving the stability of the upper and lower systems, which are easier to analyze. Following similar lines, to check global asymptotic stability of the original system, we also introduce upper and lower comparison systems. Then, we prove global asymptotic stability of the two bounding systems. Since upper and lower comparison systems can be viewed as switched linear system and linear system, respectively, the global asymptotic stability is easier to prove. We stress that although the switching system approach in Lee and He (2020) is applied in this paper, the detailed proof is entirely different and nontrivial. In particular, the upper and lower comparison systems are given as follows:

\[_{t}^{u}=(-X^{T}DX- I+ X^{T}DP_{X_ {t}^{*}}X)_{t}^{u},_{t}^{l}=(-X^{T}DX- I+ X^{ T}DP_{X_{}^{*}}X)_{t}^{l},\]

where \(_{t}^{u}\) and \(_{t}^{l}\) denote the states of the upper and lower systems, respectively. We defer the detailed construction of each system to Appendix A.12. The stability of overall system can be proved by establishing stability of the upper and lower comparison systems.

**Theorem 5.1**.: _Suppose \(\) satisfies (15), and Assumption 2.1, 2.2, and 2.3 hold. Moreover, assume that a solution of RPBE in (7) exists. Then, it is also unique, and the origin is the unique globally asymptotically stable equilibrium point of (17)._

The detailed proof is given in Appendix A.12. Building on the previous results, we now use Borkar and Meyn's theorem in Lemma A.1 to establish the convergence of RegQ. The full proof of the following theorem is given in Appendix A.13.

**Theorem 5.2**.: _Suppose \(\) satisfies (15), then with Assumption 2.1, 2.2, and 2.3 holds. Assume that solution of RPBE in (7) exists. Then, \(_{}^{*}\) is unique, and under the stochastic update (13), \(_{k}_{}^{*}\) as \(k\) with probability one, where \(_{}^{*}\) satisfies (7)._

We note that if \(\) is larger than the term \((S_{1})\) in (15), then \(_{}^{*}\) exists and is unique by Lemma 3.3.

## 6 Experiments

In this section, we briefly present the experimental results under well-known environments in Tsitsiklis and Van Roy (1996), Baird (1995), where Q-learning with linear function approximation diverges. As from Figure 1(b), our algorithm shows faster convergence rate than other algorithms. Further details on the experiments are deferred to Appendix B. In Appendix B.6, we also compare performance under the Mountain Car environment (Sutton and Barto, 2018) where Q-learning performs well. In Appendix B.5, we show experimental results under various step-size and \(\). Moreover, the trajectories of upper and lower systems to illustrate the theoretical results are given in Appendix B.7.

## 7 Conclusion

In this paper, we presented a new convergent Q-learning with linear function approximation (RegQ), which is simple to implement. We provided theoretical analysis on the proposed RegQ, and demonstrated its performance on several experiments, where the original Q-learning with linear function approximation diverges. Developing a new Q-learning algorithm with linear function approximation without bias would be one interesting future research topic. Moreover, considering the great success of deep learning, it would be interesting to develop deep reinforcement learning algorithms with appropriately preconditioned regularization term instead of using the target network.

## 8 Acknowledgements

The work was supported by the Institute of Information Communications Technology Planning Evaluation (IITP) funded by the Korea government under Grant 2022-0-00469, and the BK21 FOUR from the Ministry of Education (Republic of Korea).