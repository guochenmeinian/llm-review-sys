# Hierarchical Integration Diffusion Model for

Realistic Image Deblurring

 Zheng Chen\({}^{1}\), Yulun Zhang\({}^{2*}\), Ding Liu\({}^{3}\), Bin Xia\({}^{4}\), Jinjin Gu\({}^{5,6}\), Linghe Kong\({}^{1}\), Xin Yuan\({}^{7}\)

\({}^{1}\)Shanghai Jiao Tong University, \({}^{2}\)ETH Zurich, \({}^{3}\)Bytedance Inc, \({}^{4}\)Tsinghua University,

\({}^{5}\)Shanghai AI Laboratory, \({}^{6}\)The University of Sydney, \({}^{7}\)Westlake University

Corresponding authors: Yulun Zhang, yulun100@gmail.com; Linghe Kong, linghe.kong@sjtu.edu.cn

###### Abstract

Diffusion models (DMs) have recently been introduced in image deblurring and exhibited promising performance, particularly in terms of details reconstruction. However, the diffusion model requires a large number of inference iterations to recover the clean image from pure Gaussian noise, which consumes massive computational resources. Moreover, the distribution synthesized by the diffusion model is often misaligned with the target results, leading to restrictions in distortion-based metrics. To address the above issues, we propose the Hierarchical Integration Diffusion Model (HI-Diff), for realistic image deblurring. Specifically, we perform the DM in a highly compacted latent space to generate the prior feature for the deblurring process. The deblurring process is implemented by a regression-based method to obtain better distortion accuracy. Meanwhile, the highly compact latent space ensures the efficiency of the DM. Furthermore, we design the hierarchical integration module to fuse the prior into the regression-based model from multiple scales, enabling better generalization in complex blurry scenarios. Comprehensive experiments on synthetic and real-world blur datasets demonstrate that our HI-Diff outperforms state-of-the-art methods. Code and trained models are available at https://github.com/zhengchen1999/HI-Diff.

## 1 Introduction

Image deblurring is a long-standing computer vision task, aiming to recover a sharp image from a blurred observation. Blurred artifacts can arise from various factors, _e.g._, camera shake and fast-moving objects. To address this challenge, traditional methods typically formulate the task as an optimization problem and incorporate natural priors  to regularize the solution space. However, since blur in real scenarios is complex and non-uniform, which is hard to be modeled by the specific priors, these algorithms suffer from poor generalization in complex situations.

With the development of deep learning, convolutional neural networks (CNNs) have been applied in image deblurring . Among them, the regression-based methods have shown remarkable success, especially in terms of distortion-based metrics (_e.g._, PSNR). Moreover, Transformer-based approaches , which can capture long-distance dependencies, are introduced as an alternative to CNNs. These methods further boost the deblurring performance. However, regression-based methods are prone to recovering images with fewer details, since the regression losses are conservative with high-frequency details .

Apart from regression-based methods, deep generative models, like generative adversarial networks (GANs)  and normalizing flows , provide other solutions for generating complex details. Recently, Diffusion Models (DMs)  have exhibited impressive performance in image synthesis  and restoration tasks (including image deblurring) . DMs generate high-fidelity images through a stochastic iterative denoising process from a pure white Gaussian noise. Compared to other generative models, such as GANs, DMs generate a more accurate target distribution without encountering optimization instability or mode collapse.

Nonetheless, DM-based methods face several challenges. **First**, DMs are limited by the high computational cost of generating samples. It requires a high number of inference steps. Some methods reduce the number of iterations by predicting the residual distribution  or applying advanced sampling strategies [41; 3]. However, the overall computational complexity is still high, especially for high-resolution images. Furthermore, although some methods perform DMs on latent space , the compression ratio is small (_e.g._, 8 times), due to limitations in generation quality. **Second**, generative models, including DMs, tend to produce undesired artifacts not present in the original clean image. Besides, the generated details may also be misaligned with real targets. These lead to the poor performance of DM regarding some distortion-based metrics (_e.g._, PSNR).

The aforementioned issues promote us to apply DMs from another perspective. The motivation for our work is threefold. **First**, due to the high computational overhead in the image space, we also consider applying DMs on the low-dimensional latent space. Meanwhile, we increase the compression ratio of latent to effectively reduce the computational complexity. **Second**, since the advantages of regression-based methods in distortion accuracy, we integrate DMs and regression-based methods to improve the performance of DMs regarding distortion. **Third**, considering the non-uniform blur in real scenarios, we apply a hierarchical approach to enhance the generalization of the method.

Specifically, we apply DMs to generate priors in latent space, inspired by the application of priors in traditional deblurring algorithms. The priors are integrated into the regression-based model in a hierarchical manner to improve the details of restored images. The design contains three benefits: **(1)** The dimension of latent space can be very low, since the regression-based model restores most of the distribution. **(2)** The issue of distortion caused by misaligned details generated by DMs can be avoided. **(3)** The hierarchical integration enables better generalization in complex blurry scenarios.

Based on the above analysis, we propose a novel approach called the Hierarchical Integration Diffusion Model (HI-Diff) for realistic image deblurring. Following previous practice [10; 35; 51], we perform a two-stage training to realize latent compression and the training of the DM, respectively. Without loss of generality, for the regression-based methods, we choose the encoder-decoder Transformer architecture. **In the first stage**, we compress the ground-truth image into a highly compact latent representation as the prior feature through a latent encoder (LE). We propose the hierarchical integration module (HIM) that can fuse the prior and intermediate features of Transformer at multiple levels. We jointly train the LE and Transformer to effectively construct the prior. **In the second stage**, we train a latent diffusion model to generate the prior feature in the latent space from the Gaussian noise and guide Transformer through the HIM. Similar to the first stage, we jointly train the DM and Transformer. In summary, our main contributions are three-fold as follows:

* We propose the Hierarchical Integration Diffusion Model (HI-Diff), for realistic image deblurring. The HI-Diff leverages the power of diffusion models to generate informative priors, that are integrated into the deblurring process hierarchically for better results.
* We apply the diffusion model in highly compact latent space to generate the prior. Meanwhile, we propose the hierarchical integration module to fuse the prior into the regression-based model from multiple scales, enabling the generalization in complex blurry scenarios.
* Extensive experiments conducted on synthetic and real-world blur datasets demonstrate the superior performance of the HI-Diff in comparison to state-of-the-art deblurring methods.

## 2 Related Work

### Image Deblurring

**Traditional Methods.** Traditional deblurring methods generally formulate the problem as an optimization problem [12; 38; 24; 6; 29]. They utilize various natural image priors for sharp images and blur kernels. Common methods include local smoothness prior , sparse image prior , \(L_{0}\)-norm gradient prior , and dark channel prior . However, these methods rely on manually crafted priors, which results in poor generalization ability and limited performance in complex situations.

**Deep CNN-based Methods.** With the rapid development of deep learning, significant progress has been made in image deblurring using CNN-based methods [37; 28; 43; 55; 1; 16]. For instance, MSCNN  designs a multi-scale CNN to restore sharp images. SRN  proposes a coarse-to-fine scale-recurrent network for more efficient multi-scale image deblurring. DMPHN  devises a deep multi-patch hierarchical deblurring network to exploit the deblurring information at different scales. XYDeblur , on the other hand, divides the original deblurring problem into two sub-problems.

**Transformer-based Methods.** Recently, Transformer [46; 9] proposed in natural language processing (NLP), which utilizes the self-attention (SA) mechanism to model long-range dependence, has shown remarkable performance in image deblurring [48; 53; 44]. For example, Restormer  utilizes "transposed" attention, which calculates the SA across channel dimension instead of spatial dimension, to model global information and keep computational efficiency to large images. Stripformer  constructs horizontal and vertical strip tokens to catch region-specific blurred patterns with different orientations in dynamic scenes. These methods further improved the deblurring performance compared with CNN-based Methods. However, they are limited in recovering image details, since the regression-based methods are conservative with high-frequency details .

### Diffusion Models

Diffusion Models (DMs) [40; 15] are probabilistic generative models that enable the construction of desired data samples from the Gaussian noise via a stochastic iterative denoising process. DMs have demonstrated excellent performance in various image restoration tasks [18; 17; 47; 7], such as super-resolution [36; 25], inpainting , and deblurring . A survey  summarizes more diffusion-based restoration methods. For example, DiffIR  utilizes the diffusion model to generate a prior representation for image restoration, and applies a two-stage training approach. DvSR  introduces conditional DMs into image deblurring with a residual model, showing more realistic results than regression-based methods. InDI  directly produces high-quality results by restoring low-quality images. However, one of the restrictions of DMs is the large number of iteration steps required in inference. Some methods attempt to mitigate this limitation by applying well-designed noise schedules  and sampling strategies  or performing DM on the latent space . Despite these efforts, the overall complexity remains high, especially for high-resolution images common in image deblurring. Additionally, these methods are susceptible to misaligned details distribution and undesired artifacts, resulting in poor performance in distortion-based metrics, _e.g._, PSNR.

## 3 Method

Our goal is to integrate the diffusion model (DM) and the regression-based model, thus overcoming the shortcomings of the DM and realizing better deblurring. We propose the Hierarchical Integration Diffusion Model (HI-Diff). The HI-Diff performs the DM to generate the prior feature that is integrated hierarchically into Transformer (the regression-based model).

Figure 1: The overall framework of our HI-Diff. (a) Transformer, adopts hierarchical encoder-decoder architecture, equipped with HIM, for the deblurring process. (b) Diffusion Model, is performed in a highly compact latent space for computational efficiency. (c) The multi-scale prior feature \(\{_{1},_{2},_{3}\}\) is obtained by downsampling the prior feature multiple times. In stage one, \(_{1}{=}\); in stage two, \(_{1}{=}}\). (d) The hierarchical integration module (HIM), calculates cross-attention between the intermediate feature of Transformer and the multi-scale prior feature. (e) The latent encoder (LE), where the size of the input feature (\(in\)) is \(H{}W{}6\) for \(\), and \(H{}W{}3\) for \(_{}\).

The overall framework of the proposed HI-Diff is depicted in Fig. 1. The HI-Diff consists of two parts: Transformer and the latent diffusion model. We adopt Restormer , a hierarchical encoder-decoder Transformer architecture, in our method. Compared with other Transformer networks designed specifically for image deblurring, Restormer is a general restoration model. Applying this model in our method can better illustrate the effectiveness of our proposed method. Meanwhile, following previous practice [10; 35; 51], we train our HI-Diff with a two-stage training strategy, to realize latent compression and the training of the DM. In this section, we first elaborate on the two-stage training framework and then illustrate the whole deblurring inference process.

### Stage One: Latent Compression

In stage one, our purpose is to compress the ground truth image into the highly compact latent space, and utilize it to guide Transformer in the deblurring process. As shown in Fig. 1(a, b), we compress the ground truth images through a latent encoder (LE) to obtain a compact representation as the prior feature. Then we integrate the prior feature into Transformer through the hierarchical integration module (HIM). The prior feature can provide explicit guidance for Transformer, thus increasing the details of the reconstructed image. Next, we describe these parts in detail.

**Latent Encoder.** As shown in Fig. 1(b), given the blurry input image \(_{Blur}{}^{H W 3}\) and its corresponding ground truth counterpart \(_{GT}{}^{H W 3}\), we first concatenate them along the channel dimension and feed them into the latent encoder (LE) to generate the prior feature \(^{N C^{}}\). Here \(H\) and \(W\) represent the image height and width, while \(N\) and \(C^{}\) are the token number and channel dimensions of \(\). Importantly, the token number \(N\) is a constant much smaller than \(H{}W\). The compression ratio (\(\)) is much higher than that applied in previous latent diffusion  (_e.g._, 8 times). Therefore, the computational burden of the subsequent latent diffusion model is effectively reduced. The details of the latent encoder are depicted in Fig. 1(e), which contains \(L\) residual blocks.

**Hierarchical Integration Module.** To effectively integrate the prior feature and intermediate feature of Transformer, we propose the hierarchical integration module (HIM). As illustrated in Fig. 1(a), the HIM is placed in front of each encoder and decoder. For each HIM, cross-attention is computed between the prior and intermediate features for feature fusion. This module allows the information in the prior feature to be aggregated into features of Transformer.

Specifically, as shown in Fig. 1(d), given the intermediate feature \(_{in}{}^{ W}\), we reshaped it as tokens \(_{r}{}^{W}\); where \(\) is spatial resolution, and \(\) denotes channel dimension. Then we linearly project \(_{r}\) into \(^{W}\) (\(query\)). Similarly, we project the prior feature \(_{i}{}^{ C^{}}\) as \(^{}\) (\(key\)) and \(^{}\) (\(value\)). The cross-attention is formulated as:

\[=_{Q}_{r},=_{K}_{i },=_{V}_{i},\] (1)

where \(_{Q}{}^{}\), \(_{K}{}^{C^{}}\), and \(_{V}{}^{C^{}}\) represent learnable parameters of linear projections without bias. As vanilla multi-head self-attention [46; 9], we separate channels into multiple "heads" and calculate the attention operations. Note that Fig. 1(d) depicts the situation with a single head and omits some details for simplification. Finally, we reshape and project the output of cross-attention, and add it with \(_{in}\) to derive the output feature \(_{out}{}^{}\).

Moreover, since the non-uniform blur in real scenarios, the single-scale prior feature cannot adapt well to complex blurry situations. Therefore, we generate the multiple-scale prior feature \(\{_{1},_{2},_{3}\}\) (where \(_{1}{=}\)), by downsampling the prior feature \(\), as shown in Fig. 1(c). The multiple-scale prior feature adapts to different scale intermediate features for better fusion. The effectiveness of the hierarchical integration with the multiple-scale prior feature is demonstrated in Sec. 4.2.

**Training Strategy.** To ensure the effectiveness of the latent encoder (LE) in constructing the prior feature, we optimize it jointly with Transformer using the \(L_{1}\) loss function, defined as:

\[_{}=\|_{DB}-_{GT}\|_{1},\] (2)

where \(_{DB}\) is the deblurred image, and \(_{GT}\) represents its corresponding ground truth.

### Stage Two: Latent Diffusion Model

In stage two, a latent diffusion model (DM) is trained to learn to generate the prior feature, that enhances the deblurring process of Transformer through HIM.

**Diffusion Model.** Specifically, our latent diffusion model is based on conditional denoising diffusion probabilistic models [15; 3; 36; 35]. The diffusion model involves a forward diffusion process and a reverse denoising process, as illustrated in Fig. 1(b).

In the _diffusion process_, given a ground truth image, we first adopt the latent encoder (LE) trained in stage one to generate the corresponding prior feature \(^{N C^{}}\). We take \(\) as the starting point of the forward Markov process, and gradually add Gaussian noise to it over \(T\) iterations as follows:

\[q(_{1:T}_{0})=_{t=1}^{T}q(_{t} _{t-1}), q(_{t}_{t-1})=( _{t};}_{t-1},_{t}),\] (3)

where \(t{=}1,,T\); \(_{t}\) represents the noisy features at the \(t\)-th step; \(_{0}{=}\) for unification; \(_{1:T}{}(0,1)\) are hyperparameters that control the variance of the noise; \(\) denotes the Gaussian distribution. Through iterative derivation with reparameterization , Eq. (3) can be written as:

\[q(_{t}_{0})=(_{t};_{t}}_{0},(1-_{t})),=1- _{t},_{t}=_{i=1}^{t}_{i}.\] (4)

In the _reverse process_, we aim to generate the prior feature from a pure Gaussian distribution. The reverse process is a \(T\)-step Markov chain that runs backwards from \(_{T}\) to \(_{0}\). Specifically, for the reverse step from \(_{t}\) to \(_{t-1}\), we use the posterior distribution as:

\[q(_{t-1}_{t},_{0})=(_{ t-1};_{t}(_{t},_{0}),_{t-1}}{1- _{t}}_{t}),\ _{t}(_{t},_{0})=}}(_{t}-}{_{t} }}),\] (5)

where \(\) represents the noise in \(_{t}\), and is the only uncertain variable. Following previous work [15; 36; 35; 51], we adopt a neural network (denoted as denoising network, \(_{}\)) to estimate the noise \(\) for each step. Since DM operates in the latent space, we utilize **another latent encoder**, denoted as \(_{}\), with the same structure as LE. \(_{}\) compresses the blurry image \(_{Blur}\) into latent space to get the condition latent \(^{N C^{}}\). The denoising network predicts the noise conditioned on the \(_{t}\) and \(\), _i.e._, \(_{}(_{t},,t)\). With the substitution of \(_{}\) in Eq. (5) and set the variance to (\(1{-}_{t}\)), we get:

\[_{t-1}=}}(_{t}-}{ _{t}}}_{}(_{t},,t) )+}_{t},\] (6)

where \(_{t}{}(0,)\). By iteratively sampling \(_{t}\) using Eq. (6) \(T\) times, we can generate the predicted prior feature \(}{}^{N C^{}}\), as shown in Fig. 1(b). The predicted prior feature is then used to guide Transformer, that is, \(_{1}{=}}\) in Fig. 1(c). Notably, since the distribution of the latent space (\(^{N C^{}}\)) is much simpler than that of images (\(^{H W C}\)) [50; 51], the prior feature can be generated with a small number of iterations. We further explore the iteration numbers \(T\) in Sec. 4.2.

**Training Strategy.** Training DM means training denoising network \(_{}\). Previous works [15; 41] train the model by optimizing the weighted variational bound. The training objective is:

\[_{}\|-_{}(_ {t}}+_{t}},,t)\|_{2}^{2},\] (7)

where \(\) and \(\) are prior feature and condition latent defined above; \(t{}[1,T]\) is a random time-step; \((0,)\) denotes sampled noise. However, the objective in Eq. (7) only trains DM. Since the slight deviation between the predicted prior feature and the actual prior \(\), directly combining DM with Transformer could cause a mismatch, which restricts the deblurring performance.

To overcome this issue, we jointly train the diffusion model and Transformer, inspired by previous work . In this approach, for each training iteration, we use the prior feature \(\) to generate the noise sample \(_{T}\) through Eq. (4). As the time-step \(T\) is small in latent space, we then run the complete \(T\) iteration reverse processes (Eq. (6)) to generate the predicted prior feature \(}\). The \(}\) is used to guide Transformer through HIM (\(_{1}{=}}\)). Finally, the training loss is given by the sum of the deblurring loss \(_{}\) and the diffusion loss \(_{}\), where the diffusion loss \(_{}{=}\|}-\|_{1}\).

### Inference

After completing the two-stage training, given a blurry input image \(_{Blur}{}^{H W 3}\), the HI-Diff first compresses \(_{Blur}\) into a condition latent \(^{N C^{}}\) via latent encoder \(_{}\). Then the predicted prior feature \(}{}^{N C^{}}\) is generated by the diffusion model. Specifically, the diffusion model iteratively executes the reverse process (defined in Eq. (6)) \(T\) times starting from a randomly sampled Gaussian Noise (\((0,)\)). Finally, the HI-Diff reconstructs the deblurred image \(_{DB}{}^{H W 3}\) from the input image \(_{Blur}\), using Transformer, which is enhanced by the prior feature \(}\).

## 4 Experiments

### Experimental Settings

**Data and Evaluation.** Following previous image deblurring methods, we evaluate our method on synthetic datasets (GoPro  and HIDE ) and the real-world dataset (RealBlur  and RWBI ). The GoPro dataset contains 2,103 pairs of blurry and sharp images for training and 1,111 image pairs for testing. The HIDE dataset provides testing 2,025 images. The RealBlur dataset has two sub-set: RealBlur-J and RealBlur-R. Each sub-set consists of 3,758 training pairs and 980 testing pairs. The RWBI dataset contains 3,112 blurry images captured with different hand-held devices. For synthetic datasets, we train HI-Diff on the GoPro training set and test it on GoPro and HIDE. Moreover, we further test the GoPro-trained model on RealBlur and RWBI to evaluate the generalization of our method. For real-world datasets, we train and test HI-Diff on RealBlur datasets, following previous works [54; 44]. We adopt two common metrics: PSNR and SSIM .

**Implementation Details.** Our HI-Diff consists of two parts: Transformer and the latent diffusion model. For Transformer, without loss of generality, we apply Restormer , a 4-level encoder-decoder Transformer architecture. From level-1 to level-4, we set the number of Transformer blocks as , the number of channels as , and the attention heads as . Besides, there are 4 blocks in the refinement stage. The channel expansion factor is 2.66. For the latent diffusion model, the token number \(N\) is 16, and the channel dimension \(C^{}\) is 256. The latent encoder contains \(L{=}6\) residual blocks. We set the total time-step \(T\) as 8, and the variance hyperparameters \(_{1:T}\) constants increasing linearly from \(_{1}{=}0.1\) to \(_{T}{=}0.99\).

**Training Settings.** We train our HI-Diff with Adam optimizer  with \(_{1}{=}0.9\) and \(_{2}{=}0.99\). For stage one, the total training iterations are 300K. The initial learning rate is set as \(2{}10^{-4}\) and gradually reduced to \(1{}10^{-6}\) with the cosine annealing . Following previous work , we adopt progressive learning. Specifically, we set the initial patch size as 128 and the patch size as 64. We progressively update the patch size and batch size pairs to [(\(160^{2}\),40),(\(192^{2}\),32),(\(256^{2}\),16),(\(320^{2}\),16),(\(384^{2}\),8)] at iterations [20K,40K,60K,80K,100K]. For stage two, we adopt the same training settings as in stage one. Moreover, following previous works [53; 54], we apply random rotation and flips for data augmentation. We use PyTorch  to implement our models with 4 A100 GPUs.

### Ablation Study

In this section, we study the effects of different designs of our proposed method. We conduct all experiments on the dataset GoPro . The iterations for stages one and two are 100K, respectively. The image patch size and batch size are set as 192\(\)192 and 32. When we calculate the FLOPs, the image size is 3\(\)256\(\)256. The results are reported in Tab. 1 and Figs. 2 and 3.

**Effects of Diffusion Prior.** We construct a baseline model without prior generated from diffusion in the first row of Tab. 1, denoted as Baseline, which is actually the vanilla Restormer  architecture. For fair comparisons, Baseline adopts the same implementation and training settings as HI-Diff (ours, listed in the fourth row). Comparing Baseline and HI-Diff, we can discover that using the prior feature generated by the latent diffusion model (DM) yields a 0.28 dB improvement. It demonstrates the effectiveness of our proposed method. In addition, the HI-Diff, integrated with diffusion, only adds 4.86M Params and 8.22G FLOPs over Baseline. It reveals that performing the diffusion model in highly compact latent space is very efficient. Furthermore, we show the visual comparisons of the Baseline (without the prior feature) and HI-Diff in Fig. 2 (first row). Our HI-Diff, generates sharper textures and complete structures, compared with Baseline.

   Method & Prior & Multi-Scale & Joint-training & Params (M) & FLOPs (G) & PSNR (dB) & SSIM \\   Baseline & ✗ & ✗ & ✗ & 19.13 & 117.25 & 31.96 & 0.9528 \\ Single-Guide & ✓ & ✗ & ✓ & 21.98 & 125.39 & 32.00 & 0.9534 \\ Split-Training & ✓ & ✓ & ✗ & 23.99 & 125.47 & 30.73 & 0.9434 \\ HI-Diff (ours) & ✓ & ✓ & ✓ & 23.99 & 125.47 & 32.24 & 0.9558 \\   

Table 1: Ablation study. We train and test models on the GoPro  dataset. Image size is 3\(\)256\(\)256 to calculate FLOPs. Prior: the prior feature generated by the diffusion model; Multi-scale: the multi-scale prior feature for hierarchical integration (as opposed to single-scale); Joint-training: the diffusion model and Transformer are trained jointly in stage two.

**Effects of Hierarchical Integration.** We conduct an ablation experiment on the hierarchical integration with the multi-scale prior feature (illustrated in Fig. 2(c). We apply the single-scale prior feature on Transformer, which means we set \(_{1}\)=\(_{2}\)=\(_{3}\)=\(\) (or \(}\)). We denote the new model as Single-Guide, and its result is shown in the second row. We find that the PSNR of Single-Guide drops by 0.24dB compared with HI-Diff, which adopts the multi-scale prior feature. It indicates that the single-scale prior feature cannot adapt well to complex blurry situations. The visual comparison in Fig. 2 (second row) reveals that applying the hierarchical integration restores better-deblurred images.

**Effects of Joint Training Strategy.** We explore the impact of the joint training strategy in stage two. We train a model only optimized diffusion model in stage two, denoted as Split-Training. Specifically, for Split-Training, we first generate the prior feature \(\) from the ground truth and then apply the training objective defined in Eq. (7) to train the diffusion model alone. Then the diffusion model is directly combined with Transformer for evaluation after training is complete. For fair comparisons, Split-Training applies the same pre-trained (stage one) model as HI-Diff in stage two training, and the iterations are 100K. Comparing Split-Training and HI-Diff, HI-Diff is significantly better than Split-Training by 1.51 dB on PSNR value. These results are consistent with the analysis in Sec. 3.2 and demonstrate the importance of the joint training strategy.

**Effects of Iterations Number.** We further conduct an ablation study to investigate the influence of iteration numbers in the diffusion model. We set six different iterations \(T\): \(\{1,2,4,8,16,32\}\) for the diffusion model. Meanwhile, the variance hyperparameters \(_{1:T}\) are always linearly interpolated from \(_{1}\)\(=\)\(0.1\) to \(_{T}\)\(=\)\(0.99\) for different \(T\). We plot the PSNR of different iterations \(T\) in Fig. 3. We find that only one iteration inference cannot generate the reasonable prior feature, limiting the deblurring performance. Besides, when the number of iterations reaches 8, the curve basically converges. It indicates that only a small number of iterations is needed to generate the suitable prior feature, since the simple distribution of the highly compact latent space (only contains \(N\)\(=\)\(16\) tokens).

### Evaluation on Synthetic Datasets

We compare our HI-Diff with 16 state-of-the-art methods: DeblurGAN , DeepDeblur , DeblurGAN-v2 , SRN , DBGAN , MT-RNN , DMPHN , SAPHN , SPAIR , MIMO-UNet+ , TTFA , MPRNet , HINet , Restormer , and Stripformer . We show quantitative results in Tab. 2 and visual results in Fig. 4.

**Quantitative Results.** We train our method on GoPro , and test it on GoPro and HIDE . Moreover, we further test the GoPro-trained model on the real-world dataset: RealBlur  (RealBlur-R and RealBlur-J). The PSNR/SSIM results on four benchmark datasets are reported in Tab. 2. Our method outperforms all compared state-of-the-art methods on all datasets.

When compared on synthetic datasets: GoPro and HIDE, our HI-Diff obtains the 0.25 dB gain on GoPro over Stripformer , the second best method. Meanwhile, compared with Restormer , the backbone of our method, our HI-Diff yields **0.41 dB** and **0.24 dB** gains on GoPro and HIDE.

When compared on real-world datasets: RealBlur-R and RealBlur-J, our HI-Diff exhibit a better generalization ability than other state-of-the-art algorithms. Compared with the recent best-performing method on GoPro, Stripformer, our method yields 0.33 dB on the RealBlur-J dataset. Besides, the HI-Diff outperforms the backbone, Restormer , by 0.09 dB on RealBlur-R and 0.19 dB on RealBlur-J. All these comparisons demonstrate the effectiveness of our HI-Diff.

**Visual Results.** We show visual comparisons on GoPro , HIDE , RealBlur , and RWBI  in Fig. 4. We can observe that most compared methods suffer from artifacts or still contain significant blur effects. In contrast, our method can reconstruct more accurate textures and sharper edges. For example, in the HIDE sample, compared methods fail to reconstruct the white lines in the cloth, while our method recover sharp textures. All these visual comparisons are consistent with quantitative results and further demonstrate the superiority of our method.

   &  &  &  &  \\  & PSNR \(\) & SSIM \(\) & PSNR \(\) & SSIM \(\) & PSNR \(\) & PSNR \(\) & SSIM \(\) \\  DeblurGAN  & 28.70 & 0.858 & 24.51 & 0.871 & 33.79 & 0.903 & 27.97 & 0.834 \\ DeepDelur  & 29.08 & 0.914 & 25.73 & 0.874 & 32.51 & 0.841 & 27.87 & 0.827 \\ DeblurGAN-v2  & 29.55 & 0.934 & 26.61 & 0.875 & 35.26 & 0.944 & 28.70 & 0.866 \\ SRN  & 30.26 & 0.934 & 28.36 & 0.915 & 35.66 & 0.947 & 28.56 & 0.867 \\ DGGAN  & 31.10 & 0.942 & 28.94 & 0.915 & 33.78 & 0.909 & 24.93 & 0.745 \\ MT-RNN  & 31.15 & 0.945 & 29.15 & 0.918 & 35.79 & 0.951 & 28.44 & 0.862 \\ DMPHN  & 31.20 & 0.940 & 29.09 & 0.924 & 35.70 & 0.948 & 28.42 & 0.860 \\ SAPHN  & 31.85 & 0.948 & 29.98 & 0.930 & N/A & N/A & N/A & N/A \\ SPAIR  & 32.06 & 0.953 & 30.29 & 0.931 & N/A & N/A & 28.81 & 0.875 \\ MIMO-UNet+  & 32.45 & 0.957 & 29.99 & 0.930 & 35.54 & 0.947 & 27.63 & 0.837 \\ TFTA  & 32.50 & 0.958 & 30.55 & 0.935 & N/A & N/A & N/A & N/A \\ MPRNet  & 32.66 & 0.959 & 30.96 & 0.939 & 35.99 & 0.952 & 28.70 & 0.873 \\ HINet  & 32.71 & 0.959 & 30.32 & 0.932 & 35.75 & 0.949 & 28.17 & 0.849 \\ Restormer  & 32.92 & 0.961 & 31.22 & 0.942 & 36.19 & 0.957 & 28.96 & 0.879 \\ Stripformer  & 33.08 & 0.962 & 31.03 & 0.940 & 36.08 & 0.954 & 28.82 & 0.876 \\ HI-Diff (ours) & 33.33 & 0.964 & 31.46 & 0.945 & 36.28 & 0.958 & 29.15 & 0.890 \\  

Table 2: Quantitative comparisons on the four benchmark datasets: GoPro , HIDE , and RealBlur  (RealBlur-R and RealBlur-J). All models are trained only on GoPro dataset. Best and second best results are colored with red and blue. Our HI-Diff outperforms state-of-the-art methods.

Figure 4: Visual comparison on GoPro , HIDE , RealBlur , and RWBI  datasets. RWBI only contains blurry images are captured with different hand-held devices. Models are trained only on the GoPro dataset. Our HI-Diff generates images with clearer details.

### Evaluation on Real-World Datasets

We further compare our HI-Diff with 6 state-of-the-art methods: DeblurGAN-v2 , SRN , MIMO-UNet+ , MPRNet , BANet , and Stripformer . We show quantitative and visual results in Tab. 4 and Fig. 5. For fair comparisons, all previous method results are directly cited from the original papers or generated from official pre-trained models.

**Quantitative Results.** Table 3 reports PSNR/SSIM comparisons on real-world datasets: RealBlur  (RealBlur-R and RealBlur-J). We train and test our HI-Diff on the RealBlur datasets, following previous works [54; 44]. Our method significantly outperforms other compared methods on the two datasets. Especially, compared with the recent best method, Stripformer, the HI-Diff obtains **1.17 dB** and **1.22 dB** gains on RealBlur-R and RealBlur-J, respectively.

**Visual Results.** We show visual comparisons on RealBlur in Fig. 5. Our method recovers sharper images with more high-frequency textures. However, most compared methods fail to recover clear images. For instance, compared methods have severe artifacts and blurring on green words, while our HI-Diff restores correct textures that are generally faithful to the ground truth. These visual results further demonstrate the strong ability of our HI-Diff for realistic image deblurring.

### Model Size Analyses

We further show the comparison of model size (_e.g._, Params) and computational complexity (_e.g._, FLOPs) in Tab. 4. The FLOPs are measured when the image size is set as 3\(\)256\(\)256. It shows that our HI-Diff has less FLOPs than CNN-based methods (_e.g._, MPRNet ). Meanwhile, compared with Transformer-based methods, Restormer  and Stripformer , our HI-Diff performs better with comparable Params and less FLOPs. It indicates that our method achieves a better trade-off between performance and computational consumption. To further demonstrate the effectiveness of our method, we provide another variant of HI-Diff with less Params and FLOPs and better performance than Restormer. More details about HI-Diff-2 are provided in the supplementary material.

## 5 Conclusion

In this paper, we design the Hierarchical Integration Diffusion Model (HI-Diff), for realistic image deblurring. Specifically, HI-Diff performs the diffusion model to generate the prior feature for a regression-based method during deblurring. The regression-based method preserves the general

  
**Method** &  DMPHN \\  \\  &  MIMO-UNet+ \\  \\  &  MPRNet \\  \\  &  HINet \\  \\  &  Restormer \\  \\  &  Stripformer \\  \\  &  HI-Diff \\ (ours) \\  & 
 HI-Diff \\ (ours) \\  \\  Params (M) & 21.70 & 16.11 & 20.13 & 88.67 & 26.13 & 19.71 & 28.49 & 23.99 \\ FLOPs (G) & 195.44 & 150.68 & 760.02 & 67.51 & 154.88 & 155.03 & 142.62 & 125.47 \\ PSNR (dB) & 31.20 & 32.45 & 32.66 & 32.71 & 32.92 & 33.08 & 33.33 & 33.28 \\   

Table 4: Model complexity comparisons. Params, FLOPs, and PSNR on GoPro are reported. When we calculate the FLOPs, the image size is set as 3\(\)256\(\)256.

Figure 5: Visual comparison on the RealBlur  dataset. Models are trained on the RealBlur dataset.

  
**Dataset** & **Method** &  DeblurGAN-v2 \\  \\  &  SRN \\  \\  &  MIMO-UNet+ \\  \\  &  MPRNet \\  \\  &  BANet \\  \\  &  Stripformer \\  \\  & 
 HI-Diff \\ (ours) \\  \\  RealBlur-R & PSNR \(\) & 36.44 & 38.65 & N/A & 39.31 & 39.55 & 39.84 & 41.01 \\
 & SSIM \(\) & 0.935 & 0.965 & N/A & 0.972 & 0.971 & 0.974 & 0.978 \\  RealBlur-J & PSNR \(\) & 29.69 & 31.38 & 31.92 & 31.76 & 32.00 & 32.48 & 33.70 \\
 & SSIM \(\) & 0.870 & 0.909 & 0.919 & 0.922 & 0.9230 & 0.929 & 0.941 \\   

Table 3: Quantitative comparisons on RealBlur . All models are trained and tested on the corresponding datasets. Best and second best results are colored with red and blue.

distribution, while the prior feature generated by the diffusion model enhances the details of the deblurred image. Meanwhile, the diffusion model is performed in a highly compact latent space with computational efficiency. Furthermore, we propose the hierarchical integration module (HIM) to fuse the prior feature and image features of Transformer hierarchically for better generalization ability in complex blurry scenarios. Extensive experiments on synthetic and real-world blur datasets demonstrate that our proposed HI-Diff outperforms state-of-the-art methods.