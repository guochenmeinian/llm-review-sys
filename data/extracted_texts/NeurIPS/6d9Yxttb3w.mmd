# Offline Imitation Learning with Variational Counterfactual Reasoning

Zexu Sun\({}^{\$}\), Bowei He\({}^{}\), Jinxin Liu\({}^{}\), Xu Chen\({}^{\$\$}\), Chen Ma\({}^{}\), Shuai Zhang\({}^{\$}\)

\({}^{\$}\)Gaoling School of Artificial Intelligence, Renmin University of China

\({}^{}\)Department of Computer Science, City University of Hong Kong

\({}^{}\)School of Engineering, Westlake University \({}^{}\)DiDi Chuxing

{sunzexu21, xu.chen}@ruc.edu.cn, boweihe2-c@my.cityu.edu.hk

liujinxin@westlake.edu.cn, chemma@cityu.edu.hk, shuai.zhang@tju.edu.cn

Corresponding author

###### Abstract

In offline imitation learning (IL), an agent aims to learn an optimal expert behavior policy without additional online environment interactions. However, in many real-world scenarios, such as robotics manipulation, the offline dataset is collected from suboptimal behaviors without rewards. Due to the scarce expert data, the agents usually suffer from simply memorizing poor trajectories and are vulnerable to the variations in the environments, lacking the capability of generalizing to new environments. To automatically generate high-quality expert data and improve the generalization ability of the agent, we propose a framework named Offline Imitation Learning with Counterfactual data Augmentation (OILCA) by doing counterfactual inference. In particular, we leverage identifiable variational autoencoder to generate _counterfactual_ samples for expert data augmentation. We theoretically analyze the influence of the generated expert data and the improvement of generalization. Moreover, we conduct extensive experiments to demonstrate that our approach significantly outperforms various baselines on both DeepMind Control Suite benchmark for in-distribution performance and CausalWorld benchmark for out-of-distribution generalization.

## 1 Introduction

By utilizing the pre-collected expert data, imitation learning (IL) allows us to circumvent the difficulty in designing proper rewards for decision-making tasks and learning an expert policy. Theoretically, as long as adequate expert data are accessible, we can easily learn an imitator policy that maintains a sufficient capacity to approximate the expert behaviors . However, in practice, several challenging issues hinder its applicability to practical tasks. In particular, expert data are often limited, and due to the typical requisite for online interaction with the environment, performing such online IL may be costly or unsafe in real-world scenarios such as self-driving or industrial robotics . Alternatively, in such settings, we might instead have access to large amounts of pre-collected unlabeled data, which are of unknown quality and may consist of both good-performing and poor-performing trajectories. For example, in self-driving tasks, a number of human driving behaviors may be available; in industrial robotics domains, one may have access to large amounts of robot data. The question then arises: can we perform offline IL with only limited expert data and the previously collected unlabeled data, thus relaxing the costly online IL requirements?

Traditional behavior cloning (BC)  directly mimics historical behaviors logged in offline data (both expert data and unlabeled data) via supervised learning. However, in our above setting, BCsuffers from unstable training, as it relies on sufficient high-quality offline data, which is unrealistic. Besides, utilizing unlabeled data indiscriminately will lead to severe catastrophes: Bad trajectories mislead policy learning, and good trajectories fail to provide strong enough guidance signals for policy learning. In order to better distinguish the effect of different quality trajectories on policy learning, various solutions are proposed correspondingly. For example, ORIL  learns a reward model to relabel previously collected data by contrasting expert and unlabeled trajectories from a fixed dataset; DWBC  introduces a discriminator-weighted task to assist the policy learning. However, such discriminator-based methods are prone to overfitting and suffer from poor generalization ability, especially when only very limited expert data are provided.

Indeed, the expert data play an important role in offline IL and indicate the well-performing agent's intention. Thus, how to fully understand the expert's behaviors or preferences via limited available expert data becomes pretty crucial. In this paper, we propose to investigate counterfactual techniques for interpreting such expert behaviors. Specifically, we leverage the _variational counterfactual reasoning_[23; 4] to augment the expert data, as typical imitation learning data augmentation methods [3; 7] easily generate noisy data and inevitably bias the learning agent. Here, we conduct the counterfactual reasoning of the expert by answering the following question:

_"What action might the expert take if a different state is observed?"_

Throughout this paper, we consider the structure causal model (SCM) underlying the offline training data and introduce an exogenous variable that influences the states and yet is unobserved. This variable is utilized as the minimal edits to existing expert training data so that we can generate counterfactual states that cause an agent to change its behavior. Intuitively, this exogenous variable captures variations of features in the environment. By introducing additional variations in the states during training, we encourage the model to rely less on the idiosyncrasies of a given environment. In detail, we leverage an identifiable generative model to generate the counterfactual expert data, thus enhancing the agent's capabilities of generalization in test environments (Figure 1).

The main contributions of this paper are summarized as follows:

* We propose a novel learning framework OILCA for offline IL. Using both training data and the augmentation model, we can generate counterfactual expert data and improve the generalization of the learned agent.
* We theoretically analyze the disentanglement identifiability of the constructed exogenous variable and the influence of augmented counterfactual expert data via a sampler policy. We also guarantee the improvement of generalization ability from the perspective of error bound.
* We conduct extensive experiments and provide related analysis. The empirical results about in-distribution performance on DeepMind Control Suite benchmark and out-of-distribution generalization on CausalWorld benchmark both demonstrate the effectiveness of our method.

## 2 Related Works

Offline IL.A significant inspiration for this work grows from the offline imitation learning technique on how to learn policies from the demonstrations. Most of these methods take the idea of behavior cloning (BC)  that utilizes supervised learning to learn to act. However, due to the presence of suboptimal demonstrations, the performance of BC is limited to mediocre levels on many datasets. To address this issue, ORIL  learns a reward function and uses it to relabel offline trajectories.

Figure 1: Agent is trained with the collected dataset containing limited expert data and large amounts of unlabeled data, and tested on both in-distribution and out-of-distribution environments.

However, it suffers from high computational costs and the difficulty of performing offline RL under distributional shifts. Trained on all data, BCND  reuses another policy learned by BC as the weight of the original BC objective, but its performance can even be worse if the suboptimal data occupies the major part of the offline dataset. LobsDICE  learns to imitate the expert policy via optimization in the space of stationary distributions. It solves a single convex minimization problem, which minimizes the divergence between the two-state transition distributions induced by the expert and the agent policy. CEIL  explicitly learns a hindsight embedding function together with a contextual policy. To achieve the expert matching objective for IL, CEIL advocates for optimizing a contextual variable such that it biases the contextual policy towards mimicking expert behaviors. DWBC  introduces an additional discriminator to distinguish expert and unlabeled demonstrations, and the outputs of the discriminator serve as the weights of the BC loss. CLUE  proposes to learn an intrinsic reward that is consistent with the expert intention via enforcing the embeddings of expert data to a calibrated contextual representation. OILCA aims to augment the the scarce expert data to improve the performance of the learned policy.

Causal Dynamics RLAdopting this formalism allows one to cast several important problems within RL as questions of causal inference, such as off-policy evaluation [6; 22], learning baselines for model-free RL , and policy transfer [10; 15]. CTRL  applies SCM dynamics to the data augmentation in continuous sample spaces and discusses the conditions under which the generated transitions are uniquely identifiable counterfactual samples. This approach models state and action variables as unstructured vectors, emphasizing benefits in modeling action interventions for scenarios such as clinical healthcare where exploratory policies cannot be directly deployed. MOCODA  applies a learned locally factored dynamics model to an augmented distribution of states and actions to generate counterfactual transitions for RL. FOCUS  can reconstruct the causal structure accurately and illustrate the feasibility of learning causal structure in offline RL. OILCA uses the identifiable generative model to infer the distribution of the exogenous variable in the causal MDP, then performs the counterfactual data augmentation to augment the scarce expert data in offline IL.

## 3 Preliminaries

### Problem Definition

We consider the causal Markov Decision Process (MDP)  with an additive noise. In our problem setting, we have an offline static dataset consisting of _i.i.d_ tuples \(_{}=\{s_{t}^{i},a_{t}^{i},s_{t+1}^{i}\}_{i=1}^ {n_{}}\) s.t. \((s_{t},a_{t})(s_{t},a_{t}),s_{t+1} f_{}(s_{ t},a_{t},u_{t+1})\), where \((s_{t},a_{t})\) is an offline state-action distribution resulting from some behavior policies, \(f_{}(s_{t},a_{t},u_{t+1})\) represents the causal transition mechanism, \(u_{t+1}\) is the sample of the exogenous variable \(u\), which is unobserved, and \(\) is a small permutation. Let \(_{E}\) and \(_{U}\) be the sets of expert and unlabeled demonstrations respectively, our goal is to only leverage the offline batch data \(_{}:=_{E}_{U}\) to learn an optimal policy \(\) without any online interaction.

### Counterfactual Reasoning

We provide a brief background on counterfactual reasoning. Further details can be found in .

**Definition 1** (Structural Causal Model (SCM)).: _A structural causal model \(\) over variables \(=\{X_{1},,X_{n}\}\) consists of a set of independent exogenous variables \(=\{_{1},,_{n}\}\) with prior distributions \(P(_{i})\) and a set of functions \(f_{1},,f_{n}\) such that \(X_{i}=f_{i}(_{i},_{i})\), where \(_{i}\) are parents of \(X_{i}\). Therefore, the distribution of the SCM, which is denoted \(P^{}\), is determined by the functions and the prior distributions of exogenous variables._

Inferring the exogenous random variables based on the observations, we can intervene in the observations and inspect the consequences.

**Definition 2** (_do_-intervention in SCM).: _An intervention \(I=(X_{i}:=f_{i}(}_{i},_{i} ))\) is defined as replacing some functions \(f_{i}(_{i},_{i})\) with \(f_{i}(}_{i},_{i})\), where \(}_{i}\) is the intervened parents of \(X_{i}\). The intervened SCM is indicated as \(^{I}\), and, consequently, its distribution is denoted as \(P^{;I}\)._

The counterfactual inference with which we can answer the _what if_ questions will be obtained in the following process:1. Infer the posterior distribution of exogenous variable \(P(_{i}=)\), where \(\) is a set of observations. Replace the prior distribution \(P(_{i})\) with the posterior distribution \(P(_{i}=)\) in the SCM.
2. We denote the resulted SCM as \(_{}\) and its distribution as \(P^{_{}}\), perform an intervention \(I\) on \(_{}\) to reach \(P^{_{};I}\).
3. Return the output of \(P^{_{};I}\) as the counterfactual inference.

SCM representation of causal MDPWe encode causal MDP (under a policy \(\)) into an SCM \(\). The SCM shown in Figure 2 consists of an exogenous variable \(u\) and a set of functions that transmit the state \(s_{t}\), action \(a_{t}\) and latent representation \(u_{t+1}\) of \(u\) to the next state \(s_{t+1}\)_e.g._\(s_{t+1}_{}(s_{t},a_{t},u_{t+1})\), where \(\) is a small perturbation, and subsequently, to the next action \(a_{t+1}\), _e.g._\(a_{t+1}( s_{t+1})\). To perform counterfactual inference on the SCM \(\), we intervene in the original parents pair \((s_{t},a_{t})\) to \((_{t},_{t})\). Specifically, we sample the latent representation \(_{t+1}\) from the distribution of exogenous variable \(u\), and then generate the counterfactual next state \(_{t+1}\), _i.e._\(_{t+1}_{}(_{t},_{t},_{t+1})\), and also the counterfactual next action \(_{t+1}\), _i.e._\(_{t+1}(_{t+1})\), where \(\) is the sampler policy.

### Variational Autoencoder and Identifiability

We briefly introduce the Variational Autoencoder (VAE) and present its identifiability results. The VAE can be conceptualized as the amalgamation of a generative latent variable model and an associated inference model, both of which are parameterized by neural networks . Specifically, the VAE learns the joint distribution \(p_{}(,)=p_{}()p_{}()\), where \(p_{}()\) represents the conditional distribution of observing \(\) given \(\). Here, \(\) denotes the set of generative parameters, and \(p_{}()=_{i=1}^{I}p_{} (z_{i})\) represents the factorized prior distribution of the latent variables. By incorporating an inference model \(q_{}()\), the parameters \(\) and \(\) can be jointly optimized by maximizing the evidence lower bound (ELBO) on the marginal likelihood \(p_{}()\).

\[&=_{q_{ {}}()}[ p_{}( )]-D_{}(q_{}()\|p())\\ &= p_{}()-D_{} (q_{}()\|p_{ }()) p_{ }(),\] (1)

where \(D_{}\) denotes the KL-divergence between the approximation and the true posterior, and \(\) is a lower bound of the marginal likelihood \(p_{}()\) because of the non-negativity of the KL-divergence. Recently, it has been shown that VAEs with unconditional prior distributions \(p_{}()\) are not identifiable , but the latent factors \(\) can be identified with a conditionally factorized prior distribution \(p_{}()\) over the latent variables to break the symmetry .

## 4 Offline Imitation Learning with Counterfactual Data Augmentation

At a high level, OILCA consists of following steps: (1) data augmentation via variational counterfactual reasoning, and (2) cooperatively learning a discriminator and a policy by using \(_{U}\) and augmented \(_{E}\). In this section, we detail these two steps and present our method's theoretical guarantees.

Figure 2: SCM of causal Markov Decision Process (MDP). We incorporate an exogenous variable in the SCM that is learned and utilized for counterfactual reasoning about _do_-intervention.

### Counterfactual Data Augmentation

Our intuition is that the counterfactual expert data can model deeper relations between states and actions, which can help the learned policy be generalized better. Hence, in this section, we aim to generate counterfactual expert data by answering the _what if_ question in Section 1. Consequently, counterfactual expert data augmentation is especially suitable for some real-world settings, where executing policies during learning can be too costly or slow.

As presented in Section 3.2, the counterfactual data can be generated by using the posterior of the exogenous variable obtained from the observations. Thus, we can briefly introduce the conditional VAE  to build the latent representation of the exogenous variable \(u\). Moreover, Considering the identifiability of unsupervised disentangled representation learning , an additionally observed variable \(c\) is needed, where \(c\) could be, for example, the time index or previous data points in a time series, some kind of (possibly noisy) class label, or another concurrently observed variable . Formally, let \(=(,,)\) be the parameters of the following conditional generative model:

\[p_{}(s_{t+1},u s_{t},a_{t},c)=p_{}(s_{t+1} s_{t},a_{t },u)p_{,}(u c),\] (2)

where we first define:

\[p_{}(s_{t+1} s_{t},a_{t},u)=p_{}(s_{t+1}-_{s_{t},a_{t}}( u)).\] (3)

Equation (2) describes the generative mechanism of \(s_{t+1}\) given the underlying exogenous variable \(u\), along with \((s_{t},a_{t})\). Equation (3) implies that the observed representation \(s_{t+1}\) is an additive noise function, _i.e._, \(s_{t+1}=_{s_{t},a_{t}}(u)+\) where \(\) is independent of \(_{s_{t},a_{t}}\) or \(u\). Moreover, this formulation also can be found in the SCM representation of causal MDP in Section 3.2, where we treat the function \(f\) as the parameter \(\) of the model.

Following standard conditional VAE  derivation, the evidence lower bound (ELBO) for each sample for \(s_{t+1}\) of the above generative model can be written as:

\[ p(s_{t+1} s_{t},a_{t},c)& (,) p_{}(s_{t+1}  s_{t},a_{t},u)+ p(c)-\\ & D_{}(q_{}(u s_{t},a_{t},s_{t+1},c)\|p_{ ,}(u c)).\] (4)

Note that the ELBO in Equation (4) contains an additional term of the \( p(c)\) that does not affect identifiability but improves the estimation for the conditional prior , we present the theoretical guarantees of disentanglement identifiability in Section 4.3. Moreover, the encoder \(q_{}\) contains all the observable variables. The reason is that, as shown in Figure 2(a), from a causal perspective, \(s_{t},a_{t}\) and \(u\) form a collider at \(s_{t+1}\), which means that when given \(s_{t+1}\), \(s_{t}\) and \(a_{t}\) are related to \(u\).

We seek to augment the expert data in \(_{E}\). As shown in Figure 2(b), once the posterior of exogenous variable \(q_{}(u s_{t},a_{t},s_{t+1},c)\) is obtained, we can perform _do_-intervention. In particular, we intervene in the parents \((s_{t},a_{t})\) of \(s_{t+1}\) in \(_{E}\) by re-sampling a different pair \((_{t},_{t})\) from the collected data in \(_{U}\). Moreover, we sample the latent representation \(_{t+1}\) from the learned posterior distribution of exogenous variable \(u\). Then utilizing \(_{t}\), \(_{t}\), and \(_{t+1}\), we can generate the counterfactual next state according to Equation (3), which is denoted as \(_{t+1}\). Subsequently, we pre-train a sampler policy \(_{E}\) with the original \(_{E}\) to sample the counterfactual next action \(_{t+1}=_{E}(_{t+1})\). Thus, for all the generated tuples \((_{t+1},_{t+1})\), we constitute them in \(_{E}\).

### Offline Agent Imitation Learning

In general, the counterfactual data augmentation of our method can enhance many offline IL methods. It is worth noting that as described in , discriminator-based methods are easy to be over-fitted, which can more directly show the importance and effectiveness of the counterfactual augmented data. Thus, in this section, also to best leverage the unlabeled data, we use Discriminator-Weighted Behavioral Cloning (DWBC) , a state-of-the-art discriminator-based offline IL method. This method introduces a unified framework to learn the policy and discriminator cooperatively. The discriminator training gets information from the policy \(_{}\) as additional input, yielding a new discriminating task whose learning objective is as follows:

\[_{}(_{E}, _{U})=&}_{(s_{t},a_{t})_{E}}[-  D_{}(s_{t},a_{t},_{})]+}_{(s _{t}^{},a_{t}^{})_{U}}[-(1-D_{}(s_{t}^ {},a_{t}^{},_{})]\\ &-}_{(s_{t},a_{t})_{E}}[- (1-D_{}(s_{t},a_{t},_{}))],\] (5)where \(D_{}\) is the discriminator, \(\) is called the class prior. In the previous works [35; 39], \(\) is a fixed hyperparameter often assigned as 0.5.

Notice that now \(_{}\) appears in the input of \(D_{}\), which means that imitation information from \(_{}\) will affect \(_{}\), and further impact the learning of \(D_{}\). Thus, inspired by the idea of adversarial training, DWBC  introduces a new learning objective for BC Task:

\[_{}=&}_{(s_{t},a_{t})_{E}}[-_{}(a_{t} s _{t})]-}_{(s_{t},a_{t})_{E}}[-_{ }(a_{t} s_{t})]\\ &+}_{(s^{}_{t},a^{}_{t}) _{U}}[-_{}(a^{}_{t} s^{}_{t })],>1.\] (6)

where \(d\) represents \(D_{}(s_{t},a_{t},_{})\) for simplicity, \(\) is the weight factor (\(>1\)). The detailed training procedure of OILCA is shown in Algorithm 1. Moreover, we also present more possible combinations with other offline IL methods and the related results in Appendix F.

```
0: Dataset \(_{E}\), \(_{U}\), \(_{}\), pre-trained sampler policy \(_{E}\), hyperparameters \(\), \(\), initial variational counterfactual parameters \(,\), discriminator parameters \(\), policy parameters \(\), data augmentation batch number \(B\).
0: Learned policy parameters \(\).
1:while counterfactual training do\(\) Variational counterfactual reasoning
2: Sample \((s_{t},a_{t},s_{t+1},c)_{}\) to form a training batch
3: Update \(\) and \(\) according to Equation (4)
4:endwhile
5:for\(b=1\) to \(B\)do\(\) Expert data augmentation
6: Sample \((s_{t},a_{t},s_{t+1},c)_{E}\), \((_{t},_{t})_{U}\) to form an augmentation batch
7: Generate the counterfactual \(_{t+1}\) according to Equation (2), then predict \(_{t+1}=_{E}(_{t+1})\)
8:\(_{E}(_{t+1},_{t+1})\)
9:endfor
10:while agent training do\(\) Learning the discriminator and policy cooperatively
11: Sample \((s_{t},a_{t})_{E}\) and \((s^{}_{t},a^{}_{t})_{U}\) to form a training batch
12: Update \(\) according Equation (5) every 100 training steps\(\) Discriminator learning
13: Update \(\) according to Equation (6) every 1 training step\(\) Policy learning
14:endwhile ```

**Algorithm 1** Training procedure of OILCA.

### Theoretical Analysis

In this section, we theoretically analyze our method, which mainly contains three aspects: (1) disentanglement identifiability, (2) the influence of the augmented data, and (3) the generalization ability of the learned policy.

Our disentanglement identifiability extends the theory of iVAE . To begin with, some assumptions are needed. Considering the SCM in Figure 2(a), we assume the data generation process in Assumption 1.

**Assumption 1**.: _(a) The distribution of the exogenous variable \(u\) is independent of time but dependent on the auxiliary variable c. (b) The prior distributions of exogenous variable \(u\) are different across auxiliary variable c. (c) The transition mechanism \(p(s_{t+1} s_{t},a_{t},u)\) are invariant across different auxiliary variable c. (d) Given the exogenous variable \(u\), the next state \(s_{t+1}\) is independent of the auxiliary variable c. i.e. \(s_{t+1} c u\)._

Part of the above assumption is also used in ; considering the identifiability of iVAE, we also add some necessary assumptions, which are also practical. In the following discussion, we will show that when the underlying data-generating mechanism satisfies Assumption 1, the exogenous variable \(u\) can be identified up to permutation and affine transformations if the conditional prior distribution \(p(u|c)\) belongs to a general exponential family distribution.

**Assumption 2**.: _The prior distribution of the exogenous variable \(p(u|c)\) follows a general exponential family with its parameter specified by an arbitrary function \((c)\) and sufficient statistics \((u)=[_{}(u),_{NN}(u)]\), here \(_{}(u)\) is defined by the concatenation of \([_{1}(u^{1})^{T},,_{d}(u^{d})^{T}]^{T}\) from a factorized exponential family and the outputs of a neural network \(_{NN}(u)\) with universal approximation power. The probability density can be written as:_

\[p_{,}(u c)=(u)}{(u)} (u)^{T}(c).\] (7)

Under the Assumption 2, and leveraging the ELBO in Equation (4), we can obtain the following identifiability of the parameters in the model. For convenience, we omit the subscript of \(_{s_{t},a_{t}}\) as \(}\).

**Theorem 1**.: _Assume that we observe data sampled from a generative model defined according to Equation (2)-(3) and Equation (7) with parameters \((,,)\), the following holds:_

1. _The set_ \(\{s_{t+1}:_{}(s_{t+1}=0)\}\) _has measure zero, where_ \(_{}\) _is the characteristic function of the density_ \(p_{}\) _defined in Equation (_3_)._
2. _The function_ \(\) _is injective and all of its second-order cross partial derivatives exist._
3. _The sufficient statistics_ \(_{}\) _are twice differentiable._
4. _There exist_ \(k+1\) _distinct points_ \(c^{0},,c^{k}\) _such that the matrix_ \[L=((c^{1})-(c^{0}),, (c^{k})-(c^{0}))\] (8) _of size_ \(k k\) _is invertible._

_Then, the parameters \(=(,,)\) are identifiable up to an equivalence class induced by permutation and component-wise transformations._

Theorem 1 guarantees the identifiability of Equation (2). We present its proof in Appendix A.

Moreover, Theorem 1 further implies a consistent result on the conditional VAE. If the variational distribution of encoder \(q_{}\) is a broad parametric family that includes the true posterior, we have the following results.

**Theorem 2**.: _Assume the following holds:_

1. _There exists the_ \((,)\) _such that the family of distributions_ \(q_{}(u s_{t},a_{t},s_{t+1},c)\) _contains_ \(p_{}(u s_{t},a_{t},s_{t+1},c)\)_._
2. _We maximize_ \((,)\) _with respect to both_ \(\) _and_ \(\)_._

_Then, given infinite data, OILCA can learn the true parameters \(^{*}:=(^{*},^{*},^{*})\)._

We present the corresponding proof in Appendix B. Theorem 2 is proved by assuming our conditional VAE is flexible enough to ensure the ELBO is tight for some parameters and the optimization algorithm can achieve the global maximum of ELBO.

In our framework, the current generated expert sample pairs \((_{t+1},_{t+1})\) are estimated based on the sampler policy \(_{E}\). However, \(_{E}\) may be not perfect, and its predicted results may contain noise. Thus, we would like to answer: "given the noise level of the sampler policy, how many samples one need to achieve sufficiently well performance?". Using \((0,0.5)\) indicates the noise level of \(_{E}\). If \(_{E}\) can exactly recover the true action \(a_{t+1}\) (i.e., \(=0\) ), then the generated sequences are perfect without any noise. On the contrary, \(=0.5\) means that \(_{E}\) can only produce random results, and the generated sequences are fully noisy. Then we have the following theorem:

**Theorem 3**.: _Given a hypothesis class \(\), for any \(,(0,1)\) and \((0,0.5)\), if \(_{E}\) is the pretrained policy model learned based on the empirical risk minimization (ERM), and the sample complexity (i.e., number of samples) is larger than \()}{^{2}(1-2)^{2}}\), then the error between the model estimated and true results is smaller than \(\) with probability larger than \(1-\)._

The related proof details are presented in Appendix C. From Theorem 3, we can see: in order to guarantee the same performance with a given probability (i.e., \(\) and \(\) are fixed), one needs to generate more than \()}{^{2}(1-2)^{2}}\) sequences. If the noise level \(\) is larger, more samples have to be generated. Extremely, if the pre-trained policy can only produce fully noisy information (i.e., \(=0.5\)), then infinity number of samples are required, which is impossible in reality.

For the generalization ability,  explains the efficacy of counterfactual augmented data by the empirical evidence. In the context of offline IL, a straightforward yet very relevant conclusion from the analysis of generalization ability is the strong dependence on the number of expert data . We work with finite state and action spaces (\(||,||<\)), and for the learned policy \(_{}\), we can analyze the generalization ability from the perspective of error upper bound with the optimal expert policy \(^{}\).

**Theorem 4**.: _Let \(|_{E}|\) be the number of empirical expert data used to train the policy and \(\) be the expected upper bound of generalization error. There exists constant \(h\) such that, if_

\[|_{E}||||(||/ )}{^{2}},\] (9)

_and each state \(s_{t}\) is sampled uniformly, then, with probability at least \(1-\), we have:_

\[_{s_{t}}^{}( s_{t})-_{}(  s_{t})_{1}.\] (10)

_which shows that increasing \(|_{E}|\) drastically improves the generalization guarantee._

Note that we provide the proof details for Theorem 4 in D.

## 5 Experiments

In this section, we evaluate the performance of OILCA, aiming to answer the following questions.

**Q1:** With the synthetic toy environment of the causal MDP, can OILCA disentangle the latent representations of the exogenous variable? **Q2:** For an in-distribution test environment, can OILCA improve the performance? **Q3:** For an out-of-distribution test environment, can OILCA improve the generalization? In addition, we use five baseline methods: BC-exp (BC on the expert data \(_{E}\)), BC-all (BC on all demonstrations \(_{}\)), ORIL , BCND , LobsDICE , DWBC . More details about these methods are presented in Appendix E. Furthermore, the hyper-parameters of our method and baselines are all detail-tuned for better performance.

### Simulations on Toy Environment (Q1)

In real-world situations, we can hardly get the actual distributions of the exogenous variable. To evaluate the disentanglement identifiability in variational counterfactual reasoning, we build a toy environment to show that our method can indeed get the disentangled distributions of the exogenous variable.

Toy environmentFor the toy environment, we consider a simple 2D navigation task. The agent can move a fixed distance in each of the four directions. States are continuous and are considered as the 2D position of the agent. The goal is to navigate to a specific target state within a bounding box. The reward is the negative distance between the agent's state and the target state. For the initialization of the environment, we consider \(C\) kinds of Gaussian distributions (Equation (7)) for the exogenous variable, where \(C\) = \(3\), and the conditional variable \(c\) is the class label. We design the transition function by using a multi-layer perceptron (MLP) with invertible activations. We present the details about data collection and model learning in Appendix E.

ResultsWe visualize the identifiability in such a 2D case in Figure 3, where we plot the sources, the posterior distributions learned by OILCA, and the posterior distributions learned by a vanilla conditional VAE, respectively. Our method recovers the original sources to trivial indeterminacies (rotation and sign flip), whereas the vanilla conditional VAE fails to separate the latent variables well. To show the effectiveness of our method in the constructed toy environment, we also conduct repeated experiments for 1K episodes (500 steps per episode) to compare OILCA with all baseline methods. The results are presented in Figure 4, showing that OILCA achieves the highest average return. To analyze the influence of the number of augmented samples (Theorem 4), we also conduct the experiments with varying numbers of counterfactual expert data; the result is shown in Figure 5. The X-axis represents the percentage of \(|_{E}|/|_{U}|\), where \(_{E}\) is the augmented expert data. We can observe that within a certain interval, the generalization ability of the learned policy does improve with the increase of \(|_{E}|\).

### In-distribution Performance (Q2)

We use DeepMind Control Suite to evaluate the performance of in-distribution performance. Similar to , we also define an episode as positive if its episodic reward is among the top 20% episodes for the task. For the auxiliary variable \(c\), we add three kinds of different Gaussian noise distributions into the environment (encoded as \(c=\{0,1,2\}\)). Moreover, we present the detailed data collection and statistics in Appendix E.1). We report the results in Table 1. We can observe that OILCA outperforms baselines on all tasks; this shows the effectiveness of the augmented counterfactual expert data. We also find that the performance of ORIL and DWBC tends to decrease in testing for some tasks (ORIL: Cheetah Run, Walker Walk; DWBC: Cheetah Run, Manipulator Insert Ball); this "overfitting" phenomenon also occurs in experiments of previous offline RL works . This is perhaps due to limited data size and model generalization bottleneck. DWBC gets better results on most tasks, but for some tasks, such as Manipulator Insert Ball and the Walker Walk, OILCA achieves more than twice the average return than DWBC.

### Out-of-distribution Generalization (Q3)

To evaluate the out-of-distribution generalization of OILCA, we use a benchmark named Causal-World, which provides a combinatorial family of tasks with a common causal structure and

   Task Name & BC-exp & BC-all & ORIL & BCND & LobsDICE & DWBC & **OILCA** \\   & 195.44 & 269.03 & 221.24 & 243.52 & 292.96 & 382.55 & **608.38** \\  & \(\) 7.39 & \(\) 7.06 & \(\) 14.49 & \(\) 11.33 & \(\) 11.05 & \(\) 8.95 & \(\) 35.54 \\ Cheetah Run & 66.59 & 90.01 & 45.08 & 96.06 & 74.53 & 66.87 & **116.05** \\  & \(\) 11.09 & \(\) 31.74 & \(\) 9.88 & \(\) 16.15 & \(\) 7.75 & \(\) 4.60 & \(\) 14.65 \\ Finger Turn Hard & 129.20 & 104.56 & 185.57 & 204.67 & 109.03 & 243.47 & **298.73** \\  & \(\) 4.51 & \(\) 8.32 & \(\) 26.75 & \(\) 13.18 & \(\) 12.19 & \(\) 17.12 & \(\) 5.11 \\ Fish Swim & 74.59 & 68.87 & 84.90 & 153.28 & 188.84 & 212.39 & **290.28** \\  & \(\)11.73 & \(\) 11.93 & \(\)19.96 & \(\)19.29 & \(\)11.28 & \(\)7.62 & \(\) 10.07 \\ Humanoid Run & 77.59 & 138.93 & 96.88 & 257.01 & 120.87 & 302.33 & **460.96** \\  & \(\) 6.63 & \(\) 9.14 & \(\)10.76 & \(\)11.21 & 41.66 & \(\)14.53 & \(\) 17.58 \\ Manipulator Insert Ball & 91.61 & 98.59 & 98.25 & 141.71 & 197.79 & 107.86 & **296.83** \\  & \(\)7.49 & \(\)1.62 & \(\)2.68 & \(\)15.30 & \(\)1.98 & \(\)15.01 & \(\) 3.43 \\ Manipulator Insert Peg & 92.02 & 119.63 & 105.86 & 220.66 & 299.19 & 238.39 & **305.66** \\  & \(\)15.04 & \(\)6.37 & \(\)5.10 & \(\)15.14 & \(\)3.40 & \(\)19.76 & \(\) 4.91 \\ Walker Stand & 169.14 & 192.14 & 181.23 & 279.66 & 252.34 & 280.07 & **395.51** \\  & \(\) 8.00 & \(\)37.91 & \(\) 10.31 & \(\) 12.69 & \(\) 7.73 & \(\) 5.79 & \(\) 8.05 \\ Walker Walk & 29.44 & 75.79 & 41.43 & 157.44 & 102.14 & 166.95 & **377.19** \\  & \(\) 2.18 & \(\) 6.34 & \(\) 4.05 & \(\) 9.31 & \(\) 5.94 & \(\) 10.68 & \(\) 15.87 \\   

Table 1: Results for in-distribution performance on DeepMind Control Suite. We report the average return of episodes (with the length of 1K steps) over five random seeds. The best results and second best results are **bold** and underlined, respectively.

underlying factors. Furthermore, the auxiliary variable \(c\) represents the different _do_-interventions on the task environments . We collect the offline data by using three different _do_-interventions on environment features (stage_color, stage_friction. floor_friction) to generate offline datasets, while other features are set as the defaults. More data collection and statistics details are presented in Appendix E.1. We show the comparative results in Table 2. It is evident that OILCA also achieves the best performance on all the tasks; ORIL and DWBC perform the second-best results on most tasks. BEND performs poorly compared to other methods. The reason may be that the collected data in space \(\) can be regarded as low-quality data when evaluating on space \(\), which may lead to the poor performance of a single BC and cause cumulative errors for the BC ensembles of BEND. LobsDICE even performs poorer than BC-exp on most tasks. This is because the KL regularization, which regularizes the learned policy to stay close to \(_{U}\) is too conservative, resulting in a suboptimal policy, especially when \(_{U}\) contains a large collection of noisy data. This indeed hurts the performance of LobsDICE for out-of-distribution generalization.

## 6 Conclusion

In this paper, we propose an effective and generalizable offline imitation learning framework OILCA, which can learn a policy from the expert and unlabeled demonstrations. We apply a novel identifiable counterfactual expert data augmentation approach to facilitate the offline imitation learning. We also analyze the influence of generated data and the generalization ability theoretically. The experimental results demonstrate that our method achieves better performance in simulated and public tasks.