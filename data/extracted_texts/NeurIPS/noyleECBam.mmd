# Marginal Density Ratio for Off-Policy Evaluation in Contextual Bandits

Muhammad Faaiz Taufiq

Department of Statistics

University of Oxford

&Arnaud Doucet

Department of Statistics

University of Oxford

&Rob Cornish

Department of Statistics

University of Oxford

&Jean-Francois Ton

ByteDance Research

ByteDance

###### Abstract

Off-Policy Evaluation (OPE) in contextual bandits is crucial for assessing new policies using existing data without costly experimentation. However, current OPE methods, such as Inverse Probability Weighting (IPW) and Doubly Robust (DR) estimators, suffer from high variance, particularly in cases of low overlap between target and behavior policies or large action and context spaces. In this paper, we introduce a new OPE estimator for contextual bandits, the Marginal Ratio (MR) estimator, which focuses on the shift in the marginal distribution of outcomes \(Y\) instead of the policies themselves. Through rigorous theoretical analysis, we demonstrate the benefits of the MR estimator compared to conventional methods like IPW and DR in terms of variance reduction. Additionally, we establish a connection between the MR estimator and the state-of-the-art Marginalized Inverse Propensity Score (MIPS) estimator, proving that MR achieves lower variance among a generalized family of MIPS estimators. We further illustrate the utility of the MR estimator in causal inference settings, where it exhibits enhanced performance in estimating Average Treatment Effects (ATE). Our experiments on synthetic and real-world datasets corroborate our theoretical findings and highlight the practical advantages of the MR estimator in OPE for contextual bandits.

## 1 Introduction

In contextual bandits, the objective is to select an action \(A\), guided by contextual information \(X\), to maximize the resulting outcome \(Y\). This paradigm is prevalent in many real-world applications such as healthcare, personalized recommendation systems, or online advertising . The objective is to perform actions, such as prescribing medication or recommending items, which lead to desired outcomes like improved patient health or higher click-through rates. Nonetheless, updating the policy presents challenges, as naively implementing a new, untested policy may raise ethical or financial concerns. For instance, prescribing a drug based on a new policy poses risks, as it may result in unexpected side effects. As a result, recent research  has concentrated on evaluating the performance of new policies (target policy) using only existing data that was generated using the current policy (behaviour policy). This problem is known as Off-Policy Evaluation (OPE).

Current OPE methods in contextual bandits, such as the Inverse Probability Weighting (IPW)  and Doubly Robust (DR)  estimators primarily account for the policy shift by re-weighting thedata using the ratio of the target and behaviour polices to estimate the target policy value. This can be problematic as it may lead to high variance in the estimators in cases of substantial policy shifts. The issue is further exacerbated in situations with large action or context spaces , since in these cases the estimation of policy ratios is even more difficult leading to extreme bias and variance.

In this work we show that this problem of high variance in OPE can be alleviated by using methods which directly consider the shift in the marginal distribution of the outcome \(Y\) resulting from the policy shift, instead of considering the policy shift itself (as in IPW and DR). To this end, we propose a new OPE estimator for contextual bandits called the Marginal Ratio (MR) estimator, which weights the data directly based on the shift in the marginal distribution of outcomes \(Y\) and consequently is much more robust to increasing sizes of action and context spaces than existing methods like IPW or DR. Our extensive theoretical analyses show that MR enjoys better variance properties than the existing methods making it highly attractive for a variety of applications in addition to OPE. One such application is the estimation of Average Treatment Effect (ATE) in causal inference, for which we show that MR provides greater sample efficiency than the most commonly used methods.

Our contributions in this paper are as follows:

* Firstly, we introduce MR, an OPE estimator for contextual bandits, that focuses on the shift in the marginal distribution of \(Y\) rather than the joint distribution of \((X,A,Y)\). We show that MR has favourable theoretical properties compared to existing methods like IPW and DR. Our analysis also encompasses theory on the approximation errors of our estimator.
* Secondly, we explicitly lay out the connection between MR and Marginalized Inverse Propensity Score (MIPS) , a recent state-of-the-art contextual bandits OPE method, and prove that MR attains lowest variance among a generalized family of MIPS estimators.
* Thirdly, we show that the MR estimator can be applied in the setting of causal inference to estimate average treatment effects (ATE), and theoretically prove that the resulting estimator is more data-efficient with higher accuracy and lower variance than commonly used methods.
* Finally, we verify all our theoretical analyses through a variety of experiments on synthetic and real-world datasets and empirically demonstrate that the MR estimator achieves better overall performance compared to current state-of-the-art methods.

## 2 Background

### Setup and Notation

We consider the standard contextual bandit setting. Let \(X\) be a context vector (e.g., user features), \(A\) denote an action (e.g., recommended website to the user), and \(Y\) denote a scalar reward or outcome (e.g., whether the user clicks on the website). The outcome and context are sampled from unknown probability distributions \(p(y x,a)\) and \(p(x)\) respectively. Let \(\{(x_{i},a_{i},y_{i})\}_{i=1}^{n}\) be a historically logged dataset with \(n\) observations, generated by a (possibly unknown) _behaviour policy_\(^{b}(a x)\). Specifically, \(\) consists of i.i.d. samples from the joint density under _behaviour policy_,

\[p_{^{b}}(x,a,y) p(y x,a)\,^{b}(a x)\,p(x).\] (1)

We denote the joint density of \((X,A,Y)\) under the _target policy_ as

\[p_{^{*}}(x,a,y) p(y x,a)\,^{*}(a x)\,p(x).\] (2)

Moreover, we use \(p_{^{b}}(y)\) to denote the marginal density of \(Y\) under the behaviour policy,

\[p_{^{b}}(y)=_{}p_{^{b}}(x,a,y)\,a\,x,\]

and likewise for the target policy \(^{*}\). Similarly, we use \(_{^{b}}\) and \(_{^{*}}\) to denote the expectations under the joint densities \(p_{^{b}}(x,a,y)\) and \(p_{^{*}}(x,a,y)\) respectively.

Off-policy evaluation (OPE)The main objective of OPE is to estimate the expectation of the outcome \(Y\) under a given target policy \(^{*}\), i.e., \(_{^{*}}[Y]\), using only the logged data \(\).

Throughout this work, we assume that the support of the target policy \(^{*}\) is included in the support of the behaviour policy \(^{b}\). This is to ensure that importance sampling yields unbiased off-policy estimators, and is satisfied for exploratory behaviour policies such as the \(\)-greedy policies.

**Assumption 2.1** (Support).: For any \(x,a\), \(^{*}(a x)>0^{b}(a x)>0\).

### Existing off-policy evaluation methodologies

Next, we will present some of the most commonly used OPE estimators before outlining the limitations of these methodologies. This motivates our proposal of an alternative OPE estimator.

The value of the target policy can be expressed as the expectation of outcome \(Y\) under the target data distribution \(p_{^{*}}(x,a,y)\). However in most cases, we do not have access to samples from this target distribution and hence we have to resort to importance sampling methods.

Inverse Probability Weighting (IPW) estimatorOne way to compute the target policy value, \(_{^{*}}[Y]\), when only given data generated from \(p_{^{b}}(x,a,y)\) is to rewrite the policy value as follows:

\[_{^{*}}[Y]= y\,p_{^{*}}(x,a,y)\,y\,a \,x= y\,\,}(x,a,y)}{}(x,a,y)}{p_ {(a,x)}}}\,p_{^{b}}(x,a,y)\,y\,a\,x= _{^{b}}[Y\,(A,X)],\]

where \((a,x)}(x,a,y)}{p_{^{b}}(x,a,y)}=(a x)}{^{b}(a x)}\), given the factorizations in Eqns. (1) and (2). This leads to the commonly used _Inverse Probability Weighting (IPW)_ estimator:

\[_{}_{i=1}^{n}(a_{i},x_{i}) \,y_{i}.\]

When the behaviour policy is known, IPW is an unbiased and consistent estimator. However, it can suffer from high variance, especially as the overlap between the behaviour and target policies decreases.

Doubly Robust (DR) estimatorTo alleviate the high variance of IPW,  proposed a _Doubly Robust (DR)_ estimator for OPE. DR uses an estimate of the conditional mean \((a,x)[Y X=x,A=a]\) (_outcome model_), as a control variate to decrease the variance of IPW. It is also doubly robust in that it yields accurate value estimates if either the importance weights \((a,x)\) or the outcome model \((a,x)\) is well estimated [13; 15]. The DR estimator for \(_{^{*}}[Y]\) can be written as follows:

\[_{}=_{i=1}^{n}(a_{i},x_{i})\,(y_{i}- (a_{i},x_{i}))+(^{*}),\]

where \((^{*})=_{i=1}^{n}_{a^{}} (a^{},x_{i})^{*}(a^{} x_{i})_{ ^{*}}[(A,X)]\). Here, \((^{*})\) is referred to as the Direct Method (DM) as it uses \((a,x)\) directly to estimate target policy value.

### Limitation of existing methodologies

To estimate the value of the target policy \(^{*}\), the existing methodologies consider the shift in the joint distribution of \((X,A,Y)\) as a result of the policy shift (by weighting samples by policy ratios). As we show in Section 3.1, considering the joint shift can lead to inefficient policy evaluation and high variance especially as the policy shift increases . Since our goal is to estimate \(_{^{*}}[Y]\), we will show in the next section that considering only the shift in the marginal distribution of the outcomes \(Y\) from \(p_{^{b}}(Y)\) to \(p_{^{*}}(Y)\), leads to a more efficient OPE methodology compared to existing approaches.

To better comprehend why only considering the shift in the marginal distribution is advantageous, let us examine an extreme example where we assume that \(Y\!\!\! A X\), i.e., the outcome \(Y\) for a user \(X\) is independent of the action \(A\) taken. In this specific instance, \(_{^{*}}[Y]=_{^{b}}[Y] 1/n_{i=1}^{n}y_{i}\), indicating that an unweighted empirical mean serves as a suitable unbiased estimator of \(_{^{*}}[Y]\). However, IPW and DR estimators use policy ratios \((a,x)=(a x)}{^{b}(a x)}\) as importance weights. In case of large policy shifts, these ratios may vary significantly, leading to high variance in IPW and DR.

In this particular example, the shift in policies is inconsequential as it does not impact the distribution of outcomes \(Y\). Hence, IPW and DR estimators introduce additional variance due to the policy ratios when they are not actually required. This limitation is not exclusive to this special case; in general, methodologies like IPW and DR exhibit high variance when there is low overlap between target and behavior policies  even if the resulting shift in marginals of the outcome \(Y\) is not significant.

Therefore, we propose the _Marginal Ratio (MR)_ OPE estimator for contextual bandits in the subsequent section, which circumvents these issues by focusing on the shift in the marginal distribution of the outcomes \(Y\). Additionally, we provide extensive theoretical insights on the comparison of MR to existing state-of-the-art methods, such as IPW and DR.

## 3 Marginal Ratio (MR) estimator

Our method's key insight involves weighting outcomes by the marginal density ratio of outcome \(Y\):

\[_{^{*}}[Y]=_{}y\,p_{^{*}}(y)\,y=_{ }y\,}(y)}{p_{^{*}}(y)}\,p_{^{b}}(y)\,y=_{^{b}}[Y\,w(Y)],\]

where \(w(y)}(y)}{p_{^{b}}(y)}\). This leads to the Marginal Ratio OPE estimator:

\[_{}_{i=1}^{n}w(y_{i})\,y_{i}.\]

In Section 3.1 we prove that by only considering the shift in the marginal distribution of outcomes, the MR estimator achieves a lower variance than the standard OPE methods. In fact, this estimator does not depend on the shift between target and behaviour policies directly. Instead, it depends on the shift between the marginals \(p_{^{b}}(y)\) and \(p_{^{*}}(y)\).

Estimation of \(w(y)\)When the weights \(w(y)\) are known exactly, the MR estimator is unbiased and consistent. However, in practice the weights \(w(y)\) are often not known and must be estimated using the logged data \(\). Here, we outline an efficient way to estimate \(w(y)\) by first representing it as a conditional expectation, which can subsequently be expressed as the solution to a regression problem.

**Lemma 3.1**.: _Let \(w(y)=}(y)}{p_{^{b}}(y)}\) and \((a,x)=(a|x)}{^{b}(a|x)}\), then \(w(y)=_{^{b}}[(A,X)\,Y=y]\), and,_

\[w=_{f}\,_{^{b}}[((A,X)-f(Y))^{2}].\] (3)

Lemma 3.1 allows us to approximate \(w(y)\) using a parametric family \(\{f_{}:\}\) (e.g. neural networks) and defining \((y) f_{^{*}}(y)\), where \(^{*}\) solves the regression problem in Eq. (3).

Note that MR can also be estimated alternatively by directly estimating \(h(y) w(y)\,y\) using a similar regression technique as above and computing \(_{}=1/n_{i=1}^{n}h(y_{i})\). We include additional details along with empirical comparisons in Appendix F.1.1.

### Theoretical analysis

Recall that the traditional OPE estimators like IPW and DR use importance weights which account for the the shift in the joint distributions of \((X,A,Y)\). In this section, we prove that by considering only the shift in the marginal distribution of \(Y\) instead, MR achieves better variance properties than these estimators. Our analysis in this subsection assumes that the ratios \((a,x)\) and \(w(y)\) are known exactly. Since the OPE estimators considered are unbiased in this case, our analysis of variance is analogous to that of the mean squared error (MSE) here. We address the case where the weights are not known exactly in Section 3.1.2. First, we make precise our intuition that the shift in the joint distribution of \((X,A,Y)\) is 'greater' than the shift in the marginal distribution of outcomes \(Y\). We formalise this using the notion of \(f\)-divergences.

**Proposition 3.2**.: _Let \(f:[0,)\) be a convex function with \(f(1)=0\), and \(_{f}(P||Q)\) denotes the \(f\)-divergence between distributions \(P\) and \(Q\). Then,_

\[_{f}(p_{^{*}}(x,a,y)\,||\,p_{^{b}}(x,a,y)) _{f}(p_{^{*}}(y)\,||\,p_{^{b}}(y)).\]

IntuitionProposition 3.2 shows that the shift in the joint distributions is at least as 'large' as the shift in the marginals of the outcome \(Y\). Traditional OPE estimators, therefore take into consideration more of a distribution shift than needed, and consequently lead to inefficient estimators. In contrast, the MR estimator mitigates this problem by only considering the shift in the marginal distributions of outcomes resulting from the policy shift. This provides further intuition on why the MR estimator has lower variance compared to existing methods.

**Proposition 3.3** (Variance comparison with IPW estimator).: _When the weights \((a,x)\) and \(w(y)\) are known exactly, we have that \(_{^{}}[_{}]_{^{ }}[_{}]\). In particular,_

\[_{^{}}[_{}]-_{^{ }}[_{}]=_{^{ }}[_{^{}}[(A,X) Y ]Y^{2}] 0.\]

IntuitionProposition 3.3 shows that the variance of MR estimator is smaller than that of the IPW estimator when the weights are known exactly. Moreover, the proposition also shows that the difference between the two variances will increases as the variance \(_{^{}}[(A,X) Y]\) increases. This variance is likely to be large when the policy shift between \(^{b}\) and \(^{*}\) is large, or when the dimensions of contexts \(X\) and/or the actions \(A\) is large, and therefore in these cases the MR estimator will perform increasingly better than the IPW estimator. A similar phenomenon occurs for DR as we show next, even though in this case the variance of MR is not in general smaller than that of DR.

**Proposition 3.4** (Variance comparison with DR estimator).: _When the weights \((a,x)\) and \(w(y)\) are known exactly and \((A,X)[Y X,A]\), we have that,_

\[_{^{}}[_{}]-_{^{ }}[_{}]_{^{ }}[_{^{}}[(A,X)\,Y Y ]-_{^{}}[(A,X)\,(A,X) X] ].\]

IntuitionProposition 3.4 shows that if \(_{^{}}[(A,X)\,Y Y]\) is greater than \(_{^{}}[(A,X)\,(A,X) X]\) on average, the variance of the MR estimator will be less than that of the DR estimator. Intuitively, this will occur when the dimension of context space \(\) is high because in this case the conditional variance over \(X\) and \(A\), \(_{^{}}[(A,X)\,Y Y]\) is likely to be greater than the conditional variance over \(A\), \(_{^{}}[(A,X)\,(A,X) X]\). Our empirical results in Appendix F.2 are consistent with this intuition. Additionally, we also provide theoretical comparisons with other extensions of DR, such as Switch-DR  and DR with Optimistic Shrinkage (DRos)  in Appendix B, and show that a similar intuition applies for these results. We emphasise that the well known results in  which show that IPW and DR estimators achieve the optimal _worst case_ variance (where the worst case is taken over a class of possible outcome distributions \(Y X,A\)) are not at odds with our results presented here (as the distribution of \(Y X,A\) is fixed in our setting).

#### 3.1.1 Comparison with Marginalised Inverse Propensity Score (MIPS) 

In this section, we compare MR against the recently proposed Marginalised Inverse Propensity Score (MIPS) estimator , which uses a marginalisation technique to reduce variance and provides a robust OPE estimate specifically in contextual bandits with large action spaces. We prove that the MR estimator achieves lower variance than the MIPS estimator and doesn't require new assumptions.

MIPS estimatorAs we mentioned earlier, the variance of the IPW estimator may be high when the action \(A\) is high dimensional. To mitigate this, the MIPS estimator assumes the existence of a (potentially lower dimensional) action embedding \(E\), which summarises all'relevant' information about the action \(A\). Formally, this assumption can be written as follows:

**Assumption 3.5**.: The action \(A\) has no direct effect on the outcome \(Y\), i.e., \(Y\!\!\! A X,E\).

For example, in the setting of a recommendation system where \(A\) corresponds to the items recommended, \(E\) may correspond to the item categories. Assumption 3.5 then intuitively means that item category \(E\) encodes all relevant information about the item \(A\) which determines the outcome \(Y\). Assuming that such action embedding \(E\) exists,  prove that the MIPS estimator \(_{}\), defined as

\[_{}_{i=1}^{n}} (e_{i},x_{i})}{p_{^{b}}(e_{i},x_{i})}\,y_{i}=_{i=1}^{n} {p_{^{*}}(e_{i} x_{i})}{p_{^{b}}(e_{i} x_{i})}\,y_{i},\]

provides an unbiased estimator of target policy value \(_{^{*}}[Y]\). Moreover, \(_{^{b}}[_{}]_{^{b}}[ _{}]\).

IntuitionThe context-embedding pair \((X,E)\) can be seen as a representation of the context-action pair \((X,A)\) which contains less'redundant information' regarding the outcome \(Y\). Intuitively, the MIPS estimator, which only considers the shift in the distribution of \((X,E)\) is therefore more efficient than the IPW estimator (which considers the shift in the distribution of \((X,A)\) instead).

Figure 1: Bayesian network corresponding to Assumption 3.5.

MR achieves lower variance than MIPSGiven the intuition above, we should achieve greater variance reduction as the amount of redundant information in the representation \((X,E)\) decreases. We formalise this in Appendix D and show that the variance of MIPS estimator decreases as the representation gets closer to \(Y\) in terms of information content. As a result, we achieve the greatest variance reduction by considering the marginal shift in the outcome \(Y\) itself (as in MR) rather than the shift in the representation \((X,E)\) (as in MIPS). The following result formalizes this finding.

**Theorem 3.6**.: _When the weights \(w(y)\), \(}(e,x)}{p_{^{b}}(e,x)}\) and \((a,x)\) are known exactly, then under Assumption 3.5, \(_{^{b}}[_{}]=_{^{b}}[_{}]=_{^{b}}[Y]\), and \(_{^{b}}[_{}]_{^ {b}}[_{}]_{^{b}}[ _{}]\)._

This analysis provides a link between the MR and MIPS estimators in the framework of contextual bandits, and shows that the MR estimator achieves lower variance than MIPS estimator while not requiring any additional assumptions (e.g. Assumption 3.5 as in MIPS). We also verify this empirically in Section 5.1 by reproducing the experimental setup in  along with the MR baseline.

#### 3.1.2 Weight estimation error

Our analysis so far assumes prior knowledge of the behavior policy \(^{b}\) and the marginal ratios \(w(y)\). However, in practice, both quantities are often unknown and must be estimated from data. To this end, we assume access to an additional training dataset \(_{}=\{(x_{i}^{},a_{i}^{},y_{i}^{})\}_{i=1}^{m}\) (for weight estimation), in addition to the evaluation dataset \(=\{(x_{i},a_{i},y_{i})\}_{i=1}^{n}\) (for computing the OPE estimate). The estimation of \((y)\) involves a two-step process that exclusively utilizes data from \(_{}\):

1. First, we estimate the policy ratio \((a,x)(a|x)}{^{b}(a|x)}\). This can be achieved by estimating the behaviour policy \(^{b}\), and defining \((a,x)(a|x)}{^{b}(a|x)}\). Alternatively, \((a,x)\) can also be estimated directly by using density ratio estimation techniques as in .
2. Secondly, we estimate the weights \((y)\) using Eq. (3) with \(\) instead of \(\).

In practice, one may consider splitting \(_{}\) for each estimation step outlined above. Moreover, each approximation step may introduce bias and therefore, the MR estimator may have two sources of bias. While classical OPE methods like IPW and DR also suffer from bias because of \(\) estimation, the estimation of \((y)\) is specific to MR. However, we show below that given any policy ratio estimate \(\), if \((y)\) approximates \(_{^{b}}[(A,X) Y=y]\) 'well enough' (i.e., the estimation step (ii) shown above is 'accurate enough'), then MR achieves a lower variance than IPW and incurs little extra bias.

**Proposition 3.7**.: _Suppose that the IPW and MR estimators are defined as,_

\[_{}_{i=1}^{n}(a_{i },x_{i})\,y_{i},_{}_{i=1}^{n}(y_{i})\,y_{i},\]

_and define the approximation error as \((Y)-(Y)\), where \((Y)_{^{b}}[(A,X) Y]\). Then we have that, \((_{})-(_{})=_{^{b}}[\,Y]\). Moreover,_

\[_{^{b}}[_{}]-_{^ {b}}[_{}]=(_{^{b }}[_{^{b}}[(A,X)\,Y Y]]}_{ 0}-_{^{b}}[ \,Y]-2\,((Y)\,Y,\,Y)).\] (4)

IntuitionThe \(\) term defined in Proposition 3.7 denotes the error of the second approximation step outlined above. As a direct consequence of this result, we show in Appendix C that as the error \(\) becomes small (specifically as \(_{^{b}}[^{2}] 0\)), the difference between biases of MR and IPW estimator becomes negligible. Likewise, the terms \(_{^{b}}[\,Y]\) and \(((Y)\,Y,\,Y)\) in Eq. (4) will also be small and as a result the variance of MR will be lower than that of IPW (as the first term is positive).

In fact, using recent results regarding the generalisation error of neural networks , we show that when using 2-layer wide neural networks to approximate the weights \((y)\), the estimation error \(\) declines with increasing training data size \(m\). Specifically, under certain regularity assumptions we obtain \(_{^{b}}[^{2}]=O(m^{-2/3})\). Using this we show that as the training data size \(m\) increases, the biases of MR and IPW estimators become roughly equal with a high probability, and

\[_{^{b}}[_{}]-_{^{b}}[ _{}]=\,_{^{b}}[_{ ^{b}}[(A,X)\,Y Y]]+O(m^{-1/3}).\]Therefore the variance of MR estimator falls below that of IPW for large enough \(m\). The empirical results shown in Appendix F.2 are consistent with this result. Due to space constraints, the main technical result has been included in Appendix C.

### Application to causal inference

Beyond contextual bandits, the variance reduction properties of the MR estimator make it highly useful in a wide variety of other applications. Here, we show one such application in the field of causal inference, where MR can be used for the estimation of average treatment effect (ATE)  and leads to some desirable properties in comparison to the conventional ATE estimation approaches. Specifically, we illustrate that the MR estimator for ATE utilizes the evaluation data \(\) more efficiently and achieves lower variance than state-of-the-art ATE estimators and consequently provides more accurate ATE estimates. To be concrete, the goal in this setting is to estimate ATE, defined as follows:

\[[Y(1)-Y(0)].\]

Here \(Y(a)\) corresponds to the outcome under a deterministic policy \(_{a}(a^{} x)(a^{}=a)\). Hence any OPE estimator can be used to estimate \([Y(a)]\) (and therefore ATE) by considering target policy \(^{*}=_{a}\). An important distinction between MR and existing approaches (like IPW or DR) is that, when estimating \([Y(a)]\), the existing approaches only use datapoints in \(\) with \(A=a\). To see why this is the case, we note that the policy ratios \((A|X)}{^{*}(A|X)}=(A|X)}\) are zero when \(A a\). In contrast, the MR weights \(}(Y)}{p_{^{*}}(Y)}\) are not necessarily zero for datapoints with \(A a\), and therefore the MR estimator uses all evaluation datapoints when estimating \([Y(a)]\).

As such we show that MR applied to ATE estimation leads to a smaller variance than the existing approaches. Moreover, because MR is able to use all datapoints when estimating \([Y(a)]\), MR will generally be more accurate than the existing methods especially in the setting where the data is imbalanced, i.e., the number of datapoints with \(A=a\) is small for a specific action \(a\). In Appendix E, we formalise this variance reduction of the MR ATE estimator compared to IPW and DR estimators, by deriving analogous results to Propositions 3.3 and 3.4. In addition, we also show empirically in Section 5.3 that the MR ATE estimator outperforms the most commonly used ATE estimators.

## 4 Related Work

Off-Policy evaluation is a central problem both in contextual bandits [13; 5; 21; 6; 7; 17; 22; 8; 23] and in RL [24; 25; 26; 27]. Existing OPE methodologies can be broadly categorised into Direct Method (DM), Inverse Probability Weighting (IPW), and Doubly Robust (DR). While DM typically has a low variance, it suffers from high bias when the reward model is misspecified . On the other hand, IPW  and DR [13; 5; 17] use policy ratios as importance weights when estimating policy value and suffer from high variance as overlap between behaviour and target policies increases or as the action/context space gets larger [29; 14]. To circumvent this problem, techniques like weight clipping or normalisation [4; 30; 31] are often employed, however, these can often increase bias.

In contrast to these approaches,  propose MIPS, which considers the marginal shift in the distribution of a lower dimensional embedding of the action space. While this approach reduces the variance associated with IPW, we show in Section 3.1.1 that the MR estimator achieves a lower variance than MIPS while not requiring any additional assumptions (like Assumption 3.5).

In the context of Reinforcement Learning (RL), various marginalisation techniques of importance weights have been used to propose OPE methodologies. [21; 25; 26] use methods which considers the shift in the marginal distribution of the states, and applies importance weighting with respect to this marginal shift rather than the trajectory distribution. Similarly,  use marginalisation for OPE in deep RL, where the goal is to consider the shift in marginal distributions of state and action. Although marginalization is a key trick of these estimators, these techniques do not consider the marginal shift in reward as in MR and are aimed at resolving the curse of horizon, a problem specific to RL. Apart from this,  propose a general framework of OPE based on conditional expectations of importance ratios for variance reduction. While their proposed framework includes reward conditioned importance ratios, this is not the main focus and there is little theoretical and empirical comparison of their proposed methodology with existing state-of-the-art methods like DR.

Finally we note that the idea of approximating the ratio of intractable marginal densities via leveraging the fact that this ratio can be reformulated as the conditional expectation of a ratio of tractable densities is a standard idea in computational statistics  and has been exploited more recently to perform likelihood-free inference . In particular, while  typically approximates this expectation through Markov chain Monte Carlo,  uses regression instead, however without any theory.

## 5 Empirical Evaluation

In this section, we provide empirical evidence to support our theoretical results by investigating the performance of our MR estimator against the current state-of-the-art OPE methods. The code to reproduce our experiments has been made available at: github.com/faai2T/MR-OPE.

### Experiments on synthetic data

For our synthetic data experiment, we reproduce the experimental setup for the synthetic data experiment in  by reusing their code with minor modifications. Specifically, \(^{d}\), for various values of \(d\) as described below. Likewise, the action space \(=\{0,,n_{a}-1\}\), with \(n_{a}\) taking a range of different values. Additional details regarding the reward function, behaviour policy \(^{b}\), and the estimation of weights \((y)\) have been included in Appendix F.2 for completeness.

Target policiesTo investigate the effect of increasing policy shift, we define a class of policies,

\[^{^{*}}(a|x)=^{*}\ (a=_{a^{} }q(x,a^{}))+}{||} q(x,a)[Y X=x,A=a],\]

where \(^{*}\) allows us to control the shift between \(^{b}\) and \(^{*}\). In particular, as we show later, the shift between \(^{b}\) and \(^{*}\) increases as \(^{*} 1\). Using the ground truth behaviour policy \(^{b}\), we generate a dataset which is split into training and evaluation datasets of sizes \(m\) and \(n\) respectively.

BaselinesWe compare our estimator with DM, IPW, DR and MIPS estimators. Our setup includes action embeddings \(E\) satisfying Assumption 3.5, and so MIPS is unbiased. Additional baselines have been considered in Appendix F.2. For MR, we split the training data to estimate \(^{b}\) and \((y)\), whereas for all other baselines we use the entire training data to estimate \(^{b}\) for a fair comparison.

ResultsWe compute the target policy value using the \(n\) evaluation datapoints. Here, the MSE of the estimators is computed over 10 different sets of logged data replicated with different seeds. The results presented have context dimension \(d=1000\), number of actions \(n_{a}=100\) and training data size \(m=5000\). More experiments for a variety of parameter values are included in Appendix F.2.

Varying number of evaluation data \(n\)In Figure 1(a) we plot the results with increasing size of evaluation data \(n\) increases. MR achieves the smallest MSE among all the baselines considered when \(n\) is small, with the MSE of MR being at least an order of magnitude smaller than every baseline for \(n 500\). This shows that MR is significantly more accurate than the baselines when the size of the evaluation data is small. As \(n\), the difference between the results for MR and MIPS decreases. However, MR attains smaller variance and MSE than MIPS generally, verifying our analysis in Section 3.1.1. Moreover, Figure 1(a) shows that while the variance of MR is greater than that of DM, it still achieves the lowest MSE overall, owing to the high bias of DM.

Figure 2: Results for synthetic data experiment. In 1(a) we have \(^{*}=0.8\) and in 1(b) we have \(n=800\).

Varying \(^{*}\)As \(^{*}\) parameter of the target policy increases, so does the shift between the policies \(^{b}\) and \(^{^{*}}\) as illustrated by the figure on the right, which plots the KL-divergence \(D_{}(^{b}\,||\,^{^{*}})\) as a function of \(\). Figure 2b plots the results for increasing policy shift. Overall, the MSE of MR estimator is lowest among all the baselines. Moreover, while the MSE and variance of all estimators increase with increasing \(^{*}\) the increase in these quantities is lower for the MR estimator than for the other baselines. Therefore, the relative performance of MR estimator improves with increasing policy shift and MR remains robust to increase in policy shift.

Additional ablation studiesIn Appendix F.2, we investigate the effect of varying context dimensions \(d\), number of actions \(n_{a}\) and number of training data \(m\). In every case, we observe that the MR estimator has a smaller MSE than all other baselines considered. In particular, MR remains robust to increasing \(n_{a}\) whereas the MSE and variance of IPW and DR estimators degrade substantially when \(n_{a} 2000\). Likewise, MR outperforms the baselines even when the training data size \(m\) is small.

### Experiments on classification datasets

Following previous works on OPE in contextual bandits [13; 22; 36; 5], we transform classification datasets into contextual bandit feedback data in this experiment. We consider five UCI classification datasets  as well as Mnist  and CIFAR-100  datasets, each of which comprises \(\{(x_{i},a_{i}^{})\}_{i}\), where \(x_{i}\) are feature vectors and \(a_{i}^{}\) are the ground-truth labels. In the contextual bandits setup, the feature vectors \(x_{i}\) are considered to be the contexts, whereas the actions correspond to the possible class of labels. For the context vector \(x_{i}\) and the action \(a_{i}\), the reward \(y_{i}\) is defined as \(y_{i}(a_{i}=a_{i}^{})\), i.e., the reward is 1 when the action is the same as the ground truth label and 0 otherwise. Here, the baselines considered include the DM, IPW and DR estimators as well as Switch-DR  and DR with Optimistic Shrinkage (DRos) . We do not consider a MIPS baseline here as there is no natural embedding \(E\) of \(A\). Additional details are provided in Appendix F.3.

In Table 1, we present the results with number of evaluation data \(n=1000\) and number of training data \(m=500\). The table shows that across all datasets, MR achieves the lowest MSE among all methods. Moreover, for the Letter and CIFAR-100 datasets the IPW and DR yield large bias and variance arising from poor policy estimates \(^{b}\). Despite this, the MR estimator which utilizes the _same_\(^{b}\) for the estimation of \((y)\) leads to much more accurate results. We also verify that MR outperforms the baselines for increasing policy shift and evaluation data \(n\) in Appendix F.3.

### Application to ATE estimation

In this experiment, we investigate the empirical performance of the MR estimator for ATE estimation.

T twins datasetWe use the Twins dataset studied in , which comprises data from twin births in the USA between 1989-1991. The treatment \(a=1\) corresponds to being born the heavier twin and the outcome \(Y\) corresponds to the mortality of each of the twins in their first year of life. Specifically, \(Y(1)\) corresponds to the mortality of the heavier twin (and likewise for \(Y(0)\)). To simulate the observational study, we follow a similar strategy as in  to selectively hide one of the two twins as explained in Appendix F.4. We obtain a total of 11,984 datapoints, of which 5000 datapoints are used to train the behaviour policy \(^{b}\) and outcome model \((x,a)\).

   Dataset & Digits & Letter & OyDigits & PenDigits & Saffamese & Mnist & CIFAR-100 \\  DM & 0.1508\(\)0.0015 & 0.0886\(\)0.0026 & 0.0485\(\)0.0016 & 0.0520\(\)0.0016 & 0.0208\(\)0.0009 & 0.1109\(\)0.0014 & 0.0020\(\)0.0001 \\ DR & 0.1334\(\)0.0000 & 3.5085\(\)1.1768 & 0.0464\(\)0.0016 & 0.2343\(\)1.0404 & 0.0560\(\)0.0395 & 0.2617\(\)0.0139 & 38.29\(\)0.2523 \\ DRos & 0.0847\(\)0.0025 & 0.2763\(\)0.0586 & 0.0384\(\)0.0025 & 0.0138\(\)0.0297 & 0.0078\(\)0.008 & 0.2151\(\)0.0061 & 0.2628\(\)0.1087 \\ IPW & 0.1623\(\)0.0014 & 4.523\(\)2.2057 & 0.0846\(\)0.0056 & 0.1342\(\)0.0531 & 0.0900\(\)0.0067 & 0.3395\(\)0.0118 & 41.169\(\)2.0079 \\ SwitchDR & 0.0982\(\)0.0032 & 0.2037\(\)0.0597 & 0.0557\(\)0.00047 & 0.0342\(\)0.0090 & 0.0136\(\)0.0012 & 0.2750\(\)0.0102 & 1.164\(\)0.8227 \\ MR (Ours) & **0.0034\(\)0.0001** & **0.0018\(\)0.0004** & **0.0006\(\)0.0002** & **0.0008\(\)0.0002** & **0.0016\(\)0.0003** & **0.0121\(\)0.0009** & **0.0007\(\)0.0002** \\   

Table 1: Mean squared error of target policy value with standard errors over 10 different sessions for different classification datasets. Here, number of evaluation data \(n=1000\), and \(^{*}=0.6\).

Here, we consider the same baselines as the classification data experiments in previous section. For our evaluation, we consider the absolute error in ATE estimation, \(_{}\), defined as: \(_{}:=|_{}^{(n)}-_{}|\). Here, \(_{}^{(n)}\) denotes the value of the ATE estimated using \(n\) evaluation datapoints. We compute the ATE value using the \(n\) evaluation datapoints, over 10 different sets of observational data (using different seeds). Table 2 shows that MR achieves the lowest estimation error \(_{}\) for all values of \(n\) considered here. While the performance of other baselines improves with increasing \(n\), MR outperforms them all.

## 6 Discussion

In this paper, we proposed an OPE method for contextual bandits called marginal ratio (MR) estimator, which considers only the shift in the marginal distribution of the outcomes resulting from the policy shift. Our theoretical and empirical analysis showed that MR achieves better variance and MSE compared to the current state-of-the-art methods and is more data efficient overall. Additionally, we demonstrated that MR applied to ATE estimation provides more accurate results than most commonly used methods. Next, we discuss limitations of our methodology and possible avenues for future work.

LimitationsThe MR estimator requires the additional step of estimating \((y)\) which may introduce an additional source of bias in the value estimation. However, \((y)\) can be estimated by solving a simple 1d regression problem, and as we show empirically in Appendix F, MR achieves the smallest bias among all baselines considered in most cases. Most notably, our ablation study in Appendix F.2 shows that even when the training data is reasonably small, MR outperforms the baselines considered.

Future workThe MR estimator can also be applied to policy optimisation problems, where the data collected using an 'old' policy is used to learn a new policy. This approach has been used in Proximal Policy Optimisation (PPO)  for example, which has gained immense popularity and has been applied to reinforcement learning with human feedback (RLHF) . We believe that the MR estimator applied to these methodologies could lead to improvements in the stability and convergence of these optimisation schemes, given its favourable variance properties.