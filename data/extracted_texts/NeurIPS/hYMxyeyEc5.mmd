# Embedding Trajectory for Out-of-Distribution Detection in Mathematical Reasoning

Yiming Wang\({}^{}\) Pei Zhang\({}^{,}\) Baosong Yang\({}^{,\)\(\) Derek F. Wong\({}^{}\)

Zhuosheng Zhang\({}^{}\) Rui Wang\({}^{,\)\(\)

\({}^{}\)Shanghai Jiao Tong University \({}^{}\)Tongyi Lab \({}^{}\)NLP\({}^{2}\)CT Lab, University of Macau

\(\): Corresponding Author

Email: \({}^{}\){yiming.wang, wangrui12}@sjtu.edu.cn

\({}^{}\)yangbaosong.ybs@alibaba-inc.com

###### Abstract

Real-world data deviating from the independent and identically distributed (_i.i.d._) assumption of in-distribution training data poses security threats to deep networks, thus advancing out-of-distribution (OOD) detection algorithms. Detection methods in generative language models (GLMs) mainly focus on uncertainty estimation and embedding distance measurement, with the latter proven to be most effective in traditional linguistic tasks like summarization and translation. However, another complex generative scenario mathematical reasoning poses significant challenges to embedding-based methods due to its high-density feature of output spaces, but this feature causes larger discrepancies in the embedding shift trajectory between different samples in latent spaces. Hence, we propose a trajectory-based method TV Score, which uses trajectory volatility for OOD detection in mathematical reasoning. Experiments show that our method outperforms all traditional algorithms on GLMs under mathematical reasoning scenarios and can be extended to more applications with high-density features in output spaces, such as multiple-choice questions.

https://github.com/Alsace08/OOD-Math-Reasoning

## 1 Introduction

The rapid development of generative language models (GLMs)  has empowered them to fit diverse and challenging datasets, showing strong generalization over in-distribution (ID) test data satisfying the independent and identically distributed (_i.i.d._) assumption. However, unconstrained inputs in real-world settings frequently trigger distributional drifts, called out-of-distribution (OOD) data. In such scenarios, model performance often deteriorates unexpectedly, yielding harmful outcomes. Thus, OOD detection  is critical in safeguarding model security.

A highly scalable detection method must not rely on specific OOD data distributions, so simulating scenarios where OOD data is unavailable is more promising. Most existing research mainly focuses on vision and text classification tasks . In contrast, studies addressing OOD detection on GLMs remain relatively niche, despite the more severe risks associated with OOD perils in GLMs due to the potential for error propagation in autoregressive generated sequences . Existing methods on GLMs only focus on traditional text generation scenarios like summarization and translation, and these methods did not step outside the research framework of uncertainty estimation  and embedding distance measure . Among these,  has demonstrated that embedding-based methods are currently the only optimal solution for text generation scenarios, they determine whether a new sample is ID or OOD by calculating the _Mahalanobis Distance_ between the new sample embedding and ID embedding distribution in the static input or output space.

Recently, mathematical reasoning has emerged as a challenging generative task and a crucial benchmark for evaluating model abilities. However, it presents unique phenomena in both input and output spaces that render embedding-based methods inapplicable, as shown in Figure 1:* _Input space of mathematical reasoning exhibits vague clustering features across various domains, in contrast to the more defined clusters observed in text generation._ This indicates that embedding may struggle to capture the complexity of mathematical questions.
* _Output space of mathematical reasoning exhibits high-density characteristics with significant overlap between different domains._ we call this phenomenon **Pattern Collapse**. Since the output is mathematically symbolic [53; 37], it compresses the search space, increasing the likelihood of overlap between questions from disparate domains (As cases of Figure 0(a)). More importantly, the sequence tokenization used in GLMs allows for substantial token sharing among mathematically distinct expressions, as these mathematical tokens are primarily drawn from digits 0-9 and finite special symbols such as decimal points and square roots, rather than diverse linguistic elements. These scalar outputs lack distinctive features associated with specific domain distributions.

More discussion of the two phenomena, especially the "_pattern collapse_", will be presented in Section 6. Given the limitations of traditional methods, we aim to explore innovative OOD detection solutions in mathematical reasoning scenarios. We transform our focus from static embedding space to the dynamic embedding trajectory, this motivation stems from a theoretical insight, as shown in Figure 2: "_pattern collapse" causes the convergence of the trajectory endpoints of different samples, leading to significant trajectory differences across samples._ In Section 2.1, we model and prove this hypothesis to elucidate the intuition of using trajectories as a measure. Subsequently, in Section 2.2, we perform empirical experiments to investigate the underlying causes of trajectory differences between ID and OOD samples. Our findings reveal a phenomenon we term **Early Stabilization**, wherein _GLMs achieve primary reasoning in later stages for ID samples, a pattern not observed in OOD samples_. This observation provides direct evidence for the rationale behind using trajectory as a measure.

Based on these analyses, in Section 3, we propose the **T**rajectory **V**olatility detection algorithm (**TV Score**) for mathematical reasoning. Then in Section 4 and 5, we conduct extensive OOD detection experiments with diverse datasets and GLMs to validate the effectiveness of our method. We also tackle the challenging scenario of OOD quality estimation, which raises higher precision demands on the OOD scores. Results indicate that our method surpasses all traditional algorithms for GLMs under the mathematical reasoning scenario. Additionally, we demonstrate the extension of our method to a broader range of tasks with high-density features in output spaces, such as multiple-choice questions.

Problem Statement: OOD Detection on GLMs.We start by formalizing GLMs. Let \(\) and \(\) be the input and output spaces with \(P_{}\) and \(P_{}\) be the marginal distributions for respective space, and \(P_{,}\) is the joint data distribution defined over \(\). GLMs are trained given input sequence \(=x_{1}x_{2}...x_{t} P_{}\) of length \(t\) to autoregressively generate the next token in the corresponding output sequence \(=y_{1}y_{2}...y_{n} P_{}\) of length \(n\) over the likelihood model \(p_{}(|)=_{i=1}^{n}p_{}(y_{i}|_{  i},)\), where each \(x_{i}\) and \(y_{i}\) are taken from vocabulary \(\) and \(\) is sampled from the parameter space \(\).

Figure 1: Embedding projection and cases of input and output spaces under mathematical reasoning and text generation scenarios. We select MATH  dataset for mathematical reasoning and OPUS  for text generation, each with four diverse domains. Different colors represent different domains, with lighter and darker shades indicating input and output. We use SimCSE  for sentence embeddings and UMAP  for dimensionality reduction. Appendix B shows detailed settings and examples.

Assume that \(_{,}\) denote a distribution sufficiently different from \(P_{,}\), the goal of OOD detection in GLMs is to find a score function \(f(,,)\) for each sample and a threshold \(\), which may rely on the features of \(\), \(\), and \(\), to achieve a high discrimination accuracy goal:

\[_{f}\ _{(,) P_{,}}[f( ,,)<]+_{(}, })_{,}}[f( },},)>].\] (1)

## 2 Dynamic Embedding Trajectory Distinguishes ID and OOD Samples in Mathematical Reasoning

We begin by defining the embedding trajectory and its volatility features.Given a sample \(s\), we put its input to the language model \(p_{}\) with \(L\) layers, and the output sequence consists of \(T\) tokens. For the \(t\)-th token, we denote its output embedding at layer \(l\) as \(_{l}^{t}\), with each embedding a \(d\)-dimensional vector. Following the definitions in , we define the average embedding \(_{l}=_{t=1}^{T}_{l}^{t}\) as the sentence embedding at layer \(l\). Then, the embedding trajectory is formed as a progressive chain of these embeddings: \(_{0}_{1}_{l} _{L-1}_{L}\). To measure the change magnitudes of the embedding trajectory in the latent space, we define two types of trajectory volatilities:

* _Dimension-independent volatility_\(_{I}(s)^{d}\): For sample \(s\), we first obtain the embedding difference vector \(|_{l}-_{l-1}|\) between each adjacent-layer pair \(l-1\) and \(l\). \(_{I}\) is the average of all differences across layers, it captures the local trajectory changes across individual dimensions: \[_{I}(s)=_{l=1}^{L}|_{l}-_{l-1}|=_{l=1}^{L}(|y_{l}^{1}-y_{l-1}^{1}|,,| y_{l}^{d}-y_{l-1}^{d}|)^{}.\] (2)
* _Dimension-joint volatility_\(V_{J}(s)\): For sample \(s\), we first obtain the L2-norm of the embedding difference \(||_{l}-_{l-1}||_{2}\) between each adjacent-layer pair \(l-1\) and \(l\). \(V_{J}\) is the average of all such differences across layers, it captures the global changes in the trajectory: \[V_{J}(s)=_{l=1}^{L}||_{l}-_{l-1}||_{2}=_{l=1}^{L}_{i=1}^{d}(y_{l}^{i}-y_ {l-1}^{i})^{2}}.\] (3)

In this section, we will clarify our motivation: _Why Dynamic Embedding Trajectory As The Measure?_ This stems from the phenomenon of "_pattern collapse_" in the output space, where the endpoints of different sample trajectories converge to a high-density region. This constraint potentially increases the likelihood of trajectory differences across samples. We will model and prove this theoretical intuition in Section 2.1 through the _Dimension-independent volatility_. After gaining insight into trajectory differences, we specifically explore the differences between ID and OOD sample trajectories. We will empirically investigate this in Section 2.2 through the _Dimension-joint volatility_.

### Theoretical Intuition: Trajectory Differences with Higher Likelihood

Figure 1 has illustrated the "_pattern collapse_" phenomenon in the output space in mathematical reasoning scenarios. We abstract this phenomenon in Figure 2, which compares the trajectory

Figure 2: The “pattern collapse” phenomenon only exists in mathematical reasoning scenarios, where two samples initially distant in distance will converge approximately at the endpoint after undergoing embedding shifts, and does not occur in text generation scenarios. This produces a greater likelihood of trajectory variation under different samples in mathematical reasoning.

trend between different samples in the mathematical reasoning and text generation scenarios: In mathematical reasoning, when initial points of two trajectories are separated by any distance in the input space, they typically converge to a significantly closer distance in the output space after undergoing an embedding shift. However, in text generation, outputs from different samples may not exhibit this same convergence. This finding inspires the following theoretical intuition: **Hard constraints on trajectory endpoints in mathematical reasoning allow for a higher probability of trajectory differences under different samples**, as expressed by the key hypothesis:

**Hypothesis 1**: _In scenarios characterized by pattern collapse in the output space, the probability of trajectory volatility differences across samples increases._

We now formalize this hypothesis. Assume that the output space is a Gaussian distribution \((,^{2})\), so the output embedding \(_{L}(,^{2})\). For two different samples \(s_{i}\) and \(s_{j}\), their dimension-independent volatilities are \(_{I}(s_{i})\) and \(_{I}(s_{j})\), respectively. We want to show that when pattern collapse exists, the probability of \(_{I}(s_{i})-_{I}(s_{j})\) will increase. According to the pattern collapse features under different scenarios, we can constraint the \(_{L}\) as follows:

* For mathematical reasoning with pattern collapse, \(\), so we approximate that \(_{L}\);
* For text generation without pattern collapse, \(=(_{1},_{2},,_{D})\), so \(_{L}\).

With such formalized constraints, we model our Hypothesis 1 as a main theorem:

**Theorem 2.1** (Main Theorem): _We assume that \(\{_{l}\}_{l=1}^{L}\) are all independent variables sampling from vector space \(^{d}\). For different samples \(s_{i}\) and \(s_{j}\), their embedding sets are \(\{[_{i}]_{l}\}_{l=1}^{L}\) and \(\{[_{j}]_{l}\}_{l=1}^{L}\), respectively. The likelihood of trajectory volatility differences between \(s_{i}\) and \(s_{j}\) under mathematical reasoning scenarios is higher than that under text generation scenarios, which means:_

\[_{\{[_{i}]_{l}\}_{l=1}^{L},\ \{[_{j}]_{l}\}_{l=1}^{L }(^{d})\{_{I}(s_{i})-_{I}(s_{j}) |[_{i}]_{L},[_{j}]_{L}\}}\] \[>_{\{[_{i}]_{l}\}_{l=1}^{L},\ \{[_{j}]_{l}\}_{l=1}^{L}(^{d})\{_{ I}(s_{i})-_{I}(s_{j})|[_{i}]_{L},[_{j}]_{L} (,^{2})\}}\]

Due to space limits, we present the **Complete Proof** in Appendix C. This demonstrates that when pattern collapse occurs, the probability of trajectory volatility differences across samples increases.

### Empirical Analysis: Early Stabilization of ID samples

The theoretical analysis in Section 2.1 provides an intuition for using embedding trajectory as the measure for distinguishing between different samples. However, the specific trajectory differences between ID and OOD samples remain unclear. Thus, we investigate this empirically in this section.

We select eleven mathematical reasoning datasets: one for ID data and ten for OOD data. The MultiArith dataset serves as the ID data, while the OOD datasets include GSM8K, SVAMP, AddSub, SingleEq, SingleOp, and MATH. The latter encompasses five tasks across various mathematical domains: Algebra, Geometry, Counting and Probability, Number Theory, and Precalculus. This selection includes varying task types and levels of difficulty. We first train a base Llama2-7B (32 layers) using the ID training set, then inference on the ID test set and all OOD test sets. Details regarding the datasets, model, and implementation can be found in Section 4.1.

Figure 3: Trajectory volatility curve comparisons between one ID data and ten OOD data from diverse mathematical domains. Each trajectory represents the average of all samples from the corresponding datasets, with color shading being the sample standard deviation. Llama2-7B is used for the backbone.

We measure the dimension-joint volatility for all samples from each ID and OOD test set. Specifically, we compute each adjacent-layer change magnitude \(||_{l}-_{l-1}||_{2}\), and connect all values as a change curve, with higher value means the higher volatility. Figure 3 shows ten curve comparisons, with each sub-figure including the ID data and one OOD data. We find that the change magnitude slightly until the 20th layer. After 20 layers, for ID data, the change magnitude is again suppressed after a few layers of inference, while for OOD data, the magnitude is maintained at a relatively high level.

We term this phenomenon "**Early Stabilization**": For ID data, GLMs largely complete their reasoning in the mid-to-late stages, and simple adjustments are sufficient after that. However, for OOD data, GLMs can still not complete accurate reasoning at a later stage. They thus can only randomly switch to a specific output pattern, _i.e._, the scalar mathematical expression pattern. This provides strong evidence that using embedding trajectory for OOD detection may be effective.

## 3 TV Score: Trajectory Volatility Score for OOD Detection

In Section 2.2, we have identified a significant difference in embedding trajectory volatilities between ID and OOD samples in mathematical reasoning. We now aim to leverage this phenomenon to develop a lightweight OOD detection solution tailored for mathematical reasoning scenarios.

Inspired by static embedding methods that use the ID sample embedding cluster as the reference to measure the _Mahalanobis Distance_ (MaDis) , we similarly aim to use the ID sample trajectory cluster as the reference to measure the difference between them and a new sample trajectory. While measuring the difference between an embedding and an embedding cluster only requires a simple MaDis calculation, quantifying the difference between a trajectory and a trajectory cluster is less intuitive. Thus, we seek a transition idea starting from the static space Gaussian assumption.

First, we obey the assumption under static embeddings [3; 43] to fit all ID embeddings at each layer \(l\) to a Gaussian distribution \(_{l}=(_{l},_{l})\). Next, for a new sample with \(_{l}\) be its embedding at layer \(l\), we map it to its MaDis \(f(_{l}):^{d}\) with \(_{l}\) as follows:

\[f(_{l})=(_{l}-_{l})^{}(_{l})^{-1}( _{l}-_{l})(0 l L).\] (4)

Finally, we treat the MaDis differences \(|f(_{l})-f(_{l-1})|\) between adjacent layer-pairs \(l-1\) and \(l\) as the adjacent-layer volatility of the new sample, and average all adjacent-layer volatilities as the final trajectory volatility score (TV Score \(S\)) of this sample:

\[S=_{l=1}^{L}|f(_{l})-f(_{l-1})|.\] ( **TV Score** )

The anticipated trend is that when the two adjacent embeddings after MaDis mapping exhibit a greater difference, the embedding change between the two layers is more volatile compared to ID data. This enables us to identify new samples with trajectory volatility features that significantly deviate from those of the ID samples, thus increasing the likelihood that they are OOD samples.

Furthermore, as a trajectory, outliers in the trajectory may significantly impact feature extraction [21; 28]. To mitigate this, we explore higher-order differential smoothing techniques to enhance trajectory smoothness. We first define the \(k\)-order embedding \(^{k}_{l}\) and Gaussian distribution \(^{k}_{l}=^{k}(_{l},_{l})\) for all \(l L-k\) based on the backward difference:

\[^{k}_{l}=_{i=0}^{k}(-1)^{k+i}^{i}_{k}_{l+k}, \ \ ^{k}_{l}=(_{i=0}^{k}(-1)^{k+i}^{ i}_{k}_{l+k},\ _{i=0}^{k}^{i}_{k}_{l+k}),\] (5)

where \(^{i}_{k}=\). Similarly, we mapping \(^{k}_{l}\) to its MaDis \(^{k}f(_{l}):^{d}\) with \(^{k}_{l}\):

\[^{k}f(_{l})=(^{k}_{l}-_{i=0}^{k}(-1)^{k+i} ^{i}_{k}_{l+k})^{}(_{i=0}^{k}^ {i}_{k}_{l+k})^{-1}(^{k}_{l}-_{i=0}^{k}(- 1)^{k+i}^{i}_{k}_{l+k}).\] (6)

Following the definition of TV Score, we define the trajectory volatility score after differential smoothing (TV Score w/ DiSmo \(^{k}S\)) as follows:

\[^{k}S=_{l=1}^{L}|^{k}f(_{l})- ^{k}f(_{l-1})|.\] ( **TV Score w/ Dismo** )

The **Algorithmic Process** and **Computational Complexity** are detailed in Appendix D.

Experiments

### Setup

Dataset Selection.For the ID dataset, we use the MultiArith , which consists of Math Word Problems on arithmetic reasoning. For the OOD datasets, we intuitively introduce two types of detection scenarios following : (i) _Far-shift OOD_ scenario, we select the MATH  dataset with five domains of algebra, geometry, counting and probability, number theory, and precalculus; (ii) _Near-shift OOD_ scenario, we select five independent datasets: GSM8K , SVAMP , AddSub , SingleEq , and SingleOp . We consider the ID data negative-(-) and the OOD data positive(+). Refer to Appendix E.1 for basic information and OOD features of these datasets.

Data Split and Sampling.Given the limited data size of MultiArith, totaling only 600 samples and lacking a standard division, we allocate 360 samples for training and 240 for testing. However, with such a small test set, randomness in evaluation becomes a concern. To mitigate this, we conduct test sampling and set the sampling size as 1000. Specifically, we denote ID dataset as \(_{}\) and OOD dataset as \(_{}\). For each sampling, the collection is \(\{_{},}_{}\}\) where \(}_{}_{}\) and \(|_{}|=|}_{}|\), this guarantees positive and negative sample balance. We report both the mean and standard variance of the results to enhance the reliability of evaluations. Refer to Appendix E.2 for the ID dataset split.

Implementation._To measure the application value of our method used in cutting-edge GLMs, we use Llama2-7B  and GPT2-XL (1.5B)  as our backbones for ID dataset training. Refer to Appendix E.3 for training details. However, there exists uncertainty about the data used in the pre-training phase, especially for Llama2 because its data is closed-source. Some research  have confirmed the absence of data leakage in Llama2 for the MATH and GSM8K datasets, we still conduct pre-experiments to examine the rationality of the OOD data selection rigorously. Our criterion is the claim that a dataset can be categorized as OOD if it exceeds the capabilities of the base model, as proposed in prior studies . Results of the pre-experiments are shown in Appendix E.4, and they can confirm that these datasets can be considered as OOD data for the two GLMs.

Baseline.We compare our method with five training-free baselines where OOD training data are unavailable. We refer to the latest survey  to select them for the scarcity of OOD detection methods on GLMs: (1) Maximum Softmax Probability (Prob.) ; (2) Monte-Carlo Dropout ; (3) Sequence Perplexity ; (4) Input Embedding ; (5) Output Embedding . Refer to Appendix E.5 for details. Additionally, we set the smoothing order \(k\) ranges from 1 to 5 for TV Score w/ DiSmo and report the highest among them when with smoothing.

Evaluation.We divide the OOD detection evaluation into two scenarios: (1) **Offline Detection**, which classifies whether samples from a given list belong to OOD. For each collection \(\{_{},}_{}\}\), we report the AUROC  and FPR95 metrics. The former represents the area under the ROC curve and the latter represents the value of FPR at 95% TPR. (2) **Online Detection**, which utilizes the offline detection results to calculate an optimal classification threshold for a direct determination of whether new samples belong to OOD. We introduce the metrics in the corresponding result sub-sections.

### Main Results

Offline Detection.Table 1 presents the results of the offline detection scenarios.

* _Performance Analysis_: In the far-shift OOD setting, **our average performance surpasses 98 (Llama2-7B) and 96 (GPT2-XL) under the AUROC metric**, surpassing the optimal baseline by 10+ points. Moreover, our performance stands at **an impressive 5.21 (Llama2-7B) and 9.89 (GPT2-XL) under the FPR95 metric, representing a remarkable 80%+ reduction** compared to the optimal baseline, far surpassing all baseline methods. In the near-shift OOD setting, the robustness of our method is even more impressive. All of the baseline methods show significant performance degradation, especially in Llama2-7B, with the AUROC metric decreasing below 60 and the FPR95 elevating above 80. However, our method maintains excellent performances, with AUROC scores surpassing 90 and FPR95 below 30. This indicates that for more fine-grained OOD detection scenarios, our method demonstrates greater adaptability.
* _Model Analysis_: Comparing performances of Llama2-7B and GPT2-XL, we find two phenomena: (i) Results on GPT2-XL are more stable, performance differences between GPT2-XL on far- and near-drift settings are not significant, while Llama2-7B shows a significant performance degradation (mainly for baselines) on near-shift setting; (ii) the DiSmo technique is more effective on GPT2-XL, which suggests that there are more anomalous learning tendencies in latent spaces of small models, and the smoothing helps to minimize these anomalies.

In addition, we conduct significant tests (Details are shown in Table 11 - 14). We find that our methods almost pass all significance tests, while the embedding-based methods have the lowest pass rate among baselines, suggesting that their results are more susceptible to sampling error. We also find that the performance of differential smoothing fluctuates greatly in different settings. Therefore, we conduct the ablation of the smoothing order \(k\). Results and analyses are shown in Appendix F.1.

Online Detection.In this part, we utilize the TV score for online OOD discrimination. For each collection \(\{_{},}_{}\}\), we obtain a detector and computer the optimal cut-off \(_{i}\) of Youden Index, which is at the point in the AUROC curve where \(\) is maximum. Then for all OOD samples \(s_{}-}_{}\), we donate \(t\) as the sampling size and computer the discrimination accuracy:

\[=_{i=1}^{t}_{}-}_{}}[(s)_{i} ]}{|_{}-}_{} |}.\] (7)

In addition, the discrimination accuracy should vary less under different data collections, reflecting the discriminator's robustness. Therefore, we denote the Robustness metric as sampling variance.

Table 2 presents the results in Llama2-7B. Compared to the embedding-based methods, **our TV score obtains about an average of 20-point accuracy improvement in both far-shift OOD and near-shift OOD settings**, and on some datasets, such as Cnt.&Prob, our TV score achieves more than 40 points of improvement. These all imply that TV Score can perform online discrimination of OOD samples more accurately. In addition, our TV score also possesses stronger robustness, which means that in real scenarios, we can find the optimal threshold more consistently in the face of different accessible ID and OOD data, reducing the potential riskiness due to uncontrollable data acquisition.

    &  &  \\   &  &  &  &  \\   & AUROC \(\) & FPR95 \(\) & AUROC \(\) & FPR95 \(\) & AUROC \(\) & FPR95 \(\) & AUROC \(\) & FPR95 \(\) \\  Max Softmax Prob.  & 78.66\(\)1.38 & 81.44\(\)3.56 & 60.14\(\)1.54 & 88.91\(\)2.40 & 70.54\(\)1.42 & 78.29\(\)2.40 & 67.12\(\)1.30 & 76.27\(\)2.46 \\ Monte-Carlo Dropout  & 68.63\(\)2.21 & 87.04\(\)4.58 & 52.33\(\)2.22 & 91.92\(\)1.99 & 66.18\(\)2.17 & 84.69\(\)1.48 & 63.54\(\)1.72 & 78.08\(\)2.96 \\ Perplexity  & 85.64\(\)1.46 & 53.06\(\)4.38 & 59.35\(\)1.89 & 86.09\(\)1.99 & 80.82\(\)1.04 & 64.53\(\)2.10 & 73.74\(\)1.12 & 72.39\(\)1.77 \\ Input Embedding  & 75.89\(\)1.03 & 67.87\(\)1.49 & 60.33\(\)1.32 & 84.65\(\)2.53 & 86.26\(\)0.04 & 49.33\(\)2.10 & 83.22\(\)0.08 & 52.90\(\)1.16 \\ Output Embedding  & 74.86\(\)1.39 & 75.21\(\)1.26 & 44.50\(\)1.06 & 86.46\(\)1.39 & 77.95\(\)1.16 & 65.64\(\)3.42 & 79.28\(\)1.24 & 64.70\(\)2.72 \\  TV Score (Ours) & **98.76\(\)0.21** & **5.21\(\)0.09** & **92.64\(\)2.03** & **28.39\(\)1.38** & 93.47\(\)0.08 & 42.10\(\)0.09 & **94.86\(\)0.23** & 13.82\(\)0.38 \\ w/ DiSmo (Ours) & 93.25\(\)0.78 & 41.82\(\)4.96 & 56.99\(\)1.41 & 88.01\(\)1.71 & **96.54\(\)0.01** & **9.89\(\)1.64** & 94.19\(\)0.25 & **13.66\(\)0.08** \\  \(\) (**bold** - underline) & +13.12 & -47.85 & +32.31 & -56.26 & +10.28 & -39.44 & +11.64 & -39.24 \\   

Table 1: AUROC and FPR95 results of the **Offline Detection** scenario. Underline and **bold** denote SOTA among all baselines and all methods, respectively. We report the _average_ results under each setting in the main text, results of each dataset are shown in Table 11 and 12 (Appendix F).

    &  \\   & **Accuracy\(\)** & **Robustness\(\)** &  & **Accuracy\(\)** & **Robustness\(\)** \\   & I-Emb. / O-Emb. / TV (ours) & & & I-Emb. / O-Emb. / TV (ours) \\  Algebra & 76.43 / 45.42 / **93.88** & 5.27 / 6.94 / **0.97** & GSM8K & 81.49 / 75.32 / **93.39** & 10.08 / 3.36 / **2.05** \\ Geometry & 74.32 / 54.79 / **94.47** & 2.44 / 2.43 / **1.65** & SVAMP & 68.66 / 63.33 / **94.88** & 5.26 / 3.54 / **2.13** \\ Cnt.&@Prob & 50.31 / 27.55 / **93.74** & 9.99 / **2.34** / 2.36 & AddSub & **79.16** / 78.09 / 74.11 & 3.21 / 6.98 / **2.77** \\ Num.Theory & 85.80 / 54.38 / **92.08** & 3.31 / 11.45 / **2.34** & SingleEq & 59.83 / 72.56 / **93.15** & 11.57 / **3.14** / 3.17 \\ Precalculus & 80.33 / 88.50 / **99.28** & 6.13 / 1.38 / **0.67** & SingleOp & 69.38 / 62.20 / **95.75** & 4.00 / **2.37** / 2.45 \\  _Average_ & 73.44 / 54.13 / **94.69** & 5.43 / 4.91 / **1.60** & _Average_ & 71.70 / 70.30 / **90.26** & 6.82 / 3.88 / **2.51** \\   

Table 2: Accuracy and Robustness results of the **Online Detection** scenario. We mainly compare our method with embedding-based methods, and **bold** denotes the best among these methods.

Generalizability Exploration

### Beyond Detection: OOD Quality Estimation

In this part, we utilize the TV score for generative quality estimation (QE). For text generation, the QE performance is usually measured by calculating the correlation coefficient between automatic scores and human ratings. However, QE in mathematical reasoning scenarios is not a well-defined problem. For one mathematical question, its answer is either right or wrong, the intermediate state does not exist. For example, when the correct answer is \(12.5\), it is difficult to judge which is better between generated answers of \(1.25\) and \(13.6\). The human approach may be to judge by comparing the difference value or similarity like Rouge  and BertScore  between the generated answer and the correct answer, which is unfair to the machine because there is a lot of randomness in the intermediary process of computation, and the solution pattern of machines is case-based , so it is not suitable to judge the machine-generated results with customized mathematical rules.

Therefore, we use the binary direct matching1 to compare the model-generated answers with the correct answers. Considering the open-ended output of the GLMs, we give a loose matching condition, _i.e._, as long as the correct answer is included in the generated answer by the model, the generated answer is recognized as correct and the matching score is 1, otherwise the matching score is 0. We compute the Kendall rank correlation coefficient \(\) and Spearman rank correlation coefficient  between each OOD score and the matching score.

Table 3 presents the results. For Llama2-7B, when compared with Kendall correlation, the correlation improvement of TV scores **over SOTA baselines reaches up to 100% under both far-shift and near-shift OOD settings.** Compared with Spearman correlation, TV scores demonstrate a correlation enhancement **over SOTA baselines by up to 100% under far-shift OOD setting and 30% under near-shift OOD setting**. GPT2-XL also demonstrates excellent performance. These findings indicate that our TV scores not only facilitate the binary discrimination of ID and OOD samples but also substantially reflect the quality and precision of generated mathematical reasoning.

### Beyond Mathematical Reasoning

Apart from mathematical reasoning, our method also has a wider range of potential applications that **can be extended to any task where the output space exhibits the pattern collapse property**. An example would be multiple-choice questions, which is a popular evaluation tool in the era of large language models and also display the pattern collapse property due to the limited output space being confined to the "ABCD" four options. To verify the generalizability of our method, we conduct experiments using the multiple-choice dataset MMLU , and our method also outperforms all traditional algorithms in this setting. Results and analyses are shown in Appendix F.4.

    &  &  \\   &  &  &  &  \\   & Kendall \(\) & Spearman \(\) & Kendall \(\) & Spearman \(\) & Kendall \(\) & Spearman \(\) & Kendall \(\) & Spearman \(\) \\  Max Softmax Prob. & 0.024\(\)0.028 & 0.038\(\)0.029 & 0.038\(\)0.083 & 0.026\(\)0.008 & 0.066\(\)0.005 & 0.044\(\)0.046 & 0.057\(\)0.008 & 0.057\(\)0.002 \\ Perplexity & 0.050\(\)0.038 & 0.045\(\)0.016 & 0.074\(\)0.026 & 0.050\(\)0.008 & 0.036\(\)0.008 & 0.038\(\)0.017 & 0.033\(\)0.018 & 0.058\(\)0.019 \\ Input Embedding & 0.078\(\)0.018 & 0.102\(\)0.017 & 0.036\(\)0.004 & 0.115\(\)0.007 & 0.059\(\)0.012 & 0.038\(\)0.017 & 0.033\(\)0.018 & 0.058\(\)0.019 \\ Output Embedding & 0.058\(\)0.018 & 0.025\(\)0.017 & 0.038\(\)0.016 & 0.115\(\)0.007 & 0.059\(\)0.012 & 0.098\(\)0.016 & 0.012\(\)0.018 & 0.068\(\)0.016 \\  TV Score (Ours) & **0.161\(\)0.018** & 0.147\(\)0.015 & **0.159\(\)0.007** & **0.158\(\)0.007** & 0.138\(\)0.010 & 0.123\(\)0.013 & **0.131\(\)0.015** & 0.146\(\)0.015 \\ w/ Disrno (Ours) & 0.111\(\)0.018 & **0.152\(\)0.015** & 0.113\(\)0.018 & 0.134\(\)0.017 & **0.139\(\)0.007** & **0.141\(\)0.014** & 0.123\(\)0.014 & **0.154\(\)0.018** \\  \(\) (**bold** : underline) & +0.083 & +0.050 & +0.085 & +0.043 & +0.073 & +0.043 & +0.074 & +0.086 \\   

Table 3: **OOD Quality Estimation**: Kendall’s \(\) and Spearman correlation between various OOD scores and benchmark quality metric binary matching. Each column shows the correlation when ID and OOD samples are merged. Underline denotes the SOTA among all baselines, and **bold** denotes the SOTA among our methods. We report the _average_ results under each setting in the main text, results of each dataset are shown in Table 13 and 14 (Appendix F).

[MISSING_PAGE_FAIL:9]

tokenization, two expressions that are very different in the mathematical sense (_e.g._, Two numbers that are far apart on the real number line) may share many tokens because regular mathematical expressions are only taken from 0-9 number tokens and a limited number of special symbols, such as decimal points, slashes, and root signs. Thus, the collapse occurs at the token level during the autoregressive prediction of each token.

We conduct the following statistical analysis to demonstrate the universality of _'pattern collapse_" across various mathematical reasoning tasks: We categorize the mathematical tasks into various types across different domains and difficulties. In each task, we count the token number \(N\) and the token type number \(N_{}\) in the dataset, then compute the token duplication rate \(D\) and the vocab coverage \(C\) as follows: We use Llama-2 tokenizer , whose token type number in vocab \(N_{}\) is 32000. The computation metric is:

\[D=1-}}{N},\ \ \ C=}}{N_{}}.\] (8)

We also test translation and summarization tasks by taking samples with the same token size as the mathematical reasoning dataset for a clear comparison. Table 6 presents the statistics data, we find that: (i) The average token duplication rate was 98.9% on all math tasks, and even a staggering 99.9% on some easy arithmetic tasks; In contrast, the token duplication rate on the text generation task is only about 60%, with about 2000 token types, and still increasing as the total number of tokens increases. These data and comparisons demonstrate that pattern collapse occurs on mathematical reasoning and not on text generation. (ii) Token repetition rate exceeded 97% on all seven math tasks of different difficulties and types. From these conclusions, we can demonstrate that the "_pattern collapse_" occurs on generally all types of mathematical reasoning tasks.

### Can Chain-of-Thought Address "_pattern collapse_"?

A straightforward approach to addressing "_pattern collapse_" in the output space is to leverage chain-of-thought (CoT) techniques [54; 17; 62; 52; 61] to **expand the output space size**. Likewise, we adopt the solution steps associated with each sample in the MATH dataset as the output and employ SimCSE to derive embedding representations. The experimental setup aligns with Section 4.1, and the results are shown in Table 5(b). We note a similar phenomenon as in Table 5(a), _i.e._, the detection accuracy under different ID-OOD pairs varies greatly, and thus the detection randomness is more pronounced. This suggests that despite that CoT expands the output space size, the output answer is still essentially related to the difficulty and digit of mathematical reasoning, and the semantic embedding representation cannot reflect these features accurately.

## 7 Conclusion

We propose the TV Score, a lightweight OOD detection method for mathematical reasoning, which distinguishes between ID and OOD samples by the embedding trajectory volatility in the latent space. We identify bottlenecks in OOD detection for mathematical reasoning and prove them empirically and theoretically. Experiments show that our method substantially outperforms all traditional algorithms, and can be extended to more application scenarios beyond mathematical reasoning.

   Task Type & \(N\) & \(N_{}\) & \(D\) & \(C\) \\   \\  Arithmetic(easy) & 16136 & 14 & 99.9\% & 0.04\% \\ Arithmetic(hard) & 5663 & 16 & 99.7\% & 0.05\% \\ Algebra & 5234 & 107 & 98.0\% & 0.33\% \\ Geometry & 2615 & 75 & 97.1\% & 0.23\% \\ Cnt.\&Prob. & 2524 & 43 & 98.3\% & 0.13\% \\ Num.Theory & 2395 & 71 & 97.1\% & 0.22\% \\ Precalculus & 3388 & 84 & 97.5\% & 0.26\% \\  _Average_ & _5422_ & _58_ & _98.9\%_ & _0.18\%_ \\   \\  Translation & 2500 & 1065 & 57.4\% & 3.32\% \\  & 5000 & 1832 & 63.3\% & 5.10\% \\  & 10000 & 2980 & 70.2\% & 9.31\% \\  _Average_ & _5833_ & _1959_ & _66.4\%_ & _6.12\%_ \\   \\  Translation & 2500 & 1065 & 49.4\% & 4.01\% \\  & 5000 & 1970 & 60.6\% & 6.16\% \\  & 10000 & 3192 & 68.0\% & 9.98\% \\  _Average_ & _5833_ & _2142_ & _63.2\%_ & _6.69\%_ \\   

Table 6: Statistics about output tokens on mathematical reasoning (seven different task types) and text generation (translation and summarization).

## Limitations

Our limitation mainly lies in the relatively small sizes of datasets used in our experiments. Due to the difficulty of collecting and labeling mathematical reasoning data, dataset sizes in this field are generally small, mostly in the hundreds or thousands, making it difficult to obtain millions of data for training and reasoning as in translation or summarization tasks. To address this, we adopt test sampling to reduce the randomness under small-scale testing and mitigate the data imbalance.

## Ethics Statement

The data and models used in this work are sourced from the official version of the original paper, and we strictly adhere to the provided usage protocol. Regarding the data, no modifications have been made to the original dataset. Regarding the models, supervised fine-tuning and OOD data inference are involved. To mitigate the risk of uncontrollable outputs, all generated outputs in the experiments have been reviewed to ensure their safety. Furthermore, as our focus is solely on mathematical reasoning and does not involve sensitive content, we would not cause any potential societal impact.