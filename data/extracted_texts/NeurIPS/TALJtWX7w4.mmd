# LaSCal: Label-Shift Calibration without target labels

Teodora Popordanoska1Gorjan Radevski1Tinne Tuytelaars Matthew B. Blaschko

ESAT-PSI, KU Leuven

firstname.lastname@kuleuven.be

###### Abstract

When machine learning systems face dataset shift, model calibration plays a pivotal role in ensuring their reliability. Calibration error (CE) provides insights into the alignment between the predicted confidence scores and the classifier accuracy. While prior works have delved into the implications of dataset shift on calibration, existing CE estimators either (i) assume access to labeled data from the target domain, often unavailable in practice, or (ii) are derived under a covariate shift assumption. In this work we propose a novel, label-free, consistent CE estimator under _label shift_. Label shift is characterized by changes in the marginal label distribution \(p(Y)\), with a constant conditional \(p(X|Y)\) distribution between the source and target. We introduce a novel calibration method, called LaSCal, which uses the estimator in conjunction with a post-hoc calibration strategy, to perform unsupervised calibration on the target distribution. Our thorough empirical analysis demonstrates the effectiveness and reliability of the proposed approach across different modalities, model architectures and label shift intensities.

## 1 Introduction

Reliable uncertainty estimation is crucial for predictive models, particularly in safety-critical applications, where decisions based on predictions have significant consequences (Amodei et al., 2016; Kompa et al., 2021). The _calibration error_ (CE) (Naeini et al., 2015; Guo et al., 2017; Vaicenavicius et al., 2019) measures the discrepancy between predicted probabilities and observed class frequencies, indicating the reliability of the model's predictions. When a _calibrated_ model predicts an 80% chance of flu, we expect 80 out of 100 patients with similar symptoms to have the flu. Estimating CE and addressing miscalibration typically requires i.i.d. labeled held-out data. However, real-world settings often violate these assumptions: (i) the source (train) may differ from the target (test) distribution, known as _dataset shift_(Quinonero Candela et al., 2009), leading to a false sense of confidence in the model and suboptimal decision-making (Park et al., 2020); and (ii) obtaining labeled target data for CE estimation is often unrealistic or prohibitively expensive, e.g., in medical diagnostics during disease outbreaks acquiring labeled patient data is needed, but costly. Thus, traditional post-hoc calibration methods (e.g., temperature scaling (Guo et al., 2017) or isotonic regression (Zadrozny and Elkan, 2002)), which rely on labeled calibration sets in an i.i.d. setting, are not directly applicable.

The two most common types of dataset shift are: (i) _covariate shift_, where the feature distribution changes between the source and target domains, denoted as \(p_{s}(X) p_{t}(X)\), but the conditional label distribution remains the same, i.e., \(p_{s}(Y|X)=p_{t}(Y|X)\); and (ii) _label shift_, where the label distribution differs, that is \(p_{s}(Y) p_{t}(Y)\), while the conditional feature distribution remains the same, i.e., \(p_{s}(X|Y)=p_{t}(X|Y)\)(Moreno-Torres et al., 2012; Quinonero Candela et al., 2009)2.

Previous methods, such as TransCal (Wang et al., 2020), CPCS (Park et al., 2020), and HeadToTail (Chen and Su, 2023), address calibration under dataset shift, but are specifically designed around the covariate shift assumption. Notably, while HeadToTail also assumes a change in the label distribution between the source and target domains (i.e., \(p_{s}(Y) p_{t}(Y)\)) by using long-tailed source data and balanced target data, it only partially addresses the label shift scenario. As a result, how to effectively estimate and maintain calibration under _label shift_ assumption - especially in the absence of target domain labels - remains an open question3.

To address this gap, we derive _a novel CE estimator of a model facing label shift_, which allows us to reliably estimate CE without requiring labeled target data. Compared to prior work (see Table 1), it is the only label-free, consistent CE estimator under the label shift assumption. We build on ideas from unsupervised domain adaptation, and employ importance weighting to estimate the degree of shift in the target distribution. We utilize current state-of-the-art methods, e.g., ELSA Tian et al. (2023), RLLS Azizzadenesheli et al. (2019), etc., which yield per-class importance weights to account for the label shift. Note that in contrast to our work, these methods focus only on the predictive performance of a model, neglecting the model's calibration altogether.

Furthermore, we propose a novel, accuracy-perserving, post-hoc calibration method, called **LasCal** (Label-Shift Calibration), which utilizes the proposed CE estimator as a loss function. We conduct experiments across a variety of datasets, models, weight estimators, intensities of shift on the target distribution, and imbalance factors of the source distribution to validate its performance. Our results demonstrate that LasCal effectively performs unsupervised calibration on the target domain, yielding better calibrated models, compared to traditional i.i.d. calibration methods, calibration methods designed for covariate shift (Chen and Su, 2023; Park et al., 2020; Wang et al., 2020), and label shift adaptation methods that rely on calibration using a labeled validation (source) set (Alexandari et al., 2020; Wen et al., 2024).

To summarize, we make the following **contributions:**

1 We derive the first label-free, consistent calibration error estimator under label shift (SS3);

2 We propose a post-hoc calibration method, **LaSCal**, which outperforms existing methods in unsupervised calibration tasks in the presence of label shift (SS4.1);

3 We analyze the properties of LaSCal, and demonstrate its robustness across various datasets, modalities, model architectures and domain-shift scenarios (SS4.2).

Our codebase is released at the following repository: https://github.com/tpopordanoska/label-shift-calibration.

## 2 Related Work

**Estimating CE** is a challenging task as it requires estimating an expectation conditioned on a continuous random variable: \([Y f(X)]\), where \(X\) is the input, \(Y\) is a one-hot label, and \(f\) is a probabilistic model. The CE is often estimated using binning (Zadrozny and Elkan, 2001; Naeini et al., 2015), i.e., in the _binary_ setting, the unit interval \(\) is split into intervals (bins) of either equal width (Nguyen and O'Connor, 2015) or equal mass (adaptive binning) (Vaicenavicius et al.,

    &  &  &  &  Consistent estimator under label shift assumption \\  } \\  TempScal (Source) (Guo et al., 2017) & ✗ & ✗ & ✓ & ✗ \\ CPCS (Park et al., 2020) & ✗ & ✓ & ✓ & ✗ \\ TransCal (Wang et al., 2020) & ✗ & ✓ & ✓ & ✗ \\ HeadToTail (Chen and Su, 2023) & ✗ & ✓ & ✓ & ✗ \\
**LaSCal (Ours)** & ✓ & ✓ & ✓ & ✓ \\   

Table 1: Properties of related calibration methods. LaSCal is accuracy preserving, and relies on a consistent CE estimator designed for unsupervised calibration under label-shift.

2019). Calibration of a _multi-class_ model is often quantified via expected CE (ECE) (Naeini et al., 2015), used to assess the so-called top-label (or confidence) calibration (Guo et al., 2017), which only considers the confidence of the predicted class. Class-wise calibration (Kull et al., 2019) is a stronger notion, requiring calibrated scores for each class: \(f_{k}(X)\) is compared with \([Y_{k} f_{k}(X)]\) for each class \(k\). Canonical calibration (Vaiencnavicius et al., 2019; Popordanoska et al., 2022) is the strictest notion, requiring the whole probability vector to be calibrated, i.e., \(f(X)\) should match \([Y f(X)]\). In this work, we focus on binary and class-wise CE, estimated using adaptive binning.

Numerous **calibration methods** address neural network miscalibration, falling into two categories: post-hoc and trainable strategies. _Post-hoc methods_ adjust the output scores using held-out calibration set. One of the earliest approaches in binary classification is Platt scaling (Platt, 1999), which has been extended to a multi-class setting via matrix, vector and temperature scaling (Guo et al., 2017). Other approaches include isotonic regression (Zadrozny and Elkan, 2002), ensemble temperature scaling (Zhang et al., 2020), Beta (Kull et al., 2017) and Dirichlet calibration (Kull et al., 2019). _Trainable methods_ incorporate a calibration objective alongside the classification loss (Kumar et al., 2018; Mukhoti et al., 2020; Popordanoska et al., 2022). All of these strategies focus on a supervised setting, and do not account for dataset shift. Recent studies (Ovadia et al., 2019; Karandikar et al., 2021) have shown that models calibrated with traditional i.i.d. calibration methods lose their calibration under dataset shift. Subsequently, several works address calibration under _covariate shift_ assumption: CPCS (Park et al., 2020), TransCal (Wang et al., 2020), and HeadToTail (Chen and Su, 2023), which calibrate on the target domain without labels. In contrast, we focus on the _label shift_ setting. Our work introduces a general calibration error estimator under label shift, usable as a training objective in post-hoc and trainable calibration methods. Importantly, post-hoc calibration is done on the unlabeled target data, enhancing performance and reliability compared to standard source data calibration.

**Label shift**, also known as prior probability shift, (Lipton et al., 2018; Azizzadenesheli et al., 2019; Alexandari et al., 2020) is often intertwined with the broader concept of unsupervised domain adaptation (Kouw and Loog, 2021). Several different methods address label shift: importance re-weighting (Lipton et al., 2018; Azizzadenesheli et al., 2019; Saerens et al., 2002; Tian et al., 2023), kernel mean matching (KMM) (Zhang et al., 2013), and generative adversarial training (Guo et al., 2020). There are two popular importance re-weighting approaches: one based on maximizing the likelihood function and the other based on inverting a confusion matrix. Saerens et al. (2002) propose an Expectation Maximization (EM) procedure to estimate the class priors shift between the source and target distributions. Importantly, EM does not require retraining or hyperparameter tuning. However, it assumes calibrated predictions, which modern neural networks often lack (Guo et al., 2017). To address this, hybrid methods combining calibration techniques and domain adaptation methods have been proposed. Alexandari et al. (2020) propose Bias-Corrected Temperature Scaling (BCTS) alongside EM. Lipton et al. (2018) propose Black-Box Shift Learning (BBSL), which estimates the re-weighting coefficients even if the model is poorly calibrated. As an improvement over BBSL, Azizzadenesheli et al. (2019) propose a technique with statistical guarantees: Regularized Learning under Label Shifts (RLLS). They introduce a regularization hyperparameter, addressing the high estimation error of the importance weights in the low target sample regime. Both BBSL and RLLS estimate importance weights from a confusion matrix of a held-out validation set. Both methods cope with label shift when the classifier is miscalibrated, but require model retraining with the importance weights. Recently, Tian et al. (2023) propose a moment-matching framework (Tian et al., 2023) to address label shift, named Efficient Label Shift Adaptation (ELSA). Wen et al. (2024) propose an algorithm called Class Probability Matching with Calibrated Networks (CPMCN), which improves the computational efficiency and empirically outperforms existing methods. Importantly, the goal of these works is to improve the classifier's predictive performance on the label-shifted domain without addressing its calibration. While some methods (Alexandari et al., 2020; Wen et al., 2024) include a calibration step on the labeled validation (source) data to obtain importance weights, they do not calibrate the models on the target domain. In contrast, we propose an approach for target domain calibration without relying on labeled target data. In the absence of target labels, we leverage importance weight estimators to re-weigh the source data.

## 3 Methods

We consider a classification setting where \(X=^{d}\) is the input, and \(Y=\{0,1\}^{k}\) is the one-hot encoded target, with \(d\) as the feature space dimensionality, and \(k\) the number of classes. The data consists of: labeled source data \(\{(x_{i},y_{i})\}_{i=1}^{n}\) and unlabeled target data \(\{x_{i}\}_{i=n+1}^{n+m}\). The notation \(p_{s}()\) and \(p_{t}()\) denotes distributions on the source and target domain, respectively. The support on the target domain is a subset of \(\), i.e., the target data does not contain new classes. We use capital letters for unbounded random variables, and lower case letters with subscripts for elements of the data sample. Note that we may still treat elements of the data sample as random variables.

Consider a probabilistic classifier \(f^{k}\), where \(^{k}\) is a (\(k-1\))-dimensional probability simplex over \(k\) classes, and let \(Z=f(X)\) denote the predicted probability distribution for input \(X\). We focus on _class-wise calibration error_(Kull et al., 2019; Kumar et al., 2019; Gruber and Buettner, 2022), given by:

\[_{p}(f)^{p}=_{c=1}^{k}[ (Y_{c}=1 Z_{c})-Z_{c}^{p} ],\] (1)

where \(Y_{c}\) denotes the \(c^{}\) entry in the one-hot label, and \(Z_{c}\) denotes the \(c^{}\) class confidence score. Since the CE is defined w.r.t. the data distribution, the model's calibration decreases under domain shift, also empirically shown by Ovadia et al. (2019); Karandikar et al. (2021). However, those works estimate CE on the target shifted data using labels, often unavailable in practice. Thus, we derive an \(L_{p}\) classwise CE estimator for label-free target distribution exhibiting _label shift_.

Calibration error estimator under label shift.We consider a label shift: \(p_{s}(Y) p_{t}(Y)\) and \(p_{s}(X Y)=p_{t}(X Y)\). We assume the target distribution is absolutely continuous w.r.t. the source; i.e., for every \(Y\) with \(p_{t}(Y)>0\), we require \(p_{s}(Y)>0\)(Lipton et al., 2018)4. Assuming access to \(n\) labeled source samples, and \(m\) unlabeled target samples, we aim to find an estimator:

\[}_{p}(f)^{p}=_{c=1}^{k}_{ j=n+1}^{m+n}_{p_{t}[} z_{jc} ]}-z_{jc}^{p},\] (2)

where the expectations are taken w.r.t. the target, and \(z_{jc}\) denotes the \(c^{}\) entry of the vector \(z_{j}\).

The main challenge is estimating the conditional expectation \(_{p_{t}[} z_{jc}]}\) without labels from the target distribution. To re-weigh the source label distribution, we use importance weights \(=(_{1},,_{k})^{T}\), where \(_{i}:=p_{t}(Y_{c}=1)/p_{s}(Y_{c}=1)\), which we estimate using unsupervised domain adaption methods (Tian et al., 2023; Alexandari et al., 2020; Azizzadenesheli et al., 2019; Lipton et al., 2018). Then, for the conditional expectation, we have:

\[_{p_{t}}[Y_{c} Z_{c}=z_{c}] =_{y_{c}\{0,1\}}y_{c}(Y_{c}=y_{c},Z_{c}=z_{c})} {p_{t}(Z_{c}=z_{c})}=(Z_{c}=z_{c} Y_{c}=1)p_{t}(Y_{c}=1)}{p_{t }(Z_{c}=z_{c})}\] (3) \[=(Z_{c}=z_{c}|Y_{c}=1)p_{s}(Y_{c}=1)_{c}}{p_{t}( Z_{c}=z_{c})}_{c}_{i=1}^{n}(Z_{c}=z_ {c},z_{ic})y_{ic}}{_{i=n+1}^{m+n}(Z_{c}=z_{c},z_{ic})}\] (4)

where \(_{c}=(Y_{c}=1)}{p_{s}(Y_{c}=1)}\), \(_{c}\) is its empirical estimate, and \(\) is any consistent kernel over its domain (Silverman, 1986). Under the label shift assumption, we estimate \(p_{t}(Z|Y)\) using \(p_{s}(Z|Y)\) because \(p(X|Y)\) remains constant, with \(Z=f(X)\) and \(f\) being a fixed model. The weights \(\) are estimated for each \(Y\) using labeled source and unlabeled target data, along with the model \(f\). The error rate of the conditional expectation estimator in Equation (4) is determined by the maximum error rate of its components: the weight \(_{c}\) and the ratio estimator. Empirically, we use the RLLS estimator, with an error rate: \((n^{-1/2}+m^{-1/2})\)(Azizzadenesheli et al., 2019, Lemma 1) (same as the ratio estimator (Scott and Wu, 1981, Theorem 1)).

**Proposition 3.1**: _Given a kernel \(\) consistent over its domain (Silverman, 1986), \(_{p_{t}[} Z_{c}]}\) is a pointwise consistent estimator of \(_{p_{t}[Y_{c} Z_{c}]}\), that is:_

\[}\ _{c} _{i=1}^{n}(Z_{c},z_{ic})y_{ic}}{_{i=n+1}^{m+n}(Z_{ c},z_{ic})}=(Z_{c}=z_{c} Y_{c}=1)p_{t}(Y_{c}=1)}{p_{t}(Z_{c}=z_{c})}\] (5)Proof sketch.: The proof structure follows (Popordanoska et al., 2022, Proposition 3.2), which demonstrates the pointwise consistency of the ratio estimator. Since the weight estimator is also consistent (Azizzadenesheli et al., 2019, Lemma 1), by the same argument for the product of two convergent sequences of random variables (Proposition 3.2), the conditional expectation estimator is also pointwise consistent.

Plugging Equation (4) back into Equation (2), for CE under label shift we get:

\[}_{p}(f)^{p}=_{c=1}^{k}_{j =n+1}^{m+n}|_{c}_{i=1}^{n}(z_{jc}, z_{ic})y_{ic}}{_{i j}^{m+n}(z_{jc},z_{ic})}-z_{jc} |^{p}.\] (6)

The estimator has values \(\). Since the ratio is pointwise consistent by Proposition 3.1, and following Popordanoska et al. (2022, Proposition 3.5), the CE estimator is consistent for any consistent kernel. Depending on the kernel, the estimator can be differentiable and integrated into post-hoc and trainable calibration methods 5. We use a binning kernel, returning \(1\) when \(z_{ic}\) and \(z_{jc}\) fall in the same bin, and \(0\) otherwise. The binning estimator yields consistency under well known conditions on the number of bins as a function of the number of observations (Lugosi and Nobel, 1996).

Unsupervised calibration under label shift.The CE estimator can be integrated in any post-hoc calibration method, e.g., temperature scaling. In the supervised i.i.d. setting, the optimal temperature \(T^{*}\) is obtained by minimizing the cross entropy loss. In the label shift setting, we propose using LaSCal to find \(T^{*}\) by minimizing the classwise calibration error obtained by the estimator in Equation (6). In particular, let \(l_{j}\) denote the logits corresponding to \(z_{j}\), and \(()\) the _softmax_ function. We find the optimal temperature \(T^{*}\) as:

\[T^{*}=*{arg\,min}_{T}\,_{c=1}^{k}_{ j=n+1}^{m+n}|_{p_{t}}[(l_{j}}/T)_{c}]- (l_{j}/T)_{c}|^{p}.\] (7)

## 4 Experiments and Discussion

**Datasets.** To assess the performance of LaSCal for calibrating models facing label shift, we experiment using natural image datasets (Krizhevsky et al., 2009), as well as datasets derived from real-world scenarios (Koh et al., 2021). In particular, we use the CIFAR-10/100 Long Tail (LT) datasets (Cao et al., 2019), which are simulated from CIFAR (Krizhevsky et al., 2009) with an imbalance factor (IF) defined as a ratio of the number of samples in the most and least prevalent class. We additionally use Wilds (Koh et al., 2021) with different modalities: Camelyon17 (Bandi et al., 2018) and iWildCam (Beery et al., 2021) with images, and Amazon (Ni et al., 2019) with text. Camelyon17 consists of histopathological images of patient lymph node sections with potential metastatic breast cancer. The labels denote whether the central region contains a tumor (binary). iWildCam consists of images from animal traps in the wild, while the labels are different animal species. The Amazon dataset contains review text samples paired with 1-out-of-5 star ratings as labels. Please refer to Appendix A.1 for details about the datasets.

**Metrics.** Unless stated otherwise, we report \(L_{2}\) calibration error (CE) \( 100\)(Kumar et al., 2019), fix the number of bins to 15, and use adaptive binning strategy (Vaicenavicius et al., 2019)). In multi-class settings, we report the sum of per-class CE. We perform a bootstrap procedure, i.e., repeatedly resampling with replacement and estimating CE on each subset, and we report the mean and standard deviation of the estimates. In the reliability diagrams, we report \(L_{1}\) top-label CE (ECE).

**Models.** For the experiments we conduct on CIFAR-10/100 we use ResNet (He et al., 2016) models initialized from scratch with different depths (20, 32, 56, 110). For experiments on iWildCam we report results with a standard ResNet-50 (He et al., 2016), two ViT-large transformer-based models (Dosovitskiy et al., 2020) (with an image resolution of 224 or 384), and Swin-Large (Liu et al., 2021) (all pre-trained on ImageNet). For experiments on Amazon, we use pre-trained transformer-based models: BERT (Devlin et al., 2018), RoBERTa (Liu et al., 2019), DistillBert (Sanh et al., 2019) and DistillRoBERTa (Sanh et al., 2019). For the experiments on Camelyon17, we use a ResNet-50 pre-trained on ImageNet. Please refer to Appendix A.2 for implementation details.

### Calibration under label shift

We compare the performance of LaSCal as a method for post-hoc calibration of a model trained on a source distribution against several (state-of-the-art) baselines. We compare against: (i) **Uncal**: uncalibrated model trained on source data; (ii) **TempScal** calibrated model using temperature scaling on source data; (iii) **CPCS**(Park et al., 2020), **TransCal**(Wang et al., 2020), and **HeadToTail** Chen and Su (2023): calibrated models using adapted versions of TempScal, derived under covariate shift assumption. HeadToTail additionally assumes long-tailed source data, and balanced target data. (iv) **EM-BCTS**(Alexandari et al., 2020) and **CPMCN**(Wen et al., 2024): methods for label shift adaptation, where a calibration step is performed on the source data prior to obtaining the importance weights. Note that TempScal relies only on labeled source data, while the other baselines also incorporate unlabeled target data. Additionally, in Appendix A.3 we include other common, post-hoc, source-domain calibration methods: vector scaling (**VectScal**) (Guo et al., 2017), an ensemble method designed to improve the expressivity of TempScal, abbreviated as **EnsTempScal**(Zhang et al., 2020), and one-versus-all isotonic regression (**IROVA**) (Zadrozny and Elkan, 2002).

We train ResNet models on the CIFAR-10/100 LT variants, and use \(=10\), i.e., the least frequent class is subsampled to 10% of the original size, while the target is balanced. The iWildCam and Amazon datasets have an i.i.d. validation set, serving as our source distribution, and an i.i.d. test set, to which we apply label shift and use it as our target distribution. We use the i.i.d. test set to ensure that the input distribution \(p(X)\) remains the same. On iWildCam, we select the 20 most frequent classes from the target dataset. On both iWildCam and Amazon, we obtain a uniform target distribution by subsampling each class, based on the frequency of the least frequent class.

_Performance of LaSCal across various modalities, datasets and models._ In Table 2, we report CE on the label-shifted (balanced) target domain before and after calibration with various post-hoc methods. We observe that LaSCal either achieves a lower macro-averaged CE across models compared to other methods, or performs on par with the top-performing method, irrespective of the input modality. Compared to the second best method - EM-BCTS - where the calibration is performed on the labeled source data, the proposed LaSCal is explicitly derived for _unsupervised_ calibration on a label-shifted _target_ distribution. Notably, LaSCal significantly outperforms other baselines on CIFAR-100, where around 50% of the classes contain less than 30 source data points (see Figure 5 in Appendix A.1). This highlights LaSCal's effectiveness even in low data regimes6. In Appendix A.3, we report accuracy, additional experiments using other IFs on CIFAR-10/100, and provide results for the scenario where the source is balanced and the target is long-tailed, as commonly studied in related works (Tian et al., 2023; Alexandari et al., 2020; Lipton et al., 2018; Azizzadenesheli et al., 2019).

_Performance of LaSCal compared to temperature scaling using labels._ In Fig. 1 (Left), we evaluate how closely LaSCal (without labels) approaches the performance of temperature scaling applied on the target distribution using labels, referred to as TempScal (Target), which serves as a competitive baseline. For comparison, we also include temperature scaling applied on the source distribution, referred to as TempScal (Source), representing a lower reference point for the method's performance. Throughout these experiments, we keep the input distribution \(p(X)\) fixed. Across different models on iWildCam and Amazon, we observe that LaSCal performs favorably relative to TempScal (Source) and closes the gap with TempScal (Target), demonstrating its effectiveness in unsupervised calibration.

_Label shift with changing input distribution._ We consider an alternative setting where both the label \(p(Y)\) and input \(p(X)\) distributions change, which is common in real-world applications7. We investigate this scenario by using the out-of-distribution (OOD) test sets of Amazon and iWildCam (\(p(X)\) changes), to which we apply label shift, and use them as our target distribution. The iWildCam OOD test set contains images of camera traps from locations absent from the source distribution, with variation in illumination, camera angle, background, vegetation, etc. (Beery et al., 2021). The Amazon OOD test set contains reviews from users outside of the source distribution. In Fig. 1 (Right), we report the CE after post-hoc calibration using temperature scaling on the source distribution (TempScal), using HeadToTail8, and LaSCal. We observe that both HeadToTail and LaSCal significantly outperform TempScal across all models. Furthermore, despite the more challenging setting, we observe that LaSCal performs on par or outperforms the HeadToTail method.

Top-label calibrationWhile classwise calibration is central to our analysis, top-label calibration remains a popular approach in related works. To gain insights about this notion of calibration, we present reliability diagrams in Fig. 2 for DistillRoBERTa trained on Amazon, allowing us to visually assess the calibration quality across confidence levels. We report CE of (a) an uncalibrated model, (b) after applying temperature scaling on the source domain, (c) after label-shift adaption using EM-BCTS, and (d) after applying temperature scaling using LaSCal. The blue bars indicate

   Model & TempScal & CPCS & TransCal & HeadToTail & EM-BCTS & CPMCN & LaSCal \\ 
**CIFAR-10-LT (FF=10)** & & & & & & & \\  ResNet-20 & \(8.87_{0.38}\) & \(4.55_{0.18}\) & \(4.61_{0.17}\) & \(5.05_{0.20}\) & \(4.71_{0.14}\) & \(}\) & \(3.79_{0.11}\) & \(}\) \\ ResNet-32 & \(10.45_{0.41}\) & \(5.03_{0.24}\) & \(5.18_{0.21}\) & \(6.59_{0.32}\) & \(4.87_{0.15}\) & \(4.99_{0.24}\) & \(5.19_{0.21}\) & \(\) \\ ResNet-56 & \(11.25_{0.31}\) & \(4.82_{0.18}\) & \(5.10_{0.18}\) & \(6.96_{0.20}\) & \(4.75_{0.14}\) & \(_{0.11}\) & \(4.42_{0.12}\) & \(4.57_{0.15}\) \\ ResNet-110 & \(11.89_{0.35}\) & \(5.12_{0.18}\) & \(5.12_{0.17}\) & \(7.51_{0.26}\) & \(4.78_{0.14}\) & \(_{0.12}\) & \(4.43_{0.13}\) & \(4.70_{0.16}\) \\   _Macor average_ & \(10.62\) & \(\) & \(5.00\) & \(6.53\) & \(4.78\) & \(\) & \(4.46\) & \(\) \\    _CIFAR-10-LT (FF=10)_ \\  } & & & & & & & \\  ResNet-20 & \(65.66_{0.23}\) & \(24.61_{0.24}\) & \(24.12_{0.23}\) & \(48.15_{0.29}\) & \(19.93_{0.21}\) & \(25.01_{0.21}\) & \(25.02_{0.24}\) & \(}\) \\ ResNet-32 & \(71.16_{0.24}\) & \(28.29_{0.24}\) & \(24.84_{0.25}\) & \(57.53_{0.24}\) & \(28.37_{0.23}\) & \(26.17_{0.21}\) & \(24.76_{0.20}\) & \(}\) \\ ResNet-56 & \(72.24_{0.21}\) & \(29.71_{0.22}\) & \(25.03_{0.24}\) & \(59.27_{0.28}\) & \(29.72_{0.27}\) & \(26.33_{0.23}\) & \(24.53_{0.22}\) & \(}\) \\ ResNet-110 & \(72.80_{0.21}\) & \(31.55_{0.25}\) & \(26.51_{0.25}\) & \(60.52_{0.27}\) & \(31.58_{0.27}\) & \(28.22_{0.24}\) & \(26.49_{0.22}\) & \(}\) \\    & \(70.47\) & \(28.54\) & \(25.13\) & \(56.37\) & \(27.40\) & \(26.43\) & \(25.20\) & \(\) \\    &  & & & & & \\  RoBERTa & \(11.44_{0.79}\) & \(4.91_{0.31}\) & \(4.20_{0.39}\) & \(4.36_{0.36}\) & \(4.36_{0.36}\) & \(2.72_{0.35}\) & \(}\) & \(3.66_{0.29}\) \\ DistillRoBERTa & \(17.82_{0.98}\) & \(5.21_{0.45}\) & \(3.60_{0.31}\) & \(7.75_{0.60}\) & \(2.90_{0.21}\) & \(_{0.28}\) & \(2.81_{0.23}\) & \(2.72_{0.23}\) \\ BERT & \(27.33_{0.98}\) & \(7.75_{0.55}\) & \(4.34_{0.39}\) & \(16.98_{0.98}\) & \(}\) & \(3.95_{0.40}\) & \(9.32_{0.54}\) & \(3.72_{0.34}\) \\ DistillBERT & \(22.18_{1.14}\) & \(6.54_{0.51}\) & \(3.94_{0.32}\) & \(11.89_{0.75}\) & \(3.43_{0.29}\) & \(3.41_{0.36}\) & \(5.48_{0.34}\) & \(}\) \\   &  &  &  &  &  &  &  \\   _WiHLcam_ & & & & & & & \\  ResNet50 & \(18.44_{0.74}\) & \(16.38_{0.61}\) & \(}\) & \(13.81_{0.48}\) & \(15.53_{0.56}\) & \(15.84_{0.57}\) & \(19.43_{0.69}\) & \(13.07_{0.45}\) \\ Swin-Large & \(22.07_{0.84}\) & \(17.39_{0.66}\) & \(17.57_{0.60}\) & \(16.42_{0.49}\) & \(16.55_{0.57}\) & \(16.81_{0.63}\) & \(18.03_{0.62}\) & \(}\) \\ ViT-Large & \(17.94_{0.71}\) & \(16.78_{0.66}\) & \(20.24_{0.80}\) & \(13.64_{0.48}\) & \(16.53_{0.66}\) & \(24.83_{1.31}\) & \(19.33_{0.80}\) & \(}\) \\ ViT-Large (384) & \(18.99_{0.86}\) & \(18.78_{0.80}\) & \(29.2_{0.96}\) & \(_{0.52}\) & \(17.92_{0.77}\) & \(19.78_{0.73}\) & \(20.74_{0.7}\) & \(17the accuracy per bin, and the red bars represent the gap of each bin to perfect calibration, i.e., the difference between accuracy and confidence for a given bin (darker shades signify under-confidence, while brighter red colors denote over-confidence). We observe that LaSCal provides better calibration (i.e., lower ECE) compared to other baselines, as also confirmed by the reported \(L_{1}\) top-label CE in the bottom right corner of each plot. Furthermore, note that while the classwise CE values of EM-BCTS are better than LaSCal (Table 2), the diagrams reveal that top-label confidence scores obtained with LaSCal are favorable compared to EM-BCTS in most bins.

Building on this, we adapt our approach to top-label calibration, and we include the adapted estimator, along with empirical comparisons with competing calibration methods in Appendix B. The results on Amazon and iWildCam further validate the effectiveness of LaSCal, which continues to outperform other methods, demonstrating its superior calibration capabilities in the top-label setting.

### Empirical analysis of the estimator's properties

Robustness analysis.Using the Camelyon17 dataset, we conduct a series of experiments to assess the impact of various factors on the performance of the CE estimator, and report the results in Fig. 3. We partition the original training set as the source distribution, and we use the i.i.d. validation set to form a target set with varying label distribution shifts. We chose this dataset because (i) the application is both realistic and safety-critical; (ii) the dataset is balanced across source and target, enabling us to alter both distributions as per the setting we are trying to verify; (iii) the problem is binary, allowing us to study the estimator properties on a simple problem. For all experiments, we use a ResNet-50 model pre-trained on ImageNet, subsequently fine-tuned on the Camelyon17 dataset.

Across the experiments, we construct the train and validation sets, sampled from the source distribution, by keeping all negative samples and sampling a portion of the positives. Unless stated otherwise, we report results by sampling \(20\%\) of the positive samples for training: i.e., \(5:1\) ratio of negative to positive points. We compare the estimated CE values (without labels) to the ground truth (with labels), across different experimental scenarios, designed to assess the impact of a change in the data distribution and the sample size on the CE estimation. To account for the variability in data resampling, we average the results across 10 iterations. For each iteration, we apply bootstrap sampling and compute the mean and variance of the estimated CE. Finally, we report the overall mean and standard deviation (depicted as shaded region in the plot) across all iterations.

Impact of data distribution changes.In Fig. 2(a), we investigate the effect of increasing the label shift intensity of the target distribution. We impose a constraint such that the size of the source and target distribution is the same (\(n=m\)), and we systematically shift the target by modifying the ratio of negative to positive samples: \(5:1,4:1,...,1:1,...,1:4\). Therefore, in the most favorable scenario (\(5:1\)), the source and target distribution are the same (no label shift), while in the extreme \(1:4\), we have \(4\) times as many positive samples in the target data (which could occur, e.g., during a disease outbreak). We observe that the estimated CE closely follows the ground truth, even in the most extreme case. Furthermore, we observe that the variance increases with the intensity of the shift, indicating greater uncertainty and reducing the confidence one should have in the CE estimates. In Fig. 2(b) we analyze the effect of changing the ratio of source to target samples (\(n:m\)), while keeping the total number of points (\(n+m\)) constant. The source distribution has a \(5:1\) ratio of negative to positive points, while the target is balanced. We observe that the estimator achieves

Figure 2: Reliability diagrams on Amazon using DistillRoBERTa before and after calibration. TempScal (Source) and EM-BCTS perform IID calibration on the source distribution. LaSCal calibrates the model on the unlabeled target distribution. We report \(L_{1}\) top-label CE in the bottom right corner.

optimal performance when the source and target data sizes are equal (\(n:m\)). As the ratio increases, the estimated values begin to diverge slightly from the ground truth. However, the true values lie within the estimator's standard deviation in most cases, demonstrating that even in more extreme settings - \(5\) more source than target samples - our estimator yields reliable CE estimates.

_Impact of data size._ In Fig. 2(c), we constrain that \(n=m\), and we incrementally vary the sample size from \(1,000\) to \(10,000\) samples. In practice, low data regimes are common where annotated data is costly to obtain. We observe that the CE estimates deviate from the ground truth the most when using the fewest data points (i.e., \(1000\)), and improve as the data quantity increases. Furthermore, our estimator has a positive bias w.r.t. ground truth in the small data regime, indicating that the estimator tends to be conservative in that setting. Such tendency is preferable in this context, as it prevents mistakenly reporting good performance of a model on the basis of not enough samples. In essence, our method errs on the side of caution, ensuring reliability even in data-constrained environments.

Method analysis.We further investigate (i) how different weight estimation methods influence the estimator's effectiveness, and (ii) to what extent our CE estimates (without labels) deviate from the values obtained using labeled target data.

_Impact of the weight estimation method._ Our estimator relies on the availability of per-class importance weights, which can be obtained using domain adaptation methods, such as ELSA (Tian et al., 2023), RLLS (Azizzadenesheli et al., 2019) and BBSL (Lipton et al., 2018). In Fig. 4 (Left), we compare the performance of these methods when integrated in our estimator. We observe that RLLS emerges as the most favorable compared to the others, providing reasonable importance weights in all settings. See Appendix A.4 for experiments involving other weight estimators.

_Performance evaluation._ In Fig. 4 (Right), we investigate the CE measured by our estimator, compared to the ground-truth CE (obtained using labels from the target domain). Additionally, we report the CE on the source domain as a reference point. We observe that the calibration error increases from the source to target domain when the model is facing label shift. Importantly, our estimator (\(_{t}}\)) effectively closes the gap to the ground-truth (\(_{t}\)), consistently yielding accurate CE estimates across models on Amazon and iWildCam.

## 5 Discussion and Conclusion

In this work, we addressed the problem of estimating CE of an _unlabeled_ target distribution under _label shift_. We observe that prior state-of-the-art methods Wang et al. (2020); Chen and Su (2023) only address CE estimation under the covariate shift assumption: \(p_{s}(X) p_{t}(X)\) and \(p_{s}(Y|X)=p_{t}(Y|X)\); while, to the best of our knowledge, we propose the first CE estimator under the label shift assumption: \(p_{s}(Y) p_{t}(Y)\) and \(p_{s}(X|Y)=p_{t}(X|Y)\). We demonstrated that it yields CE estimates closely reflecting the ground truth. Furthermore, we showcase that our estimator can be successfully used as a post-hoc calibration method - LaSCal - for unsupervised model calibration on a target distribution. Overall, our experiments indicate that LaSCal can effectively minimize the CE across

Figure 3: Robustness analysis. We report mean and standard deviation over multiple iterations of resampling the data. \(5:1\) denotes “no shift”, and the severity increases from left to right. LaSCal generalizes well to a wide range of shifts, ratios of source to target samples, and sample sizes.

different intensities of label shift and various modalities. Finally, we analyze the properties of the estimator and contribute towards a nuanced understanding of its strengths and weaknesses.

**Limitations.** First, LaSCal is specifically designed to address label-shift, however, other types of dataset-shift are equally important, e.g., _covariate shift_(Shimodaira, 2000). Note that our experiments in SS4.1 shed light on the scenario where the models encounter both label shift and shift in \(p(X)\), and we observed favorable results compared to prior work. Nevertheless, we consider designing consistent CE estimators under covariate shift a crucial direction for future work. Second, the estimator we propose is dependent on how well the importance weights reflect the ground truth between the classes, which we obtain from current methods (Tian et al., 2023; Azizzadenesheli et al., 2019; Alexandari et al., 2020). Expectedly, we inherit some limitations of such methods: if certain classes are under-represented, the importance weights could be unreliable. However, our experiments in Appendix A.4 showcase that our estimator consistently improves as the weights become more accurate. Third, the estimator requires a sufficient number of data samples, e.g., \(4000\) samples in Figure 3c, to accurately estimate the calibration error. In severely data-scarce settings, this requirement may limit potential applications. However, the error rate of our estimator is \((n^{-1/2}+m^{-1/2})\), which is the same as the weight estimation methods (see Azizzadenesheli et al. (2019, Lemma 1) for the RLLS method, and Garg et al. (2020, page 8, top paragraph) for the EM-BCTS method). Therefore, the data requirement is not unique to our method, but rather it is common across all weight estimation-based approaches.

**Broader impact.** Our proposed approach effectively reduces CE under label shift, and allows for a more comprehensive and realistic evaluation of model calibration. We consider the ethical risks to be essentially the same as for any probabilistic classifier. Overall, we consider this paper a significant step toward improving the model's robustness and reliability, crucial for safety-critical applications.