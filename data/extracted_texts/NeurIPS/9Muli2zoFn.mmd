# Optimal Transport-Guided Conditional Score-Based Diffusion Model

Xiang Gu\({}^{1}\), Liwei Yang\({}^{1}\), Jian Sun (\(\))\({}^{1,2,3}\), Zongben Xu\({}^{1,2,3}\)

\({}^{1}\) School of Mathematics and Statistics, Xi'an Jiaotong University, Xi'an, China

\({}^{2}\) Pazhou Laboratory (Huangpu), Guangzhou, China

\({}^{3}\) Peng Cheng Laboratory, Shenzhen, China

{xianggu,yangliwei}@stu.xjtu.edu.cn {jiansun,zbxu}@xjtu.edu.cn

###### Abstract

Conditional score-based diffusion model (SBDM) is for conditional generation of target data with paired data as condition, and has achieved great success in image translation. However, it requires the paired data as condition, and there would be insufficient paired data provided in real-world applications. To tackle the applications with partially paired or even unpaired dataset, we propose a novel Optimal Transport-guided Conditional Score-based diffusion model (OTCS) in this paper. We build the coupling relationship for the unpaired or partially paired dataset based on \(L_{2}\)-regularized unsupervised or semi-supervised optimal transport, respectively. Based on the coupling relationship, we develop the objective for training the conditional score-based model for unpaired or partially paired settings, which is based on a reformulation and generalization of the conditional SBDM for paired setting. With the estimated coupling relationship, we effectively train the conditional score-based model by designing a "resampling-by-compatibility" strategy to choose the sampled data with high compatibility as guidance. Extensive experiments on unpaired super-resolution and semi-paired image-to-image translation demonstrated the effectiveness of the proposed OTCS model. From the viewpoint of optimal transport, OTCS provides an approach to transport data across distributions, which is a challenge for OT on large-scale datasets. We theoretically prove that OTCS realizes the data transport in OT with a theoretical bound. Code is available at [https://github.com/XJTU-XGU/OTCS](https://github.com/XJTU-XGU/OTCS).

## 1 Introduction

Score-based diffusion models (SBDMs)  have gained much attention in data generation. SBDMs perturb target data to a Gaussian noise by a diffusion process and learn the reverse process to transform the noise back to the target data. The conditional SBDMs  that are conditioned on class labels, text, low-resolution images, _etc._, have shown great success in image generation and translation. The condition data and target data in the conditional SBDMs  are often paired. That is, we are given a condition for each target sample in training, _e.g._, in the super-resolution , each high-resolution image (target data) in training is paired with its corresponding low-resolution image (condition). However, in real-world applications, there could not be sufficient paired training data, due to the labeling burden. Therefore, it is important and valuable to develop SBDMs for applications with only unpaired or partially paired training data, _e.g._, unpaired  or semi-paired  image-to-image translation (I2I). Though there are several SBDM-based approaches  for unpaired I2I, the score-based models in these approaches are often unconditioned, and the conditions are imposed in inference by cycle consistency , designing the initial states , or adding a guidance term to the output of the unconditional score-based model . It is unclear how to train the conditional score-based model with unpaired training dataset. For the task with a few paired and a large numberof unpaired data, _i.e._, partially paired dataset, there are few SBDMs for tackling this task, to the best of our knowledge.

This paper works on how to train the conditional score-based model with unpaired or partially paired training dataset. We consider the I2I applications in this paper where the condition data and target data are images respectively from different domains. The main challenges for this task are: 1) the lack of the coupling relationship between condition data and target data hinders the training of the conditional score-based model, and 2) it is unclear how to train the conditional score-based model even with an estimated coupling relationship, because it may not explicitly provide condition-target data pairs as in the setting with paired data. We propose a novel Optimal Transport-guided Conditional Score-based diffusion model (OTCS) to address these challenges. Note that different from the existing OT-related SBDMs that aim to understand  or promote  the unconditional score-based models, our approach aims to develop the conditional score-based model for unpaired or partially paired data settings guided by OT.

We tackle the first challenge based on optimal transport (OT). Specifically, for applications with unpaired setting, _e.g._, unpaired super-resolution, practitioners often attempt to translate the condition data (_e.g._, low-resolution images) to target domain (_e.g._, consisting of high-resolution images) while preserving image structures , _etc._ We handle this task using unsupervised OT  that transports data points across distributions with the minimum transport cost. The coupling relationship of condition data and target data is modeled in the transport plan of unsupervised OT. For applications with partially paired setting, it is reasonable to utilize the paired data to guide building the coupling relationship of unpaired data, because the paired data annotated by humans should have a reliable coupling relationship. The semi-supervised OT  is dedicated to leveraging the annotated keypoint pairs to guide the matching of the other data points. So we build the coupling relationship for partially paired dataset using semi-supervised OT by taking the paired data as keypoints.

To tackle the second challenge, we first provide a reformulation of the conditional SBDM for paired setting, in which the coupling relationship of paired data is explicitly considered. Meanwhile, the coupling relationship in this reformulation is closely related to the formulation of the coupling from \(L_{2}\)-regularized OT. This enables us to generalize the objective of the conditional SBDM for paired setting to unpaired and partially paired settings based on OT. To train the conditional score-based model using mini-batch data, directly applying the standard training algorithms to our approach can lead to sub-optimal performance of the trained conditional score-based model. To handle this challenge, we propose a new "resampling-by-compatibility" strategy to choose sampled data with high compatibility as guidance in training, which shows effectiveness in experiments.

We conduct extensive experiments on unpaired super-resolution and semi-paired I2I tasks, showing the effectiveness of the proposed OTCS for both applications with unpaired and partially paired settings. From the viewpoint of OT, the proposed OTCS offers an approach to transport the data points across distributions, which is known as a challenging problem in OT on large-scale datasets. The data transport in our approach is realized by generating target samples from the optimal conditional transport plan given a source sample, leveraging the capability of SBDMs for data generation. Theoretically and empirically, we show that OTCS can generate samples from the optimal conditional transport plan of the \(L_{2}\)-regularized unsupervised or semi-supervised OTs.

## 2 Background

Our method is closely related to OT and conditional SBDMs, which will be introduced below.

### Conditional SBDMs with Paired Data

The conditional SBDMs  aim to generate a target sample \(\) from the distribution \(q\) of target training data given a condition data \(\). For the paired setting, each target training sample \(\) is paired with a condition data \(_{}()\). The conditional SBDMs with paired dataset can be roughly categorized into two types, respectively under the classifier guidance  and classifier-free guidance . Our approach is mainly related to the second type of methods. These methods use a forward stochastic differential equation (SDE) to add Gaussian noises to the target training data for training the conditional score-based model. The forward SDE is \(_{t}=f(_{t},t)\,t+g(t)\, \) with \(_{0} q\), and \(t[0,T]\), where \(^{D}\) is a standard Wiener process, \(f(\(^{D}\) is the drift coefficient, and \(g(t)\) is the diffusion coefficient. Let \(p_{t|0}\) be the conditional distribution of \(_{t}\) given the initial state \(_{0}\), and \(p_{t}\) be the marginal distribution of \(_{t}\). We can choose the \(f(,t)\), \(g(t)\), and \(T\) such that \(_{t}\) approaches some analytically tractable prior distribution \(p_{}(_{T})\) at time \(t=T\), _i.e._, \(p_{T}(_{T}) p_{}(_{T})\). We take \(f,g,T\), and \(p_{}\) from two popular SDEs, _i.e._, VE-SDE and VP-SDE  (please refer to Appendix A for model details). The conditional score-based model is trained by denoising score-matching loss:

\[_{}()=_{t}w_{t}_{_{ 0} q}_{_{t} p_{t|0}(_{t}|_{0}) }\|s_{}(_{t};_{}(_{0}),t)-_{_{t}} p_{t|0}(_{t}|_{0})\| _{2}^{2}, \]

where \(w_{t}\) is the weight for time \(t\). In this paper, \(t\) is uniformly sampled from \([0,T]\), _i.e._, \(t([0,T])\). With the trained \(s_{}(;,t)\), given a condition data \(\), the target sample \(_{0}\) is generated by the reverse SDE as \(_{t}=[f(_{t},t)-g(t)^{2}s_{}(_{t};,t)]t+g(t)\,}\), where \(}\) is a standard Wiener process in the reverse-time direction. This process starts from a noise sample \(_{T}\) and ends at \(t=0\).

### Optimal Transport

Unsupervised OT.We consider a source distribution \(p\) and a target distribution \(q\). The unsupervised OT  aims to find the optimal coupling/transport plan \(\), _i.e._, a joint distribution of \(p\) and \(q\), such that the transport cost is minimized, formulated as the following optimization problem:

\[_{}_{(,)}c(, ),\ \ =\{:T_{\#}^{}=p,T_{\#}^{ }=q\}, \]

where \(c\) is the cost function. \(T_{\#}^{}\) is the marginal distribution of \(\)_w.r.t._ random variable \(\). \(T_{\#}^{}=p\) means \((,)\,=p(), \). Similarly, \(T_{\#}^{}=q\) indicates \((,)\,=q(), \).

Semi-supervised OT.The semi-supervised OT is pioneered by [28; 30]. In semi-supervised OT, a few matched pairs of source and target data points (called "keypoints") \(=\{(_{k},_{k})\}_{k=1}^{K}\) are given, where \(K\) is the number of keypoint pairs. The semi-supervised OT aims to leverage the given matched keypoints to guide the correct transport in OT by preserving the relation of each data point to the keypoints. Mathematically, we have

\[_{}_{(,) m }g(,),\ \ =\{:T_{\#}^{ }(m)=p,T_{\#}^{}(m)=q\}, \]

where the transport plan \(m\) is \((m)(,)=m(,)(,)\), and \(m\) is a binary mask function. Given a pair of keypoints \((_{k_{0}},_{k_{0}})\), then \(m(_{k_{0}},_{k_{0}})=1\), \(m(_{k_{0}},)=0\) for \(_{k_{0}}\), and \(m(,_{k_{0}})=0\) for \(_{k_{0}}\). \(m(,)=1\) if \(,\) do not coincide with any keypoint. The mask-based modeling of the transport plan ensures that the keypoint pairs are always matched in the derived transport plan. \(g\) in Eq. (3) is defined as \(g(,)=d(R_{}^{s},R_{}^{t})\), where \(R_{}^{s},R_{}^{s}(0,1)^{K}\) model the vector of relation of \(\), \(\) to each of the paired keypoints in source and target domain respectively, and \(d\) is the Jensen-Shannon divergence. The \(k\)-th elements of \(R_{}^{s}\) and \(R_{}^{s}\) are respectively defined by

\[R_{,k}^{s}=,_{k})/)}{_{l=1} ^{K}(-c(,_{l})/)},\ R_{,k}^{t}=,_{k})/)}{_{l=1}^{K}(-c(, _{l})/)}, \]

where \(\) is set to \(0.1\). Note that, to ensure feasible solutions, the mass of paired keypoints should be equal, _i.e._, \(p(_{k})=q(_{k}),(_{k},_{k}) \). Please refer to  for more details.

\(L_{2}\)**-regularized unsupervised and semi-supervised OTs.** As in Eqs. (2) and (3), both the unsupervised and semi-supervised OTs are linear programs that are computationally expensive to solve for larger sizes of training datasets. Researchers then present the \(L_{2}\)-regularized versions of unsupervised and semi-supervised OTs that can be solved by training networks [31; 32]. The \(L_{2}\)-regularized unsupervised and semi-supervised OTs are respectively given by

\[_{}_{(,)}c(, )+^{2}(\|p q)\ \ _{} _{(,) m}g(, )+^{2}(m\|p q), \]

where \(^{2}(\|p q)=,)^{2}}{p()q( )}\,\,\), \(\) is regularization factor. The duality of the \(L_{2}\)-regularized unsupervised and semi-supervised OTs can be unified in the following formulation [31; 32]:

\[_{u,v}_{}(u,v)=_{ p}u( )+_{ q}v()- _{ p, q}I(,)[(u( )+v()-(,))_{+}]^{2}, \]where \(a_{+}=(a,0)\). For unsupervised OT, \(I(,)=1\) and \((,)=c(,)\). For semi-supervised OT, \(I(,)=m(,)\) and \((,)=g(,)\). In [31; 32], \(u,v\) are represented by neural networks \(u_{},v_{}\) with parameters \(\) that are trained by mini-batch-based stochastic optimization algorithms using the loss function in Eq. (6). The pseudo-code for training \(u_{},v_{}\) is given in Appendix A. Using the parameters \(\) after training, the estimate of optimal transport plan is

\[(,)=H(,)p()q( ),H(,)=I( ,)(u_{}()+v_{}( )-(,))_{+}. \]

\(H\) is called compatibility function. Note that \(\) and \(H\) depend on \(c\) and \(\), which will be specified in experimental details in Appendix C.

## 3 OT-Guided Conditional SBDM

We aim to develop conditional SBDM for applications with unpaired or partially paired setting. The unpaired setting means that there is no paired condition data and target data in training. For example, in unpaired image-to-image translation (I2I), the source and target data in the training set are all unpaired. For the partially paired setting, along with the unpaired set of condition data (e.g., source data in I2I) and target data, we are also given a few paired condition data and target data.

We propose an Optimal Transport-guided Conditional SBDM, dubbed OTCS, for conditional diffusion in both unpaired and partially paired settings. The basic idea is illustrated in Fig. 1. Since the condition data and target data are not required to be paired in the training dataset, we build the coupling relationship of condition and target data using OT [27; 28]. Based on the estimated coupling, we propose the OT-guided conditional denoising score matching to train the conditional score-based model in the unpaired or partially paired setting. With the trained conditional score-based model, we generate a sample by the reverse SDE given the condition. We next elaborate on the motivations, OT-guided conditional denoising score matching, training, and inference of our approach.

### Motivations for OT-Guided Conditional SBDM

We provide a reformulation for the conditional score-based model with paired training dataset discussed in Sect. 2.1, and this formulation motivates us to extend the conditional SBDM to unpaired and partially paired settings in Sect. 3.2. Let \(q\) and \(p\) respectively denote the distributions of target data and condition data. In the paired setting, we denote the condition data as \(_{}()\) for a target data \(\), and \(p\) is the measure by push-forwarding \(q\) using \(_{}\), \(p()=_{\{:_{}()= \}}q()\) over the paired training dataset.

Figure 1: Illustration of optimal transport-guided conditional score-based diffusion model. We build the coupling \((,)\) of condition data (_e.g._, source images in I2I) \(\) and target data \(\) guided by OT. Based on the coupling, we train the conditional score-based model \(s_{}(;,t)\) by OT-guided conditional denoising score-matching that uses the forward SDE to diffuse target data to noise. With \(s_{}(;,t)\), we generate data given the condition \(\) using the reverse SDE in inference.

**Proposition 1**.: _Let \((,)=)}(- _{}())\) where \(\) is the Dirac delta function, then \(_{}()\) in Eq. (1) can be reformulated as_

\[_{}()=_{t}w_{t}_{  p}_{ q}(,)_{_{t} p_{t|0}(_{t}|)}\|s_{}( _{t};,t)-_{_{t}} p_{t|0}(_{ t}|)\|_{2}^{2}. \]

_Furthermore, \((,)=(,)p() q()\) is a joint distribution for marginal distributions \(p\) and \(q\)._

The proof is given in Appendix B. From Proposition 1, we have the following observations. First, the coupling relationship of condition data and target data is explicitly modeled in \((,)\). Second, the joint distribution \(\) exhibits a similar formulation to the transport plan \(\) in Eq. (7). The definition of \((,)\) in Proposition 1 is for paired \(,\). While for the unpaired or partially paired setting, the definition of \((,)\) is not obvious due to the lack of paired relationship between \(,\). We therefore consider modeling the joint distribution of condition data (\(\)) and target data (\(\)) by \(L_{2}\)-regularized OT (see Sect. 2.2) for the unpaired and partially paired settings, in which the coupling relationship of condition data and target data is built in the compatibility function \(H(,)\).

### OT-Guided Conditional Denoising Score Matching

With the motivations discussed in Sects. 1 and 3.1, we model the coupling relationship between condition data and target data for unpaired and partially paired settings using \(L_{2}\)-regularized unsupervised and semi-supervised OT's, respectively. Specifically, the \(L_{2}\)-regularized unsupervised and semi-supervised OT's are applied to the distributions \(p,q\), and the coupling relationship of the condition data \(\) and target data \(\) is built by the compatibility function \(H(,)\). We then extend the formulation for paired setting in Eq. (8) by replacing \(\) with \(H\) to develop the training objective for unpaired and partially paired settings, which is given by

\[_{}()=_{t}w_{t}_{  p}_{ q}H(,)_{ _{t} p_{t|0}(_{t}|)}\|s_{}( _{t};,t)-_{_{t}} p_{t|0}(_{ t}|)\|_{2}^{2}. \]

Equation (9) is dubbed "OT-guided conditional denoising score matching". In Eq. (9), \(H\) is a "soft" coupling relationship of condition data and target data, because there may exist multiple \(\) satisfying \(H(,)>0\) for each \(\). While Eq. (8) assumes "hard" coupling relationship, _i.e._, there is only one condition data \(\) for each \(\) satisfying \((,)>0\). We minimize \(_{}()\) to train the conditional score-based model \(s_{}(_{t};,t)\). We will theoretically analyze that our formulation in Eq. (9) is still a diffusion model in Sect. 3.5, and empirically compare the "soft" and "hard" coupling relationship in Appendix D.

### Training the Conditional Score-based Model

To implement \(_{}()\) in Eq. (9) using training samples to optimize \(\), we can sample mini-batch data \(\) and \(\) from \(p\) and \(q\) respectively, and then compute \(H(,)\) and \(_{,}=_{t}w_{t}_{ _{t} p_{t|0}(_{t}|)}\|s_{}(_{t}; ,t)-_{_{t}} p_{t|0}(_{t}|) \|_{2}^{2}\) over the pairs of \((,)\) in \(\) and \(\). However, such a strategy is sub-optimal. This is because given a mini-batch of samples \(\) and \(\), for each source sample \(\), there may not exist target sample \(\) in the mini-batch with a higher value of \(H(,)\) that matches condition data \(\). Therefore, few or even no samples in a mini-batch contribute to the loss function in Eq. (9), leading to a large bias of the computed loss and instability of the training. To tackle this challenge, we propose a "resampling-by-compatibility" strategy to compute the loss in Eq. (9).

Resampling-by-compatibility.To implement the loss in Eq. (9), we perform the following steps:

* Sample \(\) from \(p\) and sample \(_{}=\{^{l}\}_{l=1}^{L}\) from \(q\);
* Resample a \(\) from \(_{}\) with the probability proportional to \(H(,^{l})\);
* Compute the training loss \(_{,}\) in the above paragraph on the sampled pair \((,)\).

In implementation, \(u_{}\) and \(v_{}\) (introduced above Eq. (7) in Sect. 2.2) are often lightweight neural networks, so \(H(,^{l})\) can be computed fast as in Eq. (7). In the applications where we are given training datasets of samples, for each \(\) in the set of condition data, we choose all the samples \(\) in the set of target data satisfying \(H(,)>0\) to construct \(_{}\), and meanwhile store the corresponding values of \(H(,)\). This is done before training \(s_{}\). During training, we directly choose \(\) from \(_{}\) based on the stored values of \(H\), which speeds up the training process. Please refer to Appendix A for the rationality of the resampling-by-compatibility.

[MISSING_PAGE_FAIL:6]

For semi-supervised OT, \(\) is further constrained by \(=m\). We follow  to assume that \((,u,v)\) is \(\)-strongly convex in \(L_{1}\)-norm _w.r.t._\(\), and take the assumptions (see Appendix B) in  that investigates the bound for unconditional SBDMs.

**Theorem 2**.: _Suppose the above assumption and the assumptions in Appendix B hold, and \(w_{t}=g(t)^{2}\), then we have_

\[_{ p}W_{2}(p^{}(|),(|))& C_{1}_{}(,u_{},v_{})_{1}+_{}( )}\\ +& C_{3}_{ p}W_{2}(p_{T} (|),p_{}), \]

_where \(C_{1},C_{2}\), and \(C_{3}\) are constants to \(\) and \(\) given in Appendix B._

The proof is provided in Appendix B. In OTCS, we use \(u_{}\) and \(v_{}\) to respectively parameterize \(u\) and \(v\) as discussed in Sect. 2.2. The trained \(u_{}\) and \(v_{}\) are the minimizer of the dual problem in Eq. (6) that are near to the saddle point of \((,u,v)\). This implies that the gradient norm \(\|_{}(,u_{},v_{})\|_{1}\) of the Lagrange function _w.r.t._ the corresponding primal variable \(\) is minimized in our approach. The conditional score-based model \(s_{}\) is trained to minimize \(_{}()\) according to Theorem 1. So the loss \(_{}()\) of trained \(s_{}\) is minimized. We choose the forward SDE such that \(p_{T}(|)\) is close to \(p_{}\), which minimizes \(_{ p}W_{2}(p_{T}(|),p_{})\). Therefore, OTCS minimizes \(_{ p}W_{2}(p^{}(|),( |))\), indicating that OTCS can approximately generate samples from \((|)\).

Comparison with related large-scale OT methods.Recent unsupervised OT methods [26; 38; 39; 40] often parameterize the transport map by a neural network learned by adversarial training based on the dual formulation [38; 39; 40], or generate samples from the conditional transport plan . Our method is mostly related to SCONES  that leverages the unconditional SBM for generating samples from the estimated conditional transport plan \((|)\). Motivated by the expression of \((|)\) in Sect. 3.5, given source sample \(\), SCONES generates target sample \(\) by the reverse SDE \(_{t}=[f(_{t},t)-g(t)^{2}(_{ _{t}} H(,_{t})+s_{}(_{t};t ))]t+g(t)\,}\), where \(s_{}(_{t};t)\) is the unconditional score-based model. The compatibility function \(H\) is trained on clean data. While in SCONES, \(_{_{t}} H(,_{t})\) is computed on noisy data \(_{t}\) for \(t>0\). OTCS computes \(H\) on clean data as in Eq. (9). We provide a 1-D example in Fig. 2 to evaluate SCONES and OTCS. From Figs. 1(c)-c), we can see that the sample histogram, generated by OTCS given "-4" as condition, better fits \((|-4)\). In Fig. 1(d), OTCS achieves a lower expected Wasserstein distance \(_{ p}W_{2}(p^{}(|), (|))\). In SCONES, the gradient of \(H\) on noisy data could be inaccurate or zero (as shown in Fig. 1(a)), which may fail to guide the noisy data \(_{t}\) to move towards the desired locations as \(t 0\). Our OTCS utilizes \(H\) to guide the training of the conditional score-based model, without requiring the gradient of \(H\) in inference. This may account for the better performance of OTCS.

## 5 Experiments

We evaluate OTCS on unpaired super-resolution and semi-paired I2I. Due to space limits, additional experimental details and results are given in Appendix C and D, respectively.

### Unpaired Super-Resolution on CelebA Faces

We consider the unpaired super-resolution for 64\(\)64 aligned faces on CelebA dataset . Following , we split the dataset into 3 disjointed subsets: A1 (90K), B1 (90K), and C1 (30K). For images in each subset, we do 2\(\) bilinear downsampling to obtain the low-resolution images, followed by 2\(\) bilinear upsampling to generate datasets of A0, B0, and C0 correspondingly. We train the model on A0 and B1 respectively as the source and target datasets, and test on C0 for generating high-resolution images. To apply OTCS to this task, we take B1 as target data and A0 as unpaired source data. We use the \(L_{2}\)-regularized unsupervised OT to estimate the coupling, where \(c\) is set to the mean squared \(L_{2}\)-distance. In testing, given a degenerated image \(\) in C0 as condition, we follow [19; 20] to sample noisy image \(_{M}\) from \(p_{M|0}(|)\) as initial state and perform the reverse SDE to generate the high-resolution image. \(M=0.2\) in experiments. Our approach is compared with recent adversarial-training-based unsupervised OT methods [38; 39; 40; 42; 43], diffusion-based unpaired I2I methods [20; 44], flow-based I2I method , and SCONES  (discussed in Sect. 4). We use the FID score  to measure the quality of translated images, and the SSIM metric to measure the structural similarity of each translated image to its ground-truth high-resolution image in C1.

In Tab. 1, OTCS achieves the lowest FID and the highest SSIM on CelebA dataset among the compared methods. We can observe that in general, the adversarial-training-based OT methods [38; 39; 40; 42; 43] achieve better SSIM than the diffusion-based methods [20; 44; 45; 26]. This could be because the OT guidance is imposed in training by these OT methods. By contrast, the diffusion-based methods [20; 44; 45; 26] generally achieve better FID than OT methods [38; 39; 40; 42; 43], which may be attributed to the capability of diffusion models for generating high-quality images. Our OTCS imposes the OT guidance in the training of diffusion models, integrating both advantages of OT and diffusion models. In Fig. 3, we show the guided high-resolution images sampled based on OT (left) and translated images by OTCS (right). We also report the FID (0.78) and SSIM (0.9635) of the Oracle that uses true high-resolution images in A1 as paired data for training. We can see that OTCS approaches the Oracle.

### Semi-paired Image-to-Image Translation

We consider the semi-paired I2I task that a large number of unpaired along with a few paired images across source and target domains are given for training. The goal of semi-paired I2I is to leverage the

    &  &  &  &  \\  & & FID \(\) & SSIM \(\) & FID \(\) & Acc (\%) \(\) & FID \(\) & Acc (\%) \(\) \\  W2GAN  & OT & 48.83 & 0.7169 & 118.45 & 33.56 & 97.06 & 29.13 \\ OT-ICNN  & OT & 33.26 & 0.8904 & 148.29 & 38.44 & 50.33 & 10.84 \\ OTM  & OT & 22.93 & 0.8302 & 69.27 & 33.11 & 18.67 & 9.48 \\ NOT  & OT & 13.65 & 0.9157 & 156.07 & 28.44 & 23.90 & 15.72 \\ KNOT  & OT & 5.95 & 0.8887 & 118.26 & 27.33 & **3.18** & 9.25 \\ ReFlow  & Flow & 70.69 & 0.4544 & 56.04 & 29.33 & 138.59 & 11.57 \\ EGSDE  & Diffusion & 11.49 & 0.3835 & 52.11 & 29.33 & 34.72 & 11.78 \\ DDIB  & Diffusion & 11.35 & 0.1275 & 28.45 & 32.44 & 9.47 & 9.15 \\ TCR  & – & – & – & 34.61 & 40.44 & 6.90 & 36.21 \\ SCONES  & OT, Diffusion & 15.46 & 0.1042 & 25.24 & 35.33 & 6.68 & 10.37 \\
**OTCS (ours)** & OT, Diffusion & **1.77** & **0.9313** & **13.68** & **96.44** & 5.12 & **67.42** \\   

Table 1: Quantitative results for unpaired super-resolution on Celeba and semi-paired I2I on Animal images and Digits. The best and second best are respectively bolded and underlined.

Figure 3: Left: The guided high-resolution images (_i.e._, \(:H(,)>0\)) sampled based on OT for low-resolution image \(\) in training. Right: results of OTCS on CelebA (64\(\)64) in unpaired setting.

paired cross-domain images to guide the desired translation of source images to the target domain. To apply our approach to the semi-paired I2I, we take the source images as condition data. We use the \(L_{2}\)-regularized semi-supervised OT to estimate the coupling. The cost \(c\) and \(c^{}\) in Eq. (4) are taken as the cosine dissimilarity of features using the image encoder of CLIP . Apart from the compared unpaired I2I approaches in Sect. 5.1, we additionally compare our approach with the semi-paired I2I approach TCR . For the OT-based approaches , we additionally impose the matching of the paired images using a reconstruction loss in them for semi-paired I2I. It is non-trivial to impose the matching of the paired images in the diffusion/flow-based approaches . We adopt two metrics of FID and Accuracy (Acc). The FID measures the quality of generated samples. The higher Acc implies that the guidance of the paired images is better realized for desired translation. The experiments are conducted on digits and natural animal images.

For _Animal images_, we take images of cat, fox, and leopard from AFHQ  dataset as source, and images of lion, tiger, and wolf as target. Three cross-domain image pairs are given, as shown in Fig. 4(a). By the guidance of the paired images, we expect that the cat, fox, and leopard images are respectively translated to the images of lion, tiger, and wolf. The Acc is the ratio of source images translated to ground-truth translated classes (GTTCs), where the GTTCs of source images of cat/fox/leopard are lion/tiger/wolf. For _Digits_, we consider the translation from MNIST  to Chinese-MNIST . The MNIST and Chinese-MNIST contain the digits (from 0 to 9) in different modalities. We annotate 10 cross-domain image pairs, each corresponding to a digit, as in Fig. 4(b). With the guidance of the paired images, we expect that the source images are translated to the target ones representing the same digits. The GTTCs for the source images are their corresponding digits.

We can observe in Tab. 1 that OTCS achieves the highest Acc on both Animal images and Digits, outperforming the second-best method TCR  by more than 50% and 30% on the two datasets, respectively. Our approach explicitly models the guidance of the paired images to the unpaired ones using the semi-supervised OT in training, and better translates the source images to target ones of the desired classes. In terms of the FID, OTCS achieves competitive (on Digits) or even superior (on Animal images) results over the other approaches, indicating that OTCS can generate images of comparable quality. The translated images in Figs. 4 also show the effectiveness of OTCS.

Figure 4: Results of OTCS for semi-paired I2I on (a) Animal images and (b) Digits. The bottom of Fig. 4(b) plots source (odd columns) and corresponding translated (even columns) images.

Figure 5: (a) Results of OTCS w/ and w/o RSC. (b-c) Results of OTCS with varying (b) numbers and (c) samplings of paired data on Animal images. (d) Results of OTCS for different \(M\) on CelebA.

### Analysis

**Effectiveness of resampling-by-compatibility (RSC).** Figure 5(a) shows that OTCS achieves better results (left top points are better) than OTCS (w/o RSC) in semi-paired I2I on Animal images and unpaired super-resolution on CelebA, demonstrating the effectiveness of resampling-by-compatibility.

**Results on semi-paired I2I with varying numbers and samplings of paired images.** We study the effect of the number and choice of paired images in semi-paired I2I. Figure 5(b) shows that as the number of paired data increases, the Acc increases, and the FID marginally decreases. This implies that our approach can impose the guidance of different amounts of paired data to translate source images to desired classes. From Fig. 5(c), OTCS achieves similar FID and Acc for three different samplings of the same number, _i.e._, 3, of paired images (denoted as "S1", "S2", and "S3" in Fig. 5(c)).

**Results on unpaired super-resolution with varying initial time.** We show the results of OTCS under different initial time \(M\) in the reverse SDE. Figure 5(d) indicates that with a smaller \(M\), our OTCS achieves better SSIM. This makes sense because adding smaller-scale noise in inference could better preserve the structure of source data in SBDMs, as in . However, smaller \(M\) may lead to a larger distribution gap/FID between generated and target data for SBDMs with unconditional score-based model . We observe that OTCS achieves the FID below 1.85 for \(M\) in [0.2, 0.5].

## 6 Conclusion

This paper proposes a novel Optimal Transport-guided Conditional Score-based diffusion model (OTCS) for image translation with unpaired or partially paired training dataset. We build the coupling of the condition data and target data using \(L_{2}\)-regularized unsupervised and semi-supervised OTs, and present the OT-guided conditional denoising score-matching and resampling-by-compatibility to train the conditional score-based model. Extensive experiments in unpaired super-resolution and semi-paired I2I tasks demonstrated the effectiveness of OTCS for achieving desired translation of source images. We theoretically analyze that OTCS realizes data transport for OT. In the future, we are interested in more applications of OTCS, such as medical image translation/synthesis.

## Limitations

The cost function should be determined first when using our method. In experiments, we simply choose the squared \(L_{2}\)-distance in image space for unpaired super-resolution and cosine distance in feature space for semi-paired I2I, achieving satisfactory performance. However, the performance may be improved if more domain knowledge is employed to define the cost function. Meanwhile, if the number of target data is small, the generation ability of our trained model may be limited.