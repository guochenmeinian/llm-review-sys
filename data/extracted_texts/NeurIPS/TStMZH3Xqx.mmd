# Context Shift Reduction for Offline Meta-Reinforcement Learning

Yunkai Gao1,2,3 Rui Zhang2 Jiaming Guo2 Fan Wu2,3,4,5 Qi Yi1,2,3 Shaohui Peng5 Siming Lan1,2,3 Ruizhi Chen5 Zidong Du2,6 Xing Hu2,6 Qi Guo2 Ling Li4,5 Yunji Chen2,4

Corresponding Author.1 University of Science and Technology of China, USTC, Hefei, China

2 State Key Lab of Processors, Institute of Computing Technology, Chinese Academy of Sciences, Beijing, China

3 Cambricon Technologies

4 University of Chinese Academy of Sciences, UCAS, Beijing, China

5 Intelligent Software Research Center, Institute of Software, CAS, Beijing, China

6 Shanghai Innovation Center for Processor Technologies, SHIC, Shanghai, China

{gyk314, yiqi, lansm}@mail.ustc.edu.cn

{wufan2020, pengshaohui, ruizhi, liling}@iscas.ac.cn

{zhangrui, guojiaming, duzidong, huxing, guoqi, cyj}@ict.ac.cn

###### Abstract

Offline meta-reinforcement learning (OMRL) utilizes pre-collected offline datasets to enhance the agent's generalization ability on unseen tasks. However, the context shift problem arises due to the distribution discrepancy between the contexts used for training (from the behavior policy) and testing (from the exploration policy). The context shift problem leads to incorrect task inference and further deteriorates the generalization ability of the meta-policy. Existing OMRL methods either overlook this problem or attempt to mitigate it with additional information. In this paper, we propose a novel approach called **C**ontext **S**hift **R**eduction for **O**MRL (**CSRO**) to address the context shift problem with only offline datasets. The key insight of CSRO is to minimize the influence of policy in context during both the meta-training and meta-test phases. During meta-training, we design a max-min mutual information representation learning mechanism to diminish the impact of the behavior policy on task representation. In the meta-test phase, we introduce the non-prior context collection strategy to reduce the effect of the exploration policy. Experimental results demonstrate that CSRO significantly reduces the context shift and improves the generalization ability, surpassing previous methods across various challenging domains.

## 1 Introduction

Meta-Reinforcement Learning (RL) has made significant strides in enhancing agents' generalization capabilities for unseen tasks. Meta-RL methods [6; 5; 27] leverage vast amounts of trajectories gathered across a task set during the meta-training phase to learn the shared structures of tasks. During meta-testing, these meta-RL methods exhibit swift adaptation to new tasks with a limited number of trials. Context-based meta-RL methods [27; 39; 7] have emerged as the most popular approaches, showcasing remarkable performance and rapid task adaptation. These methods first acquire task information by learning a task representation from the context (i.e., the set of transitions) and subsequently condition the policy on the task representation to execute appropriate actions.

Due to the requirement of a vast number of trajectories sampled from a task set, data collection in meta-RL can be both expensive and time-consuming. Offline RL [17; 32; 14] presents a potential solution to mitigate the cost of data collection. These methods only utilize large datasets that were previously collected by some policies (referred to as the behavior policy), without any online interaction with the environment during the training phase.

By combining meta-RL and offline RL, offline meta-reinforcement learning (OMRL) [18; 20; 37] amalgamates the benefits of generalization ability on unseen tasks and training without requiring interaction with the environment. During meta-training, both the acquisition of task representation and the training of the policy utilize pre-collected offline trajectories obtained from the task-dependent behavior policy.

However, OMRL faces a context shift problem: a distribution discrepancy arises between the context obtained from the behavior policy during meta-training and the context collected from the exploration policy during meta-testing . Given that the task representation is learned from the context, this context shift problem hinders the accurate inference of task information by the task representation. Consequently, this leads to a decline in performance when adapting to unseen tasks. As shown in Table 1, we compared the test results of FOCAL  and OffPearl  in two different environments and found that context shift significantly reduced testing performance.

Existing OMRL methods primarily aim to incorporate the benefits of offline RL into meta-RL, but they do not fully address the context shift problem. Some approaches [20; 21; 19] utilize pre-collected offline datasets from the test tasks to acquire task representation, disregarding the context shift problem. However, this approach is impractical as obtaining pre-collected offline datasets for new and unseen tasks is extremely challenging. Other methods attempt to mitigate the context shift problem but require additional information beyond the use of offline datasets alone. For instance,  assumes that the reward functions of all tasks are known,  requires the collection of a substantial volume of online data post offline training.

In this paper, we introduce a novel approach called **C**ontext **S**hift **R**eduction for **O**MRL (**CSRO**) to address the context shift problem using only offline datasets. The key insight of CSRO is to minimize the impact of the policy in context during both the meta-training and meta-test phases. Firstly, the context is collected from the task-dependent behavior policy, as depicted in Figure 1 left. When encoding the context into the task representation during meta-training, the task representation tends to embed the characteristics of the behavior policy. This incorrect task inference during the meta-test phase stems from the disparity between the behavior policy and the exploration policy. Hence, our objective is to reduce the influence of the behavior policy on task representation during the meta-training phase. To achieve this, we design a max-min mutual information representation learning mechanism that minimizes the mutual information between the task representation and the behavior policy, while maximizing the mutual information between the task representation and the task information. During the meta-test, the current exploration policy of OMRL [27; 4; 26] conditions on an initial task representation. The collected context corresponds to the policy of the initial task representation, which significantly differs from the behavior policy, as shown in Figure 1 middle. This context leads to incorrect task inference and control, as depicted in Figure 1 right. Therefore, we propose the non-prior context collection strategy to reduce the impact of the exploration strategy. In practice, the agent initially explores the task independently and randomly at each step, then the agent proceeds to explore based on the context. Through random exploration, the agent initially gains a preliminary understanding of the task and gradually enhances the accuracy of task recognition during subsequent exploratory steps.

Experimentally, we compare the proposed CSRO with previous OMRL algorithms. For a fair comparison, we use the same offline backbone algorithm and the same offline data for environments including Point-Robot and MuJoCo physics simulator  with reward or dynamic function changes. Experimental results demonstrate that the proposed CSRO can effectively mitigate the context shift problem and enhance the generalization capabilities, outperforming prior methods on a range of challenging domains.

## 2 Related Works

Meta Reinforcement Learning.Meta-RL leverages training task sets sampled from the task distribution to learn and generalize to new tasks. Gradient-based meta-RL [6; 33] methods seek policy parameter initialization that requires only a few update steps to generalize well on the new tasks. Since the parameters that cause reward or dynamic changes across different tasks are unknown, context-based meta-RL  address this problem as a PODMP. These methods employ a context encoder to extract task representations from historical trajectories, enabling the identification of task domains, with policies conditioned on these acquired task representations. Our proposed CSRO is based on context-based meta-RL frameworks .

Offline Reinforcement learning.Unlike on-policy and off-policy RL, in offline RL, the agent does not interact with the environment during the training process and only interacts with the environment during the test phase. Offline RL methods  use pre-collected data generated by behavior policy for training, effectively reducing the cost of data collection. The distribution shift between the behavior policy and the learned policy introduces the challenge of Q overestimation .  make the distribution shift bounded by constraining the differences between learned policy and behavior policy. We employ BRAC  as our offline backbone algorithm.

Offline Meta Reinforcement learning.OMRL solves the generalization problem and expensive data collection problem by using meta-learning on pre-collected offline datasets. Existing OMRL methods  use historical trajectories from offline datasets to infer task representations during meta-training. In the meta-test phase, existing methods can be categorized into two types based on the source of the context: offline test and online test. Offline test methods  use sampled context from the pre-collected offline data in the test task, which is impractical and ignores the context shift problem. In contrast, online test methods  use the context collected by the agent in the test task. While these online test methods can mitigate the context shift problem, they require additional information beyond just offline datasets, such as reward functions of all tasks  and additional online data . We focus on improving the generalization performance of the online test by addressing the context shift problem using fully offline datasets.

Mutual Information Optimization.In order to learn more about essential representation, mutual information optimization is often employed to enhance the correlation between the representation

   Env &  &  \\   & context A & context B & context A & context B \\  FOCAL & **-4.4**\(\)0.1 & -14.9\(\)1.1 & **-45.7**\(\)2.7 & -69.5\(\)9.6 \\ OffPearl & **-5.1**\(\)0.1 & -17.8\(\)1.5 & **-123.0**\(\)11.5 & -162.8\(\)28.8 \\   

Table 1: Context shift leads to testing performance decline. Context A refers to the use of offline data collected by behavior policy as the context during testing, with no context shift problem. Context B, on the other hand, involves using a trained meta-policy to explore and collect context based on an initial task representation, resulting in a context shift problem.

Figure 1: Offline meta-RL on the Point-Robot: one of the tasks where the task objective is to control the agent to reach the goal on the semicircle. **Left:** During meta-training, the offline dataset of this task is collected by task-dependent behavior policy and comprised solely of trajectories leading towards the goal. **Middle:** The agent was trained using the OffPearl  method. During the meta-test phase, the agent utilizes the current exploration policy of OMRL  and employs the learned meta-policy, which is conditioned on an initial task representation sampled from a prior distribution, to collect contexts. **Right:** The agent navigates out trajectory based on the context depicted in the middle subfigure, the same color represents the corresponding context and trajectory.

and other properties. The greater the mutual information, the greater the correlation between the two variables. [2; 22] maximizes the mutual information between variables by maximizing the estimated mutual information lower bound. [1; 3] minimizes the mutual information between variables by minimizing the upper bound of the estimated mutual information. In this work, we utilize CLUB  to minimize the mutual information between task representation and behavior policy.

## 3 Preliminaries

Problem Formulation.In RL, we formalize each task as a Markov Decision Process (MDP), defined by \(M=(S,A,P,_{0},R,)\) with state space \(S\), action space \(A\), transition function \(P(s^{}|s,a)\), reward function \(R(s,a)\), initial state distribution \(_{0}(s)\) and discount factor \((0,1)\). The distribution of policy is \((a|s)\). We aim to maximize the expected cumulative rewards \(J()=E_{}[_{t=0}^{}^{t}R(s_{t},a_{t})]\), where \(\) is trajectory following \(s_{0}_{0}\), \(a_{t}(a_{t}|s_{t})\), \(s_{t+1} P(s_{t+1}|s_{t},a_{t})\). We define the value function and action-value function as:

\[V_{}(s_{t})=_{a_{t},s_{t+1} P(s_{t+1}|s_{t},a_{t})}[ _{l=0}^{}^{l}R(s_{t+l},a_{t+l})]\] (1)

\[Q_{}(s_{t},a_{t})=R(s_{t},a_{t})+_{s_{t+1} P(s_{t+1}|s_ {t},a_{t})}[V_{}(s_{t+1})]\] (2)

In offline meta-reinforcement learning (OMRL), we assume each task sampled from a prior task distribution, \(M_{i}=(S,A,P_{i},_{0},R_{i},) p(M)\). Different tasks have the same state space and action space, but the reward function or transition dynamic is different due to different parameters. So the task distribution can be defined as \(p(R,P)\). The offline datasets \(D_{i}=\{(s_{i,j},a_{i,j},r_{i,j},s^{}_{i,j})\}_{j=1}^{N_{slice}}\) of task \(M_{i}\) is composed of the state, action, reward, and next-state tuples collected by the task-dependent behavior policy \(^{i}_{}(a|s)\). Since the parameters of different tasks are unknown, for each task, context-based OMRL samples a mini-batch of historical data from the offline datasets as the context \(c=\{(s_{j},a_{j},r_{j},s^{}_{j})\}_{j=1}^{n}\). The context encoder transforms the context \(c\) into a task representation \(z=q_{}(z|c)\). Policy, value function, and action-value function are all conditioned on \(z\). We use offline data to train the meta policy \(_{}(a|s,z)\) with parameters \(\), and will not interact with the environment during the training. OMRL aims to maximize the expected cumulative rewards in the test task:

\[J(_{})=_{M p(M)}[J_{M}(_{})].\] (3)

## 4 Method

### Description of Context Shift Problem

OMRL uses pre-collected offline data from task-dependent behavior policy to maximize the expected cumulative reward. Generally, given multiple different tasks, each behavior policy is the standard RL policy trained on each task. Then each offline dataset is collected from the behavior policy interacting with this environment. For \(N\) MDPs sampled from \(p(P,R)\), the behavior policy of task \(M_{i}\) for

Figure 2: CSRO framework. **Left:** In meta-training, the context encoder \(q_{}\) extracts each transition embedding from \((s,a,r,s^{})\) transition tuple sample from offline datasets, the CLUB variational distribution estimator \(q_{}\) is used to approximate \(p(z|(s,a))\). We use the mean of transition embedding as task representation which conditions both the critic \(Q_{}\) and the actor \(_{}\). **Right:** In test phase, agent uses \(_{Np}\) to explore new tasks.

collecting data is \(^{i}_{}(a|s)\), and the offline data is \(D_{i}=\{(s_{i,j},a_{i,j},r_{i,j},s_{i,j})^{}\}_{j=1}^{N_{size}}\). The distribution of offline data is denoted by

\[p(D_{i})=(s_{0})_{j=0}^{N_{size}}^{i}_{}(a_{j}|s_{j})R(s_{j},a _{j})P(s_{j+1}|s_{j},a_{j}).\] (4)

In the meta-test phase, the data is online collected by the exploration policy.

The different sources of offline datasets used in meta-training and online data used in the meta-test lead to the context shift problem: distribution discrepancy between context from behavior policy and context collected from exploration policy. As shown in Eq 4, the distribution of collected offline datasets is jointly determined by task and behavior policy, which means the context used to train the context encoder contains some characteristics specific to the behavior policy. When the characteristic of behavior policy is correlated with the task, the context encoder is possible to mistakenly embed the characteristic of behavior policy as the task information. Since the characteristics of the exploration policy may be very different from the behavior policy, the task representation derived from the context encoder will deliver incorrect task information and cause performance degradation in the meta-test phase.

For example, as shown in Figure 1 left, the task goal is to reach the position on the semicircle, while the offline datasets only contain the trajectories of behavior policy that go towards the corresponding goal. Thus the direction of the behavior policy is its characteristic which is highly correlated with the task goal. Based on this, the context encoder tends to memorize the direction of the context as the task information. During the meta-test phase, the common exploration policy is conditioned on an initial task representation \(z_{0}\) sampled from a prior \(p(z)\) to collect context. The initial task representation \(z_{0}\) contains a specific direction, so the collected context will move to this specific direction which is different from behavior policy, as shown in Figure 1 middle. Affected by this context, the agent will go along the specific direction instead of going to the task goal, as shown in Figure 1 right.

To address the context shift problem, we propose that CSRO reduce the effect of policy in the context in both the meta-training and meta-test phases. Figure 2 gives an overview of our CSRO framework.

### Max-min Mutual Information Representation Learning

OMRL uses offline datasets to train a context encoder \(q_{}\) to distinguish tasks. We first sample the context \(c_{i}=\{(s_{i,j},a_{i,j},r_{i,j},s^{}_{i,j})\}_{j=1}^{N_{z}}\) from the offline datasets \(D_{i}\) of task \(M_{i}\). And then the context encoder extracts each transition embedding from each transition of the context: \(z_{i,j}=q_{}(z|(s_{i,j},a_{i,j},r_{i,j},s^{}_{i,j}))\). Finally, we use the mean of transition embedding \(z_{i}=_{j}|z_{i,j}|\) as the task representation of task \(M_{i}\). Ideally, the agent should pay more attention to the reward function of the environment where the reward changes, and the dynamic function of the environment where the dynamic changes, and only infer the task from there. However, since the offline dataset is determined by the behavior policy, the task representation will contain the characteristics of the behavior policy. Due to the context shift problem, this context encoder will lead to incorrect task inference in the meta-test phase.

In order to ensure the task representation only focuses on representing the feature of the task, we design the max-min mutual information representation learning mechanism. Since mutual information is a measure of the correlation between two random variables, we can use mutual information to guide the optimization direction of the context encoder. This mechanism consists of two parts, one is to maximize the mutual information between task representation \(z\) and the task, and the other is to minimize the mutual information between \(z\) and the behavior policy \(_{}\).

Since the task representation needs to represent the task information, we need to maximize the mutual information between task representation and the task. We use distance metric learning in  to obtain mutual information approximation with task:

\[L_{maxMI}()=1\{y_{i}=y_{j}\}\|z_{i}-z_{j}\|_{2}^{2}+1\{y_{i} y_{j}\} -z_{j}\|_{2}^{n}+},\] (5)

where \(c_{i}\) is context sampled from task \(M_{i}\), \(y_{i}\) is task label, \(z_{i}=q_{}(z|c_{i})\) is a task representation. Context encoder minimizes the distance of task representations from the same task and maximizes the distance of task representations from different tasks.

Definition 1.In the test task \(M_{i}=(S,A,P_{i},,R_{i}) p(M)\), context \(c\) as a context collected by exploration policy \(_{e}\). The expected return of test task \(M_{i}\) which is evaluated by a learned meta-policy \(_{}(a|s,z)\) is:

\[J_{M_{i}}(_{},_{e})=E_{s_{0}(s_{0}),z q_{ }(|c),a_{t}_{}(|s_{t},z),r_{t} R_{i}(s_{t},a_{t} ),s^{}_{t} P_{i}(|s_{t},a_{t})}[_{t=0}^{H-1}r_{t}].\] (6)

Proposition 1.For task \(M_{i}\) and its corresponding behavior policy \(^{i}_{}\), when exploration policy \(_{e}\) and behavior policy \(^{i}_{}\) are different, if and only if mutual information between task representations and policies \(I(z;_{e})=0\), the expected test return for both is the same \(J_{M_{i}}(_{},_{e})=J_{M_{i}}(_{},^{i}_{})\).

As analyzed in Section 4.1, the context encoder is possible to contain the characteristics of the behavior policy. Proposition 1 states that we also need to minimize the mutual information between task representations and policies \(_{}\) to remove the influence of behavior policy in task representation. However, due to the collection strategy of offline datasets, each task has only one policy to collect data, which makes it difficult to obtain the representation of behavior policy. Consider that each transition tuple \((s,a,r,s^{})\) is jointly determined by task and behavior policy \(p(a,r,s^{}|s)=_{}(a|s)p(s^{}|s,a)r(s,a)\), we use \((s,a)\) tuple to represent behavior policy. Following , we introduce using CLUB to minimize mutual information between transition embedding \(z\) and \((s,a)\). Mutual information upper bound estimation of CLUB is defined as:

\[I_{CLUB}(z,(s,a))=_{i}[ p(z_{i}|(s_{i},a_{i}))- _{j}[ p(z_{j}|(s_{i},a_{i}))]].\] (7)

However the conditional distribution \(p(z|(s,a))\) is unavailable on our tasks, therefore we use a variational distribution \(q_{}(z|(s,a))\) to approximate \(p(z|(s,a))\) by minimizing Log-likelihood:

\[L_{VD}()=-_{M p(M)}_{i}[ q_{ }(z_{i}|(s_{i},a_{i}))].\] (8)

We minimize mutual information between transition embedding \(z\) and \((s,a)\) by minimize mutual information upper bound estimation:

\[L_{minMI}()=_{M p(M)}_{i}[ q_{ }(z_{i}|(s_{i},a_{i}))-_{j}[ q_{}(z_{j}|(s_{i},a_{i}))]],\] (9)

which \(z_{i}\) represents task embedding obtained by \((s_{i},a_{i},r_{i},s^{}_{i})\) through the context encoder. Here, the variational distribution estimator \(q_{}\) and context encoder \(q_{}\) are used for adversarial training. If each transition embedding \(z\) obtained by the context encoder \(q_{}(z|(s,a,r,s^{}))\) contains more \((s,a)\) information, the \(q_{}(z|(s,a))\) has higher accuracy, but mutual information upper bound \(L_{minMI}()\) will be higher. If the transition embedding \(z\) does not contain \((s,a)\) information, the ability to predict \(z_{i}\) through \((s_{i},a_{i})\) is the same as that from other \((s_{j},a_{j})\), \(L_{minMI}()\) is lower. In this adversarial training, the mutual information between behavior policy and task representation can be minimized, the context encoder will pay more attention to the information of tasks.

By combining the above two mutual information, we can get the total loss of context encoder as:

\[L_{encoder}()=L_{maxMI}+ L_{minMI},\] (10)

where \(\) is a hyperparameter to adjust the weight of the two mutual information. Based on the max-min mutual information representation learning, we can reduce the influence of policy in task representation.

### Non-prior Context Collection Strategy

In the online meta-test phase, the agent needs to explore the new task to collect context \(c\) and update the posterior distribution \(q_{}(z|c)\) according to context \(c\). The current exploration strategy of OMRL [27; 4; 26] follows the common exploration strategy of meta-RL . The agent uses the learned meta-policy which is conditioned on initial task representation \(z_{0}\) sampled from the prior distribution \(p(z)\) to explore the new task. After that, the agent updates posterior \(q_{}(z|c)\) by collected context \(c\) and samples new \(z\). Then the agent continues to explore the task to collect context conditioned on \(z\). The steps of sampling \(z\) and collecting context are performed iteratively. Finally, the agent executes task inference according to all collected contexts.

Because there is only one policy for each task to collect data, the context distribution sampled from offline datasets is highly correlated with the behavior policy. Even if we propose the max-minmutual information representation learning which minimizes the mutual information between task representation and behavior policy, we still cannot completely eliminate the influence of policy in task representation. If we use the common exploration strategy to collect context \(c\), the distribution of context \(c\) will correlate with the sampled initial \(z_{0}\). In this way, the posterior \(q_{}(z|c)\) will be affected by \(z_{0}\), leading to incorrect task inference.

On the other hand, there are some methods in current online meta-reinforcement learning that specifically train an exploration policy to collect context [7; 38]. However, in offline settings, there is no way to interact with the environment, and using offline datasets to train the exploration policy, the exploration policy is limited to the vicinity of the datasets, and the conservatism of offline is in conflict with exploration, so by training an exploration policy to solve this problem in offline settings is difficult.

We propose a non-prior context collection strategy to eliminate this problem. Our strategy is not conditioned on sampled initial \(z_{0}\) from prior. The agent first explores the task independently and randomly at each step. Then posterior \(p(z|c)\) will be updated after this exploration. Through this exploration, the agent preliminarily recognizes the task. After that, the agent continuously explores the task according to the posterior \(q_{}(z|c)\) and updates the posterior at each step until the context \(c\) is collected. In this process, the agent gradually recognizes the task more accurately. Finally, the agent evaluates based on the collected context \(c\). By adopting this approach, we mitigate the influence of the sampled initial \(z_{0}\).

### Algorithm Summary

Finally, in order to avoid the problem of overestimation of \(Q\) caused by the distribution shift of the actions in offline learning, we use BRAC  to constrain the similarity between learned policy \(_{}\) and behavior policy \(_{}\) by punishing the distribution shift of learned policy \(_{}\). The optimization objectives under the actor-critic framework become:

\[L_{citric}()=_{(s,a,r,s^{}) D,z q_{}(z|c),a^ {}_{}(|s^{},z)}[(Q_{}(s,a,z)-r- Q_{ }^{target}(s^{},a^{},z))^{2}].\] (11)

\[L_{actor}()=-_{(s,a,r,s^{}) D,z q_{}(z|c),a^ {}_{}(|s,z)}[Q_{}(s,a^{},z)- D (_{}(|s,z),_{}(|s,z))].\] (12)

where \(D\) is the divergence estimate of learned meta-policy \(_{}(|s,z)\) and behavior policy \(_{}(|s,z)\), and we use the KL divergence.

We summarized our meta-training and meta-test method in the pseudo-code of A.

## 5 Experiments

We propose max-min mutual information representation learning and the non-prior context collection strategy to mitigate the context shift between the meta-train and meta-test. To demonstrate the performance of our method, we compare CSRO with the prior offline meta-RL methods on meta-RL tasks in which the reward function or dynamic function is variable. Code is available at https://github.com/MoreanP/CSRO.git.

### Experimental Settings

Environments.We evaluate our method on the Point-Robot and MuJoCo  that are often used as the offline meta-RL benchmarks:(1) **Point-Robot** is a 2D navigation task of a point in continuous space, and the goal is located on a semicircle far from the origin. (2) **Half-Cheetch-Vel** is to control the agent to reach the target velocity of tasks. (3) **Ant-Goal** is a task modified on Ant, which needs to control the agent to reach different goals on the circle. (4) **Humanoid-Dir** is to control the humanoid agent to move in the direction provided by the task. (5) **Hopper-Rand-Params** is to control the velocity of the agent as fast as possible. (6) **Walker-Rand-Params** is also to control the biped agent to move forward as quickly as possible. For (1) and (3), the goal positions of different tasks are different. (2) and (4) are different in target velocity and direction respectively. These four types of environments are all reward functions changing environments. (5) and (6) are dynamic functions changing environments. Robots in different environments have different physical parameters, including mass, inertia, stamping, and friction.

Offline Data Collections.For each environment, we sampled 30 training tasks and 10 test tasks from the task distribution. We use SAC  on each training task to train an agent and save the policy at different training times as behavior policy. We use each policy to roll out 50 trajectories in the corresponding environment as offline datasets.

Compared Methods.To demonstrate the performance of our method, we compare CSRO with the following methods:(1) **OffPearl** is an extension that applies Pearl  to offline RL. The context encoder outputs the distribution of task representation and updates by Q-function. The pre-collected offline datasets are used to replace the interaction with the environment. (2) **FOCAL** uses metric distance learning to train context encoder, reduce the task representation distance of the same task, and increase the task representation distance of different tasks. (3) **CORRO** trains CVAE  or adds noise to produce negative samples, and uses InfoNCE  to train robust context encoder. (4) **BOReL** builds on VariBAD . For a fair comparison, we use a variant of BOReL that does not utilize oracle reward functions, as introduced in the original paper .

For fairness comparison, all methods here use the same offline RL algorithm BRAC  and the same offline datasets. More details of the experimental setting and results are available in the Appendix.

   Env &  &  &  \\   & w/ Np & w/o Np & w/ Np & w/o Np & w/ Np & w/o Np \\  CSRO & **-6.4\(\)**0.8 & -9.2\(\)0.6 & **-48.4\(\)**3.9 & -68.5\(\)13.9 & **344.2\(\)**38.0 & 319.7\(\)38.4 \\ FOCAL & -11.8\(\)1.6 & -14.9\(\)1.1 & -60.9\(\)5.7 & -69.5\(\)9.6 & 253.3\(\)42.7 & 247.5\(\)29.4 \\ OffPearl & -17.0\(\)1.6 & -17.8\(\)1.5 & -133.7\(\)18.9 & -162.8\(\)28.8 & 284.5\(\)30.9 & 262.0\(\)24.5 \\ CORRO & -7.8\(\)1.9 & -10.5\(\)3.0 & -65.6\(\)9.3 & -92.1\(\)23.2 & 312.5\(\)46.6 & 275.2\(\)73.9 \\ BOReL & -21.6\(\)3.9 & -23.2\(\)5.8 & -90.1\(\)28.3 & -56.1\(\)10.7 & 260.6\(\)40.2 & 245.8\(\)32.9 \\   

Table 2: Comparing CSRO with other baselines in the online test phase without and with the non-prior context collection strategy(Np) in Point-Robot, Half-Cheetah-Vel, and Walker-Rand-Params environments.

Figure 3: The average return of the online test phase on unseen test tasks versus other OMRL methods. Point-Robot, Half-Cheetah-Vel, Ant-Goal, and Humanoid-Dir are all reward functions changing environments. Hopper-Rand-Params and Walker-Rand-Params are dynamic functions changing environments. The shaded region shows a standard deviation across 8 seeds.

### Comparison Online Test Results.

To evaluate our performance in the online test phase, we compare CSRO with other methods across all six environments. In the online test phase, each method needs to explore new tasks and collect context. The four baseline methods follow the common exploration strategy, CSRO uses the non-prior context collected strategy that we proposed.

We plot the mean and standard deviation curves of returns across 8 random seeds in Figure 3. In the six environments, CRSO outperforms all the baselines, especially in Point-Robot and Ant-Goal. Experimental results prove the effectiveness of our method.

### Ablation.

Max-min mutual information representation learning and non-prior context collection strategy are the key components of our proposed CSRO. Max-min mutual information representation learning uses metric distance learning and CLUB minimizes mutual information. We compare the methods with those without CLUB minimize mutual information(minMI) and non-prior context collection strategy (Np) components, to show the effect of each component. We conducted experiments on six environments, and the results are shown in Figure 4. In six environments, we notice that if both components are not used, the average return of the online test is the lowest. After adding minMI, the average return is improved to varying degrees. In most environments, the average return is also increased after using Np. We noticed that in the Point-Robot and Ant-Goal, our component effect is more significant. Because in the Point-Robot and Ant-Goal, the behavior policy of different tasks moves in different directions, which makes the influence of context shift more serious.

In the online test phase, We also compare the average return of CSRO with other baselines without and with Np. As shown in Table 2, in the online test without Np, CSRO outperforms other baselines in most environments. This shows that CSRO has learned the context encoder with better generalization. Comparing online tests without Np and with Np, the average return of most methods is improved after using Np, this shows the effectiveness of Np. However, the performance of other methods with Np is lower than CSRO, because others do not fully reduce the influence of behavior policy on context encoder.

Figure 4: Ablation study in six environments, to compare CSRO with methods that without CLUB minimize mutual information (minMI) and non-prior context collection strategy (Np) components.

### Visualization.

In order to analyze the task representation of the context encoder, we use t-SNE  to map the embedding vectors into 2D space and visualize the task representations. For each test task of Half-Cheetah-Vel, we use the non-prior context collection strategy to sample 100 contexts to visualize task embedding. In Figure 5, compared to the other methods, CSRO successfully clusters the task representations of the same task and distinguishes the task representations from different tasks better than other baselines.

## 6 Conclusion

In this paper, we study the context shift problem in OMRL, which arises due to the distribution discrepancy between the context derived from the behavior policy during meta-training and the context obtained from the exploration policy during meta-test. Context shift problem will damage the generalization capability of the meta-policy by leading to incorrect task inference on unseen tasks. We propose that CSRO address the context shift problem with only offline datasets with the key insight of reducing the effect of policy in context during both meta-training and meta-test. In meta-training, we design the max-min mutual information representation learning mechanism which reduces the influence of behavior policy in task representation. In the meta-test, we introduce the non-prior context collection strategy to reduce the effect of the exploration policy. We compared CSRO with previous OMRL methods on a range of challenging domains with reward or dynamic function changes. Experimental results show that CSRO can substantially reduce the context shift and outperform prior methods.