# Conditional Synthesis of 3D Molecules

with Time Correction Sampler

 Hojung Jung\({}^{1}\)1 & Youngrok Park\({}^{1}\)1 & Laura Schmid\({}^{1}\) & Jaehyeong Jo\({}^{1}\)

**Dongkyu Lee\({}^{2}\)** &Bongsang Kim\({}^{2}\)** &Se-Young Yun\({}^{1}\)2 & Jinwoo Shin\({}^{1}\)2

 KAIST AI\({}^{1}\) & LG Electronics\({}^{2}\)

{ghwjd7281, yr-park, yunseyoung, jinwooshin}@kaist.ac.kr

Equal contributionCorresponding authors

###### Abstract

Diffusion models have demonstrated remarkable success in various domains, including molecular generation. However, conditional molecular generation remains a fundamental challenge due to an intrinsic trade-off between targeting specific chemical properties and generating meaningful samples from the data distribution. In this work, we present Time-Aware Conditional Synthesis (TACS), a novel approach to conditional generation on diffusion models. It integrates adaptively controlled plug-and-play "online" guidance into a diffusion model, driving samples toward the desired properties while maintaining validity and stability. A key component of our algorithm is our new type of diffusion sampler, Time Correction Sampler (TCS), which is used to control guidance and ensure that the generated molecules remain on the correct manifold at each reverse step of the diffusion process at the same time. Our proposed method demonstrates significant performance in conditional 3D molecular generation and offers a promising approach towards inverse molecular design, potentially facilitating advancements in drug discovery, materials science, and other related fields.

## 1 Introduction

Discovering molecules with specific target properties is a fundamental challenge in modern chemistry, with significant implications for various domains such as drug discovery and materials science . While diffusion models have shown great success in the generation of real-world molecules , their primary goal is often simply to generate realistic molecules without considering specific properties, which can lead to producing molecules with undesirable chemical properties.

Existing works address this issue by leveraging controllable diffusion frameworks to generate molecules with desired properties . One approach is to use classifier guidance , which utilizes auxiliary trained classifiers to guide the diffusion process . An alternative is to use classifier-free guidance (CFG) , which directly trains the diffusion models on condition-labeled data. While both approaches can generate stable molecules, they struggle to generate truly desirable molecules due to the complex structures and the discrete nature of atomic features .

On the other hand, recent works  have introduced training-free guidance for controllable generation in a plug-and-play manner, which we hereafter refer to as online guidance (OG). This approach can directly estimate the conditional score with unconditional diffusion model. However, our analysis shows that applying online guidance into the molecular generation can result in generating samples with significantly low molecular stability and validity due to the stepwise enforcement of specific conditions without considering the original distribution at each timestep.

To address this gap, we propose _Time-Aware Conditional Synthesis_ (TACS), a novel framework for generating 3D molecules. TACS utilizes the online guidance in tandem with a novel diffusion sampling technique that we call _Time Correction Sampler_ (TCS). TCS explicitly considers the possibility that online guidance can steer the generated sample away from the desired data manifold at each step of the diffusion model's denoising process, resulting in an 'effective timestep' that does not match the correct timestep during the generation. TCS then corrects this mismatch between the timesteps, thereby effectively preventing samples from deviating from the target distribution while ensuring they satisfy the desired conditions. By combining online guidance with TCS and integrating them into a diffusion model, TACS allows generated samples to strike a balance between approaching the target property and remaining faithful to the target distribution throughout the denoising process.

To the best of our knowledge, TACS is the first diffusion framework that simultaneously addresses inverse molecular design and data consistency, two critical objectives that often conflict.

We summarize our main contributions as follows:

* We propose Time-Aware Conditional Synthesis (TACS), a new framework for diffusion model that utilizes adaptively corrected online guidance during the generation.
* We introduce Time Correction Sampler (TCS), a novel diffusion sampling technique that ensures the generated samples remain faithful to the data distribution. It includes a time predictor, an equivariant graph neural network that accurately estimates the correct data manifold during inference by predicting the time information of the generation process.
* Through extensive experiments on a 3D molecule dataset, we demonstrate that TACS outperforms previous state-of-the-art methods by producing samples that closely match the desired quantum chemical properties while maintaining data consistency.

## 2 Related Works

Diffusion modelsDiffusion models have achieved great success in a variety of domains, including generation of images [12; 46], audio generation , videos [21; 36; 42], and point clouds [8; 37]. A particular highlight in the success of diffusion models is their potential to generate molecules that

Figure 1: **(a) Overview of Time-Aware Conditional Synthesis (TACS). TACS helps generate high-quality samples that match target condition while following basic properties of the molecules. At each timestep \(t\), online guidance is applied to push \(x_{t}\) towards the desired condition. Time Predictor finds the desired timestep \(t_{p}\) for \(x_{t}\) after applying the guidance. Using predicted timestep \(t_{p}\), Tweedieâ€™s formula is used to predict the clean molecule \(_{0}^{t}\). Finally, forward process \(q(x_{t-1}|x_{0})\) is applied to proceed to the next denoising step of \(t-1\). (b) Motivation for TACS. Applying online guidance (\(\), purple) can shift the generated samples away from the correct data manifold corresponding to the current timestep. This undesirable deviation (red) can be avoided by using time correction to first measure the deviated timestep \(t^{}\), then adjusting the guidance to get corrected guidance vector (\(}\), green), which keeps the generated samples stay on the correct data manifold.**

can form the basis of new, previously unseen, medical compounds. Multiple approaches have been explored to achieve this. For instance, graph diffusion such as GeoDiff , GDSS , and DiGress  can generate graph structures that correspond to molecular candidates. Additionally, some approaches incorporate chemical knowledge tailored to specific applications, such as RFdiffusion for protein design , a method based on the RoseTTAFold structure prediction network . Other previous literature considers different domain-specific applications, such as diffusion for molecular docking , or molecular conformer generation . Most relevant to our work, diffusion models have also shown promising results in synthesizing 3D molecules [23; 58; 27], generating stable and valid 3D structures. Recently, some of the works further advance 3D molecule generation techniques by making more reliable diffusion process  or fast generation  of 3D molecules.

Conditional molecular generationDeep generative models [38; 23; 58] have made considerable progress in synthesizing 3D molecules with specific properties. Specifically, conditional diffusion models [23; 5; 58; 18] have achieved noticeable improvements in synthesizing realistic molecules. EDM  trains separate conditional diffusion models for each type of chemical condition, while EEGSDE  trains an additional energy-based model to provide conditional guidance during the inference. GeoLDM  utilizes a latent diffusion model  to run the diffusion process in the latent space. MuDM  applies online guidance to simultaneously target multiple properties. However, existing methods either produce unstable and invalid molecular structures or are unable to accurately meet the target conditions. To overcome these limitations, we propose TACS, a novel framework which ensures the generative process remains faithful to the learned marginal distributions in each timestep while effectively guiding the samples to meet the desired quantum chemical properties.

Adaptive inference scheduleRecent efforts have explored adaptive inference schedules to enhance the fidelity of samples generated by diffusion models with timestep information.  proposes adjusting the noise schedule during reverse diffusion, while  optimizes input timesteps for a more accurate reverse trajectory. TS-DPM  mitigates exposure bias by adaptively shifting timesteps during inference to align with the training variance. Similar to our time preidction mechanism, several works leverage auxilary network to classify time information with different motivation and purpose. DMCMC  introduce noise classifier for accelerating inference during earlier diffusion steps and MoreRed  leverages a timestep prediction network to initialize or adaptively guide the reverse diffusion process using the adjusted timesteps for molecular relaxation. In contrast, our TACS is specifically designed for conditional generation, predicts timesteps at each denoising step to refine clean sample estimates via Tweedie's formula, ensuring alignment with the data manifold and adherence to target conditions. Further comparison is provided in Appendix E.

## 3 Preliminaries

Diffusion modelsDiffusion models [50; 20; 52] are a type of generative model that learn to reverse a multi-step forward noising process applied to the given data. In the forward process, noise is gradually injected into the ground truth data, \(_{0} q_{0}\), until it becomes perturbed into random noise, \(_{T}(0,)\), where \(T\) is the total number of diffusion steps. We follow the Variance Preserving stochastic differential equation (VP-SDE) [52; 20] where the forward process is modeled by the following SDE:

\[_{t}=-(t)_{t}\, t+_{t},\] (1)

where \((t)\) is a pre-defined noise schedule and \(_{t}\) is a standard Wiener process. Then, the reverse of the forward process in Eq. (1) is also a diffusion process that is modeled by the following SDE :

\[_{t}=[-(t)_{ t}-(t)_{_{t}} p_{t}(_{t})]t+ }_{t},\] (2)

where \(p_{t}\) is the probability density of \(_{t}\) and \(}_{t}\) is a standard Wiener process with backward time flows. The reverse process in Eq. (2) can be used as a generative model when the score function \(_{} p_{t}()\) is known. To estimate the score function from given data, a neural network \(_{}\) is trained to minimize the following objective :

\[()=_{t,_{0}} (t)\|_{}(_{t},t)-_{ _{t}} p_{t}(_{t})\|_{2}^{2},\] (3)

where \(t\!\!U[0,T]\), \(_{0}\) is sampled from the data distribution, and \(:[0,T]^{+}\) is a positive weight function.

Online guidanceRecent works [17; 9; 51] leverage a conditional diffusion process where the conditional probability \(p_{t}(_{t}|)\) is modeled without training on labeled pairs \((_{t},)\). To understand this approach, observe that for the conditional generation, the reverse SDE of Eq. (2) can be rewritten as follows:

\[_{t}=[-(t)_{t}-(t) _{_{t}} p_{t}(_{t}|)]t +}_{t}.\] (4)

From Bayes' rule, the conditional score \(_{} p_{t}(_{t}|)\) can be decomposed as follows:

\[_{_{t}} p_{t}(_{t}|)=_{_{t}} p_{t}(_{t})+_{_{t}} p_{t}(| _{t}).\] (5)

While unconditional score \(_{_{t}} p_{t}(_{t})\) can be approximated by the unconditional diffusion model \(_{}\) from Eq. (3), online guidance can estimate conditional score part \(_{_{t}} p(|_{t})\) without any training. Notably, DPS  approximates conditional score as follows:

\[_{_{t}} p(|_{t})_{ _{t}} p(|}_{0}),\] (6)

where \(}_{0}\) is a point estimation of the final clean data using Tweedie's formula :

\[}_{0}=_{t}+(1-_{t})_{ _{t}} p(_{t})}{_{t}}},\ \ _{t}=e^{-_{0}^{t}(s)ds}.\] (7)

While DPS uses a point estimate of \(_{0}\), Loss Guided Diffusion (LGD)  uses Bayesian assumption where \(_{0}\) is a Monte Carlo estimation of \(q(_{0}|_{t})\), which is a normal distribution with mean \(}_{0}\) and variance \(_{t}^{2}\) which is a hyperparameter.

For a given property estimator \(\) satisfying \(=(_{0})\), Eq. (6) can be written as follows:

\[_{_{t}}_{_{0} p(_{0}| _{t})}p(|}_{0})_{_ {t}}(_{i=1}^{m}(-(( _{0}^{i}),))(_{t},t),\] (8)

where \(\) is a differentiable loss function and \(_{0}^{i}\) are independent variables sampled from \(q(_{0}|_{t})\). Using this approximation, we can replace \(_{_{t}} p(|_{t})\) in Eq. (5) and conditional generation process now becomes:

\[_{t}=[-(t)_{t}-(t) (_{_{t}} p_{t}(_{t})+z(_{t},t))]t+}_{ t},\] (9)

where \(z\) is the hyperparameter for controlling online guidance strength. In this work, we use \(L_{2}\) loss for the differentiable loss \(\) and set \(m=1\) following Song et al. .

3D representations of moleculesIn our framework, we follow EDM  in modeling the distribution of atomic coordinates \(\) within a linear subspace \(\), where the center of mass is constrained to zero. This allows for translation-invariant modeling of molecular geometries. Further details of the zero-center-of-mass subspace is provided in Appendix A.3.

## 4 Time-Aware Conditional Synthesis

In this section, we propose our framework, Time-Aware Conditional Synthesis (TACS). Section 4.1 presents the key component of TACS: the Time Correction Sampler, a novel sampling technique that leverages corrected time information during the generation process. Section 4.2 introduces the overall framework of TACS, which accurately integrates online guidance into the diffusion process using our sampling technique to generate stable and valid molecules that meet the target conditions.

### Time Correction Sampler

Diffusion models are known to have an inherent bias, referred to as exposure bias, where the marginal distributions of the forward process do not match the learned marginal distributions of the backward process . To mitigate exposure bias in the diffusion models, we propose the Time Correction Sampler (TCS), which consists of two parts: time prediction and time correction.

Time PredictorDuring conditional generation process of diffusion model, a sample follows the reverse SDE as in Eq. (4). However, due to error accumulation during the generation process [33; 6], a sample at timestep \(t\) of the reverse process of diffusion may not accurately reflect the true marginal distribution at timestep \(t\). This discrepancy between forward and reverse process can especially increased when applying online guidance for every denoising steps and consequently lead to the generation of molecules with low stability and validity. We aim to mitigate this issue by correcting the time information based on the sample's current position.

To achieve this, we train a neural network, a time predictor, to estimate the proper timestep of a given noised data. Specifically, given a random data point \(\) with unknown timestep, time predictor models how likely \( p_{t}\) for each timestep in \([0,T]\). For training, we parameterize a time predictor by equivariant graph neural network (EGNN) \(\). Then, cross-entropy loss between the one hot embedding of timestep vector and the logit vector for the model output is used as follows:

\[_{}()=-_{t,_{0}} [(}_{}(_{t})_{t} )],\] (10)

where timestep \(t\) is sampled from the uniform distribution \(U[0,T]\), \(_{0}\) is chosen from the data distribution, \(_{t}\) is constructed from Eq. (1), and \(}_{}(_{t})_{t}\) is the \(t\)-th component of the model output \(}_{}\) for a given input \(_{t}\). We empirically evaluate the performance of the time predictor on the QM9 train and test datasets. Forward noise, corresponding to each true timestep, is added to the data, and the time predictor estimates the true timestep, with accuracy measured accordingly. As shown in 3b, the predictor struggles in the white noise region, but achieves near-perfect accuracy after timestep 400.

Time correctionTCS works by first modifying Tweedie's formula (Eq. 7) using the estimated timestep from time predictor to utilize the information of the proper timestep estimated by time predictor during the denoising diffusion process.

Specifically, for a sample \(}_{t}\) at time \(t\) during the reverse diffusion process, we use the corrected timestep \(t_{}\) predicted by time predictor, instead of the current timestep \(t\), to estimate the final sample \(}_{0}\) as follows:

\[(}_{t},t_{}):=f( }_{t},t_{})=}_{t}+(1-_{t_{ {pred}}})s_{}(}_{t},t_{})}{ _{t_{}}}}.\] (11)

From the better prediction of the final sample \(}_{0}\), we perturb it back to the next timestep \(t-1\) using the forward process using Eq. (1).

Intuitively, TCS encourages the generated samples to adhere more closely to the proper data manifolds at each denoising step. The iterative correction of the time through the generative process ensures the final sample lie on the correct data distribution. Consequently, for 3D molecular generation, TCS helps synthesizing molecules with higher molecular stability and validity, both of which are crucial for generating realistic and useful molecules.

### Unified guidance with time correction

Finally, we present TACS in Algorithm 1, which is a novel diffusion sampler for conditional generation that integrates TCS with online guidance. For each timestep of the reverse diffusion process (Eq. 4), we apply online guidance (Eq. 8) to guide the process toward satisfying the target condition. Subsequently, TCS is applied to correct the deviation from the proper marginal distribution induced by online guidance. This ensures the samples follow the correct marginal distribution during the generative process, as shown in Fig. 1. In Section 5, we experimentally validate that TACS is capable of generating valid and stable molecules satisfying the target condition.

Time clippingDuring the generation, we empirically observe that the predicted timestep \(t_{}\) often deviates significantly from the current time step \(t\). Naively applying this information to TCS can be problematic as the dramatic changes in timestep may skip crucial steps, resulting in unstable or invalid molecules. To prevent large deviation of \(t_{}\), we set a time window so that \(t_{}\) remains in the time interval \([t-,t+]\), where \(\) is a hyperparameter for the window size.

## 5 Experiments

In this section, we present comprehensive experiments to evaluate the performance of TACS and demonstrate its effectiveness in generating 3D molecular structures with specific properties while maintaining stability and validity. In Section 5.1, we present synthetic experiment with \(H_{3}^{+}\) molecules, where the ground state energies are computed using the variational quantum eigensolver (VQE). In Section 5.2, we assess our method using QM9, a standard dataset in quantum chemistry that includes molecular properties and atom coordinates. We compare our approach against several state-of-the-art baselines and provide a detailed analysis of the results.

### Synthetic experiment with \(H_{3}^{+}\)

Quantum online guidanceWe present quantum online guidance as a modified version of online guidance where quantum machine learning algorithm for the property estimation of generating molecules. Specifically, we use VQE  when calculating the ground state energy of generated molecules. Contrary to prior works [23; 5], which train auxiliary classifiers to estimate each condition, this quantum computational chemistry-based approach can leverage exact calculation of the condition for a given estimate. This, in turn, is expected to generate molecules with accurate target ground state energies. A detailed explanation of this approach is provided in Appendix A.2.

SetupWe first construct synthetic \(H_{3}^{+}\) as follows. For each molecule, a hydrogen atom is placed uniformly at random within the 3-D unit sphere. We then augment our sample by rotating each molecule randomly to satisfy the equivariance property . Then the ground state energy of each molecule is measured with VQE in order to provide conditional labels. Finally, we train unconditional

Figure 2: Synthetic experiment on \(H_{3}^{+}\) dataset. TACS is robust in generating samples that (a) match the desired condition and (b) stick to the original data distribution.

diffusion model and CFG-based conditional diffusion model with the constructed data. For evaluation, we measure the ground state energy and calculate MAE (Mean Absolute Error) with the target energy. Also, we measure the average L2 distance between position of each atom and its projection to the unit sphere.

ResultsThe results in Figure 2 indicate that while online guidance correctly guides the samples to the target condition, it can lead to the samples deviated from the original data distribution. In contrast, molecules sampled from TACS can satisfy both low MAE and low L2 distance. Further details and additional discussions are provided in Appendix B.1.

### Conditional generation for target quantum chemical properties

DatasetWe evaluate our method on QM9 dataset , which contains about 134k molecules with up to 9 heavy atoms of (C, N, O, F), each labeled with 12 quantum chemical properties. Following previous works [1; 23], we test on 6 types of quantum chemical properties and split the dataset into 100k/18k/13k molecules for training, validation, and test. The training set is further divided into two disjoint subsets of 50k molecules each: \(D_{a}\) for property predictor training and \(D_{b}\) for generative model training. Further details are provided in Appendix B.2.

EvaluationTo evaluate how generate samples meet the desired target condition, a property prediction model \(_{p}\) is trained on \(D_{a}\). Then, MAE for \(K\) number of samples is calculated as \(_{i=1}^{K}|_{p}(^{(i)})-c^{(i)}|\), where \(^{(i)}\) represents \(i\)-th generated molecule and \(c^{(i)}\) is corresponding target quantum chemical properties. Molecular stability (MS) and validity (Valid)  are used to measure how generated samples satisfy basic chemical properties. Details of the evaluation metrics are provided in Appendix B.2.

BaselinesWe use Equivariant Diffusion Models (EDM)  and Equivariant Energy Guided SDE (EEGSDE)  for the baselines. Following , we put additional baselines including "Naive Upper-Bound" (randomly shuffled property labels), "#Atoms" (properties predicted by atom count), and "L-Bound" (lower bound on MAE using a separate prediction model).

ResultsTable 1 shows the result of conditional generation of TACS and TCS with baselines. We generate \(K\)=\(10^{4}\) samples for the evaluation in each experiment and the average values and standard deviations are reported across 5 runs. For all of the quantum chemical properties, TACS achieves lower MAE while maintaining comparable or higher molecular stability (MS) and validity compared to other baselines. Notably, when comparing with the baseline methods that maintains the MS above 80%, the MAE of TACS is significantly lower than the baselines. The result demonstrates the

    & \)\(\)} &  & ^{}\))} \\  Method & MAE & MS (\%) & Valid (\%) & MAE & MS (\%) & Valid (\%) & MAE & MS (\%) & Valid (\%) \\  U-bound & 6.879\(\)0.015 & - & - & 1.613\(\)0.003 & - & 8.98\(\)0.020 & - & - & - \\ EDM & 1.072\(\)0.005 & 81.04\(\)0.6 & 90.40\(\)0.2 & 1.118\(\)0.006 & 80.84\(\)0.2 & 91.2\(\)0.3 & 2.77\(\)0.050 & 79.6\(\)0.3 & 89.9\(\)0.2 \\ EEGSDE & 1.044\(\)0.023 & 81.0\(\)0.5 & 90.5\(\)0.2 & 0.854\(\)0.002 & 79.4\(\)0.1 & 90.6\(\)0.5 & 2.62\(\)0.090 & 79.8\(\)0.3 & 89.2\(\)0.3 \\ OG & **0.184\(\)**0.004 & 30.2\(\)0.4 & 51.9\(\)0.5 & **2.654\(\)**8.878 & 6.8\(\)0.5 & 27.7\(\)0.3 & **0.85\(\)**0.019 & 21.2\(\)0.2 & 48.7\(\)0.3 \\ TCS(ours) & 0.904\(\)0.011 & **90.30\(\)**0.5 & **94.9\(\)**0.1 & 0.971\(\)**0.050 & **92.7\(\)**4.03 & **96.6\(\)**0.2 & 1.85\(\)0.006 & **87.5\(\)**0.2 & 98.9\(\)0.1 \\ TACS(ours) & **0.689\(\)**0.008 & 83.6\(\)0.2 & 92.4\(\)0.1 & **0.387\(\)**0.006 & 83.3\(\)0.3 & 91.3\(\)0.3 & **1.44\(\)**0.007 & 86.0\(\)0.1 & 92.5\(\)0.1 \\ L-bound & 0.040 & - & - & 0.043 & - & 0.090 & - & - \\    &  & }\) (meV)} & }\) (meV)} \\  Method & MAE & MS (\%) & Valid (\%) & MAE & MS (\%) & Valid (\%) & MAE & MS (\%) & Valid (\%) \\  U-bound & 1464\(\)4 & - & - & 645\(\)41 & - & - & 1457\(\)5 & - & - \\ EDM & 673\(\)7 & 81.8\(\)0.5 & 90.9\(\)0.3 & 372\(\)1 & 79.6\(\)0.1 & 91.6\(\)0.2 & 602\(\)4 & 81.0\(\)0.2 & 91.4\(\)0.5 \\ EEGSDE & 539\(\)5 & 80.1\(\)0.4 & 90.5\(\)0.3 & 300\(\)5 & 78.7\(\)0.7 & 91.2\(\)0.2 & 494\(\)9 & 81.4\(\)0.6 & 91.1\(\)0.2 \\ OG & **95.2**\(\)4 & 31.3\(\)0.7 & 61.9\(\)3.4 & **233\(\)**8 & 11.5\(\)0.4 & 40.8\(\)2.6 & **170\(\)**1 & 21.1\(\)0.5 & 42.3\(\)0.9 \\ TCS(ours) & 594\(\)4 & **91.9\(\)**0.4 & **96.0\(\)**0.2 & 338\(\)5 & **92.7\(\)**0.2 & **96.6\(\)**0.2 & 493\(\)9 & **91.7\(\)**3.9 & **96.2\(\)**0.4 \\ TACS(ours) & **332\(\)**3 & 88.8\(\)0.6 & 93.9\(\)0.3 & **168\(\)**2 & 87.3\(\)0.7 & 93.0\(\)0.2 & **289\(\)**4 & 82.7\(\)0.7 & 91.3\(\)0.2 \\ L-bound & 65 & - & - & 39 & - & - & 36 & - & - \\   

Table 1: Conditional generation with target quantum properties on QM9. TACS generate samples with lowest MAE while maintaining similar level of stability as other baselines. TCS can generate molecules with high stability and validity. \(*\) notation is marked for the values for the best MAE within methods with molecule stability above 80%.

effectiveness of TACS in balancing the objectives of generating molecules with desired properties and ensuring their structural validity.

TCS achieves high validity and atom stability and molecular stability, surpassing the unconditional generation performance of the baselines, but with a higher MAE compared to TACS. This highlights the importance of online guidance for precise property targeting. However, applying only online guidance yields samples with low MAE but suffers from reduced validity and stability, occasionally failing to generate valid molecules due to numerical instability. This shows the ability of TACS which places the samples on the correct data manifold at each denoising step, even if they deviate from the true time-manifold due to the online guidance. Finally, we put the results of different methods with 9 different runs for each method and plot the MAE and MS in Figure 2(a). The result clearly shows that TACS and TCS reaches closer to the Pareto front of satisfying molecular stability and the target condition together.

### Target structure generation

We conduct experiments on target structure generation with QM9 as in . For evaluation, we report Tanimoto similarity score  which captures similarity of molecular structures by molecular fingerprint and molecular stability to check whether basic properties of molecules are satisfied during the conditional generation process. We put additional details of the experiment in Appendix B.3.2.

ResultsTable 2 shows that TACS significantly outperforms baseline methods both in Tanimoto similarity and molecular stability. Interestingly, performance of TACS is robust in the online guidance strength \(z\). This demonstrates TACS's ability to generalize on different tasks.

    &  \\  Method & Similarity \(\) & MS (\%) \\  cG-SchNet & 0.499\(\)0.002 & - \\ Conditional EDM & 0.671\(\)0.004 & - \\ TCS (Ours) & **0.792\(\)0.077** & 90.42 \\ TACS (Ours) (\(z=0.01\)) & 0.694\(\)0.001 & **90.45** \\ TACS (Ours) (\(z=0.05\)) & 0.695\(\)0.003 & 90.02 \\ TACS (Ours) (\(z=0.1\)) & 0.713\(\)0.087 & 90.28 \\ EEGSDE (\(s=0.1\)) & 0.547\(\)0.002 & 74.07 \\ EEGSDE (\(s=0.5\)) & 0.600\(\)0.002 & 74.67 \\ EEGSDE (\(s=1.0\)) & 0.540\(\)0.029 & 90.44 \\   

Table 2: Quantitative results showing similarity and stability of generated molecules compared to target structures.

    &  \\  Method & AS (\%) \(\) & Valid (\%) \\  Data & 86.5 & 99.9 \\  ENF & - & - \\ G-Schnet & - & - \\ GDM & 75.0 & 90.8 \\ GDM-AUG & 77.7 & 91.8 \\ EDM & 81.3 & 92.6 \\ EDM-Bridge & 82.4 & 92.8 \\  TCS(Ours) & **89.6** & **97.6** \\   

Table 3: Unconditional generation using Geom-Drug dataset.

Figure 3: (a) Comparative analysis of molecule stability and MAE across five distinct methods, highlighting the enhanced stability of our approach at comparable MAE levels. (b) Performance of the time predictor for train and test set on QM9.

### Unconditional generation on Geom-Drug dataset

To verify the scalability of time correction sampler, we use Geom-Drug  as our dataset. Geom-Drug consists of much larger and complicate molecules compared to the QM9. For fair comparisons, we follow [23; 5] to split the dataset for training, validation and test set include 554k, 70k, and 70k samples respectively. We test the performance of TCS on unconditional generation of 3D molecules when using Geom-Drug. For evaluation, we use atom stability (AS) and validity of generated samples. The result in Table 3 shows that samples generated by TCS satisfy the highest atom stability and the validity with high margin compared to the baselines. Details of the experiments are in Appendix B.3.1.

### Ablation Studies

Time prediction functionWe investigate how the the design of time prediction function affects the performance of TACS. Specifically, for line 6 in Alg. 1, rather than using argmax function to obtain corrected timestep \(t_{}\), we choose to use expectation value by \(t_{}=[(x)]\). Table 4 shows the comparison between two methods in six different types of quantum chemical properties. Expectation based time prediction results in molecules with higher MAE and higher molecular stability.

Online guidance strength \(z\)To analyze the effect of online guidance strength \(z\) in Eq. (9), we measure MAE, molecular stability, and validity of samples generated by TACS for different \(z\) values. Table 5 shows the result with target condition on \(_{}\) values. One can observe while trade-off occurs for different \(z\) values, performance of TACS is robust in varying \(z\). Interestingly, our experiment shows that there exists an optimal value of \(z\) which generates samples with the lowest MAE that is even comparable to applying online guidance without time correction (OG). As expected, using \(z=0\) (TCS) generates molecules with the highest MS and validity but with the highest MAE.

Time window length \(\)We measure how the performance of TACS varies with time window length \(\). Table 6 shows the MAE, molecular stability values for different window sizes when the target property is \(\). The result shows that the performance of TACS is robust when using moderate window size but decreases when window size becomes larger than certain point. We set \(=10\) for other experiments.

In Appendix C, we provide the results of further ablation studies including the effect of mc sampling and effective diffusion steps for TACS. Overall, the results show that our method is robust in the choice of hyperparameters and generalizable to different datasets and tasks.

## 6 Discussion

Exploiting quantum chemistryIn Section 5.1, we demonstrate that quantum computing-based guidance can serve as an accurate property predictor for the online guidance. Currently, in the absence of a non-noisy quantum computer, scaling up this exact guidance to the QM9 dataset is close to impossible due to compounding noise [43; 10]. However, future fault-tolerant quantum technology is

   Window size (\(\)) & MAE & MS (\%) \\ 
2 & 1.481 & **87.25** \\
4 & 1.460 & 86.52 \\
6 & 1.460 & 85.73 \\
8 & 1.448 & 86.84 \\
10 & **1.441** & 86.08 \\
12 & 1.442 & 85.17 \\
14 & 1.459 & 82.76 \\
16 & 1.530 & 79.10 \\   

Table 6: Results of TACS on target property \(\) when varying the time window size.

    & ()\)} &  & ^{3}\))} &  & }\) (meV)} & }\) (meV)} \\  Method & MAE & MS (\%) & MAE & MS (\%) & MAE & MS (\%) & MAE & MS (\%) & MAE & MS (\%) \\  Argmax & 0.659 & 83.3 & 0.387 & 83.3 & 1.44 & 86.0 & 332 & 88.8 & 168 & 87.3 & 289 & 82.7 \\ Expectation & 0.703 & 84.6 & 0.451 & 90.2 & 1.56 & 87.3 & 351 & 90.7 & 182 & 89.8 & 334 & 90.1 \\   

Table 4: Comparison between performance of TACS when using argmax function and expectation for correcting timesteps using time predictor.

   Method & MAE & MS (\%) & Valid (\%) \\  TCS (\(z=0\)) & 493 & **91.7** & **96.2** \\ OG & **170** & 21.1 & 42.3 \\ \(z=1.5\) & 311 & 80.3 & 90.7 \\ \(z=1.0\) & 236 & 74.9 & 86.3 \\ \(z=0.5\) & 288 & 82.7 & 91.3 \\   

Table 5: Ablation study on the OG strength \(z\) with target property \(_{}\).

expected to provide quantum advantage in calculating chemical properties. This can be incorporated into our algorithm when using online guidance and therefore, further improvements of our TACS are on the horizon.

Connection to other fieldsRecent works point out the exposure bias exists for diffusion models , where there is a mismatch between forward and reverse process. Our experiments in 5.2 indicate that Time Correction Sampler can provide a solution to the exposure bias problem during the sampling process in diffusion models. Moreover, since time predictor can gauge this mismatch during inference, one might leverage this information for future works.

Another direction is applying our algorithm to matching  frameworks. Contrary to diffusion models, these matching models can start with arbitrary distributions and directly learn vector fields. We expect time predictor to be also effective with these types of algorithms. Investigating the connection between our algorithm and matching models will be an interesting future direction.

## 7 Conclusion

In this work, we introduce Time-Aware Conditional Synthesis (TACS), a novel approach for conditional 3D molecular generation using diffusion models. Our algorithm leverages a Time Correction Sampler (TCS) in combination with online guidance to ensure that generated samples remain on the correct data manifold during the reverse diffusion process. Our experimental results clearly demonstrate the advantage of our algorithm, as it can generate molecules that are close to the target conditions while also being stable and valid. This can be seen as a significant step towards precise and reliable molecular generation.

Despite multiple advantages, several open questions remain. For example, how can we more efficiently use the Time Correction Sampler, or more generally, whether this method improves performance in other domains such as in image generation. We expect that our work will open various opportunities across different domains, such as quantum chemistry and diffusion models.

LimitationAlthough we demonstrate the effectiveness of our algorithm on multiple datasets and tasks, we use a trained neural network to estimate chemical properties of each molecule for main experiments. Using exact computational chemistry-based methods might improve our algorithm.

Societal impactsWe believe that our framework can assist in drug discovery, which requires synthesizing stable and valid molecules that satisfy target conditions. However, our work could unfortunately be misused to generate toxic or harmful substances.