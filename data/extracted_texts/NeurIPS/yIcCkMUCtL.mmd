# Towards a Unified Analysis of Kernel-based Methods Under Covariate Shift

Xingdong Feng\({}^{1}\), Xin He\({}^{1}\), Caixing Wang\({}^{1}\), Chao Wang\({}^{1}\), Jingnan Zhang\({}^{2}\)

\({}^{1}\)School of Statistics and Management, Shanghai University of Finance and Economics

\({}^{2}\)International Institute of Finance, School of Management,

University of Science and Technology of China

{feng.xingdong, he.xin17}@mail.shufe.edu.cn

{wang.caixing, wang.chao}@stu.shufe.edu.cn

jnzhang@ustc.edu.cn

Caixing Wang is the corresponding author and all the authors contributed equally to this paper and their names are listed in alphabetical ordering.

###### Abstract

Covariate shift occurs prevalently in practice, where the input distributions of the source and target data are substantially different. Despite its practical importance in various learning problems, most of the existing methods only focus on some specific learning tasks and are not well validated theoretically and numerically. To tackle this problem, we propose a unified analysis of general nonparametric methods in a reproducing kernel Hilbert space (RKHS) under covariate shift. Our theoretical results are established for a general loss belonging to a rich loss function family, which includes many commonly used methods as special cases, such as mean regression, quantile regression, likelihood-based classification, and margin-based classification. Two types of covariate shift problems are the focus of this paper and the sharp convergence rates are established for a general loss function to provide a unified theoretical analysis, which concurs with the optimal results in literature where the squared loss is used. Extensive numerical studies on synthetic and real examples confirm our theoretical findings and further illustrate the effectiveness of our proposed method.

## 1 Introduction

Covariate shift is a phenomenon that commonly occurs in machine learning, where the distribution of input features (covariates) changes between the source (or training) and target (or test) data, while the conditional distribution of output values given covariates remains unchanged (Shimodaira, 2000; Pan & Yang, 2010). Such a phenomenon is illustrated in Figure 1 where the learned predictive function from the source data may significantly differ from the true function. Thus, the prediction performance can be largely degraded since the predictive function has not been trained on data that accurately represents the target environment. Covariate shift can arise in a variety of domains, including medicine and healthcare (Wei et al., 2015; Hajiramezanali et al., 2018), remote sensing (Tuia et al., 2011), and natural language and speech processing (Yamada et al., 2009; Fei & Liu, 2015). Various factors contribute to covariate shift, such as data sampling bias (e.g., patient demographics in healthcare applications), changes in the studied population (e.g., vocabulary evolution in natural language processing), or measurement and observational errors (e.g., sensor noise or calibration errors in the sensor domain). Compared to the well-studied supervised learning without such a distribution mismatch (Gyorfi et al., 2002), there still exists some gap in both theoretically and numerically understanding the influence of the covariate shift under various kernel-based learning problems.

This paper provides a unified analysis of the kernel-based methods under covariate shift. Moreover, a general loss function is considered, which is allowed to belong to a rich loss function family and thus includes many commonly used methods as special cases, such as mean regression, quantile regression, likelihood-based classification, and margin-based classification. This paper considers two types of covariate shift problems in which the importance ratio is assumed to be uniformly bounded or to have a bounded second moment. A unified theoretical analysis has been provided that the sharp convergence rates are established for a general loss function under two evaluation metrics, which concurs with the optimal results in Ma et al. (2023) where the squared loss is used. Our theoretical findings are also validated by a variety of synthetic and real-life examples.

**Our contributions.** The contributions of this paper are multi-fold. We propose a unified analysis of the kernel-based methods under covariate shift, which provides an insightful understanding of the influences of covariate shift on the kernel-based methods both theoretically and numerically. By utilizing empirical process in learning theory, we investigate the theoretical behaviors of several estimators under various conditions, with particular emphasis on different importance ratio cases between the source and target distributions. Specifically, we show that the unweighted estimator achieves the optimal learning rates in terms of both \(^{2}\)-error and the excess risk with respect to the target distribution under the uniformly bounded case. Yet, the unweighted estimator is sub-optimal under the bounded second moment case. Then, we construct a weighted estimator by using an appropriate truncated ratio, which again attains a sharp convergence rate. Unlike kernel ridge regression (KRR), the estimator for the general loss does not have an explicit form, making many classical analysis techniques inapplicable (Lian, 2022) and in our technical proofs, the theoretical derivation is much more involved due to the considered general loss function. Numerous experiments on synthetic data and multi-source real data with various loss functions confirm our theoretical findings. To some extent, this paper provides a comprehensive study of the numerical performance of the kernel-based methods under various scenarios with covariate shift.

**Related work.** Some most related works including covariate shift adaptation and importance ratio estimation are presented below.

**Covariate shift adaptation.** Shimodaira (2000) investigates the impact of covariate shift in parametric regression with maximum likelihood estimation and proposes an importance-weighting (IW) estimator, which has a significant improvement when the misspecification does exist. Sugiyama and Muller (2005b) further extend this work by analyzing an unbiased estimator for \(^{2}\)-error. These fundamental works also motivate a variety of follow-up studies under the parametric setting Sugiyama and Storkey (2006); Yamazaki et al. (2007); Wen et al. (2014); Lei et al. (2021). Beyond the parametric setting, Kpottofe and Martinet (2021) consider the nonparametric classification problem and provide a new minimax result that concisely captures the relative benefits of source and target labeled data under covariate shift. Focusing on the Holder continuous regression function class, Pathak et al. (2022) propose a new measure of distribution mismatch between the source and target distributions. Ma et al. (2023) and Gogolashvili et al. (2023) establish the optimal learning rates for KRR over RKHS. Recently, covariate shift in overparameterized models, such as high-dimensional models and neural networks, has also drawn tremendous attention from relevant researchers (Hendrycks and Dietterich, 2019; Byrd and Lipton, 2019; Hendrycks et al., 2021; Tripuraneni et al., 2021).

Figure 1: (a) The probability density functions of normal distributions with \(_{1}=0,^{2}=0.4\) that the source data is driven from and \(_{1}=1.5,^{2}=0.6\) that the target data is driven from, respectively; (b) the learned function trained by using the source data and the true mean regression function. Note that the considered example serves as an illustration that satisfies case (ii) in Section 2.3.

Importance ratio estimation.A straightforward approach to estimating the importance ratio is separately estimating the source and target densities by kernel density estimation (Sugiyama & Muller, 2005a; Baktashmotlagh et al., 2014) and then computing the ratio. In practice, it is more efficient to directly estimate the importance ratio by minimizing some discrepancy measures between distributions, including kernel mean matching (Huang et al., 2006; Gretton et al., 2009), Kullback-Leibler divergence (Sugiyama et al., 2007a,b, 2012) and non-negative Bregman divergence (Kato & Teshima, 2021).

**Notation.** In this paper, we use \(C\) to denote a universal constant that may vary from line to line. For two sequence \(a_{n}\) and \(b_{n}\), we say \(a_{n} b_{n}\) if and only if \(a_{n}=O(b_{n})\) and \(b_{n}=O(a_{n})\) hold.

## 2 Problem formulation

### Learning within a rich family of loss functions

Suppose that the random pair \((,y)\) is drawn from some unknown distribution \(P_{,y}\) with \(=(x_{1},,x_{p})^{}\), where \(^{p}\) is a compact support and \(y\). In the literature of machine learning, the true target function \(f^{*}\) is often defined as the minimizer of the expected risk with a pre-specified loss function \(L(,):^{+}\) that

\[f^{*}:=*{argmin}_{f}^{L}(f)=*{argmin}_{f} E[Ly,f()].\] (1)

Throughout this paper, we consider a general loss function belonging to a rich loss function family that \(L(y,)\) is assumed to be convex and locally \(c_{L}\)-Lipschitz continuous (Wainwright, 2019; Dasgupta et al., 2019), that is for some \(V 0\), there exists a constant \(c_{L}>0\) such that \(|L(y,)-L(y,^{})| c_{L}|-^{}|\) holds for all pairs \(,^{}[-V,V]\) and \(y\). A variety of popularly used loss functions satisfy these two conditions, including

* **Squared loss**: \(L(y,f())=(y-f())^{2}\) with \(c_{L}=2(M_{y}+V)\), for any \(|y| M_{y}\) with constant \(M_{y}>0\);
* **Check loss**: \(L(y,f())=(y-f())(-I_{\{y f()\}})\) with \(c_{L}=1\) and quantile level \(\);
* **Huber loss**: \(L(y,f())=(y-f())^{2}\), if \(|y-f()|;|y-f()|-^{2}\), otherwise, with \(c_{L}=\);
* **Logistic loss**: \(L(y,f())=(1+(-yf()))/ 2\) with \(c_{L}=( 2)^{-1}e^{V}/(1+e^{V})\);
* **Hinge loss**: \(L(y,f())=(1-yf())_{+}\)with \(c_{L}=1\).

Note that the explicit form of \(f^{*}\) may differ from one loss to another. For example, for the squared loss, \(f^{*}()=E[y|\,]\); for the check loss, \(f^{*}()=Q_{}(y|\,)\) with \(Q_{}(y|\,)=\{y:P(Y y|\,)\}\); for the hinge loss, \(f^{*}=\)sign\((P(y=1|\,)-1/2)\) with sign\(()\) denoting the sign function. Moreover, we require \(f^{*}_{K}\), where \(_{K}\) denotes the RKHS induced by a pre-specified kernel function \(K(,):\). In practice, one of the most important tasks in machine learning is to learn \(f^{*}\) from the source data and use the estimated predictive function \(\) for prediction in the target data.

### Measurement under source and target distributions

Classical learning problems often explicitly or implicitly assume that the source and target data are drawn from the same distribution. Precisely, the source data comes from a joint distribution \(P_{S}=P_{y|\,}P_{}^{S}\) where \(P_{y|\,}\) is the conditional distribution and \(P_{}^{S}\) is the input distribution with density function \(_{}^{S}\). Then, the performance of the estimated predictive function \(\) is usually evaluated by the \(^{2}(P_{}^{S})\)-error or the excess risk error with respect to \(P_{S}\) that

\[\|-f^{*}\|_{S}^{2}=E_{ S} ()-f^{*}()^{2},_{ S}^{L}()-_{S}^{L}(f^{*})=E_{S}L(y,( ))-L(y,f^{*}()),\]

where \(E_{ S}\) and \(E_{S}\) are the expectation over \(P_{}^{S}\) and \(P_{S}\) conditioning on the observed data, respectively. When covariate shift occurs, the target data may come from some totally different joint distribution \(P_{T}=P_{y|}P_{}^{T}\) in the sense that although \(P_{y|}\) representing the regression or classification rule remains invariant, \(P_{}^{T}\) differs significantly from \(P_{}^{S}\). We also assume that \(P_{}^{T}\) has density function \(_{}^{T}\). Obviously, it is reasonable to evaluate \(\) under \(P_{T}\) instead of \(P_{S}\). Then, our primary interest is the \(^{2}(P_{}^{T})\)-error or the excess risk error with respect to \(P_{T}\) that

\[\|-f^{}\|_{T}^{2}=E_{ T}()-f^{}()^{2},_{T}^{L} ()-_{T}^{L}(f^{})=E_{T}L(y,( ))-L(y,f^{}()),\]

where \(E_{ T}\) and \(E_{T}\) are the expectation over \(P_{}^{T}\) and \(P_{T}\) conditioning on the observed data, respectively. In the rest of this paper, \(f^{}\) is defined as the optimal function under the target distribution such that \(f^{}=*{argmin}_{f}E_{T}[Ly,f()]\).

### Kernel-based estimation under covariate shift and importance ratio correction

Suppose that random sample \(_{n}^{S}=}_{i}^{S},y_{i}^{ S}}_{i=1}^{n}\) are i.i.d. drawn from the source distribution \(P_{S}\). We consider the classical nonparametric estimation problem in RKHS (Vapnik, 1999) that

\[:=*{argmin}_{f_{K}}_{i= 1}^{n}Ly_{i}^{S},f(_{i}^{S})+\|f\|_{K}^{2},\] (2)

where \(\) is the regularization parameter. Without covariate shift, the first term on the right side of (2) is an unbiased estimator of \(_{T}^{L}(f)\). However, it becomes biased when covariate shift occurs, and thus may lead to inaccurate predictive estimator. To tackle this issue, we consider the importance ratio measuring the discrepancy between distributions that is \(()=_{}^{T}()/_{}^{S}( ),\) for any \(\), and we notice that \( L(y,f())_{}^{T}()dP_{y|}d =()L(y,f())_{}^{S}( )dP_{y|}d\). Inspired by this, the weighted version of (2) can be used, which leads to an importance ratio weighted (IRW) estimator that

\[^{}:=*{argmin}_{f_{K}} _{i=1}^{n}(_{i}^{S})Ly_{i}^{S},f(_{i}^{S}) +\|f\|_{K}^{2}.\] (3)

Throughout this paper, we focus on two types of the importance ratio that

* \(()\) is \(\)-uniformly bounded that is \(_{}()\), for some positive constant \(\);
* \(()\)'s second moment is bounded that is \(E_{ S}[^{2}()]^{2}\), for some constant \(^{2} 1\).

Note that case (i) reduces to the classical case without covariate shift if \(=1\). Yet, the bounded case is somewhat restrictive, and a much weaker condition is considered in case (ii). It is also clear that case (i) can be regarded as a special case of case (ii) by taking \(^{2}=\). To see this, we have \(E_{ S}[()^{2}]=E_{ T}[()]\). It is interesting to notice that these two cases are related to Renyi divergence (Renyi, 1961) between \(_{}^{S}\) and \(_{}^{T}\). Specifically, the conditions in cases (i) and (ii) are equivalent to requiring \(D_{}(_{}^{T}\|_{}^{S})\) and \(D_{2}(_{}^{T}\|_{}^{S})\) being bounded (Cortes et al., 2010), respectively. Moreover, as pointed out by Ma et al. (2023), (3) may result in significant inflation of the variance, largely due to the unbounded importance ratio. Thus, it is natural to consider a truncated importance ratio with a pre-specified threshold value \(_{n}>0\)(Ma et al., 2023; Gogolashvili et al., 2023). Precisely, we consider the following truncation

\[_{n}():=\{(),_{n}\}.\]

Accordingly, the following truncated important ratio weighted (TIRW) estimator is considered that

\[^{}:=*{argmin}_{f_{K}} _{i=1}^{n}_{n}(_{i}^{S})Ly_{i}^{S},f(_{i}^{S })+\|f\|_{K}^{2},\] (4)

where the theoretical suggestion of the choice of \(_{n}\) is provided in Section 3.

## 3 Main results

In this section, we provide a unified theoretical analysis of the unweighted estimator in (2) and the TIRW estimator in (4) under two types of importance ratio. Let \(_{K}\) denote the RKHS induced by a symmetric, continuous, and positive semi-definite kernel function \(K(,):\). Under some regularity conditions, Mercer's theorem (Mercer, 1909) guarantees that \(K\) has an eigen-expansion of the form

\[K(,^{})=_{j=1}^{}_{j}_{j}( )_{j}(^{}),\]

where \(\{_{j}\}_{j 1}\) are the eigenvalues and \(\{_{j}\}_{j 1}\) are the orthonormal eigenfunctions of \(^{2}(,P_{}^{T})=f:_{}f ^{2}()_{}^{T}()d\,<}\). We expand the kernel in \(^{2}(,P_{}^{T})\) for deriving bounds under the target distribution. For any \(f_{K}\), we have \(f=_{j=1}^{}a_{j}_{j}\) with \(a_{j}=_{}f()_{j}()_{}^{ T}()d\,\) and the RKHS-norm is \(\|f\|_{K}^{2}=_{j=1}^{}a_{j}^{2}/_{j}<\). The kernel complexity function of \(_{K}\) is then given as \(R()=_{j=1}^{}(^{2},_{j}\|f^{*} \|_{K}^{2})}\). In literature, \(R()\) is important to quantify the localized Rademacher complexity of \(_{K}\), which helps to build tight bounds in kernel-based methods (Mendelson, 2002; Koltchinskii & Yuan, 2010). For theoretical simplicity, we assume \(\|f^{*}\|_{K}=1\) in the rest of this paper, which is commonly considered in machine learning literature (Yang et al., 2017; Li et al., 2021). The following technical assumptions are required for the theoretical analysis.

**Assumption 1**: There exists some constant \(>0\) such that \(_{}|K(,)|\), and the eigenfunctions \(\{_{j}\}_{j 1}\) are uniformly bounded such that \(_{}|_{j}()| 1\) for all \(j 1\).

**Assumption 2**: For some sufficiently small constant \(u>0\), we assume \(E_{I}[L(y,f())]-E_{I}[L(y,f^{*}() )] c_{0}\|f-f^{*}\|_{I}^{2}\) holds with some constant \(c_{0}>0\), for all \(\|f-f^{*}\|_{I} u\), where \(I\{S,T\}\).

Assumption 1 imposes a boundedness condition on the kernel function and its corresponding eigenfunctions, which is commonly considered in the literature and satisfied by many popularly used kernel functions with the compact support condition (Smale & Zhou, 2007; Steinwart et al., 2009; Mendelson & Neeman, 2010). Assumption 2 is a local \(c_{0}\)-strong convexity condition of the expected loss function with respect to \(^{2}(,P_{}^{S})\) and \(^{2}(,P_{}^{T})\) at \(f^{*}\). Similar assumptions are also considered by Steinwart & Christmann (2008); Wainwright (2019); Li et al. (2021); Lian (2022). Note that many popularly used loss functions, including squared loss, check loss, Huber loss, logistic loss, and hinge loss, satisfy this assumption. More detailed discussions on Assumption 2 are deferred to Section A.7 of the supplementary material.

### Convergence rate for the uniformly bounded case

We begin to establish the convergence rate of the unweighted estimator \(\) under the uniformly bounded case with covariate shift.

**Theorem 1**.: _Under Assumptions 1-2, if the importance ratio is \(\)-uniformly bounded, let \(>c_{0}_{n}^{2}/4\) with \(_{n}\) being the smallest positive solution to \(CR() c_{0}^{2}/2\), then for some constant \(c_{1}>0\), with probability at least \(1-n^{-c_{1}}\), we have_

\[\|-f^{*}\|_{T}^{2}(_{n}^{2}+2c_{0}^{-1} ).\] (5)

_Furthermore, based on (5), we have_

\[_{T}^{L}()-_{T}^{L}(f^{*}) c_{L} _{n}^{2}+2c_{0}^{-1}^{1/2}.\] (6)

Note that the existence and uniqueness of \(_{n}\) in Theorem 1 is guaranteed for any kernel class (Bartlett et al., 2005). To facilitate the comprehension of Theorem 1, we define an index as \(d()=\{j 1|_{j}^{2}\}\) for a given target error level \(>0\). It is known that the kernel with eigenvalues satisfying that \(_{j=d()+1}^{}_{j} Cd()^{2}\) is referred to as the regular kernel class (Yang et al., 2017). From the definition of \(d()\) and regular kernel, we can get that \(_{j=1}^{}(^{2},_{j})<d()^{2}\), thus the inequality \(CR() c_{0}^{2}/2\) in Theorem 1 can be directly simplified as \()/n} C\) under the assumption that \(\|f^{*}\|_{K}=1\). Consequently, we can rewrite (5) as

\[\|-f^{*}\|_{T}^{2} C^{2}+d(),\] (7)where \(\) satisfies \(d() C^{2}\) and \(^{2}\) (see Section C.4 of the supplementary material for the detailed proof). The bound in (7) controls a type of bias-variance tradeoff by the choice of \(\), and hence \(\). Under the uniformly bounded case, Ma et al. (2023) has established a minimax rate of the order \(_{>0}\{^{2}+d()}{n}\}\) for the squared loss function. It is worthnoting that the result in (7) can also attain this lower bound up to a logarithmic factor under some weaker conditions. Particularly, the assumption of Ma et al. (2023) that the noise terms are sub-Gaussian is no longer needed in (7). Although the convergence rate of (6) is sub-optimal for general loss function \(L\) considered in Section 2.1, it becomes optimal at the rate of \(c_{0}^{}(_{n}^{2}+2c_{0}^{-1})\) if the following assumption holds.

**Assumption 3**: For some sufficiently small constant \(u>0\), we assume \(E_{T}[L(y,f())]-E_{T}[L(y,f^{*}() )] c_{0}^{}\|f-f^{*}\|_{T}^{2}\) holds with some constant \(c_{0}^{}>c_{0}>0\), for all \(\|f-f^{*}\|_{T} u\).

In fact, Assumption 3 is a mild condition that can be satisfied by many commonly used losses. For instance, for the squared loss, the equality always holds with \(c_{0}^{}=1\); for the check loss, Assumption 3 is satisfied if the conditional density of the noise term is uniformly bounded (Zhang et al., 2021; Lian, 2022). Moreover, the regular kernel class includes kernels with either finite rank (i.e., linear or polynomial kernels), polynomially decayed eigenvalues (i.e., Sobolev kernels), or exponentially decayed eigenvalues (i.e., Gaussian kernels). Corollary 1 provides the convergence rate of \(\) over these three specific kernel classes.

**Corollary 1**.: _Under Assumptions 1-3, if the kernel has a finite rank \(D\), and let \(=C\), then with probability at least \(1-n^{-c_{1}}\), we have_

\[\|-f^{*}\|_{T}^{2}_{T}^{L}()- _{T}^{L}(f^{*}) CD n}{n},\] (8)

_and if the eigenvalues of the kernel decay polynomially such as \(_{j} Cj^{-2r}\) with some constant \(r>1/2\) for \(j=1,2,\), and let \(=C^{}()^{}\), then with probability at least \(1-n^{-c_{1}}\), we have_

\[\|-f^{*}\|_{T}^{2}_{T}^{L}()- _{T}^{L}(f^{*}) C( n}{n})^{ {2r}{2r+1}},\] (9)

_and if the eigenvalues of the kernel decay exponentially such as \(_{j} e^{-Cj j}\), and let \(=Cn}{n}\), then with probability at least \(1-n^{-c_{1}}\), we have_

\[\|-f^{*}\|_{T}^{2}_{T}^{L}()- _{T}^{L}(f^{*}) C^{2}n}{n},\] (10)

Note that these bounds in (8)-(10) reduce to the known minimax lower bounds (Yang et al., 2017) for the squared loss without covariate shift (i.e., \(=1\)). As the uniform boundedness implies the boundedness of the second moment, the convergence rate of the TIRW estimator \(^{}\) for the uniformly bounded case is similar to Theorem 3 in the next section by replacing \(\) with \(^{2}\).

### Convergence rate for the second moment bounded case

The optimality for the \(\)-uniformly bounded importance ratio condition relies on the inequality that \(\|-f^{*}\|_{T}^{2}\|-f^{*}\|_{S}^{2}\). Yet, such a desired relation is not guaranteed for the second moment bounded case. Theorem 2 shows that the unweighted estimator \(\) is still consistent, but not optimal.

**Theorem 2**.: _Under Assumptions 1-2, if the importance ratio satisfies that \(E_{ S}[^{2}()]^{2}\), let \(>c_{0}_{n}^{2}/4\) with \(_{n}\) being the smallest positive solution to \(CR((c_{0}^{-1}c_{L}})^{1/2}) c_{0} ^{2}/2\), then for some constant \(c_{2}>0\), with probability at least \(1-n^{-c_{2}}\), we have_

\[\|-f^{*}\|_{T}^{2} c_{0}^{-1}c_{L}}(_ {n}^{2}+2c_{0}^{-1})^{1/2}.\] (11)

_Furthermore, based on (11), we have_

\[_{T}^{L}()-_{T}^{L}(f^{*}) c_{L}}(_{n}^{2}+2c_{0}^{-1})^{1/2}.\] (12)To see the bound in (11) is sub-optimal, we consider the kernel with finite rank \(D\), we can show that \(_{n}(D n}}{n})^{1/3}\), and if we take \((D n}}{n})^{2/3}\), the unweighted estimator satisfies that \(\|-f^{*}\|_{T}^{2}=O_{P}((D n}{n})^{1/3})\), which is far from the optimal rate (see Section C.4 of the supplementary material for examples of finite rank, polynomially and exponentially decay kernel classes). To deal with the sub-optimality, we consider the importance ratio correction ensuring that \(E_{S}[()L(y,f())]=E_{T}[L(y,f())]\). The following theorem shows that the TIRW estimator \(^{}\) can again reach a sharp convergence rate up to logarithmic factors under some mild conditions.

**Theorem 3**.: _Under Assumptions 1-2, if the importance ratio satisfies that \(E_{ S}[^{2}()]^{2}\), let \(>c_{0}_{n}^{2}/4\) with \(_{n}\) being the smallest positive solution to \(C} nR() c_{0}^{2}/2\), and set the truncation level \(_{n}=}\), then for some constant \(c_{3}>0\), with probability at least \(1-n^{-c_{3}}\), we have_

\[\|^{}-f^{*}\|_{T}^{2}_{n}^{2}+2c_{0}^{-1}.\] (13)

_Furthermore, based on (13), we have_

\[_{T}^{L}(^{})-_{T}^{L}(f^{*})c_{0}_{n}^{2}+2.\] (14)

Similar to (7), when dealing with regular kernel classes, the bounds in (13) and (14) become

\[\|^{}-f^{*}\|_{T}^{2}_{T}^{L}(^{ })-_{T}^{L}(f^{*}) C^{2}+^{2}n}{n}d(),\] (15)

where \(\) is any solution of \(^{2}n}{n}d() C^{2}\) and \(^{2}\). Since the second moment boundedness can be implied by the uniform boundedness, it can be concluded that \(^{}\) also reaches the minimax lower bound for the square loss up to logarithmic factors (with \(\) substituted by \(^{2}\)). For three specific kernel classes, we also have the following Corollary for the TIRW estimator \(^{}\).

**Corollary 2**.: _Under Assumptions 1-2, if the kernel has a finite rank \(D\), and let \(=CD^{2}n}{n}\), then with probability at least \(1-n^{-c_{3}}\), we have_

\[\|^{}-f^{*}\|_{T}^{2}_{T}^{L}(^{ })-_{T}^{L}(f^{*}) CD^{2}n}{n},\] (16)

_and if the eigenvalues of the kernel decay polynomially such as \(_{j} Cj^{-2r}\) with a constant \(r>1/2\) for \(j=1,2,\), and let \(=C( n}{n})^{}\), then with probability at least \(1-n^{-c_{3}}\), we have_

\[\|^{}-f^{*}\|_{T}^{2}_{T}^{L}(^{ })-_{T}^{L}(f^{*}) C(^{2}n}{n} )^{},\] (17)

_and if the eigenvalues of the kernel decay exponentially such as \(_{j} e^{-Cj j}\), and let \(=C^{3}n}{n}\), then with probability at least \(1-n^{-c_{3}}\), we have_

\[\|-f^{*}\|_{T}^{2}_{T}^{L}()-_{T}^{L}(f^{*}) C^{3}n}{n},\] (18)

For easy reference, we summarize some important theoretical results that have been established by us in table 1.

    &  &  \\   & Unweighted estimator & TIRW estimator & Unweighted estimator & TIRW estimator \\   & (D n}{n})\)} & ()\)} & ((D n}{n})^{1/3})\)} & (D^{2}n}{n})\)} \\   & & & & \\   & (( n}{n})^{})\)} & ((n}{n})^{})\)} & (( n}{n})^{})\)} \\   & & & & \\   & (^{2}n}{n})\)} & (n}{n})\)} & ((^{2}n}{n})^{1/3})\)} & (^{3}n}{n})\)} \\     & & & & \\   

Table 1: Established convergence rates under different casesNumerical experiments

In this section, we validate our theoretical analyses by performing numerical experiments on both synthetic data and real applications. To estimate the importance ratios, we apply the Kullback-Leibler importance estimation procedure (KLIEP) (Sugiyama et al., 2007b), and the estimation details are provided in the supplementary material. For brevity, we only report the performance of kernel-based quantile regression (KQR) where the check loss is used in synthetic data analysis, and the performance of kernel support vector support machine (KSVM) with hinge loss in the real data analysis; completed results for other loss functions as well as the detailed settings and results for the other examples, including for the multi-dimensional cases, can be found in Section A of the supplementary material. In our experiments, we consider the RKHS induced by Gaussian kernel in all the examples, and all the experiments are replicated 100 times in the synthetic data analysis.

### Synthetic data analysis

We investigate the performance of KQR under covariate shift with the following generating model

\[y=f_{0}(x)+(1+r(x-0.5)^{2})(-^{-1}( )),\]

where \(f_{0}(x)=( x)\) with \(x\), \(\) denotes the CDF function of the standard normal distribution and \( N(0,1)\). We consider \(_{}^{} N(_{1},_{1}^{2})\) and \(_{}^{} N(_{2},_{2}^{2})\) with \(_{1}=0,_{1}^{2}=0.4,_{2}=0.5,_{2}^{2}=0.3\) for the uniformly bounded case and \(_{1}=0,_{1}^{2}=0.3,_{2}=1,_{2}^{2}=0.5\) for the moment bounded case, respectively. Moreover, we set \(r=0\) and \(=0.5\) for the homoscedastic case, and \(r=1\) and \(=0.3\) for the heteroscedastic case, respectively. Note that the simulation results for the case that \(=0.3\) and \(r=1\) are presented in Figure 2 under the uniformly bounded case and in Figure 3 under the moment bounded case; completed results for other cases are provided in the supplementary material. We compare the averaged mean square error (MSE) and empirical excess risk of the unweighted estimator and weighted estimator, either with true or estimated weights across different choices of regularization parameter \(\), source sample size \(n\), and target sample size \(m\).

From (a) and (d) in Figure 2, we can conclude that the error of the unweighted estimator is very close to that of the weighted estimator for the uniformly bounded case, which is consistent with our theoretical findings in Section 3. For the moment bounded case as demonstrated in (a) and (d) of Figure 3, the weighted estimator consistently outperforms its unweighted counterpart for all choices of \(\). Even when \(\) is far from its optimal choice, the weighted estimator still maintains a lower

Figure 2: Averaged MSE and empirical excess risk for unweighted KQR, TIRW KQR with true weight and estimated weight, respectively. Note that in (a) and (d), the curves are plotted with respect to \(_{10}\) with \(n=500,m=1000\); in (b) and (e) the curves are plotted with respect to \(n\) with fixed \(m=1000,=10^{-4}\); in (c) and (f), the curves are plotted with respect to \(m\) with fixed \(n=500,=10^{-4}\).

error level with significant improvement over the unweighted estimator whose error is on occasion extremely high for small choices of \(\). Additionally, it is clear from Panels (b) and (e) of Figures 2 and 3 that in the moment bounded case, the error curves for the unweighted estimator have some significant gaps with those of the weighted estimator, while in the bounded case, these curves tend to coincide as \(n\) grows. It is also clear from the table 1 that the trends in Figure 2 (b)-(e) and Figure 3 (b)-(e) almost agree with the explicit convergence rate where the Gaussian kernel with exponential decay is used. This phenomenon is consistent with our theoretical conclusion that the unweighted estimator can only achieve sub-optimal rates when the importance ratio is moment bounded and attain optimal rates when uniformly bounded. Finally, we note that the target sample size has a subtle influence on all the estimators, as demonstrated in Panels (c) and (f) of Figures 2 and 3.

### Real case study

We consider the binary classification problem on the Raisin dataset, which is available in https://archive.ics.uci.edu/ml/datasets.php. The dataset contains 900 instances and 7 attributes. After standardization, the data are first randomly split into source and target datasets. We introduce a binary random variable \(s\) that serves as a labeling indicator and assign it to the source dataset if \(s=0\). To ensure that the conditional distribution of different datasets remains invariant, we require \(s\) to be conditionally independent with the response \(y\) given the covariate \(\)(Zadrozny, 2004; Quinonero-Candela et al., 2008). We implement KSVM in which the covariate shift only exists in the first covariate. Specifically, for \(>0\), we conduct the splitting rule as \(P(s_{i}=1_{i})=(1,(x_{i,0}-c)^{2}/)\), where \(x_{i,0}\) is the first element of \(_{i}\) and \(c=_{i}\{x_{i,0}\}\). We refer to \(\) as the shift level that a smaller value of \(\) favors a greater distinction between source and target datasets. We set the turning parameter \(C_{}=(n)^{-1}\). For the TIRW estimator, we use importance weighted cross validation (IWCV) (Sugiyama et al., 2007) to tune the truncation parameter \(_{n}\). We refer to Section A in the supplementary material for the details of the adopted method.

Figure 4 summarizes the accuracy rate and standard error in different settings. As shown in this figure, the unweighted estimator has poor performance on target data, even for the optimal choice of \(C_{}\). Nevertheless, the weighted estimator has a significant improvement in performance. Surprisingly, the weighted estimator is relatively stable with respect to the choices of \(C_{}\), which is consistent with our results on synthetic data. Moreover, we can find that a proper truncation slightly improves the accuracy rate of the weighted estimator while reducing its variation.

Figure 3: Averaged MSE and empirical excess risk for unweighted KQR, TIRW KQR with true weight and estimated weight, respectively. Note that in (a) and (d), the curves are plotted with respect to \(_{10}\) with \(n=500,m=1000\); in (b) and (e) the curves are plotted with respect to \(n\) with fixed \(m=1000,=10^{-4}\); in (c) and (f), the curves are plotted with respect to \(m\) with fixed \(n=500,=10^{-4}\).

## 5 Conclusion

In this work, we propose a unified analyzing framework for kernel-based methods under covariate shift and show that the predictive function can be better estimated by using the distribution information of the covariates from both aspects of theory and numerical performance. The established theoretical results fulfill the gap in understanding the influence of the covariate shift under various kernel-based learning problems, both researchers and practitioners may benefit from our theoretical findings. Extensive numerical studies also provide empirical evidence and confirm the established theoretical results. Note that it is very interesting to test if there exists a distribution shift in practical applications and if the distribution shift satisfies the uniformly bounded or moment bounded assumptions. Unfortunately, the relevant approaches have remained lacking to our best knowledge. And it is interesting to note that as shown in our real applications, the TIRW estimator always outperforms the unweighted estimator, and thus we suggest using the TIRW estimator to analyze the real-life dataset. Moreover, in the theory, we directly use the true importance ratio, and it is difficult to derive the consistency of the estimated ratio and plug it into our theoretical analysis. In the machine learning literature, there exist several measures to quantify the divergence between two distributions, including but not limited to \(f\)-divergence, Wasserstein distance and kernel mean matching. It is still an open problem if it still works when we use other measures rather than the importance ratio. We leave such promising and interesting topics as potential future work.