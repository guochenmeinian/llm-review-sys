# Causal discovery with endogenous context variables

Wiebke Gunther\({}^{1,2*}\) **Oana-Iuliana Popescu\({}^{1,2*}\)  Martin Rabel\({}^{1,3,4*}\) Urmi Ninad\({}^{1,2}\)  Andreas Gerhardus\({}^{1}\)  Jakob Runge\({}^{1,2,3,4}\) \({}^{1}\)German Aerospace Center (DLR), Institute of Data Science, Jena, Germany

\({}^{2}\)Technische Universitat Berlin, Institute of Computer Engineering

and Microelectronics, Berlin, Germany

\({}^{3}\)Center for Scalable Data Analytics and Artificial Intelligence (ScaDS.AI)

Dresden/Leipzig, Germany

\({}^{4}\)Technische Universitat Dresden, Faculty of Computer Science, Dresden, Germany

oana-iulia.popescu@dlr.de

equal contribution

###### Abstract

Causal systems often exhibit variations of the underlying causal mechanisms between the variables of the system. Often, these changes are driven by different environments or internal states in which the system operates, and we refer to context variables as those variables that indicate this change in causal mechanisms. An example are the causal relations in soil moisture-temperature interactions and their dependence on soil moisture regimes: Dry soil triggers a dependence of soil moisture on latent heat, while environments with wet soil do not feature such a feedback, making it a _context-specific_ property. Crucially, a regime or context variable such as soil moisture need not be exogenous and can be influenced by the dynamical system variables - precipitation can make a dry soil wet - leading to joint systems with endogenous context variables. In this work we investigate the assumptions for constraint-based causal discovery of context-specific information in systems with endogenous context variables. We show that naive approaches such as learning different regime graphs on masked data, or pooling all data, can lead to uninformative results. We propose an adaptive constraint-based discovery algorithm and give a detailed discussion on the connection to structural causal models, including sufficiency assumptions, which allow to prove the soundness of our algorithm and to interpret the results causally. Numerical experiments demonstrate the performance of the proposed method over alternative baselines, but they also unveil current limitations of our method.

## 1 Introduction

In recent years, causal discovery (CD), that is, learning cause-effect relationships from observational data, has garnered significant interest across various domains, from Earth sciences and genomics to industrial settings [(11; 26; 27; 1)]. Such complex systems often exhibit a change of causal mechanisms over time or across different environments, including changes in the associated causal graph. An example are the causal relations between surface heat and latent heat and their dependence on soil moisture regimes: When the soil is dry, it triggers a dependence of soil moisture on latent heat due to the dry soil reflecting heat, while environments with wet soil do not feature such a feedback. These changing causal mechanisms can be represented using so-called contexts, where the causal mechanisms and structures vary depending on the states of one or more context variables that augment the assumed underlying structural causal model [(7; 17; 15)]. Both time-series [(29)] and non-time-series data can exhibit such behavior. Context-dependent systems have been widely studied; see Mooij et al.

(15) for a review. Context variables [(15; 34; 18)] have also been called selection variables [(17)] or regime indicators [(23; 29)] in the literature.

Causal discovery on such systems is challenging [(7; 15)] and methods for CD in case of systems with changing causal mechanisms typically assume that the context variable is exogenous, as will be discussed below and in Sec. 3.2. Yet there exist many real-world examples where the context indicators are endogenous. A regime/context variable such as soil moisture can be influenced by the dynamical system variables - precipitation can make a dry soil wet - leading to joint systems with endogenous context variables, as illustrated in Fig. 1, where we show a hypothesized causal model of the drivers of soil moisture (SM). Understanding context-specific causal relationships is crucial for applications such as extreme event forecasting and for enhancing our general understanding of dynamical systems.

Our work investigates the assumptions for constraint-based CD on such systems. A core difficulty in treating endogenous context indicators is that context-specific CD methods which resort to masking, i. e., conditioning on the context of interest and ignoring data from other contexts, e.g., [(7; 29)], can introduce selection bias if the assumption of exogenous context variables is violated. For example, applying CD only on samples from the dry context in the soil moisture problem of Fig. 1 would introduce a spurious correlation between the precipitation and latent heat flux. Other methods apply CD on the pooled data, i.e., the concatenated dataset containing all contexts. Then allowing for endogenous variables is possible [(15)], but does not yield context-specific information, i.e., no distinction between solid and dashed edges in Fig. 1 can be made. We propose an adaptive constraint-based discovery algorithm that allows to distinguish context-specific causal graphs and give a detailed discussion of the connection to structural causal models, including sufficiency assumptions, which allow to prove the soundness of our algorithm and to interpret the results causally.

Context-specific graphs contain more information than union graphs on pooled data, i.e., the dashed edges in in Fig. 1. This information can under suitable assumptions be discovered by additionally taking context-specific independencies (CSIs) into account. CSIs are independence relations that are only present when data of a single context is viewed in isolation. Naively searching through all CSIs would lead to an inflated search space of available independence tests. Further CSIs necessarily use only a reduced sample size which can also increase error rates. Indeed, a simple baseline method we compare against suffers from an increased error rate, whereas our proposed method is able to avoid an inflation of required tests. This is achieved by an easy-to-implement decision rule which allows to adaptively decide for one and only one test to be executed per separating set. Whenever consistent, tests are further executed on the pooled dataset, thus on all available data.

We now summarize our contributions: (1) We propose a general framework for adapting existing constraint-based CD algorithms to extract context-specific information, in addition to joint information, about skeleton graphs when contexts are (potentially) endogenous without inflating the number of required independence tests. (2) We give an SCM-based interpretation of this additional information and unveil interesting and little-studied difficulties whose understanding we consider essential to the problem. (3) We work out the theoretical assumptions under which our proposed method soundly recovers the context-specific skeletons despite these difficulties. (4) We conduct a simulation study to numerically evaluate the performance of the proposed method and understand the failure modes of current approaches.

## 2 Related work

The problem of CD from heterogeneous data sources has gained interest in recent years. Mooij et al. [(14)] offers a broad overview of the topic and groups recent works on CD for heterogeneous data

Figure 1: In this strongly simplified example, the variable soil moisture (SM) is an endogenous context variable influenced by variables such as precipitation (TP) and latent heat flux (LH) in both wet and dry regimes of SM, represented by solid edges. In dry conditions only, a feedback loop from the latent heat flux to the soil moisture is created because the soil additionally reflects the heat, represented by the dashed edge (a feedback loop is a time-delayed cycle, leading to a cyclic summary graph representation while the underlying time-series graph remains acyclic).

into two categories: Works that do CD separately on each context-specific dataset (the data points belonging to a specific context) and works that use the pooled datasets (all data points). Works that obtain context-specific graphs apply CD on the context-specific dataset, where the assignment to contexts is either known [(8; 24)], identified before applying CD [(12; 36)], or iteratively learned [(29)]. The information from the context-specific graphs can then be summarized in a single graph, the so-called union graph.

Mooij et al. [(14)] propose the Joint Causal Inference (JCI) framework to deal with multi-context CD by modeling the context variable and using CD on the pooled datasets to uncover the relationships between the context and system variables, where the context can also be endogenous. Several CD methods can be extended for JCI, e.g., FCI [(32)]. FCI is also applied in [(28; 10)] on the pooled data to discover causal relationships among all variables. Zhang et al. [(39)] test for conditional independence between system and context variables on the pooled dataset under the assumption of exogenous context variables. Constraint-based CD for the multi-context case has also been studied specifically for the time-series case, e.g., [(29; 33; 5)]. Among non-constraint-based methods, Peters et al. [(19)]; Heinze-Deml et al. [(6)] exploit the invariance of the conditional distribution of a target variable given its direct causes across multiple contexts, while Zhou et al. [(41)] find causal structure by modeling the direct causal effects as functions of the context variables. Although not directly methodically related, CD for cyclical graphs is also relevant to our problem, as cycles can appear between the different contexts [(8; 3)]. Most above-mentioned methods using both context-specific and pooled data assume, either implicitly or explicitly, that the context variable is exogenous. This is possibly due to the fact that, for context-specific approaches, endogenous variables might lead to selection bias, while for methods that use pooled data it suffices to treat endogenous variables as any other variable in the graph. In our work, we discover context-specific causal graphs for the case of endogenous context variables. Assuming access to the context variable, we obtain information from the pooled and context-specific graphs. We focus on the non-time-series case and leave the extension to time-series for future work.

Labeled Directed Acyclic Graphs (LDAGs) [(18)] are conceptually closest to our work. LDAGs summarize context-specific information in graphical form by assigning a label to each edge according to the context in which dependence arises. Hyttinen et al. [(9)] propose a constraint-based method to discover LDAGs from data similar to our approach: A variant of the PC algorithm that tests conditional independence of \(X\!\!\! Y|R=r\) within each context \(R=r\) instead of testing \(X\!\!\! Y|R\) on the pooled data. We discuss how our definitions of context-specific graphs fundamentally differ from CSIs in Sec. 3.1 and delimit our work from LDAGs in App. A.

## 3 Formal description

We first briefly outline preliminary definitions (see, e.g., [(16)] for detailed definitions). We then point out an unexpected difficulty of our approach in the connection to SCMs and its remedy.

**Preliminaries** We work within the framework of structural causal models (SCM) [(16)]. We define the set of observed **endogenous variables**\(\{X_{i}\}_{i I}\), which take values in \(_{i}\), with finite index set \(I\). Let \(V:=\{X_{i} i I\}\) represent the set of all endogenous variables. The set of (hidden) **exogenous noises**\(\{_{i}\}_{i I}\), taking values in \(_{i}\) is denoted \(U:=\{_{i} i I\}\). For any subset \(A V\), let \(_{A}:=_{j A}_{j}\). We denote \(:=_{V}\) and \(:=_{U}\).

A set of **structural equations**\(:=\{f_{i}|i I\}\) is a set of parent sets \(\{(i) V|i I\}\) together with functions \(f_{i}:_{(i)}{}_{i}_{i}\). An **intervention**\(_{(A=g)}\) on a subset \(A V\) is a replacement of \(f_{j} g_{j}\) for \(j A\). We will only need **hard interventions**, \(g_{j} x_{j}=\) below.

Given a distribution \(P_{}\) of the noises \(U=\{_{i}\}_{i I}\), a collection of random variables \(V=\{X_{i}\}_{i I}\)**satisfies the structural equations**\(\)**on**\(U\) if \(X_{i}=f_{i}((X_{j})_{j(i)},_{i})\). An **SCM**\(M\) is a triple \(M=(V,U,)\), where \(V\) solves the structural equations \(\) given \(U\). The **intervend model**\(M_{(A=g)}\) is the1 SCM \(M_{(A=g)}:=(V^{},U,\,_{(A=g)})\). A **causal graph** describes qualitative relations between variables; given a collection of parent-sets \(\{_{i}\}_{i I}\), on the nodes \(I\) add a directed edge \(p i\) for all \(i I\) and all \(p_{i}\). See next section Sec. 3.1.

We observe data from a system with multiple, slightly different SCMs, corresponding to **contexts** and indicated by a categorical **context indicator / variable**, as illustrated in example 3.1. This variable \(R V\) is a variable whose value indicates the context, i.e., the dataset to which the data point belongs. Therefore, the value-space of \(R\) defines all datasets, and its values associate data points to datasets.

**Example 3.1**.: Given a binary context indicator variable \(R\) and a _multivariate_ mechanism of the form

\[Y:=f_{Y}(X,R,_{Y})=(R)g(X)+_{Y},\]

the dependence \(X Y\) is present in the context \(R=1\), but absent for \(R=0\). This entails a **context-specific independence** (CSI) and \(X Y|R=0\) and \(X Y|R=1\).

### SCMs for endogenous contexts and their associated graphs

In order to create a connection between CSIs and SCMs, we define multiple graphical objects. We motivate their necessity and exemplify them in Sec. 3.2.

Given a set of structural equations, \(\), we define the **mechanism graph**\(G[]\), constructed via parent sets \(_{i}\) specified via \(\) (see "causal graphs" above). Given a pair consisting of a set of structural equations \(\), and the (support of) a distribution of the observables \(P(V)\) we define the **observable graph**\(G[,P]\), constructed via parent sets \(^{}_{i}_{i}\) (of \(X_{i}\)), such that \(j^{}_{i}\) if and only if for all values \(}\) of \(_{i}-\{j\}\) the mapping \(x_{j} f_{i}|_{\,P(_{i})}(x_{j}, },_{i})\) is constant (where defined).

The **union graph** of an SCM \(M=(V^{M},U^{M},^{M})\), where \(V^{M}\) is distributed according to \(P_{M}\), is the observable graph

\[G^{}[M]:=G[^{M},P_{M}]\]

which consolides the information from multiple contexts into a unified graphical representation. If \(=^{}\) satisfies standard minimality assumptions (2, Def. 2.6), then \(G[^{}]=G^{}[M]\) (given faithfulness, Sec. 4.2) thus corresponds to the causal graph in the standard sense. Given an SCM \(M\) with a context indicator \(R\), there are _multiple_ meaningful sets of structural equations and _multiple_ meaningful associated distributions on observables, which result in _multiple_ observable graphs associated to the SCM \(M\); an overview is provided in Table 1 in the appendix, see also Fig. 2 and the next subsection. We thus distinguish _multiple_ context-specific graphs. The **descriptive graph**

\[^{}_{R=r}[M]:=G[^{M}_{(R=r)},P_{ M}(V|R=r)],\]

captures relations present in the _intervened_ model's mechanisms \(^{M}_{(R=r)}\) (the SCM in the context \(r\)) and encountered in _observational_ data together with this context; the last point is formalized by restricting our attention to the support of \(P_{M}(V|R=r)\). For edges not involving \(R\), the same information is contained in \(G[^{M},P_{M}(V|R=r)]\) using the unintervened \(\), which supports the intuition that the context-specific graph captures the overlap of observations and the context of interest. Since \(R\) is a constant per-context, we add edges involving \(R\) from the union graph to \(^{}_{R=r}[M]\) and denote the result \(G^{}_{R=r}[M]\). The result is _very different_ from an independence graph of the conditional distribution: There are no edges induced by selection bias in \(G^{}_{R=r}[M]\).

The **physical graph** encodes the differences from the union graph necessary to describe the context consistently and describes the intuitive notion of \(R\) introducing physical changes in mechanisms:

\[G^{}_{R=r}=G[^{M}_{(R=r)},P_{M}(V)]\]

Importantly, the context-specific graphs defined above _depend only on the SCM_, without making explicit or implicit reference to independence. This sets them apart from graphical representations of independence structure like LDAGs (18): LDAGS are graphical independence models describing context-specific independence (CSI) structure of a dataset. However, a causal analysis requires an understanding of interventional properties, which, in turn, requires inferring knowledge about the causal model properties. In the single-context case, under the faithfulness assumption, knowledge about the causal properties of models is directly connected to the independence structure. As will be explored in Sec. 3.2, this direct connection cannot generally hold in the multi-context case. Thus, an important open problem is the connection of CSI structure to the underlying causal model. Such a relation is given in Sec. 4.2, connecting properties of the underlying causal model represented by context-specific graphs to CSI structure.

### Two problems of CD with endogenous context variables

In this section, we describe two main problems encountered with context-specific causal discovery and illustrate them by two examples. In the columns of Fig. 2, we show the different graphs of systems with the following SCMs:

**Example 3.2**.: The mechanisms \(X:=_{X},T:=_{T}\) and the binary threshold exceedence \(R:=[(X+T+_{R})>t]\{0,1\}\) agree for both systems. (i) For the system depicted in the left column of Fig. 2, \(Y:=R g(T)+_{Y}\) is a function of \(R\) with the dependence on \(T\) explicitly disabled for \(R=0\). (ii) On the right-hand side, \(Y:=(T,T_{0})+_{Y}\), is not a function of \(R\), but assume \(P(T>T_{0}|R=0)<\), such that given \(R=0\) automatically \((T,T_{0}) T_{0}\) and hence the dependence of \(Y\) on \(T\) becomes negligible for \(R=0\).

**Selection bias** Endogenous context variables can pose a problem for context-specific CD if the context variable is driven by multiple other variables, and is thus a collider. As described in Sec. 2, methods to obtain context-specific graphs typically apply CD on the context-specific dataset, thus essentially conditioning on the context variable. If the context variable is a collider or a descendant thereof, this approach leads to selection bias (red edge in Fig. 2). This is a subtle issue: From an independence structure viewpoint, the dependence between \(X\) and \(T\) exists yet does not seem to make any intuitive sense and does not admit causal semantics. A formal description in which the absence of this edge is considered correct - as it should be for a causal analysis - requires _the underlying model_ as a starting point. Indeed the graphs defined above from the SCM directly (also shown in Fig. 2) consider the absence of this edge correct.

**The support problem** A second problem is encountered, because CSI can arise in two different ways from a given model: Either by an explicitly disabled dependence as in the first example, or indirectly through the lack of observational support in a specific context. Note that, in Fig. 2, our graphical models capture this difference: Once \(G^{}=G^{}\) (left-hand side), while in the other case \(G^{} G^{}\) (right-hand side).

Concerning the second example in Ex. 3.2 in particular, we make the following observations: **(a)** There is no evidence for the absence of the link \(T Y\), e. g. when considering interventional questions. **(b)** The absence of the link _does_ correctly describe an independence, e. g. edge orientations, cycle resolution, or function fitting on the respective data.

Thus, for these problems, the link \(T Y\) is not required for a meaningful description in the context \(R=0\). **(c)**\(R\) is adjacent to \(T\), but we could add an intermediate node \(T M R\) without changing the problem, so adjacency of \(R\) to the changing link is not guaranteed. **(d)** We lack observations of another context variable \(R^{}\), which indicates whether \(T>T_{0}\), and would suffice to fully describe the qualitative structure of the mechanism at \(Y\). Observations (a) and (b) demonstrate that there is not a single "correct" graph to learn, and the additional flexibility of observable graphs introduced above is necessary. (a) and (b) also make it clear, that it should be carefully specified what _should be learned_ for a particular application and what _could be learned_ (see Sec. 3.1), and what a specific algorithm _will_ learn (see Sec. 4.2). Finally, CD heavily relies on restricting the search space for separating sets to adjacencies, which becomes non-trivial in sight of (c). We will return to (d) momentarily.

In our setup, the context indicator is _given_ by the user. The context indicator can either arise naturally from the problem setting, or it can be the result of preprocessing using anomaly or regime detection methods (see also Sec. F.2). Since the indicator is chosen, it becomes important to understand which context indicator makes for a _good choice_ in view of the problems illustrated above. A core contribution of our work is to understand which assumptions about the model, including the choice

Figure 2: Left: An example of an SCM where the physical and descriptive graphs are the same. Right: an example of an SCM where the physical and descriptive graphs differ, c.f. the “support problem”. For \(G^{}\), \(R\) is not shown, as it is a constant per dataset, and links with other variables will not be found. Context specific graphs depend on the value \(r\) of \(R\) and are summarized in a single diagram containing a solid edge for edges that are present in both contexts, and a dashed edge for edges that are present for exactly one of the two contexts.

of context indicator, prevent drawing wrong conclusions. We give suitable assumptions to make the problem tractable and the result interpretable (in terms of SCMs) in Sec. 3.3 based on observation (d).

### Assumptions

We now define the assumptions that a proper context indicator must fulfill such that our causal discovery method yields meaningful results. These _regime sufficiency assumptions_ are described below and further formalized in Sec. C; the general approach and the naming are inspired by observation (d) made above and its resemblance to causal sufficiency.

**Sufficiency assumptions regarding the context indicator** The support problems in Example 3.2 (ii) occur if the qualitative change in the causal mechanisms does not involve the observed context indicator \(R\) directly, cf. (d). Therefore, we define the **strong context-sufficiency** assumption (Def. C.1), which enforces that the qualitative changes in the graph involve \(R\) directly as displayed in Example 3.1. We also define **single-graph-sufficiency** (Def. C.2), which enforces that certain context-specific graphs collapse to the same graph. This is a weaker assumption than the strong sufficiency above, see Cor. C.1, but still suffices to proof soundness of our algorithm and even allows for a strong interpretation of results as encoding physical changes; this is thus a technically better, albeit less intuitive and potentially harder to verify directly, assumption.

The reduced search space for CSI, cf. (c) in Sec.3.2, happens already under the assumption of **weak context-sufficiency** (Def. C.3), which formalizes dependence on \(R\) in the weak sense of being adjacent in the graph. This is yet a weaker assumption, see Cor. C.2, still ensures useful output from our algorithm (Rmk. D.2), but does not allow for a strong (physical) interpretation of the results anymore. These assumptions mirror the causal sufficiency assumption: They exclude hidden contexts and lead to fewer CITs and a stronger interpretation of results as physical changes. We further discuss the hierarchy of these assumptions in Sec. C.1.

**Additional assumptions** We assume **causal sufficiency** (Def. C.4, no hidden confounders). Furthermore, we require at least **weak (descriptive) context-acyclicity** (Def. C.5), i.e., \(G^{}_{R=r}\) is a DAG (acyclic) for all \(r\). In practice, we assume **strong (descriptive) context-acyclicity** (Def. C.5), meaning there are further no cycles involving any ancestors of \(R\) (including \(R\) itself) in the union graph. Efficient discovery with our method requires directed cycles of length \( 2\), as discussed in Sec. D.7, Sec. D.8. We assume that \(R\) is a categorical variable which takes finitely many values \(r\) with \(P(R=r)>0\).

## 4 Causal discovery with endogenous context variables

We propose a method to discover context-specific graphs and their corresponding union graph which extends the PC(-stable) algorithm [(31; 4)] with a novel adaptive testing strategy. In Sec.4.2 we will connect the output of our method to the graphical objects defined in 3.1. In particular, under suitable sufficiency assumptions the output is precisely \(G^{}_{R=r}\). The approach is not specific to PC but could also be used with other constraint-based algorithms.

### Method

Formal details are given in Sec. 4.2. First observe that for physical changes (edges in \(G^{}\) not in \(G^{}_{R=r}\)) or under weak context-sufficiency (Def. C.3), the only changes in \(G^{}_{R=r}\) relative to the union graph occur downstream of the context indicator, more precisely in the adjacencies of its children (lemma C.4). On the other hand, spurious links due to selection bias occur upstream of the context indicator (cf. Sec.3.2). By either of the context-acyclicity assumptions introduced above, these two cases are mutually exclusive. Skeleton discovery has to find a valid separating set \(Z\) to remove any edge \(X\) to \(Y\) which is not in the context-specific \(G^{}_{R=r}\). By assuming an appropriate version of faithfulness, the decision between independence testing on the context-specific data or on the pooled data does not matter for all other candidates \(S\) for \(Z\), as long as we decide correctly for (one) valid \(S\). On the other hand, under causal sufficiency a valid \(S_{0}(Y)\) exists by a suitable Markov-property. Thus \(R S_{0}\) implies \(R\) is a parent of \(Y\) and we are in the first case, thus should test on the context-specific data. By mutual exclusiveness, we can consistently do so without the risk of selection bias. Conversely \(R S_{0}\) implies \(R\) is not a parent of \(Y\), and there is no context-specificinformation to be obtained here; thus testing on the pooled data is consistent (it does not loose information), avoids selection-bias (\(X\) and \(Y\)_could_ be ancestors of \(R\)) and uses all available data. Thus for the _valid_\(S_{0}\) we will by this decision rule always use the correct test.

```
1:Input: Context indicator \(R\), Samples for \(X_{1},...,X_{D},X_{R}=R\)
2:Output: Context-specific graphs \(G_{R=r} r\{1,...,n_{r}\}\)
3:for\(r=1\) to \(n_{r}\)do
4: Initialize \(G_{R=r}\) as fully connected graph
5:for\(espest_{size}=0\) to \(D-1\)do
6:for each \(j\{1,,D,R\}\)do
7:for each \(i(X_{j})\) and \(S(X_{j})-\{i\}\) with \(\#S=espest_{size}\)do
8: Test \(X_{i}\!\!\! X_{j}|S R,R=r\) if \(R S\), else test \(X_{i}\!\!\! X_{j}|S\) on pooled data
9:if independence is found then
10: Remove edge \(X_{i}-X_{j}\) from \(G\)
11: Orient edges as in PC algorithm
12:return\(\{G_{R=r} r\{1,...,n_{r}\}\}\) ```

**Algorithm 1** Adaptive CD for Discovering Context-Specific Graphs with Endogenous Context Variables

**Discovering context-specific graphs** First, we discover \(G_{R=r}\) which, under the assumptions of Thm. 1, agrees with both the descriptive and the physical graph. For a fixed context value \(R=r\), we adapt the skeleton phase of the standard PC algorithm described in (4) to test on the pooled data whenever \(R\) is not in the conditioning set. Whenever \(R\) is in the conditioning set, the algorithm tests \(X\!\!\! Y|,R=r\) instead of \(X\!\!\! Y|,R\), as described in Algorithm 1.

**Obtaining the union graph** To obtain the union graph, we combine the information about the edges in all context-specific graphs as follows: If the edge from \(X\) to \(Y\) is found in none of the context-specific graphs, then no edge is added to the union graph. If an edge \(X Y\) was found in any of the context-specific graphs, then the directed edge is added to the union graph. The resulting graph may contain both the edge \(X Y\) and the edge \(X Y\). See also Sec. D.14.

**Scaling properties** We study univariate context indicators, but our approach allows multiple indicators. A discussion on the time complexity of our algorithm for this case can be found in Sec. D.9.

### Theoretical results

**Markov properties** The Markov property ensures that _links that should be removed, are removed_ from suitable independence relations.

**Lemma 4.1**.: _Assume strong context-acyclicity, causal sufficiency and single-graph-sufficiency. If \(X\) and \(Y\), both \(X,Y R\), with \(Y_{R=r}^{}(X)\) (this is not a restriction by context-acyclicity, rather fixes notation), are not adjacent in \(G_{R=r}^{}\), then there is \(Z_{R=r}^{}(Y)\) such that: If \(Y\) is neither part of a directed cycle in the union graph (union cycle) nor a child of \(R\) in the union graph (union child), then (a) \(X\!\!\! Y|Z\), otherwise (b) \(X\!\!\! Y|Z,R=r\)._

**Remark 4.1**.: If either \(X=R\) or \(Y=R\), then there is no per-context test available. In this case, we fall back to the standard result: If \(X\) and \(Y\) are not adjacent in \((G^{})\), then there is \(Z_{R=r}^{}(Y)\) or \(Z_{R=r}^{}(X)\) such that \(X\!\!\! Y|Z\) (see Sec. D.4).

The full proof can be found in Sec. D.3. The idea is as follows: Case (a) is relatively standard and follows by a "path-blocking" argument (37). We focus on case (b), proved in three steps:

**(i)** Assuming single-graph-sufficiency, \(G_{R=r}^{}\) agrees with the graph that would have been observed if \(R\) had been intervened to \(r\). This graph is, in a standard way, associated to the intervened SCM. Thus, the usual Markov property holds (20, Prop. 6.31 (p. 105)), and independence in that SCM, see (iii), is reduced to d-separation in the context-specific graph. **(ii)** For the cases excluded by case (a), \(_{R=r}^{}(Y)\{R\}\) is always a valid d-separating set (D.2). **(iii)** The intervened model observed under the noises \(_{i}\) of the original SCM, has a counterfactual distribution (Sec. D.2) and by standard results (16, cor. 7.3.2 (p. 229)), the counterfactual independence \(X_{r}\!\!\! Y_{r}|Z_{r},R_{r}=r\) implies \(X\!\!\! Y|Z,R=r\).

**Faithfulness properties** The faithfulness property ensures that _links that should remain in the graph, do remain in the graph_ and are not erroneously deleted due to ill-suited independence relations. A probability distribution \(P\) is faithful to a DAG \(G\) if independence \(X_{P}Y|Z\) with respect to \(P\) implies d-separation \(X_{G}Y|Z\) with respect to \(G\). This means that, if \(G^{} G\) is (strictly) sparser, then faithfulness to \(G^{}\) is (strictly) weaker than faithfulness to \(G\). Now, \(G_{R=r}^{} G^{}\), so "\(P_{M}()\) is faithful to \(G_{R=r}^{}\)" is weaker than the standard assumption "\(P_{M}()\) is faithful to \(G^{}\)". Similarly (excluding links involving \(R\)), \(_{R=r}^{}\) is sparser than what one would expect for a graph of the conditional model (there are no edges induced by selection bias \(_{R=r}^{}\)), so "\(P_{M}(|R=r)\) is faithful to \(_{R=r}^{}\)" is also weaker than expected. The hypothesis of the following lemma is thus unconventional but not particularly strong. This lemma is proved in Sec. D.5.

**Lemma 4.2**.: _Given \(r\), assume both \(P_{M}\) is faithful to \(G_{R=r}^{}\) and \(P_{M}(|R=r)\) is faithful to \(_{R=r}^{}\) (we will refer to this condition as \(r\)-faithfulness, or \(R\)-faithfulness if it holds for all \(r\)). Then:_

\[ Z\{X\!\!\! Y|Z \\ X,Y RX\!\!\! Y|Z,R=r\}  XYG_{R=r}^{}.\]

**Soundness of the algorithm**_The proposed algorithm recovers a meaningful graph._ Our algorithm is (descriptively) sound (Rmk. D.2) but would not be complete without the sufficiency assumptions introduced in Sec. 3.3. Moreover, the strong- or single-graph-sufficiency makes our algorithm discover the physical graph soundly.

**Theorem 1**.: _Assume causal sufficiency, single-graph-sufficiency, \(r\)-faithfulness and strong context-acyclicity with minimal union cycles of length \( 2\) (edge-flips). In the oracle case (if there are no finite-sample errors during independence testing), algorithm 1 recovers the skeleton of \(G_{R=r}^{}=G_{R=r}^{}\)._

The detailed proof is in Sec. D.6. Restricting cycles to edge flips is necessary to avoid the problems discussed in Sec. D.7 and Sec. D.8. Together with the context-acyclicity assumption, it ensures that all nodes involved in union cycles are union children of \(R\), and thus all edges pointing at union cycles are tested on context-specific data, avoiding problems with acyclifications (see Rmk. 4.1 and (2)). The proof itself consists of three parts: **(i)** Testing _all_ subsets \(Z(Y)\) as separating sets finds all missing links by the Lemma 4.1. This follows from context-sufficiency and the restricted form of cycles. **(ii)** The algorithm actually does test all such subsets \(Z(Y)\). Identical to the argument for the PC algorithm. **(iii)** We do not remove too many edges. This follows directly from Lemma 4.2.

## 5 Simulation study

### Experimental setup

**Data generation** Our data models are created by first randomly generating a linear acyclic SCM with up to \(D+1\) nodes (base graph) of the form \(X^{i}=_{j}^{D+1}a_{ij}X^{j}+c_{j}^{j}\), where \(i=1,,D+1\), at a desired sparsity level \(s\). One of the nodes is randomly selected as the context indicator \(R\). To obtain categorical context indicators for the \(n_{}-1\) context-specific SCMs, thresholding is applied by taking the \(n_{}-1\) quantiles of the continuous values of \(R\), adjusted using a data imbalance factor \(b\). To generate a context-specific SCM, \(n_{}\) links of the base graphs are edited sequentially by selecting a variable randomly (excluding the context indicator), adding, removing, or flipping an edge to this variable and ensuring it is a child of \(R\) by adding an edge from \(R\) to it (and in the case of edge flips, also to the node at the other end of the edge). These operations lead to a non-linear relationship between the context indicator and the other variables. We enforce the presence or absence of cycles in the union graph. The data generation approach is detailed in Sec. E.1.

**Evaluated methods** We compare our method, named PC-AC (AC is short from "adaptive context"), to a variant where PC-stable is applied on each context-specific dataset separately by masking, denoted by PC-M. We expect PC-M to have a higher false positive rate (FPR) due to selection bias, and a lower true positive rate (TPR), as links involving the context indicator cannot be found using the masked data. We also compare our algorithm to PC-stable applied on the pooled dataset, named PC-P, which only recovers joint information, i.e., union graphs. We expect PC-P to have a slightly higher TPR, as it tests all links on all data points. PC-P should not suffer from selection bias, thus, the FPR of PC-P should be lower than that of PC-M for acyclic union graphs. For cyclic union graphs, PC-P only finds the acyclification, thus, the FPR should asymptotically remain finite. We also compare to abaseline method, named PC-B: For each context, we compute the intersection of the links found by PC-M and PC-P and then add the links found using PC-P for \(R\). PC-B should converge asymptotically toward the true graph (see Sec. D.10). However, as PC-B runs more tests overall, PC-AC should have better finite-sample properties. As we do not control for cycle length, the performance of PC-AC might be affected by large cycles, as discussed in Sec. D.7 and Sec. D.8. We obtain union graphs for PC-M and PC-B using the unionization approach from Sec. 4. We also compare union graphs from two methods which test on pooled data: FCI-JCI0 (32; 15) and CD-NOD (39). We do not compare to other methods that obtain context-specific graphs, as they assume exogenous context indicators. A fair comparison to our algorithm is hard to realize due to our assumptions and a lack of available methods suitable to this problem. We compare computational runtimes in App. E.4.

We present results where \(D+1=8\) and density \(s=0.4\). For all \(j\), \(^{j}(0,1)\). We draw the non-zero \(a_{i,j}\) randomly from \(\{1.8,1.5,1.2,-1.2,-1.5,-1.8\}\), and set \(c_{j}=1\) for all \(j\). For the context indicator \(R\), we set \(c_{R}=0.2\). We discuss results with and without enforced cycles. For the configurations without cycles, we apply only the _remove_ operation (see Sec. E.1). The dataset presented here is balanced in the number of samples for each \(r\), i.e., \(b=1\). A challenge of our experimental setup is that non-linear relationships between continuous variables and the categorical \(R\) must be tested (see also App D.11). Non-parametric permutation-based tests for mixed-type data with non-linear relationships exist (13; 38; 21), but are computationally expensive. Therefore, we apply a parametric mixed-type data test (35) for most experiments. For a fair comparison, we run versions of the algorithms with so-called link assumptions, where the adjacencies of \(R\) are either partially or fully known, i.e., we input the (directed) links to or from \(R\) (adj. \(R\)-all), or the (directed) links from \(R\) to its children (adj. \(R\)-ch.), or test without known links (adj. none). For all tests involving only continuous variables, we use partial correlation. When testing pooled data, the link from a regressed-out variable might be missing in one of the contexts, but partial correlation tests should still work, as discussed in Sec. D.12. We show results for "adj. \(R\)-ch." and "adj. none" and postpone results with "adj. \(R\)-all" to Sec. E.3. Here, we discuss the TPR and FPR for the union and context-specific graphs (averaged across contexts) but also evaluate edgemark precision and recall in Sec. E.3. Error bars are generated using Bootstrap with \(200\) iterations. We repeat each experiment \(100\) times, however, the graph generation is not always successful. We evaluate how well our method scales, e.g., with different \(D,s\) and \(b\) in Sec. E.3. The code, based on causal-learn (40) and Tigramite (25), and details for replication (random seeds) can be found here: https://github.com/oanaipopescu/adaptive_endogenous_contexts.

### Results

Figure 3: Results for our algorithm PC-AC (adaptive context, our method), PC-M (masking), PC-B (baseline), and PC-P (pooled) on the setup described in Sec. 5.1. Dotted lines indicate settings where links from the context indicator \(R\) to its children are fixed / known (adj. \(R\)-ch.), solid lines indicate no prior knowledge about links (adj. none). The left panel shows results using a parametric CIT, the right panel shows results for the same setting with "adj. none" using a non-parametric CIT.

The left plot of Fig. 3 shows results for the experimental setup described in Sec. 5.1**without cycles**. For individual contexts, our method outperforms PC-M in terms of FPR for both link assumption cases. Without any link assumptions, the FPR for both PC-B and PC-AC increase significantly. We test whether this is due to the testing problem (Sec. D.11) by using a non-parametric CIT (21). Results in the right plot of Fig. 3 show that the FPR is significantly lowered for all methods. For PC-M, the union graph FPR is high compared to the context-specific FPR, as, for the individual context graphs, the links between context indicator and system variables cannot be found (as \(R\) is a constant). Still, false positives can appear in the union graph due to selection bias. Our method performs best in terms of TPR and FPR on union and context-specific graphs with context children link assumptions and without link assumptions. PC-B performs slightly worse due to its finite-sample properties. However, with fully known context-system links (Fig. 4 in Sec. E.3.1), masking finds more links overall, having the best TPR, but also higher FPR, followed by PC-AC, PC-B, and PC-P. Results for the same setup as in Sec. 5.1**with enforced cycles** in the union graph (Fig. 6 in Sec. E.3.2) show similar behavior of the TPR and FPR, albeit some differences are less pronounced, possibly since the complexity of the problem increases. As expected, the FPR for PC-P, which detects only the acidification, increases. We observe that for all versions without link assumptions, the FPR increases significantly compared to the setup without cycles. Larger differences in FPR between PC-M and PC-AC can be seen for samples up to \(2000\). Regarding TPR, PC-AC and PC-B perform best for the context-specific graphs, especially without any link assumptions. Results for the comparison with FCI and CD-NOD for the **union graphs**, detailed in Sec. E.3.3, show that our method slightly outperforms CD-NOD, which assumes acyclicity. Our method outperforms FCI in terms of TPR, but FPR is lower for FCI.

## 6 Discussion and conclusion

In this work, we have introduced a novel method for causal discovery (CD) of context-specific graphs and their union in the presence of a (possibly) endogenous context indicator. We propose a simple modification of the PC algorithm, but our method can be combined with any other constraint-based CD algorithm. Our approach provides an elegant and efficient solution to the problem of selection bias. Further, we discuss how to formally link context-specific independence (CSI) relations to structural causal models (SCMs); to this end we introduce novel graphical objects and assumptions and prove the soundness of our algorithm. We discuss the theoretical and practical limitations to recovering the true graphs, e. g. in presence of large cycles (D.7). Our method has a lower FPR than applying CD on each context individually, which can suffer from selection bias; it displays better finite-sample performance than a proposed baseline method. Our method is comparable with CD-NOD (39) and FCI (28) on the union graphs, but additionally provides context-specific information.

**Limitations** Our method requires that the context indicator \(R\) is observed and chosen appropriately, as discussed in Sec. 3.2; it can handle some union cycles, but not reliably so for large union cycles, see Sec. D.8. Without prior knowledge about adjacencies of \(R\), our method has difficulties to significantly outperform pooled methods and to keep up with the baseline in numerical tests; this is likely due to the CIT problem discussed in Sec. 5.2, an interpretation supported by a smaller experiment with a non-parametric CIT (Fig. 3, right panel). We thus believe that the problem can be solved using appropriate CITs. Finite sample errors incur further propagated errors similar to standard CD; errors involving links to \(R\) additionally lead to a regression to standard CD concerning context-specific information (see App D.13). In this work, we have assumed causal sufficiency, however, real-world data often contains hidden confounders.

**Future work** We have mainly focused on skeleton discovery and omitted a detailed study of orientation rules. Algorithms such as FCI and CD-NOD already perform well for edge orientations of the union graph, as small experiments in Sec. E.3.3 indicate. But there also seem to be additional edge orientations available only by combining per-context information (see Sec. F.1 for an example), a possibility also mentioned in (9); these orientations can be beyond what can be concluded even with JCI arguments. In practice, contexts are often assigned by thresholding, so an extension to contexts given as deterministic functions of observed variables (see Sec. F.2.2)is of interest. Similar remarks apply to anomaly-detection outputs, defining normal and anomalous contexts. The assumption of causal sufficiency simplifies the arguments, but does not seem strictly necessary; it likely can be relaxed in future work. Finally, our method is in principle extendable to the time-series case. Particularly when allowing for contemporaneous relations of the context indicator, selection bias is a non-trivial problem for time-series.