# Smoothed Online Learning for Prediction in Piecewise Affine Systems

Adam Block

Department of Mathematics

MIT

ablock@mit.edu

&Max Simchowitz

CSAIL

MIT

msimchow@csail.mit.edu

Russ Tedrake

CSAIL

MIT

###### Abstract

The problem of piecewise affine (PWA) regression and planning is of foundational importance to the study of online learning, control, and robotics, where it provides a theoretically and empirically tractable setting to study systems undergoing sharp changes in the dynamics. Unfortunately, due to the discontinuities that arise when crossing into different "pieces," learning in general sequential settings is impossible and practical algorithms are forced to resort to heuristic approaches. This paper builds on the recently developed _smoothed online learning_ framework and provides the first algorithms for prediction and simulation in PWA systems whose regret is polynomial in all relevant problem parameters under a weak smoothness assumption; moreover, our algorithms are efficient in the number of calls to an optimization oracle. We further apply our results to the problems of one-step prediction and multi-step simulation regret in piecewise affine dynamical systems, where the learner is tasked with simulating trajectories and regret is measured in terms of the Wasserstein distance between simulated and true data. Along the way, we develop several technical tools of more general interest.

## 1 Introduction

A central problem in the fields of online learning, control, and robotics is how to efficiently plan through piecewise-affine (PWA) systems. Such systems are described by a finite set of disjoint regions in state-space, within which the dynamics are affine. In this paper, we consider the related problem of learning to make predictions in PWA systems when the dynamics are unknown. While recent years have seen considerable progress around our understanding of linear control systems, the vast majority of dynamics encountered in practical settings involve nonlinearities. Learning and predicting in nonlinear systems is typically far more challenging because, unlike their linear counterparts, the dynamics in a local region of a nonlinear system do not determine its global dynamics.

PWA systems allow for discontinuities across the separate regions ("pieces"), and are thus a simplified way of modeling rich phenomena that arise in numerous robotic manipulation and locomotion tasks , such as modeling dynamics involving contact. In addition, deep neural networks with ReLU activation  are PWA systems, providing further motiviation for their study. Already, there is a computational challenge simply in optimizing an objective over these systems, which is the subject of much of the previous literature. Here, we take a statistical perspective, assuming that we have access to effective heuristic algorithms for this optimization task, as is common in online learning . Uniformly accurate learning of the dynamics across all pieces is typically impossiblebecause some regions of space require onerous exploration to locate; thus, we instead consider an iterative prediction setting, where at each time \(t\), the learner predicts the subsequent system state. From this, we extend to prediction of entire trajectories: over episodes \(t=1,,T\), a learner suggests a policy \(_{t}\), and the learner attempts to learn the dynamics so as to minimize prediction error along the trajectory \(_{}\) induces. This is motivated by iterative learning control, where our notion of error is an upper bound on the discrepancy between the planner's estimate of policy performance and the ground truth.

Our iterative formulation of the learning problem is equivalent to the regret metric favored by the online learning community, and which has seen application to online/adaptive control and filtering problems in recent work. Critically, regret does not require uniform identification of system parameters, which is typically impossible. The key pathology is that policies can oscillate across the boundary of two regions, accruing significant prediction error due to sharp discontinuities of the dynamics between said regions, a problem well-known to the online learning community . Moreover, this pathology is not merely a theoretical artifact: discontinuities and non-smoothness pose significant challenges to planning and modeling contact-rich dynamics such as those encountered in robotic manipulation .

Our solution takes inspiration from, and establishes a connection between, two rather different fields. Recent work in the robotics and control communities has relied on _randomized smoothing_ to improve planning across discontinuous and non-smooth dynamics . Additionally, the online learning community has studied _smoothed online learning_, which circumvents the threshold-effect pathologies described above. We show that, if the dynamics and the control inputs are subject to randomized smoothing, low regret becomes achievable. We note that the randomized smoothing approach is in some sense canonical in mitigating the aforementioned pathology of policies that oscillate across the boundaries of two regions; smoothing prohibits this pathology by ensuring that the system is generally far from these boundaries. More importantly, our proposed no-regret algorithm is _efficient_ in terms of the number of calls to an optimization oracle, a popular notion of computational efficiency in the online learning community . In our setting, the optimization oracle required finds the _best-fit_ PWA system to a batch of given data. Though this problem is intractable , there is a rich literature of popular heuristics . Unlike those works, we examine the _statistical challenge_ of generalization to novel data given such an oracle. We remark that in many practical cases, our smoothness assumption comes for free, in the sense that the Gaussian noise used to smooth gradients in Suh et al.  is already sufficient for our results to hold.

Contributions.A formal description of our setting is deferred to Section 2. Informally, we consider the problem of prediction in a PWA system over a horizon of \(T\) steps, where the regions are determined by intersections of halfspaces; we obtain prediction in PWA dynamical systems as a special case. We aim to achieve sublinear-in-\(T\) excess square-loss error (_regret_) of \(O(T^{1-})\) with respect to the optimal predictor which knows the system dynamics, where \(>0\) is constant and the prefactor on the regret is at most polynomial in all of the problem parameters. Our result is derived from a general guarantee for online piecewise affine regression, which subsumes the online PWA identification setting. We show that, when the dynamics and the control inputs are subject to randomized smoothing satisfying the \(_{}\)-directional smoothness condition introduced by , our regret bound is polynomial in \(_{}\), dimension, and other natural problem parameters. While the exact dependence on horizon may be far from optimal, we emphasize that our algorithm is the first to achieve regret even polynomial in all parameters in the difficult setting of PWA systems. Moreover, our work provides the first regret bound with polynomial dependence in dimension for oracle-efficient smoothed online learning in the sense of Hazan and Koren  of a noncontinuous function class without a realizability assumption and allowing for process noise. As a further application, we adapt our algorithm to make predictions, at each time \(t\), of the trajectory comprising the next \(H\) steps in the evolution of the dynamical system. We bound the _simulation regret_, the cumulative error in Wasserstein distance between the distribution of our proposed trajectory and that of the actual trajectory. Assuming a Lyapunov condition, we demonstrate that our modified algorithm achieves simulation regret \(O((H) T^{1-})\), which allows for efficient simulation.

Key challenges.As noted above, vanishing regret in our setting is impossible without directional smoothness due to discontinuity in the regressors between different regions. The key challenge is to leverage smoothness to mitigate the effect of these discontinuities. Note that, if the learner were to observe the region in addition to the state, regression would be easy by decomposing the problem into \(K\) separate affine regression instances; the difficulty is in minimizing this approach _without explicit labels indicating which points are in which regions._ We remark that were we to care only about low regret without regard to efficiency, a simple discretization scheme of size exponential in dimension coupled with a standard learning from experts algorithm  can achieve low regret; realizing an oracle-efficient algorithm is significantly more challenging.

We adopt a natural, epoch-based approach by calling the optimization oracle between epochs, estimating the underlying system, and using this estimate to assign points to regions in the subsequent epoch. This introduces three new challenges, each of which requires substantial technical effort to overcome. First, we need to control the performance of our oracle on the regression task, which we term _parameter recovery_ below. Second, we must enforce consistency between regions learned in different epochs, so that we can predict the correct regions for subsequent covariates; doing this necessitates an intricate analysis of how the estimated parameters evolve between epochs. Finally, we need to modify the output of our oracle to enforce low regret with respect to the classification problem of correctly predicting which mode we are in on as yet unseen data.

Our techniques.Our algorithm proceeds in epochs, at the end of each of which we compute a best-fitting piecewise affine approximation to available data by calling the Empirical Risk Minimization (ERM) oracle. The analysis of this best-fit shows that we recover the parameters and decision boundaries of the associated regions ("pieces") frequently visited during that epoch. By the pigeonhole principle, this ultimately covers all regions visited a non-neglible number of times \(t\) over the horizon \(T\). Here, we leverage a careful analysis based on two modern martingale-least squares techniques: the self-normalized concentration bound  for establishing recovery in a norm induced by within-region empirical covariance matrices, and the block-martingale small-ball method  to lower-bound the smallest eigenvalues of empirical covariances with high probability. In addition, we introduce and bound a new complexity parameter, the _disagreement cover_, in order to make our statements uniform over the set of possible decision boundaries.

After the estimation phase, each epoch uses this estimate to make predictions on new data as it arrives. The key challenge is classifying the region to which each newly observed data point belongs. Without smoothing, this can be particularly treacherous, as points on or near to the boundary of regions can easily be misclassified and the correct predictions are discontinous. To leverage smoothing, we propose a reduction to online convex optimization on the hinge loss with lazy updates and show, through a careful decomposition of the loss, that our classification error can be controlled in terms of the assumed directional smoothness. Combining this bound on the classification error with the parameter recovery described in the preceding paragraph yields our sublinear regret guarantee.

We instantiate one-step prediction as a special case of the more general online linear regression problem, showing that the approach described above immediately applies to the first problem under consideration. Finally, in order to simulate trajectories, we use the learned parameters in the epoch to predict the next \(H\) steps of the evolution. We then use the fact that our main algorithm recovers the parameters defining the PWA system to show that simulation regret is bounded, which solves the second main problem and allows for simulation in such systems.

### Related Work

**System Identification.**  System-identification refers to estimating the governing equations of a dynamical system. The special case of linear dynamical systems is classical [37; 38; 16], and more recent work has provided finite-sample statistical analyses in many regimes of interest [54; 15; 43; 61; 63]. Estimation for non-linear systems has proven challenging, and has been studied most in the setting where the dynamics involve a known and smooth nonlinearity [39; 51; 20], or where only the observation model is nonlinear [14; 42].  study _Markov jump systems_, where the system dynamics alternate between one of a finite number of linear systems ("modes"), with switches between modes governed by a Markov chain. PWA systems are thus an attractive intermediate step between the simple linear setting and the intractable general case. To our knowledge, ours is the first work to tackle piecewise affine dynamics in full generality, where the system mode is determined by the system state.

Despite its worst-case computational intractability , there is a rich literature of heuristic algorithms for computing the best-fit PWA system to data; see the surveys  and , which compare various approaches, notably the clustering method due to . These references focus strictly on the _algorithmic_ facets of computing a best-fit given an existing data set. We instead abstract the computation of a best-fit into an ERM oracle in order to focus on the _statistical_ considerations.

Online Learning and Smoothing. The study of online learning is now classical, with a small sample of early works including Littlestone , Freund and Schapire . More recently, a general theory of online learning matching that which we have in the statistical learning setting was built up in Rakhlin et al. , Rakhlin and Sridharan , Rakhlin et al. , Block et al. , with Rakhlin and Sridharan  characterizing the minimax regret of online regression. Due to the robustness and generality of this adversarial model, many problems that are trivial to learn in the statistical setting become impossible in the adversarial regime. Thus, some work  has sought to constrain the adversary to be _smooth_, in the sense that the adversary is unable to concentrate its actions on worst-case points. In addition, Block and Simchowitz , which introduces the notion of directional smoothness to control the regret in a realizable, online classification problem; realizability, here, means that there is no process noise in the sense that there exists some piecewise affine function that perfectly predicts all targets given the covariates. We also note that the algorithm in that paper is highly tailored to this realizable setting and thus is not at all robust to the noise considered in the present paper. Of particular note is the concurrent work of Block et al. , which solves a similar problem with a stronger oracle. Note that in that paper, the oracle assumption is strong enough to break the lower bound of Hazan and Koren , while in this work we use the much weaker oracle assumption found in Hazan and Koren , Haghtalab et al. , Block et al. . This distinction is important because even in the standard (fully adversarial) online learning setting, there is a computational separation between these two oracle models in general, as per Agarwal et al. ; thus the fact that this separation does not apply to PWA systems given smoothness may be of independent interest.

Online Learning for Control.In addition to the recent advances in finite-sample system identification, a vast body of work has studied control tasks from the perspective of regret . While we do not consider a control objective in this work, we share with these works the performance metric of regret. Our work is more similar in spirit to online prediction in control settings , in that we also consider the task of next-step predictions under a system subject to control inputs.

Smoothing in RL and Control.One interpretation of the smooth online learning setting is that well-conditioned random noise is injected into the adversary's decisions. It is well known that such noise injection can be viewed as a form of regularization , and recent recent work in the robotics literature has shown that randomized smoothing improves the landscape in various robotic planning and control tasks . More broadly, randomization has been popular for computation of zeroth-order estimates of gradients, notably via the acclaimed policy-gradient computation .

## 2 Setting

In this section, we formally describe the problem setting of online PWA regression. We suppose there is a ground truth classifier \(g_{}:^{d}[K]\) and matrices \(_{i}^{} i[K]_{i}^{ }^{m(d+1)}}\) such that

\[_{t}=_{i_{t}}^{}}_{t}+ _{t}+_{t}, i_{t}=g_{}(}_{t}), }_{t}=[_{t}^{}|1]^{},|| _{t}||_{}, \]

where, \(_{t}^{d}\) are covariates, \(_{t}^{m}\) are responses, \(_{t}^{m}\) are zero-mean noise vectors in \(^{m}\), \(_{t}\) are (small) non-stochastic corruptions with norm at most \(_{} 1\), and \(i_{t}[K]\) are the regression modes, which depend on the covariates \(_{t}\). The extension to \(}_{t}\) accomodates affine regressors. We suppose that the learner has access to pairs \((_{t},_{t})\) but, critically, does not know the regression modes \(i_{t}\). We do however suppose that \(g_{}\) is an _affine classifer_; that is \(g^{}=_{1 i K} <_{i},>+b_{i}}\), where \(_{i} S^{d-1}\) is the unit sphere and \(b_{i}[-B,B]\). It can be shown that many natural physical systems are indeed modeled as PWA with affine boundaries , and the closed loop dynamics for model-predictive control (MPC) in these cases is also a PWA system . We will assume throughout access to an empirical risk minimization oracle, ErmOracle, which satisfies the following guarantee:

**Assumption 1** (ErmOracle guarantee).: _Given data \((}_{1:s},_{1:s})\), ErmOracle returns \(\{}_{i}|i[K]\},\) satisfying_

\[_{t=1}^{s}||}_{(_{t} )}}_{t}-_{t}||^{2}-_{g, \;\{_{i}|i[K]\}}_{t=1}^{s}||_{g( _{t})}}_{t}-_{t}||^{2} _{}. \]

While such an oracle is not computationally efficient in the worst case , there are many popular heuristics used in practical situations . The learner aims to construct an algorithm, efficient with respect to the above oracle, that at each time step \(t\) produces \(}_{t}\) such that

\[_{T}:=_{t=1}^{T}\|}_{t}-_{g _{}(}_{t})}^{}}_{t}\|^{2}=o(T). \]

This notion of regret is standard in the online learning community and, as we shall see, immediately leads to bounds on prediction error.

Directional Smoothness.As previously mentioned, without further restriction, sublinear regret is infeasible, as formalized in the following proposition:

**Proposition 1**.: _In the above setting, there exists an adversary with \(m=d=1\), K=2, that chooses \(^{}\) and \(g_{}\), as well as \(_{1},,_{T}\) such that any learner experiences \([_{T}]\)._

Proposition 1 follows from a construction of a system where there is a discontinuity across a linear boundary, across which the states \(_{t}\) oscillate. The bound is then a consequence of the classical fact that online classification with linear thresholds suffers linear regret; see Appendix B.1 for a formal proof, included for the sake of completeness. Crucially, a discontinuity in the dynamics necessitates an \((1)\) contribution to regret each time the decision boundary is incorrectly determined. To avoid this pathology, we suppose that the contexts are smooth; however, because standard smoothness  leads to regret that is exponential in dimension , we instead consider a related condition, "directional smoothness."1

**Definition 2** (Definition 52 from Block and Simchowitz ).: _Given a scalar \(_{}>0\), a random vector \(\) is called \(_{}\)-directionally smooth if for all \( S^{d-1}:=\{w^{d}:\|w\|=1\}\), \(c\), and \(>0\), it holds that \((|,-c|) /_{}\)._

As an example, for any vector \(_{t}\), if \(_{t}(0,_{}^{2})\), then \(_{t}+_{t}\) is \(}}{}\)-directionally smooth; see Appendix C.1 for a proof and examples of directional smoothness for other noise distributions. Crucially, directional smoothness is _dimension-independent_, in contradistinction to standard smoothness, where we would only have \((_{}^{d})\)-smoothness (in the standard sense) in the previous example. We remark that directional smoothness is a weak condition that holds in many natural settings. Indeed, whenever noise is injected into the dynamics, directional smoothness will come for free. Such noise injection can occur when there is uncertainty in position, as is common in robotic applications; in this case, we can interpret this uncertainty itself as stochastic, which was the original motivation for smoothed analysis of algorithms . Further, note that while directional smoothness ensures the system spends little time close to a boundary, due to the discreteness in time, there is no restriction on the number of mode switches, which can be \((T)\) in general.

We defer further discussion of the assumption to Appendix C.1. We require our smoothness condition to hold conditionally:

**Assumption 2**.: _Let \(_{t}\) denote the filtration generated by \(_{1},,_{t}\). For all times \(t\), \(_{t}\) conditional on \(_{t-1}\) is \(_{}\)-directionally smooth._

Further Assumptions.Next, we make two standard assumption for sequential regression, one controlling the tail of the noise and the other the magnitude of the parameters.

**Assumption 3**.: _Let \(_{t}^{}\) denote the filtration generated by \(_{t}\) and \(_{1},,_{t-1}\) (equivalently, by \(_{t}\) and \(_{t},,_{t-1}\)). For all \(t\), it holds that \(_{t}\) is \(^{2}\)-sub-Gaussian conditioned on \(_{t}^{}\); in particular, \(_{t}\) is conditionally zero mean._

**Assumption 4**.: _We suppose that for all \(1 t T\), \(||}_{t}|| B\) and, furthermore, \(\|_{t}^{}\|_{} R\) for all \(i\). We will further assume that ErmOracle always returns \(}_{i}\) such that \(\|}_{i}\|_{} R\)._Finally, we assume that the true affine parameters are well-separated:

**Assumption 5**.: _There is some \(_{}>0\) such that for all \(1 i<j K\), it holds that \(\|_{i}^{}-_{j}^{}\|_{} _{}\)._

Note that Assumption 5 is, in a sense, generic, as explained in Remark 4 We defer the formal setting of one-step prediction and simulation regret to Appendix G.1 and section 3.1.

## 3 Algorithm and Guarantees

We propose Algorithm 1, an oracle-efficient protocol with provably sublinear regret and polynomial dependence on all problem parameters. Algorithm 1 runs in epochs: at the beginning of epoch \(\), the learner calls ErmOracle on the past data to produce a linear classifier \(_{}\) and estimates of the regression matrices in each mode, \(}_{,i}\). A major challenge is identifying the same affine regions between epochs. To this end, the learner permutes the labels of \(_{}\) to preserve consistency in labels across epochs, as explained informally in Section 4.2 and in greater detail in Appendix E.

```
1:Initialize Epoch length \(E\), Classifiers \(_{1:K}^{0}=(,,)\), margin parameter \(>0\), learning rate \(>0\)
2:for\(=1,2,,T/E\)do (\(}\) iterate over epochs)
3:\((}_{,i})_{1 i K}\), \(_{}(}_{1: E}, _{1: E})\)
4:\(_{}(_{},( {}_{,i})_{1 i K},(}_{- 1,i})_{1 i K})\)
5:\(_{1:K}^{ E}(_{1:K}^{(-1)E}, }_{(-1)E: E};_{},,)\)
6: Let \(_{}(})=_{1 i K}_{i}^{ E},}\) denote classifier induced by \(_{1:K}^{ E}\).
7:for\(t= E,,(+1)E-1\)do
8: Receive\(}_{t}\), and predict\(}_{t}=}_{,_{}(}_{t})}}_{t}\)
9: Receive\(_{t}\)
```

**Algorithm 1** Main Algorithm

The learner then runs online gradient descent (Algorithm 2) on the hinge loss to produce a modified classifier \(_{}\); finally, throughout the epoch, the learner uses \(}_{,i}\) and \(_{}\) to predict \(}_{t}\) before repeating the process in the next epoch. The reason for using a secondary algorithm to transform \(_{}\) into \(_{}\) is to enforce stability of the predictor across epochs, which is necessary to bound the regret. Again, we suppose that Assumption 1 holds throughout.

**Theorem 3** (Regret Bound).: _Suppose we are in the setting of online PWA regression (2.1) and Assumptions 2-5 hold. Then, if the parameters \(E,,\) are set as in (F.6), it holds that with probability at least \(1-\), \(_{}(},(1/ )) T^{35/36}+_{} T+K^{2} _{t=1}^{T}\|_{t}\|\), for \(}:=\{d,m,_{}^{-1},_{}^{-1},B,R,K,\}\), where the polynomial dependence is given in (F.7)._

**Remark 1**.: _While Theorem 3 requires that we are correctly setting the parameters of the algorithm, aggregation algorithms allow us to tune these parameters in an online fashion (see, e.g. )._

**Remark 2**.: _The misspecification errors \(}_{t}\) can be indicators corresponding to the \(}_{t}\) being in small, rarely visited regions; thus, we could run an underspecified ErmOracle, with \(K^{} K\) modes and recover a regret bound depending only on frequently visited modes._

When \(_{}=_{}=0\), we obtain exactly the polynomial, no-regret rates promised in the introduction. Along the way to proving our regret bound, we establish that ErmOracle correctly recovers the linear parameters within frequently visited modes.

**Theorem 4** (Parameter Recovery).: _Suppose that Assumptions 2-4 hold and let \(\{}_{}|i[K]\},\) denote the output of \((}_{1:T},_{1:T})\) and \(I_{ij}()\) denote the set of times \(t\) such that \((}_{t})=i\) and \(g_{}(}_{t})=j\). Then with probability at least \(1-\), for all \(1 i,j K\) such that \(|I_{ij}()|(},( )) T^{1-(1)}\) it holds that \(\|}_{i}-_{j}^{}\|_{}^{2}\) is bounded by \(}{|I_{ij}()|}(},()).\)_

Above we have given the result with the assumption that \(_{}=_{}=0\) for the sake of presentation; in the formal statement, the general case is stated. Theorem 4 implies that directional smoothness is sufficient to guarantee parameter recovery at a parametric rate, in marked distinction to most adversarial learning regimes. Before providing more detail on the algorithm and its analysis in Section 4, we discuss an application to \(H\)-step prediction. An application to one-step prediction with learner-provided controls can be found in Appendix G.1

### Guarantees for Simulation Regret

We now describe an application of our results to \(H\)-step prediction; more formal description is detailed in Appendix G.3. The learning process occurs in _episodes_\(t=1,2,,T\), consisting of steps \(h=1,2,,H\). In each episode, an external planner provides the learner a policy \(_{t}\). For simplicity, we assume that \(_{t}=(_{t,1},,_{t,H})\) is _open loop_ (state-independent) and stochastic, minimicking situations such as model predictive control; extensions are mentioned in Appendix G.6. With each episode, the true dynamics are given by

\[_{t,h+1}=_{t,h}^{*}_{t}+_{t,h}^{*} _{t,h}+_{t,h}^{*}+_{t,h}, i_{t,h}=g^{*}( _{t,h},_{t,h}). \]

We assume that the process noise \(_{t,h}\) are independently drawn from a known distribution \(\), and that \(_{t,1}\) is sampled from an arbitrary \(_{}\)-smooth distribution. At the start of episode \(t\), the learner then produces estimates \(}_{t},}_{t},_{t}\) and simulates the plan \(_{t}\) using the plug in estimate of the dynamics, i.e., \(}_{t;h+1}=}_{t,_{t,h}}}_{t,h}+}_{t,_{t,h}}_{t,h}+}_{t, {i}_{t,h}}}_{t,h},_{t,h}=_{t}(} _{t,h},}_{t,h})\), where \(}_{t,h}}}{{}}\), and \(}_{t,h}\) are an i.i.d. draw from the stochastic, open-loop policy \(_{t}\). Because the simulated and true processes use a different noise sequence, we consider the following notion of error, which measures the distance between the two _distributions_ induced by the dynamics, as opposed to the regret, which measure the distance between the realizations thereof. We choose the Wasserstein metric \(_{2}\), as it upper bounds the difference in expected value of any Lipschitz reward function between the true and simulated trajectories (see Appendix G.3 for a formal definition and more explanation).

**Definition 5** (Simulation Regret).: _Let \(_{2}(,)\) denote the \(L_{2}\)-Wasserstein distance, define the concatenations \(_{t,h}=(_{t,h},_{t,h})\) and \(}_{t,h}=(}_{t,h},}_{t,h})\), and let \(_{t}\) be the filtration generated by \(\{_{s,h}\}_{1 s t,1 h H}\). We define the \(T\)-episode, \(H\)-step simulation regret as \(_{T,H}:=_{t=1}^{T}_{2}(_{t,1:H}, }_{t,1:H}_{t-1})^{2}\)._

Our goal is to achieve \(_{T,H}(H) T^{1-(1)}\), but polynomial-in-\(H\) dependence may be challenging for arbitrary open-loop policies and unstable dynamics of the pieces. Thus, in the interest of simplicity, we decouple the problems of linear stability from the challenge of error compounding due to discontinuity of the dynamics by adopting the following strong assumption.

**Assumption 6**.: _There exists a known, positive definite Lyapunov matrix \(^{d_{t} d_{x}}\) that satisfies \((_{i}^{*})^{}(^{*})_{i}\) for all modes \(i[K]\)._

Using a minor modification of Algorithm 1, detailed in Algorithm 4, we show that we can get vanishing simulation regret, summarized in the following result:

**Theorem 6**.: _Suppose that we are in the setting of (3.1) and that Assumptions 2-5 and 6 hold. If we run a variant of Algorithm 1 (see Algorithm 4 in Appendix G.4), then with probability at least \(1-\), it holds that \(_{T,H}(},H)  T^{35/36}\)._

The proof of Theorem 6 with the exact polynomial dependence on the parameters can be found in Appendix G.3 and rests on a lemma showing that under Assumption 6, simulation regret at a given time \(t\) can be bounded as \((H)\) multiplied by the maximum one-step prediction error for times \(t,t+1,,t+H\), which is bounded in Theorem 3. We provide an exact recovery guarantee in the case \(H=1\) and without requiring Assumption 6 in Appendix G.1.

## 4 Analysis

In this section, we present a sketch of the proof of Theorem 15. There are two primary sources of regret: that which is due to poorly estimating the linear parameters within a mode and that which is due to misclassification of the mode. We analyze each source separately, beginning with the parameter recovery result of Theorem 4.

### Proof Sketch of Theorem 4

We break the proof into three parts: first, we show that the regret of \(\) and the \(}_{i}\), when restricted to times \(t I_{ij}()\), is small; second, we relate the prediction error \(_{ij}()=_{t I_{ij}()}\|(}_{i}-_{j}^{*})}_{t}\|^{2}\), to the regret on \(I_{ij}()\); third, demonstrate that \(_{ij}()=_{t I_{ij}()}}_{t} }_{t}^{T}\) has minimal eigenvalue bounded below by some constant with high probability. If all three of these claims hold, then, noting that \(\|}_{i}-_{j}^{*}\|_{F}^{2}\|_{ij}( )^{-1}\|_{}_{t I_{ij}()}\|( {}_{i}-_{j}^{*})}_{t}\|^{2}\),

we conclude. Each of these claims requires significant technical effort in its own right. We introduce _disagreement covers_, a stronger analogue of \(\)-nets adapted to our problem and allowing us to turn statements proven for a single \(g\) into ones uniform over \(\). The first step is to bound the size of disagreement covers for the class \(\) of interest; we then prove each of the three claims for some fixed \(g\) and lift the result to apply to the data-dependent \(\). This is done in Appendix D.1.

We now turn to our three claims. For the first, proved in Lemma D.15, we introduce the _excess risk_\(_{ij}(g,)=_{t I_{ij}(g)}||_{i}}_{t}-_{t}||^{2}-||_{t}+_{t}||^{2}\), for each pair \((i,j)\), and note that the cumulative empirical excess risk \(_{i,j}_{ij}(,})\) of predicting using \(\) and \(}\) returned by the ERM oracle is bounded by \(_{}\) because \(_{ij}(g_{*},_{*})=0\) due to Equation (2.1). Thus, showing that \(_{ij}(,})\) is small can be done by showing that for no \(i^{},j^{}\) is \(_{i^{}j^{}}(,}) 0\). This can be accomplished by a concentration argument for a single \(g,_{0}\), coupled with a covering argument using our notion of disagreement covers to boost the result to one uniform in \(\).

For the second claim, i.e., that \(_{ij}()\) is controlled by \(_{ij}(,})\), we provide a proof in Lemma D.14. For a fixed \(g\), we decompose \(_{ij}(g,})\) into \(_{ij}(g)\) and an error term. We then use a generalization of the self-normalized martingale inequality from Abbasi-Yadkori et al.  to control the error in terms of \(_{ij}(g)\), providing a self-bounded inequality. Finally, we rearrange this inequality and apply a union bound on a disagreement cover to boost the result to one uniform in \(\) and \(\).

To prove the third claim, that \(_{ij}()\) has singular values uniformly bounded from below, we split our argument into two parts. First, in Appendix D.2, we assume the following sliced-small ball condition on the data, i.e., for some \(,>0\), it holds that \((}_{t},^{2} c^ {2}|_{t},\,t I_{ij}()) c\). Given the above condition, we establish a high probability lower bound on \(_{ij}(g)\) for fixed \(g\) using a self-normalized martingale inequality, using analysis that may be of independent interest. We then again apply a union bound on a disagreement cover to lift this result to be uniform in \(\). Finally, in Appendix D.3, we provide bounds on \(,\) using directional smoothness and Markov's inequality.

### Mode Prediction

In this section, we address the second source of error, mode misclassification. The primary challenge is that directional smoothness, as opposed to independent data, is insufficiently strong to guarantee that \(_{}\) generalizes well to unseen data in epoch \(+1\). We take inspiration from online learning and stabilize our algorithm across epochs by modifying the classifier \(_{}\). There are two challenges in ensuring good performance of our online classifier. First, the dynamics described in (2.1) are only identifiable up to a permutation of the labels. Thus, in order to enforce stability across epochs, we need to enforce consistency of labelling accross epochs. This task is made more difficult by the fact that different modes may be combined or split up across epochs due to the black box nature of ErmORacle. We solve this by appealing to a subroutine, Reorder, described in Algorithm 3 in Appendix E, which combines modes that are sufficiently large and have sufficiently similar parameters and then relabels the modes so that similar nominal clusters persist accross epochs.

The second challenge is enforcing stability of our online classifier. We do this by introducing a surrogate loss \(_{,t,}\), the multi-class hinge loss with parameter \(>0\)2. Formally, let \(_{1:K}=(_{1},,_{K})\) for \(_{i}^{d-1}\), and for \(g\), define the \((1/)\)-Lipschitz and convex surrogate loss:

\[_{,t,g}(_{1:K})=(0,_{j g( _{t})}(1-_{g(_{t})}- _{j},_{t}}{})). \]

In Ogd (see Algorithm 2), we modify the output of ErmORacle to construct a classifier \(_{}\) by running lazy online gradient descent on this surrogate loss, using the reordered labels given by the output of ErmORacle evaluated on the previous epoch. By invoking Ogd, we show that our mode classifier is sufficiently stable to ensure low regret, as stated informally in the following result.

**Theorem 7** (Mode Prediction, Informal Statement of Theorem 13).: _Suppose that Assumptions 2-5 hold and let \(^{ mode}_{t}\) be the event that the learner, invoking Algorithm 1 with correctly tuned parameters, misclassifies the mode of \(}_{t}\). Then, with probability at least \(1-\), it holds that \(_{t=1}^{T}\{^{ mode}_{t}\}( },()) T^{1- (1)}\)._

Proof Sketch.: We begin by addressing the lack of identifiability of the modes. For the purposes of analysis, for each epoch \(\), we introduce the function \(_{}:[K][K]\) such that \(_{}(i)=_{1 j K}\|}_{ ,i}-_{j}^{}\|_{}\). In words, \(_{}(i)\) is the mode \(j\) according to the ground truth whose parameters are closest to those estimated by ErmORacle. We let \(^{ mode}_{t}\) denote the event of misclassifying the mode, i.e. the event that \(_{}(_{}(}_{t})) g_{}(}_{t})\). We can then decompose the misclassification as \(^{ mode}_{t}\{_{+1}(_{}(}_{t})) g_{}(}_{t})\}\{_{}( _{}(}_{t}))_{+1}(_{ }(}_{t}))\}\). We call the first event look-ahead classification error and the second permutation disagreement error. To bound the first of these, we further decompose the look-ahead classification error event: \(\{_{+1}(_{}(}_{t})) g_{}( {}_{t})\}\{_{+1}(_{+1}( }_{t})) g_{}(}_{t})\}\{_{}(}_{t})_{+1}(}_{t})\}\). Controlling the first of these events is proved as a corollary of the bound on the permutation disagreement error and we defer its discussion for the sake of simplicity. To bound the probability of the second event, upper bound the indicator loss by \(_{,t,_{+1}}\) and apply standard online learning techniques to show that regret of OGD on the \((1/)\)-Lipschitz and convex surrogate loss is small. We then use smoothness to show that the optimal comparator with respect to the surrogate loss does not experience large regret with respect to the indicator loss, which in turn has a comparator experiencing zero loss due to the well-specified nature of \(g_{}\). Thus, putting everything together, this provides bound on the look-ahead classification error, with full details presented in Appendix E.1.

Bounding the permutation disagreement error is what necessitates the gap assumption. We show that if there are sufficiently many data points that \(_{}\) assigns to a given mode, with the threshold defined in terms of \(_{ sep}\) and other parameters of the problem, then with high probability the cluster becomes stable in the sense that \(}_{,i}}_{+1,i}\). This result is proved using the fact that if \(|I_{i,j}(_{})|\) is large enough, then the parameter recovery results from the previous section tell us that \(\|}_{i}-}_{j}\|_{}\) is small. Using the triangle inequality and the fact that \(\|}_{j}^{}-_{j^{}}^{}\|_ {}>_{ sep}\) for \(j^{} j\) ensures that \(j\) is unique in satisfying \(\|}_{,i}-_{j}^{}\|_{} 1\). A similar argument applies to epoch \(+1\), and thus we can identify \(}_{,i}\) with some \(}_{+1,i^{}}\) by these matrices being sufficiently close in Frobenius norm. Algorithm 3 takes advantage of exactly this property and permutes the labels across epochs in order to maintain consistency and control the permutation disagreement error; full details can be found in Appendix E.2. Combining this argument with the bound on the look-ahead classification error suffices to control the online classification component of the regret. 

## 5 Discussion

We have given an efficient online learning algorithm for prediction in piecewise affine (PWA) systems. Our results are the first foray into the study of such systems, and a number of outstanding questions remain: Does directional smoothness facilliate low regret for planning and control, in addition to for simulation and prediction? If the systems are piecewise-affine but forced to be continuous on their boundaries, is there an oracle efficient algorithm which suffers low regret without assuming directional smoothness? Can learning in piecewise affine systems be obtained under _partial observation_ of the system state? Can the dependence of regret on horizon be improved? We hope that our work initiates investigation of the above as the field continues to expand its understanding beyond the linear regime.