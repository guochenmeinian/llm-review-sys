# Leveraging an ECG Beat Diffusion Model for Morphological Reconstruction from Indirect Signals

Lisa Bedin\({}^{*}\)

Ecole Polytechnique

&Gabriel Cardoso\({}^{}\)

Ecole Polytechnique, IHU Liryc

Josselin Duchateau

Bordeaux University Hospital, IHU Liryc

&Remi Dubois

IHU Liryc

&Eric Moulines

Ecole Polytechnique

###### Abstract

Electrocardiogram (ECG) signals provide essential information about the heart's condition and are widely used for diagnosing cardiovascular diseases. The morphology of a single heartbeat over the available leads is a primary biosignal for monitoring cardiac conditions. However, analyzing heartbeat morphology can be challenging due to noise and artifacts, missing leads, and a lack of annotated data. Generative models, such as denoising diffusion generative models (DDMs), have proven successful in generating complex data. We introduce BeatDiff, a light-weight DDM tailored for the morphology of multiple leads heartbeats. We then show that many important ECG downstream tasks can be formulated as conditional generation methods in a Bayesian inverse problem framework using BeatDiff as priors. We propose EM-BeatDiff, an Expectation-Maximization algorithm, to solve this conditional generation tasks without fine-tuning. We illustrate our results with several tasks, such as removal of ECG noise and artifacts (baseline wander, electrode motion), reconstruction of a 12-lead ECG from a single lead (useful for ECG reconstruction of smartwatch experiments), and unsupervised explainable anomaly detection. Experiments show that the combination of BeatDiff and EM-BeatDiff outperforms SOTA methods for the problems considered in this work.

## 1 Introduction

Electrocardiograms (ECG) are essential tools for diagnosing cardiac conditions. Two main types of diagnostics can be obtained from an ECG signal: rhythm-based and morphology-based. Rhythm-based diagnostics focus on the frequency and regularity of heartbeats, while morphology-based diagnostics focus on the shape and amplitude of the various waves and segments of the ECG signal; see . Many critical cardiac conditions can be diagnosed by analyzing the morphology of the different phases of a single beat (). For example, an increase in the ST segment suggests a myocardial infarction (), while a long QT syndrome is associated with an increased risk of sudden death (). In fact, patients who have survived events similar to sudden death often have abnormal intracardiac signals, even during sinus rhythm; see .

Most generative models for ECG literature attempt to accurately represent the rhythm, i.e. the time at which the individual ECG events occur; see e.g., . We focus in this paper on the morphology of a single heartbeat.

The standard for ECG recording systems includes 12 leads, which are obtained using 9 electrodes. The use of multiple leads is required because pathologies may manifest only in one lead. For example, T wave inversions--which can indicate Arrhythmogenic Right Ventricula Dysplasia--might only appear on one or two precordial leads (). Furthermore, the specific precordial lead in which a disease is detected has an important diagnostic value about the disease location in the heart ().

Multi-lead ECGs can be affected by noise and artefacts, i.e. unwanted signals caused primarily by variations in potential and impedance at the electrode-skin interface, but also by other factors such as environmental interference, movement of the subject; see e.g.,  and the references therein. These artefacts overlap in the spectral range of interest and manifest as morphological features that resemble inherent aspects of the ECG or disease-specific aspects. Therefore, methods that can accurately reconstruct 12-lead ECGs from partial observations are central to analysing the morphology of heartbeats. In this work, we address classical problems such as baseline wander or motion artefacts; we are also interested in the reconstruction of missing leads to be able to reconstruct the 12-lead representation from a reduced number of electrodes, which is an essential precursor for the reconstruction of 12-lead ECGs from smartwatch measurements; see .

The heartbeat morphology reconstruction problems are naturally formulated as Bayesian linear inverse problems (). The observation vector is an affine transformation of the signal of interest, which is influenced by additive noise. This affine function is only partially known (it may depend on unknown parameters) and the corresponding inverse problem is usually ill-posed (in the missing lead case, the affine function is not invertible). Inverse Bayesian problems require the use of a prior distribution for the signal to be reconstructed. Recently, the use of generative models to define priors has enabled us to achieve many successes in various areas.; see e.g.,. Early works in this area used flow models or GANs. There has been a recent increase in interest in using diffusion models as a prior in Bayesian inverse problems (). Many techniques have been recently proposed. We focus here on MCGDiff (), which constructs unbiased estimates of posterior distributions using Sequential Monte Carlo (SMC) methods, a.k.a. particle filter.

Our main contributions are as follow

* We introduce BeatDiff a new light-weight DDM model designed to generate 12-leads heart beat morphology. In comparison to , BeatDiff has a significantly lower memory footprint and faster generation speed. BeatDiff has shown superior performance to state-of-the-art ECG generation methods accross all the metrics that we have considered.
* We then show how BeatDiff can be used as a prior to address various challenges in heartbeat morphology reconstruction from partial observations. We show how the MCGDiff method can be combined with Monte Carlo Expectation Maximization (MCEM) algorithm to compute maximum likelihood estimate of the unknown parameters of the inverse linear model (e.g., noise level estimation, noise and artifact model, etc.), leading to a new full-fledged algorithm for conditional ECG generation, called EM-BeatDiff.
* We demonstrate the effectiveness of our approach by comparing it to state-of-the-art methods. Our algorithm outperforms the current best approaches on multiple evaluation metrics specifically designed for ECGs, and offers new paths that have the potential to lead to novel applications.

Related works:The use of generative models () as informative priors in solving Bayesian inverse problems has attracted significant interest (). In particular, DDMs have been demonstrated as a particularly suitable choice of prior for solving inverse problems (). DDMs are generative models that transform a simple reference distribution into the training data distribution through a denoising process called denoising diffusion. These models are capable of generating high-quality realistic samples on par with the best Generative Adversarial Networks (GANs) () in terms of image and audio generation, without the intricacies of adversarial training (). In this article, we follow the approach proposed in , for sampling solutions to an inverse problem using a Sequential Monte Carlo (SMC) algorithm that guides the denoising process of a pretrained diffusion model. This method is accompanied by a series of theoretical guarantees in realistic scenarios.

Generative modeling, denoising methods, and automatic anomaly detection algorithms are commonly used for ECG analysis. In particular, DDMs have been demonstrated to be capable of generating realistic ECGs:  focuses on generating a single healthy beat for a single ECG lead,  generates a 10-second period conditioned on various complementary ECG information. Additionally, numerous methods address the denoising problem in ECGs; see e.g., [79; 56; 15]. Classical approaches like Dower matrices () are used to reconstruct missing leads in ECGs. [97; 43] rely on neural networks to detect anomalies, and  use adversarial autoencoders for unsupervised anomaly detection. However, to our knowledge, there is no method that addresses all these problems with a single pretrained model.

## 2 BeatDiff - a generative model for heartbeat morphology

Denoising Diffusion Generative Models (DDM):We briefly describe in this section the DDMs and introduce some basic notations which are required below; see [24; 37; 86; 83; 85; 44; 19] and the references therein for theory and practical implementation details. We focus on the variance-exploding (VE) framework (). In the _forward path_ an initial state \(X_{0}\) is sampled from the data distribution \(_{}\) and independent Gaussian noise with zero-mean and increasing variance is added to generate subsequent states \(X_{k}=X_{k-1}+_{k}_{k}\), where \(k^{*}\), \(_{k}>0\), and \(_{k}(0,)\). The joint p.d.f. of the Markov chain is \(_{0:K}(x_{0:K})=_{}(x_{0})_{k=1}^{K}q_{ k}(x_{k}|x_{k-1})\), where \(q_{k}(|x_{k-1})=(x_{k-1},_{k}^{2}\,)\) and \(K^{*}\). The conditional distribution of \(X_{k}\) given \(X_{s}\) with \(k>s 0\) is given by \(_{k|s}(|x_{s})=(x_{s},(v_{k}^{2}-v_{s}^{2})\,)\) with \(v_{k}^{2}=_{j=1}^{k}_{j}^{2}\) (and \(v_{0}^{2}=0\)). The number of forward steps \(K\) is chosen such that \(v_{K}^{2}=v_{}^{2}\) is far larger than the variance of \(_{}\). With such choice, \(_{K|0}(|x_{0})\) is close to the reference distribution \(q_{}=(0,v_{}^{2}\,)\). We learn for each state \(X_{k}\) a denoiser \(_{0|k}^{}\) with parameters \(\) trained to minimize \(_{}():=_{k=1}^{K}_{k}^{2}_{X_{0 _{},(0,)}}[ \|_{0|k}^{}(X_{0}+v_{k},v_{k})-X_{0}\|^{2}]\), where \(\{_{k}\}_{k[1:K]}\) is a sequence of appropriately defined positive weights. We denote the result of this minimization as \(^{*}\). In the backward path, we sample \(x_{K} q_{}\) and for \(k=K\) to \(k=2\) we sample \(x_{k-1}\) given \(x_{k}\) with

\[p_{k-1|k}(x_{k-1}|x_{k})=(x_{k-1};_{k-1}(x_{k},_{0|k}^{^{*}}(x_{k},v_{k})),_{k-1}^{2}\,_{d})\]

where the variances are hyperparameters \(=\{_{k}\}_{k}\) satisfying \(_{k}^{2} v_{k}^{2}\) and \(_{k-1}(x_{k},x_{0}):=x_{0}+(v_{k-1}^{2}/v_{k}^{2}-_{k-1}^{2}/v_{k} ^{2})^{1/2}(x_{k}-x_{0})\). Finally, we sample \(x_{0} p_{0}(|x_{1}):=(_{0|1}^{^{*}}(x_{ 1},v_{1}),_{0}^{2}\,)\). To keep the notations simple, we remove in the sequel the dependence in \(\) and \(^{*}\). For \(k[0:K-1]\), we denote by \(_{k}(x_{k})\) the marginal distribution of \(X_{k}\):

\[_{k}(x_{k}):= q_{}(x_{K})_{s=K}^{k+1}p_{s-1|s}( x_{s-1}|x_{s})x_{k+1:K}.\]

BeatDiff model:In the standard ECG, the augmented limb leads (AVL, AVR, AVF) can be obtained from a known linear combination of the limb leads (I, II, III) ([59; Vol 1, Chapter 11]). Hence, it is standard practice to select either the augmented leads or the limb leads to model the ECG ([3; 35]). We exclude the augmented leads and use the leads (I, II, III, V1-6). We denote by \(L=9\) the number of leads, and by \(T\) the maximal heartbeat duration (expressed in number of samples).

Various factors, including age (A), sex (S) and the RR interval, which is the reciprocal of heart rate, influence the morphology of the heartbeat; see e.g., [60; 75; 6]. Therefore, we use the DDM described above to approximate the distribution \(_{}\) of heartbeats over the retained leads _conditionally_ on the patient characteristics \(:=(,,)\). The denoiser of BeatDiff \(_{0|k}^{}\) takes as input \((x,v_{k},)\) where \(x\) is the \(L T\) matrix of single heartbeat samples, \(v_{k}\) is the \(k\)-th step diffusion variance and \(\) encodes the patient features. We obtain \(\) from \(=(,,)\) by first one-hot-coding the Boolean variable S and then embedding it using a fully connected 2-layer network. For \(v_{k}\) we use the Fourier positional encoding () of \((v_{k})\) as in . For \(_{0|k}^{}\) we use a modified 1d Unet, the specific details are given in Appendix B.1.4. The model has \(10^{6}\) parameters. Compared to , the inference time is 400 times shorter and the memory footprint is 900 times smaller.

BeatDiff trainingWe utilize the PhysioNet Challenge dataset ([31; 68; 69]), comprising 43,101 12-lead ECGs. The pre-processing of  is used which consists of normalization of the sampling frequency, detection of \(\) peaks to identify heartbeats, segmentation of the heartbeats. We obtain 214,460 single-beat ECGs, each with \(T=176\) samples and \(L=9\) (I, II, III, V1-V6). See Appendix B.1.1 for details. Each patient (and _the entirety of its recordings_) is attributed to one of the three datasets: Training, Cross-validation (CV) or Test. During training, a batch of size is constituted by firstly drawing \(b\) patients and then selecting randomly one of the beats for each given patient. For testing and cross-validation, due to the significant variability between patients in comparison to the variability between heartbeats, we randomly select a single beat per patient for model evaluation. The entire network \(^{}_{0|k}\) is trained to minimize \(_{}\) using the Adam optimizer () with a batch-size \(2^{10}\) on the healthy training set, and the best model in terms of \(_{}\) over the cross-validation set is retained. See Appendix B.1.4 for details.

## 3 EM-BeatDiff - conditional heartbeat generation from indirect measurements

We present EM-BeatDiff a method that allows us to sample heartbeat morphology from partial observations, focusing on a class of problems that can be formulated as Bayesian linear inverse problems. Our approach is based on Monte-Carlo guided diffusion (MCGDiff), introduced in  (see also ), which is used in combination with BeatDiff.

Monte Carlo Guided Diffusion (MCGDiff):In many applications of interest, the objective is to sample from a distribution \(_{0}(x_{0}):=g_{0}(x_{0})_{0}(x_{0})/\), where \(g_{0}\) is a nonnegative potential function, \(_{0}\), the marginal of the diffusion model at time 0, and \(:= g_{0}(x)_{0}(x)x\) is the normalizing constant. For example, in a Bayesian setting, \(g_{0}\) is the likelihood function (the conditional distribution of the observation given the current value of the state \(x_{0}\)) and \(_{0}(x_{0})\) is the prior distribution of the state. In such case, \(_{0}(x_{0})\) is the posterior distribution of the state \(x_{0}\) given the current observation. A simple idea for sampling the posterior \(_{0}(x_{0})\) is to use sampling importance resampling (SIR, ), where \(_{0}\) is used as the instrumental distribution. However, this method may be inefficient since the instrumental distribution neglects the potential \(g_{0}\).

We define a distribution over the path space

\[_{0:K}(x_{0:K}):=^{-1}g_{0}(x_{0})_{k=1}^{K}p_{k-1|k}(x_{k -1}|x_{k})q_{}(x_{K}).\]

In , a sequence of positive intermediate potentials \(\{g_{k}\}_{k[1:K]}\) with \(g_{K} 1\) was introduced to guide the backward Markov chain to regions where the potential \(g_{0}\) is large. The path space distributions may be equivalently rewritten as

\[_{0:K}(x_{0:K})  q_{}(x_{K})_{k=1}^{K}(x_{k -1})}{g_{k}(x_{k})}p_{k-1|k}(x_{k-1}|x_{k})\] \[ q_{}(x_{K})_{k=1}^{K}_{k}(x_{k}) _{k-1|k}(x_{k-1}|x_{k})\,, \]

where, for \(k[1:K]\), \(_{k-1|k}(|x_{k}):=g_{k-1}()p_{k-1|k}(|x_{k})/_{k}(x_{k})\), and \(_{k}(x_{k}):= g_{k-1}(x^{})p_{k-1|k}(x^{}|x_{k}) x\), and \(_{k}(x_{k}):=_{k}(x_{k})/g_{k}(x_{k})\). We implicitly assume that these formulas have a closed form. Sampling according to (3) passes through the intermediate distributions \(_{k}(x_{k}):= q_{}(x_{K})_{s=k+1}^{K}_{s}(x_{s })_{s-1|s}(x_{s-1}|x_{s})x_{k+1:K}\) for each \(k[1:K]\), which verifies

\[_{k-1}(x_{k-1}) g_{k-1}(x_{k-1})_{k-1}(x_{k-1}) _{k}(x)_{k-1|k}(x_{k-1}|x)_{k}(x)x\,. \]

Each \(_{k-1}\) thus has the same structure as \(_{0}\): a product of a potential function and the marginal law at time \(k-1\) of the backward diffusion.

It remains to approximate this sequence of distributions. For this purpose, we use Sequential Monte Carlo (SMC); see . Suppose that we have at iteration \(k\) a _particle approximation_\(_{k}^{M}=M^{-1}_{j=1}^{M}_{_{k}^{j}}\) of \(_{k}\) through a set of \(M_{>0}\) particles \(_{k}^{1:M}\), initialized with \(_{K}^{1:M} q_{}^{ M}\). Plugging this approximation into Equation (3.2) gives

\[_{k-1}_{j=1}^{M}_{k}(_{k}^{j})_{k-1|k}(| _{k}^{j})\,.\]

Hence, to obtain \(_{k-1}^{1:M}\), we first sample \(M\) ancestors according to \(I_{k-1}^{1:M}\{_{k}(_{k}^{j})/_{i=1}^{M} _{k}(_{k}^{i})\}_{j=1}^{M}^{ M}\), then we sample new particles \(_{k-1}^{1:M}\{_{k-1|k}(|_{k}^{I_{k-1}})\}_{j=1}^{M}\), leading to \(_{k-1}^{M}=M^{-1}_{j=1}^{M}_{_{k-1}^{j}}\). Algorithm is given in Appendix A.1.1.

Bayesian inverse problemsWe assume that the \(d_{y} 1\) vector of observations \(Y\) (noisy/partial heartbeat) is given by

\[Y=A_{}X_{0}+b_{}+D_{},(0, ), X_{0}_{0} \]

where \(A_{}\) is a \(d_{y} d_{x}\) matrix (for selecting the lead/time observed indices), \(b_{}\) is a \(d_{y} 1\) vector (modeling heartbeat artifacts; e.g., baseline wander, electrode motion), \(D_{}\) is a \(d_{y} d_{y}\) invertible matrix (the variance of the noise), and \(\) is a vector of unknown parameters. Define by \(g_{0}^{,y}(x_{0})\) the likelihood of the observation, given by \(g_{0}^{,y}(x_{0}):=(y;A_{}x+b_{},D_{}D_{ }^{})\). Given an observation \(y\) and a value of the parameter \(\), we may sample \(X_{0}\) from the posterior \(X_{0}|y,\), with p.d.f. \(_{0}^{,y}(x_{0})=_{0}(x_{0})g_{0}^{,y}(x_{0})/ ^{,y}\), \(^{,y}= g_{0}^{,y}(x)_{0}(x)x\) is the normalizing constant. We use MCGDiff with the intermediate potentials \(\{g_{k}^{,y}\}_{k[0:K]}\) defined as

\[g_{k}^{,y}(x)=(y;A_{}x+b_{},_{k,})\,, \]

where the sequence of covariance matrices \(_{k,}\) are specified in Appendix A.2.1. For this choice of potentials, \(p_{k-1|k}^{,y}\) and \(_{k}^{,y}\) admit closed forms given in Appendix A.2.2.

MCGDiff allows to sample \(X_{0}|y,\) for a known parameter \(\). When \(\) is unknown, we maximize the penalized marginal log-likelihood

\[^{*}=*{argmax}_{^{2}}(l()+ ())\,, l():=^{, y}= g_{0}^{y,}(x)_{0}(x)x \]

where \(()\) is a penalty. The best-known method for optimizing the marginal log-likelihood (3.5) is the expectation maximization algorithm (EM); see . The EM iterates between two main steps: expectation (E) and maximization (M). Starting from an initial guess \(_{0}\), the EM algorithm alternates between: (E) compute the surrogate function \((;_{i}):= g_{0}^{y,}(x_{0})_{0}^{,y}(x_{0})x_{0}\); and (M) solve for \(_{i+1}:=*{arg\,max}_{}(; _{i})+()\). Under general conditions, the sequence of parameter estimates \((_{i})_{i}\) converges to a stationary point \(_{*}\) of the marginal penalized likelihood; see [61, Chapter 3]. In this setting, the E-step is untractable; we approximate the surrogate function in the (E) step using MCGDiff with the current parameter \(_{i}\) and the sequence of intermediate potentials defined in (3.4). Such scheme becomes a specific instance of the Monte Carlo EM algorithm (MCEM), initially introduced in  and further analyzed in .

The EM-BeatDiff algorithm:We combine the BeatDiff for the prior and MCGDiff algorithms for posterior sampling, with MCEM steps for parameter inference. The only slight difference is that the observations are gathered in a matrix \(\) of size \(\) - where \(\) is the number of observed leads and \(\) the number of observed samples on each lead. The state we are attempting to reconstruct is a matrix of size \(L T\). The observation equation takes the form

\[Y=A_{}X_{0}_{}+B_{}+D_{}_{ },\]

where \((A_{},D_{})\) and \((_{},_{})\) are \( L\) and \(T\) matrices, \(B_{}\) is a \(\) matrix, and \(\) is a \(L T\) matrix with i.i.d. standard Gaussian entries. The model (3.3) is obtained by applying the vectorization operator to \(\). The full algorithm is detailed in Appendix A.3. Note that EM-BeatDiff is also applicable to "standard" ECG signals and could be used in combination with the ECG generative model of , for example.

## 4 Experimental validation

BeatDiff evaluation:We begin by assessing the impact of BeatDiff in a classifier improvement task. This involves comparing the performance of a classifier trained on a severely unbalanced dataset with that of the same classifier trained on a balanced dataset. The balancing is achieved by augmenting the minority class with new examples from a generative model. Results for sex classification from heartbeat are reported in Table 1, including model size, inference time, F1 score, total accuracy, and AUC score are shown for the balanced dataset with BeatDiff and alternative ECG generation models from , retrained to generate ECGs conditioned on sex. Diffusion-based models BeatDiff and SSDM () outperform WGAN (), with BeatDiff being 400 times faster than . See implementation details in Appendices B.3.1, B.3.2 and B.4.

[MISSING_PAGE_FAIL:6]

To evaluate this, we rely on well-known empirical formulas from . These formulas introduce coefficients called "corrected QT" denoted as QT\({}_{0}^{c}\) and QT\({}_{1}^{c}\), which depend on the patient and are determined from ECGs measured during stress test. We regress the intercept QT\({}_{0}^{c}\) and slope QT\({}_{1}^{c}\) of the Fridericia formula from , which states that QT \(=\) QT\({}_{0}^{c}\) + QT\({}_{1}^{c}\)\(}\), from the generated curves. As shown in figure 2, we observe a consistent trend between the observed and regressed curves for four patients. Additionally, Table 10 indicates a high \(R^{2}\)-score of 0.98 between observed and expected QT curves in the test set. EM-BeatDiff generates QT for different RR that follow the Fridericia formula, one of the most correlated with patient QT vs. RR behaviour, without explicitly encoding this relationship during training. This demonstrates the ability of EM-BeatDiff to capture underlying physiological mechanisms.

Artifact removal (AR):Many solutions for removing ECG artifacts such as baseline wander-a low-frequency artifact caused mainly by respiration and body movements- or electrode motion-also a low-frequency artifact caused by bad electrode contact- have been proposed so far, most often based on adaptive filter, time-frequency (and most notably empirical mode decomposition) and time-scale decomposition; see  and the references therein. We use in this experiment a sparse representation of the artifacts in a dictionary, and propose to use penalized MLE with DDM prior to estimate the artifacts and denoise the ECG. In this case, we set for a given \(\{1,L\}\) and \(\{1,T\}\)

\[B_{}=[b_{1}^{},,b_{}^{}]^{}  b_{,t}^{}=_{i=1}^{K}_{j,}c_{j}(t),t[1:][1:]\,, \]

with \(\{c_{j}\}_{j=1}^group sparsity: it keeps or removes the projections of observations on \(c_{j}\) across all leads. The second term promotes global sparsity. Details are given in Appendix B.2.2.

The evaluation of EM-BeatDiff in the AR task on 12-lead ECGs contaminated with per-lead independent noise from the MIT-BIH Noise Stress Test database () is presented in Table 3. Despite not being exposed to MIT-BIH Noise during training, EM-BeatDiff outperforms DeScoD () -a conditional DDM specifically trained to remove baseline wander- according to the following metrics: Sum of the square of the distances (SSD), Absolute maximum distance (MAD), and Cosine similarity (Cos.) (, Appendix B.5). Visualizations of ECGs obtained with EM-BeatDiff and DeScoD are provided in figure 3, and failure cases of DeScoD are discussed in Appendix B.6.4.

Missing Leads Reconstruction (ML):In resource-limited clinical settings like ambulatory care, electrode placements can vary from six-lead montages and reduced Frank or EASI configurations to single-lead setups. Similarly, in non-clinical settings, smartwatches like the Apple Watch provide a single lead ECG by measuring the potential between the wrist and the finger of the opposite hand. Recent studies such as  showed that this single lead ECG is essentially equivalent to the lead I ECG recorded in a 12 lead ECG. Several papers have addressed the reconstruction of ECGs from a single lead with deep learning, indicating potential applicability in ECG reconstruction from smartwatch single-lead ECG; see e.g., .

In the first experiment, we evaluate the performance of EM-BeatDiff in reconstructing V1-6 from the limb leads (I, II, III). This corresponds to the setting ML (V1-6) in Table 2. The second task we consider is generating II, III, V1-6 from lead I, which we refer to as the Smartwatch task. This corresponds to setting ML (SW) in Table 2. In Table 4, EM-BeatDiff outperforms EkGAN (), a deep learning-based methods designed and trained for ECG missing lead reconstruction according to SSD, MAD and Cos. Unlike EkGAN, EM-BeatDiff does not require any task-specific training.

followed by the respective medical condition name. Table 5 shows that EM-BeatDiff outperforms AAE (), which uses as anomaly score the MSE between the output of an Adversarial Auto Encoder and the input ECG, according to the AUC of the anomaly score. See Appendix B.3.5 for implementation details. A key advantage of the aforementioned approach is its ability to function in an interactive manner, unlike methods that rely on training on a specific setting. By simply selecting a different set of ECG leads for conditioning, the posterior can be regenerated in a near-online fashion following visual assessment of the posterior and the patient ECGs as in the MI case in Figure 3.

## 5 Conclusion

In this work, we have described a flexible method that addresses several challenges in heart beat morphology, including baseline wander and electrode-motion removal, missing lead reconstruction and anomaly detection, all formulated as Bayesian linear inverse problems. Our method utilises BeatDiff a DDM pre-trained to generate the heartbeat morphology on 12 leads, as a prior for sampling solutions to inverse problems with EM-BeatDiff. Several evaluation metrics show the effectiveness of EM-BeatDiff compared to baseline solutions, which contrary to EM-BeatDiff require specific training for the specific task in hand.

Our approach also enables new applications, such as generating a 12-lead ECG using a subset of electrodes, including 12-lead heartbeat morphology reconstruction from smartwatch measurements as an example. Another example is the anomaly detection algorithm which can enable diagnostic of long QT syndrome or other diseases that specifically alter repolarization. In this paper, BeatDiff was trained only on healthy ECGs. However, BeatDiff could be trained on a dataset containing ECGs presenting pathologies by conditioning on the specific pathology as discussed below.

## 6 Discussion

This paper focus on generating 12-lead healthy heartbeats from partial measurements, e.g., limb leads only, samples corrupted with eletrodec artifacts, see Tables 3 and 4. We show that EM-BeatDiff can also be used to classify abnormal heartbeats in an unsupervised manner: we generate healthy counterparts of abnormal heartbeats and use the distance as an anomaly score. The flexibility of our

Figure 3: Illustration of EM-BeatDiff on the denoising, inpainting and anomaly detection tasks. The red background indicate the parts of the ECG that are observed through \(y\). The red ECGs corresponds to the real ECG and the blue ECGs corresponds to each algorithm reconstructed ECG.

   Model & MI & LAD & LAE & LQT \\  AAE  & 80.23 & 82.69 & 74.87 & 70.96 \\ EM-BeatDiff & \(\) & \(\) & \(\) & \(\) \\   

Table 5: AUC obtained using the proposed anomaly detection score (\(1-R^{2}\)) for each medical conditioning. See Table 2 for details on the inverse problem in hand. Confidence intervals are obtained by running 10 times EM-BeatDiff per heartbeat.

method allows the detection of various heart conditions (MI, LQT, LAD, LAE) by reconstructing 12 leads from limb leads only, QRS only, or ST only, see Tables 11 and 12.

Risk of hallucinationWe would like to point out that this anomaly detection tool is semi-white-box: rather than outputting an abnormality score, our approach is also able to show the healthy counterparts of an abnormal signal and highlight where they differ from the patient's signals. This could theoretically enable cardiologists to rule out abnormalities that are not relevant. However, there is still a risk of hallucinations. We have shown that the generated signals are close to the real signals for healthy patients, but a clinical study must be performed before clinical use.

10s ECG signalsAlthough our study focused on heartbeat morphology, we would like to discuss the feasibility of generating realistic longer samples that are more than a beat. We trained a diffusion model to produce 5-second ECGs. We then applied our sampling algorithm to reconstruct 12-lead ECGs from limb leads only and limb leads + V2 + V4. This second setting is similar to AliveCor's recent system Kardia12L*. We found that reconstructing 12 leads from multi-beat ECGs is more complex and requires precordial leads for reasonable results (see figure 11). A special study is needed to build a relevant diffusion model and adapt the algorithm's parameters in order to generate longer 12-lead ECGs from limb leads only. This adaptation is complex due to the need for larger models and more particles for posterior sampling.

Arrhythmic dataTesting EM-BeatDiff's ability to reconstruct arrhythmic ECGs is valuable as it would enable the use of additional simulated leads for abnormality detection from portable devices such as smartwatches or AliveCor products. We trained a diffusion model on 5-second ECGs with Atrial Fibrillation (AF) from PhysioNet and successfully predicted a reasonable 12-lead ECG from limbs + V2 + V4 (Kardia12L setting) (see figure 12). A larger AF dataset would yield more interesting results, but this experiment shows EM-BeatDiff's potential for generating rhythmic abnormalities.

Heartbeat segmentationWe would like to discuss the use of external segmentation tools for segmenting heartbeats before applying EM-BeatDiff. The segmentation of heartbeats is a common practice in the literature. Many works, including the baselines we analyzed in our paper, such as , and more recent papers , rely on external tools to segment the common 10-second clinical ECG signal into heartbeats. The heartbeat settings of EM-BeatDiff could also be used for arrhythmic data such as Premature Ventricular Contractions (PVC), even if they significantly alter the ECG phase. Indeed, one could detect PVCs using available methods such as  and remove them from inference.

## 7 Broader Impact

We demonstrate various ways in which BeatDiff and EM-BeatDiff can be utilized to address various heartbeat morphology analysis tasks. It is important to note that all our results are currently in prototype stage, and before any implementation in a clinical environment, a prior impact assessment and clinical trial must be conducted. This notably includes verifying performance on other datasets that better represent patient characteristics, as well as conditioning all the hyperparameters chosen in this study on this dataset.

## 8 Acknowledgment

This work was supported by the French National Research Agency (ANR- 10-IAHU04-LIRYC). We would like to thank PNY Technology for the computing power made available to us for this study. The work of LB and GC has been partly funded by the European Union (ERC-2022-SYG-OCEAN-101071601). Views and opinions expressed are however those of the author(s) only and do not necessarily reflect those of the European Union or the European Research Council Executive Agency. Neither the European Union nor the granting authority can be held responsible for them.