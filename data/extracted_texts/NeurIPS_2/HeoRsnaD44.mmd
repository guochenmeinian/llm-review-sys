# Unified Guidance for Geometry-Conditioned Molecular Generation

Sirine Ayadi\({}^{*1,2}\)

Leon Hetzel\({}^{*1,2,3}\)

Johanna Sommer\({}^{*1,2}\)

Fabian Theis\({}^{1,2,3}\)

Stephan Gunnemann\({}^{1,2}\)

Equal contributionProject Page: www.cs.cit.tum.de/daml/uniguide

###### Abstract

Effectively designing molecular geometries is essential to advancing pharmaceutical innovations, a domain, which has experienced great attention through the success of generative models and, in particular, diffusion models. However, current molecular diffusion models are tailored towards a specific downstream task and lack adaptability. We introduce UniGuide, a framework for controlled geometric guidance of unconditional diffusion models that allows flexible conditioning during inference without the requirement of extra training or networks. We show how applications such as structure-based, fragment-based, and ligand-based drug design are formulated in the UniGuide framework and demonstrate on-par or superior performance compared to specialised models. Offering a more versatile approach, UniGuide has the potential to streamline the development of molecular generative models, allowing them to be readily used in diverse application scenarios.

## 1 Introduction

Diffusion models have emerged as an important class of generative models in various domains, including computer vision , signal processing , computational chemistry, and drug discovery [3; 4; 5; 6; 7; 8]. By gradually adding noise to data samples and learning the reverse process of removing noise, diffusion models effectively transform noisy samples into structured data [9; 10]. In the context of drug discovery, it is essential to effectively address downstream tasks, which often pose specific geometric conditions. Examples of this include (i) Structure-based drug design (SBDD) that aims to create small ligands that fit given receptor binding sites , (ii) Fragment-based drug design (FBDD) that designs molecules by elaborating known scaffolds [12; 13], or (iii) Ligand-based drug design (LBDD) which generates molecules that fit a certain shape . Recent works address these tasks by either incorporating specialised models or focusing on conditions that directly resemble molecular structures. In both cases, this narrow focus restricts their adaptability to new or slightly altered settings.

We address the challenge of adaptability by introducing UniGuide, a method that unifies guidance for geometry-conditioned molecular generation, see Fig. 1. The key element for achieving this unification is the _condition map_, which transforms complex geometric conditions to match the diffusion model'sconfiguration space, thereby enabling self-guidance without the need for external models. Like other guidance-based approaches, UniGuide does not constrain the generality of the underlying model. Moreover, our method is the most versatile, extending beyond guiding molecular structures to leveraging complex geometric conditions such as volumes, surfaces, and densities, thereby enabling the unified tackling of diverse drug discovery tasks. For complex conditions specifically, previous works primarily rely on conditional diffusion models for effective condition encoding [12; 13; 14]. With our method, we are able to tackle the same tasks, while overcoming major drawbacks: UniGuide eliminates the need for additional training and, more importantly, avoids constraining the model to specific tasks.

We demonstrate the wide applicability of UniGuide by tackling a variety of geometry-constrained drug discovery tasks. With performance either on par with or superior to tailored models, we conclude that UniGuide offers advantages beyond its unification. Firstly, while the novelty of conditional models often stems from the condition incorporation, our method redirects focus to advancing unconditional generation, which directly benefits multiple applications. Furthermore, this separation of model training and conditioning allows us to tackle tasks with minimal data, a common scenario in the biological domain.

In summary, our contributions are as follows:

* We present UniGuide: A unified guidance method for generating geometry-contitoned molecular structures, requiring neither additional training nor external networks used to guide the generation.
* We demonstrate UniGuide's wide applicability by tackling various conditioning scenarios in structure-based, fragment-based, and ligand-based drug design.
* We show UniGuide's favourable performance over task-specific baselines, highlighting the practical relevance of our approach.

## 2 Related work

Diffusion models and controllable generationDiffusion models [9; 10] are generative models achieving state-of-the-art performance across various domains, including the generation of images [1; 9], text , or point clouds . Conditional diffusion models [17; 18; 19; 20; 21] are based on the same principle but incorporate a particular condition in their training, allowing for the controlled generation. Alternatively, classifier guidance [22; 23] relies on external models for controllable generation. Prior works in this context primarily focused on global properties [22; 24], lacking the capacity to condition on the geometric conditions central to our work. For instance, Bao et al.  demonstrate control over molecule generation based on desired quantum properties.

_De novo_ molecule generationResearch on _de novo_ molecule generation focused extensively on generating molecules using their chemical graph representations [7; 25; 26; 27; 28; 29; 30; 31; 32; 33; 34]. However, these methods are limited in modelling the molecules' conformation information and are, therefore, not ideally suited for several drug-discovery settings, such as target-aware drug design. Recently, attention has shifted towards generating molecules in 3D space, utilising variational autoencoders , autoregressive models [36; 37; 38], flow-based models [39; 40], and diffusion-based approaches [41; 42; 43; 44; 45; 46; 47].

Figure 1: UniGuide handles diverse conditioning modalities for guidance, including: (i) a target receptor for SBDD, (ii) additional molecular fragments for FBDD, or (iii) a predefined 3D shape for LBDD. It combines a source condition \(\) and the unconditional model \(_{}(_{t},t)\) within its condition map to enable self-guidance. The flexible formulation of our approach can be generalised to new geometric tasks, for example, conditioning on atomic densities.

 Conditional generation of moleculesDownstream applications of molecular generation can be categorised by their condition modality. In the case of SBDD [38; 48; 49], Schneuing et al.  and Guan et al. , for example, introduce models that simultaneously operate on protein pockets and ligands. In the conditional case, the pocket context is fixed throughout the generation. Moreover, FBDD imposes (multiple) scaffolds as a constraint [12; 11; 51; 52; 53]. Igashov et al.  expand given scaffolds by generating the molecule around the fixed scaffolds. In a related task of FBDD, linker design with pose estimation, as discussed in , further generate the rotation of the given scaffolds. SBDD and FBDD rely on the availability of high-quality data of protein pockets, which is often scarce. For this reason, LBDD aims to generate molecules that match the same 3D volume of reference ligands that are known to bind to the target of interest [55; 56]. Chen et al.  specifically train a shape encoder to capture the molecular shape of a reference ligand and use the resulting embedding to train a conditional diffusion model.

## 3 Controlling the generation of diffusion models

Diffusion Models [9; 57] learn a Markov Chain that involves a forward process to perturb data from a distribution \(q()\) and learn to reverse the process to generate new samples from a tractable prior, for example, a normal distribution. Given a data point sampled from the true underlying distribution, \(_{} q()\), the forward process \(q(_{t}|_{t-1})\) gradually adds Gaussian noise:

\[q(_{t}|_{t-1})=_{t}\, \,}_{t-1},_{t}\;, \]

where \(\{_{t}(0,1)\}_{t=1}^{T}\) defines a variance schedule. Defining the forward process this way, one can readily sample from \(q(_{t}\,|\,_{})\):

\[_{t}=_{t}}_{}+_{t}}\;,(,)\;, \]

with \(_{t}=1-_{t}\) and \(_{t}=_{i=1}^{t}_{i}\). Since the time-reverse process \(q(_{t-1}|_{t})\) depends on \(_{}\), which is not available at generation time, it is approximated by modelling \(p_{}(_{t-1}\,|\,_{t})\):

\[p_{}(_{t-1}\,|\,_{t})= _{t-1}\,\,_{}(_{t},t),_{t}\;, \]

where the mean \(_{}\) is parameterised by a noise-predicting neural network \(_{}\) in the form of:

\[_{}(_{t},t)=}} _{t}-}{_{t}}}_{ }(_{t},t)\;. \]

The model \(_{}\) is trained to optimise the variational lower bound through the simplified training objective:

\[_{}=-_{ }(_{t},t)_{2}^{2}. \]

Self-guiding diffusion modelsUsing Bayes' rule, the conditional probability \(p_{}(_{t}\,|\,)\) given a condition \(\) can be expressed as

\[p_{}(_{t}\,|\,) p_{}(_{t})\,p_{ }(\,|\,_{t})\;. \]

This allows us to decompose the score function as follows:

\[_{_{t}}\! p_{}(_{t}\,|\,)=_{ _{t}}\! p_{}(_{t})+S\,_{_{t}}\! p _{}(\,|\,_{t})\;, \]

where the second term is used for guiding the unconditional generation, with \(S>0\) controlling the guidance strength. Using that \(_{_{t}}\! p_{}(_{t})=-(1-_{t})^ {-}_{}(_{t},t)\), we can rewrite the score function from Eq. (7) and identify the modified noise predictor \(}_{}\):

\[_{_{t}}\! p_{}(_{t}\,|\,)=- {_{t}}}_{}(_{t},t)-_{t}}S\,_{_{t}}\! p_{}( \,|\,_{t})}_{=:}_{}(_{t},t, )} \]

The modified mean function \(}_{}\) then follows from the modified version of Eq. (4), enabling us to sample from \(p_{}(_{t-1}\,|\,_{t},) }_{}(_{t},t,),_{t}\):

\[}_{}(_{t},t,)=}} _{t}-}{_{t}}}}_{}(_{t},t,)\!\!=_{}( _{t},t)+(t)_{_{t}}\! p_{}(\,|\, _{t})\;, \]where \((t)=(_{t})^{-}_{t}S\) balances the conditional update. Eq. (9) requires sampling from \( p_{}(\,|\,_{t})\) to which we do not have access. Assuming the condition \(\) lies in the same space as \(_{t}\), we can follow Kollovieh et al.  and approximate \( p_{}(\,|\,_{t})\) as a multivariate Gaussian distribution:

\[p_{}(\,|\,_{t})=\,|\,_{ }(_{t},t),\, \]

where \(_{}(_{t},t)\) approximates the clean data point, enabling to estimate the condition in data space. Using Eq. (2), we can readily predict the clean data point given the noisy sample \(_{t}\) via

\[_{}(_{t},t)=_{t}-_{t}}\,_{}(_{t},t)}{_{t}}}}_{0}. \]

With this, the _guiding term_ becomes a direct differentiation of the squared error with respect to the noisy sample \(_{t}\):

\[_{_{t}}\! p_{}(\,|\,_{t})=- {2}_{_{t}}_{}(_{t},t)- _{2}^{2}. \]

By directly leveraging the prediction of the unconditional model \(_{}\), Eq. (12) establishes our self-guiding conditioning, thereby defining the self-guided noise predictor \(}_{}\):

\[}_{}(_{t},t,)=_{}( _{t},t)+_{t}}S}{2}_{_{t}}}_{0}-_{2}^{2}. \]

## 4 UniGuide

To enable the application of unconditional molecular diffusion models \(_{}\) to geometric downstream tasks in drug discovery, we aim to develop a unified guidance framework, UniGuide, see Fig. 1. Importantly, we seek to enable guidance from arbitrary geometric conditions \(\), where \(\) denotes a general space of source conditions. However, the source conditions \(\) cannot be directly used for the loss computation in Eq. (12) when they do not match the configuration space \(\).

To address this challenge, we introduce _condition maps_\(C\), which bridge the gap between arbitrary source conditions \(\) and target conditions \(\) suitable for guidance. In Sec. 4.1, we start with its general formulation and continue to derive a condition map \(C_{}\) for the special case where \(=\). This will be useful when discussing the application of UniGuide to various drug discovery tasks in Sec. 4.2. We also demonstrate how to derive a task-specific condition map \(C_{ V}\) for ligand-based drug design.

NotationIn 3D space, the _configuration_ of molecules, including proteins, can be represented by a set of tuples \(=\{(_{i},_{i})\}_{i=1}^{}\), where \(_{i}^{3}\) and \(_{i}^{d}\) refer to coordinates and features of a node \(_{i}=(_{i},_{i})\), respectively. The space of configurations is denoted by \(\) and includes configurations of varying size \(N\). We distinguish between different configuration entities via superscripts, i.e. refer to molecules \(\) and proteins \(\) through \(^{}\) and \(^{}\), respectively. The collection of coordinates \(=\{_{1},,_{N}\}^{N 3}\) defines the _confomation_ of a molecule \(\) or protein \(\). We represent arbitrary geometric conditions with the variable \(\), and conditions that can be used for guidance with the variables \(\).

### Unified self-guidance from geometric conditions \(\)

The concept of a condition map \(C\) is essential to our method, enabling guidance from conditions \(\) in a unified fashion, where \(\) represents a space of general geometric objects such as structures, densities, or surfaces. These geometric objects do not necessarily match the configuration space \(\), i.e. \(\), preventing the computation of the guiding score function from Eq. (12). We overcome this challenge by defining \(C\) as a transformation that maps \(\) to a suitable target condition \(\), which is then utilised for self-guidance.

In the most general case, \(C\) takes the form of

\[C:   \] \[  ,\]

where the source condition \(\) together with a configuration \(\) are mapped to a target condition \(\). Including the condition map \(C\) in the guidance, we obtain our guidance signal:\[_{_{t}}\! p_{}(\,|\,_{t})=- _{_{t}}}_{0}-C(,}_{0 })_{2}^{2}\!\!=-_{_{t}}(}_{0 },), \]

where \(}_{0}=_{}(_{t},t)\) is the estimate of \(_{0}\) given the unconditional model \(_{}(_{t},t)\) obtained according to Eq. (11) and \(=C(,}_{0})\) is the target condition produced by the condition map. In this formulation, \(\) can also be understood as _guidance target_ of the unconditional model.

It is important to highlight that Eq. (15) should not destroy the underlying properties of the unconditional generative process. In particular, if the unconditional model \(_{}\) is equivariant to a set of transformations \(G\), e.g. rotations and translations, as is common in the molecular domain, we want to retain equivariance also in the guidance signal. Hence, the self-guided model \(}_{}\) should satisfy

\[}_{}G(_{t}),t,=G }_{}(_{t},t,)\,, \]

for all transformations \(G\) to which \(_{}\) is equivariant.

**Theorem 4.1**.: _Consider a function \(C:\). If \(C(,)\) is invariant to rigid transformations \(G\) in the first argument and equivariant in the second argument, then the gradient \(_{}\|\|_{2}^{2}\) of the vector \(=-C(,)\) is equivariant to transformations of \(\)._

Proof.: We prove Theorem 4.1 in App. B. 

Using Theorem 4.1, we can guarantee equivariant guidance signals if the condition maps \(C(,)\) are invariant and equivariant under rigid transformations concerning the source condition \(\) and configuration \(\), respectively.

Guidance in the special case of \(=\)In the case where the source condition \(\) directly defines subset \(\) of \(m<N\) nodes of the configuration, i.e. \(=\), we can fully specify the condition map. This is feasible because the condition map no longer needs to bridge different spaces; it only needs to ensure equivariance, as the loss computation between \(\) and the configuration is already possible. To distinguish this special case from the general setting, we denote \(=}^{m(3+d)}\) and refer to the defined subset within the configuration \(}_{0}\) by \(}_{0}^{}\).

In order to satisfy the requirements on \(C},}_{0}^{}\) as stated by Theorem 4.1, we align \(}\) with \(}_{0}^{}\) by using the Kabsch algorithm [59; 60]. Denoting the resulting transformation with \(T_{}_{0}^{}}\), we get an \(}_{0}\)-equivariant condition map:

\[C_{}\!:&^{m(3+d)} ^{m(3+d)}&&^{m(3+d)}\\ &}\;\;}_{0}^{}&&T_{ }_{0}^{}}}. \]

Taken together, we can compute the guidance signal based on the following loss \(\):

\[}_{0}^{},} =}_{0}^{}-T_{}_{0}^{}}}_{2}^{2}. \]

We emphasise that although the loss \(}_{0}^{},}\) is computed on the subset \(\), the gradient, as presented in Eq. (15), is still computed with respect the full configuration \(_{t}\).

In summary, our method requires only an unconditionally trained model \(_{}\) and a suitable condition map \(C\), eliminating the need for additional networks or training. Together, this facilitates unified self-guidance from arbitrary geometric sources. Importantly, the separation of model training and conditioning enables us to tackle tasks even with minimal data, which is crucial in practical scenarios. In the following section, we discuss the wide applicability of UniGuide by illustrating its application to multiple drug discovery tasks.

### UniGuide for drug discovery

Having introduced both the guidance framework and the condition map, we will continue to discuss how to tackle a set of drug discovery tasks within the UniGuide framework. We start with its application to ligand-based drug design (LBDD), which aims to generate a ligand that satisfies a predefined molecular shape.

Ligand-based drug designLBBD aims to generate novel ligands with a similar 3D shape as a reference ligand \(_{}\). In this setting, one operates on the molecule level only since the protein information is assumed to be unknown. However, to still generate active ligands that bind to a protein pocket, one leverages the 3D shape information of a reference molecule. Specifically, the goal is to modify the generative process \(}_{}\) to generate a ligand \(_{0}\) with a similar 3D shape but different molecular structure than \(_{}\). With Sec. 4.1 introducing all required concepts, we can readily formulate a _surface condition map_\(C_{ V}\) suitable to tackle the task of LBBD, see Fig. 2:

To represent \(_{}\)'s 3D shape, we identify our source condition \(\) with a set of \(K\) points \(\) sampled uniformly from the reference ligand's surface \( V\), \(^{K 3}=\). As no features are guided, we formulate \(C_{ V}\) with respect to the conformation space \(=^{N 3}\):

\[ C_{ V}:^{K 3} ^{N 3}&^{N 3}\\ }_{0}& _{}, \]

where \(}_{0}\) denotes the conformation of the clean data point estimation \(}_{0}\) as computed by Eq. (11). To satisfy Theorem 4.1, \(C_{ V}\) first aligns \(\) with \(}_{0}\) by a rotation \(R_{}_{0}}^{3 3}\) resulting from the ICP algorithm . For every atom coordinate \(}_{i}\), \(C_{ V}\) subsequently computes the mean \(}_{i}\) over \(}_{i}\)'s \(k\) closest surface points:

\[}_{i}=_{j_{}_{i}}}R_{ }_{0}}_{j}_{}_{i}} =_{I\{1,,K\},|I|=k}_{j I}\|R_{}_{0}}_{j}-}_{i}\|_{2}. \]

Finally, the individual components \(_{,i}\) of the target condition compute as follows:

\[_{,i}=}_{i}+(}_{i}-}_{i})\;,&}_{i}V\\ }_{i}-(}_{i}-}_{i})\;,&}_{i}V d<\\ }_{i}\;,&, \]

where \(d\) denotes the distance to the surface, \(d=\|}_{i}-}_{i}\|_{2}\), and \(\) the required distance to the surface. Note that the target condition \(_{}\) represents a valid conformation inside the surface \( V\), and that \(C_{ V}\) effectively bridges spaces from \(\) to \(\). Consequently, when using \(C_{ V}\), the guidance signal is derived from Eq. (15) with the loss function \((}_{0},)\). The full algorithm for guidance using \(C_{ V}\) is presented in App. D.1.

Structure-based drug designThe goal of SBDD is to design a ligand that binds to a target protein pocket \(\). In this setting, one operates on both the molecule and protein level. Technically, we are interested in generating a ligand \(_{0}^{}\) conditioned on the protein configuration \(}^{}\). With the unconditional diffusion model \(_{}(_{t},t)\), \(_{t}=(_{t}^{},_{t}^{})\), approximating the joint distribution of ligand-protein pairs \(p(_{}^{},_{}^{})\), one can readily see that the source condition directly corresponds to the configuration of the protein pocket. Hence, we can use \(C_{}\) from Sec. 4.1 and identify \(}\) with \(}^{}\). The guidance signal then follows from the loss \((}_{0}^{},}^{})\) with \(^{}=C_{}(}^{},}_{0}^{})\) as defined in Eq. (18). We describe the sampling algorithm for the SBDD task in App. E.1.

Fragment-based drug designFBDD aims to design a ligand by optimising a molecule around fragments \(\) that bind weakly to a receptor. Similarly to SBDD, one operates on both the molecule and protein level. Technically, we are interested in generating a ligand \(_{0}^{}\) conditioned on both the protein and the fragment configuration, \(}^{}\) and \(}^{}\), respectively. Considering the same kind of unconditional model \(_{}(_{t},t)\) as in SBDD, we can use \(C_{}\) from Sec. 4.1. Only now, we identify \(}\) with both \(}^{}\) and \(}^{}\) and write \(}^{}\) with \(=\). Using Eq. (18), the guidance signal directly follows from \((}_{0}^{},}^{ })\) with \(^{}=C_{}(}^{ },}_{0}^{})\). The sampling algorithm is similar to the one described in App. E.1.

Several tasks exist within the FBDD setting [62; 63; 64; 65]. Examples are scaffold hopping , where the core structure of \(_{0}^{}\) has to be generated, but functional groups that interact with the receptor are

Figure 2: Surface condition map \(C_{ V}\): For each atom coordinate \(_{i}\), the closest surface points \(_{j}\) are computed. The target condition \(_{,i}\) is the projection along the mean of neighbours \(}_{i}\) to the inside of the volume by a margin \(\), where \(d=\|}_{i}-}_{i}\|_{2}\).

fixed, or linker design , where the connection between separated fragments has to be optimised through the generative process, see Fig. 5. Note that these tasks differ primarily in their application and can be treated identically from a technical perspective within UniGuide. In addition, one can also consider variations where the protein information \(}^{}\) is discarded. This usually aligns with switching to an unconditional model \(_{}\) that solely models the distribution over molecules. We present results for this configuration in Sec. 5.3.

Furthermore, we would like to highlight that it is possible to combine guidance strategies within UniGuide. For example, one could incorporate a version of the surface condition map \(C_{ V}\) for FBDD to provide an additional geometric guidance signal for the atoms not included in \(\).

LimitationsDrug discovery also involves tasks beyond purely geometric conditions, encompassing global graph properties . These are excluded from the UniGuide framework. Additionally, UniGuide requires the unconditional model to be trained on a matching configuration space. We discuss the broader impact of our work in App. A.

## 5 Results

In this section, we compare UniGuide to state-of-the-art models across various drug discovery tasks. To highlight the wide range of tasks to which unconditional models can be adapted through UniGuide, we conduct experiments on ligand-based (Sec. 5.1), structure-based (Sec. 5.2) and fragment-based (Sec. 5.3) drug design. We demonstrate that UniGuide performs competitively or even surpasses specialised baseline models, underscoring its practical relevance and transferability to diverse drug discovery scenarios.

### Ligand-based drug design

DatasetFollowing Chen et al. , we employ the MOSES dataset for the ligand-based drug design task . We evaluate on a test set consisting of \(1000\) reference ligands, from which the 3D shape conditions are extracted. For every shape condition \(_{}\), \(50\) samples are generated. We refer to App. D.1 for further details on the evaluation setup.

BaselinesFor the LBDD task, we compare UniGuide to ShapeMol, a conditional diffusion model that is trained by conditioning on learned latent embeddings of the molecular surfaces . Chen et al.  also propose a correction technique that adjusts the atom positions based on their distance to the reference ligand's nodes, which is refered to as ShapeMol+g. Additionally, we include as baselines Virtual Screening (VS) , a shape-based virtual screening tool, and SQUID , a variational autoencoder that decodes molecules by sequentially attaching fragments with fixed bond lengths and angles. For this task, we evaluate UniGuide equipped with the surface condition map \(C_{ V}\) from Eq. (21) in conjunction with two _unconditionally trained_ diffusion models, ShapeMol [U] and EDM [14; 20] as well as the _conditional_ model ShapeMol . The "only shape" column in Tab. 1 indicates whether a method uses solely the reference ligand's shape or also incorporates its atom positions.

We compare UniGuide with an alternative guidance approach adapted from Guan et al.  in App. D.4 and refer to App. C and App. D.3 for further information on the unconditional models and the guidance parameters, respectively. In addition, inspired by the performance of UniGuide on the

LBDD task, we further motivate its applicability for the generation of molecules given atom densities, see App. G.

EvaluationThe goal of LBDD is to discover novel molecules that fit within a given 3D shape. This can be quantified by a high 3D shape similarity and low graph similarity compared to the reference ligand, as illustrated in Fig. 3 as well as App. D.2. We highlight this trade-off by reporting the ratio of these similarities in Tab. 1 as \(_{S}/_{G}\), which constitutes the most important metric for this task. We follow Chen et al.  and further evaluate the mean and maximum shape similarities \(_{S}\) and \(_{S}\), respectively, per reference ligand, measured via the volume overlap between the two aligned molecules. Additionally, we report the graph similarity \(_{G}\) defined as the Tanimoto similarity between the generated and reference ligand, and the graph similarity \(_{G}\) of the generated molecule with the maximum shape similarity. Further metrics concerning the quality of the generated ligands are provided in App. D.2.

Both in terms of shape similarity and graph similarity, guiding the generation of EDM with UniGuide outperforms other task-specific conditioning mechanisms and even the Virtual Screening baseline. Emphasised by the Ratio metric across all evaluated methods, UniGuide demonstrates that it is able to generate diverse molecules with very similar shapes compared to the reference ligand. Remarkably, UniGuide achieves higher shape similarity than ShapeMol+g, even though the conditional model is explicitly guided towards the position of the reference ligand through the position correction technique. UniGuide, on the other hand, does not require information about the reference's atom positions at all to generate novel, high-quality ligands. This highlights how UniGuide and the design of condition maps enables unconditional models like EDM, that have not been tailored or trained for the LBDD task, to achieve state-of-the-art performance on new tasks.

### Structure-based drug design

DatasetsFollowing Schneuing et al. , we evaluate UniGuide on two protein-ligand datasets: the CrossDocked dataset  and the Binding MOAD dataset . For the CrossDocked dataset, we follow the preprocessing as described by  and conduct the evaluation on \(100\) test protein pockets.

    & & Method & Vina Score (\(\)) & Vina Min (\(\)) & Vina Dock (\(\)) & QED (\(\)) & SA (\(\)) \\    } &   } & Test Set & \(-6.362 3.14\) & \(-6.707 2.50\) & \(-7.450 2.33\) & 0.48 & 0.73 \\   & &   & \(3\)D-SBDD\({}^{*}\) & \(\) & \(-6.180 2.42\) & \(-6.746 4.02\) & 0.51 & 0.63 \\   & &   & \(-5.139 3.17\) & \(-6.415 2.93\) & \(-7.152 4.90\) & 0.56 & 0.74 \\   & &   & \(-4.750-\) & \(-6.170-\) & \(-\) & \(-\) & \(-\) \\   & &   & \(-5.466 8.32\) & \(-6.643 4.94\) & \(-7.802 3.62\) & 0.48 & 0.58 \\   & &   & \(-3.684 1.13\) & \(-4.670 6.06\) & \(-6.941 4.33\) & 0.47 & 0.58 \\   & &   & \(-4.097 11.3\) & \(-6.306 5.00\) & \(-7.889 2.61\) & **0.57** & **0.64** \\   & &   & \(-5.103 8.39\) & \(-6.610 4.20\) & \(\) & **0.57** & **0.64** \\     } &   } & Test Set & \(-6.748 2.77\) & \(-7.563 2.53\) & \(-8.297 2.03\) & 0.60 & 0.64 \\   & &   & \(-4.466 2.63\) & \(-6.309 2.52\) & \(-7.482 1.84\) & 0.43 & 0.56 \\    & &   & \(-4.744 7.70\) & \(-6.586 2.59\) & \(-7.767 2.06\) & 0.55 & **0.62** \\    & & 
  & \(-5.074 6.75\) & \(-6.622 2.57\) & \(-7.911 1.97\) & **0.56** & 0.61 \\   

Table 2: Structure-Based Drug Design. Quantitative comparison of generated ligands for target pockets from the CrossDocked and Binding MOAD test sets. Results taken from the respective works are indicated with \((^{*})\). We highlight the best conditioning approach for the DiffSBDD backbone in **bold** and underline the best approach over all methods.

Figure 3: Examples of the two shape-conditioned ligands generated by UniGuide. The goal is to have _low_ molecular graph similarity and _high_ shape similarity. The parameter space similarity is the same as the _Binding_ model. The _Binding_ model is the same as the _Binding_ model. The _Binding_ model is the same as the _Binding_ model.

The Binding MOAD dataset is preprocessed as discussed in Schneuing et al. , resulting in \(130\) test proteins. Per target pocket, \(100\) ligands are generated. We evaluate the generation of ligands on models that are trained on the full-atom context of the pockets in Tab. 2 and results of models trained on the \(C_{}\) representation of the pockets are provided in App. E.5.

BaselinesWe compare UniGuide to two autoregressive models designed for the SBDD task: 3D-SBDD  and Pocket2Mol . We further include TargetDiff  and DecompDiff , conditional diffusion models for SBDD that fix the protein pocket context during every step of the diffusion process. We exclude approaches with explicit drift terms like Guan et al.  and Huang et al.  from the comparison, as UniGuide's SBDD condition map does not include drift terms currently, but can be readily extended to do so. Schneuing et al.  present two techniques for controlled structure-based generation: (i) DiffSBDD-cond, a conditional diffusion model similar to  and (ii) DiffSBDD, an inpainting-inspired technique that modifies the generative process of an unconditional diffusion model that jointly generates protein-ligand pairs. Across datasets, both UniGuide and DiffSBDD control the same unconditional ligand-protein diffusion model. We provide more information and further evaluation regarding this base model in App. E.2 and App. E.3 and investigate the influence of the guidance scale \(S\) as well as the resampling trick , a technique that modifies the generative process to better harmonise the generated ligand with the controlled pockets, in App. E.4 and App. E.5.

EvaluationAs the task of SBDD is to generate ligands that bind well to a given protein pocket, we assess generated ligands based on affinity-related metrics (Vina Score, Vina Min and Vina Dock), which estimate the binding affinity between the generated ligands and a given test receptor . Additionally, we measure the quality of the generated ligands using two chemical properties: the drug-likeness (QED) and the synthetic accessibility (SA) [66; 73].

Tab. 2 demonstrates that, without additional training or external networks, UniGuide performs competitively with even the highly specialised conditional models like TargetDiff and DecompDiff. Our results indicate that not fully converging to the target protein pocket due to soft guidance, compared to, for example, DiffSBDD's inpainting-inspired technique, is not a limitation in practice. Rather, it suggests that utilising self-guidance in combination with a suitable condition map generates well-harmonised ligand-protein pairs. This is also reflected in the properties of the generated ligands, where UniGuide achieves good drug-likeness (QED) and synthetic accessibility (SA) scores. We provide additional qualitative examples for the SBDD task in Fig. 4, which showcase that UniGuide not only generates drug-like ligands but is even able to improve over the VINA Dock metric of the reference ligand.

### Fragment-based drug design

Datasets & BaselinesIn the following, we investigate linker design, a subfield of fragment-based drug design. We follow Igashov et al.  and decompose ligands from the ZINC dataset  with the MMPA algorithm . Note that the ZINC dataset does not contain pocket information, and the evaluated approaches operate solely at the molecular level. We compare UniGuide to DiffLinker , a diffusion-based conditional model that fixes fragments in space. Additionally, we evaluate

Figure 4: Qualitative example of a test protein pocket (6c0b) from the Binding MOAD dataset. We show the reference ligand (grey) and samples generated by UniGuide (blue).

    & QED (\(\)) & SA (\(\)) & No. Rings (\(\)) & Valid (\(\)) & Unique (\(\)) & 2D Filters (\(\)) & Recovery (\(\)) \\  Non- &  UniGuideâ€™s \\ diffusion \\  &  Deller+ConVAE +MMFF * \\ 30Linker * \\  & 
 0.64 \(\) 0.16 \\ 0.

the variational autoencoder-based methods DeLinker  and 3DLinker , adapted as described in Igashov et al. . We provide more information on the experimental setup as well as the unconditionally trained EDM model in App. F.1 and App. C.

EvaluationFollowing Igashov et al. , we evaluate the generated linkers and ligands with respect to their properties (SA, QED, Number of Rings and 2D Filters). We additionally measure (i) the uniqueness of the generated samples, (ii) the recovery of the reference ligands, and (iii) the validity, which combines the chemical validity and the successful linking of the fragments.

Using UniGuide to control the EDM generation enables the successful combination of the condition fragments and the generation of diverse linkers. Even compared to task-specific models, UniGuide is able to perform competitively across different metrics. Importantly, UniGuide enables the same unconditional model (EDM) to tackle both the linker design task as presented in Tab. 3 as well as the LBDD task as presented in Tab. 1 without additional training. Note that, while DiffLinker is specifically designed to generate linkers, UniGuide readily generalises to other tasks within the FBDD setting, such as fragment growing and scaffolding, see Fig. 5. Additionally, UniGuide is agnostic to the fragmentation procedure used to obtain the condition scaffolds, meaning that UniGuide will generalise to unseen fragments as long as the underlying molecule fits within the training distribution. In App. F.2, we demonstrate how the same unconditional model can be adapted for these tasks. Our quantitative evaluation highlights the benefits achieved through the unification of controlled generation provided by UniGuide.

## 6 Conclusion

In this work, we present UniGuide, a unified way of controlling the generation of molecular diffusion models towards geometric constraints. UniGuide generalises to a multitude of drug discovery tasks without the need for conditioning networks or specialised training protocols, enabling UniGuide to find applicability also in scenarios where little data is available. By demonstrating that specialisation is not a necessity and that a more flexible, unified method outperforms specialised approaches across tasks and datasets, we open up new avenues for streamlined and flexible generative models with wide-ranging applications.

AcknowledgementsSA, LH, and JS are thankful for valuable feedback from Marcel Kollovieh, Leo Schwinn, and Alessandro Palma from the DAML group and Theis Lab. SA is supported by the DAAD programme Konrad Zuse Schools of Excellence in Artificial Intelligence, sponsored by the Federal Ministry of Education and Research. LH is supported by the Helmholtz Association under the joint research school "Munich School for Data Science - MUDS". FJT acknowledges support from the Helmholtz Association's Initiative and Networking Fund through Helmholtz AI (ZT-1-PF-5-01). FJT further acknowledges support by the BMBF (01IS18053A). In addition, FJT results for Immunai Inc., Singularity Bio B.V., CytoReason Ltd, and Omniscope Ltd and has an ownership interest in Dermagnostix GmbH and Cellarity.

Figure 5: For various pocket-conditioned FBDD tasks, we show reference ligands (grey), desired fragments (magenta), and ligands generated by UniGuide (blue).