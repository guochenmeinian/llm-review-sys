# Lite Class-prompt Tiny-VIT for Multi-Modality Medical Image Segmentation

Haotian Guan

1Department of Electrical and Electronic Engineering, The University of Hong Kong, Hong Kong, China

1jiajingz@connect.hku.hk

 Bingze Dai

1Department of Electrical and Electronic Engineering, The University of Hong Kong, Hong Kong, China

1jiajingz@connect.hku.hk

1Department of Electrical and Electronic Engineering, The University of Hong Kong, Hong Kong, China

1jiajingz@connect.hku.hk

1Department of Electrical and Electronic Engineering, The University of Hong Kong, Hong Kong, China

1jiajingz@connect.hku.hk

1Department of Electrical and Electronic Engineering, The University of Hong Kong, Hong Kong, China

1jiajingz@connect.hku.hk

1Department of Electrical and Electronic Engineering, The University of Hong Kong, Hong Kong, China

1jiajingz@connect.hku.hk

1Department of Electrical and Electronic Engineering, The University of Hong Kong, Hong Kong, China

1jiajingz@connect.hku.hk

1Department of Electrical and Electronic Engineering, The University of Hong Kong, Hong Kong, China

1jiajingz@connect.hku.hk

1Department of Electrical and Electronic Engineering, The University of Hong Kong, Hong Kong, China

1jiajingz@connect.hku.hk

1Department of Electrical and Electronic Engineering, The University of Hong Kong, Hong Kong, China

1jiajingz@connect.hku.hk

1Department of Electrical and Electronic Engineering, The University of Hong Kong, Hong Kong, China

1jiajingz@connect.hku.hk

1Department of Electrical and Electronic Engineering, The University of Hong Kong, Hong Kong, China

1jiajingz@connect.hku.hk

1Department of Electrical and Electronic Engineering, The University of Hong Kong, Hong Kong, China

1jiajingz@connect.hku.hk

1Department of Electrical and Electronic Engineering, The University of Hong Kong, Hong Kong, China

1jiajingz@connect.hku.hk

1Department of Electrical and Electronic Engineering, The University of Hong Kong, Hong Kong, China

1jiajingz@connect.hku.hk

1Department of Electrical and Electronic Engineering, The University of Hong Kong, Hong Kong, China

1jiajingz@connect.hku.hk

1

###### Abstract

The increasing demand for accurate medical image segmentation is crucial for alleviating the workload of doctors and enhancing diagnostic accuracy, particularly in low-income countries with limited computational resources. This study investigates the application of a novel deep learning model, class-prompt Tiny-VIT, to segment various medical image modalities using a laptop. The primary focus is on the challenges posed by the significant differences across image modalities, which render a unified model ineffective in handling certain modalities like positron emission tomography (PET) with high dice similarity on the segmentation task. Experimental results demonstrate that the class prompt, a simplified yet efficient method, can effectively boost model performance on modalities such as PET and microscopy, achieving improved overall segmentation accuracy. This research holds significant potential for the practical implementation of medical image segmentation in resource-constrained settings, and underlines the importance of developing deep learning algorithms tailored to specific medical imaging modalities.

Keywords:Multi-modality Medical image segmentation Class prompt TinyVIT

## 1 Introduction

Medical image segmentation plays a crucial role in computer-aided diagnosis, treatment planning, disease progression monitoring, image-guided interventions, and personalized medicine. The accurate delineation of anatomical structures and pathological regions is essential for effective clinical decision-making .

Various deep-learning based semantic segmentation models have been proposed  while most existing fundamental segmentation models are mainly based on natural images. Various machine learning based models were proposed to cope with different specific segmentation tasks including brain, liver, tumour, cell, lung, cardiac, vascular etc with different imaging modalities such as MRI, OCT, ultrasound, X-Ray, ultrasound etc and have demonstrated remarkable success in medical image segmentation tasks which helps on various medicaltasks including tumor diagnostic , vessel and tissue characterization and so on .

However, the complexity and diversity of medical imaging modalities, along with the inherent variability in anatomical structures, make it difficult to design a robust and efficient segmentation model that can perform well across different imaging scenarios . Instead of focusing on specialized models for single tasks, researchers have explored more generalized models that can manage multiple scenarios like SAM , this trend also lead to the development of generalized methods for medical image segmentation across different modalities with U-Net architecture  and models inspired by SAM like MedSAM  and so on. While in the meantime, these methods often require substantial computational resources, which may not be feasible for deployment on resource-constrained devices such as laptops. To enable real-time processing and edge-machine use with such machine learning models, the size and computation complexity need to be reduced. To this end, MobileSAM , and EfficientViTSAM , TinyVIT  have shown promising results in terms of both accuracy and computational efficiency. These methods employ self-attention mechanisms to capture global and local contextual information to improve performance with comparable small models. However, despite their success, these methods still face limitations in terms of model size, computational complexity, and adaptability to different imaging modalities, particularly when considering the deployment of these methods on resource-constrained devices such as laptops with an 8G CPU without GPU that is commonly used in clinical.

To solve the computation cost and multi-modality generalization challenges mentioned above, inspired by TinyVIT  and Vision Transformer (ViT) architecture  which have demonstrated great potential in computer vision tasks, here we propose a novel approach Class-prompted TinyVIT network for medical image segmentation across different imaging modalities, with high accuracy and low computation cost that is capable of running on an 8G CPU device in almost real-time. The Class-prompted TinyVIT is inspired by the actual divisions in hospitals where different modalities are assigned to specific doctors instead of letting the same doctor to read all modalities images. By this class-prompt method, the model would acquire the modality class information while using the same model with tuned parameters with specific modality while keep the similar model size.

By adapting this architecture, we aim to provide a compact and efficient solution that can be deployed on devices with limited computational resources. Our primary contribution lies in introducing class-prompt to the late TinyVIT model to cope with the multi-modality medical image segmentation across different imaging modalities effectively as specialized models. The combination of compact model size, high accuracy, and compatibility with resource-constrained CPUs makes our approach a promising solution for real-world medical imaging applications. Furthermore, we conduct experiments on the provided dataset to validate the effectiveness of our approach. The results demonstrate superior segmentation accuracy and computational efficiency, highlighting the potential of our approach in advancing medical image analysis for edge-device application. In summary, this paper presents a novel class-prompted TinyVIT-based approach for medical image segmentation that addresses the challenges of model size, computational complexity, and adaptability to diverse imaging modalities. Our solution holds the potential to significantly impact the field of medical image analysis, particularly in the context of deployment on resource-constrained devices.

## 2 Method

We introduce a pioneering class-prompt-based methodology aimed at enhancing segmentation efficacy across a spectrum of medical imaging modalities. Drawing inspiration from the specialized organizational structure of hospitals, where domain experts are assigned to interpret distinct imaging modalities, our objective is to cultivate expert models tailored to each modality. However, the deployment of 11 individual models on a laptop proves unfeasible due to memory constraints. To address this challenge, we propose a prompt-driven approach that effectively communicates the current input modality to the model, thereby transforming it into an adept specialist for the specific modality under consideration. This innovative strategy enables us to uphold a concise and efficient model architecture while attaining superior segmentation performance across diverse medical imaging tasks.

### Preprocessing

The original dataset consists of eleven modalities with unbalanced data samples as illustrated in Fig. 1. Among those, CT holds the biggest portion with 1218411 items. The size of the whole training dataset is about 6TB with 1,000,000+ image-mask pairs, covering 10 medical image modalities and more than 20 cancer types. To deal with such a large and imbalanced dataset, to avoid redundant and long training time costs, we first sampled the original dataset. Though we can try to train on the whole dataset to get a more comprehensive model, the time and electricity cost for the training process would be very burdensome. As a result, not only to make the model like, we decide to make the training process also lie so that researchers with a single normal GPU can train it within reasonable time and calculation cost. Here we first sampled the original large dataset less than 1/10 of its original size. As CT images are far more than the number of other modalities, we randomly sampled CT images with 1/50 and randomly sampled other modalities to 1/10 of original numbers as shown in Figure 1. After sampling, the sampled dataset size drops to less than 300 GB.

Not only the number of each modality is different, the image and mask size in different modalities are also different which draws a problem to input the same model for training. As a result, to fit the training model, we first resize all the input images to 256*256 pixels to keep consistence so that we can use the same lite model. Boxes are generated using ground truth. Ground truth are covered completely by the box. In theory, area outside the box should not be segmented.

### Proposed Method

**Class Prompt:** Various image classifier models have been explored, including traditional networks, deep learning, transfer learning, self-supervised learning, and more . However, most of these models use large architectures, making them unsuitable for tasks with limited computational resources.

In our model, we address this limitation by incorporating a classifier that leverages the TinyVIT encoder. This approach notably diminishes both the model's size and parameter count. To enhance the classifier's efficacy further, we have integrated a three-layer multilayer perceptron (MLP) network as the modality classifier head. This augmentation exploits the insights derived from the encoder structure. As a result, our model showcases outstanding performance.

Specifically, we equipped TinyVIT with a class prediction head, which is implemented as a multilayer perceptron (MLP) that starts with an input dimension of 256. This MLP features a hidden layer dimension of 256, and is designed to classify data into one of 11 distinct categories. The architecture includes three layers, to process and refine the information through successive transformations. The first layer takes the input vector \(\) of dimension 256 and transforms it to a hidden state \(_{1}\) using a linear transformation followed by a non-linear activation function (ReLU). The MLP is represented as:

\[_{1}=ReLU(_{1}+_{1}) \] \[_{2}=ReLU(_{2}_{1}+_{2})\] (2) \[=_{3}_{2}+_{3} \]

Figure 1: Number of images of different modalities in original dataset and sampled dataset for training.

where \(_{1},_{2},_{3}\) are the weight matrixes and \(_{1},_{2},_{3}\) is the bias vectors. This structure allows the classifier to effectively learn and make predictions by capturing complex patterns and relationships in the data, making it a vital component in achieving high accuracy in our classification tasks.

#### 2.0.1 Class-prompt Tiny-VIT

Class prompt takes the categories from the classification head in encoder and returns a prompt for mask decoder. The pretrained encoder makes sure that images modalities can be correctly identified. The small size of class prompt encoder is specially designed for running inference on laptop. The prompt is added to the box prompt as the input of decoder. Our decoder is a transformer with three blocks.

#### 2.0.2 Loss function:

We use the summation between Dice loss and focal loss because compound loss functions have been proven to be robust in various medical image segmentation tasks .

a) Dice loss is a performance metric derived from the Dice coefficient, which is commonly used to gauge the similarity between two samples. Specifically tailored for the field of medical image segmentation, the Dice loss function is particularly effective in handling class imbalance, a frequent challenge where the region of interest occupies a significantly smaller portion of the image compared to the background. The Dice loss is calculated as

\[L_{Dice}=1- \]

Figure 2: Class-prompted TinyVIT Network architecture. Class prompt takes the categories from the classification head in encoder and returns a prompt for mask decoder.

where \(X\) and \(Y\) represent the binary prediction and ground truth masks, respectively. This loss function ensures that the model is not only predicting the classes accurately but also aligning closely with the actual contours and boundaries of the regions of interest in the images.

b) Focal loss is an advanced adaptation of the cross-entropy loss, specifically designed to address the prevalent issue of class imbalance by concentrating more on difficult, misclassified examples. This is particularly useful in image segmentation tasks where there is a significant imbalance between different classes. The focal loss function is mathematically represented as:

\[L_{Focal}=-_{t}(1-p_{t})^{}(p_{t}) \]

Here, \(p_{t}\) is the probability that the model assigns to the ground truth class. The parameter \(\) is the focusing parameter, which scales how much the function focuses on hard examples. The term \((1-p_{t})^{}\) decreases the loss contribution from easy examples and increases the importance of correcting misclassified examples. \(_{t}\) is a balancing factor that can be used to give more focus to rare classes. This formulation helps in fine-tuning the model's predictions, ensuring that it not only achieves high accuracy but also improves performance on the more challenging aspects of the segmentation task.

From the perspective of inference efficiency, our simple MLP structure can be easily implemented on CPU-only machines without complex acceleration strategies.

### Post-processing

The size of the mask outputted from the model is unified to 256 by 256. In order to obtain the mask for the original medical image, we resize the outputted mask to the original size with bilinear interpolation. The model will produce a prediction for each box with its index. To save the complete result, all boxes and corresponding segmentation are saved as an overlay.

## 3 Experiments

### Dataset and evaluation measures

We used the challenge dataset for model development, including 11 modalities and both 2D and 3D images.

The evaluation metrics include two accuracy measures--Dice Similarity Coefficient (DSC) and Normalized Surface Dice (NSD)--alongside one efficiency measure--running time.The Dice Similarity Coefficient (DSC) is formulated as follows:

\[DSC=\]

where \(P\) represents the set of pixels in the predicted segmentation mask, \(G\) represents the set of pixels in the ground truth segmentation mask, \(||\) denotes the cardinality or size of the set, \(\) denotes the intersection of sets.

The formula for Normalized Surface Dice (NSD) is given by:

\[NSD=1-\]

where \(A\) and \(B\) are the segmentation mask and ground truth being compared. \(Surface(A)\) and \(Surface(B)\) represent the surface areas of masks \(A\) and \(B\) respectively. \(Surface(A B)\) represents the surface area of the intersection of masks \(A\) and \(B\).

This formula calculates the Dice similarity coefficient between the surfaces of the two masks and normalizes it by the average surface area of the two masks. A higher NSD value indicates a better overlap between the surfaces of the two masks.

### Implementation details

#### 3.2.1 Environment settings

The development environments and requirements are presented in Table 1.

#### 3.2.2 Training protocols

1. Data augmentation: in the domain of multimodal medical image segmentation, the strategic implementation of data augmentation stands as a pivotal factor in augmenting model generalization and precision. By adhering to a data augmentation rate of 0.5, incorporating stochastic horizontal flips (fliplr) and vertical flips (flipud), we enrich the training dataset by introducing nuanced variations within the multimodal input images and their corresponding segmentation maps. These meticulous operations empower the model to discern and delineate anatomical structures resilient to horizontal and vertical transformations, thereby fortifying its resilience and efficacy across a spectrum of modalities. Through these refined data augmentation methodologies, our primary objective is to enhance the model's proficiency in accurately segmenting intricate anatomical entities in multimodal medical images, thereby advancing its efficacy within clinical frameworks.

  System & Ubuntu 18.04.5 LTS \\  CPU & Intel Xeon W-2225 10C/20T 4.1Ghz \\  RAM & 32GB DDR4-3200 ECC RDIMM \\  GPU (number and type) & One NVIDIA GeForce RTX 3090 24G \\  CUDA version & 10.496 \\  Programming language & Python 3.80 \\  Deep learning framework & torch 2.0, torchvision 0.2.2 \\  Specific dependencies & None \\  Code & None \\  

Table 1: Development environments and requirements. (mandatory table)2. Data sampling strategy: during the model training phase, the challenge organizer's publicly available training data was partitioned randomly into training and validation sets in a 7:3 ratio. Specifically, for the 2D image modality, random sampling was directly employed. However, in the case of 3D image modalities such as CT, MRI, and PET, the conventional approach of preprocessing involves segmenting each 3D image into multiple consecutive 2D slices, leading to a proliferation of redundant data due to the significant similarity between adjacent slices. To address this issue, a uniform interval sampling technique was implemented to extract 2D slices from the 3D images, with a fixed spacing of 5 between neighboring samples. This method effectively reduces data redundancy and enhances training efficiency by minimizing the inclusion of highly similar information found in adjacent slices.

3. Optimal model selection criteria: optimal model selection criteria are particularly critical when tasked with segmenting multimodal medical images. In this context, the criteria must be tailored to the nuances of medical image analysis. Given the complexity and variability of medical data, the selected criteria should prioritize robustness and generalizability across different imaging modalities, such as MRI, CT, and PET scans. Here we used Dice similarity coefficient, Jaccard index, and Normalized Surface Distance(NSD) to evaluate segmentation performance in medical imaging tasks. Besides, inferences time is also included in the selection program, giving the same weight as the segmentation performance.

## 4 Results and discussion

### Quantitative results on validation set

Table 4 explains the efficiency of all models by computing the inference time on 14 representative images across all image modalities. On laptop with CPU, 3D

 p{284.5pt}}  Pre-trained Model & MedSAM  \\   Batch size & 64 \\  Patch size & 256\(\)256\(\)3 \\   Total epochs & 20 \\  Optimizer & AdamW  \\  Initial learning rate (lr) & 5e-4 \\  Lr decay schedule & ReduceLROnPlateau \\  Training time & 75 hours \\  Loss function & Dice Loss, Cross Entropy Loss, Focal Loss \\  Number of model parameters & 10.99M \\  Number of flops & 2.2G \\  CO\({}_{2}\)eq & 15 Kg \\  

Table 2: Training protocols. (mandatory table)images take much longer inference time since the model deals with segmentation frame by frame. The bottleneck is also on resizing large images to regular input size 256 by 256. Overall, baseline model runs fastest and ablation study is comparable in running time. Our proposed method runs 1.3% to 16.7% slower than baseline model.

The results of our quantitative experiments are shown in Table 3. The table presents a comprehensive quantitative evaluation of three models: baseline, ablation model, and our class-prompt Tiny-VIT. Each model's performance is assessed based on Dice Similarity Coefficient (DSC) and Normalized Surface Dice (NSD) metrics across various imaging modalities including CT, MR, PET, US, X-ray, dermatology, endoscopy, fundus, and microscopy.

Upon the quantitative results, it is evident that our class-prompt Tiny-VIT consistently outperforms both the baseline and ablation model across most modalities. Specifically, compared with the baseline, our class-prompt Tiny-VIT demonstrates superior DSC of 3.54%, 7.62%, 27.55%, 1.20%, 1.36%, and 19.68% for CT, MR, PET, X-ray, dermatology, and microscopy, respectively. compared with the baseline, our class-prompt Tiny-VIT demonstrates superior NSD of 4.25%, 8.44%, 95.32%, 2.66%, 0.17%, and 21.33% for CT, MR, PET, X-ray, dermatology, and microscopy, respectively. The improvement indicates our efficacy in accurately segmenting, especially for PET and microscopy images, which is also evidenced by the normalized radargram. As for ultrasound, endoscopy, and fundus images, our class-prompt Tiny-VIT can reach segmentation performance in line with the baseline, thus demonstrating that our improvement in the majority of modalities does not compromise the segmentation performance of the minority modalities. Notably, our class-prompt Tiny-VIT achieves the highest average DSC and NSD values of 86.89% and 88.04% respectively, showcasing its overall effectiveness in comparison to the baseline and ablation modal.

To further demonstrate the role of class prompts, we conducted three fine-tuning experiments. We fine-tuned the baseline on PET, ultrasound, and X-ray

   &  &  &  \\   & DSC(\%) & NSD(\%) & DSC(\%) & NSD(\%) & DSC(\%) & NSD (\%) \\  CT & 89.1 & 91.03 & 89.69 & 91.29 & 92.26 & 94.90 \\ MR & 83.28 & 86.1 & 81.39 & 83.42 & 89.63 & 93.37 \\ PET & 55.1 & 29.12 & 63.19 & 46.04 & 70.28 & 56.88 \\ US & 94.78 & 96.81 & 92.92 & 96.3 & 94.77 & 96.81 \\ X-Ray & 75.83 & 80.39 & 76.7 & 82.53 & 76.74 & 82.53 \\ Dermatology & 92.47 & 93.85 & 92.45 & 94.01 & 93.73 & 94.01 \\ Endoscopy & 96.04 & 98.11 & 95.41 & 97.56 & 96.04 & 98.11 \\ Fundus & 94.8 & 96.41 & 94.56 & 96.2 & 94.81 & 96.41 \\ Microscopy & 61.63 & 65.39 & 73.76 & 79.34 & 73.76 & 79.34 \\  Average & 82.56 & 81.91 & 84.45 & 85.18 & 86.89 & 88.04 \\  

Table 3: Quantitative evaluation results.

datasets separately to simulate the effect when the model focuses only on a certain class of modes. The DSC and NSD radargrams of the fine-tuning results are shown in Fig. 3. The results show that continual fine-tuning on the ultrasound and X-ray datasets alone does not improve the model performance, but rather leads to a degradation of it. Therefore, it is not feasible to simply fine-tune on each class and then integrate the fine-tuned models of each class. However, the original baseline performs poorly on certain modalities (e.g., PET), and further fine-tuning on these modalities can significantly boost the segmentation performance on that modality, which is not achievable with multimodal mixed training. Therefore, it is worthwhile to enable the model to have an independent perception of each class and to make class-specific processing.

Figure 3: The Dice result (the first row) and NSD result (the second row) of the baseline model, and baseline model fine-tuned (FT) on PET, Ultrasound, and X-ray datasets, respectively. The left plot shows the raw numerical comparison and the right plot shows the normalized comparison, where the maximum Dice or NSD on each modality is scaled as 1 and the minimum Dice or NSD on each modality is scaled as 0.

### Qualitative results on validation set

Here we show some examples with good segmentation results and two examples with bad segmentation results. The good cases can almost perfectly segment the region of interest with high DSC ad NSD. Fig. 4 shows the examples with good segmentation results.

Fig. 5 shows the examples with bad segmentation results. For the bad performance cases,some of the segmentation masks cannot fully cover the correct area and some segmentation masks covers more than the region of interest.

### Segmentation efficiency results on validation set

Here we compare the segmentation efficiency based on the time cost on the Codabench platform. On the validation set, the proposed method cost 03:08 min to segment all images and the baseline model costs 03:35 min on validation set. For single cases, please refer to Table.4.

### Results on final testing set

This is a placeholder. We will announce the testing results during CVPR (6.17-18)

### Limitation and future work

In this work, we want to show that class prompt helps with the segmentation of medical images from the perspective of doctors. Unlike natural images, medical images are obtained based on physics. A universal model that understands how

  Case ID & Size & Num. Objects & Baseline Ablation Study & Proposed \\ 
3DBox\_CT\_0566 & (287, 512, 512) & 6 & 373.6 & 373.5 & 381.2 \\
3DBox\_CT\_0888 & (237, 512, 512) & 6 & 92.4 & 92.3 & 95.1 \\
3DBox\_CT\_0860 & (246, 512, 512) & 1 & 10.3 & 10.1 & 12.7 \\
3DBox\_MR\_0621 & (115, 400, 400) & 6 & 143.6 & 143.2 & 150.5 \\
3DBox\_MR\_0121 & (64, 290, 320) & 6 & 91.3 & 91.5 & 95.3 \\
3DBox\_MR\_0179 & (84, 512, 512) & 1 & 10.5 & 10.7 & 12.2 \\
3DBox\_PET\_0001 & (264, 200, 200) & 1 & 5.8 & 5.9 & 7.4 \\
2DBox\_US\_0525 & (256, 256, 3) & 1 & 0.6 & 0.6 & 0.7 \\
2DBox\_X-Ray\_0053 & (320, 640, 3) & 34 & 1.9 & 2.0 & 2.1 \\
2DBox\_Dermoscopy\_0003 & (3024, 4032, 3) & 1 & 0.8 & 0.9 & 1.1 \\
2DBox\_Endoscopy\_0086 & (480, 560, 3) & 1 & 0.6 & 0.6 & 0.7 \\
2DBox\_Fundus\_0003 & (2048, 2048, 3) & 1 & 0.8 & 0.8 & 0.8 \\
2DBox\_Microscope\_0008 & (1536, 2040, 3) & 19 & 1.7 & 1.6 & 1.8 \\
2DBox\_Microscope\_0016 & (1920, 2560, 3) & 241 & 12.9 & 13.5 & 14.1 \\  

Table 4: Quantitative evaluation of segmentation efficiency in terms of running time (s).

Figure 4: Examples with good segmentation results

Figure 5: Examples with bad segmentation results

all modalities work is difficult to achieve. Prompts such as image modality are crucial as patients need to be divided to different departments in a hospital. The class prompt is now built with a 3 layer MLP module. We will design more complicated and reasonable prompt that better suits medical images. Currently the proposed class-prompt TinyVIT is a structure based on TinyVIT. The transformer architecture is still a heavy burden for segmenting medical images on laptop. A smaller model with the same or better precision is highly demanded.

## 5 Conclusion

Segmenting medical images using laptop is indispensable for alleviating the workload of doctors and improving diagnosing accuracy especially in low-income countries. The main findings and results show that differences across image modalities are huge and a unified model cannot handle modalities such as PET with high dice similarity on segmentation task. Class prompt, as a simple network, can efficiently boost model performance on PET and thus leading to better accuracy overall.

#### 5.0.1 Acknowledgements

We thank all the data owners for making the medical images publicly available and CodaLab  for hosting the challenge platform.