# RePoseDM: Recurrent Pose Alignment and Gradient Guidance for Pose Guided Image Synthesis

Anant Khandelwal

Glance AI

anant.iitd.2085@gmail.com

###### Abstract

Pose-guided person image synthesis task requires re-rendering a reference image, which should have a photo-realistic appearance and flawless pose transfer. Since person images are highly structured, existing approaches require dense connections for complex deformations and occlusions because these are generally handled through multi-level warping and masking in latent space. The feature maps generated by convolutional neural networks do not have equivariance, and hence multi-level warping is required to perform pose alignment. Inspired by the ability of the diffusion model to generate photorealistic images from the given conditional guidance, we propose recurrent pose alignment to provide pose-aligned texture features as conditional guidance. Due to the leakage of the source pose in conditional guidance, we propose gradient guidance from pose interaction fields, which output the distance from the valid pose manifold given a predicted pose as input. This helps in learning plausible pose transfer trajectories that result in photorealism and undistorted texture details. Extensive results on two large-scale benchmarks and a user study demonstrate the ability of our proposed approach to generate photorealistic pose transfer under challenging scenarios. Additionally, we demonstrate the efficiency of gradient guidance in pose-guided image generation on the HumanArt dataset with fine-tuned stable diffusion.

## 1 Introduction

Skeleton-guided image synthesis presents a formidable challenge within the domain of computer vision, offering a diverse array of applications spanning e-commerce, virtual reality, the metaverse, and the entertainment industries, aimed at content generation. Furthermore, these algorithms hold promise in enhancing performance via data augmentation for downstream tasks such as person re-identification . The main challenge here is to generate photorealistic images that adhere to the specified target pose and appearance derived from the source image. In the literature, a variety of techniques have been introduced, such as generative adversarial networks (GANs), diffusion models (DM), and variational autoencoders (VAE). Generally, all of them used CNNs (convolutional neural networks), which suffer from the problem of spatial transformation  and generation of equivariant feature maps . To address the issue of spatial feature transformation, stacked CNNs have been introduced to expand the receptive field from local to global. However, transitioning from local to global can lead to the loss of fine-grained details in the source appearance. Flow-based networks  handle efficient spatial transformations, but they exhibit diminished performance in scenarios involving complex deformations and severe occlusions . Since human images are highly structured, addressing complex deformations and occlusions necessitates multi-level warping and masking in latent space. However, this stacked warping approach was still unable to fully resolve the issue, as it tended to diminish the fine-grained details of the source appearance . GAN or VAE methods, whether flow-based or stacked CNNs, encounter challenges related to appearance deformations such as blurry details or low-quality outputs. Conversely, diffusion-based models rely on the iterative reduction of noise, modeled through CNN and attention mechanisms. Attention mechanisms, as described by Vaswani et al. , possess the capability of capturing dependencies by directly computing the interactions between any two positions. Therefore, diffusion models should theoretically be able to achieve perfect alignment of the source image and target pose through cross-attention. Unfortunately, in practice, due to the lack of equivariance between feature maps obtained from CNNs, the interaction positions cannot be decoded well by the attention mechanism. Hence, to address this issue, we proposed _Recurrent Pose Alignment_ to repeatedly align the source image with a given target pose (shown in Supp. Figure 8). Injecting these pose-aligned features into the cross-attention in U-Net reduce the pose alignment error. It is based on multi-level warping, but it fails in cases of severe occlusions. Therefore, we propose _gradient-guided_ training/sampling from diffusion models to further reduce the pose error in a localized manner. Our major contributions are as follows:

* We proposed a method called _Recurrent Pose Alignment_ as a conditional block within the error prediction module in the diffusion model, aiming to reduce the leakage of the source pose into the denoising pipeline. Additionally, we establish the practical groundwork for multi-level warping, necessary for addressing equivariance in CNN feature maps.
* We proposed a novel _Gradient Guidance_ technique to enforce the poses generated through interactions with source appearances to adhere to valid pose manifolds.
* We demonstrated improvements in both pose correction and the accurate generation of source appearance in pose-guided person image synthesis on the DeepFashion, HumanArt, and Market-1501 datasets.

## 2 Related Work

With the significant success of diffusion-based models for conditional image synthesis , an attempt known as PIDM  has been proposed for photorealistic image synthesis given the target pose and source image. PIDM  proposed to denoise the noise concatenated with the target pose image, conditioned on the source image. This process aims to inject the source appearance features into the cross-attention of U-Net. However, the feature map produced by CNNs lacks equivariance, causing the attention mechanism to struggle in accurately mapping source features to the target pose. Additionally, some GAN-based methods  simply concatenate the source pose, target image, and target pose as input to obtain the target image, leading to feature misalignment. To address this issue, the method proposed in  suggests disentangling the guidance from pose and source appearance using skip-connections in U-Net. Another method proposed in  introduces deformable skip connections for efficient spatial transformation. This approach breaks down the overall transformation into a series of local affine transformations, thereby addressing the issue of equivariance in CNN feature maps. Flow-based methods  are based on the idea of warping the source appearance with the target pose. GFLA  proposes global flow fields and an occlusion mask for mapping the source image to the target pose. ADGAN  utilizes a texture encoder to extract appearance features for different body parts and feeds them into residual AdaIN blocks to synthesize the target image. PISE , SPGnet , and CASD  all employ parsing maps with variations in encoder and decoder to generate the final image. CoCoNet  uses an attention mechanism to extract appearance features between cross-domain images. NTED , a method based on distribution operation, proposes obtaining semantically similar texture features by aligning the semantic textures of the source image with the semantic filters for the target pose. All the aforementioned approaches propose a method to map the source to the target pose in some way but do not involve pose correction. We proposed _gradient guidance_ to iteratively correct the pose.

## 3 Proposed Method

**Overall Framework**: Fig.1 displays the overall architecture of our proposed generative model, _RePoseDM_. Given a source image \(I_{S}\) and a target pose \(P\), our goal is to generate a target image that strictly follows the target pose and has the same appearance as the source. This is achieved using the conditional guidance into U-Net from pose-aligned texture features (_Recurrent Pose Alignment_) and gradient guidance (from _Pose Interaction Fields_) to learn the plausible trajectories for the target pose generation. We will discuss next (Section 3.1) the training of conditional diffusion models with gradient guidance, followed by _Recurrent Pose Alignment_ in Section 3.2 and _Pose Interaction Fields_ in Sec.3.3.

### Appearance Conditioned Diffusion Model

_RePoseDM_ is based on the generative scheme of iterative noise reduction as proposed in Denoising diffusion probabilistic model (DDPM) . The general idea behind DDPM is the combination of two processes: _forward_ diffusion and _backward_ denoising. During the forward (diffusion) process, it gradually adds noise to the data sampled from the target distribution \(_{0}(_{0})\), and the backward (denoising) process aims to eliminate this noise. The forward process is described by the Markov chain with the following distribution:

\[q(_{T}|_{0})=_{t=1}^{T}q(_{t}|_{t- 1}),\\ q(_{t}|_{t-1})=(_{t};}_{t-1},_{t}). \]

Here, the noise schedule \(_{t}\) is an increasing sequence of \(t[0,T]\) with \(_{t}(0,1)\). Using the notations \(_{t}=_{t=1}^{T}_{t},_{t}=1-_{t}\). we can sample from \(q(_{t}|_{0})\) in a closed form at an arbitrary time step \(t\): \(_{t}=_{t}}_{0}+_{t}}\), where \((0,)\). For the denoising process, we predict the noise \(_{}(_{t},t,,_{S})\) using the neural network (U-Net) using which we can predict the next-step sample \(_{t-1}\) from the noisy sample \(y_{t}\) at previous time-step given as:

\[_{t-1}=}}(_{t}-}{ _{t}}}_{}(_{t},t,,_{S}) )+_{t} \]

where \((0,),_{t}^{2}\) is variance which is \(\) in DDPM. With this iterative process we sample the clean image \(_{0}\) from the noise \(_{T}(0,)\).

**Noise Prediction**\(_{}(_{t},t,,_{S})\): Given the target pose \(\)and noisy sample \(_{t}\), we concatenate the representation of these two (obtained from VAE encoder) before passing it to the noise predictor network **U-Net**. The target pose \(\) will guide each intermediate denoising step to synthesize the final person image for the given pose and bind the garment texture on that pose using the warped texture features obtained from the _Recurrent Pose Alignment Block_ (explained in Section 3.2). This block, recurrently at each step, warps the source image with the target pose \(P\) to produce the texture features which can be superimposed onto the target pose in the denoising process. This ensures no source pose leakage and hence avoids any additional noise that can cause pose misalignment. However, as shown in Fig.1, for the challenging transfer of poses i.e. left side pose (source) to the front pose (target), there are deformations in predicted \(_{t}\) which is termed as _pose alignment noise_. Due to this additional pose alignment noise, we train the denoising process using gradient guidance from _Pose Interaction Fields_ (explained in Section 3.3) \(G(_{t})\), where \(_{t}\) is the pose obtained from the denoised image which is obtained after subtracting ground truth noise \(\) from noise predicted by U-Net i.e. \(_{}\). Let \(_{}\) be the updated predicted noise including the pose alignment noise, incorporating this in the denoising training loss as:

\[L_{mse}=_{t[0,T],_{0}(_{0}),}|| -_{}(_{t},t,P,I_{S})||^{2} \]

where \(_{t}(_{t}|_{0})\) is the noisy sample from the forward process. For an effective learning strategy in fewer steps, an additional loss term \(L_{vib}\) is proposed in , to learn the noise variance \(_{}\) of the posterior distribution \((y_{t-1}|y_{t})=_{}(y_{t-1}|y_{t})=(_{t}; _{}(_{t},t,P,I_{S}),_{}(_{t},t,P,I_{S}))\). Instead of directly deriving \(_{},_{}\) from the neural network, we predict only the noise \(_{}\) from which the mean and variance are calculated . The updated loss is given as:

\[L_{total}=L_{mse}+L_{vib} \]

### Recurrent Pose Alignment

**MapFormer**: Given the source image \(I_{S}\) and the target pose image \(P\), these are mapped to their respective latent representations using VAE encoder. These latent representations are then fed to two key components: Attention and Pose Mapping Aggregator. Attention in _MapFormer_ consists of both Self-Attention and Cross-Attention blocks for \(I_{S}\) and \(P\) respectively. Both blocks perform region-specific attention to introduce the effect of multi-level warping from global \(\) non-local region \(\) local region. This is inspired by , where multi-level warping of the source image is performed to cope with warping deformations due to non-equivariant feature maps for both images. Specifically, for the coordinate point \(\), the region \(()\), query \(Q\), key \(K\), and value \(V\), the self-attention (self(.)) and cross-attention (cross(.)) are given as follows:

\[()=softmax((( ))^{T}K_{i}(())}{})V_{i}(()) \] \[()=softmax((( ))^{T}K_{j}(())}{})V_{j}(())\]

where \(i\) and \(j\) refer to the indices of images, denoting the query from one and the key, value from another. \(D\) is the

Figure 1: **RePoseDM**: Architecture of our proposed U-Net based Diffusion Model with _Recurrent Pose Alignment_ and _Gradient Guidance_ from _Pose Interaction Fields_. Warped source appearance features are fed to U-Net using cross-attention.

[MISSING_PAGE_FAIL:4]

where \(_{0,t}\) is the estimated cleaned image using Tweedie's formula, perturbed diffusion model given as:

\[_{t}=_{t}-_{t}/(1-})}  y_{0,t}, \]

where \( y_{0,t}=-_{_{t}}G_{}(_{t})\) for some scale factor \(\), leading to

\[_{t}=_{t}+_{t}}_{_ {t}}G_{}(_{t}) \]

suggesting the pose guided diffusion model. The previous work  sets the scale factor to \(=_{t}}\).

### Sampling and Gradient Guidance

At test time, the samples are generated from the model with the input random noise \(_{T}=(0,)\) concatenated with the target pose \(P\) and the interaction conditioning \(F_{S}^{N}\), which contains features of the source garment when interacted with the target pose \(P\). The distribution \(p(y_{t-1}|y_{t},P,I_{S})\) governs the sampling process from \(t=T\) to \(t=0\) in iterative manner. Following, the previous works  we also leveraged the classifier-free guidance. This implies that we have conditional and unconditional sample from the model and combine them as follows

\[_{cond}=_{uncond}+w_{c}*(_{interaction}+ \\ _{t}}_{gradient}) \]

where the strength of interaction conditioning is controlled by scalar \(w_{c}\), the unconditioned prediction is given as \(_{uncond}=_{}(_{t},t,,)\) where the condition of target pose \(P\), and source image \(I_{S}\) has been set to null, which implies there is no interaction conditioning \(F_{S}^{N}\), on the other hand the conditioned prediction is \(_{}(_{t},t,P,I_{S})\), where the interaction features \(F_{S}^{N}\) are given as input to cross-attention of U-Net. Additionally, we leveraged gradient guidance for the pre-trained pose estimation model, to account for pose alignment error during denoising process, this is given as \(_{gradient}=_{_{t}}G_{}(_{t})\), which is combined as in eqn 15. During training, the diffusion model learns both conditioned and unconditioned distributions by randomly setting \(P,I_{S}=\) for \(p\%\) of examples, which learns the distribution \(p(_{0})\) faithfully and leverage it during inference.

## 4 Experiments

**Datasets**: Experiments were carried out on the In-Shop Clothes Retrieval Benchmark of DeepFashion  and the Market-1501  datasets. The DeepFashion dataset contains \(52,712\) high-resolution images of men and women fashion models, while the Market-1501 dataset contains \(32,668\) low-resolution images. Pose skeletons were extracted using OpenPose . For DeepFashion, following the dataset splits in , there are a total of \(101,966\) pairs in the training set and \(8,570\) pairs in the testing set. For both datasets, the training and test sets do not contain overlapping person identities. The images from both datasets vary in factors such as illumination, background, and viewpoint angles. Evaluation metrics are explained in App. 7 and implementation details are given in App. 8.

### Quantitative and Qualitative Comparisons

We compared our model _RePoseDM_ both qualitatively (Fig.2, 3) and quantitatively (Tab.1) with several state-of-the-art methods, namely, PIDM , NTED , CocosNet2 , CASD , DPTN , Def-GAN , PATN , ADGAN , PISE , and GFLA . For qualitative comparison, we experimented with the DeepFashion dataset at multiple resolutions, i.e., \(256 176\) and \(512 352\) images. For Market-1501, we used \(128 64\) images. Tab.1 shows that our model achieved the best results in all three metrics: FID, SSIM, and LPIPS, indicating superior photorealism in the generated images (Fig.2), while preserving finer details like texture and cloth warping for the given target pose. Moreover, the improvement over SSIM and LPIPS demonstrates better structural properties, not only in terms of generating the target pose but also in accurate garment reconstruction for a given target pose. Fig.2 presents a qualitative visual comparison of our method with state-of-the-art frameworks on the DeepFashion dataset. The synthesized images from other methods were obtained using the pre-trained models provided by the corresponding authors. From the results, it can be observed that ADGAN  and PISE  consistently perform poorly in terms of the quality of generated images and cannot retain shape and texture

  
**Dataset** & **Methods** & **FID(\(\))** & **SSIM(\(\))** & **LPIPS(\(\))** \\    & Def-GAN & 18.457 & 0.6786 & 0.2330 \\  & PATN & 20.751 & 0.6709 & 0.2562 \\  & ADGAN & 14.458 & 0.6721 & 0.2283 \\  & PISE & 13.610 & 0.6629 & 0.2059 \\  & GFLA & 10.573 & 0.7074 & 0.2341 \\  & DPTN & 11.387 & 0.7112 & 0.1931 \\  & CASD & 11.373 & 0.7248 & 0.1936 \\  & NTED & 8.6838 & 0.7182 & 0.1752 \\  & PIDM & 6.3671 & 0.7312 & 0.1678 \\  & **RePoseDM (Ours)** & **5.1986** & **0.7923** & **0.1463** \\   & CocosNet2 & 13.325 & 0.7236 & 0.2265 \\  & NTED & 7.7821 & 0.7376 & 0.1980 \\  & PIDM & 5.8365 & 0.7419 & 0.1768 \\  & **RePoseDM (Ours)** & **4.7284** & **0.7944** & **0.1566** \\    & Def-GAN & 25.364 & 0.2683 & 0.2994 \\  & PTN & 22.657 & 0.2821 & 0.3196 \\   & GFLA & 19.751 & 0.2883 & 0.2817 \\   & DPTN & 18.995 & 0.2854 & 0.2711 \\   & PIDM & 14.451 & 0.3054 & 0.2415 \\   & **RePoseDM (Ours)** & **13.689** & **0.3284** & **0.2206** \\   

Table 1: Quantitative Comparision of **RePoseDM** with SOTA methods in terms of FID, SSIM, LPIPSdetails. GFLA  improves on the texture details (4th and 8th row left columns, and 8th row right column) but still struggles to generate reasonable results in unseen regions of images (6th row left column, and 2nd and 4th row right columns). CASD  and NTED  show slight improvements compared to methods before them but still struggle to preserve the source appearance in complex scenarios (9th and 1st rows in left column, and 3rd, 5th, and 10th rows in right column). Although PIDM  generates sharp images, it either has problems with incorrect pose (5th and 7th row right columns, 5th row left column) or missing texture (2nd, 4th, 6th, 9th, and 10th row left columns, and 2nd, 3rd, 6th, 8th, and 10th row right columns). Our method minimizes texture errors and faithfully generates images for invisible regions as well. With pose guidance, our method generates the correct pose in those places where PIDM  missed, as shown in Fig.2 (5th and 7th row right columns, 5th row left column). Additionally, we provide qualitative results on the Market-1501 dataset as shown in Fig.3. The Market-1501 dataset contains challenging backgrounds, and as shown in Fig.3, our method is still able to generate photorealistic images while faithfully retaining the source appearance in the target pose. Additionally, some results on appearance control are shown in Fig.4, where given the reference image needs to be transformed to wearing a garment provided in the garment image. We chose challenging poses of garment images and demonstrated that our method faithfully generates those invisible regions in a reference image.

### Human Perception Study

To validate the effectiveness of our method in terms of human perception, the results are evaluated by 100 participants in two schemes: 1) For comparison with ground truth

Figure 3: Qualitative comparision from several SOTA methods are shown on Market-1501 dataset. Ours indicate RePoseDM

Figure 2: Qualitative comparison of several SOTA methods on the DeepFashion dataset. The inputs shown are target pose and source image, ground truth shows the image in target pose. Images generated from several methods are shown next. Ours indicate RePoseDM

images, we randomly selected 30 images from the test set and 20 images generated by our method. Participants are required to mark the image generated by our method or from ground truth image. Following , we adopted two metrics, namely, _R2G_ and _G2R_. _R2G_ is the percentage of real images classified as generated images, and _G2R_ is the percentage of generated images classified as real images. 2) For comparison with other methods, we randomly selected 30 images from the test set and finally presented 30 such sets containing the source image, target pose, image generated by our method, and baselines. Following , we quantified this in terms of a metric named _JAB_, which represents the percentage of images from our method that are considered best among all other methods. For each of the three metrics, higher values indicate better performance of our method. Results presented in Fig.7 demonstrate that _RePoseDM_ outperforms all other methods. For instance, _RePoseDM_ achieves _G2R_\(=62\%\), which is nearly \(15\%\) better than the second-best model, and the _JAB_ metric is \(82\%\), favoring images generated by our method over others.

### Ablation Study

We conducted detailed ablation studies to demonstrate the merits of contributions made towards pose-guided person image synthesis. Tab.2 shows the quantitative results on the DeepFashion dataset, comparing _RePoseDM_ with several ablation baselines to quantify the contributions made by _Recurrent Pose Alignment_ and _Gradient Guidance_. The baseline B1 is the baseline without _Gradient Guidance_ and _Recurrent Pose Alignment_. Specifically, it consists of a conditioned U-Net-based noise prediction module where noise and the target pose are concatenated as input, and the source image is passed through a simple CNN encoder to provide texture conditioning to the U-Net. Baseline B1 is PIDM only. Baseline B2 incorporates pose alignment conditions into the U-Net model from the _Recurrent Pose Alignment_ block but without any gradient guidance. Finally, RePoseDM is compared with two baselines, B1 and B2, as shown in Tab.2 and Fig.5. Qualitatively, as shown in Fig.5, baseline B1 generates images with incorrect pose and texture, while baseline B2 generates images lacking in pose quality.

### Effectiveness of Gradient Guidance

We further applied and tested the proposed _Gradient Guidance_ in the pre-trained text-based diffusion model, Stable Diffusion v2-1 (SD) . We fine-tuned the SD model on 0.2M text-image-pose pairs obtained from the LAION-Human dataset  and tested it on the validation set of the Human-Art dataset . Specifically, we concatenated the noise and pose representation obtained from the VAE encoder and input these to the text-conditioned U-Net for noise prediction at each step of the denoising process. During training, we modified \(_{t}\) to \(}\) according to Equation 15 containing gradient guidance for predicted pose represen

  
**Methods** & **FID(\(\))** & **SSIM(\(\))** & **LPIPS(\(\))** \\  B1 & 7.5274 & 0.7189 & 0.1912 \\ B2 & 6.9113 & 0.7055 & 0.1634 \\ RePoseDM & **5.1986** & **0.7923** & **0.1463** \\   

Table 2: Ablation Studies showing the impact made _Recurrent Pose Alignment_ and _Gradient Guidance_

Figure 4: Editing Capability of RePoseDM by controlling garment appearance of target image using source image.

Figure 5: Qualitative comparison with ablation baselines B1 & B2

tation obtained from the pre-trained pose estimator HigherHRNet . The pose-guided training loss for stable diffusion is given as:

\[L_{LDM}=E_{t,z,}[||-_{}(}z_{0}+_{t}},c,t)||_{2}^{2}] \]

where \(z_{0}\) is the latent embedding of a sample \(x_{0}\), \(c\) is the text (prompt) embedding, \(_{t}\), \(_{}\) and \(\) is the same as that in vanilla diffusion models. Fig.6 presents the qualitative comparison of pose-guided image generation obtained from _HumanSD_ (shown in the middle after the target pose) and RePoseSD (shown on the right after the image from HumanSD). We name our model RePoseSD, which is obtained after fine-tuning with our proposed gradient guidance on the SD model. Clearly, the images generated by our method show better pose alignment, especially in cases where the target pose comprises multiple poses. For example, consider the case of Jesus: our method is able to generate the correct pose of the hands and legs of the other two persons. Similarly, in other cases like dance, where the hand should be close to the head, and football, where the boys should have opposite poses, our method accurately captures these details. Tab.3 shows the quantitative comparison of our method with HumanSD , which is the current state-of-the-art in text-based pose-guided generation. Our method outperforms in terms of all three metrics: image quality, pose accuracy, and Text Consistency, using the same metrics as used in .

### Person Re-Identification

We evaluate the applicability of images generated from _RePoseDM_ in improving the performance of the downstream task of person re-identification (re-ID) with data augmentation using images generated from our method. We perform this evaluation with data augmentation on the Market-1501 dataset. Specifically, we randomly sample 20%, 40%, 60%, and 80% from the training dataset and augment each set with images generated from our method for the randomly selected source image and randomly selected target pose. To facilitate the comparison of our method with other baselines, we repeat the above procedure for augmented set creation from images generated with other baselines as well. Specifically, we select PIDM , PTN , GFLA , and DPTN . Tab.4 presents the results using the ResNet50 backbone on each of the individual sets with data augmentation from different methods. The performance of the fine-tuned ResNet50 on data augmented with our method outperforms all the other methods.

## 5 Conclusion

In conclusion, we present a novel approach for pose-guided person image synthesis, leveraging recurrent pose alignment and gradient guidance from pose interaction fields. By providing pose-aligned texture features as conditional guidance, our method achieves photorealistic results with flawless pose transfer, even in challenging scenarios. Extensive experiments on large-scale benchmarks and a user study demonstrate the effectiveness of our approach in generating high-quality images. Furthermore, our method showcases efficiency and stability in generating pose-guided images, as demonstrated on the HumanArt dataset with fine-tuned stable diffusion. Overall, our approach advances the state-of-the-art in pose-guided image synthesis, offering applications in various fields such as virtual try-on, digital entertainment, and augmented reality.

Figure 6: Qualitative comparison b/w HumanSD and RePoseSD. HumanSD and RePoseSD trained on 0.2M text-image-pose pairs randomly sampled from _LAION-Human_

Figure 7: Human Perception Study on DeepFashion dataset showing R2G, G2R and JAB metrics. RePoseDM outperforms other methods.