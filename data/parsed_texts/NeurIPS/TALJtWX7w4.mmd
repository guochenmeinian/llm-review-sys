# LaSCal: Label-Shift Calibration without target labels

 Teodora Popordanoska1Gorjan Radevski1Tinne Tuytelaars Matthew B. Blaschko

ESAT-PSI, KU Leuven

firstname.lastname@kuleuven.be

Footnote 1: Equal contribution.

###### Abstract

When machine learning systems face dataset shift, model calibration plays a pivotal role in ensuring their reliability. Calibration error (CE) provides insights into the alignment between the predicted confidence scores and the classifier accuracy. While prior works have delved into the implications of dataset shift on calibration, existing CE estimators either (i) assume access to labeled data from the target domain, often unavailable in practice, or (ii) are derived under a covariate shift assumption. In this work we propose a novel, label-free, consistent CE estimator under _label shift_. Label shift is characterized by changes in the marginal label distribution \(p(Y)\), with a constant conditional \(p(X|Y)\) distribution between the source and target. We introduce a novel calibration method, called LaSCal, which uses the estimator in conjunction with a post-hoc calibration strategy, to perform unsupervised calibration on the target distribution. Our thorough empirical analysis demonstrates the effectiveness and reliability of the proposed approach across different modalities, model architectures and label shift intensities.

## 1 Introduction

Reliable uncertainty estimation is crucial for predictive models, particularly in safety-critical applications, where decisions based on predictions have significant consequences (Amodei et al., 2016; Kompa et al., 2021). The _calibration error_ (CE) (Naeini et al., 2015; Guo et al., 2017; Vaicenavicius et al., 2019) measures the discrepancy between predicted probabilities and observed class frequencies, indicating the reliability of the model's predictions. When a _calibrated_ model predicts an 80% chance of flu, we expect 80 out of 100 patients with similar symptoms to have the flu. Estimating CE and addressing miscalibration typically requires i.i.d. labeled held-out data. However, real-world settings often violate these assumptions: (i) the source (train) may differ from the target (test) distribution, known as _dataset shift_(Quinonero Candela et al., 2009), leading to a false sense of confidence in the model and suboptimal decision-making (Park et al., 2020); and (ii) obtaining labeled target data for CE estimation is often unrealistic or prohibitively expensive, e.g., in medical diagnostics during disease outbreaks acquiring labeled patient data is needed, but costly. Thus, traditional post-hoc calibration methods (e.g., temperature scaling (Guo et al., 2017) or isotonic regression (Zadrozny and Elkan, 2002)), which rely on labeled calibration sets in an i.i.d. setting, are not directly applicable.

The two most common types of dataset shift are: (i) _covariate shift_, where the feature distribution changes between the source and target domains, denoted as \(p_{s}(X)\neq p_{t}(X)\), but the conditional label distribution remains the same, i.e., \(p_{s}(Y|X)=p_{t}(Y|X)\); and (ii) _label shift_, where the label distribution differs, that is \(p_{s}(Y)\neq p_{t}(Y)\), while the conditional feature distribution remains the same, i.e., \(p_{s}(X|Y)=p_{t}(X|Y)\)(Moreno-Torres et al., 2012; Quinonero Candela et al., 2009)2.

Previous methods, such as TransCal (Wang et al., 2020), CPCS (Park et al., 2020), and HeadToTail (Chen and Su, 2023), address calibration under dataset shift, but are specifically designed around the covariate shift assumption. Notably, while HeadToTail also assumes a change in the label distribution between the source and target domains (i.e., \(p_{s}(Y)\neq p_{t}(Y)\)) by using long-tailed source data and balanced target data, it only partially addresses the label shift scenario. As a result, how to effectively estimate and maintain calibration under _label shift_ assumption - especially in the absence of target domain labels - remains an open question3.

Footnote 3: We design a CE estimator under the _label shift_ assumption, which involves scenarios where both the source and _target_ label distributions may be imbalanced. In contrast, HeadToTail operates under a covariate shift assumption ((Chen and Su, 2023, Section 3.1)), and is applied only in a specific type of label shift.

To address this gap, we derive _a novel CE estimator of a model facing label shift_, which allows us to reliably estimate CE without requiring labeled target data. Compared to prior work (see Table 1), it is the only label-free, consistent CE estimator under the label shift assumption. We build on ideas from unsupervised domain adaptation, and employ importance weighting to estimate the degree of shift in the target distribution. We utilize current state-of-the-art methods, e.g., ELSA Tian et al. (2023), RLLS Azizzadenesheli et al. (2019), etc., which yield per-class importance weights to account for the label shift. Note that in contrast to our work, these methods focus only on the predictive performance of a model, neglecting the model's calibration altogether.

Furthermore, we propose a novel, accuracy-perserving, post-hoc calibration method, called **LasCal** (Label-Shift Calibration), which utilizes the proposed CE estimator as a loss function. We conduct experiments across a variety of datasets, models, weight estimators, intensities of shift on the target distribution, and imbalance factors of the source distribution to validate its performance. Our results demonstrate that LasCal effectively performs unsupervised calibration on the target domain, yielding better calibrated models, compared to traditional i.i.d. calibration methods, calibration methods designed for covariate shift (Chen and Su, 2023; Park et al., 2020; Wang et al., 2020), and label shift adaptation methods that rely on calibration using a labeled validation (source) set (Alexandari et al., 2020; Wen et al., 2024).

To summarize, we make the following **contributions:**

1 We derive the first label-free, consistent calibration error estimator under label shift (SS3);

2 We propose a post-hoc calibration method, **LaSCal**, which outperforms existing methods in unsupervised calibration tasks in the presence of label shift (SS4.1);

3 We analyze the properties of LaSCal, and demonstrate its robustness across various datasets, modalities, model architectures and domain-shift scenarios (SS4.2).

Our codebase is released at the following repository: https://github.com/tpopordanoska/label-shift-calibration.

## 2 Related Work

**Estimating CE** is a challenging task as it requires estimating an expectation conditioned on a continuous random variable: \(\mathbb{E}\left[Y\mid f\left(X\right)\right]\), where \(X\) is the input, \(Y\) is a one-hot label, and \(f\) is a probabilistic model. The CE is often estimated using binning (Zadrozny and Elkan, 2001; Naeini et al., 2015), i.e., in the _binary_ setting, the unit interval \([0,1]\) is split into intervals (bins) of either equal width (Nguyen and O'Connor, 2015) or equal mass (adaptive binning) (Vaicenavicius et al.,

\begin{table}
\begin{tabular}{l c c c c} \hline \hline \multicolumn{1}{c}{Calibration method} & \multicolumn{1}{c}{Label shift} & \multicolumn{1}{c}{No target labels} & \multicolumn{1}{c}{Accuracy preserving} & \multicolumn{1}{c}{
\begin{tabular}{c} Consistent estimator under label shift assumption \\ \end{tabular} } \\ \hline TempScal (Source) (Guo et al., 2017) & ✗ & ✗ & ✓ & ✗ \\ CPCS (Park et al., 2020) & ✗ & ✓ & ✓ & ✗ \\ TransCal (Wang et al., 2020) & ✗ & ✓ & ✓ & ✗ \\ HeadToTail (Chen and Su, 2023) & ✗ & ✓ & ✓ & ✗ \\
**LaSCal (Ours)** & ✓ & ✓ & ✓ & ✓ \\ \hline \hline \end{tabular}
\end{table}
Table 1: Properties of related calibration methods. LaSCal is accuracy preserving, and relies on a consistent CE estimator designed for unsupervised calibration under label-shift.

2019). Calibration of a _multi-class_ model is often quantified via expected CE (ECE) (Naeini et al., 2015), used to assess the so-called top-label (or confidence) calibration (Guo et al., 2017), which only considers the confidence of the predicted class. Class-wise calibration (Kull et al., 2019) is a stronger notion, requiring calibrated scores for each class: \(f_{k}(X)\) is compared with \(\mathbb{E}\left[Y_{k}\mid f_{k}\left(X\right)\right]\) for each class \(k\). Canonical calibration (Vaiencnavicius et al., 2019; Popordanoska et al., 2022) is the strictest notion, requiring the whole probability vector to be calibrated, i.e., \(f(X)\) should match \(\mathbb{E}\left[Y\mid f\left(X\right)\right]\). In this work, we focus on binary and class-wise CE, estimated using adaptive binning.

Numerous **calibration methods** address neural network miscalibration, falling into two categories: post-hoc and trainable strategies. _Post-hoc methods_ adjust the output scores using held-out calibration set. One of the earliest approaches in binary classification is Platt scaling (Platt, 1999), which has been extended to a multi-class setting via matrix, vector and temperature scaling (Guo et al., 2017). Other approaches include isotonic regression (Zadrozny and Elkan, 2002), ensemble temperature scaling (Zhang et al., 2020), Beta (Kull et al., 2017) and Dirichlet calibration (Kull et al., 2019). _Trainable methods_ incorporate a calibration objective alongside the classification loss (Kumar et al., 2018; Mukhoti et al., 2020; Popordanoska et al., 2022). All of these strategies focus on a supervised setting, and do not account for dataset shift. Recent studies (Ovadia et al., 2019; Karandikar et al., 2021) have shown that models calibrated with traditional i.i.d. calibration methods lose their calibration under dataset shift. Subsequently, several works address calibration under _covariate shift_ assumption: CPCS (Park et al., 2020), TransCal (Wang et al., 2020), and HeadToTail (Chen and Su, 2023), which calibrate on the target domain without labels. In contrast, we focus on the _label shift_ setting. Our work introduces a general calibration error estimator under label shift, usable as a training objective in post-hoc and trainable calibration methods. Importantly, post-hoc calibration is done on the unlabeled target data, enhancing performance and reliability compared to standard source data calibration.

**Label shift**, also known as prior probability shift, (Lipton et al., 2018; Azizzadenesheli et al., 2019; Alexandari et al., 2020) is often intertwined with the broader concept of unsupervised domain adaptation (Kouw and Loog, 2021). Several different methods address label shift: importance re-weighting (Lipton et al., 2018; Azizzadenesheli et al., 2019; Saerens et al., 2002; Tian et al., 2023), kernel mean matching (KMM) (Zhang et al., 2013), and generative adversarial training (Guo et al., 2020). There are two popular importance re-weighting approaches: one based on maximizing the likelihood function and the other based on inverting a confusion matrix. Saerens et al. (2002) propose an Expectation Maximization (EM) procedure to estimate the class priors shift between the source and target distributions. Importantly, EM does not require retraining or hyperparameter tuning. However, it assumes calibrated predictions, which modern neural networks often lack (Guo et al., 2017). To address this, hybrid methods combining calibration techniques and domain adaptation methods have been proposed. Alexandari et al. (2020) propose Bias-Corrected Temperature Scaling (BCTS) alongside EM. Lipton et al. (2018) propose Black-Box Shift Learning (BBSL), which estimates the re-weighting coefficients even if the model is poorly calibrated. As an improvement over BBSL, Azizzadenesheli et al. (2019) propose a technique with statistical guarantees: Regularized Learning under Label Shifts (RLLS). They introduce a regularization hyperparameter, addressing the high estimation error of the importance weights in the low target sample regime. Both BBSL and RLLS estimate importance weights from a confusion matrix of a held-out validation set. Both methods cope with label shift when the classifier is miscalibrated, but require model retraining with the importance weights. Recently, Tian et al. (2023) propose a moment-matching framework (Tian et al., 2023) to address label shift, named Efficient Label Shift Adaptation (ELSA). Wen et al. (2024) propose an algorithm called Class Probability Matching with Calibrated Networks (CPMCN), which improves the computational efficiency and empirically outperforms existing methods. Importantly, the goal of these works is to improve the classifier's predictive performance on the label-shifted domain without addressing its calibration. While some methods (Alexandari et al., 2020; Wen et al., 2024) include a calibration step on the labeled validation (source) data to obtain importance weights, they do not calibrate the models on the target domain. In contrast, we propose an approach for target domain calibration without relying on labeled target data. In the absence of target labels, we leverage importance weight estimators to re-weigh the source data.

## 3 Methods

We consider a classification setting where \(X\in\mathcal{X}=\mathbb{R}^{d}\) is the input, and \(Y\in\mathcal{Y}=\{0,1\}^{k}\) is the one-hot encoded target, with \(d\) as the feature space dimensionality, and \(k\) the number of classes. The data consists of: labeled source data \(\{(x_{i},y_{i})\}_{i=1}^{n}\) and unlabeled target data \(\{x_{i}\}_{i=n+1}^{n+m}\). The notation \(p_{s}(\cdot)\) and \(p_{t}(\cdot)\) denotes distributions on the source and target domain, respectively. The support on the target domain is a subset of \(\mathcal{Y}\), i.e., the target data does not contain new classes. We use capital letters for unbounded random variables, and lower case letters with subscripts for elements of the data sample. Note that we may still treat elements of the data sample as random variables.

Consider a probabilistic classifier \(f\colon\mathcal{X}\rightarrow\Delta^{k}\), where \(\Delta^{k}\) is a (\(k-1\))-dimensional probability simplex over \(k\) classes, and let \(Z=f(X)\) denote the predicted probability distribution for input \(X\). We focus on _class-wise calibration error_(Kull et al., 2019; Kumar et al., 2019; Gruber and Buettner, 2022), given by:

\[\mathrm{CWCE}_{p}\left(f\right)^{p}=\frac{1}{k}\sum_{c=1}^{k}\mathbb{E}\left[ \left\lvert\mathbb{P}\left(Y_{c}=1\mid Z_{c}\right)-Z_{c}\right\rvert^{p} \right],\] (1)

where \(Y_{c}\) denotes the \(c^{\text{th}}\) entry in the one-hot label, and \(Z_{c}\) denotes the \(c^{\text{th}}\) class confidence score. Since the CE is defined w.r.t. the data distribution, the model's calibration decreases under domain shift, also empirically shown by Ovadia et al. (2019); Karandikar et al. (2021). However, those works estimate CE on the target shifted data using labels, often unavailable in practice. Thus, we derive an \(L_{p}\) classwise CE estimator for label-free target distribution exhibiting _label shift_.

Calibration error estimator under label shift.We consider a label shift: \(p_{s}(Y)\neq p_{t}(Y)\) and \(p_{s}(X\mid Y)=p_{t}(X\mid Y)\). We assume the target distribution is absolutely continuous w.r.t. the source; i.e., for every \(Y\in\mathcal{Y}\) with \(p_{t}(Y)>0\), we require \(p_{s}(Y)>0\)(Lipton et al., 2018)4. Assuming access to \(n\) labeled source samples, and \(m\) unlabeled target samples, we aim to find an estimator:

Footnote 4: The support of the target label distribution should be contained within the source label distribution support.

\[\widehat{\mathrm{CWCE}}_{p}(f)^{p}=\frac{1}{k}\frac{1}{m}\sum_{c=1}^{k}\sum_{ j=n+1}^{m+n}\left\lvert\mathbb{E}_{p_{t}\left[\widehat{Y_{c}}\mid z_{jc} \right]}-z_{jc}\right\rvert^{p},\] (2)

where the expectations are taken w.r.t. the target, and \(z_{jc}\) denotes the \(c^{\text{th}}\) entry of the vector \(z_{j}\).

The main challenge is estimating the conditional expectation \(\mathbb{E}_{p_{t}\left[\widehat{Y_{c}}\mid z_{jc}\right]}\) without labels from the target distribution. To re-weigh the source label distribution, we use importance weights \(\omega=(\omega_{1},\ldots,\omega_{k})^{T}\), where \(\omega_{i}:=p_{t}(Y_{c}=1)/p_{s}(Y_{c}=1)\), which we estimate using unsupervised domain adaption methods (Tian et al., 2023; Alexandari et al., 2020; Azizzadenesheli et al., 2019; Lipton et al., 2018). Then, for the conditional expectation, we have:

\[\mathbb{E}_{p_{t}}[Y_{c}\mid Z_{c}=z_{c}] =\sum_{y_{c}\in\{0,1\}}y_{c}\frac{p_{t}(Y_{c}=y_{c},Z_{c}=z_{c})} {p_{t}(Z_{c}=z_{c})}=\frac{p_{t}(Z_{c}=z_{c}\mid Y_{c}=1)p_{t}(Y_{c}=1)}{p_{t }(Z_{c}=z_{c})}\] (3) \[=\frac{p_{s}(Z_{c}=z_{c}|Y_{c}=1)p_{s}(Y_{c}=1)\omega_{c}}{p_{t}( Z_{c}=z_{c})}\approx\frac{\frac{1}{n}\hat{\omega}_{c}\sum_{i=1}^{n}\kappa(Z_{c}=z_ {c},z_{ic})y_{ic}}{\frac{1}{m}\sum_{i=n+1}^{m+n}\kappa(Z_{c}=z_{c},z_{ic})}\] (4)

where \(\omega_{c}=\frac{p_{t}(Y_{c}=1)}{p_{s}(Y_{c}=1)}\), \(\hat{\omega}_{c}\) is its empirical estimate, and \(\kappa\) is any consistent kernel over its domain (Silverman, 1986). Under the label shift assumption, we estimate \(p_{t}(Z|Y)\) using \(p_{s}(Z|Y)\) because \(p(X|Y)\) remains constant, with \(Z=f(X)\) and \(f\) being a fixed model. The weights \(\hat{\omega}\) are estimated for each \(Y\in\mathcal{Y}\) using labeled source and unlabeled target data, along with the model \(f\). The error rate of the conditional expectation estimator in Equation (4) is determined by the maximum error rate of its components: the weight \(\hat{\omega}_{c}\) and the ratio estimator. Empirically, we use the RLLS estimator, with an error rate: \(\mathcal{O}(n^{-1/2}+m^{-1/2})\)(Azizzadenesheli et al., 2019, Lemma 1) (same as the ratio estimator (Scott and Wu, 1981, Theorem 1)).

**Proposition 3.1**: _Given a kernel \(\kappa\) consistent over its domain (Silverman, 1986), \(\mathbb{E}_{p_{t}\left[\widehat{Y_{c}}\mid Z_{c}\right]}\) is a pointwise consistent estimator of \(\mathbb{E}_{p_{t}\left[Y_{c}\mid Z_{c}\right]}\), that is:_

\[\underset{n,m\rightarrow\infty}{\text{plim}}\ \frac{\frac{1}{n}\hat{\omega}_{c} \sum_{i=1}^{n}\kappa(Z_{c},z_{ic})y_{ic}}{\frac{1}{m}\sum_{i=n+1}^{m+n}\kappa(Z_{ c},z_{ic})}=\frac{p_{t}(Z_{c}=z_{c}\mid Y_{c}=1)p_{t}(Y_{c}=1)}{p_{t}(Z_{c}=z_{c})}\] (5)Proof sketch.: The proof structure follows (Popordanoska et al., 2022, Proposition 3.2), which demonstrates the pointwise consistency of the ratio estimator. Since the weight estimator is also consistent (Azizzadenesheli et al., 2019, Lemma 1), by the same argument for the product of two convergent sequences of random variables (Proposition 3.2), the conditional expectation estimator is also pointwise consistent.

Plugging Equation (4) back into Equation (2), for CE under label shift we get:

\[\widehat{\mathrm{CWCE}}_{p}(f)^{p}=\frac{1}{k}\frac{1}{m}\sum_{c=1}^{k}\sum_{j =n+1}^{m+n}\left|\frac{\frac{1}{n}\hat{\omega}_{c}\sum_{i=1}^{n}\kappa(z_{jc}, z_{ic})y_{ic}}{\frac{1}{m-1}\sum_{i\neq j}^{m+n}\kappa(z_{jc},z_{ic})}-z_{jc} \right|^{p}.\] (6)

The estimator has values \(\in[0,2]\). Since the ratio is pointwise consistent by Proposition 3.1, and following Popordanoska et al. (2022, Proposition 3.5), the CE estimator is consistent for any consistent kernel. Depending on the kernel, the estimator can be differentiable and integrated into post-hoc and trainable calibration methods 5. We use a binning kernel, returning \(1\) when \(z_{ic}\) and \(z_{jc}\) fall in the same bin, and \(0\) otherwise. The binning estimator yields consistency under well known conditions on the number of bins as a function of the number of observations (Lugosi and Nobel, 1996).

Footnote 5: Popordanoska et al. (2022) and Zhang et al. (2020) proposed Dirichlet and Triweight kernels, respectively.

Unsupervised calibration under label shift.The CE estimator can be integrated in any post-hoc calibration method, e.g., temperature scaling. In the supervised i.i.d. setting, the optimal temperature \(T^{*}\) is obtained by minimizing the cross entropy loss. In the label shift setting, we propose using LaSCal to find \(T^{*}\) by minimizing the classwise calibration error obtained by the estimator in Equation (6). In particular, let \(l_{j}\) denote the logits corresponding to \(z_{j}\), and \(\sigma(\cdot)\) the _softmax_ function. We find the optimal temperature \(T^{*}\) as:

\[T^{*}=\operatorname*{arg\,min}_{T}\,\frac{1}{k}\frac{1}{m}\sum_{c=1}^{k}\sum_{ j=n+1}^{m+n}\left|\mathbb{E}_{p_{t}}[\widehat{Y_{c}\mid\sigma(l_{j}}/T)_{c}]- \sigma(l_{j}/T)_{c}\right|^{p}.\] (7)

## 4 Experiments and Discussion

**Datasets.** To assess the performance of LaSCal for calibrating models facing label shift, we experiment using natural image datasets (Krizhevsky et al., 2009), as well as datasets derived from real-world scenarios (Koh et al., 2021). In particular, we use the CIFAR-10/100 Long Tail (LT) datasets (Cao et al., 2019), which are simulated from CIFAR (Krizhevsky et al., 2009) with an imbalance factor (IF) defined as a ratio of the number of samples in the most and least prevalent class. We additionally use Wilds (Koh et al., 2021) with different modalities: Camelyon17 (Bandi et al., 2018) and iWildCam (Beery et al., 2021) with images, and Amazon (Ni et al., 2019) with text. Camelyon17 consists of histopathological images of patient lymph node sections with potential metastatic breast cancer. The labels denote whether the central region contains a tumor (binary). iWildCam consists of images from animal traps in the wild, while the labels are different animal species. The Amazon dataset contains review text samples paired with 1-out-of-5 star ratings as labels. Please refer to Appendix A.1 for details about the datasets.

**Metrics.** Unless stated otherwise, we report \(L_{2}\) calibration error (CE) \(\times 100\)(Kumar et al., 2019), fix the number of bins to 15, and use adaptive binning strategy (Vaicenavicius et al., 2019)). In multi-class settings, we report the sum of per-class CE. We perform a bootstrap procedure, i.e., repeatedly resampling with replacement and estimating CE on each subset, and we report the mean and standard deviation of the estimates. In the reliability diagrams, we report \(L_{1}\) top-label CE (ECE).

**Models.** For the experiments we conduct on CIFAR-10/100 we use ResNet (He et al., 2016) models initialized from scratch with different depths (20, 32, 56, 110). For experiments on iWildCam we report results with a standard ResNet-50 (He et al., 2016), two ViT-large transformer-based models (Dosovitskiy et al., 2020) (with an image resolution of 224 or 384), and Swin-Large (Liu et al., 2021) (all pre-trained on ImageNet). For experiments on Amazon, we use pre-trained transformer-based models: BERT (Devlin et al., 2018), RoBERTa (Liu et al., 2019), DistillBert (Sanh et al., 2019) and DistillRoBERTa (Sanh et al., 2019). For the experiments on Camelyon17, we use a ResNet-50 pre-trained on ImageNet. Please refer to Appendix A.2 for implementation details.

### Calibration under label shift

We compare the performance of LaSCal as a method for post-hoc calibration of a model trained on a source distribution against several (state-of-the-art) baselines. We compare against: (i) **Uncal**: uncalibrated model trained on source data; (ii) **TempScal** calibrated model using temperature scaling on source data; (iii) **CPCS**(Park et al., 2020), **TransCal**(Wang et al., 2020), and **HeadToTail** Chen and Su (2023): calibrated models using adapted versions of TempScal, derived under covariate shift assumption. HeadToTail additionally assumes long-tailed source data, and balanced target data. (iv) **EM-BCTS**(Alexandari et al., 2020) and **CPMCN**(Wen et al., 2024): methods for label shift adaptation, where a calibration step is performed on the source data prior to obtaining the importance weights. Note that TempScal relies only on labeled source data, while the other baselines also incorporate unlabeled target data. Additionally, in Appendix A.3 we include other common, post-hoc, source-domain calibration methods: vector scaling (**VectScal**) (Guo et al., 2017), an ensemble method designed to improve the expressivity of TempScal, abbreviated as **EnsTempScal**(Zhang et al., 2020), and one-versus-all isotonic regression (**IROVA**) (Zadrozny and Elkan, 2002).

We train ResNet models on the CIFAR-10/100 LT variants, and use \(\mathrm{IF}=10\), i.e., the least frequent class is subsampled to 10% of the original size, while the target is balanced. The iWildCam and Amazon datasets have an i.i.d. validation set, serving as our source distribution, and an i.i.d. test set, to which we apply label shift and use it as our target distribution. We use the i.i.d. test set to ensure that the input distribution \(p(X)\) remains the same. On iWildCam, we select the 20 most frequent classes from the target dataset. On both iWildCam and Amazon, we obtain a uniform target distribution by subsampling each class, based on the frequency of the least frequent class.

_Performance of LaSCal across various modalities, datasets and models._ In Table 2, we report CE on the label-shifted (balanced) target domain before and after calibration with various post-hoc methods. We observe that LaSCal either achieves a lower macro-averaged CE across models compared to other methods, or performs on par with the top-performing method, irrespective of the input modality. Compared to the second best method - EM-BCTS - where the calibration is performed on the labeled source data, the proposed LaSCal is explicitly derived for _unsupervised_ calibration on a label-shifted _target_ distribution. Notably, LaSCal significantly outperforms other baselines on CIFAR-100, where around 50% of the classes contain less than 30 source data points (see Figure 5 in Appendix A.1). This highlights LaSCal's effectiveness even in low data regimes6. In Appendix A.3, we report accuracy, additional experiments using other IFs on CIFAR-10/100, and provide results for the scenario where the source is balanced and the target is long-tailed, as commonly studied in related works (Tian et al., 2023; Alexandari et al., 2020; Lipton et al., 2018; Azizzadenesheli et al., 2019).

Footnote 6: We noticed that the optimal temperature obtained by LaSCal for CIFAR-100 is considerably higher than related methods. We hypothesize the discrepancy arises from the optimization process.

_Performance of LaSCal compared to temperature scaling using labels._ In Fig. 1 (Left), we evaluate how closely LaSCal (without labels) approaches the performance of temperature scaling applied on the target distribution using labels, referred to as TempScal (Target), which serves as a competitive baseline. For comparison, we also include temperature scaling applied on the source distribution, referred to as TempScal (Source), representing a lower reference point for the method's performance. Throughout these experiments, we keep the input distribution \(p(X)\) fixed. Across different models on iWildCam and Amazon, we observe that LaSCal performs favorably relative to TempScal (Source) and closes the gap with TempScal (Target), demonstrating its effectiveness in unsupervised calibration.

_Label shift with changing input distribution._ We consider an alternative setting where both the label \(p(Y)\) and input \(p(X)\) distributions change, which is common in real-world applications7. We investigate this scenario by using the out-of-distribution (OOD) test sets of Amazon and iWildCam (\(p(X)\) changes), to which we apply label shift, and use them as our target distribution. The iWildCam OOD test set contains images of camera traps from locations absent from the source distribution, with variation in illumination, camera angle, background, vegetation, etc. (Beery et al., 2021). The Amazon OOD test set contains reviews from users outside of the source distribution. In Fig. 1 (Right), we report the CE after post-hoc calibration using temperature scaling on the source distribution (TempScal), using HeadToTail8, and LaSCal. We observe that both HeadToTail and LaSCal significantly outperform TempScal across all models. Furthermore, despite the more challenging setting, we observe that LaSCal performs on par or outperforms the HeadToTail method.

Top-label calibrationWhile classwise calibration is central to our analysis, top-label calibration remains a popular approach in related works. To gain insights about this notion of calibration, we present reliability diagrams in Fig. 2 for DistillRoBERTa trained on Amazon, allowing us to visually assess the calibration quality across confidence levels. We report CE of (a) an uncalibrated model, (b) after applying temperature scaling on the source domain, (c) after label-shift adaption using EM-BCTS, and (d) after applying temperature scaling using LaSCal. The blue bars indicate

\begin{table}
\begin{tabular}{l c c c c c c c} \hline \hline Model & TempScal & CPCS & TransCal & HeadToTail & EM-BCTS & CPMCN & LaSCal \\ \hline
**CIFAR-10-LT (FF=10)** & & & & & & & \\ \hline ResNet-20 & \(8.87\pm_{0.38}\) & \(4.55\pm_{0.18}\) & \(4.61\pm_{0.17}\) & \(5.05\pm_{0.20}\) & \(4.71\pm_{0.14}\) & \(\bm{37.7\pm_{0.12}}\) & \(3.79\pm_{0.11}\) & \(\bm{44.4\pm_{0.17}}\) \\ ResNet-32 & \(10.45\pm_{0.41}\) & \(5.03\pm_{0.24}\) & \(5.18\pm_{0.21}\) & \(6.59\pm_{0.32}\) & \(4.87\pm_{0.15}\) & \(4.99\pm_{0.24}\) & \(5.19\pm_{0.21}\) & \(\bm{481.07}\) \\ ResNet-56 & \(11.25\pm_{0.31}\) & \(4.82\pm_{0.18}\) & \(5.10\pm_{0.18}\) & \(6.96\pm_{0.20}\) & \(4.75\pm_{0.14}\) & \(\bm{44.41}_{0.11}\) & \(4.42\pm_{0.12}\) & \(4.57\pm_{0.15}\) \\ ResNet-110 & \(11.89\pm_{0.35}\) & \(5.12\pm_{0.18}\) & \(5.12\pm_{0.17}\) & \(7.51\pm_{0.26}\) & \(4.78\pm_{0.14}\) & \(\bm{44.40}_{0.12}\) & \(4.43\pm_{0.13}\) & \(4.70\pm_{0.16}\) \\ \hline \hline _Macor average_ & \(10.62\) & \(\bm{4.8}\) & \(5.00\) & \(6.53\) & \(4.78\) & \(\bm{4.39}\) & \(4.46\) & \(\bm{4.63}\) \\ \hline \hline \multicolumn{7}{l}{
\begin{tabular}{l} _CIFAR-10-LT (FF=10)_ \\ \end{tabular} } & & & & & & & \\ \hline ResNet-20 & \(65.66\pm_{0.23}\) & \(24.61\pm_{0.24}\) & \(24.12\pm_{0.23}\) & \(48.15\pm_{0.29}\) & \(19.93\pm_{0.21}\) & \(25.01\pm_{0.21}\) & \(25.02\pm_{0.24}\) & \(\bm{5.62\pm_{0.06}}\) \\ ResNet-32 & \(71.16\pm_{0.24}\) & \(28.29\pm_{0.24}\) & \(24.84\pm_{0.25}\) & \(57.53\pm_{0.24}\) & \(28.37\pm_{0.23}\) & \(26.17\pm_{0.21}\) & \(24.76\pm_{0.20}\) & \(\bm{5.80\pm_{0.07}}\) \\ ResNet-56 & \(72.24\pm_{0.21}\) & \(29.71\pm_{0.22}\) & \(25.03\pm_{0.24}\) & \(59.27\pm_{0.28}\) & \(29.72\pm_{0.27}\) & \(26.33\pm_{0.23}\) & \(24.53\pm_{0.22}\) & \(\bm{5.88\pm_{0.07}}\) \\ ResNet-110 & \(72.80\pm_{0.21}\) & \(31.55\pm_{0.25}\) & \(26.51\pm_{0.25}\) & \(60.52\pm_{0.27}\) & \(31.58\pm_{0.27}\) & \(28.22\pm_{0.24}\) & \(26.49\pm_{0.22}\) & \(\bm{1.19\pm_{0.08}}\) \\ \hline \hline \multicolumn{7}{l}{_Macor average_} & \(70.47\) & \(28.54\) & \(25.13\) & \(56.37\) & \(27.40\) & \(26.43\) & \(25.20\) & \(\bm{5.87}\) \\ \hline \hline \multicolumn{7}{l}{_Anagon Reviews_} & \multicolumn{1}{c}{} & & & & & \\ \hline RoBERTa & \(11.44\pm_{0.79}\) & \(4.91\pm_{0.31}\) & \(4.20\pm_{0.39}\) & \(4.36\pm_{0.36}\) & \(4.36\pm_{0.36}\) & \(2.72\pm_{0.35}\) & \(\bm{1.36\pm_{0.17}}\) & \(3.66\pm_{0.29}\) \\ DistillRoBERTa & \(17.82\pm_{0.98}\) & \(5.21\pm_{0.45}\) & \(3.60\pm_{0.31}\) & \(7.75\pm_{0.60}\) & \(2.90\pm_{0.21}\) & \(\bm{2.13}\pm_{0.28}\) & \(2.81\pm_{0.23}\) & \(2.72\pm_{0.23}\) \\ BERT & \(27.33\pm_{0.98}\) & \(7.75\pm_{0.55}\) & \(4.34\pm_{0.39}\) & \(16.98\pm_{0.98}\) & \(\bm{3.62\pm_{0.30}}\) & \(3.95\pm_{0.40}\) & \(9.32\pm_{0.54}\) & \(3.72\pm_{0.34}\) \\ DistillBERT & \(22.18\pm_{1.14}\) & \(6.54\pm_{0.51}\) & \(3.94\pm_{0.32}\) & \(11.89\pm_{0.75}\) & \(3.43\pm_{0.29}\) & \(3.41\pm_{0.36}\) & \(5.48\pm_{0.34}\) & \(\bm{3.44\pm_{0.28}}\) \\ \hline \multicolumn{7}{l}{_Macor average_} & \multicolumn{1}{c}{} & \multicolumn{1}{c}{} & \multicolumn{1}{c}{} & \multicolumn{1}{c}{} & \multicolumn{1}{c}{} & \multicolumn{1}{c}{} & \multicolumn{1}{c}{} \\ \hline \hline _WiHLcam_ & & & & & & & \\ \hline ResNet50 & \(18.44\pm_{0.74}\) & \(16.38\pm_{0.61}\) & \(\bm{11.52\pm_{0.93}}\) & \(13.81\pm_{0.48}\) & \(15.53\pm_{0.56}\) & \(15.84\pm_{0.57}\) & \(19.43\pm_{0.69}\) & \(13.07\pm_{0.45}\) \\ Swin-Large & \(22.07\pm_{0.84}\) & \(17.39\pm_{0.66}\) & \(17.57\pm_{0.60}\) & \(16.42\pm_{0.49}\) & \(16.55\pm_{0.57}\) & \(16.81\pm_{0.63}\) & \(18.03\pm_{0.62}\) & \(\bm{15.43\pm_{0.54}}\) \\ ViT-Large & \(17.94\pm_{0.71}\) & \(16.78\pm_{0.66}\) & \(20.24\pm_{0.80}\) & \(13.64\pm_{0.48}\) & \(16.53\pm_{0.66}\) & \(24.83\pm_{1.31}\) & \(19.33\pm_{0.80}\) & \(\bm{13.07\pm_{0.50}}\) \\ ViT-Large (384) & \(18.99\pm_{0.86}\) & \(18.78\pm_{0.80}\) & \(29.2\pm_{0.96}\) & \(\bm{1481}\pm_{0.52}\) & \(17.92\pm_{0.77}\) & \(19.78\pm_{0.73}\) & \(20.74\pm_{0.7}\) & \(17the accuracy per bin, and the red bars represent the gap of each bin to perfect calibration, i.e., the difference between accuracy and confidence for a given bin (darker shades signify under-confidence, while brighter red colors denote over-confidence). We observe that LaSCal provides better calibration (i.e., lower ECE) compared to other baselines, as also confirmed by the reported \(L_{1}\) top-label CE in the bottom right corner of each plot. Furthermore, note that while the classwise CE values of EM-BCTS are better than LaSCal (Table 2), the diagrams reveal that top-label confidence scores obtained with LaSCal are favorable compared to EM-BCTS in most bins.

Building on this, we adapt our approach to top-label calibration, and we include the adapted estimator, along with empirical comparisons with competing calibration methods in Appendix B. The results on Amazon and iWildCam further validate the effectiveness of LaSCal, which continues to outperform other methods, demonstrating its superior calibration capabilities in the top-label setting.

### Empirical analysis of the estimator's properties

Robustness analysis.Using the Camelyon17 dataset, we conduct a series of experiments to assess the impact of various factors on the performance of the CE estimator, and report the results in Fig. 3. We partition the original training set as the source distribution, and we use the i.i.d. validation set to form a target set with varying label distribution shifts. We chose this dataset because (i) the application is both realistic and safety-critical; (ii) the dataset is balanced across source and target, enabling us to alter both distributions as per the setting we are trying to verify; (iii) the problem is binary, allowing us to study the estimator properties on a simple problem. For all experiments, we use a ResNet-50 model pre-trained on ImageNet, subsequently fine-tuned on the Camelyon17 dataset.

Across the experiments, we construct the train and validation sets, sampled from the source distribution, by keeping all negative samples and sampling a portion of the positives. Unless stated otherwise, we report results by sampling \(20\%\) of the positive samples for training: i.e., \(5:1\) ratio of negative to positive points. We compare the estimated CE values (without labels) to the ground truth (with labels), across different experimental scenarios, designed to assess the impact of a change in the data distribution and the sample size on the CE estimation. To account for the variability in data resampling, we average the results across 10 iterations. For each iteration, we apply bootstrap sampling and compute the mean and variance of the estimated CE. Finally, we report the overall mean and standard deviation (depicted as shaded region in the plot) across all iterations.

Impact of data distribution changes.In Fig. 2(a), we investigate the effect of increasing the label shift intensity of the target distribution. We impose a constraint such that the size of the source and target distribution is the same (\(n=m\)), and we systematically shift the target by modifying the ratio of negative to positive samples: \(5:1,4:1,...,1:1,...,1:4\). Therefore, in the most favorable scenario (\(5:1\)), the source and target distribution are the same (no label shift), while in the extreme \(1:4\), we have \(4\) times as many positive samples in the target data (which could occur, e.g., during a disease outbreak). We observe that the estimated CE closely follows the ground truth, even in the most extreme case. Furthermore, we observe that the variance increases with the intensity of the shift, indicating greater uncertainty and reducing the confidence one should have in the CE estimates. In Fig. 2(b) we analyze the effect of changing the ratio of source to target samples (\(n:m\)), while keeping the total number of points (\(n+m\)) constant. The source distribution has a \(5:1\) ratio of negative to positive points, while the target is balanced. We observe that the estimator achieves

Figure 2: Reliability diagrams on Amazon using DistillRoBERTa before and after calibration. TempScal (Source) and EM-BCTS perform IID calibration on the source distribution. LaSCal calibrates the model on the unlabeled target distribution. We report \(L_{1}\) top-label CE in the bottom right corner.

optimal performance when the source and target data sizes are equal (\(n:m\)). As the ratio increases, the estimated values begin to diverge slightly from the ground truth. However, the true values lie within the estimator's standard deviation in most cases, demonstrating that even in more extreme settings - \(5\times\) more source than target samples - our estimator yields reliable CE estimates.

_Impact of data size._ In Fig. 2(c), we constrain that \(n=m\), and we incrementally vary the sample size from \(1,000\) to \(10,000\) samples. In practice, low data regimes are common where annotated data is costly to obtain. We observe that the CE estimates deviate from the ground truth the most when using the fewest data points (i.e., \(1000\)), and improve as the data quantity increases. Furthermore, our estimator has a positive bias w.r.t. ground truth in the small data regime, indicating that the estimator tends to be conservative in that setting. Such tendency is preferable in this context, as it prevents mistakenly reporting good performance of a model on the basis of not enough samples. In essence, our method errs on the side of caution, ensuring reliability even in data-constrained environments.

Method analysis.We further investigate (i) how different weight estimation methods influence the estimator's effectiveness, and (ii) to what extent our CE estimates (without labels) deviate from the values obtained using labeled target data.

_Impact of the weight estimation method._ Our estimator relies on the availability of per-class importance weights, which can be obtained using domain adaptation methods, such as ELSA (Tian et al., 2023), RLLS (Azizzadenesheli et al., 2019) and BBSL (Lipton et al., 2018). In Fig. 4 (Left), we compare the performance of these methods when integrated in our estimator. We observe that RLLS emerges as the most favorable compared to the others, providing reasonable importance weights in all settings. See Appendix A.4 for experiments involving other weight estimators.

_Performance evaluation._ In Fig. 4 (Right), we investigate the CE measured by our estimator, compared to the ground-truth CE (obtained using labels from the target domain). Additionally, we report the CE on the source domain as a reference point. We observe that the calibration error increases from the source to target domain when the model is facing label shift. Importantly, our estimator (\(\widehat{\mathrm{CE}_{t}}\)) effectively closes the gap to the ground-truth (\(\mathrm{CE}_{t}\)), consistently yielding accurate CE estimates across models on Amazon and iWildCam.

## 5 Discussion and Conclusion

In this work, we addressed the problem of estimating CE of an _unlabeled_ target distribution under _label shift_. We observe that prior state-of-the-art methods Wang et al. (2020); Chen and Su (2023) only address CE estimation under the covariate shift assumption: \(p_{s}(X)\neq p_{t}(X)\) and \(p_{s}(Y|X)=p_{t}(Y|X)\); while, to the best of our knowledge, we propose the first CE estimator under the label shift assumption: \(p_{s}(Y)\neq p_{t}(Y)\) and \(p_{s}(X|Y)=p_{t}(X|Y)\). We demonstrated that it yields CE estimates closely reflecting the ground truth. Furthermore, we showcase that our estimator can be successfully used as a post-hoc calibration method - LaSCal - for unsupervised model calibration on a target distribution. Overall, our experiments indicate that LaSCal can effectively minimize the CE across

Figure 3: Robustness analysis. We report mean and standard deviation over multiple iterations of resampling the data. \(5:1\) denotes “no shift”, and the severity increases from left to right. LaSCal generalizes well to a wide range of shifts, ratios of source to target samples, and sample sizes.

different intensities of label shift and various modalities. Finally, we analyze the properties of the estimator and contribute towards a nuanced understanding of its strengths and weaknesses.

**Limitations.** First, LaSCal is specifically designed to address label-shift, however, other types of dataset-shift are equally important, e.g., _covariate shift_(Shimodaira, 2000). Note that our experiments in SS4.1 shed light on the scenario where the models encounter both label shift and shift in \(p(X)\), and we observed favorable results compared to prior work. Nevertheless, we consider designing consistent CE estimators under covariate shift a crucial direction for future work. Second, the estimator we propose is dependent on how well the importance weights reflect the ground truth between the classes, which we obtain from current methods (Tian et al., 2023; Azizzadenesheli et al., 2019; Alexandari et al., 2020). Expectedly, we inherit some limitations of such methods: if certain classes are under-represented, the importance weights could be unreliable. However, our experiments in Appendix A.4 showcase that our estimator consistently improves as the weights become more accurate. Third, the estimator requires a sufficient number of data samples, e.g., \(4000\) samples in Figure 3c, to accurately estimate the calibration error. In severely data-scarce settings, this requirement may limit potential applications. However, the error rate of our estimator is \((n^{-1/2}+m^{-1/2})\), which is the same as the weight estimation methods (see Azizzadenesheli et al. (2019, Lemma 1) for the RLLS method, and Garg et al. (2020, page 8, top paragraph) for the EM-BCTS method). Therefore, the data requirement is not unique to our method, but rather it is common across all weight estimation-based approaches.

**Broader impact.** Our proposed approach effectively reduces CE under label shift, and allows for a more comprehensive and realistic evaluation of model calibration. We consider the ethical risks to be essentially the same as for any probabilistic classifier. Overall, we consider this paper a significant step toward improving the model's robustness and reliability, crucial for safety-critical applications.

## Acknowledgments

This research received funding from the Research Foundation - Flanders (FWO) through project number S001421N, the Flemish Government under the "Onderzoeksprogramma Artificiele Intelligentie (AI) Vlaanderen" programme, and KULeuven Methusalem.

Figure 4: **Left. Impact of the weight estimation method on our estimator. Right. Our estimator (\(\overline{\mathrm{CE}}_{t}\)) effectively closes the gap to the ground truth (\(\mathrm{CE}_{t}\)). We report CE normalized by the number of classes (5 for Amazon and 20 for iWildCam) for illustration purposes.**

## References

* Alexandari et al. (2020) Amr Alexandari, Anshul Kundaje, and Avanti Shrikumar. Maximum likelihood with bias-corrected calibration is hard-to-beat at label shift adaptation. In _International Conference on Machine Learning_, pages 222-232. PMLR, 2020.
* Amodei et al. (2016) Dario Amodei, Chris Olah, Jacob Steinhardt, Paul Christiano, John Schulman, and Dan Mane. Concrete problems in ai safety, 2016.
* Azizzadenesheli et al. (2019) Kamyar Azizzadenesheli, Anqi Liu, Fanny Yang, and Animashree Anandkumar. Regularized learning for domain adaptation under label shifts. _arXiv preprint arXiv:1903.09734_, 2019.
* Bandi et al. (2018) Peter Bandi, Oscar Geessink, Quirine Manson, Marcory Van Dijk, Maschenka Balkenhol, Meyke Hermsen, Babak Ehteshami Bejnordi, Byungjae Lee, Kyunghyun Paeng, Aoxiao Zhong, et al. From detection of individual metastases to classification of lymph node status at the patient level: the camelyon17 challenge. _IEEE transactions on medical imaging_, 38(2):550-560, 2018.
* Beery et al. (2021) Sara Beery, Arushi Agarwal, Elijah Cole, and Vighnesh Birodkar. The iwildcam 2021 competition dataset. _arXiv preprint arXiv:2105.03494_, 2021.
* Cao et al. (2019) Kaidi Cao, Colin Wei, Adrien Gaidon, Nikos Arechiga, and Tengyu Ma. Learning imbalanced datasets with label-distribution-aware margin loss. _Advances in neural information processing systems_, 32, 2019.
* Chen and Su (2023) Jiahao Chen and Bing Su. Transfer knowledge from head to tail: Uncertainty calibration under long-tailed distribution. In _Proceedings of the IEEE/CVF Conference on Computer Vision and Pattern Recognition_, pages 19978-19987, 2023.
* Devlin et al. (2018) Jacob Devlin, Ming-Wei Chang, Kenton Lee, and Kristina Toutanova. Bert: Pre-training of deep bidirectional transformers for language understanding. _arXiv preprint arXiv:1810.04805_, 2018.
* Dosovitskiy et al. (2020) Alexey Dosovitskiy, Lucas Beyer, Alexander Kolesnikov, Dirk Weissenborn, Xiaohua Zhai, Thomas Unterthiner, Mostafa Dehghani, Matthias Minderer, Georg Heigold, Sylvain Gelly, et al. An image is worth 16x16 words: Transformers for image recognition at scale. _arXiv preprint arXiv:2010.11929_, 2020.
* Garg et al. (2020) Saurabh Garg, Yifan Wu, Sivaraman Balakrishnan, and Zachary Lipton. A unified view of label shift estimation. _Advances in Neural Information Processing Systems_, 33:3290-3300, 2020.
* Gruber and Buettner (2022) Sebastian Gruber and Florian Buettner. Better uncertainty calibration via proper scores for classification and beyond. _Advances in Neural Information Processing Systems_, 35:8618-8632, 2022.
* Guo et al. (2017) Chuan Guo, Geoff Pleiss, Yu Sun, and Kilian Q Weinberger. On calibration of modern neural networks. In _International Conference on Machine Learning_, pages 1321-1330. PMLR, 2017.
* Guo et al. (2020) Jiaxian Guo, Mingming Gong, Tongliang Liu, Kun Zhang, and Dacheng Tao. LTF: A label transformation framework for correcting label shift. In Hal Daume III and Aarti Singh, editors, _Proceedings of the 37th International Conference on Machine Learning_, volume 119 of _Proceedings of Machine Learning Research_, pages 3843-3853. PMLR, 13-18 Jul 2020. URL https://proceedings.mlr.press/v119/guo20d.html.
* He et al. (2016) Kaiming He, Xiangyu Zhang, Shaoqing Ren, and Jian Sun. Deep residual learning for image recognition. In _Proceedings of the IEEE conference on computer vision and pattern recognition_, pages 770-778, 2016.
* Karandikar et al. (2021) Archit Karandikar, Nicholas Cain, Dustin Tran, Balaji Lakshminarayanan, Jonathon Shlens, Michael Curtis Mozer, and Becca Roelofs. Soft calibration objectives for neural networks. In _Neural Information Processing Systems_, 2021. URL https://api.semanticscholar.org/CorpusID:236772324.
* Koh et al. (2021) Pang Wei Koh, Shiori Sagawa, Henrik Marklund, Sang Michael Xie, Marvin Zhang, Akshay Balsubramani, Weihua Hu, Michihiro Yasunaga, Richard Lanas Phillips, Irena Gao, et al. Wilds: A benchmark of in-the-wild distribution shifts. In _International Conference on Machine Learning_, pages 5637-5664. PMLR, 2021.
* Kundaje et al. (2018)Benjamin Kompa, Jasper Snoek, and Andrew L Beam. Second opinion needed: communicating uncertainty in medical machine learning. _NPJ Digital Medicine_, 4(1):4, 2021.
* Kouw and Loog [2021] Wouter M. Kouw and Marco Loog. A review of domain adaptation without target labels. _IEEE Transactions on Pattern Analysis and Machine Intelligence_, 43(3):766-785, 2021. ISSN 0162-8828. doi: 10.1109/TPAMI.2019.2945942.
* Krizhevsky et al. [2009] Alex Krizhevsky, Geoffrey Hinton, et al. Learning multiple layers of features from tiny images. 2009.
* Kull et al. [2017] Meelis Kull, Telmo Silva Filho, and Peter Flach. Beta calibration: a well-founded and easily implemented improvement on logistic calibration for binary classifiers. In Aarti Singh and Jerry Zhu, editors, _Proceedings of the 20th International Conference on Artificial Intelligence and Statistics_, volume 54 of _Proceedings of Machine Learning Research_, pages 623-631. PMLR, 20-22 Apr 2017.
* Kull et al. [2019] Meelis Kull, Miquel Perello Nieto, Markus Kangsepp, Telmo Silva Filho, Hao Song, and Peter Flach. Beyond temperature scaling: Obtaining well-calibrated multi-class probabilities with Dirichlet calibration. _Advances in neural information processing systems_, 32, 2019.
* Kumar et al. [2019] Ananya Kumar, Percy Liang, and Tengyu Ma. Verified uncertainty calibration. In _Proceedings of the 33rd International Conference on Neural Information Processing Systems_, pages 3792-3803, 2019.
* Kumar et al. [2018] Aviral Kumar, Sunita Sarawagi, and Ujjwal Jain. Trainable calibration measures for neural networks from kernel mean embeddings. In Jennifer Dy and Andreas Krause, editors, _Proceedings of the 35th International Conference on Machine Learning_, volume 80 of _Proceedings of Machine Learning Research_, pages 2805-2814. PMLR, 10-15 Jul 2018.
* Lipton et al. [2018] Zachary Lipton, Yu-Xiang Wang, and Alexander Smola. Detecting and correcting for label shift with black box predictors. In _International conference on machine learning_, pages 3122-3130. PMLR, 2018.
* Liu et al. [2019] Yinhan Liu, Myle Ott, Naman Goyal, Jingfei Du, Mandar Joshi, Danqi Chen, Omer Levy, Mike Lewis, Luke Zettlemoyer, and Veselin Stoyanov. Roberta: A robustly optimized bert pretraining approach. _arXiv preprint arXiv:1907.11692_, 2019.
* Liu et al. [2021] Ze Liu, Yutong Lin, Yue Cao, Han Hu, Yixuan Wei, Zheng Zhang, Stephen Lin, and Baining Guo. Swin transformer: Hierarchical vision transformer using shifted windows. In _Proceedings of the IEEE/CVF international conference on computer vision_, pages 10012-10022, 2021.
* Loshchilov and Hutter [2017] Ilya Loshchilov and Frank Hutter. Decoupled weight decay regularization. _arXiv preprint arXiv:1711.05101_, 2017.
* 706, 1996. doi: 10.1214/aos/1032894460. URL https://doi.org/10.1214/aos/1032894460.
* Moreno-Torres et al. [2012] Jose G. Moreno-Torres, Troy Raeder, Rocio Alaiz-Rodriguez, Nitesh V. Chawla, and Francisco Herrera. A unifying view on dataset shift in classification. _Pattern Recognition_, 45(1):521-530, 2012. ISSN 0031-3203. doi: https://doi.org/10.1016/j.patcog.2011.06.019. URL https://www.sciencedirect.com/science/article/pii/S0031320311002901.
* Mukhoti et al. [2020] Jishnu Mukhoti, Viveka Kulharia, Amartya Sanyal, Stuart Golodetz, Philip Torr, and Puneet Dokania. Calibrating deep neural networks using focal loss. _Advances in Neural Information Processing Systems_, 33:15288-15299, 2020.
* Naeini et al. [2015] Mahdi Pakdaman Naeini, Gregory F. Cooper, and Milos Hauskrecht. Obtaining well calibrated probabilities using Bayesian binning. In _Proceedings of the Twenty-Ninth AAAI Conference on Artificial Intelligence_, pages 2901-2907, 2015.
* Nguyen and O'Connor [2015] Khanh Nguyen and Brendan O'Connor. Posterior calibration and exploratory analysis for natural language processing models. In _Proceedings of the 2015 Conference on Empirical Methods in Natural Language Processing_, pages 1587-1598, 2015.
* Nguyen et al. [2018]Jianmo Ni, Jiacheng Li, and Julian McAuley. Justifying recommendations using distantly-labeled reviews and fine-grained aspects. In _Proceedings of the 2019 conference on empirical methods in natural language processing and the 9th international joint conference on natural language processing (EMNLP-IJCNLP)_, pages 188-197, 2019.
* Ovadia et al. (2019) Yaniv Ovadia, Emily Fertig, Jie Ren, Zachary Nado, David Sculley, Sebastian Nowozin, Joshua Dillon, Balaji Lakshminarayanan, and Jasper Snoek. Can you trust your model's uncertainty? evaluating predictive uncertainty under dataset shift. _Advances in neural information processing systems_, 32, 2019.
* Park et al. (2020) Sangdon Park, Osbert Bastani, James Weimer, and Insup Lee. Calibrated prediction with covariate shift via unsupervised domain adaptation. In _International Conference on Artificial Intelligence and Statistics_, pages 3219-3229. PMLR, 2020.
* Paszke et al. (2019) Adam Paszke, Sam Gross, Francisco Massa, Adam Lerer, James Bradbury, Gregory Chanan, Trevor Killeen, Zeming Lin, Natalia Gimelshein, Luca Antiga, et al. Pytorch: An imperative style, high-performance deep learning library. _Advances in neural information processing systems_, 32, 2019.
* Platt (1999) John C. Platt. Probabilistic outputs for support vector machines and comparisons to regularized likelihood methods. In _Advances in Large-Margin Classifiers_, pages 61-74. MIT Press, 1999.
* Poperdanoska et al. (2022) Teodora Poperdanoska, Raphael Sayer, and Matthew B. Blaschko. A consistent and differentiable lp canonical calibration error estimator. In Alice H. Oh, Alekh Agarwal, Danielle Belgrave, and Kyunghyun Cho, editors, _Advances in Neural Information Processing Systems_, 2022.
* Candela et al. (2009) Joaquin Quinonero Candela, Masashi Sugiyama, Anton Schwaighofer, and Neil D Lawrence, editors. _Dataset shift in machine learning_. MIT Press, 2009.
* Saerens et al. (2002) Marco Saerens, Patrice Latinne, and Christine Decaestecker. Adjusting the outputs of a classifier to new a priori probabilities: A simple procedure. _Neural Computation_, 14:21-41, 2002. URL https://api.semanticscholar.org/CorpusID:18254013.
* Sanh et al. (2019) Victor Sanh, Lysandre Debut, Julien Chaumond, and Thomas Wolf. Distilbert, a distilled version of bert: smaller, faster, cheaper and lighter. _arXiv preprint arXiv:1910.01108_, 2019.
* Scholkopf et al. (2012) Bernhard Scholkopf, Dominik Janzing, Jonas Peters, Eleni Sgouritsa, Kun Zhang, and Joris Mooij. On causal and anticausal learning. In _International Conference on Machine Learning_, 2012.
* Scott and Wu (1981) Alastair Scott and Chien-Fu Wu. On the asymptotic distribution of ratio and regression estimators. _Journal of the American Statistical Association_, 76(373):98-102, 1981. ISSN 01621459.
* Shimodaira (2000) Hidetoshi Shimodaira. Improving predictive inference under covariate shift by weighting the log-likelihood function. _Journal of Statistical Planning and Inference_, 90:227-244, 10 2000. doi: 10.1016/S0378-3758(00)00115-4.
* Silverman (1986) B. W. Silverman. _Density Estimation for Statistics and Data Analysis_. Chapman & Hall, London, 1986.
* Tian et al. (2023) Qinglong Tian, Xin Zhang, and Jiwei Zhao. Elsa: Efficient label shift adaptation through the lens of semiparametric models. In _International Conference on Machine Learning_, pages 34120-34142. PMLR, 2023.
* Vaicenavicius et al. (2019) Juozas Vaicenavicius, David Widmann, Carl Andersson, Fredrik Lindsten, Jacob Roll, and Thomas Schon. Evaluating model calibration in classification. In _The 22nd International Conference on Artificial Intelligence and Statistics_, pages 3459-3467. PMLR, 2019.
* Wang et al. (2020) Ximei Wang, Mingsheng Long, Jianmin Wang, and Michael Jordan. Transferable calibration with lower bias and variance in domain adaptation. _Advances in Neural Information Processing Systems_, 33:19212-19223, 2020.
* Wen et al. (2024) Hongwei Wen, Annika Betken, and Hanyuan Hang. Class probability matching with calibrated networks for label shift adaption. In _The Twelfth International Conference on Learning Representations_, 2024.
* Zhang et al. (2019)* Wightman et al. (2019) Ross Wightman et al. Pytorch image models, 2019.
* Wolf et al. (2019) Thomas Wolf, Lysandre Debut, Victor Sanh, Julien Chaumond, Clement Delangue, Anthony Moi, Pierric Cistac, Tim Rault, Remi Louf, Morgan Funtowicz, et al. Huggingface's transformers: State-of-the-art natural language processing. _arXiv preprint arXiv:1910.03771_, 2019.
* Zadrozny and Elkan (2002) B. Zadrozny and C. Elkan. Transforming classifier scores into accurate multiclass probability estimates. _Proceedings of the eighth ACM SIGKDD international conference on Knowledge discovery and data mining_, 2002.
* Zadrozny and Elkan (2001) Bianca Zadrozny and Charles Elkan. Obtaining calibrated probability estimates from decision trees and naive bayesian classifiers. In _Proceedings of the Eighteenth International Conference on Machine Learning_, ICML '01, page 609-616, San Francisco, CA, USA, 2001. Morgan Kaufmann Publishers Inc. ISBN 1558607781.
* Zhang et al. (2020) Jize Zhang, Bhavya Kailkhura, and T. Yong-Jin Han. Mix-n-match: Ensemble and compositional methods for uncertainty calibration in deep learning. In _International Conference on Machine Learning_, 2020.
* Zhang et al. (2013) Kun Zhang, Bernhard Scholkopf, Krikamol Muandet, and Zhikun Wang. Domain adaptation under target and conditional shift. In _International conference on machine learning_, pages 819-827. PMLR, 2013.

**Supplementary Material**

**LaSCal: Label-Shift Calibration without target labels**

The Supplementary material is organized as follows:

* Details about the datasets we use for the experiments (SSA.1).
* Implementation details (SSA.2)
* Additional experiments with LaSCal (SSA.3).
* The proposed estimator with different importance weight estimators (SSA.4).

## Appendix A Experiments

In this section, we include more details about the used datasets and training procedures. We also report additional experiments to evaluate the performance of our proposed method using different importance weight estimators.

### Details about the datasets

We report statistics for all datasets in Table 3.

**CIFAR-10/100**[Krizhevsky et al., 2009, Cao et al., 2019]. Using the CIFAR datasets we examine two different types of label shift. In **Task A** the source distribution is long-tailed, whereas the target is uniform. In **Task B** the source distribution is uniform, and the target is long-tailed. The CIFAR-10/100 Long-Tail datasets are simulated from CIFAR-10/100, respectively, with different imbalance factors (IF). The IF controls the ratio between the number of samples in the most frequent and the least frequent class. For example, an imbalance factor of 10 indicates that the least frequent class appears 10 times less than the most frequent one. In Figure 5 we show the number of target images per class on the long-tailed CIFAR-10/100 with imbalance factors ranging from 1.25 to 100.

In **Task A** we keep the target distribution unchanged (i.e., balanced across classes), and we resample the source distribution with various IF. In the main paper, we presented a setting with source \(\mathrm{IF}=10\) in Table 2. Additional results using different imbalance factors induced on the source distribution are given in Tables 11 - 16. In **Task B** the models are trained on the original (balanced) CIFAR datasets, and in Table 10 in Appendix A.3 we report the performance of our CE estimator on label-shifted target distribution with various imbalance factors.

**Camelyon17**[Bandi et al., 2018] consists of \(96\times 96\) whole-side images (WSI) of breast-cancer metastases in lymph node sections collected from hospitals in the Netherlands. In each WSI, the tumor regions are annotated manually by pathologists. The labels indicate whether the central \(32\times 32\) region contains a tumor. As Camelyon17 contains only a training and validation set--drawn from the same (source) distribution--both of which are balanced across the positive and negative class, we perform the following: (i) We use the validation set as testing dataset, which we convert to our desired target distribution by resampling the positive class; (ii) From the training dataset, we allocate a validation dataset with the same size as the testing dataset. Then, we subsample the validation dataset the same way as we subsample the training dataset, so that both are effectively drawn from the same (source) distribution (e.g., used in the ablation studies in Section 4.3).

**iWildCam**[Beery et al., 2021] consists of images obtained from animal camera traps (i.e., heat or motion-activated static cameras placed in the wild) which are set in countries in different parts of

\begin{table}
\begin{tabular}{c c c c c c} \hline \hline Dataset & Modality & Num. classes & Train samples & Val samples & Test samples \\ \hline CIFAR-10 & Images & 10 & 40,000 & 10,000 & 10,000 \\ CIFAR-100 & Images & 100 & 40,000 & 10,000 & 10,000 \\ Camelyon17 & Images & 2 & 302436 & 33560 & – \\ iWildCam & Images & 182 & 129809 & 7314 & 8154 \\ Amazon & Text & 5 & 245502 & 46950 & 46950 \\ \hline \hline \end{tabular}
\end{table}
Table 3: Statistics for all datasets used in the paper. Note that we report the original number of classes and samples of the datasets we use.

the world. The label of each image is one of the 182 animal species. The training and validation set features the same long-tail distribution among classes. As testing data from the target distribution, we use the original test dataset and we perform the following: (i) we keep only the 20 most frequent classes; (ii) we resample the dataset such that classes follow a uniform distribution (thus representing the target label-shifted distribution), with an imposed minimal frequency of 84 samples per testing class. Therefore, the number of samples in the test dataset (target distribution) is 1680, while the validation set (source distribution) contains 6003 samples.

**Amazon**[Ni et al., 2019] consists of texts which represent user reviews, while the label is 1-out-of-5 score of the review. The training and validation set (the source distribution) follows the same long-tail distribution among classes. As the testing dataset is also long-tail, we resample each class based on the frequency of the least frequent class, yielding a test set following a uniform distribution of classes, representing the target, where each class appears 527 times. Therefore, the number of samples in the test dataset (target distribution) is 2860.

### Implementation details

We conduct all experiments on consumer-grade GPUs, that is, all experiments can be conducted on a single Nvidia 3090. We use PyTorch [Paszke et al., 2019] for all deep-learning-based implementations. Below we provide further information about the training procedure for each of the datasets, along with implementation details of the weight estimators we use.

**CIFAR-10/100 (Long-Tail).** We keep the same training procedure for both CIFAR-10/100 and their long-tail variants. Namely, we train all models with stochastic gradient descent (SGD) for 200 epochs, with a peak learning rate of 0.1, linearly warmed up for the first 10% of the training, and then decreased to 0.0 until the end. We apply weight decay of 0.0005, and clip the gradients when their norm exceeds 5.0. During training, we augment the images by applying random horizontal flips.

**WILDS datasets (Camelyon17, iWildCam and Amazon).** We keep the same training procedure across all WILDS datasets, with the only difference across datasets being the data augmentation and the used models. Namely, we train all models with AdamW Loshchilov and Hutter [2017] for 10 epochs, with a peak learning rate of 0.0005, linearly warmed up for the first 10% of the training and then decreased to 0.0 until the end. We apply weight decay of 0.001, and clip the gradients when their norm exceeds 5.0. During training, for models trained on Amazon we do not apply any data augmentation on the input text, while for models trained on Camelyon17 and iWildCam we obtain a random crop of the image with size \(224\times 224\), perform horizontal flipping, and apply color jitter with parameters: brightness=(0.6, 1.4), contrast=(0.6, 1.4), saturation=(0.6, 1.4). During testing, we obtain a single crop with size \(224\times 224\) from the center of the image. For all ImageNet pre-trained models we use Timm [Wightman et al., 2019] (Camelyon17 and iWildCam), while for all pre-trained language models, we use HuggingFace transformers [Wolf et al., 2019]. On Camelyon17 and iWildCam, we train a diverse set of transformer based-models which are pre-trained on ImageNet:

Figure 5: Number of target samples per class in simulated long-tail CIFAR-10/100 datasets with different imbalance factors (IF).

ResNet50 (He et al., 2016), ViT-Large and ViT-Large with input resolution of 384 (Dosovitskiy et al., 2020), and Swin-Large (Liu et al., 2021). On Amazon, we train different transformer-based language models: BERT (bert-base-uncased) (Devlin et al., 2018), D-BERT (distilbert-base-uncased) (Sanh et al., 2019), RoBERTa (roberta-base) (Liu et al., 2019), and D-RoBERTa (distilroberta-base) (Sanh et al., 2019).

**Weight estimators.** Our proposed method relies on estimating importance weights using techniques from the unsupervised domain adaptation literature. Most of the weight estimators (RLLS (Azizzadenesheli et al., 2019), BBSL (Lipton et al., 2018), EM-BCTS (Saerens et al., 2002)) that we use are implemented in https://github.com/kundajelab/abstention. For the ELSA (Tian et al., 2023) method, we used the original implementation provided by the authors. In some of our settings, we detected issues with the weight estimation methods, prompting us to set a minimal value of the confidence scores to \(1\times 10^{-15}\) for EM-BCTS, \(1\times 10^{-3}\) for ELSA, and \(1\times 10^{-2}\) for BBSL, in order to get a reasonable estimate of the weights in most cases. We also encountered issues with the BBSL method on the iWildCam dataset, due to the source distribution containing 0-frequency classes. RLLS consistently delivered the most accurate and stable weight estimations, thus, we report our main results using this method. Note that in certain experiments, some of the importance weight estimation methods (e.g., BBSL) yield poor estimates, resulting in abnormal values for the calibration error. However, addressing these issues is beyond the scope of this paper, as they are specific to the weight estimation methods, and not with our CE estimator.

### Additional experiments with LaSCal as a post-hoc calibration method

In Table 4 we report additional performance evaluation of LaSCal compared to other post-hoc calibration strategies on CIFAR-10/100, where the model is trained on a long-tail source distribution obtained with various imbalance factors (IF). We report CE on the balanced target distribution. The missing values of the HeadToTail method are due to singular matrix error encountered when running the method, using the original code of the paper.

In Table 5 we report additional performance evaluation of LaSCal against traditional, i.i.d, post-hoc calibration methods. Note that VectScal, EnsTempScal, and IROvA are not specifically designed for label-shift scenarios and rely solely on labeled source data. In contrast, LaSCal is tailored for situations where label shift occurs, leveraging both the labeled source data and unlabeled target data to perform calibration. This enables LaSCal to adapt to changes in the class distribution between the source and target domains, providing better calibration under such conditions, as reflected in the reported results.

In Figure 6 and Figure 7 we show reliability diagrams for CIFAR-10 using ResNet-20, and Amazon using DistillBERT, respectively, before and after calibration. Similar to the results presented in the main text, we observe that LaSCal obtains lowest ECE.

\begin{table}
\begin{tabular}{l l l l l l l l l} \hline \hline Model & Uncl & TempScal & VectScal & EnsTempScal & IROvA & CPCS & TransCal & HeadToTail & Laser \\ \hline \multicolumn{8}{l}{**CIFAR-10-LT (IF = 5)**} \\ \hline ResNet-10 & 8.38\({}_{\pm 2.4}\) & 4.71\({}_{\pm 0.16}\) & 4.68\({}_{\pm 0.15}\) & 4.96\({}_{\pm 0.16}\) & 5.55\({}_{\pm 0.20}\) & 4.90\({}_{\pm 0.20}\) & 4.67\({}_{\pm 0.17}\) & 4.60\({}_{\pm 0.13}\) & 4.41\({}_{\pm 0.12}\) \\ ResNet-32 & 10.38\({}_{\pm 0.25}\) & 5.41\({}_{\pm 0.16}\) & 5.34\({}_{\pm 0.16}\) & 5.78\({}_{\pm 0.17}\) & 6.23\({}_{\pm 0.20}\) & 5.63\({}_{\pm 0.19}\) & 5.99\({}_{\pm 0.17}\) & 4.68\({}_{\pm 0.14}\) & 4.69\({}_{\pm 0.15}\) \\ ResNet-56 & 11.86\({}_{\pm 0.11}\) & 5.37\({}_{\pm 0.16}\) & 5.47\({}_{\pm 0.17}\) & 5.17\({}_{\pm 0.18}\) & 6.53\({}_{\pm 0.27}\) & 5.65\({}_{\pm 0.16}\) & 7.19\({}_{\pm 0.18}\) & 4.76\({}_{\pm 0.12}\) & 4.74\({}_{\pm 0.13}\) \\ ResNet-10 & 13.19\({}_{\pm 0.30}\) & 5.69\({}_{\pm 0.18}\) & 5.77\({}_{\pm 0.17}\) & 5.33\({}_{\pm 0.14}\) & 6.80\({}_{\pm 0.27}\) & 5.70\({}_{\pm 0.20}\) & 9.37\({}_{\pm 0.31}\) & – & 4.84\({}_{\pm 0.12}\) \\ \hline \multicolumn{8}{l}{**CIFAR-10-LT (IF = 5)**} \\ \hline ResNet-20 & 65.16\({}_{\pm 0.25}\) & 26.45\({}_{\pm 0.24}\) & 27.50\({}_{\pm 0.28}\) & 27.55\({}_{\pm 0.26}\) & 31.14\({}_{\pm 0.24}\) & 26.26\({}_{\pm 0.28}\) & 47.48\({}_{\pm 0.25}\) & 21.69\({}_{\pm 0.25}\) & 5.97\({}_{\pm 0.00}\) \\ ResNet-35 & 71.34\({}_{\pm 0.20}\) & 28.75\({}_{\pm 0.20}\) & 28.84\({}_{\pm 0.22}\) & 29.54\({}_{\pm 0.28}\) & 31.08\({}_{\pm 0.24}\) & 27.66\({}_{\pm 0.25}\) & 57.39\({}_{\pm 0.24}\) & 28.67\({}_{\pm 0.26}\) & 26.19\({}_{\pm 0.00}\) \\ ResNet-56 & 37.07\({}_{\pm 0.16}\) & 38.13\({}_{\pm 0.18}\) & 38.20\({}_{\pm 0.27}\) & 30.27\({}_{\pm 0.27}\) & 31.51\({}_{\pm 0.23}\) & 29.39\({}_{\pm 0.29}\) & 67.11\({}_{\pm 0.20}\) & 33.12\({}_{\pm 0.27}\) & 47.47\({}_{\pm 0.00}\) \\ ResNet-110 & 73.99\({}_{\pm 0.19}\) & 35.23\({}_{\pm 0.20}\) & 30.74\({}_{\pm 0.25}\) & 34.29\({}_{\pm 0.27}\) & 32.15\({}_{\pm 0.22}\) & 29.58\({}_{\pm 0.28}\) & 62.93\({}_{\pm 0.27}\) & 35.27\({}_{\pm 0.27}\) & 6.61\({}_{\pm 0.00}\) \\ \hline \hline \multicolumn{8}{l}{**CIFAR-10-LT (IF = 2)**} \\ \hline ResNet-30 & 9.09\({}_{\pm 0.14}\) & 5.55\({}_{\pm 0.13}\) & 5.48\({}_{\pm 0.13}\) & 5.96\({}_{\pm 0.13}\) & 6.30\({}_{\pm 0.14}\) & 5.87\({}_{\pm 0.13}\) & 5.28\({}_{\pm 0.12}\) & – & 4.69\({}_{\pm 0.12}\) \\ ResNetAs some of the post-hoc calibration strategies are not accuracy-preserving, in Tables 6 to 8 we report accuracy for the uncalibrated model, as well as for vector scaling, and isotonic regression. We observe that the change in accuracy is negligible in most cases.

\begin{table}
\begin{tabular}{l c c c c c} \hline \hline Model & Uncal & VectScal & EnsTempScal & IROvA & LasCal \\ \hline \multicolumn{6}{l}{_CIFAR-10-LT (IF=10)_} \\ \hline ResNet-20 & \(8.87_{\pm 0.38}\) & \(5.30_{\pm 0.19}\) & \(4.72_{\pm 0.20}\) & \(5.19_{\pm 0.24}\) & \(4.44_{\pm 0.17}\) \\ ResNet-32 & \(10.45_{\pm 0.41}\) & \(5.13_{\pm 0.19}\) & \(5.43_{\pm 0.22}\) & \(5.78_{\pm 0.26}\) & \(4.81_{\pm 0.17}\) \\ ResNet-56 & \(11.25_{\pm 0.31}\) & \(5.14_{\pm 0.17}\) & \(4.69_{\pm 0.18}\) & \(6.01_{\pm 0.25}\) & \(4.57_{\pm 0.15}\) \\ ResNet-110 & \(11.89_{\pm 0.35}\) & \(5.20_{\pm 0.20}\) & \(4.97_{\pm 0.17}\) & \(5.89_{\pm 0.29}\) & \(4.70_{\pm 0.16}\) \\ \hline \multicolumn{6}{l}{_Macro average_} & \multicolumn{1}{c}{10.62} & 5.19 & 4.95 & 5.72 & 4.63 \\ \hline \hline \multicolumn{6}{l}{_CIFAR-10-LT (IF=10)_} \\ \hline ResNet-20 & \(65.66_{\pm 0.23}\) & \(25.91_{\pm 0.22}\) & \(25.37_{\pm 0.20}\) & \(28.75_{\pm 0.24}\) & \(5.62_{\pm 0.08}\) \\ ResNet-32 & \(71.16_{\pm 0.24}\) & \(26.14_{\pm 0.22}\) & \(27.84_{\pm 0.23}\) & \(27.76_{\pm 0.24}\) & \(5.80_{\pm 0.07}\) \\ ResNet-56 & \(72.24_{\pm 0.21}\) & \(26.67_{\pm 0.25}\) & \(28.95_{\pm 0.27}\) & \(28.52_{\pm 0.21}\) & \(5.88_{\pm 0.07}\) \\ ResNet-110 & \(72.80_{\pm 0.21}\) & \(28.36_{\pm 0.26}\) & \(30.96_{\pm 0.26}\) & \(29.96_{\pm 0.19}\) & \(6.19_{\pm 0.08}\) \\ \hline \multicolumn{6}{l}{_Macro average_} & \multicolumn{1}{c}{70.47} & 26.77 & 28.28 & 28.75 & 5.87 \\ \hline \hline \multicolumn{6}{l}{_Amazon Reviews_} \\ \hline RoBERTa & \(11.44_{\pm 0.79}\) & \(5.48_{\pm 0.45}\) & \(4.86_{\pm 0.43}\) & \(4.88_{\pm 0.42}\) & \(3.66_{\pm 0.29}\) \\ DistillRoBERTa & \(17.82_{\pm 0.98}\) & \(5.84_{\pm 0.41}\) & \(5.27_{\pm 0.41}\) & \(4.80_{\pm 0.40}\) & \(2.72_{\pm 0.23}\) \\ BERT & \(27.33_{\pm 0.98}\) & \(8.47_{\pm 0.52}\) & \(7.74_{\pm 0.59}\) & \(7.02_{\pm 0.45}\) & \(3.62_{\pm 0.30}\) \\ DistillBERT & \(22.18_{\pm 1.14}\) & \(7.36_{\pm 0.47}\) & \(6.52_{\pm 0.54}\) & \(6.40_{\pm 0.46}\) & \(3.40_{\pm 0.28}\) \\ \hline \multicolumn{6}{l}{_Macro average_} & \multicolumn{1}{c}{19.19} & 6.79 & 6.10 & 5.78 & 3.38 \\ \hline \hline \multicolumn{6}{l}{_iWildCam_} \\ \hline ResNet50 & \(18.44_{\pm 0.74}\) & \(21.10_{\pm 1.13}\) & \(16.61_{\pm 0.58}\) & \(16.07_{\pm 0.70}\) & \(13.07_{\pm 0.45}\) \\ Swin-Large & \(22.07_{\pm 0.84}\) & \(20.89_{\pm 0.99}\) & \(17.36_{\pm 0.62}\) & \(16.49_{\pm 0.69}\) & \(15.43_{\pm 0.54}\) \\ ViT-Large & \(17.94_{\pm 0.71}\) & \(20.96_{\pm 0.95}\) & \(17.07_{\pm 0.69}\) & \(16.87_{\pm 0.86}\) & \(13.07_{\pm 0.50}\) \\ ViT-Large (384) & \(18.99_{\pm 0.86}\) & \(21.64_{\pm 1.07}\) & \(18.69_{\pm 0.75}\) & \(16.49_{\pm 0.77}\) & \(17.27_{\pm 0.66}\) \\ \hline \multicolumn{6}{l}{_Macro average_} & \multicolumn{1}{c}{19.36} & 21.15 & 17.43 & 16.48 & 14.71 \\ \hline \hline \end{tabular}
\end{table}
Table 5: CE on label-shifted target domain before and after calibration with various post-hoc methods.

Figure 6: Reliabiliy diagrams on CIFAR-10 using ResNet-20 before and after calibration.

Figure 7: Reliability diagrams on Amazon using DistillRoBERTa before and after calibration.

[MISSING_PAGE_FAIL:19]

methods, resulting in abnormal CE values. In contrast, the RLLS method yields stable and reliable values across all settings. The CE estimates obtained using RLLS often closely align with those of the CE estimator that utilizes ground truth weights, denoted as \(\bm{\omega}^{*}\).

\begin{table}
\begin{tabular}{l c c c c c c c} \hline \hline \multirow{2}{*}{Model} & \multirow{2}{*}{Acc\({}_{\epsilon}\)} & \multirow{2}{*}{Acc\({}_{\epsilon}\)} & \multirow{2}{*}{CE\({}_{\epsilon}\)} & \multirow{2}{*}{CE\({}_{\epsilon}\)} & \multirow{2}{*}{\(\widetilde{\text{CE}}_{\epsilon}(\bm{\omega}^{*})\)} & \(\widetilde{\text{CE}}_{\epsilon}(\hat{\bm{\omega}})\) & \(\widetilde{\text{CE}}_{\epsilon}(\hat{\bm{\omega}})\) & \(\widetilde{\text{CE}}_{\epsilon}(\hat{\bm{\omega}})\) \\  & & & & & RLS & ELSA & EM-BCTS & BBSL \\ \hline \hline \multicolumn{1}{l}{_CIFAR-10-LT_} & & & & & & & & \\ ResNet-20 & \(87.22_{\pm 0.65}\) & \(8.76_{\pm 0.12}\) & \(7.95_{\pm 0.32}\) & \(8.70_{\pm 0.40}\) & \(10.77_{\pm 0.50}\) & \(12.13_{\pm 0.72}\) \\ ResNet-32 & \(88.47_{\pm 0.63}\) & \(10.72_{\pm 0.21}\) & \(9.36_{\pm 0.42}\) & \(9.71_{\pm 0.52}\) & \(10.57_{\pm 0.41}\) & \(10.88_{\pm 0.53}\) \\ ResNet-56 & \(88.53_{\pm 0.62}\) & \(10.02_{\pm 0.14}\) & \(8.47_{\pm 0.37}\) & \(8.82_{\pm 0.48}\) & \(10.10_{\pm 0.55}\) & \(10.78_{\pm 0.53}\) \\ ResNet-110 & \(90.00_{\pm 0.59}\) & \(13.74_{\pm 0.33}\) & \(10.42_{\pm 0.62}\) & \(10.36_{\pm 0.60}\) & \(10.45_{\pm 0.58}\) & \(10.83_{\pm 0.58}\) \\ \hline \hline \multicolumn{1}{l}{_CIFAR-100_} & & & & & & & \\ ResNet-20 & \(61.19_{\pm 0.96}\) & \(59.15_{\pm 0.26}\) & \(57.08_{\pm 0.42}\) & \(57.54_{\pm 0.48}\) & \(53.83_{\pm 0.78}\) & \(53.38_{\pm 0.83}\) \\ ResNet-32 & \(62.71_{\pm 0.95}\) & \(67.24_{\pm 0.24}\) & \(65.16_{\pm 0.46}\) & \(65.77_{\pm 0.42}\) & \(61.10_{\pm 0.80}\) & \(60.20_{\pm 0.81}\) \\ ResNet-56 & \(65.07_{\pm 0.93}\) & \(74.59_{\pm 0.19}\) & \(72.58_{\pm 0.35}\) & \(73.55_{\pm 0.45}\) & \(68.67_{\pm 0.80}\) & \(69.51_{\pm 0.84}\) \\ ResNet-110 & \(65.96_{\pm 0.93}\) & \(76.04_{\pm 0.18}\) & \(73.83_{\pm 0.35}\) & \(74.27_{\pm 0.38}\) & \(67.72_{\pm 0.75}\) & \(68.15_{\pm 0.83}\) \\ \hline \hline \end{tabular}
\end{table}
Table 10: Performance evaluation of our estimator on a label-shifted target distribution using different imbalance factors, with models trained on balanced CIFAR-10/100. Across both shifts, LaSCal (\(\widetilde{\text{CE}}_{\epsilon}\)) yields accurate estimates compared to the ground truth (with labels), and effectively handles even the severe case with \(\mathrm{IF}=100\). The error bars represent 95\(\%\) CI for Acc, and average standard deviation across classes for \(\mathrm{CE}\).

\begin{table}
\begin{tabular}{l c c c c c c c c} \hline \hline \multirow{2}{*}{Model} & \multirow{2}{*}{Acc\({}_{\epsilon}\)} & \multirow{2}{*}{Acc\({}_{\epsilon}\)} & \multirow{2}{*}{CE\({}_{\epsilon}\)} & \multirow{2}{*}{CE\({}_{\epsilon}\)} & \multirow{2}{*}{\(\widetilde{\text{CE}}_{\epsilon}(\bm{\omega}^{*})\)} & \(\widetilde{\text{CE}}_{\epsilon}(\hat{\bm{\omega}})\) & \(\widetilde{\text{CE}}_{\epsilon}(\hat{\bm{\omega}})\) & \(\widetilde{\text{CE}}_{\epsilon}(\hat{\bm{\omega}})\) \\  & & & & & RLS & ELSA & EM-BCTS & BBSL \\ \hline \hline \multicolumn{1}{l}{_CIFAR-10-LT_} & & & & & & & & \\ ResNet-20 & \(83.10_{\pm 1.5}\) & \(78.24_{\pm 0.81}\) & \(8.19_{\pm 0.41}\) & \(8.86_{\pm 0.32}\) & \(9.26_{\pm 0.29}\) & \(8.93_{\pm 0.33}\) & \(9.06_{\pm 0.31}\) & \(8.57_{\pm 0.48}\) & \(9.01_{\pm 0.40}\) \\ ResNet-32 & \(55.48_{\pm 1.08}\) & \(50.87_{\pm 0.79}\) & \(9.18_{\pm 0.50}\) & \(10.45_{\pm 0.90}\) & \(11.75_{\pm 0.46}\) & \(12.16_{\pm 0.42}\) & \(12.03_{\pm 0.39}\) & \(11.20_{\pm 0.47}\) & \(12.19_{\pm 0.39}\) \\ ResNet-56 & \(85.38_{\pm 1.18}\) & \(81.71_{\pm 0.76}\) & \(9.87_{\pm 0.54}\) & \(11.24_{\pm 0.13}\) & \(11.67_{\pm 0.33}\) & \(11.71_{\pm 0.24}\) & \(11.62_{\pm 0.34}\) & \(11.19_{\pm 0.49}\) & \(11.77_{\pm 0.30}\) \\ ResNet-110 & \(84.94_{\pm 1.10}\) & \(81.29_{\pm 0.76}\) & \(10.06_{\pm 0.58}\) & \(11.95_{\pm 0.38}\) & \(12.28_{\pm 0.35}\) & \(12.21_{\pm 0.33}\) & \(12.18_{\pm 0.33}\) & \(11.69_{\pm 0.41}\) & \(12.26_{\pm 0.35}\) \\ \hline \hline \multicolumn{1}{l}{_CIFAR-100-LT_} & & & & & & & & \\ \hline \hline \multicolumn{1}{l}{_CIFAR-10-LT_} & & & & & & & & & \\ ResNet-20 & \(83.10_{\pm 1.5}\) & \(78.24_{\pm 0.81}\) & \(8.19_{\pm 0.41}\) & \(8.86_{\pm 0.33}\) & \(9.26_{\pm 0.29}\) & \(8.93_{\pm 0.33}\) & \(9.06_{\pm 0.31}\) & \(8.57_{\pm 0.48}\) & \(9.01_{\pm 0.40}\) \\ ResNet-32 & \(55.48_{\pm 1.08}\) & \(50.87_{\pm 0.47}\) & \(9.18_{\pm 0.50}\) & \(10.45_{\pm 0.90}\) & \(11.75_{\pm

\begin{table}
\begin{tabular}{l c c c c c c c c c} \hline \hline Model & Acc\({}_{s}\) & Acc\({}_{t}\) & CE\({}_{s}\) & CE\({}_{t}\) & \(\widehat{\rm CE}_{t}(\bm{\omega}^{\star})\) & \(\widehat{\rm CE}_{t}(\hat{\bm{\omega}})\) & \(\widehat{\rm CE}_{t}(\hat{\bm{\omega}})\) & \(\widehat{\rm CE}_{t}(\hat{\bm{\omega}})\) & \(\widehat{\rm CE}_{t}(\hat{\bm{\omega}})\) \\  & & & & & RLLS & ELSA & EM-BCTS & BBSL \\ \hline \hline _CIFAR-10-LT_ & & & & & & & & & \\ \hline ResNet-20 & 86.74\({}_{\pm 0.78}\) & 85.78\({}_{\pm 0.68}\) & 22.60\({}_{\pm 0.64}\) & 28.60\({}_{\pm 0.40}\) & 29.90\({}_{\pm 0.56}\) & 30.17\({}_{\pm 0.52}\) & 30.26\({}_{\pm 0.55}\) & 30.28\({}_{\pm 0.50}\) & 30.26\({}_{\pm 0.60}\) \\ ResNet-32 & 86.94\({}_{\pm 0.78}\) & 86.22\({}_{\pm 0.66}\) & 23.62\({}_{\pm 0.72}\) & 32.37\({}_{\pm 0.51}\) & 33.21\({}_{\pm 0.56}\) & 33.04\({}_{\pm 0.54}\) & 32.79\({}_{\pm 0.51}\) & 32.84\({}_{\pm 0.62}\) & 33.05\({}_{\pm 0.55}\) \\ ResNet-56 & 88.41\({}_{\pm 0.74}\) & 87.93\({}_{\pm 0.64}\) & 26.15\({}_{\pm 0.89}\) & 36.66\({}_{\pm 0.71}\) & 36.76\({}_{\pm 0.59}\) & 37.15\({}_{\pm 0.99}\) & 36.92\({}_{\pm 0.89}\) & 33.17\({}_{\pm 0.74}\) & 37.01\({}_{\pm 0.86}\) \\ ResNet-110 & 88.33\({}_{\pm 0.74}\) & 87.51\({}_{\pm 0.65}\) & 27.65\({}_{\pm 0.87}\) & 36.80\({}_{\pm 1.20}\) & 37.25\({}_{\pm 0.18}\) & 38.23\({}_{\pm 0.98}\) & 37.83\({}_{\pm 1.10}\) & 37.37\({}_{\pm 1.03}\) & 38.15\({}_{\pm 1.00}\) \\ \hline _CIFAR-100-LT_ & & & & & & & & & \\ \hline ResNet-20 & 56.81\({}_{\pm 1.15}\) & 56.71\({}_{\pm 0.97}\) & 60.41\({}_{\pm 0.27}\) & 61.43\({}_{\pm 0.23}\) & 61.71\({}_{\pm 0.21}\) & 61.80\({}_{\pm 0.18}\) & 61.76\({}_{\pm 0.18}\) & 61.15\({}_{\pm 0.29}\) & 123.74\({}_{\pm 1.72}\) \\ ResNet-32 & 58.43\({}_{\pm 1.14}\) & 58.59\({}_{\pm 0.97}\) & 70.46\({}_{\pm 0.26}\) & 70.48\({}_{\pm 0.22}\) & 70.53\({}_{\pm 0.28}\) & 71.24\({}_{\pm 0.15}\) & 71.33\({}_{\pm 0.21}\) & 70.22\({}_{\pm 0.25}\) & 71.66\({}_{\pm 0.15}\) \\ ResNet-56 & 60.42\({}_{\pm 1.13}\) & 59.96\({}_{\pm 0.96}\) & 73.93\({}_{\pm 0.18}\) & 74.49\({}_{\pm 0.17}\) & 74.30\({}_{\pm 0.19}\) & 74.86\({}_{\pm 0.16}\) & 74.74\({}_{\pm 0.20}\) & 74.07\({}_{\pm 0.17}\) & 74.86\({}_{\pm 0.22}\) \\ ResNet-110 & 62.88\({}_{\pm 1.12}\) & 61.99\({}_{\pm 0.95}\) & 74.93\({}_{\pm 0.20}\) & 75.45\({}_{\pm 0.88}\) & 75.39\({}_{\pm 0.20}\) & 75.74\({}_{\pm 0.20}\) & 75.88\({}_{\pm 0.15}\) & 75.07\({}_{\pm 0.16}\) & 75.68\({}_{\pm 0.18}\) \\ \hline \hline \end{tabular}
\end{table}
Table 14: Comparison of different importance weight estimators. The source is obtained with an \(\rm IF=10\). We measure \(L_{1}\) CE.

\begin{table}
\begin{tabular}{l c c c c c c c c} \hline \hline Model & Acc\({}_{s}\) & Acc\({}_{t}\) & CE\({}_{s}\) & CE\({}_{t}\) & \(\widehat{\rm CE}_{t}(\bm{\omega}^{\star})\) & \(\widehat{\rm CE}_{t}(\hat{\bm{\omega}})\) & \(\widehat{\rm CE}_{t}(\hat{\bm{\omega}})\) & \(\widehat{\rm CE}_{t}(\hat{\bm{\omega}})\) & \(\widehat{\rm CE}_{t}(\hat{\bm{\omega}})\) & \(\widehat{\rm CE}_{t}(\hat{\bm{\omega}})\) \\  & & & & & & RLLS & ELSA & EM-BCTS & BBSL \\ \hline _CIFAR-10-LT_ & & & & & & & & & \\ \hline ResNet-20 & 86.74\({}_{\pm 0.78}\) & 85.78\({}_{\pm 0.68}\) & 5.27\({}_{\pm 0.33}\) & 9.05\({}_{\pm 0.14}\) & 9.48\({}_{\pm 0.16}\) & 9.53\({}_{\pm 0.15}\) & 9.59\({}_{\pm 0.14}\) & 9.55\({}_{\pm 0.17}\) & 9.54\({}_{\pm 0.14}\) \\ ResNet-32 & 86.94\({}_{\pm 0.78}\) & 86.82\({}_{\pm 0.66}\) & 5.59\({}_{\pm 0.35}\) & 110.0\({}_{\pm 0.25}\) & 11.14\({}_{\pm 0.21}\) & 11.03\({}_{\pm 0.25}\) & 11.01\({}_{\pm 0.22}\) & 11.01\({}_{\pm 0.23}\) & 11.01\({}_{\pm 0.23}\) & 11.06\({}_{\pm 0.21}\) \\ ResNet-36 & 88.41\({}_{\pm 0.74}\) & 87.93\({}_{\pm 0.64}\) & 7.84\({}_{\pm 0.53}\) & 13.80\({}_{\pm 0.33}\) & 13.85\({}_{\pm 0.34}\) & 13.94\({}_{\pm 0.39}\) & 13.94\({}_{\pm 0.35}\) & 13.93\({}_{\pm 0.33}\) & 13.93\({}_{\pm 0.35}\) \\ ResNet-110 & 88.33\({}_{\pm 0.74}\) & 87.51\({}_{\pm 0.65}\) & 7.71\({}_{\pm 0.52}\) & 13.60\({}_{\pm 0.55}\) & 13.83\Top-label calibration

In the main paper, we focus on classwise calibration error, as it provides a more comprehensive measure of calibration by assessing the alignment of the model's confidence across all classes, rather than just the highest prediction. However, top-label calibration is widely used in the literature, so we demonstrate here how our estimator can be extended to handle this form of calibration.

For top-label calibration, we focus on the maximum score \(Q=\max(f(X))\), which corresponds to the top prediction. As before, the class labels are represented as one-hot encoded variables \(Y\in\{\mathbf{e}_{1},\ldots,\mathbf{e}_{k}\}\subset\Delta^{k}\), where \(e_{i}\) is the one-hot vector corresponding to class \(i\). The top-label \(L_{p}\) calibration error is [Kumar et al., 2019, Kull et al., 2019, Gruber and Buettner, 2022]:

\[\text{TCE}_{p}(f)^{p}=\mathbb{E}\Bigg{[}\Big{|}\mathbb{P}\big{[}Y=e_{\arg\max f (X)}\mid Q\big{]}-Q\Big{|}^{p}\Bigg{]}\] (8)

We aim to find an estimator of the form:

\[\widehat{\text{TCE}}_{p}(f)^{p}=\frac{1}{m}\sum_{j=n+1}^{m+n}\big{|}\widehat{ \mathbb{E}_{p_{i}}}[\mathbbm{1}(Y=e_{\arg\max f(X)})\mid q_{j}]-q_{j}\Big{|}^ {p},\] (9)

where the expectations are taken w.r.t. the target, and \(q_{j}\) denotes the top-label prediction for input \(x_{j}\). For the estimator of the conditional expectation we compute:

\[\mathbb{E}_{p_{i}}[\mathbbm{1}(Y=e_{\arg\max f(X)})\mid Q=q]\approx\frac{ \frac{1}{n}\sum_{c=1}^{k}\sum_{i\in S_{c}}\hat{\omega}_{c}\kappa(Q=q,q_{i}) \mathbbm{1}(y_{i}=\arg\max f(x_{i}))}{\frac{1}{m}\sum_{i=n+1}^{m+n}\kappa(Q=q, q_{i})},\] (10)

where \(S_{c}\) is the subset of samples where the true label is \(c\), and \(\mathbbm{1}\) is an indicator function returning 1 if the predicted label matches the true label for sample \(x_{i}\), and 0 otherwise.

The results presented in Tables 17 and 18 show that the observations remain the same as in the main paper: (i) LaSCal significantly reduces the CE of all models across datasets; (ii) LaSCal outperforms the baselines, achieving state-of-the-art results on the datasets and settings we experiment with.

\begin{table}
\begin{tabular}{l c c c c c c} \hline \hline Model & Uncal & TempScal & HeadToTail & EM-BCTS & CPMCN & LaSCal \\ \hline RoBERTa & \(6.03_{\pm 0.50}\) & \(1.14_{\pm 0.16}\) & \(0.93_{\pm 0.17}\) & \(0.40_{\pm 0.11}\) & \(0.37_{\pm 0.10}\) & \(0.29_{\pm 0.08}\) \\ DistillRoBERTa & \(10.73_{\pm 0.63}\) & \(1.83_{\pm 0.25}\) & \(0.58_{\pm 0.12}\) & \(0.43_{\pm 0.09}\) & \(0.66_{\pm 0.14}\) & \(0.42_{\pm 0.11}\) \\ BERT & \(17.32_{\pm 0.67}\) & \(3.71_{\pm 0.35}\) & \(0.73_{\pm 0.13}\) & \(0.75_{\pm 0.15}\) & \(2.19_{\pm 0.21}\) & \(0.61_{\pm 0.12}\) \\ DistillBERT & \(13.59_{\pm 0.72}\) & \(2.22_{\pm 0.25}\) & \(0.33_{\pm 0.10}\) & \(0.37_{\pm 0.09}\) & \(1.72_{\pm 0.25}\) & \(0.30_{\pm 0.09}\) \\ \hline Macro-average & \(11.42_{\pm 0.59}\) & \(2.23_{\pm 0.17}\) & \(0.64_{\pm 0.09}\) & \(0.49_{\pm 0.07}\) & \(1.24_{\pm 0.19}\) & \(\mathbf{0.41_{\pm 0.09}}\) \\ \hline \hline \end{tabular}
\end{table}
Table 17: Amazon experiments

\begin{table}
\begin{tabular}{l c c c c c c} \hline \hline Model & Uncal & TempScal & HeadToTail & EM-BCTS & CPMCN & LaSCal \\ \hline ResNet50 & \(3.21_{\pm 0.40}\) & \(1.66_{\pm 0.27}\) & \(1.06_{\pm 0.24}\) & \(0.64_{\pm 0.15}\) & \(2.40_{\pm 0.34}\) & \(0.74_{\pm 0.17}\) \\ Swin-Large & \(5.92_{\pm 0.57}\) & \(1.88_{\pm 0.28}\) & \(1.07_{\pm 0.25}\) & \(1.48_{\pm 0.27}\) & \(1.17_{\pm 0.28}\) & \(1.17_{\pm 0.26}\) \\ ViT-Large & \(2.43_{\pm 0.41}\) & \(1.59_{\pm 0.33}\) & \(1.48_{\pm 0.26}\) & \(3.32_{\pm 0.43}\) & \(2.34_{\pm 0.33}\) & \(0.62_{\pm 0.14}\) \\ ViT-Large (384) & \(2.69_{\pm 0.40}\) & \(1.96_{\pm 0.33}\) & \(1.85_{\pm 0.34}\) & \(1.93_{\pm 0.34}\) & \(2.18_{\pm 0.37}\) & \(0.81_{\pm 0.16}\) \\ \hline Macro-average & \(3.56_{\pm 0.41}\) & \(1.77_{\pm 0.26}\) & \(1.37_{\pm 0.27}\) & \(1.84_{\pm 0.21}\) & \(2.02_{\pm 0.23}\) & \(\mathbf{0.84_{\pm 0.12}}\) \\ \hline \hline \end{tabular}
\end{table}
Table 18: iWildCam experiments

### NeurIPS Paper Checklist

1. **Claims** Question: Do the main claims made in the abstract and introduction accurately reflect the paper's contributions and scope? Answer: [Yes] Justification: The abstract and introduction clearly state our contributions: a novel CE estimator, a post-hoc method for unsupervised calibration, and extensive empirical validation. The assumptions and scope (label shift scenario) are properly defined. Guidelines: * The answer NA means that the abstract and introduction do not include the claims made in the paper. * The abstract and/or introduction should clearly state the claims made, including the contributions made in the paper and important assumptions and limitations. A No or NA answer to this question will not be perceived well by the reviewers. * The claims made should match theoretical and experimental results, and reflect how much the results can be expected to generalize to other settings. * It is fine to include aspirational goals as motivation as long as it is clear that these goals are not attained by the paper.
2. **Limitations** Question: Does the paper discuss the limitations of the work performed by the authors? Answer: [Yes] Justification: Limitations are discussed in a separate paragraph in Section 5. Guidelines: * The answer NA means that the paper has no limitation while the answer No means that the paper has limitations, but those are not discussed in the paper. * The authors are encouraged to create a separate "Limitations" section in their paper. * The paper should point out any strong assumptions and how robust the results are to violations of these assumptions (e.g., independence assumptions, noiseless settings, model well-specification, asymptotic approximations only holding locally). The authors should reflect on how these assumptions might be violated in practice and what the implications would be. * The authors should reflect on the scope of the claims made, e.g., if the approach was only tested on a few datasets or with a few runs. In general, empirical results often depend on implicit assumptions, which should be articulated. * The authors should reflect on the factors that influence the performance of the approach. For example, a facial recognition algorithm may perform poorly when image resolution is low or images are taken in low lighting. Or a speech-to-text system might not be used reliably to provide closed captions for online lectures because it fails to handle technical jargon. * The authors should discuss the computational efficiency of the proposed algorithms and how they scale with dataset size. * If applicable, the authors should discuss possible limitations of their approach to address problems of privacy and fairness. * While the authors might fear that complete honesty about limitations might be used by reviewers as grounds for rejection, a worse outcome might be that reviewers discover limitations that aren't acknowledged in the paper. The authors should use their best judgment and recognize that individual actions in favor of transparency play an important role in developing norms that preserve the integrity of the community. Reviewers will be specifically instructed to not penalize honesty concerning limitations.
3. **Theory Assumptions and Proofs** Question: For each theoretical result, does the paper provide the full set of assumptions and a complete (and correct) proof?Answer: [Yes] Justification: To the best of our knowledge, all assumptions are provided. The pointwise consistency results are supported by sketch proofs. Guidelines: * The answer NA means that the paper does not include theoretical results. * All the theorems, formulas, and proofs in the paper should be numbered and cross-referenced. * All assumptions should be clearly stated or referenced in the statement of any theorems. * The proofs can either appear in the main paper or the supplemental material, but if they appear in the supplemental material, the authors are encouraged to provide a short proof sketch to provide intuition. * Inversely, any informal proof provided in the core of the paper should be complemented by formal proofs provided in appendix or supplemental material. * Theorems and Lemmas that the proof relies upon should be properly referenced.
4. **Experimental Result Reproducibility** Question: Does the paper fully disclose all the information needed to reproduce the main experimental results of the paper to the extent that it affects the main claims and/or conclusions of the paper (regardless of whether the code and data are provided or not)? Answer: [Yes] Justification: The method, datasets, metrics, and models are described in sufficient detail in the main text. Appendix A.1 and A.2 contain more details about the datasets and the implementation. The code is released at: https://github.com/tpopordanoska/label-shift-calibration. Guidelines: * The answer NA means that the paper does not include experiments. * If the paper includes experiments, a No answer to this question will not be perceived well by the reviewers: Making the paper reproducible is important, regardless of whether the code and data are provided or not. * If the contribution is a dataset and/or model, the authors should describe the steps taken to make their results reproducible or verifiable. * Depending on the contribution, reproducibility can be accomplished in various ways. For example, if the contribution is a novel architecture, describing the architecture fully might suffice, or if the contribution is a specific model and empirical evaluation, it may be necessary to either make it possible for others to replicate the model with the same dataset, or provide access to the model. In general. releasing code and data is often one good way to accomplish this, but reproducibility can also be provided via detailed instructions for how to replicate the results, access to a hosted model (e.g., in the case of a large language model), releasing of a model checkpoint, or other means that are appropriate to the research performed. * While NeurIPS does not require releasing code, the conference does require all submissions to provide some reasonable avenue for reproducibility, which may depend on the nature of the contribution. For example 1. If the contribution is primarily a new algorithm, the paper should make it clear how to reproduce that algorithm. 2. If the contribution is primarily a new model architecture, the paper should describe the architecture clearly and fully. 3. If the contribution is a new model (e.g., a large language model), then there should either be a way to access this model for reproducing the results or a way to reproduce the model (e.g., with an open-source dataset or instructions for how to construct the dataset). 4. We recognize that reproducibility may be tricky in some cases, in which case authors are welcome to describe the particular way they provide for reproducibility. In the case of closed-source models, it may be that access to the model is limited in some way (e.g., to registered users), but it should be possible for other researchers to have some path to reproducing or verifying the results.

5. **Open access to data and code** Question: Does the paper provide open access to the data and code, with sufficient instructions to faithfully reproduce the main experimental results, as described in supplemental material? Answer: [Yes] Justification: All datasets we use are publicly available, and the code is released. Guidelines: * The answer NA means that paper does not include experiments requiring code. * Please see the NeurIPS code and data submission guidelines (https://nips.cc/public/guides/CodeSubmissionPolicy) for more details. * While we encourage the release of code and data, we understand that this might not be possible, so "No" is an acceptable answer. Papers cannot be rejected simply for not including code, unless this is central to the contribution (e.g., for a new open-source benchmark). * The instructions should contain the exact command and environment needed to run to reproduce the results. See the NeurIPS code and data submission guidelines (https://nips.cc/public/guides/CodeSubmissionPolicy) for more details. * The authors should provide instructions on data access and preparation, including how to access the raw data, preprocessed data, intermediate data, and generated data, etc. * The authors should provide scripts to reproduce all experimental results for the new proposed method and baselines. If only a subset of experiments are reproducible, they should state which ones are omitted from the script and why. * At submission time, to preserve anonymity, the authors should release anonymized versions (if applicable). * Providing as much information as possible in supplemental material (appended to the paper) is recommended, but including URLs to data and code is permitted.
6. **Experimental Setting/Details** Question: Does the paper specify all the training and test details (e.g., data splits, hyperparameters, how they were chosen, type of optimizer, etc.) necessary to understand the results? Answer: [Yes] Justification: The main text specifies enough details to understand the results. The full detailed information about datasets, hyperparameters and other implementation details is given in Appendix A.1 and A.2. Guidelines: * The answer NA means that the paper does not include experiments. * The experimental setting should be presented in the core of the paper to a level of detail that is necessary to appreciate the results and make sense of them. * The full details can be provided either with the code, in appendix, or as supplemental material.
7. **Experiment Statistical Significance** Question: Does the paper report error bars suitably and correctly defined or other appropriate information about the statistical significance of the experiments? Answer: [Yes] Justification: The main results (Table 2 and Figure 3) report mean and standard deviation values obtained using bootstrap (repeatedly resampling with replacement and estimating CE on each subset). Guidelines: * The answer NA means that the paper does not include experiments. * The authors should answer "Yes" if the results are accompanied by error bars, confidence intervals, or statistical significance tests, at least for the experiments that support the main claims of the paper.

* The factors of variability that the error bars are capturing should be clearly stated (for example, train/test split, initialization, random drawing of some parameter, or overall run with given experimental conditions).
* The method for calculating the error bars should be explained (closed form formula, call to a library function, bootstrap, etc.)
* The assumptions made should be given (e.g., Normally distributed errors).
* It should be clear whether the error bar is the standard deviation or the standard error of the mean.
* It is OK to report 1-sigma error bars, but one should state it. The authors should preferably report a 2-sigma error bar than state that they have a 96% CI, if the hypothesis of Normality of errors is not verified.
* For asymmetric distributions, the authors should be careful not to show in tables or figures symmetric error bars that would yield results that are out of range (e.g. negative error rates).
* If error bars are reported in tables or plots, The authors should explain in the text how they were calculated and reference the corresponding figures or tables in the text.
8. **Experiments Compute Resources** Question: For each experiment, does the paper provide sufficient information on the computer resources (type of compute workers, memory, time of execution) needed to reproduce the experiments? Answer: [Yes] Justification: In appendix A.2 we provide information about the resources used in our experiments. Guidelines: * The answer NA means that the paper does not include experiments. * The paper should indicate the type of compute workers CPU or GPU, internal cluster, or cloud provider, including relevant memory and storage. * The paper should provide the amount of compute required for each of the individual experimental runs as well as estimate the total compute. * The paper should disclose whether the full research project required more compute than the experiments reported in the paper (e.g., preliminary or failed experiments that didn't make it into the paper).
9. **Code Of Ethics** Question: Does the research conducted in the paper conform, in every respect, with the NeurIPS Code of Ethics https://neurips.cc/public/EthicsGuidelines? Answer: [Yes] Justification: To the best of our knowledge, the paper conforms with the NeurIPS Code of Ethics. Guidelines: * The answer NA means that the authors have not reviewed the NeurIPS Code of Ethics. * If the authors answer No, they should explain the special circumstances that require a deviation from the Code of Ethics. * The authors should make sure to preserve anonymity (e.g., if there is a special consideration due to laws or regulations in their jurisdiction).
10. **Broader Impacts** Question: Does the paper discuss both potential positive societal impacts and negative societal impacts of the work performed? Answer: [Yes] Justification: Broader impact and ethical risks are discussed in Section 5. Guidelines: * The answer NA means that there is no societal impact of the work performed.

* If the authors answer NA or No, they should explain why their work has no societal impact or why the paper does not address societal impact.
* Examples of negative societal impacts include potential malicious or unintended uses (e.g., disinformation, generating fake profiles, surveillance), fairness considerations (e.g., deployment of technologies that could make decisions that unfairly impact specific groups), privacy considerations, and security considerations.
* The conference expects that many papers will be foundational research and not tied to particular applications, let alone deployments. However, if there is a direct path to any negative applications, the authors should point it out. For example, it is legitimate to point out that an improvement in the quality of generative models could be used to generate deepfakes for disinformation. On the other hand, it is not needed to point out that a generic algorithm for optimizing neural networks could enable people to train models that generate Deepfakes faster.
* The authors should consider possible harms that could arise when the technology is being used as intended and functioning correctly, harms that could arise when the technology is being used as intended but gives incorrect results, and harms following from (intentional or unintentional) misuse of the technology.
* If there are negative societal impacts, the authors could also discuss possible mitigation strategies (e.g., gated release of models, providing defenses in addition to attacks, mechanisms for monitoring misuse, mechanisms to monitor how a system learns from feedback over time, improving the efficiency and accessibility of ML).
11. **Safeguards** Question: Does the paper describe safeguards that have been put in place for responsible release of data or models that have a high risk for misuse (e.g., pretrained language models, image generators, or scraped datasets)? Answer: [NA] Justification: The paper will not release data or models with a risk of misuse. Guidelines: * The answer NA means that the paper poses no such risks. * Released models that have a high risk for misuse or dual-use should be released with necessary safeguards to allow for controlled use of the model, for example by requiring that users adhere to usage guidelines or restrictions to access the model or implementing safety filters. * Datasets that have been scraped from the Internet could pose safety risks. The authors should describe how they avoided releasing unsafe images. * We recognize that providing effective safeguards is challenging, and many papers do not require this, but we encourage authors to take this into account and make a best faith effort.
12. **Licenses for existing assets** Question: Are the creators or original owners of assets (e.g., code, data, models), used in the paper, properly credited and are the license and terms of use explicitly mentioned and properly respected? Answer: [Yes] Justification: We appropriately cite the creators of all datasets, models, and code packages we use. Guidelines: * The answer NA means that the paper does not use existing assets. * The authors should cite the original paper that produced the code package or dataset. * The authors should state which version of the asset is used and, if possible, include a URL. * The name of the license (e.g., CC-BY 4.0) should be included for each asset. * For scraped data from a particular source (e.g., website), the copyright and terms of service of that source should be provided.

* If assets are released, the license, copyright information, and terms of use in the package should be provided. For popular datasets, paperswithcode.com/datasets has curated licenses for some datasets. Their licensing guide can help determine the license of a dataset.
* For existing datasets that are re-packaged, both the original license and the license of the derived asset (if it has changed) should be provided.
* If this information is not available online, the authors are encouraged to reach out to the asset's creators.
13. **New Assets** Question: Are new assets introduced in the paper well documented and is the documentation provided alongside the assets? Answer: [NA] Justification: We do not release new assets. Guidelines: * The answer NA means that the paper does not release new assets. * Researchers should communicate the details of the dataset/code/model as part of their submissions via structured templates. This includes details about training, license, limitations, etc. * The paper should discuss whether and how consent was obtained from people whose asset is used. * At submission time, remember to anonymize your assets (if applicable). You can either create an anonymized URL or include an anonymized zip file.
14. **Crowdsourcing and Research with Human Subjects** Question: For crowdsourcing experiments and research with human subjects, does the paper include the full text of instructions given to participants and screenshots, if applicable, as well as details about compensation (if any)? Answer: [NA] Justification: The paper does not involve crowdsourcing nor research with human subjects. Guidelines: * The answer NA means that the paper does not involve crowdsourcing nor research with human subjects. * Including this information in the supplemental material is fine, but if the main contribution of the paper involves human subjects, then as much detail as possible should be included in the main paper. * According to the NeurIPS Code of Ethics, workers involved in data collection, curation, or other labor should be paid at least the minimum wage in the country of the data collector.
15. **Institutional Review Board (IRB) Approvals or Equivalent for Research with Human Subjects** Question: Does the paper describe potential risks incurred by study participants, whether such risks were disclosed to the subjects, and whether Institutional Review Board (IRB) approvals (or an equivalent approval/review based on the requirements of your country or institution) were obtained? Answer: [NA] Justification: The paper does not involve crowdsourcing nor research with human subjects. Guidelines: * The answer NA means that the paper does not involve crowdsourcing nor research with human subjects. * Depending on the country in which research is conducted, IRB approval (or equivalent) may be required for any human subjects research. If you obtained IRB approval, you should clearly state this in the paper.

* We recognize that the procedures for this may vary significantly between institutions and locations, and we expect authors to adhere to the NeurIPS Code of Ethics and the guidelines for their institution.
* For initial submissions, do not include any information that would break anonymity (if applicable), such as the institution conducting the review.