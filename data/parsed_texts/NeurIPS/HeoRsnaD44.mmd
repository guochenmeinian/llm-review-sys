# Unified Guidance for Geometry-Conditioned Molecular Generation

Sirine Ayadi\({}^{*1,2}\)

Leon Hetzel\({}^{*1,2,3}\)

Johanna Sommer\({}^{*1,2}\)

Fabian Theis\({}^{1,2,3}\)

Stephan Gunnemann\({}^{1,2}\)

Equal contributionProject Page: www.cs.cit.tum.de/daml/uniguide

###### Abstract

Effectively designing molecular geometries is essential to advancing pharmaceutical innovations, a domain, which has experienced great attention through the success of generative models and, in particular, diffusion models. However, current molecular diffusion models are tailored towards a specific downstream task and lack adaptability. We introduce UniGuide, a framework for controlled geometric guidance of unconditional diffusion models that allows flexible conditioning during inference without the requirement of extra training or networks. We show how applications such as structure-based, fragment-based, and ligand-based drug design are formulated in the UniGuide framework and demonstrate on-par or superior performance compared to specialised models. Offering a more versatile approach, UniGuide has the potential to streamline the development of molecular generative models, allowing them to be readily used in diverse application scenarios.

## 1 Introduction

Diffusion models have emerged as an important class of generative models in various domains, including computer vision [1], signal processing [2], computational chemistry, and drug discovery [3, 4, 5, 6, 7, 8]. By gradually adding noise to data samples and learning the reverse process of removing noise, diffusion models effectively transform noisy samples into structured data [9, 10]. In the context of drug discovery, it is essential to effectively address downstream tasks, which often pose specific geometric conditions. Examples of this include (i) Structure-based drug design (SBDD) that aims to create small ligands that fit given receptor binding sites [11], (ii) Fragment-based drug design (FBDD) that designs molecules by elaborating known scaffolds [12, 13], or (iii) Ligand-based drug design (LBDD) which generates molecules that fit a certain shape [14]. Recent works address these tasks by either incorporating specialised models or focusing on conditions that directly resemble molecular structures. In both cases, this narrow focus restricts their adaptability to new or slightly altered settings.

We address the challenge of adaptability by introducing UniGuide, a method that unifies guidance for geometry-conditioned molecular generation, see Fig. 1. The key element for achieving this unification is the _condition map_, which transforms complex geometric conditions to match the diffusion model'sconfiguration space, thereby enabling self-guidance without the need for external models. Like other guidance-based approaches, UniGuide does not constrain the generality of the underlying model. Moreover, our method is the most versatile, extending beyond guiding molecular structures to leveraging complex geometric conditions such as volumes, surfaces, and densities, thereby enabling the unified tackling of diverse drug discovery tasks. For complex conditions specifically, previous works primarily rely on conditional diffusion models for effective condition encoding [12, 13, 14]. With our method, we are able to tackle the same tasks, while overcoming major drawbacks: UniGuide eliminates the need for additional training and, more importantly, avoids constraining the model to specific tasks.

We demonstrate the wide applicability of UniGuide by tackling a variety of geometry-constrained drug discovery tasks. With performance either on par with or superior to tailored models, we conclude that UniGuide offers advantages beyond its unification. Firstly, while the novelty of conditional models often stems from the condition incorporation, our method redirects focus to advancing unconditional generation, which directly benefits multiple applications. Furthermore, this separation of model training and conditioning allows us to tackle tasks with minimal data, a common scenario in the biological domain.

In summary, our contributions are as follows:

* We present UniGuide: A unified guidance method for generating geometry-conditoned molecular structures, requiring neither additional training nor external networks used to guide the generation.
* We demonstrate UniGuide's wide applicability by tackling various conditioning scenarios in structure-based, fragment-based, and ligand-based drug design.
* We show UniGuide's favourable performance over task-specific baselines, highlighting the practical relevance of our approach.

## 2 Related work

Diffusion models and controllable generationDiffusion models [9, 10] are generative models achieving state-of-the-art performance across various domains, including the generation of images [1, 9], text [15], or point clouds [16]. Conditional diffusion models [17, 18, 19, 20, 21] are based on the same principle but incorporate a particular condition in their training, allowing for the controlled generation. Alternatively, classifier guidance [22, 23] relies on external models for controllable generation. Prior works in this context primarily focused on global properties [24, 22], lacking the capacity to condition on the geometric conditions central to our work. For instance, Bao et al. [24] demonstrate control over molecule generation based on desired quantum properties.

_De novo_ molecule generationResearch on _de novo_ molecule generation focused extensively on generating molecules using their chemical graph representations [25, 26, 27, 28, 29, 30, 31, 32, 33, 34]. However, these methods are limited in modelling the molecules' conformation information and are, therefore, not ideally suited for several drug-discovery settings, such as target-aware drug design. Recently, attention has shifted towards generating molecules in 3D space, utilising variational autoencoders [35], autoregressive models [36, 37, 38], flow-based models [39, 40], and diffusion-based approaches [41, 42, 43, 44, 45, 46, 47, 20].

Figure 1: UniGuide handles diverse conditioning modalities for guidance, including: (i) a target receptor for SBDD, (ii) additional molecular fragments for FBDD, or (iii) a predefined 3D shape for LBDD. It combines a source condition \(\mathbf{s}\in\mathcal{S}\) and the unconditional model \(\mathbf{\epsilon}_{\theta}(\mathbf{z}_{t},t)\) within its condition map to enable self-guidance. The flexible formulation of our approach can be generalised to new geometric tasks, for example, conditioning on atomic densities.

**Conditional generation of molecules** Downstream applications of molecular generation can be categorised by their condition modality. In the case of SBDD [38; 48; 49], Schneuing et al. [11] and Guan et al. [50], for example, introduce models that simultaneously operate on protein pockets and ligands. In the conditional case, the pocket context is fixed throughout the generation. Moreover, FBDD imposes (multiple) scaffolds as a constraint [11; 12; 51; 52; 53]. Igashov et al. [13] expand given scaffolds by generating the molecule around the fixed scaffolds. In a related task of FBDD, linker design with pose estimation, as discussed in [54], further generate the rotation of the given scaffolds. SBDD and FBDD rely on the availability of high-quality data of protein pockets, which is often scarce. For this reason, LBDD aims to generate molecules that match the same 3D volume of reference ligands that are known to bind to the target of interest [55; 56]. Chen et al. [14] specifically train a shape encoder to capture the molecular shape of a reference ligand and use the resulting embedding to train a conditional diffusion model.

## 3 Controlling the generation of diffusion models

Diffusion Models [9; 57] learn a Markov Chain that involves a forward process to perturb data from a distribution \(q(\mathbf{z})\) and learn to reverse the process to generate new samples from a tractable prior, for example, a normal distribution. Given a data point sampled from the true underlying distribution, \(\mathbf{z}_{\text{data}}\sim q(\mathbf{z})\), the forward process \(q(\mathbf{z}_{t}|\mathbf{z}_{t-1})\) gradually adds Gaussian noise:

\[q(\mathbf{z}_{t}|\mathbf{z}_{t-1})=\mathcal{N}\big{(}\mathbf{z}_{t}\,\big{|} \,\sqrt{1-\beta_{t}}\mathbf{z}_{t-1},\beta_{t}\mathbf{I}\big{)}\;, \tag{1}\]

where \(\{\beta_{t}\in(0,1)\}_{t=1}^{T}\) defines a variance schedule. Defining the forward process this way, one can readily sample from \(q(\mathbf{z}_{t}\,|\,\mathbf{z}_{\text{data}})\):

\[\mathbf{z}_{t}=\sqrt{\bar{\alpha}_{t}}\mathbf{z}_{\text{data}}+\sqrt{1-\bar{ \alpha}_{t}}\mathbf{\epsilon}\;,\quad\mathbf{\epsilon}\sim\mathcal{N}(\mathbf{0},\mathbf{I})\;, \tag{2}\]

with \(\alpha_{t}=1-\beta_{t}\) and \(\bar{\alpha}_{t}=\prod_{i=1}^{t}\alpha_{i}\). Since the time-reverse process \(q(\mathbf{z}_{t-1}|\mathbf{z}_{t})\) depends on \(\mathbf{z}_{\text{data}}\), which is not available at generation time, it is approximated by modelling \(p_{\theta}(\mathbf{z}_{t-1}\,|\,\mathbf{z}_{t})\):

\[p_{\theta}(\mathbf{z}_{t-1}\,|\,\mathbf{z}_{t})=\mathcal{N}\big{(}\mathbf{z}_{ t-1}\,\big{|}\,\mathbf{\mu}_{\theta}(\mathbf{z}_{t},t),\sigma_{t}\mathbf{I}\big{)}\;, \tag{3}\]

where the mean \(\mathbf{\mu}_{\theta}\) is parameterised by a noise-predicting neural network \(\mathbf{\epsilon}_{\theta}\) in the form of:

\[\mathbf{\mu}_{\theta}(\mathbf{z}_{t},t)=\frac{1}{\sqrt{\alpha_{t}}}\Big{(}\mathbf{ z}_{t}-\frac{\beta_{t}}{\sqrt{1-\bar{\alpha}_{t}}}\mathbf{\epsilon}_{\theta}( \mathbf{z}_{t},t)\Big{)}\;. \tag{4}\]

The model \(\mathbf{\epsilon}_{\theta}\) is trained to optimise the variational lower bound through the simplified training objective:

\[\mathcal{L}_{\text{train}}=\frac{1}{2}\big{\|}\mathbf{\epsilon}-\mathbf{\epsilon}_{ \theta}(\mathbf{z}_{t},t)\big{\|}_{2}^{2}\quad. \tag{5}\]

**Self-guiding diffusion models** Using Bayes' rule, the conditional probability \(p_{\theta}(\mathbf{z}_{t}\,|\,\mathbf{c})\) given a condition \(\mathbf{c}\) can be expressed as

\[p_{\theta}(\mathbf{z}_{t}\,|\,\mathbf{c})\propto p_{\theta}(\mathbf{z}_{t})\,p_{ \theta}(\mathbf{c}\,|\,\mathbf{z}_{t})\;. \tag{6}\]

This allows us to decompose the score function as follows:

\[\nabla_{\mathbf{z}_{t}}\!\log p_{\theta}(\mathbf{z}_{t}\,|\,\mathbf{c})=\nabla_{ \mathbf{z}_{t}}\!\log p_{\theta}(\mathbf{z}_{t})+S\,\nabla_{\mathbf{z}_{t}}\!\log p _{\theta}(\mathbf{c}\,|\,\mathbf{z}_{t})\;, \tag{7}\]

where the second term is used for guiding the unconditional generation, with \(S>0\) controlling the guidance strength. Using that \(\nabla_{\mathbf{z}_{t}}\!\log p_{\theta}(\mathbf{z}_{t})=-(1-\bar{\alpha}_{t})^ {-\frac{1}{2}}\mathbf{\epsilon}_{\theta}(\mathbf{z}_{t},t)\)[22], we can rewrite the score function from Eq. (7) and identify the modified noise predictor \(\hat{\mathbf{\epsilon}}_{\theta}\):

\[\nabla_{\mathbf{z}_{t}}\!\log p_{\theta}(\mathbf{z}_{t}\,|\,\mathbf{c})=-\frac{1} {\sqrt{1-\bar{\alpha}_{t}}}\Big{[}\underbrace{\mathbf{\epsilon}_{\theta}(\mathbf{z }_{t},t)-\sqrt{1-\bar{\alpha}_{t}}S\,\nabla_{\mathbf{z}_{t}}\!\log p_{\theta}( \mathbf{c}\,|\,\mathbf{z}_{t})}_{=:\hat{\mathbf{\epsilon}}_{\theta}(\mathbf{z}_{t},t, \mathbf{c})}\Big{]} \tag{8}\]

The modified mean function \(\hat{\mathbf{\mu}}_{\theta}\) then follows from the modified version of Eq. (4), enabling us to sample from \(p_{\theta}(\mathbf{z}_{t-1}\,|\,\mathbf{z}_{t},\mathbf{c})\sim\mathcal{N}\big{(} \hat{\mathbf{\mu}}_{\theta}(\mathbf{z}_{t},t,\mathbf{c}),\sigma_{t}\mathbf{I}\big{)}\):

\[\hat{\mathbf{\mu}}_{\theta}(\mathbf{z}_{t},t,\mathbf{c})=\frac{1}{\sqrt{\alpha_{t}}} \Big{(}\mathbf{z}_{t}-\frac{\beta_{t}}{\sqrt{1-\bar{\alpha}_{t}}}\hat{\mathbf{ \epsilon}}_{\theta}(\mathbf{z}_{t},t,\mathbf{c})\Big{)}\!\!=\mathbf{\mu}_{\theta}( \mathbf{z}_{t},t)+\lambda(t)\nabla_{\mathbf{z}_{t}}\!\log p_{\theta}(\mathbf{c}\,| \,\mathbf{z}_{t})\;, \tag{9}\]where \(\lambda(t)=(\alpha_{t})^{-\frac{1}{2}}\beta_{t}\mathcal{S}\) balances the conditional update. Eq. (9) requires sampling from \(\log p_{\theta}(\mathbf{c}\,|\,\mathbf{z}_{t})\) to which we do not have access. Assuming the condition \(\mathbf{c}\) lies in the same space as \(\mathbf{z}_{t}\), we can follow Kollovieh et al. [58] and approximate \(\log p_{\theta}(\mathbf{c}\,|\,\mathbf{z}_{t})\) as a multivariate Gaussian distribution:

\[p_{\theta}(\mathbf{c}\,|\,\mathbf{z}_{t})=\mathcal{N}\big{(}\mathbf{c}\,|\,\mathbf{f}_{ \theta}(\mathbf{z}_{t},t),\mathbf{I}\big{)}\, \tag{10}\]

where \(\mathbf{f}_{\theta}(\mathbf{z}_{t},t)\) approximates the clean data point, enabling to estimate the condition in data space. Using Eq. (2), we can readily predict the clean data point given the noisy sample \(\mathbf{z}_{t}\) via

\[\mathbf{f}_{\theta}(\mathbf{z}_{t},t)=\frac{\mathbf{z}_{t}-\sqrt{1-\widetilde{ \alpha}_{t}}\,\mathbf{\epsilon}_{\theta}(\mathbf{z}_{t},t)}{\sqrt{\widetilde{ \alpha}_{t}}}\rightleftharpoons\hat{\mathbf{z}}_{0}\quad. \tag{11}\]

With this, the _guiding term_ becomes a direct differentiation of the squared error with respect to the noisy sample \(\mathbf{z}_{t}\):

\[\nabla_{\mathbf{z}_{t}}\log p_{\theta}(\mathbf{c}\,|\,\mathbf{z}_{t})=-\frac{1}{2 }\nabla_{\mathbf{z}_{t}}\big{\|}\mathbf{f}_{\theta}(\mathbf{z}_{t},t)-\mathbf{c}\big{\| }_{2}^{2}\quad. \tag{12}\]

By directly leveraging the prediction of the unconditional model \(\mathbf{\epsilon}_{\theta}\), Eq. (12) establishes our self-guiding conditioning, thereby defining the self-guided noise predictor \(\tilde{\mathbf{\epsilon}}_{\theta}\):

\[\tilde{\mathbf{\epsilon}}_{\theta}(\mathbf{z}_{t},t,\mathbf{c})=\mathbf{\epsilon}_{\theta} (\mathbf{z}_{t},t)+\frac{\sqrt{1-\widetilde{\alpha}_{t}}S}{2}\nabla_{\mathbf{z }_{t}}\big{\|}\hat{\mathbf{z}}_{0}-\mathbf{c}\big{\|}_{2}^{2}\quad. \tag{13}\]

## 4 UniGuide

To enable the application of unconditional molecular diffusion models \(\mathbf{\epsilon}_{\theta}\) to geometric downstream tasks in drug discovery, we aim to develop a unified guidance framework, UniGuide, see Fig. 1. Importantly, we seek to enable guidance from arbitrary geometric conditions \(\mathbf{s}\in\mathcal{S}\), where \(\mathcal{S}\) denotes a general space of source conditions. However, the source conditions \(\mathbf{s}\) cannot be directly used for the loss computation in Eq. (12) when they do not match the configuration space \(\mathcal{Z}\).

To address this challenge, we introduce _condition maps_\(C\), which bridge the gap between arbitrary source conditions \(\mathbf{s}\) and target conditions \(\mathbf{c}\) suitable for guidance. In Sec. 4.1, we start with its general formulation and continue to derive a condition map \(C_{\mathcal{Z}}\) for the special case where \(\mathcal{S}=\mathcal{Z}\). This will be useful when discussing the application of UniGuide to various drug discovery tasks in Sec. 4.2. We also demonstrate how to derive a task-specific condition map \(C_{\partial V}\) for ligand-based drug design.

NotationIn 3D space, the _configuration_ of molecules, including proteins, can be represented by a set of tuples \(\mathbf{z}=\{(\mathbf{x}_{i},\mathbf{h}_{i})\}_{i=1}^{\mathcal{N}}\in\mathcal{Z}\), where \(\mathbf{x}_{i}\in\mathbb{R}^{3}\) and \(\mathbf{h}_{i}\in\mathbb{R}^{d}\) refer to coordinates and features of a node \(\mathbf{z}_{i}=(\mathbf{x}_{i},\mathbf{h}_{i})\), respectively. The space of configurations is denoted by \(\mathcal{Z}\) and includes configurations of varying size \(N\). We distinguish between different configuration entities via superscripts, i.e. refer to molecules \(\mathcal{M}\) and proteins \(\mathcal{P}\) through \(\mathbf{z}^{\mathcal{M}}\) and \(\mathbf{z}^{\mathcal{P}}\), respectively. The collection of coordinates \(\mathbf{x}=\{\mathbf{x}_{1},\ldots,\mathbf{x}_{N}\}\in\mathbb{R}^{N\times 3}\in\mathcal{X}\) defines the _conformation_ of a molecule \(\mathcal{M}\) or protein \(\mathcal{P}\). We represent arbitrary geometric conditions with the variable \(\mathbf{s}\in\mathcal{S}\), and conditions that can be used for guidance with the variables \(\mathbf{c}\in\mathcal{Z}\).

### Unified self-guidance from geometric conditions \(\mathbf{s}\in\mathcal{S}\)

The concept of a condition map \(C\) is essential to our method, enabling guidance from conditions \(\mathbf{s}\in\mathcal{S}\) in a unified fashion, where \(\mathcal{S}\) represents a space of general geometric objects such as structures, densities, or surfaces. These geometric objects do not necessarily match the configuration space \(\mathcal{Z}\), i.e. \(\mathcal{S}\neq\mathcal{Z}\), preventing the computation of the guiding score function from Eq. (12). We overcome this challenge by defining \(C\) as a transformation that maps \(\mathbf{s}\) to a suitable target condition \(\mathbf{c}\in\mathcal{Z}\), which is then utilised for self-guidance.

In the most general case, \(C\) takes the form of

\[C:\mathcal{S}\times\mathcal{Z} \rightarrow \mathcal{Z} \tag{14}\] \[\mathbf{s}\times\mathbf{z} \mapsto \mathbf{c}\quad,\]

where the source condition \(\mathbf{s}\) together with a configuration \(\mathbf{z}\) are mapped to a target condition \(\mathbf{c}\in\mathcal{Z}\). Including the condition map \(C\) in the guidance, we obtain our guidance signal:\[\nabla_{\mathbf{z}_{t}}\!\log p_{\theta}(\mathbf{c}\,|\,\mathbf{z}_{t})=-\frac{1}{2} \nabla_{\mathbf{z}_{t}}\big{\|}\hat{\mathbf{z}}_{0}-C(\mathbf{s},\hat{\mathbf{z}}_{0 })\big{\|}_{2}^{2}\!\!=-\nabla_{\mathbf{z}_{t}}\mathcal{L}(\hat{\mathbf{z}}_{0 },\mathbf{s})\quad, \tag{15}\]

where \(\hat{\mathbf{z}}_{0}=\mathbf{f}_{\theta}(\mathbf{z}_{t},t)\) is the estimate of \(\mathbf{z}_{0}\) given the unconditional model \(\mathbf{\epsilon}_{\theta}(\mathbf{z}_{t},t)\) obtained according to Eq. (11) and \(\mathbf{c}=C(\mathbf{s},\hat{\mathbf{z}}_{0})\) is the target condition produced by the condition map. In this formulation, \(\mathbf{c}\) can also be understood as _guidance target_ of the unconditional model.

It is important to highlight that Eq. (15) should not destroy the underlying properties of the unconditional generative process. In particular, if the unconditional model \(\mathbf{\epsilon}_{\theta}\) is equivariant to a set of transformations \(G\), e.g. rotations and translations, as is common in the molecular domain, we want to retain equivariance also in the guidance signal. Hence, the self-guided model \(\hat{\mathbf{\epsilon}}_{\theta}\) should satisfy

\[\hat{\mathbf{\epsilon}}_{\theta}\big{(}G(\mathbf{z}_{t}),t,\mathbf{c}\big{)}=G\big{(} \hat{\mathbf{\epsilon}}_{\theta}(\mathbf{z}_{t},t,\mathbf{c})\big{)}\,, \tag{16}\]

for all transformations \(G\) to which \(\mathbf{\epsilon}_{\theta}\) is equivariant.

**Theorem 4.1**.: _Consider a function \(C:\mathcal{S}\times\mathcal{Z}\rightarrow\mathcal{Z}\). If \(C(\mathbf{s},\mathbf{z})\) is invariant to rigid transformations \(G\) in the first argument and equivariant in the second argument, then the gradient \(\nabla_{\mathbf{z}}\|\mathbf{v}\|_{2}^{2}\) of the vector \(\mathbf{v}=\mathbf{z}-C(\mathbf{s},\mathbf{z})\) is equivariant to transformations of \(\mathbf{z}\)._

Proof.: We prove Theorem 4.1 in App. B. 

Using Theorem 4.1, we can guarantee equivariant guidance signals if the condition maps \(C(\mathbf{s},\mathbf{z})\) are invariant and equivariant under rigid transformations concerning the source condition \(\mathbf{s}\) and configuration \(\mathbf{z}\), respectively.

Guidance in the special case of \(\mathcal{S}=\mathcal{Z}\)In the case where the source condition \(\mathbf{s}\) directly defines subset \(\mathcal{A}\) of \(m<N\) nodes of the configuration, i.e. \(\mathcal{S}=\mathcal{Z}\), we can fully specify the condition map. This is feasible because the condition map no longer needs to bridge different spaces; it only needs to ensure equivariance, as the loss computation between \(\mathbf{s}\) and the configuration is already possible. To distinguish this special case from the general setting, we denote \(\mathbf{s}=\tilde{\mathbf{z}}\in\mathbb{R}^{m\times(3+d)}\) and refer to the defined subset within the configuration \(\hat{\mathbf{z}}_{0}\) by \(\hat{\mathbf{z}}_{0}^{\mathcal{A}}\).

In order to satisfy the requirements on \(C\big{(}\tilde{\mathbf{z}},\hat{\mathbf{z}}_{0}^{\mathcal{A}}\big{)}\) as stated by Theorem 4.1, we align \(\tilde{\mathbf{z}}\) with \(\hat{\mathbf{z}}_{0}^{\mathcal{A}}\) by using the Kabsch algorithm [59; 60]. Denoting the resulting transformation with \(T_{\hat{\mathbf{z}}_{0}^{\mathcal{A}}}\), we get an \(\hat{\mathbf{z}}_{0}\)-equivariant condition map:

\[\begin{array}{rll}C_{\mathcal{Z}}\!:&\mathbb{R}^{m\times(3+d)}\times\mathbb{ R}^{m\times(3+d)}&\rightarrow&\mathbb{R}^{m\times(3+d)}\\ &\tilde{\mathbf{z}}\,\times\,\hat{\mathbf{z}}_{0}^{\mathcal{A}}&\mapsto&T_{ \hat{\mathbf{z}}_{0}^{\mathcal{A}}}\tilde{\mathbf{z}}\quad.\end{array} \tag{17}\]

Taken together, we can compute the guidance signal based on the following loss \(\mathcal{L}\):

\[\mathcal{L}\big{(}\tilde{\mathbf{z}}_{0}^{\mathcal{A}},\tilde{\mathbf{z}} \big{)}=\frac{1}{2}\big{\|}\hat{\mathbf{z}}_{0}^{\mathcal{A}}-T_{\hat{\mathbf{ z}}_{0}^{\mathcal{A}}}\tilde{\mathbf{z}}\big{\|}_{2}^{2}\quad. \tag{18}\]

We emphasise that although the loss \(\mathcal{L}\big{(}\tilde{\mathbf{z}}_{0}^{\mathcal{A}},\tilde{\mathbf{z}} \big{)}\) is computed on the subset \(\mathcal{A}\), the gradient, as presented in Eq. (15), is still computed with respect the full configuration \(\mathbf{z}_{t}\).

In summary, our method requires only an unconditionally trained model \(\mathbf{\epsilon}_{\theta}\) and a suitable condition map \(C\), eliminating the need for additional networks or training. Together, this facilitates unified self-guidance from arbitrary geometric sources. Importantly, the separation of model training and conditioning enables us to tackle tasks even with minimal data, which is crucial in practical scenarios. In the following section, we discuss the wide applicability of UniGuide by illustrating its application to multiple drug discovery tasks.

### UniGuide for drug discovery

Having introduced both the guidance framework and the condition map, we will continue to discuss how to tackle a set of drug discovery tasks within the UniGuide framework. We start with its application to ligand-based drug design (LBDD), which aims to generate a ligand that satisfies a predefined molecular shape.

Ligand-based drug designLBDD aims to generate novel ligands with a similar 3D shape as a reference ligand \(\mathcal{M}_{\text{ref}}\). In this setting, one operates on the molecule level only since the protein information is assumed to be unknown. However, to still generate active ligands that bind to a protein pocket, one leverages the 3D shape information of a reference molecule. Specifically, the goal is to modify the generative process \(\hat{\mathbf{\epsilon}}_{\theta}\) to generate a ligand \(\mathbf{z}_{0}\) with a similar 3D shape but different molecular structure than \(\mathcal{M}_{\text{ref}}\). With Sec. 4.1 introducing all required concepts, we can readily formulate a _surface condition map_\(C_{\partial V}\) suitable to tackle the task of LBDD, see Fig. 2:

To represent \(\mathcal{M}_{\text{ref}}\)'s 3D shape, we identify our source condition \(\mathbf{s}\) with a set of \(K\) points \(\mathbf{y}\) sampled uniformly from the reference ligand's surface \(\partial V\), \(\mathbf{y}\in\mathbb{R}^{K\times 3}=\mathcal{S}\). As no features are guided, we formulate \(C_{\partial V}\) with respect to the conformation space \(\mathcal{X}=\mathbb{R}^{N\times 3}\):

\[\begin{split} C_{\partial V}:\mathbb{R}^{K\times 3}\times \mathbb{R}^{N\times 3}&\rightarrow\mathbb{R}^{N\times 3}\\ \mathbf{y}\times\hat{\mathbf{x}}_{0}&\mapsto\mathbf{c }_{\mathbf{x}}\quad,\end{split} \tag{19}\]

where \(\hat{\mathbf{x}}_{0}\) denotes the conformation of the clean data point estimation \(\hat{\mathbf{z}}_{0}\) as computed by Eq. (11). To satisfy Theorem 4.1, \(C_{\partial V}\) first aligns \(\mathbf{y}\) with \(\hat{\mathbf{x}}_{0}\) by a rotation \(R_{\hat{\mathbf{x}}_{0}}\in\mathbb{R}^{3\times 3}\) resulting from the ICP algorithm [61]. For every atom coordinate \(\hat{\mathbf{x}}_{i}\), \(C_{\partial V}\) subsequently computes the mean \(\bar{\mathbf{y}}_{i}\) over \(\hat{\mathbf{x}}_{i}\)'s \(k\) closest surface points:

\[\bar{\mathbf{y}}_{i}=\frac{1}{k}\sum_{j\in\mathcal{N}_{\hat{\mathbf{x}}_{0}}}R_{ \hat{\mathbf{x}}_{0}}\mathbf{y}_{j}\quad\text{, with }\quad\mathcal{N}_{\hat{\mathbf{x}}_{i}} =\arg\min_{I\subset\{1,\dots,K\},|I|=k}\sum_{j\in I}\left\|R_{\hat{ \mathbf{x}}_{0}}\mathbf{y}_{j}-\hat{\mathbf{x}}_{i}\right\|_{2}\quad. \tag{20}\]

Finally, the individual components \(\mathbf{c}_{\mathbf{x},i}\) of the target condition compute as follows:

\[\mathbf{c}_{\mathbf{x},i}=\begin{cases}\bar{\mathbf{y}}_{i}+\frac{\alpha}{d}(\bar{\bm {y}}_{i}-\hat{\mathbf{x}}_{i})\;,&\text{if }\hat{\mathbf{x}}_{i}\text{ outside }V\\ \bar{\mathbf{y}}_{i}-\frac{\alpha}{d}(\bar{\mathbf{y}}_{i}-\hat{\mathbf{x}}_{i})\;,&\text{ if }\hat{\mathbf{x}}_{i}\text{ inside }V\wedge d<\alpha\\ \hat{\mathbf{x}}_{i}\;,&\text{otherwise}\;,\end{cases} \tag{21}\]

where \(d\) denotes the distance to the surface, \(d=\|\bar{\mathbf{y}}_{i}-\hat{\mathbf{x}}_{i}\|_{2}\), and \(\alpha\) the required distance to the surface. Note that the target condition \(\mathbf{c}_{\mathbf{x}}\) represents a valid conformation inside the surface \(\partial V\), and that \(C_{\partial V}\) effectively bridges spaces from \(\mathcal{S}\) to \(\mathcal{X}\). Consequently, when using \(C_{\partial V}\), the guidance signal is derived from Eq. (15) with the loss function \(\mathcal{L}(\bar{\mathbf{z}}_{0},\mathbf{y})\). The full algorithm for guidance using \(C_{\partial V}\) is presented in App. D.1.

Structure-based drug designThe goal of SBDD is to design a ligand that binds to a target protein pocket \(\mathbf{s}\). In this setting, one operates on both the molecule and protein level. Technically, we are interested in generating a ligand \(\mathbf{z}_{0}^{\mathcal{M}}\) conditioned on the protein configuration \(\bar{\mathbf{z}}^{\mathcal{P}}\). With the unconditional diffusion model \(\mathbf{\epsilon}_{\theta}(\mathbf{z}_{t},t)\), \(\mathbf{z}_{t}=(\mathbf{z}_{t}^{\mathcal{M}},\mathbf{z}_{t}^{\mathcal{P}})\), approximating the joint distribution of ligand-protein pairs \(p(\mathbf{z}_{\text{data}}^{\mathcal{M}},\mathbf{z}_{\text{data}}^{\mathcal{P}})\), one can readily see that the source condition directly corresponds to the configuration of the protein pocket. Hence, we can use \(C_{\mathcal{Z}}\) from Sec. 4.1 and identify \(\bar{\mathbf{z}}\) with \(\bar{\mathbf{z}}^{\mathcal{P}}\). The guidance signal then follows from the loss \(\mathcal{L}(\bar{\mathbf{z}}_{0}^{\mathcal{P}},\bar{\mathbf{z}}^{\mathcal{P}})\) with \(\mathbf{c}^{\mathcal{P}}=C_{\mathcal{Z}}(\bar{\mathbf{z}}^{\mathcal{P}},\bar{ \mathbf{z}}_{0}^{\mathcal{P}\cup\mathcal{F}})\) as defined in Eq. (18). We describe the sampling algorithm for the SBDD task in App. E.1.

Fragment-based drug designFBDD aims to design a ligand by optimising a molecule around fragments \(\mathcal{F}\) that bind weakly to a receptor. Similarly to SBDD, one operates on both the molecule and protein level. Technically, we are interested in generating a ligand \(\mathbf{z}_{0}^{\mathcal{M}}\) conditioned on both the protein and the fragment configuration, \(\bar{\mathbf{z}}^{\mathcal{P}}\) and \(\bar{\mathbf{z}}^{\mathcal{F}}\), respectively. Considering the same kind of unconditional model \(\mathbf{\epsilon}_{\theta}(\mathbf{z}_{t},t)\) as in SBDD, we can use \(C_{\mathcal{Z}}\) from Sec. 4.1. Only now, we identify \(\bar{\mathbf{z}}\) with both \(\bar{\mathbf{z}}^{\mathcal{P}}\) and \(\bar{\mathbf{z}}^{\mathcal{F}}\) and write \(\bar{\mathbf{z}}^{\mathcal{A}}\) with \(\mathcal{A}=\mathcal{P}\cup\mathcal{F}\). Using Eq. (18), the guidance signal directly follows from \(\mathcal{L}(\bar{\mathbf{z}}_{0}^{\mathcal{A}},\bar{\mathbf{z}}^{\mathcal{P} \cup\mathcal{F}})\) with \(\mathbf{c}^{\mathcal{P}}=C_{\mathcal{Z}}(\bar{\mathbf{z}}^{\mathcal{P}\cup \mathcal{F}},\bar{\mathbf{z}}_{0}^{\mathcal{P}\cup\mathcal{F}})\). The sampling algorithm is similar to the one described in App. E.1.

Several tasks exist within the FBDD setting [62, 63, 64, 65]. Examples are scaffold hopping [64], where the core structure of \(\mathbf{z}_{0}^{\mathcal{M}}\) has to be generated, but functional groups that interact with the receptor are

Figure 2: Surface condition map \(C_{\partial V}\): For each atom coordinate \(\mathbf{x}_{i}\), the closest surface points \(\mathbf{y}_{j}\) are computed. The target condition \(\mathbf{c}_{\mathbf{x},i}\) is the projection along the mean of neighbours \(\bar{\mathbf{y}}_{i}\) to the inside of the volume by a margin \(\alpha\), where \(d=\|\bar{\mathbf{y}}_{i}-\hat{\mathbf{x}}_{i}\|_{2}\).

fixed, or linker design [65], where the connection between separated fragments has to be optimised through the generative process, see Fig. 5. Note that these tasks differ primarily in their application and can be treated identically from a technical perspective within UniGuide. In addition, one can also consider variations where the protein information \(\tilde{\mathbf{z}}^{\mathcal{P}}\) is discarded. This usually aligns with switching to an unconditional model \(\mathbf{\epsilon}_{\theta}\) that solely models the distribution over molecules. We present results for this configuration in Sec. 5.3.

Furthermore, we would like to highlight that it is possible to combine guidance strategies within UniGuide. For example, one could incorporate a version of the surface condition map \(C_{\partial V}\) for FBDD to provide an additional geometric guidance signal for the atoms not included in \(\mathcal{F}\).

LimitationsDrug discovery also involves tasks beyond purely geometric conditions, encompassing global graph properties [24]. These are excluded from the UniGuide framework. Additionally, UniGuide requires the unconditional model to be trained on a matching configuration space. We discuss the broader impact of our work in App. A.

## 5 Results

In this section, we compare UniGuide to state-of-the-art models across various drug discovery tasks. To highlight the wide range of tasks to which unconditional models can be adapted through UniGuide, we conduct experiments on ligand-based (Sec. 5.1), structure-based (Sec. 5.2) and fragment-based (Sec. 5.3) drug design. We demonstrate that UniGuide performs competitively or even surpasses specialised baseline models, underscoring its practical relevance and transferability to diverse drug discovery scenarios.

### Ligand-based drug design

DatasetFollowing Chen et al. [14], we employ the MOSES dataset for the ligand-based drug design task [66]. We evaluate on a test set consisting of \(1000\) reference ligands, from which the 3D shape conditions are extracted. For every shape condition \(\mathcal{M}_{\text{ref}}\), \(50\) samples are generated. We refer to App. D.1 for further details on the evaluation setup.

BaselinesFor the LBDD task, we compare UniGuide to ShapeMol, a conditional diffusion model that is trained by conditioning on learned latent embeddings of the molecular surfaces [14]. Chen et al. [14] also propose a correction technique that adjusts the atom positions based on their distance to the reference ligand's nodes, which is refered to as ShapeMol+g. Additionally, we include as baselines Virtual Screening (VS) [14], a shape-based virtual screening tool, and SQUID [55], a variational autoencoder that decodes molecules by sequentially attaching fragments with fixed bond lengths and angles. For this task, we evaluate UniGuide equipped with the surface condition map \(C_{\partial V}\) from Eq. (21) in conjunction with two _unconditionally trained_ diffusion models, ShapeMol [U] and EDM [14; 20] as well as the _conditional_ model ShapeMol [14]. The "only shape" column in Tab. 1 indicates whether a method uses solely the reference ligand's shape or also incorporates its atom positions.

We compare UniGuide with an alternative guidance approach adapted from Guan et al. [67] in App. D.4 and refer to App. C and App. D.3 for further information on the unconditional models and the guidance parameters, respectively. In addition, inspired by the performance of UniGuide on the

LBDD task, we further motivate its applicability for the generation of molecules given atom densities, see App. G.

EvaluationThe goal of LBDD is to discover novel molecules that fit within a given 3D shape. This can be quantified by a high 3D shape similarity and low graph similarity compared to the reference ligand, as illustrated in Fig. 3 as well as App. D.2. We highlight this trade-off by reporting the ratio of these similarities in Tab. 1 as \(\text{Sim}_{S}/\text{Sim}_{G}\), which constitutes the most important metric for this task. We follow Chen et al. [14] and further evaluate the mean and maximum shape similarities \(\text{Sim}_{S}\) and \(\max\text{Sim}_{S}\), respectively, per reference ligand, measured via the volume overlap between the two aligned molecules. Additionally, we report the graph similarity \(\text{Sim}_{G}\) defined as the Tanimoto similarity between the generated and reference ligand, and the graph similarity \(\max\text{Sim}_{G}\) of the generated molecule with the maximum shape similarity. Further metrics concerning the quality of the generated ligands are provided in App. D.2.

Both in terms of shape similarity and graph similarity, guiding the generation of EDM with UniGuide outperforms other task-specific conditioning mechanisms and even the Virtual Screening baseline. Emphasised by the Ratio metric across all evaluated methods, UniGuide demonstrates that it is able to generate diverse molecules with very similar shapes compared to the reference ligand. Remarkably, UniGuide achieves higher shape similarity than ShapeMol+g, even though the conditional model is explicitly guided towards the position of the reference ligand through the position correction technique. UniGuide, on the other hand, does not require information about the reference's atom positions at all to generate novel, high-quality ligands. This highlights how UniGuide and the design of condition maps enables unconditional models like EDM, that have not been tailored or trained for the LBDD task, to achieve state-of-the-art performance on new tasks.

### Structure-based drug design

DatasetsFollowing Schneuing et al. [11], we evaluate UniGuide on two protein-ligand datasets: the CrossDocked dataset [68] and the Binding MOAD dataset [69]. For the CrossDocked dataset, we follow the preprocessing as described by [38] and conduct the evaluation on \(100\) test protein pockets.

\begin{table}
\begin{tabular}{l l l l l l l l} \hline \hline  & & Method & Vina Score (↓) & Vina Min (↓) & Vina Dock (↓) & QED (↑) & SA (↑) \\ \hline \multirow{6}{*}{**Dataset**} & \multirow{3}{*}{**Dataset**} & \multirow{3}{*}{**Dataset**} & Test Set & \(-6.362\pm 3.14\) & \(-6.707\pm 2.50\) & \(-7.450\pm 2.33\) & 0.48 & 0.73 \\ \cline{3-8}  & & & 3D-SBDD* [38] & \(-5.754\pm 3.25\) & \(-6.180\pm 2.42\) & \(-6.746\pm 4.02\) & 0.51 & 0.63 \\  & & & Pocket2Mol* [48] & \(-5.139\pm 3.17\) & \(-6.415\pm 2.93\) & \(-7.152\pm 4.90\) & 0.56 & 0.74 \\ \cline{3-8}  & & \multirow{3}{*}{**Dataset**} & DecompDiff* (No Drift) [67] & \(-4.750\pm-+-\) & \(-6.170\pm-\) & \(-\) & \(-\) & \(-\) \\ \cline{3-8}  & & & TargetDiff* [50] & \(-5.466\pm 3.32\) & \(-6.643\pm 4.94\) & \(-7.802\pm 3.62\) & 0.48 & 0.58 \\ \cline{3-8}  & & & **IntFSBDD**-cond [11] & \(-3.684\pm 11.3\) & \(-4.670\pm 6.06\) & \(-6.941\pm 4.33\) & 0.47 & 0.58 \\  & & & DiffSBDD [11] & \(-4.097\pm 11.3\) & \(-6.306\pm 5.00\) & \(-7.889\pm 2.61\) & **0.57** & **0.64** \\  & & **UniGuide** & \(\boldsymbol{-5.103\pm 8.39}\) & \(\boldsymbol{-6.610\pm 4.20}\) & \(\boldsymbol{-7.921\pm 2.43}\) & **0.57** & **0.64** \\ \hline \hline \multirow{6}{*}{**Dataset**} & \multirow{3}{*}{**Dataset**} & Test Set & \(-6.748\pm 2.77\) & \(-7.563\pm 2.53\) & \(-8.297\pm 2.03\) & 0.60 & 0.64 \\ \cline{3-8}  & & & DiffSBDD-cond [11] & \(-4.466\pm 2.63\) & \(-6.309\pm 2.52\) & \(-7.482\pm 1.84\) & 0.43 & 0.56 \\ \cline{1-1}  & & & DiffSBDD [11] & \(-4.744\pm 7.70\) & \(-6.586\pm 2.59\) & \(-7.767\pm 2.06\) & 0.55 & **0.62** \\ \cline{1-1}  & & **UniGuide** & \(\boldsymbol{-5.074\pm 6.75}\) & \(\boldsymbol{-6.622\pm 2.57}\) & \(\boldsymbol{-7.911\pm 1.97}\) & **0.56** & 0.61 \\ \hline \hline \end{tabular}
\end{table}
Table 2: Structure-Based Drug Design. Quantitative comparison of generated ligands for target pockets from the CrossDocked and Binding MOAD test sets. Results taken from the respective works are indicated with \((^{*})\). We highlight the best conditioning approach for the DiffSBDD backbone in **bold** and underline the best approach over all methods.

Figure 3: Examples of the two shape-conditioned ligands generated by UniGuide. The goal is to have _low_ molecular graph similarity and _high_ shape similarity. The parameter values are computed using the same similarity. Further metrics concerning the quality of the generated ligands are provided in App. D.2.

The Binding MOAD dataset is preprocessed as discussed in Schneuing et al. [11], resulting in \(130\) test proteins. Per target pocket, \(100\) ligands are generated. We evaluate the generation of ligands on models that are trained on the full-atom context of the pockets in Tab. 2 and results of models trained on the \(C_{\alpha}\) representation of the pockets are provided in App. E.5.

BaselinesWe compare UniGuide to two autoregressive models designed for the SBDD task: 3D-SBDD [38] and Pocket2Mol [48]. We further include TargetDiff [50] and DecompDiff [67], conditional diffusion models for SBDD that fix the protein pocket context during every step of the diffusion process. We exclude approaches with explicit drift terms like Guan et al. [67] and Huang et al. [70] from the comparison, as UniGuide's SBDD condition map does not include drift terms currently, but can be readily extended to do so. Schneuing et al. [11] present two techniques for controlled structure-based generation: (i) DiffSBDD-cond, a conditional diffusion model similar to [50] and (ii) DiffSBDD, an inpainting-inspired technique that modifies the generative process of an unconditional diffusion model that jointly generates protein-ligand pairs. Across datasets, both UniGuide and DiffSBDD control the same unconditional ligand-protein diffusion model. We provide more information and further evaluation regarding this base model in App. E.2 and App. E.3 and investigate the influence of the guidance scale \(S\) as well as the resampling trick [71], a technique that modifies the generative process to better harmonise the generated ligand with the controlled pockets, in App. E.4 and App. E.5.

EvaluationAs the task of SBDD is to generate ligands that bind well to a given protein pocket, we assess generated ligands based on affinity-related metrics (Vina Score, Vina Min and Vina Dock), which estimate the binding affinity between the generated ligands and a given test receptor [72]. Additionally, we measure the quality of the generated ligands using two chemical properties: the drug-likeness (QED) and the synthetic accessibility (SA) [66, 73].

Tab. 2 demonstrates that, without additional training or external networks, UniGuide performs competitively with even the highly specialised conditional models like TargetDiff and DecompDiff. Our results indicate that not fully converging to the target protein pocket due to soft guidance, compared to, for example, DiffSBDD's inpainting-inspired technique, is not a limitation in practice. Rather, it suggests that utilising self-guidance in combination with a suitable condition map generates well-harmonised ligand-protein pairs. This is also reflected in the properties of the generated ligands, where UniGuide achieves good drug-likeness (QED) and synthetic accessibility (SA) scores. We provide additional qualitative examples for the SBDD task in Fig. 4, which showcase that UniGuide not only generates drug-like ligands but is even able to improve over the VINA Dock metric of the reference ligand.

### Fragment-based drug design

Datasets & BaselinesIn the following, we investigate linker design, a subfield of fragment-based drug design. We follow Igashov et al. [13] and decompose ligands from the ZINC dataset [74] with the MMPA algorithm [75]. Note that the ZINC dataset does not contain pocket information, and the evaluated approaches operate solely at the molecular level. We compare UniGuide to DiffLinker [13], a diffusion-based conditional model that fixes fragments in space. Additionally, we evaluate

Figure 4: Qualitative example of a test protein pocket (6c0b) from the Binding MOAD dataset. We show the reference ligand (grey) and samples generated by UniGuide (blue).

\begin{table}
\begin{tabular}{l l l l l l l l l l} \hline \hline  & Method & QED (\(\tau\)) & SA (\(\downarrow\)) & No. Rings (\(\uparrow\)) & Valid (\(\uparrow\)) & Unique (\(\uparrow\)) & 2D Filters (\(\uparrow\)) & Recovery (\(\tau\)) \\ \hline \multirow{4}{*}{Non-diffusion} & DeLinder+ConVAE+MMFF [53]-diffusion & 0.64 ± 0.16 & 3.11 ± 0.68 & 0.21 ± 0.42 & 98.3 & 44.2 & 84.8 & 80.2 \\  & 3DLinker [52]- & 0.65 ± 0.16 & 3.14 ± 0.68 & 0.24 ± 0.43 & 71.5 & 29.2 & 83.7 & 93.5 \\  & 3DLinker (given anchors) [52]- & 0.65 ± 0.16 & 3.11 ± 0.67 & 0.23 ± 0.42 & 99.3 & 29.0 & 84.2 & 94.0 \\ \hline \multirow{4}{*}{Diffusion-based} & DiffLinker [137]+ & 0.65 ± 0.13 & 3.19 ± 0.77 & 0.32 ± 0.54 & 90.6 & 51.4 & 87.9 & 70.7 \\  & DiffLinker (given anchors) [13]- & 0.65 ± 0.15 & 3.24 ± 0.61 & 0.36 ± 0.59 & 94.8 & 50.9 & 84.7 & 77.5 \\ \cline{1-1} \cline{2-11}  & UniGuide (EDM) & 0.64 ± 0.16 & 3.63 ± 1.08 & 0.49 ± 0.62 & 89.1 & 22.1 & 87.9 & 58.8 \\ \hline \hline \end{tabular}
\end{table}
Table 3: Linker Design. Results taken from Igashov et al. [13] are indicated with (\({}^{*}\)). We underline the best method overall.

the variational autoencoder-based methods DeLinker [53] and 3DLinker [52], adapted as described in Igashov et al. [13]. We provide more information on the experimental setup as well as the unconditionally trained EDM model in App. F.1 and App. C.

EvaluationFollowing Igashov et al. [13], we evaluate the generated linkers and ligands with respect to their properties (SA, QED, Number of Rings and 2D Filters). We additionally measure (i) the uniqueness of the generated samples, (ii) the recovery of the reference ligands, and (iii) the validity, which combines the chemical validity and the successful linking of the fragments.

Using UniGuide to control the EDM generation enables the successful combination of the condition fragments and the generation of diverse linkers. Even compared to task-specific models, UniGuide is able to perform competitively across different metrics. Importantly, UniGuide enables the same unconditional model (EDM) to tackle both the linker design task as presented in Tab. 3 as well as the LBDD task as presented in Tab. 1 without additional training. Note that, while DiffLinker is specifically designed to generate linkers, UniGuide readily generalises to other tasks within the FBDD setting, such as fragment growing and scaffolding, see Fig. 5. Additionally, UniGuide is agnostic to the fragmentation procedure used to obtain the condition scaffolds, meaning that UniGuide will generalise to unseen fragments as long as the underlying molecule fits within the training distribution. In App. F.2, we demonstrate how the same unconditional model can be adapted for these tasks. Our quantitative evaluation highlights the benefits achieved through the unification of controlled generation provided by UniGuide.

## 6 Conclusion

In this work, we present UniGuide, a unified way of controlling the generation of molecular diffusion models towards geometric constraints. UniGuide generalises to a multitude of drug discovery tasks without the need for conditioning networks or specialised training protocols, enabling UniGuide to find applicability also in scenarios where little data is available. By demonstrating that specialisation is not a necessity and that a more flexible, unified method outperforms specialised approaches across tasks and datasets, we open up new avenues for streamlined and flexible generative models with wide-ranging applications.

AcknowledgementsSA, LH, and JS are thankful for valuable feedback from Marcel Kollovieh, Leo Schwinn, and Alessandro Palma from the DAML group and Theis Lab. SA is supported by the DAAD programme Konrad Zuse Schools of Excellence in Artificial Intelligence, sponsored by the Federal Ministry of Education and Research. LH is supported by the Helmholtz Association under the joint research school "Munich School for Data Science - MUDS". FJT acknowledges support from the Helmholtz Association's Initiative and Networking Fund through Helmholtz AI (ZT-1-PF-5-01). FJT further acknowledges support by the BMBF (01IS18053A). In addition, FJT consults for Immunai Inc., Singularity Bio B.V., CytoReason Ltd, and Omniscope Ltd and has an ownership interest in Dermagnostix GmbH and Cellarity.

Figure 5: For various pocket-conditioned FBDD tasks, we show reference ligands (grey), desired fragments (magenta), and ligands generated by UniGuide (blue).

## References

* [1] Robin Rombach, Andreas Blattmann, Dominik Lorenz, Patrick Esser, and Bjorn Ommer. High-resolution image synthesis with latent diffusion models. In _Proceedings of the IEEE/CVF conference on computer vision and pattern recognition_, pages 10684-10695, 2022.
* [2] Nanxin Chen, Yu Zhang, Heiga Zen, Ron J Weiss, Mohammad Norouzi, and William Chan. Wavegrad: Estimating gradients for waveform generation. _arXiv preprint arXiv:2009.00713_, 2020.
* [3] N Anand and T Achim. Protein structure and sequence generation with equivariant denoising diffusion probabilistic models. arXiv, 2022. doi: 10.48550. _arXiv preprint arXiv:2205.15019_.
* [4] Brian L. Trippe, Jason Yim, Doug Tischer, David Baker, Tamara Broderick, Regina Barzilay, and Tommi Jaakkola. Diffusion probabilistic modeling of protein backbones in 3D for the motif-scaffolding problem, March 2023. URL [http://arxiv.org/abs/2206.04119](http://arxiv.org/abs/2206.04119). arXiv:2206.04119 [cs, q-bio, stat].
* [5] Joseph L Watson, David Juergens, Nathaniel R Bennett, Brian L Trippe, Jason Yim, Helen E Eisenach, Woody Ahern, Andrew J Borst, Robert J Ragotte, Lukas F Milles, and others. De novo design of protein structure and function with RFdiffusion. _Nature_, 620(7976):1089-1100, 2023. Publisher: Nature Publishing Group UK London.
* [6] Gabriele Corso, Bowen Jing, Regina Barzilay, Tommi Jaakkola, and others. DiffDock: Diffusion steps, twists, and turns for molecular docking. In _International conference on learning representations (ICLR 2023)_, 2023.
* [7] Yuanqi Du, Tianfan Fu, Jimeng Sun, and Shengchao Liu. MolGenSurvey: A Systematic Survey in Machine Learning Models for Molecule Design. Technical Report arXiv:2203.14500, arXiv, March 2022. URL [http://arxiv.org/abs/2203.14500](http://arxiv.org/abs/2203.14500). arXiv:2203.14500 [cs, q-bio] type: article.
* [8] Leon Hetzel, Simon Bohm, Niki Kilbertus, Stephan Gunnemann, Mohammad Lotfollahi, and Fabian Theis. Predicting single-cell perturbation responses for unseen drugs. Technical report, ICLR2022 Machine Learning for Drug Discovery, April 2022. arXiv:2204.13545 [cs, q-bio, stat] type: article.
* [9] Jonathan Ho, Ajay Jain, and Pieter Abbeel. Denoising diffusion probabilistic models. _Advances in neural information processing systems_, 33:6840-6851, 2020.
* [10] Yang Song, Jascha Sohl-Dickstein, Diederik P Kingma, Abhishek Kumar, Stefano Ermon, and Ben Poole. Score-based generative modeling through stochastic differential equations. _arXiv preprint arXiv:2011.13456_, 2020.
* [11] Arne Schneuing, Yuanqi Du, Charles Harris, Arian Jamasb, Ilia Igashov, Weitao Du, Tom Blundell, Pietro Lio, Carla Gomes, Max Welling, Michael Bronstein, and Bruno Correia. Structure-based Drug Design with Equivariant Diffusion Models, June 2023. URL [http://arxiv.org/abs/2210.13695](http://arxiv.org/abs/2210.13695). arXiv:2210.13695 [cs, q-bio].
* [12] Jos Torge, Charles Harris, Simon V Mathis, and Pietro Lio. Diffhopp: A graph diffusion model for novel drug design via scaffold hopping. _arXiv preprint arXiv:2308.07416_, 2023.
* [13] Ilia Igashov, Hannes Stark, Clement Vignac, Victor Garcia Satorras, Pascal Frossard, Max Welling, Michael Bronstein, and Bruno Correia. Equivariant 3D-Conditional Diffusion Models for Molecular Linker Design, October 2022. URL [http://arxiv.org/abs/2210.05274](http://arxiv.org/abs/2210.05274). arXiv:2210.05274 [cs, q-bio].
* [14] Ziqi Chen, Bo Peng, Srinivasan Parthasarathy, and Xia Ning. Shape-conditioned 3D molecule generation via equivariant diffusion models. _arXiv preprint arXiv:2308.11890_, 2023.
* [15] Xiang Li, John Thickstun, Ishaan Gulrajani, Percy S Liang, and Tatsunori B Hashimoto. Diffusion-lm improves controllable text generation. _Advances in Neural Information Processing Systems_, 35:4328-4343, 2022.

* [16] Xiaohui Zeng, Arash Vahdat, Francis Williams, Zan Gojcic, Or Litany, Sanja Fidler, and Karsten Kreis. LION: Latent point diffusion models for 3D shape generation. _arXiv preprint arXiv:2210.06978_, 2022.
* [17] Jonathan Ho and Tim Salimans. Classifier-free diffusion guidance. _arXiv preprint arXiv:2207.12598_, 2022.
* [18] Alex Nichol, Prafulla Dhariwal, Aditya Ramesh, Pranav Shyam, Pamela Mishkin, Bob McGrew, Ilya Sutskever, and Mark Chen. Glide: Towards photorealistic image generation and editing with text-guided diffusion models. _arXiv preprint arXiv:2112.10741_, 2021.
* [19] Weilun Wang, Jianmin Bao, Wengang Zhou, Dongdong Chen, Dong Chen, Lu Yuan, and Houqiang Li. Semantic image synthesis via diffusion models. _arXiv preprint arXiv:2207.00050_, 2022.
* [20] Emiel Hoogeboom, Victor Garcia Satorras, Clement Vignac, and Max Welling. Equivariant Diffusion for Molecule Generation in 3D, June 2022. URL [http://arxiv.org/abs/2203.17003](http://arxiv.org/abs/2203.17003). arXiv:2203.17003 [cs, q-bio, stat].
* [21] Omri Avrahami, Dani Lischinski, and Ohad Fried. Blended diffusion for text-driven editing of natural images. In _Proceedings of the IEEE/CVF conference on computer vision and pattern recognition_, pages 18208-18218, 2022.
* [22] Prafulla Dhariwal and Alexander Nichol. Diffusion models beat gans on image synthesis. _Advances in neural information processing systems_, 34:8780-8794, 2021.
* [23] Arpit Bansal, Hong-Min Chu, Avi Schwarzschild, Soumyadip Sengupta, Micah Goldblum, Jonas Geiping, and Tom Goldstein. Universal guidance for diffusion models. In _Proceedings of the IEEE/CVF conference on computer vision and pattern recognition_, pages 843-852, 2023.
* [24] Fan Bao, Min Zhao, Zhongkai Hao, Peiyao Li, Chongxuan Li, and Jun Zhu. Equivariant Energy-Guided SDE for Inverse Molecular Design, February 2023. URL [http://arxiv.org/abs/2209.15408](http://arxiv.org/abs/2209.15408). arXiv:2209.15408 [physics, q-bio].
* [25] Wengong Jin, Regina Barzilay, and Tommi Jaakkola. Junction Tree Variational Autoencoder for Molecular Graph Generation. Technical report, International Conference on Machine Learning, 2018. URL [https://arxiv.org/abs/1802.04364](https://arxiv.org/abs/1802.04364).
* [26] Krzysztof Maziarz, Henry Jackson-Flux, Pashmina Cameron, Finton Sirockin, Nadine Schneider, Nikolaus Stiefl, Marwin Segler, and Marc Brockschmidt. Learning to Extend Molecular Scaffolds with Structural Motifs. Technical Report arXiv:2103.03864, arXiv, April 2022. URL [http://arxiv.org/abs/2103.03864](http://arxiv.org/abs/2103.03864). arXiv:2103.03864 [cs, q-bio] type: article.
* [27] Wengong Jin, Regina Barzilay, and Tommi Jaakkola. Hierarchical Generation of Molecular Graphs using Structural Motifs. Technical report, International Conference on Machine Learning, 2020.
* [28] Clement Vignac, Igor Krawczuk, Antoine Siraudin, Bohan Wang, Volkan Cevher, and Pascal Frossard. DiGress: Discrete Denoising diffusion for graph generation, October 2022. URL [http://arxiv.org/abs/2209.14734](http://arxiv.org/abs/2209.14734). arXiv:2209.14734 [cs].
* [29] Xiangzhe Kong, Wenbing Huang, Zhixing Tan, and Yang Liu. Molecule Generation by Principal Subgraph Mining and Assembling, September 2022. URL [http://arxiv.org/abs/2106.15098](http://arxiv.org/abs/2106.15098). arXiv:2106.15098 [cs, q-bio].
* [30] Nicola De Cao and Thomas Kipf. MolGAN: An implicit generative model for small molecular graphs. Technical Report arXiv:1805.11973, arXiv, May 2018. URL [http://arxiv.org/abs/1805.11973](http://arxiv.org/abs/1805.11973). arXiv:1805.11973 [cs, stat] type: article.
* [31] Leon Hetzel, Johanna Sommer, Bastian Rieck, Fabian Theis, and Stephan Gunnemann. MAGNet: Motif-agnostic generation of molecules from shapes. _arXiv preprint arXiv:2305.19303_, 2023.

* [32] Zijie Geng, Shufang Xie, Yingce Xia, Lijun Wu, Tao Qin, Jie Wang, Yongdong Zhang, Feng Wu, and Tie-Yan Liu. De Novo Molecular Generation via Connection-aware Motif Mining, February 2023. URL [http://arxiv.org/abs/2302.01129](http://arxiv.org/abs/2302.01129). arXiv:2302.01129 [cs].
* [33] Johanna Sommer, Leon Hetzel, David Ludke, Fabian J. Theis, and Stephan Gunnemann. The Power of Motifs as Inductive Bias for Learning Molecular Distributions. March 2023. URL [https://openreview.net/forum?id=cs3_jJ0se3z](https://openreview.net/forum?id=cs3_jJ0se3z).
* [34] Mohamed Amine Ketata, Nicholas Gao, Johanna Sommer, Tom Wollschlager, and Stephan Gunnemann. Lift Your Molecules: Molecular Graph Generation in Latent Euclidean Space, June 2024. URL [http://arxiv.org/abs/2406.10513](http://arxiv.org/abs/2406.10513). arXiv:2406.10513.
* [35] Matthew Ragoza, Tomohide Masuda, and David Ryan Koes. Learning a continuous representation of 3D molecular structures with deep generative models. _arXiv preprint arXiv:2010.08687_, 2020.
* [36] Niklas W. A. Gebauer, Michael Gastegger, and Kristof T. Schutt. Symmetry-adapted generation of 3d point sets for the targeted discovery of molecules, January 2020. URL [http://arxiv.org/abs/1906.00957](http://arxiv.org/abs/1906.00957). G-SchNet.
* [37] Youzhi Luo and Shuiwang Ji. An Autoregressive Flow Model for 3D Molecular Geometry Generation from Scratch. October 2021. URL [https://openreview.net/forum?id=CO3Ajc-N5W](https://openreview.net/forum?id=CO3Ajc-N5W). G-SphereNet.
* [38] Shitong Luo, Jiaqi Guan, Jianzhu Ma, and Jian Peng. A 3D generative model for structure-based drug design. _Advances in Neural Information Processing Systems_, 34:6229-6239, 2021.
* [39] Victor Garcia Satorras, Emiel Hoogeboom, Fabian B. Fuchs, Ingmar Posner, and Max Welling. E(n) Equivariant Normalizing Flows, January 2022. URL [http://arxiv.org/abs/2105.09016](http://arxiv.org/abs/2105.09016). arXiv:2105.09016 [physics, stat].
* [40] Yuxuan Song, Jingjing Gong, Minkai Xu, Ziyao Cao, Yanyan Lan, Stefano Ermon, Hao Zhou, and Wei-Ying Ma. Equivariant flow matching with hybrid probability transport for 3D molecule generation. In _Thirty-seventh conference on neural information processing systems_, 2023.
* [41] Minkai Xu, Alexander Powers, Ron Dror, Stefano Ermon, and Jure Leskovec. Geometric Latent Diffusion Models for 3D Molecule Generation, May 2023. URL [http://arxiv.org/abs/2305.01140](http://arxiv.org/abs/2305.01140). GeoLDM.
* [42] Lemeng Wu, Chengyue Gong, Xingchao Liu, Mao Ye, and Qiang Liu. Diffusion-based Molecule Generation with Informative Prior Bridges, September 2022. URL [http://arxiv.org/abs/2209.00865](http://arxiv.org/abs/2209.00865). Bridge.
* [43] Alex Morehead and Jianlin Cheng. Geometry-Complete Diffusion for 3D Molecule Generation and Optimization, June 2023. URL [http://arxiv.org/abs/2302.04313](http://arxiv.org/abs/2302.04313). GCDM.
* [44] Bo Qiang, Yuxuan Song, Minkai Xu, Jingjing Gong, Bowen Gao, Hao Zhou, Wei-Ying Ma, and Yanyan Lan. Coarse-to-fine: a hierarchical diffusion model for molecule generation in 3d. In _International conference on machine learning_, pages 28277-28299. PMLR, 2023.
* [45] Clement Vignac, Nagham Osman, Laura Toni, and Pascal Frossard. Midi: Mixed graph and 3d denoising diffusion for molecule generation. _arXiv preprint arXiv:2302.09048_, 2023.
* [46] Han Huang, Leilei Sun, Bowen Du, and Weifeng Lv. Learning Joint 2D & 3D Diffusion Models for Complete Molecule Generation, June 2023. URL [http://arxiv.org/abs/2305.12347](http://arxiv.org/abs/2305.12347). JODO.
* [47] Lei Huang, Hengtong Zhang, Tingyang Xu, and Ka-Chun Wong. MDM: Molecular Diffusion Model for 3D Molecule Generation, September 2022. URL [http://arxiv.org/abs/2209.05710](http://arxiv.org/abs/2209.05710). MDM.
* [48] Xingang Peng, Shitong Luo, Jiaqi Guan, Qi Xie, Jian Peng, and Jianzhu Ma. Pocket2mol: Efficient molecular sampling based on 3d protein pockets. In _International conference on machine learning_, pages 17644-17655. PMLR, 2022.

* Liu et al. [2022] Meng Liu, Youzhi Luo, Kanji Uchino, Koji Maruhashi, and Shuiwang Ji. Generating 3d molecules for target protein binding. _arXiv preprint arXiv:2204.09410_, 2022.
* Guan et al. [2023] Jiaqi Guan, Wesley Wei Qian, Xingang Peng, Yufeng Su, Jian Peng, and Jianzhu Ma. 3d equivariant diffusion for target-aware molecule generation and affinity prediction. _arXiv preprint arXiv:2303.03543_, 2023.
* Imrie et al. [2021] Fergus Imrie, Thomas E Hadfield, Anthony R Bradley, and Charlotte M Deane. Deep generative design with 3D pharmacophoric constraints. _Chemical science_, 12(43):14577-14589, 2021. Publisher: Royal Society of Chemistry.
* Huang et al. [2022] Yinan Huang, Xingang Peng, Jianzhu Ma, and Muhan Zhang. 3DLinker: an E (3) equivariant variational autoencoder for molecular linker design. _arXiv preprint arXiv:2205.07309_, 2022.
* Imrie et al. [2020] Fergus Imrie, Anthony R Bradley, Mihaela van der Schaar, and Charlotte M Deane. Deep generative models for 3D linker design. _Journal of chemical information and modeling_, 60(4):1983-1995, 2020. Publisher: ACS Publications.
* Guan et al. [2023] Jiaqi Guan, Xingang Peng, PeiQi Jiang, Yunan Luo, Jian Peng, and Jianzhu Ma. LinkerNet: Fragment Poses and Linker Co-Design with 3D Equivariant Diffusion. _Advances in Neural Information Processing Systems_, 36:77503-77519, December 2023. URL [https://proceedings.neurips.cc/paper_files/paper/2023/hash/f4821075019a058700f6e6738eea1365-Abstract-Conference.html](https://proceedings.neurips.cc/paper_files/paper/2023/hash/f4821075019a058700f6e6738eea1365-Abstract-Conference.html).
* Adams and Coley [2022] Keir Adams and Connor W Coley. Equivariant shape-conditioned generation of 3d molecules for ligand-based drug design. _arXiv preprint arXiv:2210.04893_, 2022.
* Long et al. [2022] Siyu Long, Yi Zhou, Xinyu Dai, and Hao Zhou. Zero-shot 3d drug design by sketching and generating. _Advances in Neural Information Processing Systems_, 35:23894-23907, 2022.
* Sohl-Dickstein et al. [2015] Jascha Sohl-Dickstein, Eric Weiss, Niru Maheswaranathan, and Surya Ganguli. Deep unsupervised learning using nonequilibrium thermodynamics. In _International conference on machine learning_, pages 2256-2265. PMLR, 2015.
* Kollovich et al. [2023] Marcel Kollovich, Abdul Fatir Ansari, Michael Bohlke-Schneider, Jasper Zschiegner, Hao Wang, and Yuyang Wang. Predict, refine, synthesize: Self-guiding diffusion models for probabilistic time series forecasting. _arXiv preprint arXiv:2307.11494_, 2023.
* Kabsch [1976] Wolfgang Kabsch. A solution for the best rotation to relate two sets of vectors. _Acta Crystallographica Section A: Crystal Physics, Diffraction, Theoretical and General Crystallography_, 32(5):922-923, 1976. Publisher: International Union of Crystallography.
* Kabsch [1978] Wolfgang Kabsch. A discussion of the solution for the best rotation to relate two sets of vectors. _Acta Crystallographica Section A: Crystal Physics, Diffraction, Theoretical and General Crystallography_, 34(5):827-828, 1978. Publisher: International Union of Crystallography.
* Besl and McKay [1992] Paul J Besl and Neil D McKay. Method for registration of 3-D shapes. In _Sensor fusion IV: control paradigms and data structures_, volume 1611, pages 586-606. Spie, 1992.
* Free Energy Calculation Guided Virtual Screening of Synthetically Feasible Ligand R-Group and Scaffold Modifications: An Emerging Paradigm for Lead Optimization. In Robert A. Goodnow, editor, _Annual Reports in Medicinal Chemistry_, volume 50 of _Platform Technologies in Drug Discovery and Validation_, pages 237-262. Academic Press, January 2017. doi: 10.1016/bs.armc.2017.08.007. URL [https://www.sciencedirect.com/science/article/pii/S0065774317300106](https://www.sciencedirect.com/science/article/pii/S0065774317300106).
* Li [2020] Qingxin Li. Application of Fragment-Based Drug Discovery to Versatile Targets. _Frontiers in Molecular Biosciences_, 7:180, 2020. ISSN 2296-889X. doi: 10.3389/fmolb.2020.00180.
* Bohm et al. [2004] Hans-Joachim Bohm, Alexander Flohr, and Martin Stahl. Scaffold hopping. _Drug Discovery Today. Technologies_, 1(3):217-224, December 2004. ISSN 1740-6749. doi: 10.1016/j.ddtec.2004.10.009.

* Sheng and Zhang [2013] Chunquan Sheng and Wannian Zhang. Fragment informatics and computational fragment-based drug design: an overview and update. _Medicinal Research Reviews_, 33(3):554-598, May 2013. ISSN 1098-1128. doi: 10.1002/med.21255.
* Polykovskiy et al. [2020] Daniil Polykovskiy, Alexander Zhebrak, Benjamin Sanchez-Lengeling, Sergey Golovanov, Oktai Tatonov, Stanislav Belyaev, Rauf Kurbanov, Aleksey Artamonov, Vladimir Aladinskiy, Mark Veselov, Artur Kadurin, Simon Johansson, Hongming Chen, Sergey Nikolenko, Alan Aspuru-Guzik, and Alex Zhavoronkov. Molecular Sets (MOSES): A Benchmarking Platform for Molecular Generation Models, October 2020. URL [http://arxiv.org/abs/1811.12823](http://arxiv.org/abs/1811.12823). arXiv:1811.12823 [cs, stat].
* Guan et al. [2024] Jiaqi Guan, Xiangxin Zhou, Yuwei Yang, Yu Bao, Jian Peng, Jianzhu Ma, Qiang Liu, Liang Wang, and Quanquan Gu. DecompDiff: Diffusion Models with Decomposed Priors for Structure-Based Drug Design, 2024. URL [https://arxiv.org/abs/2403.07902](https://arxiv.org/abs/2403.07902). Version Number: 1.
* Francoeur et al. [2020] Paul G Francoeur, Tomohide Masuda, Jocelyn Sunseri, Andrew Jia, Richard B Iovanisci, Ian Snyder, and David R Koes. Three-dimensional convolutional neural networks and a cross-docked data set for structure-based drug design. _Journal of chemical information and modeling_, 60(9):4200-4215, 2020. Publisher: ACS Publications.
* Hu et al. [2005] Liegi Hu, Mark L Benson, Richard D Smith, Michael G Lerner, and Heather A Carlson. Binding MOAD (mother of all databases). _Proteins: Structure, Function, and Bioinformatics_, 60(3):333-340, 2005. Publisher: Wiley Online Library.
* Huang et al. [2024] Zhilin Huang, Ling Yang, Xiangxin Zhou, Zhilong Zhang, Wentao Zhang, Xiawu Zheng, Jie Chen, Yu Wang, CUI Bin, and Wenming Yang. Protein-ligand interaction prior for binding-aware 3d molecule diffusion models. _The Twelfth International Conference on Learning Representations 2024_.
* Lugmayr et al. [2022] Andreas Lugmayr, Martin Danelljan, Andres Romero, Fisher Yu, Radu Timofte, and Luc Van Gool. Repaint: Inpainting using denoising diffusion probabilistic models. In _Proceedings of the IEEE/CVF conference on computer vision and pattern recognition_, pages 11461-11471, 2022.
* Alhossary et al. [2015] Amr Alhossary, Stephanus Daniel Handoko, Yuguang Mu, and Chee-Keong Kwoh. Fast, accurate, and reliable molecular docking with QuickVina 2. _Bioinformatics (Oxford, England)_, 31(13):2214-2216, 2015. Publisher: Oxford University Press.
* Landrum and others [2013] Greg Landrum and others. RDKit: A software suite for cheminformatics, computational chemistry, and predictive modeling. _Greg Landrum_, 8:31, 2013.
* Irwin et al. [2020] John J. Irwin, Khanh G. Tang, Jennifer Young, Chinzorig Dandarchuluun, Benjamin R. Wong, Munkhzul Khurelbaatar, Yurii S. Moroz, John Mayfield, and Roger A. Sayle. ZINC20--A Free Ultralarge-Scale Chemical Database for Ligand Discovery. _Journal of Chemical Information and Modeling_, 2020. ISSN 1549-9596. doi: 10.1021/acs.jcim.0c00675.
* Dossetter et al. [2013] Alexander G Dossetter, Edward J Griffen, and Andrew G Leach. Matched molecular pair analysis in drug discovery. _Drug Discovery Today_, 18(15-16):724-731, 2013. Publisher: Elsevier.
* Jaini et al. [2021] Priyank Jaini, Lars Holdijk, and Max Welling. Learning equivariant energy based models with equivariant stein variational gradient descent. _Advances in Neural Information Processing Systems_, 34:16727-16737, 2021.
* Wojcikowski et al. [2015] Maciej Wojcikowski, Piotr Zielenkiewicz, and Pawel Siedlecki. Open Drug Discovery Toolkit (ODDT): a new open-source player in the drug discovery field. _Journal of cheminformatics_, 7(1):1-6, 2015. Publisher: BioMed Central.
* Vainio et al. [2009] Mikko J Vainio, J Santeri Puranen, and Mark S Johnson. ShaEP: molecular overlay based on shape and electrostatic potential, 2009.

* Sverrisson et al. [2021] Freyr Sverrisson, Jean Feydy, Bruno E. Correia, and Michael M. Bronstein. Fast end-to-end learning on protein surfaces. In _2021 IEEE/CVF Conference on Computer Vision and Pattern Recognition (CVPR)_, pages 15267-15276, June 2021. doi: 10.1109/CVPR46437.2021.01502. URL [https://ieeexplore.ieee.org/document/9577686](https://ieeexplore.ieee.org/document/9577686). ISSN: 2575-7075.
* Wojcikowski et al. [2015] Maciej Wojcikowski, Piotr Zielenkiewicz, and Pawel Siedlecki. Open Drug Discovery Toolkit (ODDT): a new open-source player in the drug discovery field. _Journal of Cheminformatics_, 7(1):26, December 2015. ISSN 1758-2946. doi: 10.1186/s13321-015-0078-2. URL [https://jcheminf.biomedcentral.com/articles/10.1186/s13321-015-0078-2](https://jcheminf.biomedcentral.com/articles/10.1186/s13321-015-0078-2).
* Ganea et al. [2021] Octavian-Eugen Ganea, Xinyuan Huang, Charlotte Bunne, Yatao Bian, Regina Barzilay, Tommi Jaakkola, and Andreas Krause. Independent se (3)-equivariant models for end-to-end rigid protein docking. _arXiv preprint arXiv:2111.07786_, 2021.
* Zaucha et al. [2020] Jan Zaucha, Charlotte A. Softley, Michael Sattler, Dmitrij Frishman, and Grzegorz M. Popowicz. Deep learning model predicts water interaction sites on the surface of proteins using limited-resolution data. _Chemical Communications_, 56(98):15454-15457, December 2020. ISSN 1364-548X. doi: 10.1039/DOCC04383D. URL [https://pubs.rsc.org/en/content/articlelanding/2020/cc/d0cc04383d](https://pubs.rsc.org/en/content/articlelanding/2020/cc/d0cc04383d). Publisher: The Royal Society of Chemistry.
* Zhu et al. [2023] Huimin Zhu, Renyi Zhou, Dongsheng Cao, Jing Tang, and Min Li. A pharmacophore-guided deep learning approach for bioactive molecular generation. _Nature Communications_, 14(1):6234, October 2023. ISSN 2041-1723. doi: 10.1038/s41467-023-41454-9. URL [https://www.nature.com/articles/s41467-023-41454-9](https://www.nature.com/articles/s41467-023-41454-9). Publisher: Nature Publishing Group.
* Lorensen and Cline [1987] William E. Lorensen and Harvey E. Cline. Marching cubes: A high resolution 3D surface construction algorithm. In _Proceedings of the 14th annual conference on Computer graphics and interactive techniques_, SIGGRAPH '87, pages 163-169, New York, NY, USA, August 1987. Association for Computing Machinery. ISBN 978-0-89791-227-3. doi: 10.1145/37401.37422. URL [https://dl.acm.org/doi/10.1145/37401.37422](https://dl.acm.org/doi/10.1145/37401.37422).

Impact Statement

Our research holds the promise of significant contributions to the advancement of drug discovery, possibly assisting in the discovery of novel pharmaceutical compounds. Nevertheless, because of its applications in drug discovery, this strategy is not without its hazards. The ability to produce various molecules with desired properties may not only serve the purpose of beneficial drug development but may also unintentionally result in the creation of dangerous substances or compounds with unexpected effects. These concerns underline the critical need for careful handling when working with the structures this method can generate.

## Appendix B Proof of Theorem 4.1

First, recall Theorem 4.1 that we provide in Sec. 4:

**Theorem 1**.: _Consider a function \(C:\mathcal{S}\times\mathcal{Z}\rightarrow\mathcal{Z}\). If \(C(\mathbf{s},\mathbf{z})\) is invariant to rigid transformations \(G\) in the first argument and equivariant in the second argument, then the gradient \(\nabla_{\mathbf{z}}\norm{\mathbf{v}}_{2}^{2}\) of the vector \(\mathbf{v}=\mathbf{z}-C(\mathbf{s},\mathbf{z})\) is equivariant to transformations of \(\mathbf{z}\)._

Proof.: We start the proof by showing that \(\norm{\mathbf{v}}_{2}\) is invariant to transformations of both \(\mathbf{z}\) and \(\mathbf{s}\).

1. \(\norm{\mathbf{z}-C(\mathbf{s},\mathbf{z})}_{2}\) is invariant to transformations in \(\mathbf{z}\):

\[\begin{split}\norm{G\mathbf{z}-C(\mathbf{s},G\mathbf{z})}_{2}& =\norm{G\mathbf{z}-GC(\mathbf{s},\mathbf{z})}_{2}\qquad\text{[$C$ is equivariant in $\mathbf{z}$]}\\ &=\norm{G(\mathbf{z}-C(\mathbf{s},\mathbf{z}))}_{2}\\ &=\norm{\mathbf{z}-C(\mathbf{s},\mathbf{z})}_{2}\qquad\qquad\text{[$G$ is a rigid transformation]}\end{split} \tag{22}\]

2. \(\norm{\mathbf{z}-C(\mathbf{s},\mathbf{z})}_{2}\) is invariant to transformations \(\mathbf{s}\) follows immediately:

\[\norm{\mathbf{z}-C(G\mathbf{s},\mathbf{z})}_{2}=\norm{\mathbf{z}-C(\mathbf{s},\mathbf{z })}_{2}\qquad\text{[$C$ is invariant in $\mathbf{s}$]} \tag{23}\]

In a second step, we make use of the fact that for a group of transformations \(G\), it holds that if \(\mathcal{L}(\cdot,\cdot)\) is a \(G\)-invariant function, \(\nabla_{x}\mathcal{L}(\cdot,x)\) is \(G\)-equivariant [76]. From the invariance of \(\norm{\mathbf{v}}_{2}\), it follows immediately that \(\nabla_{\mathbf{z}}\norm{\mathbf{z}-C(\mathbf{s},\mathbf{z})}_{2}^{2}\) is equivariant to transformations of \(\mathbf{z}\). 

## Appendix C Unconditional Equivariant Diffusion Model

UniGuide guides an unconditional diffusion model given an arbitrary condition and a natural choice for a model operating only on the molecule level is the EDM model as proposed in Hoogeboom et al. [20].

We adapt this model for two tasks presented in this work, namely the LBDD task discussed in Sec. 5.1 and the Linker Design task as presented in Sec. 5.3. For these tasks, we train an unconditional EDM model both on the MOSES dataset [66] in the configuration as described in Chen et al. [14] and on the ZINC dataset [74] as described in Igashov et al. [13]. For both trainings, we employ the hyperparameter configuration for the GEOM dataset as described in Hoogeboom et al. [20]. We run multi-GPU trainings on 4 NVIDIA A100 GPUs until convergence, however, a single NVIDIA A100 GPU is sufficient for this training and will only increase the training time. For inference, we employ the Resampling trick as discussed in Lugmayr et al. [71] with \(R=10\) resampling steps and \(T=100\) timesteps. EDM is available under the MIT License.

## Appendix D Ligand-based drug design

### Implementation details

We train two unconditional diffusion models, ShapeMol [U] and EDM, to generate 3D molecules on the MOSES dataset [66], licensed under the MIT License, for which we generate 3D conformers with RDKit [73], available under the BSD 3-Clause License. We use \(1,593,653\) training samplesand randomly select \(1000\) samples for validation. The model architecture of ShapeMol[U] is an unconditional version of the ShapeMol model proposed in Chen et al. [14], and it is trained with \(1000\) diffusion steps. ShapeMol [U] is trained with a batch size of \(32\) on two NVIDIA A100 GPUs for \(500\) epochs. Unlike ShapeMol, we do not concatenate the molecular surface embedding of the ligands to the features. For the shape-conditioned generation with position correction (ShapeMol+g), we follow the scheme proposed in Chen et al. [14]. It provides further guidance to the conditional generation by sampling \(20\) query points from a Gaussian distribution centred around every atom in the reference ligand. The position correction adjusts the coordinates of the predicted atom positions during every generation step by pushing the coordinates close to the query points as follows:

\[\hat{\mathbf{x}}=(1-\sigma)\hat{\mathbf{x}}+\sigma\sum_{\mathbf{z}\in n(\hat{\mathbf{x}}, \mathcal{Q})}\mathbf{z}/n,\text{if}\sum_{\mathbf{x}\in n(\hat{\mathbf{x}},\mathcal{Q})} d(\hat{\mathbf{x}},\mathbf{z})/n>\gamma, \tag{24}\]

where \(d(\hat{\mathbf{x}},\mathbf{z})\) is the Euclidean distance, \(n(\hat{\mathbf{x}},\mathcal{Q})\) is the set of \(n\) nearest neighbors of \(\hat{\mathbf{x}}\) in \(\mathcal{Q}\) and \(\gamma>0\) is a distance threshold. We follow the implementation of Chen et al. [2] for the position correction method by setting \(\gamma=0.2\) and only guiding during the first \(700\) denoising steps.

For the shape-conditioned generation with UniGuide, we extract the mesh of the condition ligand using the Open Drug Discovery Toolkit [77], which is available under the BSD 3-Clause revised License. The query points we use for guidance are \(512\) points sampled uniformly on the mesh surface. For the evaluation, we measure the shape similarity Sim\({}_{S}\) as the volume overlap between the aligned generated ligand and the condition ligand. For the alignment, we utilise the ShaEP tool [78].

We provide a detailed description of the LBDD sampling algorithm in Algorithm 1.

```
Require:\(\mathbf{y}\), \(\alpha\): desired margin to surface, \(k\): number of nearest neighbours \(\mathbf{z}_{T}\sim\mathcal{N}(\mathbf{0},\mathbf{I})\) for\(t=T\)to\(1\)do \(\mathbf{x}_{t},\mathbf{h}_{t}=\mathbf{z}_{t}\) \(\hat{\mathbf{x}}_{0}=\frac{\mathbf{x}_{t}-\sqrt{1-\hat{\alpha}_{t}}\mathbf{z} _{t}}{\sqrt{\hat{\alpha}_{t}}}\) {Compute the conformation \(\hat{\mathbf{x}}_{0}\) of the clean approximation \(\hat{\mathbf{z}}_{0}\)} For every atom \(\hat{\mathbf{x}}_{i}\) in \(\hat{\mathbf{x}}_{0}\) do: \(\bar{\mathbf{y}}_{i}=\frac{1}{k}\sum_{\mathbf{y}\in\mathcal{N}_{\hat{\mathbf{x}} _{i}}}\mathbf{y}\) {Compute the mean of \(k\) nearest neighbors of \(\hat{\mathbf{x}}_{i}\) in \(\mathbf{y}\)}  Compute \((\mathbf{c}_{\mathbf{x}})_{i}\) based on Eq. (21) {Compute component-wise condition map} \(\mathcal{L}=\mathcal{L}(\hat{\mathbf{x}}_{0},\mathbf{c}_{\mathbf{x}})\) \(\mathbf{g}=\nabla_{\mathbf{x}_{t}}\mathcal{L}\) {Compute gradient of guidance loss} {Update the mean function} \(\mathbf{z}_{t-1}\sim\mathcal{N}(\mathbf{\mu}_{t},\sigma_{t}\mathbf{I})\) endfor return\(\mathbf{z}_{0}\)
```

**Algorithm 1** Sampling algorithm to generate a ligand that is conditioned on a reference ligand \(\mathcal{M}_{\text{ref}}\)'s surface, using an unconditional model \(\mathbf{\epsilon}_{\theta}(\mathbf{z}_{t},t)\) modelling the distribution over molecules. The points \(\mathbf{y}\in\mathbb{R}^{K\times 3}\) are sampled uniformly from the surface of \(\mathcal{M}_{\text{ref}}\), enclosing the volume \(V\).

### Additional results

For completeness, we report additional quantitative evaluation of the generated ligands' properties in Tab. 4. We also provide further qualitative results of the generated ligands for the LBDD task in Fig. 6. UniGuide generates ligands with better shape similarity to the reference ligands compared to the conditional model ShapeMol with the position correction technique.

\begin{table}
\begin{tabular}{l c c c c c c} \hline \hline method & Connect. (\(\uparrow\)) & Unique (\(\uparrow\)) & QED & SA (\(\uparrow\)) & LogP (\(\uparrow\)) & Lipinski (\(\uparrow\)) \\ \hline ShapeMol & 98.8\% & 99.9\% & **0.753** & 0.640 \(\pm\) 0.104 & 2.001 \(\pm\) 1.360 & 4.979 \(\pm\) 0.156 \\ ShapeMol+g & 97.0\% & 99.8\% & 0.751 & 0.630 \(\pm\) 0.110 & 1.908 \(\pm\) 1.508 & 4.874 \(\pm\) 0.170 \\
**UniGuide+ ShapeMol[U]** & 98.0\% & **100\%** & 0.736 & 0.625 \(\pm\) 0.103 & 1.828 \(\pm\) 1.463 & 4.974 \(\pm\) 0.186 \\
**UniGuide (ShapeMol)** & 99.0\% & **100\%** & 0.750 & **0.641 \(\pm\) 0.107** & **2.002 \(\pm\) 1.374** & 4.982 \(\pm\) 0.152 \\
**UniGuide+ EDM** & **99.8\%** & 99.99\% & 0.742 & 0.636 \(\pm\) 0.088 & 1.833 \(\pm\) 1.221 & **4.994 \(\pm\) 0.082** \\ \hline \hline \end{tabular}
\end{table}
Table 4: Additional ligand property results for the methods discussed in Sec. 5.1. We report mean and standard deviation and highlight the best result in **bold**.

### Guidance parameters

For the LBDD task, the guidance strength \(S\) is weighted by an exponentially decreasing function \(\frac{\beta_{t}}{\sqrt{\alpha_{t}}}\). For the guided generation using the unconditional ShapeMol [U] model under the UniGuide framework, we define a scale scheduler that increases with an exponent of \(1.01\) and weight it with \(\frac{\beta_{t}}{\sqrt{\alpha_{t}}}\) and guide from the diffusion step \(1000\) to the diffusion step \(200\). For the guided generation using the EDM model, we use a linear scale function that increases from \(5\) to \(15\). The guidance is applied from the diffusion step \(920\) to the last timestep \(1\).

### Comparison of UniGuide with an alternative loss formulation

We adapt the validity guidance loss from Guan et al. [50] to the LBDD setting. The proposed loss is grounded in the smooth distance function \(S(x)\) from Sverrisson et al. [79], which computes as:

\[S(x)=-\sigma\log\Big{(}\sum_{i}^{N}\exp(-\|x_{t}-y_{i}\|_{2}^{2}/\sigma)\Big{)}\quad.\]

This function provides an alternative approach to shape-based generation by deriving an appropriate loss function \(\sum_{x}S(x)\), rather than modifying the condition map as proposed by UniGuide. Here, \(S(x)\) implicitly defines a surface through \(S(x)-\gamma=0\) and points \(x_{t}\) inside satisfy \(S(x_{t})<\gamma\).

\begin{table}
\begin{tabular}{l|c c c c c c c c c} \hline \hline  & Sim\({}_{S}\) (\(\uparrow\)) & maxSim\({}_{S}\) (\(\uparrow\)) & Sim\({}_{G}\) (\(i\)) & maxSim\({}_{G}\) (\(i\)) & **Ratio** (\(\uparrow\)) & Connect. (\(\uparrow\)) & Unique. (\(\uparrow\)) & Diversity (\(\uparrow\)) & QED (\(\uparrow\)) \\ \hline Validity Guidance & 0.59 & 0.76 & 0.20 & 0.20 & **2.96** & 97\% & 100\% & 0.76 & 0.69 \\ UniGuide (EDM) & 0.74 & 0.86 & 0.21 & 0.20 & **3.53** & 99\% & 99\% & 0.73 & 0.74 \\ \hline \hline \end{tabular}
\end{table}
Table 5: Comparison of UniGuide with validity guidance for shape-based generation. We highlight the ratio metric as the most critical indicator, reflecting the balance between shape similarity and graph dissimilarity.

Figure 6: Examples of the ligands generated by _ShapeMol_, Pos-Correct and UniGuide. Pos-Correct is the position correction technique proposed by Chen et al. [14]. Both Pos-Correct and UniGuide are combined with the unconditionally trained model ShapeMol [U]. We plot the reference ligand as well as the generated ligands with their shapes.

On a technical level, the gradient for validity guidance computes as follows:

\[\nabla_{x_{t}}S(x_{t}) =\nabla_{x_{t}}\Big{[}-\sigma\log\Big{(}\sum_{i}^{N}\exp(-\|x_{t}-y _{i}\|_{2}^{2}/\sigma)\Big{)}\Big{]}\] \[=\frac{1}{\sum\exp(\dots)}\sum_{i}^{N}\underbrace{\exp(\dots)}_{ \omega_{i}}\nabla_{x_{t}}\|x_{t}-y_{i}\|_{2}^{2}\] \[=\frac{1}{\sum\omega_{i}}\nabla_{x_{t}}\sum_{i}^{N}\omega_{i}\|x_ {t}-y_{i}\|_{2}^{2}\quad.\]

This gradient formulation is quite similar (up to the weighting) to UniGuide's special case \(\mathcal{S}=\mathcal{Z}\), as it computes an \(L_{2}\) loss on a given conformation (\(\{y_{i}\}\)), see Eq. (18), meaning that it does not generalise to arbitrary geometric conditions.

We emphasise that UniGuide is more broadly applicable because it separates surface computation from gradient computation, offering two key benefits. First, since the condition map does not require differentiability, there is greater flexibility in computing surface points. Second, the precise geometric intuition behind the condition map makes it easier to adapt to new scenarios, as demonstrated by our application to generating density-guided molecules.

For the empirical comparison, we selected the hyperparameters \(\sigma\) and \(\gamma\) in the surface loss computation to achieve a high DICE score between the implicitly defined surface and the meshes UniGuide utilises for LBDD (\(\sigma=1\), \(\gamma=2\), DICE \(>0.8\)). Our surface calculations use the Open Drug Discovery Toolkit (ODDT), which assigns specific radii to individual atom types and employs the marching cubes algorithm to generate meshes [80].

We performed several runs around the above-specified hyperparameter configuration. The runs performed similarly, and we report the best result in Tab. 5. Although validity guidance for LBDD yields low graph similarity, the shape similarity remains suboptimal compared to UniGuide. Additionally, we frequently encounter numerical instability when computing the guidance term, an issue not present with UniGuide's formulation of LBDD. One possible explanation for this numerical instability is that the surface is defined implicitly, unlike UniGuide where it is explicitly defined. The explicit definition in UniGuide allows for relating the gradient updates directly to the surface, as shown in Eq. (21).

## Appendix E Structure-based drug design

```
Require:\(\tilde{\mathbf{z}}^{\mathcal{P}}\), \(S\) \(\mathbf{z}_{T}\sim\mathcal{N}(\mathbf{0},\mathbf{I})\){Sample from normal prior} for\(t=T\)to1do \(\hat{\mathbf{z}}^{\mathcal{P}}_{0}=\mathbf{z}^{\mathcal{P}}_{t}-\sqrt{1-\bar{ \alpha}_{t}}\mathbf{\epsilon}^{\mathcal{P}}_{\theta}(\mathbf{z}_{t},t)/\sqrt{\bar {\alpha}_{t}}\){Compute the clean data of the pocket} \(\mathcal{L}=\mathcal{L}(\hat{\mathbf{z}}^{\mathcal{P}}_{0},\tilde{\mathbf{z}} ^{\mathcal{P}})\){Compute gradient and substract the CoM} \(\mathbf{\mu}_{t}=\mathbf{\mu}_{\theta}(\mathbf{z}_{t},t)-\lambda(t)\cdot\mathbf{g}\){Update the mean of the pocket} \(\mathbf{z}_{t-1}\sim\mathcal{N}(\mathbf{\mu}_{t},\sigma_{t}\mathbf{I})\) endfor return\(\mathbf{z}=(\mathbf{z}^{\mathcal{M}}_{0},\mathbf{z}^{\mathcal{P}}_{0})\)
```

**Algorithm 2**Sampling algorithm to generate a ligand conditioned on a protein pocket \(\tilde{\mathbf{z}}^{\mathcal{P}}\) using the unconditional joint model \(\mathbf{\epsilon}_{\theta}(\mathbf{z}_{t},t)\), where \(\mathbf{z}_{t}=[\mathbf{z}^{\mathcal{M}}_{t},\mathbf{z}^{\mathcal{P}}_{t}]\), that models the distribution \(P(\mathbf{z}^{\mathcal{M}},\mathbf{z}^{\mathcal{P}})\). The guidance signal is controlled via the guidance strength \(S\). Note that samples from the generative process \(p_{\theta}(\mathbf{z}_{t-1}|\mathbf{z}_{t})\) are assumed to be CoM-free.

## Appendix E Structure-based drug design

``` Require:\(\tilde{\mathbf{z}}^{\mathcal{P}}\), \(S\) \(\mathbf{z}_{T}\sim\mathcal{N}(\mathbf{0},\mathbf{I})\){Sample from normal prior} for\(t=T\)to1do \(\hat{\mathbf{z}}^{\mathcal{P}}_{0}=\mathbf{z}^{\mathcal{P}}_{t}-\sqrt{1-\bar{ \alpha}_{t}}\mathbf{\epsilon}^{\mathcal{P}}_{\theta}(\mathbf{z}_{t},t)/\sqrt{\bar {\alpha}_{t}}\){Compute the clean data of the pocket} \(\mathcal{L}=\mathcal

### Ligand-protein generative joint model

SBDD aims to generate a ligand given a protein pocket: \(p_{\theta}(\mathbf{z}^{\mathcal{M}}\,|\,\mathbf{z}^{\mathcal{P}}_{\text{test}},t)\). We adopt DiffSBDD [11], an unconditional joint diffusion model that approximates the joint distribution \(p(\mathbf{z}^{\mathcal{M}}_{\text{data}},\mathbf{z}^{\mathcal{P}}_{\text{data}})\) of generating ligand-protein pairs, where the noise predictor \(\mathbf{\epsilon}_{\theta}(\mathbf{z}^{\mathcal{M}}_{t},\mathbf{z}^{\mathcal{P}}_{ t},t)\) is parametrised by EGNN. DiffSBDD is available under the MIT License. To process ligand and pocket nodes with a single GNN, atom types and residue types are embedded jointly. Atom and residue features are then decoded separately using atom decoder and residue decoder to \(\mathbf{\epsilon}^{\mathcal{M}}_{\theta}(\mathbf{z}^{\mathcal{M}}_{t},\mathbf{z}^{ \mathcal{P}}_{t},t)\) and \(\mathbf{\epsilon}^{\mathcal{P}}_{\theta}(\mathbf{z}^{\mathcal{M}}_{t},\mathbf{z}^{ \mathcal{P}}_{t},t)\)[11].

For the unconditional sampling with the joint model, the number of ligand and pocket nodes is sampled from the joint node distribution \(p(N^{\mathcal{M}},N^{\mathcal{P}})\), measured across a training set of \((\mathcal{M},\mathcal{P})\) pairs. During the modified generative process with the inpainting-inspired technique or with UniGuide the number of pocket nodes is set to be equal to the number of nodes in \(\mathcal{P}_{\text{test}}\), while the size of the ligand is generated from a conditional distribution \(p(N^{\mathcal{M}}\,|\,N^{\mathcal{P}})\). Since this sampling procedure leads to ligands that are much smaller compared to the reference ligands found in the test set, the mean size of sampled ligands is increased by \(10\) for Binding MOAD and \(5\) for CrossDocked during ligand generation [11]. We utilize the unconditional base models from Schneuing et al. [11], which are trained on either the \(C_{\alpha}\) or full-atom context from the Binding MOAD or CrossDocked datasets. However, we retrain the DiffSBDD model specifically on the full-atom context of the CrossDocked data, as we were unable to reproduce the reported results in this configuration from Schneuing et al. [11]. We find that contrary to what is reported in Schneuing et al. [11], the model converges early and does not need a full 1000 epochs to fully train. We employ this checkpoint to evaluate both the DiffSBDD inpainting-inspired approach as well as UniGuide. We train the model on four NVIDIA A100 GPU with a batch size of \(2\). 8 training epochs take approximately \(24\) hours.

Representing ligands and proteins as graphsProteins consist of amino acids, where every amino acid is a set of amino \((NH)\), carboxyl \((CO)\), \(\alpha\)-carbon atom and a side chain \((R)\) that is specific to every amino acid type [81]. The \(C_{\alpha}\)-representation of a protein pocket is a residue-level graph, in which the node features of the protein are represented as one-hot encodings of the amino acid type. The full-atom representation of the receptor is an atom-level graph and represents the full context of the protein pocket. Details on processed graphs of the join model \(p(\mathbf{z}^{\mathcal{M}},\mathbf{z}^{\mathcal{P}})\) are provided in Tab. 6. We refer the reader to Schneuing et al. [11] for more information on the hyperparameters of the joint model.

### Further Comparison to DiffSBDD

In addition to Tab. 2, we follow the experimental setup as utilised in Schneuing et al. [11] to compare UniGuideto DiffSBDD, which uses the same base model, in particular. In Tab. 8, we further investigate the advantages of using self-guidance in combinations with UniGuide over both the conditional DiffSBDD model (DiffSBDD-cond) as well as the inpainting-inspired technique

\begin{table}
\begin{tabular}{l c c c c c c} \hline \hline \multicolumn{2}{c}{} & \multicolumn{2}{c}{CrossDocked} & \multicolumn{2}{c}{Binding MOAD} \\ \hline  & joint \(C_{\alpha}\) & joint full- & joint \(C_{\alpha}\) & joint full- \\  & model & atom model & model & atom model & atom model \\ \hline Edges (ligand-ligand) & fully connected & fully connected & fully connected & fully connected \\ Edges (ligand-pocket) & \(<5\) Å & \(<5\) Å & \(<8\) Å & \(<7\) Å \\ \hline Edges (pocket-pocket) & \(<5\) Å & \(<5\) Å & \(<8\) Å & \(<4\) Å \\ \hline \hline \end{tabular}
\end{table}
Table 6: Hyperparameters of ligand and proteins graphs in joint models

\begin{table}
\begin{tabular}{l c c c c c c c} \hline \hline Dataset & \(R\) & \(T\) & QED (\(\uparrow\)) & SA (\(\uparrow\)) & Lipinski (\(\uparrow\)) & Diversity (\(\uparrow\)) & Connectivity (\(\uparrow\)) & Validity (\(\uparrow\)) \\ \hline C.D. (\(C_{\alpha}\)) & 1 & 500 & 0.535 & 0.660 & 4.741 & 0.772 & 0.893 & 0.986 \\ C.D. (\(C_{\alpha}\)) & 10 & 50 & 0.578 & 0.752 & 4.836 & 0.774 & 0.994 & 0.986 \\ \hline B.M. (\(C_{\alpha}\)) & 1 & 500 & 0.471 & 0.608 & 4.783 & 0.824 & 0.839 & 0.985 \\ B.M. (\(C_{\alpha}\)) & 10 & 50 & 0.544 & 0.665 & 4.883 & 0.823 & 0.961 & 0.992 \\ \hline \hline \end{tabular}
\end{table}
Table 7: Quantitative evaluation of samples generated by the unconditional joint models [11] trained on Crossdocked (C.D.) and Binding MOAD (B.M). We report the mean over all generated ligands.

(DiffSBDD). UniGuide reliably achieves superior VINA Dock scores compared to both DiffSBDD models and performs competitively with the conditional TargetDiff model. In App. E.4 and App. E.5, we expand on this experimental comparison with further analysis of the effects of Resampling as well as the guidance strength.

### Resampling

Inpainting is introduced for diffusion models to condition outputs with fixed parts [71] and can be applied for structure-based molecular tasks. Given a model that generates \((\mathbf{z}_{t}^{\mathcal{M}},\mathbf{z}_{t}^{\mathcal{P}})\) pairs at denoising step \(t\), the protein pocket \(P_{t}\) is replaced with the noised representation of protein context \(\bar{\mathbf{z}}_{t}^{\mathcal{P}}\). This noised representation can be obtained through the forward process of diffusion models as specified in Eq. (2). However, the direct application of this method leads to locally harmonised samples that struggle to incorporate the global context [71]. In order to effectively harmonise the generated information during the entire generative process, Lugmayr et al. [71] propose a technique they call "Resampling". This modifies the reverse Markov chain by moving back and forth in the diffusion process to enable the model to better incorporate the replaced components.

Schneuing et al. [11] propose to use the same resampling technique to harmonise the replaced protein context with the ligand, since the replaced receptor is sampled independently of the ligand. During resampling, each latent representation is repeatedly diffused back and forth before advancing to the next time step. We found that resampling further improves the general performance of the unconditional generation, and thus improves the guided generation as well. We report results for this in App. E.5, where we evaluate how the unconditional generation of the joint model is improved across different metrics with added resampling steps. We follow Schneuing et al. [11] in using the setting of \(R=10\) resampling steps and \(T=50\) timesteps. While DiffSBDD resamples the ligand and the noised target protein pocket, we resample the guided protein pocket and ligand with UniGuide. In general, the concept of resampling can be applied to harmonise the configuration \(\mathbf{z}_{t}\) with the condition \(\mathbf{c}\).

### Guidance parameters

The guidance scale \(S\) controls the strength of the guiding signal, see Eq. (7) and it is weighted by \(w(t)=\frac{\beta(t)}{\sqrt{\alpha_{t}}}\) during the generation. We use a constant scale \(S\) for structure-based drug design experiments and evaluate for several guidance scale values in Tab. 9 and Tab. 10 for models trained on the Binding MOAD dataset with \(C_{\alpha}\) and full-atom representation respectively. The quantitative evaluation on the CrossDocked data is shown under Tab. 11 and Tab. 12 with additional metrics reported in Tab. 7. For the generation with the \(C_{\alpha}\)-models, we generate \(100\) samples for every test pocket with a batch size of \(50\). The full generation takes approximately \(5\) hours for Binding MOAD and \(6\) hours for CrossDocked. For the DiffSBDD model trained on the Binding MOAD fullatom pocket data, we use a batch size of \(15\) for the generation. We use a batch size of \(2\) to sample with the DiffSBDD model trained on CrossDocked (fullatom).

\begin{table}
\begin{tabular}{l l c c c c c c c} \hline \hline  & & Vina (↓) & Vina Top 10\% (↓) & QED (↑) & SA (↑) & Lipinski (↑) & Diversity (↑) & RMSD (↓) \\ \hline \multirow{8}{*}{**Methods**} & Test Set & \(-6.865\pm 2.35\) & - & \(0.476\pm 0.20\) & \(0.728\pm 0.14\) & \(4.340\pm 1.14\) & - & - \\ \cline{2-9}  & 3D-SBDD [38] & \(-5.888\pm 1.91\) & \(-7.289\pm 2.34\) & \(0.502\pm 0.17\) & \(0.675\pm 0.14\) & \(4.787\pm 0.51\) & \(0.742\pm 0.09\) & - \\  & ProckeZModel\({}^{*}\)[48] & \(-7.058\pm 2.80\) & \(-8.712\pm 3.18\) & \(0.572\pm 0.16\) & \(0.752\pm 0.12\) & \(4.936\pm 0.27\) & \(0.735\pm 0.15\) & - \\  & Graph-BP\({}^{*}\)[49] & \(-4.719\pm 4.03\) & \(-7.165\pm 1.40\) & \(0.502\pm 0.12\) & \(0.307\pm 0.09\) & \(4.883\pm 0.37\) & \(0.844\pm 0.01\) & - \\ \cline{2-9}  & TargetDiff\({}^{*}\)[50] & \(-7.318\pm 2.47\) & \(\mathbf{-9.669\pm 2.55}\) & \(0.483\pm 0.20\) & \(0.584\pm 0.13\) & \(4.594\pm 0.83\) & \(0.718\pm 0.09\) & \(\mathbf{0.000\pm 0.00}\) \\  & DiffSBDD-cond- & \(-6.950\pm 2.06\) & \(-9.120\pm 2.16\) & \(0.469\pm 0.21\) & \(0.578\pm 0.13\) & \(4.562\pm 0.09\) & \(\mathbf{0.728\pm 0.07}\) & \(\mathbf{0.000\pm 0.00}\) \\  & DiffSBDD & \(-7.216\pm 2.54\) & \(-9.490\pm 2.00\) & \(\mathbf{0.571\pm 0.19}\) & \(\mathbf{0.639\pm 1.44}\) & \(\mathbf{0.480\pm 0.50}\) & \(0.707\pm 0.09\) & \(0.045\pm 0.01\) \\  & **UniGuide** & \(-7.320\pm 2.27\) & \(-9.514\pm 2.04\) & \(\mathbf{0.571\pm 0.19}\) & \(0.638\pm 0.14\) & \(\mathbf{4.832\pm 0.47}\) & \(0.705\pm 0.08\) & \(0.047\pm 0.01\) \\ \hline \hline \multirow{8}{*}{**Methods**} & Test Set & \(-8.331\pm 2.05\) & - & \(0.602\pm 0.15\) & \(0.636\pm 0.08\) & \(4.838\pm 0.37\) & - & - \\ \cline{2-9}  & Graph-BP\({}^{*}\)[49] & \(-4.843\pm 2.24\) & \(-6.629\pm 0.95\) & \(0.512\pm 0.11\) & \(0.310\pm 0.09\) & \(4.945\pm 0.27\) & \(0.826\pm 0.01\) & \(\mathbf{0.000\pm 0.00}\) \\ \cline{1-1} \cline{2-9}  & DiffSBDD-cond & \(-7.172\pm 1.88\) & \(-9.174\pm 2.13\) & \(0.430\pm 0.20\) & \(0.564\pm 0.12\) & \(4.526\pm 0.30\) & \(0.711\pm 0.08\) & \(\mathbf{0.000\pm 0.00}\) \\ \cline{1-1}  & DiffSBDD & \(-7.263\pm 4.19\) & \(-9.776\pm 2.25\) & \(0.546\pm 0.21\) & \(\mathbf{0.618\pm 0.12}\) & \(\mathbf{4.777\pm 0.54}\) & \(\mathbf{0.740\pm 0.05}\) & \(53\pm 31\) \\ \cline{1-1}  & **UniGuide** & \(-\mathbf{7.661\pm 2.59}\) & \(\mathbf{-9.864\pm 2.13}\) & \(\mathbf{0.556\pm 0.20}\) & \(0.605\pm 0.12\) & \(\mathbf{4.799\pm 0.50}\) & \(0.723\pm 0.05\) & \(55\pm 31\) \\ \hline \hline \end{tabular}
\end{table}
Table 8: Quantitative comparison of generated ligands for target pockets from the CrossDocked and Binding MOAD test sets. Results taken from Schneuing et al. [11] are indicated with \((^{*})\). We report mean and standard deviation and highlight the best diffusion-based approach in **bold**.

[MISSING_PAGE_FAIL:23]

[MISSING_PAGE_FAIL:24]

### General Fragment Conditions

To assess the performance of UniGuide for the task of FBDD, we create an experimental setup with the goal of generating ligands conditioned on desired fragments roughly following [13]. We select 10 random protein targets from the Binding MOAD dataset and decompose their corresponding reference ligands using an MMPA-based algorithm [75; 73]. This decomposition results in a set of \(40\) different scenarios, including separated fragments we want to link, a fragment to grow or small functional groups to perform scaffolding. For every set of fixed fragments, we aim to guide the unconditional generation of ligands towards the generation of a ligand containing the desired fragments. As the protein is not the target of the guidance, we employ the DiffSBDD-cond model, which is conditionally trained on the \((C_{\alpha})\)-representation of the protein pocket. For every set of fixed fragments, we generate \(100\) ligands and use a constant guidance scale of \(8\).

We provide quantitative results for the task of fragment-based drug design in Tab. 15. On the one hand, the task requires the desired fragments to be present in the generated molecule. Thus, we measure the success rate of recovery (Hit Ratio) and the RMSD between the generated fragments and desired fragments. On the other hand, given that the target fragments are met in the generated ligand, the generation has to achieve favourable chemical properties, high binding affinity, as well as high diversity within the set of generated ligands and low similarity to the reference ligand. As the Inpaint mechanism enforces the fragment during generation more strictly, it is able to achieve a better Hit Ratio and RMSD. Nevertheless, UniGuide achieves competitive results but also better VINA docking scores, better properties, and lower similarity compared to the reference ligand.

The FBDD task puts a hard constraint on the generated ligands, namely that a set of desired fragments has to be present in the generated ligand. However, neither DiffSBDD nor UniGuide can guarantee that the condition fragments are present in the generated samples.

We provide further qualitative results of the generated ligands for the FBDD task in Fig. 7.

\begin{table}
\begin{tabular}{l l c c c} \hline \hline  & & Validity (\(\uparrow\)) & Connectivity (\(\uparrow\)) & Uniqueness (\(\uparrow\)) & Novelty (\(\uparrow\)) \\ \hline \multirow{8}{*}{FBDD-cond} & Test Set & 100\% & 100\% & 96.00\% & 96.88\% \\ \cline{2-5}  & DiffSBDD-Cond (\(C_{\alpha}\)) & 95.32\% & 80.63\% & 99.97\% & 99.81\% \\ \cline{2-5}  & DiffSBDD-Cond & 97.32\% & 78.91\% & 99.99\% & 99.91\% \\ \cline{2-5}  & DiffSBDD (\(C_{\alpha}\)) & 99.20\% & 98.14\% & 99.26\% & 99.16\% \\ \cline{2-5}  & DiffSBDD & 97.76\% & 89.84\% & 99.94\% & 99.87\% \\ \cline{2-5}  & UniGuide (\(C_{\alpha}\)) & 99.12\% & 98.35\% & 99.50\% & 99.24\% \\ \cline{2-5}  & UniGuide & 97.40\% & 93.18\% & 99.93\% & 99.76\% \\ \hline \hline \multirow{8}{*}{FBDD-cond} & Test Set & 97.69\% & 100\% & 38.58\% & 77.55\% \\ \cline{2-5}  & DiffSBDD-cond (\(C_{\alpha}\)) & 94.43\% & 77.17\% & 100\% & 100\% \\ \cline{1-1} \cline{2-5}  & DiffSBDD-cond & 96.20\% & 63.20\% & 100\% & 100\% \\ \cline{1-1} \cline{2-5}  & DiffSBDD (\(C_{\alpha}\)) & 98.54\% & 91.45\% & 100\% & 100\% \\ \cline{1-1} \cline{2-5}  & DiffSBDD & 94.22\% & 75.60\% & 100\% & 100\% \\ \cline{1-1} \cline{2-5}  & UniGuide (\(C_{\alpha}\)) & 98.44\% & 93.12\% & 100\% & 99.99\% \\ \cline{1-1} \cline{2-5}  & UniGuide & 93.85\% & 79.95\% & 100\% & 100\% \\ \hline \hline \end{tabular}
\end{table}
Table 14: Additional metrics for the methods discussed in Sec. 5.2.

\begin{table}
\begin{tabular}{l l c} \hline \hline dataset & model & runtime (s) \\ \hline \multirow{2}{*}{CrossDocked (\(C_{\alpha}\))} & DiffSBDD-cond & \(60\pm 68\) \\  & DiffSBDD & \(141\pm 55\) \\  & **UnGüdé** & \(193\pm 61\) \\ \hline \multirow{2}{*}{Binding MOAD (\(C_{\alpha}\))} & DiffSBDD-cond & \(54\pm 42\) \\  & DiffSBDD & \(61\pm 17\) \\  & **UnGüdé** & \(104\pm 36\) \\ \hline \multirow{2}{*}{Binding MOAD (full)} & DiffSBDD-cond & \(345\pm 55\) \\  & DiffSBDD & \(398\pm 95\) \\  & **UnGüdé** & \(453\pm 120\) \\ \hline \hline \end{tabular}
\end{table}
Table 13: We evaluate the runtime of UniGuide and compare it to DiffSBDD-cond and DiffSBDD from Schneuing et al. [11]. We report the average time (in seconds) to generate \(100\) ligands per pocket for the CrossDocked (\(C_{\alpha}\)), Binding Moad (\(C_{\alpha}\)) and Binding Moad (fullatom).

## Appendix G Atom densities in 3D space

Similar to the guidance by the volume enclosed by the molecular surface, UniGuide allows to guide towards multiple point clouds simultaneously. A natural extension of LBDD would be to harness atom densities as described in Zaucha et al. [82]. Such a setting combines aspects of LBDD and SBDD as it provides conditions also on the feature space, yet the source can only be represented by point clouds.

In particular, we anticipate UniGuide to be useful in scenarios where explicit information about advantageous features of the ligand is provided in the form of 3D densities. Examples of this include a) volumetric densities that indicate beneficial placement of certain atom types, such as oxygen atoms [82] or b) pharmacophore-like retrieval of advantageous positions for aromatic rings, as utilised in e.g. Zhu et al. [83]. On a technical level, this setting assumes that instead of a reference ligand's structure, we only have access to (multiple) atom type densities that indicate preferred locations for optimal interaction with the protein. Additionally, instead of conditioning on a reference ligand's shape, we could condition on a protein pocket's surface, which primarily defines exclusion zones rather than precise atom placement.

\begin{table}
\begin{tabular}{r|c c}  & DiffSBDD & UniGuide \\ \hline \hline Vina (\(\downarrow\)) & -7.406 ± 0.79 & **-7.924 ± 0.89** \\ QED (\(\uparrow\)) & 0.612 ± 0.11 & **0.639 ± 0.09** \\ SA (\(\uparrow\)) & **0.703 ± 0.11** & 0.691 ± 0.10 \\ Lipinski (\(\uparrow\)) & 4.819 ± 0.28 & **4.875 ± 0.19** \\ \hline \hline Diversity (\(\uparrow\)) & 0.653 ± 0.28 & **0.669 ± 0.23** \\ Similarity (\(\downarrow\)) & **0.172 ± 0.02** & 0.177 ± 0.02 \\ \hline Validity (\(\uparrow\)) & 93.35 \% & **94.41 \%** \\ Connectivity (\(\uparrow\)) & 66.87 \% & **68.30 \%** \\ \end{tabular}
\end{table}
Table 15: Quantitative comparison between DiffSBDD and UniGuide for the FBDD task on the Binding MOAD (\(C_{\alpha}\)) dataset. As the condition in this FBDD scenario is a hard constraint that entails the condition to be exactly present in the generation, we add a post-hoc step for both methods where we replace the inpainted or guided parts with the exact condition atoms. We report mean and standard deviation and highlight the best method in **bold**.

Figure 7: Examples of the generated fragment conditioned ligands.

Adapting UniGuide for such scenarios requires only minor adjustments, as the protein surface can treated like shapes in standard LBDD, defining an exclusion zone based on proximity to the surface. The atom densities are thresholded to reflect regions of high interest and converted to surfaces using the marching cubes algorithm [84]. To also include feature information, we effectively employ a modified condition map similar to Eq. (21) that extends the transformation from the conformation to the configuration space. Moreover, the number of atoms guided by each density is adjusted based on its volume, reflecting the varying influence of each density, and guidance is only applied if atoms are sufficiently close.

We show explorative results for the guided generation of molecules towards desired atom densities using UniGuide in Fig. 8. While our current approach represents a promising first step in tackling this task, we acknowledge the potential for further refinement and are eager to explore future improvements within the UniGuide framework.

Figure 8: Given a source density of oxygens, we can extend UniGuide to generate ligands satisfying the condition.

### NeurIPS Paper Checklist

1. **Claims** Question: Do the main claims made in the abstract and introduction accurately reflect the paper's contributions and scope? Answer: [Yes] Justification: The claims made in the abstract and introduction reflect the paper's contribution and scope: Sec. 4 details how UniGuide is readily adaptable to various tasks in drug design, attesting to the unification provided by the UniGuide framework. Sec. 5 emphasises this aspect through competitive or superior performance across various tasks, even when compared to task-specific baselines. Guidelines: * The answer NA means that the abstract and introduction do not include the claims made in the paper. * The abstract and/or introduction should clearly state the claims made, including the contributions made in the paper and important assumptions and limitations. A No or NA answer to this question will not be perceived well by the reviewers. * The claims made should match theoretical and experimental results, and reflect how much the results can be expected to generalize to other settings. * It is fine to include aspirational goals as motivation as long as it is clear that these goals are not attained by the paper.
2. **Limitations** Question: Does the paper discuss the limitations of the work performed by the authors? Answer: [Yes] Justification: We discuss the limitations of UniGuide in Sec. 4. Guidelines: * The answer NA means that the paper has no limitation while the answer No means that the paper has limitations, but those are not discussed in the paper. * The authors are encouraged to create a separate "Limitations" section in their paper. * The paper should point out any strong assumptions and how robust the results are to violations of these assumptions (e.g., independence assumptions, noiseless settings, model well-specification, asymptotic approximations only holding locally). The authors should reflect on how these assumptions might be violated in practice and what the implications would be. * The authors should reflect on the scope of the claims made, e.g., if the approach was only tested on a few datasets or with a few runs. In general, empirical results often depend on implicit assumptions, which should be articulated. * The authors should reflect on the factors that influence the performance of the approach. For example, a facial recognition algorithm may perform poorly when image resolution is low or images are taken in low lighting. Or a speech-to-text system might not be used reliably to provide closed captions for online lectures because it fails to handle technical jargon. * The authors should discuss the computational efficiency of the proposed algorithms and how they scale with dataset size. * If applicable, the authors should discuss possible limitations of their approach to address problems of privacy and fairness. * While the authors might fear that complete honesty about limitations might be used by reviewers as grounds for rejection, a worse outcome might be that reviewers discover limitations that aren't acknowledged in the paper. The authors should use their best judgment and recognize that individual actions in favor of transparency play an important role in developing norms that preserve the integrity of the community. Reviewers will be specifically instructed to not penalize honesty concerning limitations.
3. **Theory Assumptions and Proofs**Question: For each theoretical result, does the paper provide the full set of assumptions and a complete (and correct) proof? Answer: [Yes] Justification: We discuss in Sec. 4 that the generative process retains equivariance with an appropriately chosen condition map and provide a full proof for this discussion in App. B. Guidelines:

* The answer NA means that the paper does not include theoretical results.
* All the theorems, formulas, and proofs in the paper should be numbered and cross-referenced.
* All assumptions should be clearly stated or referenced in the statement of any theorems.
* The proofs can either appear in the main paper or the supplemental material, but if they appear in the supplemental material, the authors are encouraged to provide a short proof sketch to provide intuition.
* Inversely, any informal proof provided in the core of the paper should be complemented by formal proofs provided in appendix or supplemental material.
* Theorems and Lemmas that the proof relies upon should be properly referenced.
4. **Experimental Result Reproducibility** Question: Does the paper fully disclose all the information needed to reproduce the main experimental results of the paper to the extent that it affects the main claims and/or conclusions of the paper (regardless of whether the code and data are provided or not)? Answer: [Yes] Justification: The setup of all experimental evaluations is described in App. E, App. F and App. D for the SBDD, FBDD and LBDD tasks respectively, including hyperparameters for UniGuide, dataset preprocessing and inference algorithms. For experimental evaluations performed according to previous work, we reference them accordingly. Guidelines: * The answer NA means that the paper does not include experiments. * If the paper includes experiments, a No answer to this question will not be perceived well by the reviewers: Making the paper reproducible is important, regardless of whether the code and data are provided or not. * If the contribution is a dataset and/or model, the authors should describe the steps taken to make their results reproducible or verifiable. * Depending on the contribution, reproducibility can be accomplished in various ways. For example, if the contribution is a novel architecture, describing the architecture fully might suffice, or if the contribution is a specific model and empirical evaluation, it may be necessary to either make it possible for others to replicate the model with the same dataset, or provide access to the model. In general. releasing code and data is often one good way to accomplish this, but reproducibility can also be provided via detailed instructions for how to replicate the results, access to a hosted model (e.g., in the case of a large language model), releasing of a model checkpoint, or other means that are appropriate to the research performed. * While NeurIPS does not require releasing code, the conference does require all submissions to provide some reasonable avenue for reproducibility, which may depend on the nature of the contribution. For example 1. If the contribution is primarily a new algorithm, the paper should make it clear how to reproduce that algorithm. 2. If the contribution is primarily a new model architecture, the paper should describe the architecture clearly and fully. 3. If the contribution is a new model (e.g., a large language model), then there should either be a way to access this model for reproducing the results or a way to reproduce the model (e.g., with an open-source dataset or instructions for how to construct the dataset).

4. We recognize that reproducibility may be tricky in some cases, in which case authors are welcome to describe the particular way they provide for reproducibility. In the case of closed-source models, it may be that access to the model is limited in some way (e.g., to registered users), but it should be possible for other researchers to have some path to reproducing or verifying the results.
5. **Open access to data and code** Question: Does the paper provide open access to the data and code, with sufficient instructions to faithfully reproduce the main experimental results, as described in supplemental material? Answer: [Yes] Justification: We made the code available as part of the supplementary material with the submission. We have included the link to UniGuide's project page, which will reference the public codebase. Guidelines: * The answer NA means that paper does not include experiments requiring code. * Please see the NeurIPS code and data submission guidelines ([https://nips.cc/public/guides/CodeSubmissionPolicy](https://nips.cc/public/guides/CodeSubmissionPolicy)) for more details. * While we encourage the release of code and data, we understand that this might not be possible, so "No" is an acceptable answer. Papers cannot be rejected simply for not including code, unless this is central to the contribution (e.g., for a new open-source benchmark). * The instructions should contain the exact command and environment needed to run to reproduce the results. See the NeurIPS code and data submission guidelines ([https://nips.cc/public/guides/CodeSubmissionPolicy](https://nips.cc/public/guides/CodeSubmissionPolicy)) for more details. * The authors should provide instructions on data access and preparation, including how to access the raw data, preprocessed data, intermediate data, and generated data, etc. * The authors should provide scripts to reproduce all experimental results for the new proposed method and baselines. If only a subset of experiments are reproducible, they should state which ones are omitted from the script and why. * At submission time, to preserve anonymity, the authors should release anonymized versions (if applicable). * Providing as much information as possible in supplemental material (appended to the paper) is recommended, but including URLs to data and code is permitted.
6. **Experimental Setting/Details** Question: Does the paper specify all the training and test details (e.g., data splits, hyperparameters, how they were chosen, type of optimizer, etc.) necessary to understand the results? Answer: [Yes] Justification: Both the discussion of the experiments provided in Sec. 5 as well as the supplementary information provided throughout the appendix ensures that the results are sufficiently contextualised for the reader. Guidelines: * The answer NA means that the paper does not include experiments. * The experimental setting should be presented in the core of the paper to a level of detail that is necessary to appreciate the results and make sense of them. * The full details can be provided either with the code, in appendix, or as supplemental material.
7. **Experiment Statistical Significance** Question: Does the paper report error bars suitably and correctly defined or other appropriate information about the statistical significance of the experiments? Answer: [Yes]Justification: Throughout the experimental evaluation we provide the mean and standard deviation for all metrics that can be computed e.g. per-sample or per-pocket to ensure statistical significance of the presented results. In cases where the metric aggregates the entire set of samples, we report the mean. Guidelines:

* The answer NA means that the paper does not include experiments.
* The authors should answer "Yes" if the results are accompanied by error bars, confidence intervals, or statistical significance tests, at least for the experiments that support the main claims of the paper.
* The factors of variability that the error bars are capturing should be clearly stated (for example, train/test split, initialization, random drawing of some parameter, or overall run with given experimental conditions).
* The method for calculating the error bars should be explained (closed form formula, call to a library function, bootstrap, etc.)
* The assumptions made should be given (e.g., Normally distributed errors).
* It should be clear whether the error bar is the standard deviation or the standard error of the mean.
* It is OK to report 1-sigma error bars, but one should state it. The authors should preferably report a 2-sigma error bar than state that they have a 96% CI, if the hypothesis of Normality of errors is not verified.
* For asymmetric distributions, the authors should be careful not to show in tables or figures symmetric error bars that would yield results that are out of range (e.g. negative error rates).
* If error bars are reported in tables or plots, The authors should explain in the text how they were calculated and reference the corresponding figures or tables in the text.
8. **Experiments Compute Resources** Question: For each experiment, does the paper provide sufficient information on the computer resources (type of compute workers, memory, time of execution) needed to reproduce the experiments? Answer: [Yes] Justification: We provide details on the hardware requirements for the training of the evaluated unconditional models in App. E.2, App. D.1 and App. C for the DiffSBDD, ShapeMol and EDM model respectively. Additionally, we provide runtime comparisons for the inference with UniGuide compared to the evaluated baselines in App. E.7. Guidelines: * The answer NA means that the paper does not include experiments. * The paper should indicate the type of compute workers CPU or GPU, internal cluster, or cloud provider, including relevant memory and storage. * The paper should provide the amount of compute required for each of the individual experimental runs as well as estimate the total compute. * The paper should disclose whether the full research project required more compute than the experiments reported in the paper (e.g., preliminary or failed experiments that didn't make it into the paper).
9. **Code Of Ethics** Question: Does the research conducted in the paper conform, in every respect, with the NeurIPS Code of Ethics [https://neurips.cc/public/EthicsGuidelines?](https://neurips.cc/public/EthicsGuidelines?) Answer: [Yes] Justification: The research presented in this work conforms with the NeurIPS Code of Ethics. Guidelines: * The answer NA means that the authors have not reviewed the NeurIPS Code of Ethics. * If the authors answer No, they should explain the special circumstances that require a deviation from the Code of Ethics.

* The authors should make sure to preserve anonymity (e.g., if there is a special consideration due to laws or regulations in their jurisdiction).
10. **Broader Impacts** Question: Does the paper discuss both potential positive societal impacts and negative societal impacts of the work performed? Answer: [Yes] Justification: We discuss the broader impact of our work in App. A. We discuss the positive societal impacts of the proposed unification and the resulting flexibility of unconditional models to be adapted to various new drug discovery tasks in Sec. 1 and Sec. 6. Guidelines: * The answer NA means that there is no societal impact of the work performed. * If the authors answer NA or No, they should explain why their work has no societal impact or why the paper does not address societal impact. * Examples of negative societal impacts include potential malicious or unintended uses (e.g., disinformation, generating fake profiles, surveillance), fairness considerations (e.g., deployment of technologies that could make decisions that unfairly impact specific groups), privacy considerations, and security considerations. * The conference expects that many papers will be foundational research and not tied to particular applications, let alone deployments. However, if there is a direct path to any negative applications, the authors should point it out. For example, it is legitimate to point out that an improvement in the quality of generative models could be used to generate deepfakes for disinformation. On the other hand, it is not needed to point out that a generic algorithm for optimizing neural networks could enable people to train models that generate Deepfakes faster. * The authors should consider possible harms that could arise when the technology is being used as intended and functioning correctly, harms that could arise when the technology is being used as intended but gives incorrect results, and harms following from (intentional or unintentional) misuse of the technology. * If there are negative societal impacts, the authors could also discuss possible mitigation strategies (e.g., gated release of models, providing defenses in addition to attacks, mechanisms for monitoring misuse, mechanisms to monitor how a system learns from feedback over time, improving the efficiency and accessibility of ML).
11. **Safeguards** Question: Does the paper describe safeguards that have been put in place for responsible release of data or models that have a high risk for misuse (e.g., pretrained language models, image generators, or scraped datasets)? Answer: [NA] Justification: The research discussed in this paper does not require safeguards to be put in place. Guidelines: * The answer NA means that the paper poses no such risks. * Released models that have a high risk for misuse or dual-use should be released with necessary safeguards to allow for controlled use of the model, for example by requiring that users adhere to usage guidelines or restrictions to access the model or implementing safety filters. * Datasets that have been scraped from the Internet could pose safety risks. The authors should describe how they avoided releasing unsafe images. * We recognize that providing effective safeguards is challenging, and many papers do not require this, but we encourage authors to take this into account and make a best faith effort.
12. **Licenses for existing assets** Question: Are the creators or original owners of assets (e.g., code, data, models), used in the paper, properly credited and are the license and terms of use explicitly mentioned and properly respected?Answer: [Yes] Justification: Where applicable, we credit and cite owners and authors of previous works and the accompanying codebases or datasets and provide the license under which the assets were made public. Guidelines:

* The answer NA means that the paper does not use existing assets.
* The authors should cite the original paper that produced the code package or dataset.
* The authors should state which version of the asset is used and, if possible, include a URL.
* The name of the license (e.g., CC-BY 4.0) should be included for each asset.
* For scraped data from a particular source (e.g., website), the copyright and terms of service of that source should be provided.
* If assets are released, the license, copyright information, and terms of use in the package should be provided. For popular datasets, paperswithcode.com/datasets has curated licenses for some datasets. Their licensing guide can help determine the license of a dataset.
* For existing datasets that are re-packaged, both the original license and the license of the derived asset (if it has changed) should be provided.
* If this information is not available online, the authors are encouraged to reach out to the asset's creators.

13. **New Assets** Question: Are new assets introduced in the paper well documented and is the documentation provided alongside the assets? Answer: [Yes] Justification: Accompanying the supplementary material, we provide documentation and instructions to navigate and utilise the UniGuide codebase. Guidelines:

* The answer NA means that the paper does not release new assets.
* Researchers should communicate the details of the dataset/code/model as part of their submissions via structured templates. This includes details about training, license, limitations, etc.
* The paper should discuss whether and how consent was obtained from people whose asset is used.
* At submission time, remember to anonymize your assets (if applicable). You can either create an anonymized URL or include an anonymized zip file.

14. **Crowdsourcing and Research with Human Subjects** Question: For crowdsourcing experiments and research with human subjects, does the paper include the full text of instructions given to participants and screenshots, if applicable, as well as details about compensation (if any)? Answer: [NA] Justification: This work did not conduct research on human subjects or crowdsourcing experiments. Guidelines:

* The answer NA means that the paper does not involve crowdsourcing nor research with human subjects.
* Including this information in the supplemental material is fine, but if the main contribution of the paper involves human subjects, then as much detail as possible should be included in the main paper.
* According to the NeurIPS Code of Ethics, workers involved in data collection, curation, or other labor should be paid at least the minimum wage in the country of the data collector.

15. **Institutional Review Board (IRB) Approvals or Equivalent for Research with Human Subjects** Question: Does the paper describe potential risks incurred by study participants, whether such risks were disclosed to the subjects, and whether Institutional Review Board (IRB) approvals (or an equivalent approval/review based on the requirements of your country or institution) were obtained? Answer: [NA] Justification: This work did not conduct experiments where human subject were involved and therefore does not require IRB approvals. Guidelines: * The answer NA means that the paper does not involve crowdsourcing nor research with human subjects. * Depending on the country in which research is conducted, IRB approval (or equivalent) may be required for any human subjects research. If you obtained IRB approval, you should clearly state this in the paper. * We recognize that the procedures for this may vary significantly between institutions and locations, and we expect authors to adhere to the NeurIPS Code of Ethics and the guidelines for their institution. * For initial submissions, do not include any information that would break anonymity (if applicable), such as the institution conducting the review.