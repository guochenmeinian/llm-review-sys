# Learning and Transferring Sparse Contextual Bigrams with Linear Transformers

 Yunwei Ren1   Zixuan Wang1   Jason D. Lee

Princeton University

{yunwei.ren, wangzx, jasonlee}@princeton.edu

Equal contribution.

Footnote 1: footnotemark:

###### Abstract

Transformers have excelled in natural language modeling and one reason behind this success is their exceptional ability to combine contextual informal and global knowledge. However, the theoretical basis remains unclear. In this paper, first we introduce the Sparse Contextual Bigram (SCB), a natural extension of the classical bigram model, where the next token's generation depends on a sparse set of earlier positions determined by the last token. We then analyze the training dynamics and sample complexity of learning SCB using a one-layer linear transformer with a gradient-based algorithm. We show that when trained from scratch, the training process can be split into an initial sample-intensive stage where the correlation is boosted from zero to a nontrivial value, followed by a more sample-efficient stage of further improvement. Additionally, we prove that, provided a nontrivial correlation between the downstream and pretraining tasks, finetuning from a pretrained model allows us to bypass the initial sample-intensive stage. We also empirically demonstrate that our algorithm can outperform SGD in this setting and discuss its relationship with the usual softmax-based transformers.

## 1 Introduction

Transformers have played a central role in modern deep learning, achieving significant success across various fields, including language modeling (OpenAI, 2023), computer vision (Dosovitskiy et al., 2020), and natural sciences (Jumper et al., 2021). The core of transformers is the self-attention layer (Vaswani et al., 2017), which can attend to any subset of the input sequence to output a weighted linear combination of the (transformed) tokens.

Several capabilities of the transformers contribute to their success in language modeling. First, they can extract contextual information from the input token sequences, which is essential in some arithmetic tasks (Edelman et al., 2022; Liu et al., 2022; Nanda et al., 2023; Yao et al., 2021). In addition, transformers can memorize global in-domain knowledge (Petroni et al., 2019; Zhang et al., 2023; Haviv et al., 2022; Carlini et al., 2021). These two abilities combined enable transformers to predict the next token based on the _in-context_ information as well as _global_ knowledge (OpenAI, 2023) acquired during training.

To theoretically understand how transformers learn both capabilities, we propose a minimalist data-generating model, the **Sparse Contextual Bigram** (SCB). This model builds on the classical bigram model and requires learning both contextual information and the (global) transition probabilities. Here, the next token depends on the transition matrix \(\bm{P}\) and a sparse set of prior tokens that is determined by the last token. In particular, SCB can be represented by a one-layer linear transformer -- a simplified architecture that can serve as an abstraction for studying transformer optimization (Ahn et al., 2023), which makes it suitable for theoretical analysis.

In this paper, we investigate the training dynamics and sample complexity of training a linear transformer to learn the SCB task using a stochastic gradient-based algorithm. Our contributions are summarized as follows:

* **Data model:** We introduce the **Sparse Contextual Bigram** (SCB) model, a simple task that requires the model to learn both in-context and global information.
* **Convergence:** We prove convergence guarantees for a one-layer linear transformer trained on with the nonconvex \(\ell_{1}\)-regularized MSE loss using preconditioned projected proximal descent, given a dataset sampled from the SCB model.
* **Sample Complexity:** Under mild conditions on the data distribution, initialization, and hyperparameters, we prove that our algorithm can recover the ground-truth with polynomial dependence on the sequence length \(T\), number of states \(N\), and the sparsity parameter \(Q\ll T\). We show that the training first goes through an initial sample-intensive stage which boosts the signal with \(\operatorname{poly}(T)\) samples, followed by a more sample-efficient stage to achieve final convergence with \(\operatorname{poly}(N,Q)\) samples. We empirically verify that our gradient-based methods converge to the ground truth with a small batch size, while unregularized stochastic gradient descent fails due to the large variance.
* **Transfer Learning:** We prove that, when there is a nontrivial correlation between the pretraining and downstream tasks, we can transfer a pre-trained model to bypass the first sample intensive stage, so that our algorithm converges to the ground truth of the downstream task with only \(\operatorname{poly}(N,Q)\) samples.

### Related works

Training dynamics of transformers.Several works have studied the learnability aspects of specific transformer architectures. Jelassi et al. (2022) demonstrated that a Vision Transformer (ViT) (Dosovitskiy et al., 2020) trained through GD, augmented with positional-embedding attention matrices, can effectively capture spatial structures. Li et al. (2023) investigated the sample complexity necessary to achieve good generalization performance on a similar ViT model. Tarzanagh et al. (2023) established a connection between the optimization landscape of self-attention and the formulation of a hard-margin Support Vector Machine (SVM) problem that separates and selects specific optimal tokens and established global convergence under strong assumptions. Tian et al. (2023, 2020) provided insights into the training dynamics of the self-attention and MLP layers, respectively, although they did not establish convergence guarantees.

Another line of work focuses on the training dynamics of in-context learning. Mahankali et al. (2023) was among the first to introduce linear regression as an in-context learning task, while Zhang et al. (2023) proved global convergence of gradient flow for a single-layer linear self-attention layer on this task. Huang et al. (2023) provided a convergence guarantee for a one-layer transformer with softmax attention on a similar task where the in-context tokens are drawn from a specific data distribution. Chen et al. (2024) generalized the single-task linear regression task to a multi-task setting and proved the global convergence of multi-head attention architecture using gradient flow on the population loss with specific initialization. In contrast, our work focuses on the language modeling ability of transformers instead of their in-context learning ability.

Several recent works analyzed transformers from a Markov chain perspective. Bietti et al. (2024) studied the in-context bigram (phrased as _induction head_) from an associative memory viewpoint. Nichani et al. (2024) proved that a simplified two-layer transformer can learn the induction head and generalize it to certain latent causal graphs. Edelman et al. (2024) further investigated training process on bigram and general \(n\)-gram tasks, and observed multi-phase dynamics. Makkuva et al. (2024) studied the loss landscape of transformers trained on sequences sampled from a single Markov Chain. Our SCB model extends the classical bigram models to allow context-dependent sparse attention on previous tokens.

Several works, including Tian et al. (2023); Zhang et al. (2023); Huang et al. (2023); Tarzanagh et al. (2023); Nichani et al. (2024); Kim and Suzuki (2024), and ours, use a similar reparameterization, consolidating the key and query matrices into a single matrix \(\bm{W}\) to simplify the dynamics of the training process. Most previous studies (Tian et al., 2023; Zhang et al., 2023; Huang et al., 2023; Tarzanagh et al., 2023; Nichani et al., 2024; Kim and Suzuki, 2024; Wang et al., 2024; Chen et al., 2024) uses population loss to simplify the analysis. In contrast, our work goes beyond the population loss to analyze the sample complexity of the stochastic gradient descent dynamics. Although Li et al. (2023) also investigated the sample complexity on a different task, their model requires a pre-trained initialization, while our model is trained from scratch.

**Transfer Learning.** Transfer learning (Devlin et al., 2018) has gained significant attention in this deep learning era. From a theoretical perspective, several works have investigated the statistical guarantees of transfer learning from the representation learning perspective (Tripuraneni et al., 2020; Du et al., 2020; Arora et al., 2019; Hanneke et al., 2023). Recent studies on transfer learning mostly focus on linear models (Li et al., 2022; Tian and Feng, 2023; Fei and Li, 2021; Zhang et al., 2022; Ju et al., 2023; Dar and Baraniuk, 2022). For dynamics of transfer learning, Lampinen and Ganguli (2018) studied the behaviors of multi-layer linear networks in a teacher-student setting, while Dhifallah and Lu (2021) analyzed single-layer perceptrons. Damian et al. (2022) showed that a two-layer neural network can efficiently learn polynomials dependent on a few directions, enabling transfer learning.

To the best of our knowledge, this is the first work studying transfer learning for transformers Moreover, unlike previous works that assume a shared structure between the pretraining and downstream tasks, we only require them to have a non-trivial correlation, which is a much weaker assumption.

### Outline of this paper

In Section 2 we formalize the problem setup, including the SCB task, the transformer architecture, and the training algorithm. Section 3 consists of our main results, and we analyze the population dynamics to provide intuitions. Section 4 contains our transfer learning results. Experimental results can be found in Section 5.

## 2 Setup

In this section, we describe our data-generating model, the one-layer linear transformer architecture, and the training algorithm.

**Notations.** We use \([T]\) to denote the set \(\{1,2,...,T\}\). Matrices and vectors are denoted in upper-case bold letters (\(\bm{A},\bm{V},\bm{\Delta}\), etc.) and lower-case bold letters (\(\bm{a},\bm{q}\), etc.), respectively. For norm, \(\|\cdot\|\) denotes \(\ell_{2}\) norm and \(\|\cdot\|_{F}\) denotes the Frobenius norm. Additionally, for \(\bm{\mu}\in\mathbb{R}^{N}\), \(\|\bm{A}\|_{\mu}\) denotes \(\mu\)-norm for matrix \(\bm{A}\in\mathbb{R}^{d\times N}\) for arbitrary \(d\), which is defined as \(\|\bm{A}\|_{\bm{\mu}}^{2}:=\operatorname{Tr}\left(\bm{A}\operatorname{diag} \left(\bm{\mu}\right)\bm{A}^{\top}\right)\). We use \(\mathbb{I}\left\{\cdot\right\}\) to denote the indicator function. We use \(\tilde{O}(\cdot)\) to hide logarithmic factors in the asymptotic notations.

### Data-generating model: Sparse Contextual Bigram

The bigram model, where the next token depends only on the current one, is arguably one of the simplest language models. To learn this model, it suffices to learn the transition probabilities \(\bm{P}\in\mathbb{R}^{N\times N}\) where \(P_{n,m}=\mathbb{P}[X_{t+1}=n\mid X_{t}=m]\), which is achievable through a linear model (0-layer transformer).

A natural way to extend the classical bigram model is to allow the next token to depend on a context-dependent set of previous tokens. This extension can model situations such as generating the words after the phrase "by Theorem 3.2", which requires us to retrieve the statement of "Theorem 3.2". Here, we propose a simple extension of this type, which we call the **Sparse Contextual Bigram** (SCB). The contextual information is encoded by a sparse probability vector \(\bm{q}\) determined by the last token. To generate the next token, the model retrieves the tokens referenced by \(\bm{q}\) and applies the transition matrix \(\bm{P}\) (global knowledge) to one of them according to the distribution \(\bm{q}\).

Formally, our data-generating model SCB can be described as follows. Let \(T\) be the sequence length and \([N]\) the vocabulary. Let \(\bm{P}\in\mathbb{R}^{N\times N}\) be a transition matrix, with column1\(\bm{P}_{k}\) being the transition probability vector of token \(k\). Suppose that \(\bm{\mu}\in\mathbb{R}^{N}_{\geq 0}\) is the stationary distribution of \(\bm{P}\).

Footnote 1: This differs from the convention of the usual Markov Chain literature where the rows are the transition probability vectors. We use this convention as it is more compatible with our notations.

Each input sequence consists of \(T+1\) tokens \((x_{1},\ldots,x_{T+1})\), i.i.d. sampled from distribution \(\bm{\mu}\). The output token (label) is generated as follows. For each \(k\in[N]\), there is a probability vector \(\bm{q}^{(k)}\in R^{T}_{\geq 0}\) that represents the tokens the model needs to attend to when the last token \(x_{T+1}\) is \(k\). For notational simplicity, we will write \(\bm{x}=(x_{1},\dots,x_{T})\), \(\bm{X}=(\bm{e}_{x_{1}},\dots,\bm{e}_{x_{T}})\) and \(\bm{Q}=(\bm{q}^{(1)},\dots,\bm{q}^{(N)})\in\mathbb{R}^{T\times N}\). When \(x_{T+1}=k\), the output token \(x_{o}\) is sampled from the distribution

\[\mathbb{P}(x_{o}=n\mid x_{T+1}=k,\bm{x})=\sum_{t=1}^{T}q_{t}^{(k)}\bm{P}_{n,x_{ t}},\quad\forall n\in[N].\] (1)

In words, we first sample a position \(s\in[T]\) according to \(\bm{q}^{(k)}\) and then run one step of the Markov Chain \(\bm{P}\) from \(x_{s}\) to generate \(x_{o}\). Note that this model can be represented by a one-layer linear transformer (see the next subsection for details). We make the following assumptions on SCB task.

**Assumption 2.1** (Sparse Contextual Bigram, SCB).: _In the SCB task, we assume the following:_

1. _(Q-sparse) For some_ \(Q\ll T\) _and each of_ \(\bm{q}^{(k)}\)_, at most_ \(Q\) _entries are nonzero._
2. _(Well-conditioned) There exists some constant_ \(C\geq 1\) _such that for every_ \(k\in[N]\) _and_ \(t\in[T]\)_,_ \(q_{t}^{(k)}\in[1/(CQ),C/Q]\) _if it is nonzero, and_ \(\mu_{k}\in[1/(CN),C/N]\)_._
3. _(Nontrivial transition)_ \(\left\lVert\bm{P}\right\rVert_{\mu}^{2}-\left\lVert\bm{\mu}\right\rVert^{2} \geq\left\lVert\bm{\mu}\right\rVert^{2}\)_._
4. _(Long sequence)_ \(T\geq(NQ)^{10}\)_._

**Remark on condition (c)**. We say the transition \(\bm{P}\) is trivial if the transition probability vectors are all the same, i.e., \(\bm{P}=\bm{\mu}\bm{1}^{\top}\). In this case, we have \(\left\lVert\bm{P}\right\rVert_{\mu}^{2}=\left\langle\bm{\mu}\bm{1}^{\top}, \bm{\mu}\bm{\mu}^{\top}\right\rangle=\left\lVert\bm{\mu}\right\rVert^{2}\). Requiring \(\left\lVert\bm{P}\right\rVert_{\mu}^{2}-\left\lVert\bm{\mu}\right\rVert^{2} \geq\left\lVert\bm{\mu}\right\rVert^{2}\) rules out situations where \(\bm{P}\) is too close to the trivial one. Also, note that for any well-conditioned \(\bm{\mu}\), we have \(\left\lVert\bm{\mu}\right\rVert^{2}\geq\Omega(1/N)\). \(\blacktriangle\)

In this work, we focus on the case where \((\bm{x},x_{T+1},x_{o})\) are given as (one data point of) the training data with \((x_{1},\dots,x_{T+1})\) i.i.d. sampled from \(\mu\). The SCB task can be extended to a sequence-to-sequence model: we drop \(x_{1}\) and append \(x_{o}\) to get a new input sequence \((x_{2},\dots,x_{T+1},x_{o})\), and then repeat the same sampling procedure to generate another token. This generates a sequence \((x_{t})_{t=1}^{\infty}\) where \((x_{T+2},x_{T+1},\dots)\) are not independent, and this makes our model a true language model. We leave the study of the more complicated learning-from-\((x_{t})_{t=1}^{\infty}\) task to future works.

### Transformer architecture

Our learner model is a one-layer single-head linear transformer (Akyurek et al., 2022; Zhang et al., 2023; Ahn et al., 2023). A general linear transformer can be expressed as: \(\bm{F}(\bm{x},x_{T+1};\bm{V},\bm{A})=\bm{V}\bm{E}\left(\bm{E}^{\top}\bm{A}\bm{E}\right),\) where \(\bm{E}\) is the embedding of the input tokens and positions, and \(\bm{A}\), \(\bm{V}\) are the parameters of the attention and output layers, respectively. In our setting, we only need a simpler model:

\[\bm{F}(\bm{x},x_{T+1};\bm{V},\bm{A}):=\bm{V}\bm{X}\left(\bm{I}_{T}\bm{A}\bm{e}_ {x_{T+1}}\right)=:\bm{V}\bm{X}\bm{a}^{(x_{T+1})},\] (2)

where \(\bm{V}\in\mathbb{R}^{N\times N}\) and \(\bm{A}\in\mathbb{R}^{T\times N}\) are the trainable parameters, and \(\bm{a}^{(k)}\) denotes the \(k\)-th column of \(\bm{A}\). This model uses cross-attention (replacing the last \(\bm{E}\) with \(\bm{e}_{x_{T+1}}\)), uses only the positional embeddings together with the last token to compute the attention weights (replacing the second \(\bm{E}\) with \(\bm{I}_{T}\)), and discards the positional embeddings in the output layer (replacing the first \(\bm{E}\) with \(\bm{X}\)). This is equivalent to manually set certain blocks in the weight matrices to \(0\), which is a common practice in the theoretical literature to simplify the analysis (Nichani et al., 2024; Huang et al., 2023; Zhang et al., 2023).

Note that our data-generating model (1) can be represented using (2) by setting \(\bm{A}=\bm{Q}\) and \(\bm{V}=\bm{P}\). We will show that a modified version of SGD can approximately recover this ground-truth model.

### Training algorithm

We assume that the stationary distribution \(\bm{\mu}\) and certain norms of the ground-truth \(\bm{P}\) and \(\bm{Q}\) are known when choosing the initialization and learning rate. The goal here is to recover \(\bm{P}\) and \(\bm{Q}\). Our loss function is the \(\ell_{1}\)-regularized MSE loss. The standard way to optimize an \(\ell_{1}\)-regularized loss is to use the proximal gradient descent. We adopt this algorithm with several additional pre-conditioning and a projection step to ensure some basic properties.

Formally, let the per-sample loss be defined as

\[l(\bm{x},x_{T+1},x_{o};\bm{V},\bm{A}):=\frac{1}{2}\left\|\bm{e}_{x_{o}}-\bm{V}\bm{ X}\bm{A}\bm{e}_{x_{T+1}}\right\|^{2}.\] (3)

We initialize \(\bm{A}=\bm{1}_{T}\bm{1}_{N}^{\top}/T\) to have uniform attention and \(\bm{V}=\bm{\mu}\bm{1}^{\top}\) to be the trivial transition. At each step \(\tau\geq 0\), we sample \(B_{\tau}\) fresh samples \(\{\bm{x}^{(i)},x_{T+1}^{(i)},x_{o}^{(i)}\}_{i=1}^{B_{\tau}}\) to form a mini-batch. The \(\ell_{1}\)-regularized mini-batch loss is defined as

\[l_{\text{reg}}^{(B_{\tau},\lambda)}\left(\{\bm{x}^{(i)},x_{T+1}^{(i)},x_{o}^{ (i)}\}_{i=1}^{B_{\tau}};\bm{V},\bm{A}\right):=\frac{1}{B_{\tau}}\sum_{i=1}^{B _{\tau}}l(\bm{x}^{(i)},x_{T+1}^{(i)},x_{o}^{(i)};\bm{V},\bm{A})+\lambda\sum_{ k=1}^{N}\left\|\bm{a}^{(k)}\right\|_{1},\]

where \(\lambda>0\) is a parameter that controls the strength of regularization. Let \(\nabla_{\bm{V}}^{(B_{\tau})}l\) and \(\nabla_{\bm{A}}^{(B_{\tau})}l\) denote the mini-batch gradients of the original \(l\) w.r.t. \(\bm{V}\) and \(\bm{A}\), respectively. We then define the preconditioned gradients as

\[\begin{split}\nabla_{\bm{V}}^{(B_{\tau})}l&:= \left(\bm{I}_{N}-\frac{\bm{1}_{N}\bm{1}_{N}^{\top}}{N}\right)\left(\nabla_{\bm {V}}^{(B_{\tau})}l\right)\text{diag}(1/\bm{\mu})\left(\bm{I}_{N}-\frac{\bm{ \mu}\bm{\mu}^{\top}}{\left\|\bm{\mu}\right\|^{2}}\right),\\ \nabla_{\bm{a}^{(k)}}^{(B_{\tau})}l&:=\frac{1}{\mu_ {k}}\left(\bm{I}_{T}-\frac{\bm{1}_{T}\bm{1}_{T}^{\top}}{T}\right)\left(\nabla_ {\bm{a}^{(k)}}^{(B_{\tau})}l\right),\quad\forall k\in[N].\end{split}\] (4)

Here, the \(1/\bm{\mu}\) rescaling plays a role similar to importance sampling. We multiply \(\nabla_{\bm{V}}^{(B_{\tau})}l\) with \(\bm{I}-\bm{1}\bm{1}^{\top}/N\) and \(\bm{I}-\bm{\mu}\bm{\mu}^{\top}/\left\|\bm{\mu}\right\|^{2}\) to ensure at least \(\bm{1}_{N}^{\top}\bm{V}=\bm{1}_{N}^{\top}\), \(\bm{1}_{T}^{\top}\bm{A}=\bm{1}_{N}^{\top}\), and \(\bm{V}\bm{\mu}=\bm{\mu}\) always hold throughout training. Note that we project each column of \(\bm{V}\) to the affine space \(\{\bm{v}\in\mathbb{R}^{T}\,:\,\bm{1}^{\top}\bm{v}=1\}\) instead of the probability simplex. This is sufficient for our analysis and is much easier to compute than the latter. We update the output layer using

\[\bm{V}_{\tau+1}=\bm{V}_{\tau}-\eta_{V}\,\nabla_{\bm{V}}^{(B_{\tau})}l,\] (5)

where \(\eta_{V}>0\) is the step size. Now, consider the attention layer. Due to the existence of the \(\ell_{1}\)-regularization, the update rule becomes a simple variant of the standard proximal gradient descent. Formally, for step size \(\eta_{A}>0\), each \(k\in[N]\) and \(t\in[T]\), we have

\[\begin{split}\bm{a}_{\tau+1}^{(k,\tau)}&=\bm{a}_{ \tau}^{(k)}-\frac{\eta_{A}}{\mu_{k}}\nabla_{\bm{a}^{(k)}}^{(B_{\tau})}l,& \text{(preconditioned GD step)},\\ \bm{a}_{t,\tau+1}^{(k,\tau)}&=\begin{cases}a_{t, \tau+1}^{(k,\tau)}-\lambda,&\text{if }a_{t,\tau+1}^{(k,\tau)}\geq\lambda,\\ 0,&\text{if }\left|a_{t,\tau+1}^{(k,\tau)}\right|\leq\lambda,\end{cases},& \text{(proximal step)},\\ \bm{a}_{\tau+1}^{(k)}&=\begin{cases}\text{Proj}\\ \bm{(1}^{\top}\bm{a}=1)\end{cases}\left(\bm{a}_{\tau+1}^{(k,\tau)}\right)=\bm{a }_{\tau+1}^{(k,\tau)}+\left(1-\bm{1}^{\top}\bm{a}_{\tau+1}^{(k,\tau)}\right) \frac{\bm{1}}{T},&\text{(projection step)}.\end{cases}\end{split}\] (6)

For the proximal step, we will later show that no \(a_{t}^{(k)}\) can ever become smaller than \(-\lambda\), so it suffices to consider those two cases. During the proximal step, all small \(a_{t}^{(k)}\) are set to \(0\), and \(\lambda\) is subtracted from all large coordinates. For notational simplicity, we define \(\bm{g}_{\lambda,\tau}^{(k)}:=-\eta_{A}^{-1}(\bm{a}_{\tau+1}^{(k)}-\bm{a}_{\tau }^{(k)})\) so that we can write the update as \(\bm{a}_{\tau+1}^{(k)}=\bm{a}_{\tau}^{(k)}-\eta_{A}\bm{g}_{\tau}^{(k)}\). We will choose \(\lambda=0\) in certain stages of training. In this case, (6) becomes the usual projected preconditioned gradient descent and we have

\[\bm{a}_{\tau+1}^{(k)}=\bm{a}_{\tau}^{(k)}-\eta_{A}\nabla_{\bm{a}^{(k)}}^{(B_{ \tau})}l\qquad\text{(when $\lambda=0$)}.\]

Our algorithm consists of three stages with different hyperparameters being used in different stages and certain rounding required between stages. The pseudocode is given in Algorithm 1 and more details on the projection/normalization steps are provided in Appendix E and F. When we train the model from scratch, all three stages are used and the initialization is \(\bm{V}_{0}=\bm{\mu}\bm{1}^{\top}\) and \(\bm{A}=\bm{1}_{T}\bm{1}_{N}^{\top}/T\).

**Transfer learning.** When doing transfer learning, the initialization will be obtained from the weights of the pre-trained model and one step of gradient update. Then, we will run Algorithm 1 from Stage 2.

## 3 Results for training from scratch

In this section, we consider the situations where we train the model from scratch, i.e., the initialization is \(\bm{V}_{0}=\bm{\mu}\bm{1}^{\top}\) and \(\bm{A}_{0}=\bm{1}\bm{1}^{\top}/T\) and discuss the ideas of the proof of the following theorem.

**Theorem 3.1** (Theorem G.1).: _Let \(\varepsilon>0\) be our target accuracy and \(\mathcal{T}_{1}=\min\{\tau\geq 0:\max\{\alpha_{V,\tau},\alpha_{A,\tau}\}\geq \Theta(1/(QN))\}\). We can choose the hyperparameters in Algorithm 1 such that within \(\operatorname{poly}(N,Q,1/\varepsilon,\log T)\) steps, we have \(\left\lVert\bm{A}-\bm{Q}\right\rVert_{\mu}^{2}\leq\varepsilon\) and \(\left\lVert\bm{V}-\bm{P}\right\rVert_{\mu}^{2}\leq\varepsilon\) with probability at least \(1-\delta\) and the numbers of samples used before and after \(\mathcal{T}_{1}\) are \(\operatorname{poly}(T,\delta)\) and \(\operatorname{poly}(N,Q,1/\varepsilon,\log T,\delta)\), respectively._

The overall strategy is analyzing the population process and then controlling the distance between the mini-batch trajectory and the population process2. In Section 3.1, we discuss the key properties of the population process that simplify the analysis. After that, we describe the dynamics of the algorithm and the signal-noise-ratio (SNR) in each of the three stages of Algorithm 1 in Section 3.2\(\sim\)3.4.

Footnote 2: Strictly speaking, what we actually control is the distance of the mini-batch trajectory to the subspace the population process lies. This allows us to prevent the potential exponential growth of the error caused by error compounding in the analysis. For details on this technique, see Appendix C.

### The population process

In this subsection, we analyze the behavior of the population process and the evolution of the signal-noise ratio. More details can be found in Appendix C, where the so-called population projected process are defined and rigorously analyzed.

For ease of presentation, we assume \(\lambda=0\) and access to the population loss \(\mathcal{L}:=\mathbb{E}\,l\). In other words, we consider the projected preconditioned gradient descent. By Lemma B.8, the dynamics of the population process is controlled by

\[\begin{split}\bm{V}_{\tau+1}&=\bm{V}_{\tau}-\eta_{ V}\left(\left\lVert\bm{A}\right\rVert_{\mu}^{2}\left(\bm{V}-\bm{\mu}\bm{1}^{ \top}\right)-\left\langle\bm{Q},\bm{A}\right\rangle_{\mu}\left(\bm{P}-\bm{ \mu}\bm{1}^{\top}\right)\right),\\ \bm{A}_{\tau+1}&=\bm{A}_{\tau}-\eta_{A}\left(\left( \left\lVert\bm{V}\right\rVert_{\mu}^{2}-\left\lVert\bm{\mu}\right\rVert^{2} \right)\left(\bm{a}^{(k)}-\frac{1}{T}\right)-\left(\left\langle\bm{V},\bm{P} \right\rangle_{\mu}-\left\lVert\bm{\mu}\right\rVert^{2}\right)\left(\bm{q}^{( k)}-\frac{1}{T}\right)\right).\end{split}\] (7)

One can prove via induction on \(\tau\) that \(\bm{V}\) (resp. \(\bm{A}\)) always stays on the straight line crossing \(\bm{\mu}\bm{1}^{\top}\) and \(\bm{P}\) (resp. \(\bm{1}\bm{1}^{\top}/T\) and \(\bm{Q}\)). In other words, there exists some time-dependent real numbers \(\alpha_{V,\tau}\), \(\alpha_{A,\tau}\), \(\beta_{V,\tau}:=1-\alpha_{V,\tau}\), \(\beta_{A,\tau}:=1-\alpha_{A,\tau}\) such that \(\bm{V}_{\tau}=\alpha_{V,\tau}\,\bm{P}+\beta_{V,\tau}\,\bm{\mu}\bm{1}^{\top}\) and \(\bm{A}_{\tau}=\alpha_{A,\tau}\bm{Q}+\beta_{A,\tau}\,\bm{1}\bm{1}^{\top}/T\). The same calculation yields the following equations that govern the dynamics of \(\alpha_{V}\) and \(\alpha_{A}\):

\[\begin{split}\alpha_{V,\tau+1}&=\alpha_{V,\tau}+ \eta_{V}K_{Q}\,\left(1-\alpha_{A}\alpha_{V}\right)\alpha_{A}+\eta_{V}\frac{1- \alpha_{V}}{T},\\ \alpha_{A,\tau+1}&=\alpha_{A,\tau}+\eta_{A}K_{P}\, \left(1-\alpha_{V}\alpha_{A}\right)\alpha_{V},\end{split}\]

where \(\alpha_{V,0}=\alpha_{A,0}=0\), \(K_{P}:=\left\lVert\bm{P}\right\rVert_{\mu}^{2}-\left\lVert\bm{\mu}\right\rVert ^{2}\gtrsim 1/N\) and \(K_{Q}:=\left\lVert\bm{Q}\right\rVert_{\mu}^{2}-1/T\gtrsim 1/Q\). Choose \(\eta_{V}=\eta/K_{Q}\) and \(\eta_{A}=\eta/K_{P}\), and we can write the above in matrix form as

\[\begin{bmatrix}\alpha_{V,\tau+1}\\ \alpha_{A,\tau+1}\end{bmatrix}=\eta(1-\alpha_{A}\alpha_{V})\begin{bmatrix}0&1 \\ 1&0\end{bmatrix}\begin{bmatrix}\alpha_{V,\tau}\\ \alpha_{A,\tau}\end{bmatrix}+\frac{\eta}{K_{Q}}\begin{bmatrix}(1-\alpha_{V})/T \\ 0\end{bmatrix}.\] (8)Hence, in order to analyze the population process, it suffices to analyze the above 2-dimensional ODE. In what follows, when we say the signal, we usually refer to these \(\alpha\)'s or some quantities whose size is proportional to them. In particular, as one can see from (8), the size of the expected gradients is proportional to \(\alpha_{V}\) and/or \(\alpha_{A}\)3.

Footnote 3: We will often drop the time subscript \(\tau\) and write \(\alpha_{V}:=\alpha_{V,\tau}\) for simplicity.

Note that when both \(\alpha_{V},\alpha_{A}\) are still small, the population dynamics of \(\alpha_{V},\alpha_{A}\) are a linear system with coefficient matrix \(\eta\left[\begin{smallmatrix}0&1\\ 1&0\end{smallmatrix}\right]\) and drift \(\left[\begin{smallmatrix}\eta T/K_{Q}\\ 0\end{smallmatrix}\right]\). The drift term will provide a small initial signal that guides the process toward the correct direction and then the linear term will amplify this signal. Since the linear term is close to \(0\) at initial and the initial signal provided by the drift term has order \(1/T\), we should expect that \(\operatorname{poly}T\) samples are necessary to distinguish it from noises (Stage 1). After the signal becomes reasonably large, the first term will have order \(1/\operatorname{poly}(N,Q)\), and we can then rely on it (combined with the \(\dot{l}_{1}\)-regularization) instead of the drift term to learn the model (Stage 2).

### Stage 1: boosting the signal

At initialization, we have \(\alpha_{V}=\alpha_{A}=0\). We define Stage 1 to be the phase until at least one of them has grown from \(0\) to some small \(\sigma_{1}=1/\operatorname{poly}(N,Q)\). Note that in this stage, the mini-batch version of (8) is approximately equivalent to

\[\begin{bmatrix}\alpha_{V,\tau+1}\\ \alpha_{A,\tau+1}\end{bmatrix}\approx\eta\begin{bmatrix}0&1\\ 1&0\end{bmatrix}\begin{bmatrix}\alpha_{V,\tau}\\ \alpha_{A,\tau}\end{bmatrix}+\frac{\eta}{K_{Q}}\begin{bmatrix}1/T\\ 0\end{bmatrix}+\bm{\varepsilon}_{\texttt{noise}}+\bm{\varepsilon}_{\texttt{ approx}},\] (9)

where \(\bm{\varepsilon}_{\texttt{noise}}\) and \(\bm{\varepsilon}_{\texttt{approx}}\) represent the errors introduced by the difference between the mini-batch and population gradients, and the fact that we are not exactly on the population trajectory. If we had infinite amount of samples so that both \(\bm{\varepsilon}_{\texttt{noise}}\) and \(\bm{\varepsilon}_{\texttt{approx}}\) were \(0\), then the second term on the RHS of (9) could provide a small positive signal to \(\alpha\) and the first term would quickly boost it to \(\sigma_{1}\) within \(\mathcal{T}_{1}=\log(T)/\eta\) iterations. In order for the above analysis to work, we need both \(\bm{\varepsilon}_{\texttt{noise}}\) and \(\bm{\varepsilon}_{\texttt{approx}}\) to be at least \(O(1)/T\) small. Since, unfortunately, \(\bm{\varepsilon}_{\texttt{noise}}\) does not scale with \(1/T\), we need \(\operatorname{poly}(T)\) samples to ensure these conditions.

We conjecture that this \(\operatorname{poly}(T)\) dependence is unavoidable (when only a polynomial amount of computing time is available). That is because around the initialization, the only signal comes from the second term and the first term amplifies whatever the second term provides, even if it has been corrupted by the errors. It either takes \(\operatorname{poly}(T)\) fresh samples each step to reveal the signal or \(\operatorname{poly}(T)\) steps (whence also \(\operatorname{poly}(T)\) samples) for the random noises to (hopefully) cancel with each other.

### Stage 2: learning the model

We know that at the end of Stage 1, at least one of \(\alpha_{V}\) and \(\alpha_{A}\) is \(\sigma_{1}=1/\operatorname{poly}(Q,N)\) large. Hence, one may expect that the signal is \(1/\operatorname{poly}(Q,N)\) large now so that we no longer need to make the noises \(1/T\) small and therefore, only \(\operatorname{poly}(N,Q)\) samples are needed. Unfortunately, this argument will not work directly, since the variance of the mini-batch gradients scales with \(T\).4 Therefore, we still need \(\operatorname{poly}(T)\) samples to reduce the squared \(\ell_{2}\)-norm of \(\bm{\varepsilon}_{\texttt{noise}}\) from \(\Omega(T)\) to \(1/\operatorname{poly}(Q,N)\). To address this issue, we introduce the \(\ell_{1}\)-regularizer and use a variant of proximal gradient descent.

Footnote 4: It is possible almost explicitly to compute the covariance matrix through some tedious calculation. Intuitively, the reason it scale with \(T\) is \(\nabla_{\bm{q}^{(k)}}l\) has \(T\) entries with most of them almost uncorrelated in a certain sense.

The idea is, while the concentration in the \(\ell_{2}\) sense is difficult, controlling the \(\ell_{\infty}\)-error is easy as every entry of \(\nabla_{\bm{q}^{(k)}}l\) is bounded whence subgaussian. As a result, we can make the coordinate-wise difference between the population and mini-batch gradients \(1/\operatorname{poly}(N,Q)\) small using only \(\operatorname{poly}(N,Q)\)\(\log T\) samples by a standard concentration argument. Moreover, we have (cf. the proof of Lemma E.3)

\[-\operatorname{\mathbb{E}}\partial_{\alpha_{t}^{(k)}}l=\mu_{k}\alpha_{V}K_{P} \left(q_{t}^{(k)}-\alpha_{V}a_{t}^{(k)}\right)=\mu_{k}\alpha_{V}K_{P}\times \begin{cases}\Omega(1/Q),&\text{if }q_{t}^{(k)}\neq 0,\\ O(\alpha_{V}a_{t}^{(k)}),&\text{if }q_{t}^{(k)}=0.\end{cases}\] (10)

Thus, as long as \(\alpha_{V}\geq 1/\operatorname{poly}(N,Q)\), the \(\ell_{\infty}\)-norm of the gradient noise being small is enough to create a separation between those useful entries (\(q_{t}^{(k)}\neq 0\)) and useless entries (\(q_{t}^{(k)}=0\)) and ensure the \(\ell_{2}\)-error of those \(Q\) useful entries is small.

The above analysis suggests removing all small entries from the gradient will work. Now, we claim that \(\ell_{1}\)-regularization and proximal gradient descent naturally implement this strategy, at least approximately. We believe softmax-based attention layers also automatically implement this strategy. See Section 5 for more discussion on the relationship between our model and softmax transformers.

Note that, at the end of Stage 1 and after the thresholding-projection step -- which is approximately equivalent to running one proximal step first -- we know that all useful \(a_{t}^{(k)}\) are at least \(\Omega(\alpha_{V}/Q)=1/\mathrm{poly}(N,Q)\), while all useless entries are of size \(O(1)/T\). By our previous discussion, we know that if \(\lambda\) is chosen appropriately, with \(\mathrm{poly}(N,Q,\log T)\) samples, the gradients w.r.t. those useful entries can be made approximately correct, while the gradients w.r.t. those useless entries are much smaller than \(\lambda\). Thus, after one gradient step, the absolute value of each of those useless \(a_{t}^{(k)}\) is still much smaller than \(\lambda\). As a result, they will be set to \(0\) in the proximal step (and to \(O(1/T)\) after the projection step), which is equivalent to filtering out all those entries, up to a small bias. Therefore, the proximal gradient updates stay close to the population trajectory, and the growth of the signals \(\alpha_{A},\alpha_{V}\) can be analyzed using the population dynamics.

We end Stage 2 when \((\alpha_{V}+\alpha_{A})/2\approx 1\). Similar to Stage 1, this also only takes \(\mathcal{T}_{2}=\tilde{O}(1/\eta)\) steps. We also show that the difference between the mini-batch trajectory and the "population trajectory" can decrease to a small value (cf. Lemma E.10). This allows us to decouple the error introduced by Stage 1 and the target accuracy. We defer the proof details to Appendix E.

### Stage 3: final rounding and convergence

The purpose of Stage 3 is to fix a minor issue regarding \(|\alpha_{V}-\alpha_{A}|\). Taylor expand (8) around \((\alpha_{A},\alpha_{V})=(1,1)\) and one will notice that although \((\alpha_{V}+\alpha_{A})/2\) can converge to \(1\) at a linear rate (and the approximation error also decreases exponentially fast), the convergence rate of \(\alpha_{A}-\alpha_{V}\) is much slower, and the process will get stuck around \((1+\delta,1-\delta)\) for some small nonzero \(\delta\), instead of converging to \((1,1)\). To accelerate this process, we directly round \(A\) via normalization, which is possible only after the approximation error becomes small in Stage 2. Then we freeze \(A\) and train \(V\) to the desired accuracy. More details about this stage can be found in Appendix F.

## 4 Results for transfer learning

The transferability of neural networks and transformers and their benefits have been widely observed and studied in both practice and theory. It is often assumed that the downstream and pretraining tasks share a common structure or representations/features, and these models can learn these common structures during training, and then leverage them in fine-tuning.

In this section, we offer a different perspective: as long as there is a (potentially small) nontrivial correlation between the pretraining and downstream tasks, the pretrained model can be used to provide a nonzero initial signal, allowing us to bypass the initial sample-intensive signal-boosting stage.

Formally, we consider the following setting. Let \(\hat{\bm{P}}\) be the transition matrix of the pretraining task and \((\bm{P},\bm{Q})\) the transition matrix and \(\bm{Q}\)-matrix of the downstream task. We still assume Assumption 2.1. In addition, we assume \(\hat{\bm{P}}\) and \(\bm{P}\) share the same stationary distribution \(\bm{\mu}\), \(\left\lVert\hat{\bm{P}}\right\rVert_{\mu}^{2}=\Theta(1)\left\lVert\bm{P} \right\rVert_{\mu}^{2}\) and \(\left\langle\hat{\bm{P}},\bm{P}\right\rangle_{\mu}-\left\lVert\bm{\mu}\right\rVert ^{2}\geq\left\lVert\bm{\mu}\right\rVert^{2}.\) The last condition can be viewed as the transfer learning version of condition (c) of Assumption 2.1. Note that we allow the correlation between \(\hat{\bm{P}}\) and \(\bm{P}\) to be as small as \(o(1)\).

**Theorem 4.1** (informal version of Theorem H.3).: _Consider the above setting. Initialize \(\bm{A}=\bm{1}\bm{1}^{\top}/T\), \(\bm{V}=\theta\hat{\bm{P}}+(1-\theta)\bm{\mu}\bm{1}^{\top}\) for some small \(\theta>0\), and run one step of gradient update on \(\bm{A}\). Then, running Algorithm 1 from Stage 2 allows us to recover \((\bm{P},\bm{Q})\) to \(\varepsilon\)-accuracy with high probability with \(\mathrm{poly}(N,Q,1/\varepsilon,\log T)\) samples._

To intuitively see why using \(\mathrm{poly}(N,Q,1/\varepsilon,\log T)\) samples is possible, recall from (9) that the reason we need \(\mathrm{poly}(T)\) samples in Stage 1 is the signal is additive and has order \(O(1/T)\), so we need the size of the noise to be at most \(O(1/T)\). On the other hand, when we initialize \(\bm{V}=\theta\hat{\bm{P}}+(1-\theta)\bm{\mu}\bm{1}^{\top}\), we have \(\alpha_{V}\geq\Theta(\theta/(NK_{P}))\gg 1/T\). Then we can rely on \(\alpha_{V}\), instead of the \(1/T\)-sized additive signal, to boost the signal of \(\alpha_{A}\) to \(\omega(1/T)\) in one step, which leads to a sample complexity that depends on \(\alpha_{V}\) instead of the \(1/T\)-sized additive signal. Then, we can reuse the analysis of Stage 2 and 3 to show that the downstream \((\bm{P},\bm{Q})\) can be approximately recovered using \(\mathrm{poly}(N,Q,1/\varepsilon,\log T)\).

Note that unlike the case of training from scratch, when performing transfer learning, the initial approximation error \(\left\|\bm{\Lambda}_{\bm{V}}\right\|_{\bm{\mu}}\), i.e., the distance between \(\bm{V}\) and its population projection, can be much larger than the signal \(\alpha_{\bm{V}}\), and it might seem unreasonable to expect that we can leverage the small signal in the presence of a large approximation error. To handle this issue, we show that the _influence_ of \(\left\|\bm{\Lambda}_{\bm{V}}\right\|_{\bm{\mu}}^{2}\) on the dynamics scales with \(\alpha_{A}(\approx\alpha_{\bm{V}})\), which is small. In addition, we also show that as long as \(\alpha_{A}\) is bounded away from \(0\) and the batch size is large, the approximation error will not grow. This allows us to ignore the approximation errors in the signal-boosting stage until we enter the regime of the Stage 2 analysis.

## 5 Experiments and relationship with softmax transformers

This section contains our experimental results. We also discuss the relationship between our linear model and the usual softmax transformers.

Experiment setupWe use the same shallow transformer model (2) to train on the synthetic data. The data distribution follows the SCB model (1) with a randomly sampled transition matrix \(\bm{P}\) together with its stationary \(\mu\), and the ground truth attention pattern \(\bm{Q}\). We choose the number of states \(N=3\), sparsity \(Q=2\), and the sequence length \(T=5000\gg N,\bar{Q}\). We use a batch size \(B=64\) to run the online projected proximal gradient descent with \(\lambda=1\text{e-}5\) and the vanilla SGD for \(\mathcal{T}=1000\) iterations. Through the signal boosting stage \(\tau\in[0,400]\), we use \(\eta_{1}=0.01\) to accelerate the process. After \(\tau>400\), we use \(\eta_{2}=0.005\) for further improvement. For SGD, we add another set of experiments with \(\eta_{2}^{\prime}=0.001\) to prevent potential instability. For more details, see Appendix I.

### Convergence

Our experiments (cf. Fig. 1) show that after switching to proximal gradient descent after Stage 1 (the signal-boosting stage), both \(\left\|\bm{P}-\bm{V}\right\|_{\bm{\mu}}\) and \(\left\|\bm{A}-\bm{Q}\right\|_{\bm{\mu}}\) decrease faster than SGD. The final distance to the ground-truth after normalization gets close to \(0\), and the similarity between the ground truth and parameters quickly converges close to \(1\). In comparison, SGD struggles to converge with the same small batch size and large learning rate, while the convergence rate is too slow when a smaller learning rate is used. This phenomenon verifies our theory that the variance of the original stochastic gradient will be too large for SGD to converge when \(T\gg Q\), \(N\), while proximal gradient descent with an \(\ell_{1}\) regularizer can resolve this issue.

### Relationship between our model and softmax transformers

We claim that they have our linear model and softmax transformers have qualitatively similar behaviors: there will be a sample-intensive initial stage, and after the model and the target have a nontrivial correlation, proximal gradient descent/SGD will become much more sample efficient.

For ease of presentation, in the following, we will assume \(N=1\), write \(\bm{a}:=\bm{a}^{(1)}\), and assume the ground-truth \(\bm{q}:=\bm{q}^{(1)}\) is \(\bm{e}_{1}=(1,0,\dots,0)\). Most of our argument below can be generalized to the general setting at least at a heuristic level. Recall that our linear model is \(f(\bm{X};\bm{V},\bm{a})=\bm{V}\bm{X}\bm{a}\). By a softmax transformer, we mean the model \(f_{\sigma}(\bm{X};\bm{V},\bm{w})=\bm{V}\bm{X}\sigma(\bm{w})=:\bm{V}\bm{X}\bm{a} _{\sigma}\) where \(\sigma\) is the softmax function and \(\bm{w}\in\mathbb{R}^{T}\) is the trainable first-layer weights.

Figure 1: **Convergence analysis:** We plot the distance to the ground truth \(\left\|\bm{V}-\bm{P}\right\|_{\bm{\mu}}\), \(\left\|\bm{A}-\bm{Q}\right\|_{\bm{\mu}}\) in different settings. After stage 1 ends at \(\tau=400\) (when \(\alpha_{A},\alpha_{\bm{V}}\approx 0.1\)), we use vanilla SGD and our proximal gradient method to train the transformer. Compared with SGD, the \(\ell_{1}\) regularized proximal gradient descent quickly converges, and the final solution (the star) recovers the ground truth. SGD either suffers from the large gradient variance (when \(\eta_{2}\) is large) or a slow convergence rate (small \(\eta_{2}^{\prime}\)).

Let \(l\) denote the (per-sample) loss. We have \(\nabla_{\bm{w}}l(f_{\sigma}(\bm{X}))=\left(\mathrm{diag}(\bm{a}_{\sigma})-\bm{a} _{\sigma}\bm{a}_{\sigma}^{\top}\right)(\bm{V}\bm{X})^{\top}\nabla l(f_{\sigma}( \bm{X}))\). As a result, the dynamics of the attention weights are controlled by

\[\bm{a}(\tau+1) \approx\bm{a}(\tau)-\eta\left(\bm{I}-\frac{\bm{1}\bm{1}^{\top}}{T }\right)(\bm{V}\bm{X})^{\top}\nabla l(f(\bm{X})),\] in our linear model, \[\bm{a}_{\sigma}(\tau+1) \approx\bm{a}_{\sigma}(\tau)-\eta\left(\mathrm{diag}(\bm{a}_{ \sigma})-\bm{a}_{\sigma}\bm{a}_{\sigma}^{\top}\right)^{2}(\bm{V}\bm{X})^{\top} \nabla l(f_{\sigma}(\bm{X})),\] in softmax transformers.

In other words, the main difference is that there will be a preconditioning matrix \((\mathrm{diag}(\bm{a})-\bm{a}\bm{a}^{\top})^{2}\) in the dynamics of softmax transformers.

Near initialization, i.e., when the attention pattern is still close to the uniform attention, we have \(\left(\mathrm{diag}(\bm{a}_{\sigma})-\bm{a}_{\sigma}\bm{a}_{\sigma}^{\top} \right)^{2}\approx\frac{1}{T^{2}}\left(\bm{I}-\frac{\bm{1}\bm{1}^{\top}}{T}\right)\). In other words, our linear model and softmax transformers are approximately equivalent up to a change in learning rates.

Now, suppose that there is a nontrivial correlation between \(\bm{a}_{\sigma}\) and \(\bm{q}=\bm{e}_{1}\), say, \(a_{\sigma,1}\) is a small constant while all other entries are \(O(1/T)\). In this case, we have \(\left(\mathrm{diag}(\bm{a}_{\sigma})-\bm{a}_{\sigma}\bm{a}_{\sigma}^{\top} \right)^{2}\approx a_{\sigma,1}(1-a_{\sigma,1})\bm{e}_{1}\bm{e}_{1}^{\top}+O (1/T)\). Effectively, softmax transformers automatically adjust the learning rate according to \(a_{\sigma,t}\) and roughly ignore those positions with a small attention weight to stabilize the gradients. Note that this is also what \(\ell_{1}\)-regularization does in our algorithm. In fact, mimicking this behavior is one of the motivations of using \(\ell_{1}\)-regularization in our linear setting. We run further experiments to highlight the resemblance between softmax attention and our linear attention model (Figure 2).

## 6 Conclusion and discussion

In this paper, we propose the Sparse Contextual Bigram (SCB) model, which is a natural extension of the bigram model, that requires both contextual and global information. Then, we analyze the problem of learning a SCB model using a one-layer linear transformer and a gradient-based algorithm. We prove quantitative bounds on the convergence rate and the sample complexity. In particular, we show when trained from scratch, the training process can be split into two stages, where the first stage uses a lot of samples to boost the signal from zero to a nontrivial value, while the second stage is much more sample-efficient. Then, we consider the problem in a transfer learning setting and prove that when there is a nontrivial correlation between the pretraining and downstream tasks, the first sample intensive stage can be bypassed.

Our data-generating model and results also lead to some interesting future directions. For example, can we improve the sample complexity of the first stage? What can we gain if the datapoints are sequences generated by repeatedly applying the SCB model?

## Acknowledgement

JDL acknowledges support of the NSF CCF 2002272, NSF IIS 2107304, and NSF CAREER Award 2144994.

Figure 2: **Similarity between the softmax and linear attention.** We train two transformers with (1) (Left) _softmax_ attention and (2) (Middle) _linear_ attention layer on the SCB tasks with the same ground-truth (\(T=50,N=10,Q=2\)). The attention pattern and the value matrix (learned transition matrix) are very similar (left two plots) and they converge to approximately the same loss (right plot).

## References

* O. GI (2023)Gpt-4 technical report. External Links: Link Cited by: SS1.
* A. Dosovitskiy, L. Beyer, A. Kolesnikov, D. Weissenborn, X. Zhai, T. Unterthiner, M. Dehghani, M. Minderer, G. Heigold, S. Gelly, et al. (2020)An image is worth 16x16 words: transformers for image recognition at scale. arXiv preprint arXiv:2010.11929. Cited by: SS1.
* 589. External Links: Link, Document Cited by: SS1.
* A. Vaswani, N. Shazeer, N. Parmar, J. Uszkoreit, L. Jones, A. N. Gomez, L. Kaiser, and I. Polosukhin (2017)Attention is all you need. Advances in neural information processing systems30. Cited by: SS1.
* B. L. Edelman, S. Goel, S. Kakade, and C. Zhang (2022)Inductive biases and variable creation in self-attention mechanisms. In International Conference on Machine Learning, pp. 5793-5831. Cited by: SS1.
* B. Liu, J. T. Ash, S. Goel, A. Krishnamurthy, and C. Zhang (2022)Transformers learn shortcuts to automata. arXiv preprint arXiv:2210.10749. Cited by: SS1.
* N. Nanda, L. Chan, T. Liberum, J. Smith, and J. Steinhardt (2023)Progress measures for grokking via mechanistic interpretability. arXiv preprint arXiv:2301.05217. Cited by: SS1.
* S. Yao, B. Peng, C. Papadimitriou, and K. Narasimhan (2021)Self-attention networks can process bounded hierarchical languages. arXiv preprint arXiv:2105.11115. Cited by: SS1.
* F. Petroni, T. Rocktaschel, P. Lewis, A. Bakhtin, Y. Wu, A. H. Miller, and S. Riedel (2019)Language models as knowledge bases?. arXiv preprint arXiv:1909.01066. Cited by: SS1.
* C. Zhang, D. Ippolito, K. Lee, M. Jagielski, F. Tramer, and N. Carlini (2023)Counterfactual memorization in neural language models. Advances in Neural Information Processing Systems36, pp. 39321-39362. Cited by: SS1.
* A. Haviv, I. Cohen, J. Gidron, R. Schuster, Y. Goldberg, and M. Geva (2022)Understanding transformer memorization recall through idioms. arXiv preprint arXiv:2210.03588. Cited by: SS1.
* N. Carlini, F. Tramer, E. Wallace, M. Jagielski, A. Herbert-Voss, K. Lee, A. Roberts, T. Brown, D. Song, U. Erlingsson, A. Oprea, and C. Raffel (2021)Extracting training data from large language models. In 30th USENIX Security Symposium (USENIX Security 21), USENIX Association, August 2021, pp. 2633-2650. External Links: Link, Document Cited by: SS1.
* K. Ahn, X. Cheng, M. Song, C. Yun, A. Jadbabaie, and S. Sra (2023)Linear attention is (maybe) all you need (to understand transformer optimization). arXiv preprint arXiv:2310.01082. Cited by: SS1.
* S. Jelassi, M. Sander, and Y. Li (2022)Vision transformers provably learn spatial structure. Advances in Neural Information Processing Systems35, pp. 37822-37836. Cited by: SS1.
* H. Li, M. Wang, S. Liu, and P. Chen (2023)A theoretical understanding of shallow vision transformers: learning, generalization, and sample complexity. arXiv preprint arXiv:2302.06015. Cited by: SS1.
*Davoud Ataee Tarzanagh, Yingcong Li, Christos Thrampoulidis, and Samet Oymak. Transformers as support vector machines. _arXiv preprint arXiv:2308.16898_, 2023.
* Tian et al. (2023a) Yuandong Tian, Yiping Wang, Beidi Chen, and Simon Du. Scan and snap: Understanding training dynamics and token composition in 1-layer transformer. _arXiv preprint arXiv:2305.16380_, 2023a.
* Tian et al. (2023b) Yuandong Tian, Yiping Wang, Zhenyu Zhang, Beidi Chen, and Simon Du. Joma: Demystifying multilayer transformers via joint dynamics of mlp and attention. _arXiv preprint arXiv:2310.00535_, 2023b.
* Mahankali et al. (2023) Arvind Mahankali, Tatsunori B Hashimoto, and Tengyu Ma. One step of gradient descent is provably the optimal in-context learner with one layer of linear self-attention. _arXiv preprint arXiv:2307.03576_, 2023.
* Zhang et al. (2023) Ruiqi Zhang, Spencer Frei, and Peter L Bartlett. Trained transformers learn linear models in-context. _arXiv preprint arXiv:2306.09927_, 2023b.
* Huang et al. (2023) Yu Huang, Yuan Cheng, and Yingbin Liang. In-context convergence of transformers. _arXiv preprint arXiv:2310.05249_, 2023.
* Chen et al. (2024) Siyu Chen, Heejune Sheen, Tianhao Wang, and Zhuoran Yang. Training dynamics of multi-head softmax attention for in-context learning: Emergence, convergence, and optimality. _arXiv preprint arXiv:2402.19442_, 2024.
* Bietti et al. (2024) Alberto Bietti, Vivien Cabannes, Diane Bouchacourt, Herve Jegou, and Leon Bottou. Birth of a transformer: A memory viewpoint. _Advances in Neural Information Processing Systems_, 36, 2024.
* Nichani et al. (2024) Eshaan Nichani, Alex Damian, and Jason D Lee. How transformers learn causal structure with gradient descent. _arXiv preprint arXiv:2402.14735_, 2024.
* Edelman et al. (2024) Benjamin L Edelman, Ezra Edelman, Surbhi Goel, Eran Malach, and Nikolaos Tsilivis. The evolution of statistical induction heads: In-context learning markov chains. _arXiv preprint arXiv:2402.11004_, 2024.
* Makkuva et al. (2024) Ashok Vardhan Makkuva, Marco Bondaschi, Adway Girish, Alliot Nagle, Martin Jaggi, Hyeji Kim, and Michael Gastpar. Attention with markov: A framework for principled analysis of transformers via markov chains. _arXiv preprint arXiv:2402.04161_, 2024.
* Kim & Suzuki (2024) Juno Kim and Taiji Suzuki. Transformers learn nonlinear features in context: Nonconvex mean-field dynamics on the attention landscape. _arXiv preprint arXiv:2402.01258_, 2024.
* Wang et al. (2024) Zixuan Wang, Stanley Wei, Daniel Hsu, and Jason D Lee. Transformers provably learn sparse token selection while fully-connected nets cannot. _arXiv preprint arXiv:2406.06893_, 2024.
* Devlin et al. (2018) Jacob Devlin, Ming-Wei Chang, Kenton Lee, and Kristina Toutanova. Bert: Pre-training of deep bidirectional transformers for language understanding. _arXiv preprint arXiv:1810.04805_, 2018.
* Tripuraneni et al. (2020) Nilesh Tripuraneni, Michael Jordan, and Chi Jin. On the theory of transfer learning: The importance of task diversity. _Advances in neural information processing systems_, 33:7852-7862, 2020.
* Du et al. (2020) Simon S Du, Wei Hu, Sham M Kakade, Jason D Lee, and Qi Lei. Few-shot learning via learning the representation, provably. _arXiv preprint arXiv:2002.09434_, 2020.
* Arora et al. (2019) Sanjeev Arora, Hrishikesh Khandeparkar, Mikhail Khodak, Orestis Plevrakis, and Nikunj Saunshi. A theoretical analysis of contrastive unsupervised representation learning. _arXiv preprint arXiv:1902.09229_, 2019.
* Hanneke et al. (2023) Steve Hanneke, Samory Kpotufe, and Yasaman Mahdaviyeh. Limits of model selection under transfer learning. In _The Thirty Sixth Annual Conference on Learning Theory_, pages 5781-5812. PMLR, 2023.
* Li et al. (2022) Sai Li, T Tony Cai, and Hongzhe Li. Transfer learning for high-dimensional linear regression: Prediction, estimation and minimax optimality. _Journal of the Royal Statistical Society Series B: Statistical Methodology_, 84(1):149-173, 2022.
* Li et al. (2020)Ye Tian and Yang Feng. Transfer learning under high-dimensional generalized linear models. _Journal of the American Statistical Association_, 118(544):2684-2697, 2023.
* Fei and Li (2021) Zhe Fei and Yi Li. Estimation and inference for high dimensional generalized linear models: A splitting and smoothing approach. _Journal of Machine Learning Research_, 22(58):1-32, 2021.
* Zhang et al. (2022) Xuhui Zhang, Jose Blanchet, Soumyadip Ghosh, and Mark S Squillante. A class of geometric structures in transfer learning: Minimax bounds and optimality. In _International Conference on Artificial Intelligence and Statistics_, pages 3794-3820. PMLR, 2022.
* Ju et al. (2023) Peizhong Ju, Sen Lin, Mark S Squillante, Yingbin Liang, and Ness B Shroff. Generalization performance of transfer learning: Overparameterized and underparameterized regimes. _arXiv preprint arXiv:2306.04901_, 2023.
* Dar and Baraniuk (2022) Yehuda Dar and Richard G Baraniuk. Double double descent: On generalization errors in transfer learning between linear regression tasks. _SIAM Journal on Mathematics of Data Science_, 4(4):1447-1472, 2022.
* Lampinen and Ganguli (2018) Andrew K Lampinen and Surya Ganguli. An analytic theory of generalization dynamics and transfer learning in deep linear networks. _arXiv preprint arXiv:1809.10374_, 2018.
* Dhifallah and Lu (2021) Oussama Dhifallah and Yue M Lu. Phase transitions in transfer learning for high-dimensional perceptrons. _Entropy_, 23(4):400, 2021.
* Damian et al. (2022) Alexandru Damian, Jason Lee, and Mahdi Soltanolkotabi. Neural networks can learn representations with gradient descent. In _Conference on Learning Theory_, pages 5413-5452. PMLR, 2022.
* Akyurek et al. (2022) Ekin Akyurek, Dale Schuurmans, Jacob Andreas, Tengyu Ma, and Denny Zhou. What learning algorithm is in-context learning? investigations with linear models. _arXiv preprint arXiv:2211.15661_, 2022.

Limitation

In this section, we briefly discuss the limitation of this work.

First, we consider one-layer single-head linear transformers with certain (blocks of the) weights merged or fixed. Though this simplification are widely used in theoretical works and linear and nonlinear transformers share some training behaviors (Ahn et al., 2023), this architecture is still very far away from the transformers used in practice.

We also use a non-standard training algorithm that has several manually separated stages. Some parts of the modification are made to address certain issues of linear transformers, while the other are made to simplify the analysis. It would be interesting (and more challenging) to consider more natural/practical training algorithms.

Finally, for our data-generating model, we only use it to generate one next token, instead of repeatedly apply SCB on the previous generated results to obtain a long sequence. In our setting, the contextual tokens are independent. While this simplifies the analysis, it deviates from how natural language works.

## Appendix B Probabilities, expectations, and variances

We collect in this section closed-form formulas for the probabilities of certain events, and the expectations and variances of some random vectors of interest. All proofs are deferred to the end of this section.

### Probabilities

**Lemma B.1**.: _For any \(t\in[T]\) and \(k,n,m\in[N]\), we have_

\[\mathbb{P}(x_{o}=n,x_{t}=m\mid x_{T+1}=k)=q_{t}^{(k)}P_{n,m}\mu_{m}+\left(1-q _{t}^{(k)}\right)\mu_{n}\mu_{m}.\]

**Lemma B.2**.: _For any \(s\neq t\in[T]\), \(k,n,m,l\in[N]\), we have_

\[\mathbb{P}(x_{o}=n\mid x_{T+1}=k,x_{s}=m,x_{t}=l)=q_{s}^{(k)}P_{n,m}+q_{t}^{( k)}P_{n,l}+\left(1-q_{s}^{(k)}-q_{t}^{(k)}\right)\mu_{n}.\]

### Gradient and Expectations

**Lemma B.3**.: _Suppose the last input token \(\bm{x}_{T+1}\) and \(\bm{a}:=\bm{A}\bm{x}_{T+1}\). The gradients of the objective are_

\[\nabla_{\bm{V}}l =\left(\bm{V}\bm{A}\bm{a}-\bm{e}_{x_{o}}\right)\left(\bm{A}\bm{a} \right)^{\top},\] \[\nabla_{\bm{a}^{(k)}}l =\mathbb{I}\left\{x_{T+1}=k\right\}(\bm{V}\bm{X})^{\top}\left(\bm {V}\bm{X}\bm{a}-\bm{e}_{x_{o}}\right)\]

**Lemma B.4**.: _For any \(k\in[N]\) and \(s,t\in[T]\), we have_

\[\mathbb{E}^{(k)}\left[\bm{e}_{x_{k}}\bm{e}_{x_{k}}^{\top}\right]=\mathbb{E} \left[\bm{e}_{x_{k}}\bm{e}_{x_{k}}^{\top}\right]=\begin{cases}\mathrm{diag}( \bm{\mu}),&s=t,\\ \bm{\mu}\bm{\mu}^{\top},&s\neq t.\end{cases}\]

**Lemma B.5**.: _For any \(\bm{V}\in\mathbb{R}^{N\times N}\) with \(\bm{V}\bm{\mu}=\bm{\mu}\) and \(s,t\in[T]\), we have_

\[\sum_{n=1}^{N}\mathbb{E}\left[V_{n,x_{s}}V_{n,x_{t}}\right]=\begin{cases}\left\| \bm{V}\right\|_{\mu}^{2},&s=t,\\ \left\|\bm{\mu}\right\|^{2},&s\neq t.\end{cases}\]

**Lemma B.6**.: _For any \(\bm{V}\in\mathbb{R}^{N\times N}\) with \(\bm{V}\bm{\mu}=\bm{\mu}\) and \(t\in[T]\), we have_

\[\mathbb{E}^{(k)}V_{x_{o},x_{t}}=q_{t}^{(k)}\left\langle\bm{V},\bm{P}\right\rangle _{\mu}+\left(1-q_{t}^{(k)}\right)\left\|\bm{\mu}\right\|^{2}.\]

**Lemma B.7** (Expected gradients).: \[\mathbb{E}\left\nabla_{\bm{V}}l=\left\|\bm{A}\right\|_{\mu}^{2}\bm{V}\mathrm{ diag}(\bm{\mu})+\left(1-\left\|\bm{A}\right\|_{\mu}^{2}\right)\bm{\mu}\bm{\mu}^{\top}\]\[-\left\langle\bm{Q},\bm{A}\right\rangle_{\mu}\bm{P}\text{diag}(\bm{ \mu})-\left(1-\left\langle\bm{Q},\bm{A}\right\rangle_{\mu}\right)\bm{\mu}\bm{ \mu}^{\top},\] \[\mathbb{E}\,\nabla_{\bm{a}^{(k)}I}=\mu_{k} \left(\left\|\bm{V}\right\|_{\mu}^{2}-\left\|\bm{\mu}\right\|^{2} \right)\bm{a}^{(k)}+\mu_{k}\bm{1}\left\|\bm{\mu}\right\|^{2}\] \[-\mu_{k}\bm{q}^{(k)}\left\langle\bm{V},\bm{P}\right\rangle_{\mu} -\mu_{k}\left(\bm{1}-\bm{q}^{(k)}\right)\left\|\bm{\mu}\right\|^{2}.\]

**Lemma B.8** (Expected preconditioned gradients).: \[\mathbb{E}\,\hat{\nabla}_{\bm{V}}I=\left\|\bm{A}\right\|_{\mu}^{2} \left(\bm{V}-\bm{\mu}\bm{1}^{\top}\right)-\left\langle\bm{Q},\bm{A}\right\rangle _{\mu}\left(\bm{P}-\bm{\mu}\bm{1}^{\top}\right),\] \[\mathbb{E}\,\hat{\nabla}_{\bm{a}^{(k)}I}=\left(\|\bm{V}\|_{\mu}^ {2}-\|\bm{\mu}\|^{2}\right)\left(\bm{a}^{(k)}-\frac{\bm{1}}{T}\right)-\left( \left\langle\bm{V},\bm{P}\right\rangle_{\mu}-\|\bm{\mu}\|^{2}\right)\left( \bm{q}^{(k)}-\frac{\bm{1}}{T}\right).\]

### Deferred proofs of this section

#### b.3.1 Probabilities

Proof of Lemma b.1.: For notational simplicity, define \(\bm{x}_{-t}=(x_{1},\ldots,x_{t-1},x_{t+1},\ldots,x_{T})\). We compute

\[\mathbb{P}(x_{o}=n,x_{t}=m\mid x_{T+1}=k)\] \[=\sum_{\hat{\bm{m}}\in[N]^{T-1}}\mathbb{P}(x_{o}=n,x_{t}=m,\bm{x }_{-t}=\hat{\bm{m}}\mid x_{T+1}=k)\] \[=\sum_{\hat{\bm{m}}\in[N]^{T-1}}\mathbb{P}(x_{o}=n\mid x_{t}=m, \bm{x}_{-t}=\hat{\bm{m}},x_{T+1}=k)\] \[\times\mathbb{P}(x_{t}=m,\bm{x}_{-t}=\hat{\bm{m}}\mid x_{T+1}=k).\]

By the independence assumption, we have \(\mathbb{P}(x_{t}=m,\bm{x}_{-t}=\hat{\bm{m}}\mid x_{T+1}=k)=\mathbb{P}(x_{t}= m,\bm{x}_{-t}=\hat{\bm{m}})=\mathbb{P}(x_{t}=m)\,\mathbb{P}(\bm{x}_{-t}=\hat{ \bm{m}})\). For the first factor, we have \(\mathbb{P}(x_{o}=n\mid x_{t}=m,\bm{x}_{-t}=\hat{\bm{m}},x_{T+1}=k)=Q_{t}^{(k) }P_{n,m}+\sum_{s\neq t}Q_{s}^{(k)}P_{n,\hat{m}_{s}}\). Therefore,

\[\mathbb{P}(x_{o}=n,x_{t}=m\mid x_{T+1}=k)\] \[=\sum_{\hat{\bm{m}}\in[T]^{N-1}}\left(Q_{t}^{(k)}P_{n,m}+\sum_{s \neq t}Q_{s}^{(k)}P_{n,\hat{m}_{s}}\right)\mathbb{P}(x_{t}=m)\,\mathbb{P}(\bm {x}_{-t}=\hat{\bm{m}})\] \[=\left(Q_{t}^{(k)}P_{n,m}+\sum_{s\neq t}Q_{s}^{(k)}\sum_{\hat{\bm {m}}\in[T]^{N-1}}P_{n,\hat{m}_{s}}\,\mathbb{P}(\bm{x}_{-t}=\hat{\bm{m}}) \right)\mu_{m}.\]

Note that for any \(s\neq t\)

\[\sum_{\hat{\bm{m}}\in[T]^{N-1}}P_{n,\hat{m}_{s}}\,\mathbb{P}(\bm{x}_{-t}=\hat {\bm{m}})=\sum_{\hat{\bm{m}}_{-s}\in[T]^{N-2}}\left(\sum_{\hat{m}_{s}=1}^{N}P_ {n,\hat{m}_{s}}\mu_{\hat{m}_{s}}\right)\mathbb{P}(\bm{x}_{-s,-t}=\hat{\bm{m}}_ {-s})=\mu_{n}.\]

Thus,

\[\mathbb{P}(x_{o}=n,x_{t}=m\mid x_{T+1}=k) =\left(q_{t}^{(k)}P_{n,m}+\sum_{s\neq t}q_{s}^{(k)}\mu_{n}\right) \mu_{m}\] \[=q_{t}^{(k)}P_{n,m}\mu_{m}+\left(1-q_{t}^{(k)}\right)\mu_{n}\mu_{ m}.\]

Proof of Lemma b.2.: For notational simplicity, let \(\bm{x}_{-s,-t}\) denote the vector obtained by removing the \(s,t\) coordinates from \(\bm{x}\). Then, we compute

\[\mathbb{P}(x_{o}=n\mid x_{T+1}=k,x_{s}=m,x_{t}=l)\] \[=\sum_{\hat{\bm{m}}\in[N]^{T-2}}\mathbb{P}(x_{o}=n,\bm{x}_{-s,-t}= \hat{\bm{m}}\mid x_{T+1}=k,x_{s}=m,x_{t}=l)\]\[=\sum_{\hat{m}\in[N]^{T-2}}\mathbb{P}(x_{o}=n\mid x_{T+1}=k,x_{s}=m,x _{t}=l,\bm{x}_{-s,-t}=\hat{m})\,\mathbb{P}(\bm{x}_{-s,-t}=\hat{m})\] \[=\sum_{\hat{m}\in[N]^{T-2}}\Bigg{(}q_{s}^{(k)}P_{n,m}+q_{t}^{(k)}P _{n,l}+\sum_{i\notin\{s,t\}}q_{i}^{(k)}P_{n,i\hat{m}_{i}}\Bigg{)}\mathbb{P}(\bm {x}_{-s,-t}=\hat{m})\] \[=q_{s}^{(k)}P_{n,m}+q_{t}^{(k)}P_{n,l}+\left(1-q_{s}^{(k)}-q_{t}^ {(k)}\right)\mu_{n}.\]

#### b.3.2 Expectations

Proof of Lemma b.3.: For each sample \(\bm{X}\), we have

\[l(\bm{x},x_{T+1},x_{o};\bm{V},\bm{A}):=\frac{1}{2}\left\|\bm{e}_{x_{o}}-\bm{VXA e}_{x_{T+1}}\right\|^{2}.\]

and \(\bm{a}\) Then we have the matrix differential:

\[\mathrm{d}l=\big{(}\bm{VXA-e}_{x_{o}}\big{)}^{\top}\mathrm{d}\bm{VXA+\big{(} \bm{VXA-e}_{x_{o}}\big{)}^{\top}\bm{VXda}}\]

Therefore,

\[\nabla_{\bm{V}}l =\big{(}\bm{VXA-e}_{x_{o}}\big{)}\,(\bm{XA})^{\top},\] \[\nabla_{\bm{a}^{(k)}l} =\mathbb{1}\left\{x_{T+1}=k\right\}(\bm{VX})^{\top}\big{(}\bm{VXA -e}_{x_{o}}\big{)}\]

Proof of Lemma b.4.: When \(s\neq t\), we have \(\mathbb{E}^{(k)}\big{[}\bm{e}_{x_{s}}\bm{e}_{x_{t}}^{\top}\big{]}=\mathbb{E}^{ (k)}\big{[}\bm{e}_{x_{s}}\big{]}\mathbb{E}^{(k)}\big{[}\bm{e}_{x_{t}}^{\top} \big{]}=\bm{\mu}\bm{\mu}^{\top}\). When \(s=t\), we have \(\mathbb{E}^{(k)}\big{[}\bm{e}_{x_{t}}\bm{e}_{x_{t}}^{\top}\big{]}=\sum_{k=1}^{ N}\mu_{k}\bm{e}_{k}\bm{e}_{k}^{\top}=\mathrm{diag}(\bm{\mu})\). 

Proof of Lemma b.5.: When \(s\neq t\), we have

\[\sum_{n=1}^{N}\mathbb{E}[V_{n,x_{s}}V_{n,x_{t}}]=\sum_{n=1}^{N} \left(\mathbb{E}\,V_{n,x_{s}}\right)^{2} =\sum_{n=1}^{N}\left(\sum_{k=1}^{N}\mu_{k}V_{n,k}\right)^{2}\] \[=\sum_{k,l=1}^{N}\mu_{k}\mu_{l}\sum_{n=1}^{N}V_{n,k}V_{n,l}=\bm{ \mu}^{\top}\bm{V}^{\top}\bm{V\mu}=\left\|\bm{\mu}\right\|^{2}.\]

When \(s=t\), we have \(\sum_{n=1}^{N}\mathbb{E}\,V_{n,x_{t}}^{2}=\sum_{n=1}^{N}\sum_{k=1}^{N}\mu_{k}V _{n,k}^{2}=\left\|\bm{V}\right\|_{\mu}^{2}.\) 

Proof of Lemma b.6.: Recall Lemma b.1. Then, we compute

\[\mathbb{E}^{(k)}V_{x_{o},x_{t}} =\sum_{n,m=1}^{N}V_{n,m}\,\mathbb{P}(x_{o}=n,x_{t}=m\mid x_{T+1}=k)\] \[=q_{t}^{(k)}\sum_{n,m=1}^{N}V_{n,m}P_{n,m}\mu_{m}+\left(1-q_{t}^ {(k)}\right)\sum_{n,m=1}^{N}V_{n,m}\mu_{n}\mu_{m}\] \[=q_{t}^{(k)}\,\big{(}\bm{V},\bm{P}\big{)}_{\mu}+\left(1-q_{t}^{(k )}\right)\bm{\mu}^{\top}\bm{V\mu}.\]

Proof of Lemma b.7.: First, we consider \(\nabla_{\bm{V}}l=\big{(}\bm{VXA-e}_{x_{o}}\big{)}\,(\bm{XA})^{\top}\), and compute \(\mathbb{E}(\bm{Xa})(\bm{Xa})^{\top}\) and \(\mathbb{E}\,\bm{e}_{x_{o}}(\bm{Xa})^{\top}\). Write \(\bm{Xa}=\sum_{t=1}^{T}a_{t}\bm{e}_{x_{t}}\). Then, we have

\[\mathbb{E}^{(k)}\left[(\bm{Xa})(\bm{Xa})^{\top}\right]=\sum_{s,t=1}^{T}a_{s}^ {(k)}a_{t}^{(k)}\,\mathbb{E}\big{[}\bm{e}_{x_{s}}\bm{e}_{x_{t}}^{\top}\big{]}\]\[=\sum_{t=1}^{T}(a_{t}^{(k)})^{2}\,\mathbb{E}[\bm{e}_{x_{x}}\bm{e}_{x_{t} }^{\top}]+\sum_{s\neq t}a_{t}^{(k)}a_{t}^{(k)}\,\mathbb{E}[\bm{e}_{x_{s}}\bm{e}_{x _{t}}^{\top}]\] \[=\left\|\bm{a}^{(k)}\right\|^{2}\mathrm{diag}(\bm{\mu})+\left(1- \left\|\bm{a}^{(k)}\right\|^{2}\right)\bm{\mu}\bm{\mu}^{\top},\]

where the last line comes from Lemma B.4. Then, we compute

\[\mathbb{E}^{(k)}\left[\bm{e}_{x_{o}}(\bm{X}\bm{a})^{\top}\right] =\sum_{t=1}^{T}a_{t}^{(k)}\mathbb{E}^{(k)}\left[\bm{e}_{x_{o}}\bm{e }_{x_{t}}^{\top}\right]=\sum_{t=1}^{T}a_{t}^{(k)}\,\left[\mathbb{P}(x_{o}=n,x _{t}=m\mid x_{T+1}=k)\right]_{n,m\in[N]}\] \[=\sum_{t=1}^{T}a_{t}^{(k)}\left(q_{t}^{(k)}\bm{P}\mathrm{diag}( \bm{\mu})+(1-q_{t}^{(k)})\bm{\mu}\bm{\mu}^{\top}\right)\] \[=\left\langle\bm{q}^{(k)},\bm{a}^{(k)}\right\rangle\bm{P}\mathrm{ diag}(\bm{\mu})+\left(1-\left\langle\bm{q}^{(k)},\bm{a}^{(k)}\right\rangle \right)\bm{\mu}\bm{\mu}^{\top},\]

where the second line comes from Lemma B.1. Thus, for \(\nabla_{\bm{V}}l\), we have

\[\mathbb{E}\,\nabla_{\bm{V}}l =\bm{V}\sum_{k=1}^{N}\mu_{k}\mathbb{E}^{(k)}\,\left[(\bm{X}\bm{a} )(\bm{X}\bm{a})^{\top}\right]-\sum_{k=1}^{N}\mu_{k}\mathbb{E}^{(k)}[\bm{e}_{x_ {o}}(\bm{X}\bm{a})^{\top}]\] \[=\left\|\bm{A}\right\|_{\mu}^{2}\bm{V}\mathrm{diag}(\bm{\mu})+ \left(1-\left\|\bm{A}\right\|_{\mu}^{2}\right)\bm{V}\bm{\mu}\bm{\mu}^{\top}- \left\langle\bm{Q},\bm{A}\right\rangle_{\mu}\bm{P}\mathrm{diag}(\bm{\mu})- \left(1-\left\langle\bm{Q},\bm{A}\right\rangle_{\mu}\right)\bm{\mu}\bm{\mu}^{ \top}.\]

Now, consider \(\nabla_{\bm{a}^{(k)}}l=\mathbb{1}\{x_{T+1}=k\}(\bm{V}\bm{X})^{\top}(\bm{V}\bm{X }\bm{a}-\bm{e}_{x_{o}})\) and compute \(\mathbb{E}^{(k)}(\bm{V}\bm{X})^{\top}(\bm{V}\bm{X})\) and \(\mathbb{E}^{(k)}(\bm{V}\bm{X})^{\top}\bm{e}_{x_{i}}\). By Lemma B.5, for each \(s,t\in[T]\), we have

\[\bm{e}_{s}^{\top}\mathbb{E}^{(k)}\left[(\bm{V}\bm{X})^{\top}(\bm{V}\bm{X}) \right]\bm{e}_{t}=\mathbb{E}^{(k)}\left[(\bm{V}\bm{e}_{x_{s}})^{\top}\bm{V}\bm {e}_{x_{o}}\right]=\sum_{n=1}^{N}\mathbb{E}\,V_{n,x_{s}}V_{n,x_{t}}=\begin{cases} \left\|\bm{V}\right\|_{\mu}^{2},&s=t,\\ \left\|\bm{\mu}\right\|^{2},&s\neq t.\end{cases}\]

In matrix form, this is

\[\mathbb{E}^{(k)}(\bm{V}\bm{X})^{\top}\bm{V}\bm{X}=\left(\left\|\bm{V}\right\|_ {\mu}^{2}-\left\|\bm{\mu}\right\|^{2}\right)\bm{I}+\bm{1}\bm{1}^{\top}\left\| \bm{\mu}\right\|^{2}.\]

Then, by Lemma B.6, for each \(t\in[T]\), we have

\[\bm{e}_{t}^{\top}\mathbb{E}[(\bm{V}\bm{X})^{\top}\bm{e}_{x_{o}} ]=\mathbb{E}^{(k)}\left[(\bm{V}\bm{e}_{x_{t}})^{\top}\bm{e}_{x_{o}}\right]= \mathbb{E}^{(k)}V_{x_{o},x_{t}}\] \[=q_{t}^{(k)}\,\left\langle\bm{V},\bm{P}\right\rangle_{\mu}+\left( 1-q_{t}^{(k)}\right)\left\|\bm{\mu}\right\|^{2}.\]

In matrix for, this is

\[\mathbb{E}[(\bm{V}\bm{X})^{\top}\bm{e}_{x_{o}}]=\bm{q}^{(k)}\,\left\langle\bm{V},\bm{P}\right\rangle_{\mu}+\left(\bm{1}-\bm{q}^{(k)}\right)\left\|\bm{\mu} \right\|^{2}.\]

Combine these together, and we obtain

\[\mu_{k}^{-1}\,\mathbb{E}\,\nabla_{\bm{a}^{(k)}}l =\mathbb{E}^{(k)}\,\left[(\bm{V}\bm{X})^{\top}\bm{V}\bm{X}\right] \bm{a}^{(k)}-\mathbb{E}^{(k)}\left[(\bm{V}\bm{X})^{\top}\bm{e}_{x_{o}}\right]\] \[=\left(\left\|\bm{V}\right\|_{\mu}^{2}-\left\|\bm{\mu}\right\|^{2} \right)\bm{a}^{(k)}+\bm{1}\left\|\bm{\mu}\right\|^{2}-\bm{q}^{(k)}\,\left\langle \bm{V},\bm{P}\right\rangle_{\mu}-\left(\bm{1}-\bm{q}^{(k)}\right)\left\|\bm{\mu} \right\|^{2}.\]

Proof of Lemma b.8.: Recall from Lemma B.7 that

\[\mathbb{E}\,\nabla_{\bm{V}}l =\left\|\bm{A}\right\|_{\mu}^{2}\bm{V}\mathrm{diag}(\bm{\mu})+ \left(1-\left\|\bm{A}\right\|_{\mu}^{2}\right)\bm{V}\bm{\mu}\bm{\mu}^{\top}\] \[\quad\quad-\left\langle\bm{Q},\bm{A}\right\rangle_{\mu}\bm{P} \mathrm{diag}(\bm{\mu})-\left(1-\left\langle\bm{Q},\bm{A}\right\rangle_{\mu} \right)\bm{\mu}\bm{\mu}^{\top},\] \[\mathbb{E}\,\nabla_{\bm{a}^{(k)}}l =\mu_{k}\,\left(\left\|\bm{V}\right\|_{\mu}^{2}-\left\|\bm{\mu} \right\|^{2}\right)\bm{a}^{(k)}+\mu_{k}\bm{1}\left\|\bm{\mu}\right\|^{2}\] \[\quad\quad\quad-\mu_{k}\bm{q}^{(k)}\,\left\langle\bm{V},\bm{P} \right\rangle_{\mu}-\mu_{k}\left(\bm{1}-\bm{q}^{(k)}\right)\left\|\bm{\mu} \right\|^{2}.\]For \(\nabla_{\mathbf{V}}\), we have

\[\bm{V}\mathrm{diag}(\bm{\mu})\mathrm{diag}(1/\bm{\mu})\left(\bm{I}- \frac{\bm{\mu}\bm{\mu}^{\top}}{\left\lVert\bm{\mu}\right\rVert^{2}}\right) =\bm{V}-\frac{\bm{\mu}\bm{\mu}^{\top}}{\left\lVert\bm{\mu}\right\rVert^ {2}},\] \[\bm{P}\mathrm{diag}(\bm{\mu})\mathrm{diag}(1/\bm{\mu})\left(\bm{I}- \frac{\bm{\mu}\bm{\mu}^{\top}}{\left\lVert\bm{\mu}\right\rVert^{2}}\right) =\bm{P}-\frac{\bm{\mu}\bm{\mu}^{\top}}{\left\lVert\bm{\mu}\right\rVert^ {2}},\] \[\bm{\mu}\bm{\mu}^{\top}\mathrm{diag}(1/\bm{\mu})\left(\bm{I}- \frac{\bm{\mu}\bm{\mu}^{\top}}{\left\lVert\bm{\mu}\right\rVert^{2}}\right) =\bm{\mu}\bm{1}^{\top}-\frac{\bm{\mu}\bm{\mu}^{\top}}{\left\lVert \bm{\mu}\right\rVert^{2}}.\]

In particular, note that the \(\bm{\mu}\bm{\mu}^{\top}/\left\lVert\bm{\mu}\right\rVert^{2}\) terms will cancel with each other. Thus, we have

\[\mathbb{E}\,\hat{\nabla}_{\mathbf{V}}l =\left\lVert\bm{A}\right\rVert_{\mu}^{2}\bm{V}+\left(1-\left\lVert \bm{A}\right\rVert_{\mu}^{2}\right)\bm{\mu}\bm{1}^{\top}-\left\langle\bm{Q}, \bm{A}\right\rangle_{\mu}\bm{P}-\left(1-\left\langle\bm{Q},\bm{A}\right\rangle _{\mu}\right)\bm{\mu}\bm{1}^{\top}\] \[=\left\lVert\bm{A}\right\rVert_{\mu}^{2}\left(\bm{V}-\bm{\mu} \bm{1}^{\top}\right)-\left\langle\bm{Q},\bm{A}\right\rangle_{\mu}\left(\bm{P} -\bm{\mu}\bm{1}^{\top}\right).\]

For \(\hat{\nabla}_{\bm{a}^{(k)}}l\), we have

\[\mathbb{E}\,\hat{\nabla}_{\bm{a}^{(k)}}l =\left(\left\lVert\bm{V}\right\rVert_{\mu}^{2}-\left\lVert\bm{ \mu}\right\rVert^{2}\right)\left(\bm{I}-\frac{\bm{1}\bm{1}^{\top}}{T}\right) \bm{a}^{(k)}-\left(\bm{I}-\frac{\bm{1}\bm{1}^{\top}}{T}\right)\bm{q}^{(k)} \left\langle\bm{V},\bm{P}\right\rangle_{\mu}\] \[\quad+\left(\bm{I}-\frac{\bm{1}\bm{1}^{\top}}{T}\right)\bm{q}^{(k )}\left\lVert\bm{\mu}\right\rVert^{2}\] \[=\left(\left\lVert\bm{V}\right\rVert_{\mu}^{2}-\left\lVert\bm{ \mu}\right\rVert^{2}\right)\left(\bm{a}^{(k)}-\frac{\bm{1}}{T}\right)-\left( \left\langle\bm{V},\bm{P}\right\rangle_{\mu}-\left\lVert\bm{\mu}\right\rVert^ {2}\right)\left(\bm{q}^{(k)}-\frac{\bm{1}}{T}\right).\]

### Concentration

In this section, we provide concentration inequalities for the gradients of the loss function. The concentration is applied on the gradient noise term

\[\bm{h}_{\bm{V},\,\tau} :=\left(\hat{\nabla}_{\bm{V}}^{(B)}l-\mathbb{E}\,\hat{\nabla}_{ \mathbf{V}}l\right)\] \[\bm{h}_{\bm{A},\,\tau} :=\left(\hat{\nabla}_{\bm{A}}^{(B)}l-\mathbb{E}\,\hat{\nabla}_{ \bm{A}}l\right)\]

where \(\hat{\nabla}_{\mathbf{V}}^{(B)}l\) and \(\hat{\nabla}_{\bm{A}}^{(B)}l\) are the preconditioned empirical gradients computed from a batch of size \(B\). Here, we first consider the concentration of the original gradients:

\[\nabla_{\mathbf{V}}l =\left(\bm{V}\bm{X}\bm{a}-\bm{e}_{x_{o}}\right)\left(\bm{X}\bm{a} \right)^{\top},\] \[\nabla_{\bm{a}^{(k)}}l =\mathbb{I}\left\{x_{T+1}=k\right\}(\bm{V}\bm{X})^{\top}\left(\bm {V}\bm{X}\bm{a}-\bm{e}_{x_{o}}\right)\]

and then consider the concentration of the preconditioned gradients. In this paper, we focus on \(\left\lVert\cdot\right\rVert_{\mu}\) as the mostly used metric for the gradient matrices.

First we prove a naive concentration w.r.t. any random vector \(\bm{y}\) with bounded second moment with any \(\left\lVert\cdot\right\rVert\).

**Lemma B.9**.: _Fix \(\delta,\varepsilon>0\). Let \(\bm{y}\) be a \(D\)-dimensional random vector with \(\mathbb{E}\left\lVert\bm{y}\right\rVert^{2}\leq G\). Define \(\bm{y}^{(B)}:=B^{-1}\sum_{i=1}^{B}\bm{y}_{i}\) where \((\bm{y}_{i})_{i}\) are i.i.d. versions of \(\bm{y}\). If_

\[B\geq\frac{G}{\delta\varepsilon^{2}},\]

_then with probability at least \(1-\delta\), we have \(\left\lVert\bm{y}-\mathbb{E}\,\bm{y}\right\rVert\leq\varepsilon\)._

Proof of Lemma b.9.: Assume w.l.o.g. that \(\mathbb{E}\,\bm{y}=0\). First, note that

\[\mathbb{E}\left\lVert\bm{y}^{(B)}\right\rVert^{2}=\frac{1}{B^{2}}\sum_{i,j=1}^{ N}\mathbb{E}\left\langle\bm{y}_{i},\bm{y}_{j}\right\rangle=\frac{1}{B^{2}}\sum_{i=1}^{N} \mathbb{E}\left\lVert\bm{y}_{i}\right\rVert^{2}\leq\frac{G}{B}.\]Hence, by the Markov inequality, we have

\[\mathbb{P}\left(\left\|\bm{v}^{(B)}\right\|\geq\varepsilon\right)=\mathbb{P}\left( \left\|\bm{v}^{(B)}\right\|^{2}\geq\varepsilon^{2}\right)\leq\frac{\mathbb{E} \left\|\bm{v}^{(B)}\right\|^{2}}{\varepsilon^{2}}\leq\frac{G}{B\varepsilon^{2}}.\]

Thus, for fixed \(\varepsilon,\delta\in(0,1)\), if we choose \(B=G/(\delta\varepsilon^{2})\), then we have with probability at least \(1-\delta\), \(\left\|\bm{v}^{(B)}\right\|\leq\varepsilon\). 

Now we upper bound the infinity norm of the preconditioned gradients to apply concentration.

**Lemma B.10**.: _Suppose that \(\left\|\mathrm{Vec}\,\bm{V}\right\|_{\infty}=O(1),\bm{V}=\tilde{\bm{V}}+\bm{ \Delta}\bm{v}\), \(\bm{A}=\tilde{\bm{A}}+\bm{\Delta}\bm{A}\), where \(\tilde{\bm{V}}\in\mathbb{R}^{N\times N}\) is a transition probability matrix, and in the attention matrix \(\tilde{\bm{A}}\) each column \(\tilde{\bm{a}}^{(k)}\) is a probability vector. Moreover, \(\left\|\bm{\Delta}\bm{A}\right\|_{F}^{2},\left\|\bm{\Delta}\bm{v}\right\|_{F} ^{2}\leq O(1/T)\). Then, we have_

\[\left\|\tilde{\bm{V}}_{\bm{a}^{(k)}}I\right\|_{\infty}\leq O(N),\ \ \ \left\|\mathrm{Vec}\,\hat{\bm{V}}I\right\|_{\infty}\leq O(N)\]

Proof.: We first consider the infinity norm of the original gradient. Recall that the gradient for \(\bm{V}\) and \(\bm{A}\) are

\[\nabla_{\bm{a}^{(k)}}I =\mathbb{1}\left\{x_{T+1}=k\right\}(\bm{V}\bm{X})^{\top}(\bm{V} \bm{X}\bm{a}^{(k)}-\bm{e}_{x_{\alpha}})\] \[\nabla_{\bm{V}}I =\left(\bm{V}\bm{X}\bm{a}-\bm{e}_{x_{\alpha}}\right)(\bm{X}\bm{a} )^{\top}\]

and the preconditioned gradient is:

\[\hat{\bm{V}}_{\bm{V}}^{(B_{\tau})}I :=\left(\bm{I}_{N}-\frac{\bm{1}_{N}\bm{1}_{N}^{\top}}{N}\right) \left(\nabla_{\bm{V}}^{(B_{\tau})}I\right)\mathrm{diag}(1/\bm{\mu})\left(\bm{ I}_{N}-\frac{\bm{\mu}\bm{\mu}^{\top}}{\left\|\bm{\mu}\right\|^{2}}\right),\] \[\hat{\bm{V}}_{\bm{a}^{(k)}}^{(B_{\tau})}I :=\frac{1}{\mu_{k}}\left(\bm{I}_{T}-\frac{\bm{1}_{T}\bm{1}_{T}^{ \top}}{T}\right)\left(\nabla_{\bm{a}^{(k)}}^{(B_{\tau})}I\right).\]

We first consider the maximum absolute value in the original gradients. For \(\nabla_{\bm{a}^{(k)}}I\), we have

\[\left\|\mathbb{1}\left\{x_{T+1}=k\right\}(\bm{V}\bm{X})^{\top}( \bm{V}\bm{X}\bm{a}^{(k)}-\bm{e}_{x_{\alpha}})\right\|_{\infty}\] \[\leq\left\|\mathbb{1}\left\{x_{T+1}=k\right\}(\bm{V}\bm{X})^{\top }(\bm{V}\bm{X}\bm{a}^{(k)})\right\|_{\infty}+\left\|\mathbb{1}\left\{x_{T+1}= k\right\}(\bm{V}\bm{X})^{\top}(\bm{e}_{x_{\alpha}})\right\|_{\infty}\] \[\leq\max_{s\in[T]}\left|\sum_{t=1}^{T}a_{t}(\bm{V}\bm{e}_{x_{s}}) ^{\top}\bm{V}\bm{e}_{x_{t}}\right|+\max_{s\in[T]}\left|(\bm{V}\bm{e}_{x_{s}}) ^{\top}\bm{e}_{x_{\alpha}}\right|\]

The first term can be upper-bounded in the following way:

\[\max_{s\in[T]}\left|\sum_{t=1}^{T}a_{t}(\bm{V}\bm{e}_{x_{s}})^{ \top}\bm{V}\bm{e}_{x_{t}}\right| =\max_{s\in[T]}\left|\sum_{t=1}^{T}\tilde{a}_{t}(\bm{V}\bm{e}_{x_ {s}})^{\top}\bm{V}\bm{e}_{x_{t}}+\sum_{t=1}^{T}\bm{\Delta}_{\bm{a},t}(\bm{V} \bm{e}_{x_{s}})^{\top}\bm{V}\bm{e}_{x_{t}}\right|\] \[\leq\left(1+\sum_{t=1}^{T}\left\|\bm{\Delta}_{\bm{a},t}\right\|_{1 }\right)\max_{s,t}\left|(\bm{V}\bm{e}_{x_{s}})^{\top}\bm{V}\bm{e}_{x_{t}}\right|\] \[\leq(1+\sqrt{T}\|\bm{\Delta}_{\bm{a},t}\|_{2})\max_{s,t}\left|( \bm{V}\bm{e}_{x_{s}})^{\top}\bm{V}\bm{e}_{x_{t}}\right|\]

Since \(\bm{V}=\tilde{\bm{V}}+\bm{\Delta}_{\bm{V}}\) and \(\left\|\bm{\Delta}_{\bm{V}}\right\|_{F}^{2},\left\|\bm{\Delta}_{\bm{A}}\right\|_{F }^{2}\leq O(1/T)\), we have \(\max_{s,t}\left|(\bm{V}\bm{e}_{x_{s}})^{\top}\bm{V}\bm{e}_{x_{t}}\right|\) upper bounded by \(O(1)\). Therefore

\[\max_{s\in[T]}\left|\sum_{t=1}^{T}a_{t}(\bm{V}\bm{e}_{x_{s}})^{\top}\bm{V}\bm{e }_{x_{t}}\right|\leq O(1)\]

And similarly, the second term \(\max_{s\in[T]}\left|(\bm{V}\bm{e}_{x_{s}})^{\top}\bm{e}_{x_{\alpha}}\right|\) can be bounded by \(O(1)\) because the infinity norm of \(\bm{V}\) is also upper bounded by \(O(1)\). Therefore, we know \(\|\nabla_{\bm{a}^{(k)}}I\|_{\infty}\leq O(1)\).

Now we consider the preconditioned gradient \(\hat{\bm{V}}_{\bm{a}^{(k)}}^{(B_{\tau})}I\):

\[\|\hat{\bm{V}}_{\bm{a}^{(k)}}^{(B_{\tau})}I\|_{\infty}=\left\|\frac{1}{\mu_{k} }\left(\bm{I}_{T}-\frac{\bm{1}_{T}\bm{1}_{T}^{\top}}{T}\right)\left(\nabla_{ \bm{a}^{(k)}}^{(B_{\tau})}I\right)\right\|_{\infty}\]\[\leq\left\|\frac{1}{\mu_{k}}\bm{I}_{T}\left(\nabla_{\bm{a}^{(k)}}^{(B_{ T})}I\right)\right\|_{\infty}+\left\|\frac{1}{\mu_{k}}\left(\frac{\bm{1}_{T}\bm{1}_{T}^{ \top}}{T}\right)\left(\nabla_{\bm{a}^{(k)}}^{(B_{T})}I\right)\right\|_{\infty}\leq O \left(N\right)\]

since \(\mu_{k}\geq\frac{c}{N}\) for all \(k\in[N]\).

We use similar technique on \(\hat{\nabla}_{\bm{V}}^{(B_{T})}I\). First, we prove the infinity norm upper bound on the original gradient.

\[\left\|\operatorname{Vec}\nabla_{\bm{V}}I\right\|_{\infty} =\left\|\operatorname{Vec}\left(\bm{V}\bm{X}\bm{a}-\bm{e}_{x_{o}} \right)\left(\bm{X}\bm{a}\right)^{\top}\right\|_{\infty}\] \[=\left\|\operatorname{Vec}\left(\bm{V}\bm{X}\bm{a}\right)\left( \bm{X}\bm{a}\right)^{\top}\right\|_{\infty}+\left\|\operatorname{Vec}\left( \bm{e}_{x_{o}}\left(\bm{X}\bm{a}\right)^{\top}\right)\right\|_{\infty}\] \[=\max_{s,t\in[T]}\left|\left(\bm{V}\bm{X}\bm{a}\right)_{s}\left( \bm{X}\bm{a}\right)^{\top}_{t}+\left\|\sum_{t=1}^{T}a_{t}\operatorname{Vec} \left(\bm{e}_{x_{o}}\bm{e}_{x_{t}}^{\top}\right)\right\|_{\infty}\] \[\leq\left\|\left(\bm{V}\bm{X}\bm{a}\right)\right\|_{\infty}\left\| \left(\bm{X}\bm{a}\right)^{\top}_{t}\right\|_{\infty}+\left\|\sum_{t=1}^{T}a_ {t}\operatorname{Vec}\left(\bm{e}_{x_{o}}\bm{e}_{x_{t}}^{\top}\right)\right\|_ {\infty}\] \[=\sum_{s,t=1}^{T}(\tilde{a_{s}}+\|\bm{\Lambda}_{\bm{A}_{s}}\|_{1} )(\tilde{a_{t}}+\|\bm{\Lambda}_{\bm{A}_{s},t}\|_{1})\left\|\bm{V}\bm{e}_{x_{s }}\right\|_{\infty}\left\|\bm{e}_{x_{t}}\right\|_{\infty}\] \[\quad+\sum_{t=1}^{T}(\tilde{a_{t}}+\|\bm{\Lambda}_{\bm{A}_{s},t}\| _{1})\left\|\operatorname{Vec}\left(\bm{e}_{x_{o}}\bm{e}_{x_{t}}^{\top}\right) \right\|_{\infty}\leq\Theta(1).\]

And therefore, the preconditioned gradient can also be bounded.

\[\|\hat{\nabla}_{\bm{V}}^{(B_{T})}I\|_{\infty} =\left\|\left(\bm{I}_{N}-\frac{\bm{1}_{N}\bm{1}_{N}^{\top}}{N} \right)\left(\nabla_{\bm{V}}^{(B_{T})}I\right)\operatorname{diag}(1/\bm{\mu}) \left(\bm{I}_{N}-\frac{\bm{\mu}\bm{\mu}^{\top}}{\left\|\bm{\mu}\right\|^{2}} \right)\right\|_{\infty}\] \[\leq\left\|\left(\nabla_{\bm{V}}^{(B_{T})}I\right)\operatorname{ diag}(1/\bm{\mu})\left(\bm{I}_{N}-\frac{\bm{\mu}\bm{\mu}^{\top}}{\left\|\bm{\mu} \right\|^{2}}\right)\right\|_{\infty}\] \[+\left\|\frac{\bm{1}_{N}\bm{1}_{N}^{\top}}{N}\left(\nabla_{\bm{V} }^{(B_{T})}I\right)\operatorname{diag}(1/\bm{\mu})\left(\bm{I}_{N}-\frac{\bm{\mu }\bm{\mu}^{\top}}{\left\|\bm{\mu}\right\|^{2}}\right)\right\|_{\infty}\] \[\leq O\left(N\right)\]

since \(\mu_{k}\geq\frac{c}{N}\) for all \(k\in[N]\). Now we finished the proof. 

With the upper bound of the infinity norm, we have the following upper bound on the second order moments of the preconditioned gradients of \(\bm{A}\) and \(\bm{V}\).

**Corollary B.11**.: _With the same setting in Lemma B.10 and \(\left\|\hat{\nabla}_{\bm{a}^{(k)}}I\right\|_{\infty}\leq O\left(N\right)\), \(\left\|\operatorname{Vec}\hat{\nabla}_{\bm{V}}I\right\|_{\infty}\leq O\left(N\right)\). Moreover, \(\left\|\bm{\Lambda}_{\bm{A}}\right\|_{F}^{2}\), \(\left\|\bm{\Lambda}_{\bm{V}}\right\|_{F}^{2}\leq O(1/T)\). Then, we have_

\[\mathbb{E}\left\|\hat{\nabla}_{\bm{A}}I\right\|_{\mu}^{2}\leq O( TN^{2}),\ \ \ \mathbb{E}\left\|\hat{\nabla}_{\bm{V}}I\right\|_{\mu}^{2}\leq O(N^{3})\]

Proof.: We directly upper bound \(\left\|\hat{\nabla}_{\bm{A}}I\right\|_{\mu}^{2}\) and \(\left\|\hat{\nabla}_{\bm{V}}I\right\|_{\mu}^{2}\) using the upper bound on infinity norm. Since \(\left\|\bm{\Lambda}_{\bm{A}}\right\|_{F}^{2}\), \(\left\|\bm{\Lambda}_{\bm{V}}\right\|_{F}^{2}\leq O(1/T)\), we have the infinity norm be upper bounded by

\[\left\|\hat{\nabla}_{\bm{a}^{(k)}}I\right\|_{\infty}\leq O\left(N\right),\ \ \ \left\| \operatorname{Vec}\hat{\nabla}_{\bm{V}}I\right\|_{\infty}\leq O\left(N\right)\]

Then, we can first bound the Frobenius norm \(\left\|\hat{\nabla}_{\bm{A}}I\right\|_{F}^{2}\), \(\left\|\hat{\nabla}_{\bm{V}}I\right\|_{F}^{2}\). We have \(\bm{V}\in\mathbb{R}^{N\times N}\), \(\bm{A}\in\mathbb{R}^{T\times N}\), so

\[\left\|\hat{\nabla}_{\bm{V}}I\right\|_{F}^{2}\leq N^{2}\left\|\hat{ \nabla}_{\bm{V}}I\right\|_{\infty}^{2}=O(N^{4}),\ \ \ \left\|\hat{\nabla}_{\bm{A}}I\right\|_{F}^{2}\leq NT\left\| \operatorname{Vec}\hat{\nabla}_{\bm{A}}I\right\|_{\infty}^{2}=O(N^{3}T).\]

That leads to:

\[\left\|\hat{\nabla}_{\bm{V}}I\right\|_{\mu}^{2}=\left\langle\hat{ \nabla}_{\bm{V}}I,\hat{\nabla}_{\bm{V}}I\operatorname{diag}(\mu)\right\rangle \leq O\left(\frac{1}{N}\right)\left\|\hat{\nabla}_{\bm{V}}I\right\|_{F}^{2} \leq O(N^{3})\] \[\left\|\hat{\nabla}_{\bm{A}}I\right\|_{\mu}^{2}=\left\langle\hat{ \nabla}_{\bm{A}}I,\hat{\nabla}_{\bm{A}}I\operatorname{diag}(\mu)\right\rangle \leq O\left(\frac{1}{N}\right)\left\|\hat{\nabla}_{\bm{A}}I\right\|_{F}^{2} \leq O(N^{2}T)\]

where the second inequality comes from the assumption that \(\mu\sim\Theta(1/N)\)Now with the upper bound of the second moments of the gradients, we begin to prove the concentration of the gradients. We first consider the first-order terms that need to be bounded in the signal dynamics:

\[\frac{\langle\bm{h}_{\bm{V}},\bm{P}\rangle_{\mu}}{K_{\bm{P}}K_{\bm{Q}}},\ \ \frac{\langle\bm{h}_{\bm{A}},\bm{Q}\rangle_{\mu}}{K_{\bm{P}}K_{\bm{Q}}}\]

**Lemma B.12**.: _Fix \(\varepsilon,\delta>0\). Under Assumption 2.1, suppose \(\left\|\hat{\nabla}_{\bm{a}^{(k)}}I\right\|_{\infty}\leq\Theta(N),\left\|\hat{ \nabla}_{\bm{V}}I\right\|_{\infty}\leq\Theta(N)\). If \(B\geq\Theta(1)\max\left(N^{4},Q^{2}N^{2}\right)^{\frac{N^{2}\log\frac{4}{4}}{ \varepsilon^{2}K_{\bm{P}}^{2}K_{\bm{Q}}^{2}}}\), then with probability at least \(1-\delta\), we have:_

\[\left|\frac{\langle\bm{h}_{\bm{V}},\bm{P}\rangle_{\mu}}{K_{\bm{P}}K_{\bm{Q}}} \right|\leq\varepsilon,\ \ \left|\frac{\langle\bm{h}_{\bm{A}},\bm{Q}\rangle_{\mu}}{K_{\bm{P}}K_{\bm{Q}}} \right|\leq\varepsilon.\]

Proof.: Note \(\bm{h}_{\bm{A}}=\frac{1}{B}\sum_{i}\hat{\nabla}_{\bm{a}^{(k)}I}(i)-\mathbb{E} \hat{\nabla}_{\bm{a}^{(k)}I}\), thus we have the upper bound for each coordinate of the gradient error bounded by \(\Theta(N)\). Similarly, we have the upper bound for each coordinate of the gradient error of \(\bm{h}_{\bm{V}}\) bounded by \(\Theta(N)\).

Then, we can bound the infinity norm of \(\langle\hat{\nabla}_{\bm{V}}I(i),\bm{P}\rangle_{\mu}\) and \(\langle\hat{\nabla}_{\bm{A}}I(i),\bm{P}\rangle_{\mu}\):

\[\left|\frac{\langle\hat{\nabla}_{\bm{V}}I(i),\bm{P}\rangle_{\mu}} {K_{\bm{P}}K_{\bm{Q}}}\right| =\left|\frac{\sum_{n,m=1}^{N}\hat{\nabla}_{\bm{V}}I(i)_{n,m}\bm{ P}_{n,m}}{K_{\bm{P}}K_{\bm{Q}}}\right|\] \[\leq\frac{N^{2}\left\|\hat{\nabla}_{\bm{V}}I(i)\right\|_{\infty} \left\|\bm{P}\right\|_{\infty}}{K_{\bm{P}}K_{\bm{Q}}}\] \[\leq\frac{\Theta(1)N^{3}}{K_{\bm{P}}K_{\bm{Q}}}.\] ( \[\left\|\bm{P}\right\|_{\infty}\leq 1.\] ) \[\left|\frac{\langle\hat{\nabla}_{\bm{A}}I(i),\bm{Q}\rangle_{\mu}} {K_{\bm{P}}K_{\bm{Q}}}\right| =\left|\frac{\sum_{n=1}^{T}\sum_{m=1}^{N}\hat{\nabla}_{\bm{A}}I( i)_{n,m}\bm{Q}_{n,m}}{K_{\bm{P}}K_{\bm{Q}}}\right|\] \[\leq\frac{QN\left\|\hat{\nabla}_{\bm{A}}I(i)\right\|_{\infty} \left\|\bm{Q}\right\|_{\infty}}{K_{\bm{P}}K_{\bm{Q}}} \text{(\text{$Q$ is Q-sparse.})}\] \[\leq\frac{\Theta(1)QN^{2}}{K_{\bm{P}}K_{\bm{Q}}}.\] ( \[\left\|\bm{Q}\right\|_{\infty}\leq 1.\] )

Note that \(\mathbb{E}\left[\nabla_{\bm{a}^{(k)}I}(i)-\mathbb{E}\nabla_{\bm{a}^{(k)}I} \right]=0,\mathbb{E}\left[\nabla_{\bm{V}}I(i)-\mathbb{E}\nabla_{\bm{V}}I \right]=0\), which means the two terms above have expectation \(0\). Since \(\bm{h}_{\bm{A}},\bm{h}_{\bm{V}}\) are both averages of \(B\) gradients of a single sample, we use Hoeffding Inequality:

\[\mathbb{P}\left(\left|\frac{\langle\bm{h}_{\bm{V}},\bm{P}\rangle_{ \mu}}{K_{\bm{P}}K_{\bm{Q}}}\right|\geq\varepsilon\right) \leq 2\exp\left(\frac{-B\varepsilon^{2}K_{\bm{P}}^{2}K_{\bm{Q}}^{2}}{N^ {6}}\right)\] \[\mathbb{P}\left(\left|\frac{\langle\bm{h}_{\bm{A}},\bm{Q}\rangle_{ \mu}}{K_{\bm{P}}K_{\bm{Q}}}\right|\geq\varepsilon\right) \leq 2\exp\left(\frac{-B\varepsilon^{2}K_{\bm{P}}^{2}K_{\bm{Q}}^{2}}{N^ {4}Q^{2}}\right)\]

By union bound, if \(B\geq\max\left(N^{2},Q^{2}\right)\frac{N^{4}\log\frac{4}{4}}{\varepsilon^{2}K_ {\bm{P}}^{2}K_{\bm{Q}}^{2}}\) it has at least \(1-\delta\) probability, s.t.

\[\left|\frac{\langle\bm{h}_{\bm{V}},\bm{P}\rangle_{\mu}}{K_{\bm{P}}K_{\bm{Q}}} \right|\leq\varepsilon,\ \ \left|\frac{\langle\bm{h}_{\bm{A}},\bm{Q}\rangle_{\mu}}{K_{\bm{P}}K_{\bm{Q}}} \right|\leq\varepsilon.\]

Then we finish this section with the concentration of the second order terms \(\left\|\bm{h}_{\bm{A}}\right\|^{2}\) and \(\left\|\bm{h}_{\bm{V}}\right\|^{2}\), which need to be bounded in the error evolution.

**Lemma B.13**.: _Fix \(\varepsilon,\delta>0\). Under Assumption 2.1, if \(\mathbb{E}\left\|\hat{\nabla}_{\bm{V}}I\right\|_{\mu}^{2}=\texttt{Tmp}_{3}=O(N^{ 3}),\mathbb{E}\left\|\hat{\nabla}_{\bm{A}}I\right\|_{\mu}^{2}=\texttt{Tmp}_{4}=O( TN^{2})\), \(B\geq\frac{\Theta(TN^{2})}{\delta\varepsilon^{2}}\), then with probability at least \(1-\delta\), we have:_

\[\left\|\bm{h}_{\bm{A}}\right\|_{\mu}\leq\varepsilon,\ \ \left\|\bm{h}_{\bm{V}} \right\|_{\mu}\leq\varepsilon.\]Proof.: Similar to Lemma B.12, \(\mathbb{E}\,\bm{h}_{\bm{V}}=0,\mathbb{E}\,\bm{h}_{\bm{A}}=0\). By Lemma B.9, when we pick \(B\geq\frac{\bm{0}(\bm{T}N^{2})}{\delta\,\varepsilon^{2}}\) we have \(\left\lVert\bm{h}_{\bm{A}}\right\rVert_{\mu}\leq\varepsilon\), \(\left\lVert\bm{h}_{\bm{V}}\right\rVert_{\mu}\leq\varepsilon\) with probability at least \(1-\delta\). 

## Appendix C The population projected process

In this section, we define the projection of the true SGD process onto the "space of population trajectories". Then, we derive formulas for the dynamics of projected process and the distance of the true SGD process to the space of population trajectories. All proofs -- except for those short ones -- are deferred to the end of this section.

### Definition of the population projection

The main reason we analyze the population process first is that on the population trajectory, both layers possess special structures. Recall that

\[\mathbb{E}\,\hat{\bm{\nabla}}_{\bm{V}}I =\left\lVert\bm{A}\right\rVert_{\mu}^{2}\left(\bm{V}-\bm{\mu} \bm{1}^{\top}\right)-\left\langle\bm{Q},\bm{A}\right\rangle_{\mu}\left(\bm{P }-\bm{\mu}\bm{1}^{\top}\right),\] \[\mathbb{E}\,\hat{\bm{\nabla}}_{\bm{A}}I =\left(\left\lVert\bm{V}\right\rVert_{\mu}^{2}-\left\lVert\bm{ \mu}\right\rVert^{2}\right)\left(\bm{A}-\frac{\bm{1}_{\bm{T}}\bm{1}_{N}^{ \top}}{T}\right)-\left(\left\langle\bm{V},\bm{P}\right\rangle_{\mu}-\left\lVert \bm{\mu}\right\rVert^{2}\right)\left(\bm{Q}-\frac{\bm{1}_{\bm{T}}\bm{1}_{N}^{ \top}}{T}\right),\]

and we initialize \(\bm{V}_{0}-\bm{\mu}\bm{1}^{\top}=0\) and \(\bm{A}-\bm{1}\bm{1}^{\top}/T=0\). Note that for any \((\bm{z}_{\tau})_{\tau}\), if \(z_{0}=0\) and \(\bm{\dot{z}}=\bm{A}\bm{z}+\bm{B}\bm{z}_{*}\), then \(\bm{z}_{\tau}\propto\bm{z}_{*}\) for all \(\tau\geq 0\). In other words, \(\bm{z}_{\tau}\) moves only along the direction \(\bm{z}_{*}\) and therefore, can be characterized by a single real number. This is exactly the same case of \(\bm{V}-\bm{\mu}\bm{1}^{\top}\) and \(\bm{A}-\bm{1}\bm{1}^{\top}/T\) in the population case. Hence, in the population case, \(\bm{V}\) stays on the line crossing \(\bm{\mu}\bm{1}^{\top}\) and \(\bm{P}\), and \(\bm{A}\) stays on the line crossing \(\bm{1}\bm{1}^{\top}/T\) and \(\bm{Q}\).

Unfortunately, mini-batch SGD does not stay exactly on the population trajectory. We can still, however, look at the projection of SGD onto the "population trajectories". Formally, for any \(\bm{V},\bm{A}\) satisfying \(\bm{1}_{N}^{\top}\bm{V}=\bm{1}_{N}^{\top},\bm{1}_{T}^{\top}\bm{A}=\bm{1}_{N}^{\top}\), and \(\bm{V}\bm{\mu}=\bm{\mu}\), we define

\[\alpha_{V} :=\operatorname*{argmin}_{\alpha\in\mathbb{R}}\left\lVert\alpha \bm{P}+(1-\alpha)\bm{\mu}\bm{1}_{N}^{\top}-\bm{V}\right\rVert_{\mu}^{2},\] \[\alpha_{A} :=\operatorname*{argmin}_{\alpha\in\mathbb{R}}\left\lVert\alpha \bm{Q}+(1-\alpha)\frac{\bm{1}_{\bm{T}}\bm{1}_{N}^{\top}}{T}-\bm{A}\right\rVert _{\mu}^{2}.\]

By setting the derivative to be \(0\), we can obtain the following closed-form formulas for \(\alpha_{V}\) and \(\alpha_{A}\).

**Note:** Without specification, we drop the the time subscript \(\tau\) and consider \(\alpha_{V}:=\alpha_{V,\tau}\) for similicity.

**Lemma C.1**.: _For any \(\bm{V},\bm{A}\) satisfying \(\bm{1}_{N}^{\top}\bm{V}=\bm{1}_{N}^{\top},\bm{1}_{T}^{\top}\bm{A}=\bm{1}_{N}^{ \top},\) and \(\bm{V}\bm{\mu}=\bm{\mu}\), we have_

\[\alpha_{V}=K_{VP}/K_{P}\quad\text{and}\quad\alpha_{A}=K_{AQ}/K_{Q},\]

_where \(K_{P}=\left\lVert\bm{P}\right\rVert_{\mu}^{2}-\left\lVert\bm{\mu}\right\rVert^ {2}\), \(K_{VP}=\left\langle\bm{V},\bm{P}\right\rangle_{\mu}-\left\lVert\bm{\mu}\right\rVert ^{2}\), \(K_{Q}=\left\lVert\bm{Q}\right\rVert_{\mu}^{2}-1/T\), \(K_{AQ}=\left\langle\bm{A},\bm{Q}\right\rangle_{\mu}-1/T\)._

For notational simplicity, we define \(\beta_{V}=1-\alpha_{V}\), \(\beta_{A}=1-\alpha_{A}\),

\[\tilde{\bm{V}}=\alpha_{V}\bm{P}+\beta_{V}\bm{\mu}\bm{1}^{\top}\quad\text{and} \quad\tilde{\bm{A}}=\alpha_{A}\bm{Q}+\beta_{A}\frac{\bm{1}\bm{1}^{\top}}{T}.\]

Then, define \(\bm{\Delta}_{V}=\bm{V}-\tilde{\bm{V}}\) and \(\bm{\Delta}_{A}=\bm{A}-\tilde{\bm{A}}\) so that we can decompose \(\bm{V}=\tilde{\bm{V}}+\bm{\Delta}_{V}\) and \(\bm{A}=\tilde{\bm{A}}+\bm{\Delta}_{A}\). By our construction, we have \(\tilde{\bm{V}}-\bm{\mu}\bm{1}^{\top}\perp\bm{\Delta}_{V}\) and similarly for \(\bm{\Delta}_{A}\). We will now show that we can in fact drop \(\bm{\mu}\bm{1}^{\top}\).

**Lemma C.2**.: _For any \(\bm{V}^{\prime}=\theta\bm{P}+(1-\theta)\bm{\mu}\bm{1}^{\top}\) and \(\bm{A}^{\prime}=\theta\bm{Q}+(1-\theta)\bm{1}\bm{1}^{\top}/T\) with \(\theta\in\mathbb{R}\), we have \(\left\langle\bm{\Delta}_{V},\bm{V}^{\prime}\right\rangle_{\mu}=0\) and \(\left\langle\bm{\Delta}_{A},\bm{A}^{\prime}\right\rangle_{\mu}=0\). In particular, we have \(\left\langle\bm{\Delta}_{V},\bm{P}\right\rangle_{\mu}=\left\langle\bm{\Delta}_{V},\tilde{\bm{V}}\right\rangle_{\mu}=0\) and \(\left\langle\bm{\Delta}_{A},\bm{Q}\right\rangle_{\mu}=\left\langle\bm{\Delta}_{A},\tilde{\bm{A}}\right\rangle_{\mu}=0\)._

Proof.: Note that \(\left\langle\bm{\mu}\bm{1}^{\top},\bm{\Delta}_{V}\right\rangle_{\mu}=\left\langle \bm{\mu},(\bm{V}-\tilde{\bm{V}})\bm{\mu}\right\rangle=0\). Hence, \(\left\langle\bm{\Delta}_{V},\bm{V}^{\prime}\right\rangle=\left\langle\bm{\Delta}_{V},\bm{V}^{\prime}-\bm{\mu}\bm{1}^{\top}\right\rangle=0\). For \(\left\langle\bm{\Delta}_{A},\bm{A}^{\prime}\right\rangle\), it suffices to note that \(\left\langle\bm{\Delta}_{A},\bm{1}\bm{1}^{\top}/T\right\rangle_{\mu}=\left\langle \bm{1}^{\top}(\bm{A}-\tilde{\bm{A}}),\bm{1}^{\top}/T\right\rangle_{\mu}=0\). 

The following lemma the basic definitions and results about the population projection.

**Lemma C.3** (Definitions and basic results on the population projection).: _Suppose that \(\bm{V},\bm{A}\) satisfy \(\bm{1}_{N}^{\top}V=\bm{1}_{N}^{\top},\bm{1}_{T}^{\top}\bm{A}=\bm{1}_{N}^{\top}\), and \(V\bm{\mu}=\bm{\mu}\). We define the following:_

\[K_{P}=\left\|\bm{P}\right\|_{\mu}^{2}-\left\|\bm{\mu}\right\|^{2}, \quad K_{VP}=\left\langle\bm{V},\bm{P}\right\rangle_{\mu}-\left\|\bm{\mu} \right\|^{2},\quad K_{V}=\left\|\bm{V}\right\|_{\mu}^{2}-\left\|\bm{\mu} \right\|^{2},\] \[\alpha_{V}=K_{VP}/K_{P},\quad\beta_{V}=1-\alpha_{V},\quad\tilde{ \bm{V}}=\alpha_{V}\bm{P}+\beta_{V}\bm{\mu}\bm{1}^{\top},\] \[\bm{\Delta}_{V}=\bm{V}-\tilde{\bm{V}},\] \[K_{Q}=\left\|\bm{Q}\right\|_{\mu}^{2}-1/T,\quad K_{AQ}=\left\langle \bm{A},\bm{Q}\right\rangle_{\mu}-1/T,\quad K_{A}=\left\|\bm{A}\right\|_{\mu}^{ 2}-1/T,\] \[\alpha_{A}=K_{AQ}/K_{Q},\quad\beta_{A}=1-\beta_{A},\quad\tilde{ \bm{A}}=\alpha_{A}\bm{A}+\beta_{A}\bm{1}_{T}\bm{1}_{N}^{\top}/T,\] \[\bm{\Delta}_{A}=\bm{A}-\tilde{\bm{A}}.\]

_Moreover, by Lemma C.2, the following hold._

\[K_{VP}=\left\langle\tilde{\bm{V}},\bm{P}\right\rangle_{\mu}- \left\|\bm{\mu}\right\|^{2}=\alpha_{V}K_{P},\] \[K_{V}=\left\|\tilde{\bm{V}}\right\|_{\mu}^{2}+\left\|\bm{\Delta} _{\bm{V}}\right\|_{\mu}^{2}-\left\|\bm{\mu}\right\|^{2}=\alpha_{V}^{2}K_{P}+ \left\|\bm{\Delta}_{\bm{V}}\right\|_{\mu}^{2},\] \[K_{AQ}=\left\langle\tilde{\bm{A}},\bm{Q}\right\rangle_{\mu}-1/T= \alpha_{A}K_{Q},\] \[K_{A}=\left\|\tilde{\bm{A}}\right\|_{\mu}^{2}+\left\|\bm{\Delta} _{\bm{A}}\right\|_{\mu}^{2}-1/T=\alpha_{A}^{2}K_{Q}+\left\|\bm{\Delta}_{\bm{A} }\right\|_{\mu}^{2}.\]

### Dynamics of the population projected process and the approximation error

We write

\[\bm{V}_{\tau+1}=\bm{V}_{\tau}-\eta_{V}\operatorname{\mathbb{E}} \hat{\bm{\nabla}}_{\bm{V}}l-\eta_{V}\left(\hat{\bm{\nabla}}_{\bm{V}}^{(B)}l- \operatorname{\mathbb{E}}\hat{\bm{\nabla}}_{\bm{V}}l\right)=:\bm{V}_{\tau}- \eta_{V}\operatorname{\mathbb{E}}\hat{\bm{\nabla}}_{\bm{V}}l-\eta_{V}\bm{h}_{ \bm{V},\tau},\] \[\bm{A}_{\tau+1}=\bm{A}_{\tau}-\eta_{A}\operatorname{\mathbb{E}} \hat{\bm{\nabla}}_{\bm{A}}l-\eta_{A}\left(\hat{\bm{\nabla}}_{\bm{A}}^{(B)}l- \operatorname{\mathbb{E}}\hat{\bm{\nabla}}_{\bm{A}}l\right)=:\bm{A}_{\tau}- \eta_{A}\operatorname{\mathbb{E}}\hat{\bm{\nabla}}_{\bm{A}}l-\eta_{A}\bm{h}_{ \bm{A},\tau},\]

where the expectations are taken over the fresh samples at step \(\tau\).

First, we expand the expected preconditioned gradients around the population projection.

**Lemma C.4** (Expanding the gradients).: \[\operatorname{\mathbb{E}}\hat{\bm{\nabla}}_{\bm{A}}l=K_{P}\alpha_{V }\left(\alpha_{V}\alpha_{A}-1\right)\left(\bm{Q}-\frac{\bm{1}_{T}\bm{1}_{N}^{ \top}}{T}\right)+K_{P}\alpha_{V}^{2}\bm{\Delta}_{\bm{A}}+\left\|\bm{\Delta}_{ \bm{V}}\right\|_{\mu}^{2}\left(\bm{A}-\frac{\bm{1}_{T}\bm{1}_{N}^{\top}}{T} \right),\] \[\operatorname{\mathbb{E}}\hat{\bm{\nabla}}_{\bm{V}}l=\alpha_{A}K_{Q }\left(\alpha_{A}\alpha_{V}-1\right)\left(\bm{P}-\bm{\mu}\bm{1}^{\top}\right)+ \frac{\alpha_{V}-1}{T}\left(\bm{P}-\bm{\mu}\bm{1}^{\top}\right)\] \[\qquad\qquad\qquad+\left(\alpha_{A}^{2}K_{Q}+\frac{1}{T}\right) \bm{\Delta}_{\bm{V}}+\left\|\bm{\Delta}_{\bm{A}}\right\|^{2}\left(\bm{V}-\bm{ \mu}\bm{1}^{\top}\right).\]

Then, we compute the dynamics of the projected process.

**Lemma C.5** (Dynamics of the population projection).: \[\alpha_{V,\tau+1}=\alpha_{V,\tau}+\eta_{V}K_{Q}\left(1-\alpha_{A} \alpha_{V}\right)\alpha_{A}+\eta_{V}\frac{1-\alpha_{V}}{T}-\eta_{V}\alpha_{V} \left\|\bm{\Delta}_{\bm{A}}\right\|^{2}-\frac{\eta_{V}}{K_{P}}\left\langle\bm{ h}_{\bm{V},\tau},\bm{P}\right\rangle_{\mu},\] \[\alpha_{A,\tau+1}=\alpha_{A,\tau}+\eta_{A}K_{P}\left(1-\alpha_{V} \alpha_{A}\right)\alpha_{V}-\eta_{A}\alpha_{A}\left\|\bm{\Delta}_{\bm{V}} \right\|_{\mu}^{2}-\frac{\eta_{A}}{K_{Q}}\left\langle\bm{h}_{\bm{A},\tau},\bm{ Q}\right\rangle_{\mu}.\]

_Note that \(\tilde{\bm{V}}=\bm{\mu}\bm{1}^{\top}+\alpha_{V}(\bm{P}-\bm{\mu}\bm{1}^{\top})\) and \(\tilde{\bm{A}}=\bm{1}_{T}\bm{1}_{N}^{\top}/T+\alpha_{A}(\bm{Q}-\bm{1}_{T}\bm{1}_{N }^{\top}/T)\). Hence, this also gives formulas for \(\tilde{\bm{V}}_{\tau+1}\) and \(\tilde{\bm{A}}_{\tau+1}\)._

Now, we consider the dynamics of the errors.

**Lemma C.6** (Dynamics of the errors).: \[\left\|\bm{\Delta}_{\bm{A},\tau+1}\right\|_{\mu}^{2}=\left(1- \eta_{A}K_{P}\alpha_{V}^{2}-\eta_{A}\left\|\bm{\Delta}_{V}\right\|_{\mu}^{2} \right)^{2}\left\|\bm{\Delta}_{\bm{A}}\right\|_{\mu}^{2}\] \[\qquad\qquad-2\eta_{A}\left(1-\eta_{A}K_{P}\alpha_{V}^{2}-\eta_{A} \left\|\bm{\Delta}_{V}\right\|_{\mu}^{2}\right)\left\langle\bm{\Delta}_{\bm{A}}, \bm{h}_{\bm{A}}\right\rangle_{\mu}\]\[-\frac{\eta_{A}^{2}}{K_{Q}}\left\langle\bm{h}_{A,\tau},\bm{Q} \right\rangle_{\mu}^{2}+\eta_{A}^{2}\left\|\bm{h}_{A}\right\|_{\mu}^{2},\] \[\left\|\bm{\Delta}_{V,\tau+1}\right\|_{\mu}^{2}=\left(1-\eta_{V} \left(\alpha_{A}^{2}K_{Q}+\frac{1}{T}\right)-\eta_{V}\left\|\bm{\Delta}_{A} \right\|^{2}\right)^{2}\left\|\bm{\Delta}_{V}\right\|_{\mu}^{2}\] \[\qquad\qquad\qquad\qquad\qquad\qquad-\frac{\eta_{V}^{2}}{K_{P}} \left\langle\bm{P},\bm{h}_{V}\right\rangle_{\mu}^{2}+\eta_{V}^{2}\left\|\bm{h} _{V}\right\|_{\mu}^{2}.\]

### Omitted proofs in this section

Proof of Lemma c.1.: We compute

\[\frac{1}{2}\partial_{\alpha}\left\|\alpha\bm{P}+(1-\alpha)\bm{ \mu}\bm{1}^{\top}-\bm{V}\right\|_{\mu}^{2} =\left\langle\alpha\bm{P}+(1-\alpha)\bm{\mu}\bm{1}^{\top}-\bm{V}, \bm{P}-\bm{\mu}\bm{1}^{\top}\right\rangle_{\mu}\] \[=\left\langle\alpha\bm{P}+(1-\alpha)\bm{\mu}\bm{1}^{\top}-\bm{V},\bm{P}\right\rangle_{\mu}=\alpha K_{P}+\left\|\bm{\mu}\right\|^{2}-\left\langle \bm{V},\bm{P}\right\rangle_{\mu}.\]

Set the derivative to be \(0\), and we get \(\alpha_{V}=(\left\langle\bm{V},\bm{P}\right\rangle_{\mu}-\left\|\bm{\mu} \right\|^{2})/K_{P}\). Similarly, we compute

\[\frac{1}{2}\partial_{\alpha}\left\|\alpha\bm{Q}+(1-\alpha)\frac{ \bm{1}\bm{1}^{\top}}{T}-\bm{A}\right\|_{\mu}^{2} =\left\langle\alpha\bm{Q}+(1-\alpha)\frac{\bm{1}\bm{1}^{\top}}{T }-\bm{A},\bm{Q}-\frac{\bm{1}\bm{1}^{\top}}{T}\right\rangle_{\mu}\] \[=\left\langle\alpha\bm{Q}+(1-\alpha)\frac{\bm{1}\bm{1}^{\top}}{T }-\bm{A},\bm{Q}\right\rangle_{\mu}\] \[=\alpha\left(\left\|\bm{Q}\right\|_{\mu}^{2}-1/T\right)-\left( \left\langle\bm{A},\bm{Q}\right\rangle_{\mu}-1/T\right).\]

Again, set the derivative to be \(0\), and we get \(\alpha_{A}=\left(\left\langle\bm{A},\bm{Q}\right\rangle_{\mu}-1/T\right)/( \left\|\bm{Q}\right\|_{\mu}^{2}-1/T)\). 

Proof of Lemma c.4.: Recall from Lemma B.8 that

\[\mathbb{B}\,\hat{\bm{\nabla}}_{\bm{V}}I =\left(K_{A}+\frac{1}{T}\right)\left(\bm{V}-\bm{\mu}\bm{1}^{\top }\right)-\left(K_{AQ}+\frac{1}{T}\right)\left(\bm{P}-\bm{\mu}\bm{1}^{\top} \right),\] \[\mathbb{B}\,\hat{\bm{\nabla}}_{\bm{A}}I =K_{V}\left(\bm{A}-\frac{\bm{1}_{T}\bm{1}_{N}^{\top}}{T}\right)- K_{VP}\left(\bm{Q}-\frac{\bm{1}_{T}\bm{1}^{\top}}{T}\right).\]

First, consider the dynamics of \(\bm{A}\). By Lemma C.3, we can further decompose it as

\[\mathbb{B}\,\hat{\bm{\nabla}}_{\bm{A}}I =\left(\alpha_{V}^{2}K_{P}+\left\|\bm{\Delta}_{V}\right\|_{\mu}^{ 2}\right)\left(\bm{A}-\frac{\bm{1}_{T}\bm{1}_{N}^{\top}}{T}\right)-\alpha_{V}K _{P}\left(\bm{Q}-\frac{\bm{1}_{T}\bm{1}^{\top}}{T}\right)\] \[=K_{P}\alpha_{V}\left(\alpha_{V}\left(\bm{A}-\frac{\bm{1}_{T}\bm {1}_{N}^{\top}}{T}\right)-\left(\bm{Q}-\frac{\bm{1}_{T}\bm{1}^{\top}}{T} \right)\right)+\left\|\bm{\Delta}_{V}\right\|_{\mu}^{2}\left(\bm{A}-\frac{\bm{ 1}_{T}\bm{1}_{N}^{\top}}{T}\right)\] \[=K_{P}\alpha_{V}\left(\alpha_{V}\left(\tilde{\bm{A}}-\frac{\bm{1} _{T}\bm{1}_{N}^{\top}}{T}\right)-\left(\bm{Q}-\frac{\bm{1}_{T}\bm{1}^{\top}}{T }\right)\right)+K_{P}\alpha_{V}^{2}\bm{\Delta}_{A}+\left\|\bm{\Delta}_{V}\right\| _{\mu}^{2}\left(\bm{A}-\frac{\bm{1}_{T}\bm{1}_{N}^{\top}}{T}\right)\] \[=K_{P}\alpha_{V}\left(\alpha_{V}\alpha_{A}-1\right)\left(\bm{Q}- \frac{\bm{1}_{T}\bm{1}_{N}^{\top}}{T}\right)+K_{P}\alpha_{V}^{2}\bm{\Delta}_{A}+ \left\|\bm{\Delta}_{V}\right\|_{\mu}^{2}\left(\bm{A}-\frac{\bm{1}_{T}\bm{1}_{ N}^{\top}}{T}\right).\]

Similarly, we can rewrite the expected preconditioned gradient of \(\bm{V}\) as

\[\mathbb{B}\,\hat{\bm{\nabla}}_{\bm{V}}I =\left(\alpha_{A}^{2}K_{Q}+\frac{1}{T}\right)\left(\bm{V}-\bm{\mu }\bm{1}^{\top}\right)-\left(\alpha_{A}K_{Q}+\frac{1}{T}\right)\left(\bm{P}-\bm{ \mu}\bm{1}^{\top}\right)+\left\|\bm{\Delta}_{A}\right\|^{2}\left(\bm{V}-\bm{ \mu}\bm{1}^{\top}\right)\] \[=\left(\alpha_{A}^{2}K_{Q}+\frac{1}{T}\right)\left(\tilde{\bm{V}}- \bm{\mu}\bm{1}^{\top}\right)-\left(\alpha_{A}K_{Q}+\frac{1}{T}\right)\left(\bm{P}- \bm{\mu}\bm{1}^{\top}\right)\] \[\qquad+\left(\alpha_{A}^{2}K_{Q}+\frac{1}{T}\right)\bm{\Delta}_{V}+ \left\|\bm{\Delta}_{A}\right\|^{2}\left(\bm{V}-\bm{\mu}\bm{1}^{\top}\right)\]\[=\alpha_{A}K_{Q}\left(\alpha_{A}\alpha_{V}-1\right)\left(\bm{P}-\bm{ \mu}\bm{1}^{\top}\right)+\frac{\alpha_{V}-1}{T}\left(\bm{P}-\bm{\mu}\bm{1}^{\top }\right)\] \[\qquad+\left(\alpha_{A}^{2}K_{Q}+\frac{1}{T}\right)\bm{\Lambda}_{V} +\left\|\bm{\Lambda}_{A}\right\|^{2}\left(\bm{V}-\bm{\mu}\bm{1}^{\top}\right)\,.\]

Proof of Lemma c.5.: Recall that \(\alpha_{V}=\left\langle\bm{V},\bm{P}\right\rangle_{\mu}/K_{P}\) and \(\alpha_{A}=\left\langle\bm{A},\bm{Q}\right\rangle_{\mu}/K_{Q}\). First, consider the dynamics of \(\bm{V}\). By Lemma C.4 and Lemma C.3, we have

\[\alpha_{V,\,\tau+1} =\alpha_{V,\,\tau}-\eta_{V}\frac{\left\langle\hat{\bm{\nabla}}_{ V}\mathcal{L}+\bm{h}_{V,\,\tau},\bm{P}\right\rangle_{\mu}}{K_{P}}\] \[=\alpha_{V,\,\tau}-\frac{\eta_{V}}{K_{P}}\alpha_{A}K_{Q}\left( \alpha_{A}\alpha_{V}-1\right)\left\langle\bm{P}-\bm{\mu}\bm{1}^{\top},\bm{P} \right\rangle_{\mu}-\frac{\eta_{V}}{K_{P}}\frac{\alpha_{V}-1}{T}\left\langle \bm{P}-\bm{\mu}\bm{1}^{\top},\bm{P}\right\rangle_{\mu}\] \[\qquad-\frac{\eta_{V}}{K_{P}}\left\|\bm{\Lambda}_{A}\right\|^{2} \left\langle\bm{V}-\bm{\mu}\bm{1}^{\top},\bm{P}\right\rangle_{\mu}-\eta_{V} \frac{\left\langle\bm{h}_{V,\,\tau},\bm{P}\right\rangle_{\mu}}{K_{P}}\] \[=\alpha_{V,\,\tau}+\eta_{V}K_{Q}\left(1-\alpha_{A}\alpha_{V} \right)\alpha_{A}+\eta_{V}\frac{1-\alpha_{V}}{T}-\eta_{V}\alpha_{V}\left\|\bm {\Lambda}_{A}\right\|^{2}-\frac{\eta_{V}}{K_{P}}\left\langle\bm{h}_{V,\,\tau },\bm{P}\right\rangle_{\mu}.\]

Similarly, for \(\bm{V}\), we have

\[\alpha_{A,\,\tau+1} =\alpha_{A,\,\tau}-\eta_{A}\frac{\left\langle\hat{\bm{\nabla}}_{ A}\mathcal{L}+\bm{h}_{A,\,\tau},\bm{Q}\right\rangle_{\mu}}{K_{Q}}\] \[=\alpha_{A,\,\tau}-\frac{\eta_{A}}{K_{Q}}K_{P}\alpha_{V}\left( \alpha_{V}\alpha_{A}-1\right)\left\langle\bm{Q}-\frac{\bm{1}_{T}\bm{1}_{N}^{ \top}}{T},\bm{Q}\right\rangle_{\mu}\] \[\qquad-\frac{\eta_{A}}{K_{Q}}\left\|\bm{\Lambda}_{V}\right\|_{\mu }^{2}\left\langle\bm{A}-\frac{\bm{1}_{T}\bm{1}_{N}^{\top}}{T},\bm{Q}\right\rangle _{\mu}-\eta_{A}\frac{\left\langle\bm{h}_{A,\,\tau},\bm{Q}\right\rangle_{\mu}}{ K_{Q}}\] \[=\alpha_{A,\,\tau}+\eta_{A}K_{P}\left(1-\alpha_{V}\alpha_{A} \right)\alpha_{V}-\eta_{A}\alpha_{A}\left\|\bm{\Lambda}_{V}\right\|_{\mu}^{2} -\frac{\eta_{A}}{K_{Q}}\left\langle\bm{h}_{A,\,\tau},\bm{Q}\right\rangle_{\mu }.\]

Proof of Lemma c.6.: First, consider the dynamics of \(\bm{\Lambda}_{A}\), which is given by

\[\bm{\Lambda}_{A,\,\tau+1} =\bm{\Lambda}_{A}-\eta_{A}K_{P}\alpha_{V}^{2}\bm{\Lambda}_{A}- \eta_{A}\left\|\bm{\Lambda}_{V}\right\|_{\mu}^{2}\left(\bm{A}-\frac{\bm{1}_{T} \bm{1}_{N}^{\top}}{T}\right)-\eta_{A}\bm{h}_{A}\] \[\qquad+\left(\eta_{A}\alpha_{A}\left\|\bm{\Lambda}_{V}\right\|_{\mu }^{2}+\frac{\eta_{A}}{K_{Q}}\left\langle\bm{h}_{A,\,\tau},\bm{Q}\right\rangle_{ \mu}\right)\left(\bm{Q}-\frac{\bm{1}_{T}\bm{1}_{N}^{\top}}{T}\right).\]

Decompose \(\bm{A}\) into \(\tilde{\bm{A}}+\bm{\Lambda}_{A}\), rearrange terms, and we obtain

\[\bm{\Lambda}_{A,\,\tau+1} =\bm{\Lambda}_{A}-\eta_{A}K_{P}\alpha_{V}^{2}\bm{\Lambda}_{A}- \eta_{A}\left\|\bm{\Lambda}_{V}\right\|_{\mu}^{2}\bm{\Lambda}_{A}\] \[\qquad-\eta_{A}\left\|\bm{\Lambda}_{V}\right\|_{\mu}^{2}\left( \tilde{\bm{A}}-\frac{\bm{1}_{T}\bm{1}_{N}^{\top}}{T}\right)+\eta_{A}\alpha_{A} \left\|\bm{\Lambda}_{V}\right\|_{\mu}^{2}\left(\bm{Q}-\frac{\bm{1}_{T}\bm{1}_{N }^{\top}}{T}\right)\] \[\qquad+\frac{\eta_{A}}{K_{Q}}\left\langle\bm{h}_{A,\,\tau},\bm{Q }\right\rangle_{\mu}\left(\bm{Q}-\frac{\bm{1}_{T}\bm{1}_{N}^{\top}}{T}\right)- \eta_{A}\bm{h}_{A}.\]

Note that \(\tilde{\bm{A}}-\bm{1}\bm{1}^{\top}/T=\alpha_{A}\bm{Q}+(1-\alpha_{A})\bm{1}\bm{1 }^{\top}/T-\bm{1}\bm{1}^{\top}/T=\alpha_{A}(\bm{Q}-\bm{1}\bm{1}^{\top}/T)\). Hence, we have

\[\bm{\Lambda}_{A,\,\tau+1} =\bm{\Lambda}_{A}-\eta_{A}K_{P}\alpha_{V}^{2}\bm{\Lambda}_{A}- \eta_{A}\left\|\bm{\Lambda}_{V}\right\|_{\mu}^{2}\bm{\Lambda}_{A}\] \[\qquad-\frac{\eta_{A}\alpha_{A}\left\|\bm{\Lambda}_{V}\right\|_{ \mu}^{2}\left(\bm{Q}-\frac{\bm{1}_{T}\bm{1}_{N}^{\top}}{T}\right)+\eta_{A} \alpha_{A}\left\|\bm{\Lambda}_{V}\right\|_{\mu}^{2}\left(\bm{Q}-\frac{\bm{1}_{ T}\bm{1}_{N}^{\top}}{T}\right)}{T}\] \[\qquad+\frac{\eta_{A}}{K_{Q}}\left\langle\bm{h}_{A,\,\tau},\bm{Q }\right\rangle_{\mu}\left(\bm{Q}-\frac{\bm{1}_{T}\bm{1}_{N}^{\top}}{T}\right)- \eta_{A}\bm{h}_{A}\]\[=\left(1-\eta_{A}K_{P}\alpha_{V}^{2}-\eta_{A}\left\|\mathbf{\Delta}_{V} \right\|_{\mu}^{2}\mathbf{\Delta}_{A}\right)\mathbf{\Delta}_{A}+\frac{\eta_{A}}{ K_{Q}}\left\langle\boldsymbol{h}_{A,\tau},\boldsymbol{Q}\right\rangle_{\mu} \left(\boldsymbol{Q}-\frac{\mathbf{1}_{T}\mathbf{1}_{N}^{\top}}{T}\right)-\eta_ {A}\boldsymbol{h}_{A}.\]

Recall that \(\left\langle\mathbf{\Delta}_{A},\boldsymbol{Q}-\mathbf{1}\mathbf{1}^{\top}/T \right\rangle_{\mu}=0\), \(\left\|\boldsymbol{Q}-\mathbf{1}\mathbf{1}^{\top}/T\right\|_{\mu}^{2}=K_{Q}\), and \(\left\langle\boldsymbol{1}\mathbf{1}_{T}^{\top}/T,\boldsymbol{h}_{A}\right\rangle _{\mu}=0\). Hence,

\[\left\|\mathbf{\Delta}_{A,\tau+1}\right\|_{\mu}^{2} =\left\|\left(1-\eta_{A}K_{P}\alpha_{V}^{2}-\eta_{A}\left\| \mathbf{\Delta}_{V}\right\|_{\mu}^{2}\right)\mathbf{\Delta}_{A}+\frac{\eta_{A }}{K_{Q}}\left\langle\boldsymbol{h}_{A,\tau},\boldsymbol{Q}\right\rangle_{\mu }\left(\boldsymbol{Q}-\frac{\mathbf{1}_{T}\mathbf{1}_{N}^{\top}}{T}\right)- \eta_{A}\boldsymbol{h}_{A}\right\|_{\mu}^{2}\] \[=\left(1-\eta_{A}K_{P}\alpha_{V}^{2}-\eta_{A}\left\|\mathbf{ \Delta}_{V}\right\|_{\mu}^{2}\right)^{2}\left\|\mathbf{\Delta}_{A}\right\|_{ \mu}^{2}+\left(\frac{\eta_{A}}{K_{Q}}\left\langle\boldsymbol{h}_{A,\tau}, \boldsymbol{Q}\right\rangle_{\mu}\right)^{2}K_{Q}+\eta_{A}^{2}\left\| \boldsymbol{h}_{A}\right\|_{\mu}^{2}\] \[\qquad-2\eta_{A}\left(1-\eta_{A}K_{P}\alpha_{V}^{2}-\eta_{A} \left\|\mathbf{\Delta}_{V}\right\|_{\mu}^{2}\right)\left\langle\mathbf{\Delta }_{A},\boldsymbol{h}_{A}\right\rangle_{\mu}\] \[\qquad-2\frac{\eta_{A}^{2}}{K_{Q}}\left\langle\boldsymbol{h}_{A, \tau},\boldsymbol{Q}\right\rangle_{\mu}\left\langle\boldsymbol{Q},\boldsymbol{ h}_{A}\right\rangle_{\mu}\] \[=\left(1-\eta_{A}K_{P}\alpha_{V}^{2}-\eta_{A}\left\|\mathbf{ \Delta}_{V}\right\|_{\mu}^{2}\right)^{2}\left\|\mathbf{\Delta}_{A}\right\|_{ \mu}^{2}-2\eta_{A}\left(1-\eta_{A}K_{P}\alpha_{V}^{2}-\eta_{A}\left\|\mathbf{ \Delta}_{V}\right\|_{\mu}^{2}\right)\left\langle\mathbf{\Delta}_{A}, \boldsymbol{h}_{A}\right\rangle_{\mu}\] \[\qquad+\eta_{A}^{2}\left\|\boldsymbol{h}_{A}\right\|_{\mu}^{2}- \frac{\eta_{A}^{2}}{K_{Q}}\left\langle\boldsymbol{h}_{A,\tau},\boldsymbol{Q} \right\rangle_{\mu}^{2}.\]

Now, consider \(\mathbf{\Delta}_{V}\). Similar to the previous calculation, we have

\[\mathbf{\Delta}_{V,\tau+1} =\mathbf{\Delta}_{V}-\eta_{V}\left(\alpha_{A}^{2}K_{Q}+\frac{1}{T }\right)\mathbf{\Delta}_{V}-\eta_{V}\left\|\mathbf{\Delta}_{A}\right\|^{2} \mathbf{\Delta}_{V}-\eta_{V}\boldsymbol{h}_{V}\] \[\qquad-\eta_{V}\frac{\alpha_{V}-1}{T}\left(\boldsymbol{P}- \boldsymbol{\mu}\mathbf{1}^{\top}\right)-\eta_{V}\left\|\mathbf{\Delta}_{A} \right\|^{2}\left(\boldsymbol{\tilde{V}}-\boldsymbol{\mu}\mathbf{1}^{\top}\right)\] \[\qquad-\left(\eta_{V}\frac{1-\alpha_{V}}{T}-\eta_{V}\alpha_{V} \left\|\mathbf{\Delta}_{A}\right\|^{2}-\frac{\eta_{V}}{K_{P}}\left\langle \boldsymbol{h}_{V,\tau},\boldsymbol{P}\right\rangle_{\mu}\right)\left(\boldsymbol {P}-\boldsymbol{\mu}\mathbf{1}^{\top}\right)\] \[=\left(1-\eta_{V}\left(\alpha_{A}^{2}K_{Q}+\frac{1}{T}\right)- \eta_{V}\left\|\mathbf{\Delta}_{A}\right\|^{2}\right)\mathbf{\Delta}_{V}\] \[\qquad+\frac{\eta_{V}}{K_{P}}\left\langle\boldsymbol{h}_{V,\tau}, \boldsymbol{P}\right\rangle_{\mu}\left(\boldsymbol{P}-\boldsymbol{\mu}\mathbf{1}^ {\top}\right)-\eta_{V}\boldsymbol{h}_{V}.\]

Again, note that \(\mathbf{\Delta}_{V}\perp_{\mu}\boldsymbol{P}-\boldsymbol{\mu}\mathbf{1}^{\top}\), \(\left\|\boldsymbol{P}-\boldsymbol{\mu}\mathbf{1}^{\top}\right\|_{\mu}^{2}=K_{P}\), and \(\left\langle\boldsymbol{\mu}\mathbf{1}^{\top},\boldsymbol{h}_{V}\right\rangle_{ \mu}=0\). Hence, we have

\[\left\|\mathbf{\Delta}_{V,\tau+1}\right\|_{\mu}^{2} =\left(1-\eta_{V}\left(\alpha_{A}^{2}K_{Q}+\frac{1}{T}\right)- \eta_{V}\left\|\mathbf{\Delta}_{A}\right\|^{2}\right)^{2}\left\|\mathbf{\Delta}_ {V}\right\|_{\mu}^{2}\] \[\qquad+2\eta_{V}\left(1-\eta_{V}\left(\alpha_{A}^{2}K_{Q}+\frac{1} {T}\right)-\eta_{V}\left\|\mathbf{\Delta}_{A}\right\|^{2}\right)\left\langle \mathbf{\Delta}_{V},\boldsymbol{h}_{V}\right\rangle_{\mu}\] \[\qquad-\frac{\eta_{V}^{2}}{K_{P}}\left\langle\boldsymbol{P}, \boldsymbol{h}_{V}\right\rangle_{\mu}^{2}+\eta_{V}^{2}\left\|\boldsymbol{h}_{V} \right\|_{\mu}^{2}.\]

## Appendix D Stage 1: signal boosting

In this section, we assume both \(\alpha_{V}\) and \(\alpha_{A}\) are close to \(0\). In this case, we can approximate Lemma C.5 with

\[\alpha_{V,\tau+1} \approx\alpha_{V,\tau}+\eta\alpha_{A}+\eta\frac{1}{TK_{Q}}-\eta \alpha_{V}\frac{\left\|\mathbf{\Delta}_{A}\right\|_{\mu}^{2}}{K_{Q}}-\eta\frac{ \left\langle\boldsymbol{h}_{V},\boldsymbol{P}\right\rangle_{\mu}}{K_{Q}K_{P}},\] \[\alpha_{A,\tau+1} \approx\alpha_{A,\tau}+\eta\alpha_{V}-\eta\alpha_{A}\frac{\left\| \mathbf{\Delta}_{V}\right\|_{\mu}^{2}}{K_{P}}-\eta\frac{\left\langle\boldsymbol{h} _{A},\boldsymbol{Q}\right\rangle_{\mu}}{K_{P}K_{Q}}.\]

We can also write this matrix form as

\[\begin{bmatrix}\alpha_{V,\tau+1}\\ \alpha_{A,\tau+1}\end{bmatrix}\approx\begin{bmatrix}\alpha_{V,\tau}\\ \alpha_{A,\tau}\end{bmatrix}+\eta\begin{bmatrix}-\left\|\mathbf{\Delta}_{A} \right\|_{\mu}^{2}/K_{Q}&1\\ 1&-\left\|\mathbf{\Delta}_{V}\right\|_{\mu}^{2}/K_{P}\end{bmatrix}\begin{bmatrix} \alpha_{V,\tau}\\ \alpha_{A,\tau}\end{bmatrix}\]\[+\eta\begin{bmatrix}1/(TK_{Q})\\ 0\end{bmatrix}-\eta\begin{bmatrix}\alpha_{A}\left\|\mathbf{\Lambda}_{V}\right\|_{ \mu}^{2}/(K_{P}K_{Q})\\ \left\langle\boldsymbol{h}_{A},\boldsymbol{Q}\right\rangle_{\mu}/(K_{P}K_{Q}).\end{bmatrix}\]

Suppose that \(\left\|\boldsymbol{\Lambda}_{A}\right\|_{\mu}^{2}/K_{Q}\) and \(\left\|\boldsymbol{\Lambda}_{V}\right\|_{\mu}^{2}/K_{P}\) are both bounded by \(\delta^{2}\). Then, we have

\[\begin{split}\alpha_{V,\,\tau+1}+\alpha_{A,\,\tau+1}& \gtrless\,(1+\eta-2\delta^{2}\eta)\left(\alpha_{V,\,\tau}+\alpha_{A,\tau} \right)+\eta\frac{1}{TK_{Q}}\\ &-\eta\frac{\left\langle\boldsymbol{h}_{V},\boldsymbol{P}\right\rangle _{\mu}}{K_{Q}K_{P}}-\eta\frac{\left\langle\boldsymbol{h}_{A},\boldsymbol{Q} \right\rangle_{\mu}}{K_{P}K_{Q}}.\end{split}\] (11)

As long as \(\delta\ll 1\) and we choose a sufficiently large batch size so that the second line is bounded by \(\eta/(2TK_{Q})\), \(\alpha_{V}+\alpha_{A}\) grows exponentially fast. Similarly, one can also bound the difference between \(\alpha_{V}\) and \(\alpha_{A}\). Formally, we have the following lemma.

**Lemma D.1** (Main result of Stage 1).: _Define the end of Stage 1 as_

\[\mathcal{T}_{1}:=\min\left\{\tau\geq 0\;:\;\max\{\alpha_{V,\,\tau},\alpha_{A, \,\tau}\}\geq\min\left\{\frac{1}{2},\frac{\Theta(1)}{QN}\right\}\right\}.\]

_Suppose \(\eta\leq 1/10,\eta_{V,\,\tau}=\eta/K_{Q}\), and \(\eta_{A,\,\tau}=\eta/K_{P}\) for some \(\eta\leq\min\{K_{P},K_{Q}\}\). Let \(B_{\tau}>0\) be the number fresh samples we use at step \(\tau\). Suppose that \(B_{\tau}\geq\tilde{O}\left(\frac{T^{2}Q^{4}N^{3}}{\min\{K_{P}^{3},K_{Q}^{3}\}}\right)\) are chosen s.t. with probability \(1-\delta_{\tau}\)_

\[\max\left\{\left|\frac{\left\langle\boldsymbol{h}_{V},\boldsymbol{P}\right\rangle _{\mu}}{K_{Q}K_{P}}\right|,\left|\frac{\left\langle\boldsymbol{h}_{A}, \boldsymbol{Q}\right\rangle_{\mu}}{K_{P}K_{Q}}\right|\right\}\leq\frac{1}{4TK_ {Q}},\] (12)

\[\max\left\{\left\|\boldsymbol{h}_{V,\,\tau}\right\|_{\mu},\left\|\boldsymbol{ h}_{A,\,\tau}\right\|_{\mu}\right\}\leq\frac{\Theta(1)\min\left\{K_{Q}^{1/2},K_{P}^{1/2},\frac{1}{\sqrt{QN^{1/2}}}\right\}\min\{K_{Q},K_{P}\}}{T\log TK_{Q}}\] (13)

_Then, the following hold with probability at least \(1-\delta_{P}\):_

* \(\mathcal{T}_{1}\leq\Theta(1)\log\bigl{(}TK_{Q}\bigr{)}/\eta\)_._
* _Throughout Stage 1,_ \(\left\|\boldsymbol{\Lambda}_{A}\right\|_{\mu}^{2}\leq\Delta/T\) _and_ \(\left\|\boldsymbol{\Lambda}_{V}\right\|_{\mu}^{2}\leq\Delta/T\)_, where_ \[\Delta:=\min\left\{\frac{1}{4}K_{Q},\frac{1}{4}K_{P},\frac{\Theta(1)}{Q^{4}N^{ 3}}\right\}.\]
* _At_ \(\mathcal{T}_{1}\)_, we have_ \(\alpha_{V}+\alpha_{A}=\Theta(\frac{1}{QN})\) _and_ \(|\alpha_{V}-\alpha_{A}|\leq\frac{\Theta(1)}{TK_{Q}}\)_._
* _For all_ \(\tau\leq\mathcal{T}_{1}\)_, we have_ \(\left\|\boldsymbol{V}\right\|_{\infty}\leq\Theta(1),\left\|\boldsymbol{A} \right\|_{\infty}\leq\Theta(1/Q)\)_._

The proof of this lemma is a large induction argument. We will first assume the bounds on \(\left\|\boldsymbol{\Lambda}_{A}\right\|_{\mu}\) and \(\left\|\boldsymbol{\Lambda}_{V}\right\|_{\mu}\) are true, so that the approximation (11) is valid. This will give us an upper bound on the length of Stage 1. Then, we show that within this many steps, the errors cannot exceed the given maximum values. Thus, the induction hypotheses are true and Lemma D.1 can be established.

Part I of the proof of Lemma D.1: Signal growth rate

Proof.: Since \(\alpha_{V}\alpha_{A}\leq\frac{1}{4}\) by definition of Stage I, we can rewrite Lemma C.5 as

\[\alpha_{V,\,\tau+1}+\alpha_{A,\,\tau+1} \geq\,(1+3\eta/4)\left(\alpha_{V,\,\tau}+\alpha_{A,\,\tau}\right)+ \eta\frac{3}{4TK_{Q}}\] \[\qquad-\eta\alpha_{V}\frac{\left\|\boldsymbol{\Lambda}_{A}\right\| _{\mu}^{2}}{K_{Q}}-\eta\alpha_{A}\frac{\left\|\boldsymbol{\Lambda}_{V}\right\| _{\mu}^{2}}{K_{P}}-\eta\frac{\left\langle\boldsymbol{h}_{V},\boldsymbol{P} \right\rangle_{\mu}}{K_{Q}K_{P}}-\eta\frac{\left\langle\boldsymbol{h}_{A}, \boldsymbol{Q}\right\rangle_{\mu}}{K_{P}K_{Q}}\] \[\geq\,(1+3\eta/4)\left(\alpha_{V,\,\tau}+\alpha_{A,\,\tau}\right)+ \eta\frac{3}{4TK_{Q}}-\frac{1}{4}\eta\alpha_{V}-\frac{1}{4}\eta\alpha_{A}- \frac{1}{4TK_{Q}}\times 2\]\[\geq\left(1+\frac{\eta}{2}\right)\left(\alpha_{V,\,\tau}+\alpha_{A,\,\tau} \right)+\eta\frac{1}{4TK_{Q}},\]

where the second line comes from induction hypothesis (b) and (12). Recursively expand the RHS, and we obtain

\[\alpha_{V,\,\tau}+\alpha_{A,\,\tau}\geq\left(1+\frac{\eta}{2}\right)^{\tau} \left(\alpha_{V,0}+\alpha_{A,0}+\frac{1}{2TK_{Q}}\right)-\frac{1}{2TK_{Q}}= \left(\left(1+\frac{\eta}{2}\right)^{\tau}-1\right)\frac{1}{2TK_{Q}}.\]

Since the RHS is upper bounded by \(1\) by definition of stage I, and we obtain

\[\mathcal{T}_{1}\leq\Theta(1)\frac{\log\bigl{(}TK_{Q}\bigr{)}}{\eta}.\]

Part II of the proof of Lemma D.1: Upper bounds on \(\left\|\mathbf{A}\right\|_{\mu}\)

Proof.: Recall from Lemma C.6 that

\[\left\|\mathbf{A}_{\boldsymbol{V},\,\tau+1}\right\|_{\mu}^{2} \leq\left\|\mathbf{A}_{\boldsymbol{V},\,\tau}\right\|_{\mu}^{2}+2 \eta_{V}\left\|\mathbf{A}_{\boldsymbol{V},\,\tau}\right\|_{\mu}\left\| \mathbf{h}_{\boldsymbol{V},\,\tau}\right\|_{\mu}+\eta_{V}^{2}\left\| \mathbf{h}_{\boldsymbol{V},\,\tau}\right\|_{\mu}^{2},\] \[\left\|\mathbf{A}_{\boldsymbol{A},\,\tau+1}\right\|_{\mu}^{2} \leq\left\|\mathbf{A}_{\boldsymbol{A},\,\tau}\right\|_{\mu}^{2}+2 \eta_{A}\left\|\mathbf{A}_{\boldsymbol{A},\,\tau}\right\|_{\mu}\left\| \mathbf{h}_{\boldsymbol{A},\,\tau}\right\|_{\mu}+\eta_{A}^{2}\left\| \mathbf{h}_{\boldsymbol{A},\,\tau}\right\|_{\mu}^{2}.\]

By part I of the proof, Stage 1 takes at most \(\Theta(1)\log(TK_{Q})/\eta\) steps. Hence, it suffices to bound the increase of these \(\left\|\mathbf{A}\right\|_{\mu}^{2}\) in this many steps. Recall the notation \(\Delta=\min\left\{\frac{1}{4}K_{Q},\,\frac{1}{4}K_{P},\frac{\Theta(1)}{QN^{1/ 2}}\right\}\). By induction hypothesis (b), we have for all \(\tau\),

\[\left\|\mathbf{A}_{\boldsymbol{V},\,\tau+1}\right\|_{\mu}^{2} \leq\left\|\mathbf{A}_{\boldsymbol{V},\,\tau}\right\|_{\mu}^{2}+2 \eta_{V}\left\|\mathbf{A}_{\boldsymbol{V},\,\tau}\right\|_{\mu}\left\| \mathbf{h}_{\boldsymbol{V},\,\tau}\right\|_{\mu}+\eta_{V}^{2}\left\| \mathbf{h}_{\boldsymbol{V},\,\tau}\right\|_{\mu}^{2}\] \[\leq\left\|\mathbf{A}_{\boldsymbol{V},\,\tau}\right\|_{\mu}^{2}+2 \eta_{V}\sqrt{\Delta/T}\left\|\mathbf{h}_{\boldsymbol{V},\,\tau}\right\|_{\mu} +\eta_{V}^{2}\left\|\mathbf{h}_{\boldsymbol{V},\,\tau}\right\|_{\mu}^{2}\] \[\leq\left\|\mathbf{A}_{\boldsymbol{V},\,\tau}\right\|_{\mu}^{2}+ \frac{\Theta(1)\eta\sqrt{\Delta/T}}{K_{Q}}\cdot\frac{\sqrt{\Delta/T}\min\{K_{P}, K_{Q}\}}{\log\bigl{(}TK_{Q}\bigr{)}}+\eta^{2}\frac{\Theta(1)\Delta\cdot\min\{K_{P}^{2}, K_{Q}^{2}\}}{TK_{Q}^{2}\log\bigl{(}TK_{Q}\bigr{)}^{2}}\] \[\left\|\mathbf{A}_{\boldsymbol{A},\,\tau+1}\right\|_{\mu}^{2} \leq\left\|\mathbf{A}_{\boldsymbol{A},\,\tau}\right\|_{\mu}^{2}+2 \eta_{A}\left\|\mathbf{A}_{\boldsymbol{A},\,\tau}\right\|_{\mu}\left\| \mathbf{h}_{\boldsymbol{A},\,\tau}\right\|_{\mu}+\eta_{A}^{2}\left\| \mathbf{h}_{\boldsymbol{A},\,\tau}\right\|_{\mu}^{2}\] \[\leq\left\|\mathbf{A}_{\boldsymbol{A},\,\tau}\right\|_{\mu}^{2}+ 2\eta_{A}\sqrt{\Delta/T}\left\|\mathbf{h}_{\boldsymbol{A},\,\tau}\right\|_{\mu} +\eta_{A}^{2}\left\|\mathbf{h}_{\boldsymbol{A},\,\tau}\right\|_{\mu}^{2}\] \[\leq\left\|\mathbf{A}_{\boldsymbol{A},\,\tau}\right\|_{\mu}^{2}+ \frac{\Theta(1)\eta\sqrt{\Delta/T}}{K_{P}}\cdot\frac{\sqrt{\Delta/T}\min\{K_{P}, K_{Q}\}}{\log\bigl{(}TK_{Q}\bigr{)}}+\eta^{2}\frac{\Theta(1)\Delta\cdot\min\{K_{P}^{2}, K_{Q}^{2}\}}{TK_{P}^{2}\log\bigl{(}TK_{Q}\bigr{)}^{2}}\]

Since Stage I at most takes \(\mathcal{T}_{1}=\Theta(1)\log(TK_{Q})/\eta\) steps, the increase of \(\left\|\mathbf{A}_{\boldsymbol{A},\,\tau}\right\|_{\mu}^{2}\) and \(\left\|\mathbf{A}_{\boldsymbol{A},\,\tau}\right\|_{\mu}^{2}\) in \(\tau\leq\mathcal{T}_{1}\) are at most (since \(\mathbf{A}_{\boldsymbol{A},0}=0,\mathbf{A}_{\boldsymbol{V},0}=0\)):

\[\left\|\mathbf{A}_{\boldsymbol{V},\,\tau}\right\|_{\mu}^{2} \leq\left(\frac{\Theta(1)\eta\sqrt{\Delta/T}}{K_{Q}}\cdot\frac{ \sqrt{\Delta/T}\min\{K_{P},K_{Q}\}}{\log\bigl{(}TK_{Q}\bigr{)}}+\eta^{2}\frac {\Theta(1)\Delta\cdot\min\{K_{P}^{2},K_{Q}^{2}\}}{TK_{Q}^{2}\log\bigl{(}TK_{Q} \bigr{)}}\right)t\] \[\leq\left(\frac{\Theta(1)\eta\sqrt{\Delta/T}}{K_{Q}}\cdot\frac{ \sqrt{\Delta/T}\min\{K_{P},K_{Q}\}}{\log\bigl{(}TK_{Q}\bigr{)}^{2}}+\eta^{2} \frac{\Theta(1)\Delta\cdot\min\{K_{P}^{2},K_{Q}^{2}\}}{TK_{Q}^{2}\log\bigl{(}TK_{Q} \bigr{)}^{2}}\right)\mathcal{T}_{1}\leq\Delta/T,\] \[\left\|\mathbf{A}_{\boldsymbol{A},\,\tau}\right\|_{\mu}^{2} \leq\left(\frac{\Theta(1)\eta\sqrt{\Delta/T}}{K_{P}}\cdot\frac{ \sqrt{\Delta/T}\min\{K_{P},K_{Q}\}}{\log\bigl{(}TK_{Q}\bigr{)}}+\eta^{2}\frac{ \Theta(1)\Delta\cdot\min\{K_{P}^{2},K_{Q}^{2}\}}{TK_{P}^{2}\log\bigl{(}TK_{Q} \bigr{)}^{2}}\right)t\] \[\leq\left(\frac{\Theta(1)\eta\sqrt{\Delta/T}}{K_{P}}\cdot\frac{ \sqrt{\Delta/T}\min\{K_{P},K_{Q}\}}{\log\bigl{(}TK_{Q}\bigr{)}}+\eta^{2}\frac {\Theta(1)\Delta\cdot\min\{K_{P}^{2},K_{Q}^{2}\}}{TK_{P}^{2}\log\bigl{(}TK_{Q} \bigr{)}^{2}}\right)\mathcal{T}_{1}\leq\Delta/T.\]

Therefore, we completed the induction for the error terms.

### Part III of the proof of Lemma D.1: Ending state

Proof.: First, consider the distance between \(\alpha_{V}\) and \(\alpha_{A}\). Similar to the part I of the proof, we rewrite Lemma C.5 as

\[\alpha_{V,\tau+1}-\alpha_{A,\tau+1}= -\left(1-\eta\left(1-\alpha_{V}\alpha_{A}\right)\right)\left( \alpha_{V,\tau}-\alpha_{A,\tau}\right)+\eta\frac{1-\alpha_{V}}{TK_{Q}}\] \[-\eta\alpha_{V}\frac{\left\|\bm{\Lambda}_{A}\right\|_{\mu}^{2}}{K _{Q}}+\eta\alpha_{A}\frac{\left\|\bm{\Lambda}_{V}\right\|_{\mu}^{2}}{K_{P}}- \eta\frac{\left\langle\bm{h}_{V},\bm{P}\right\rangle_{\mu}}{K_{Q}K_{P}}+\eta \frac{\left\langle\bm{h}_{A},\bm{Q}\right\rangle_{\mu}}{K_{P}K_{Q}}\] \[= -\left(1-\eta/2\right)\left(\alpha_{V,\tau}-\alpha_{A,\tau} \right)\pm O\left(\eta\frac{1}{TK_{Q}}\right).\]

Thus, whenever \(\alpha_{V,\tau}-\alpha_{A,\tau}\geq\Omega(1/(TK_{Q}))\), it will start to decrease. Since the amount of increase at each step is also upper bounded by \(O(1/(TK_{Q}))\), this implies \(\left|\alpha_{V,\tau}-\alpha_{A,\tau}\right|\leq O(1/(TK_{Q}))\). The other direction can be proved in the same way.

Finally, we bound the possible amount of overshot. By the part I of the proof, we can also upper bound the signal term growth

\[\alpha_{V,\tau+1}+\alpha_{V,\tau+1}\leq\left(1+2\eta\right)\left(\alpha_{V, \tau}+\alpha_{A,\tau}\right)+O\left(\frac{\eta}{TK_{Q}}\right).\]

Since \(\alpha_{V,\tau}+\alpha_{A,\tau}\leq 1\) for all \(\tau\leq\mathcal{T}_{1}\), we have \(\alpha_{V}+\alpha_{A}=\Theta(\frac{1}{Q^{N}})\) at time \(\mathcal{T}_{1}\). 

### Part IV of the proof of Lemma D.1: Upper bound on Infinity norm of \(\bm{V}\) and \(\bm{A}\)

Here we consider the upper bound of the weights \(\bm{V}\) and \(\bm{A}\), which can be used in the concentration section below.

Proof.: First, we upper bound the infinity norm of \(\bm{V}_{\tau}\).

and we can upper bound \(\left\|\bm{\Lambda}_{\bm{V}}\right\|_{F}\) by its \(\mu\)-norm:

\[\left\|\bm{\Lambda}_{\bm{V}}\right\|_{\mu}^{2}=\left\langle\bm{\Lambda}_{\bm {V}},\bm{\Lambda}_{\bm{V}}\operatorname{diag}(\mu)\right\rangle\geq\frac{c}{ N}\left\|\bm{\Lambda}_{\bm{V}}\right\|_{F}^{2}.\]

Thus we have \(\left\|\bm{V}_{\tau}\right\|_{\infty}\leq\left\|\tilde{\bm{V}}_{\tau}\right\| _{\infty}+\Theta(1)\sqrt{N}\left\|\bm{\Lambda}_{\bm{V}}\right\|_{\mu}\leq \left\|\tilde{\bm{V}}_{\tau}\right\|_{\infty}+\Theta(\frac{1}{Q^{2N}})\) by Induction hypothesis (b). And we can further bound \(\left\|\tilde{\bm{V}}_{\tau}\right\|_{\infty}\):

\[\left\|\tilde{\bm{V}}_{\tau}\right\|_{\infty}=\left\|\alpha_{V,\tau}\bm{P}+(1- \alpha_{V,\tau})\mu\bm{1}^{\top}\right\|_{\infty}\leq\left\|\bm{P}\right\|_{ \infty}+\left\|\mu\bm{1}^{\top}\right\|_{\infty}\leq\Theta(1).\]

Therefore, we have \(\left\|\bm{V}_{\tau}\right\|_{\infty}\leq\Theta(1)\).

Similarly, for \(\bm{A}\) we have (since \(\left\|\tilde{\bm{A}}_{\tau}\right\|_{\infty}=\left\|\bm{1}_{\bm{T}}\bm{1}_{N }^{\top}/T+\alpha_{A,\tau}\left(\bm{Q}-\bm{1}_{\bm{T}}\bm{1}_{N}^{\top}/T \right)\right\|_{\infty}\leq C/Q\).)

\[\left\|\bm{A}_{\tau}\right\|_{\infty}=\left\|\tilde{\bm{A}}_{\tau}+\bm{\Lambda }_{\bm{A}}\right\|_{\infty}\leq\left\|\tilde{\bm{A}}_{\tau}\right\|_{\infty}+ \left\|\bm{\Lambda}_{\bm{A}}\right\|_{\infty}\leq\left\|\tilde{\bm{A}}_{\tau} \right\|_{\infty}+\left\|\bm{\Lambda}_{\bm{A}}\right\|_{F}\leq\Theta(1/Q).\]

### Part V of the proof of Lemma D.1: Concentration

Finally, we need to ensure that with high probability, all the error terms \(\bm{h}\) cannot exceed the given bounds throughout \(t\leq\mathcal{T}_{1}\). We use Lemma B.12 and Lemma B.13 to bound the concentration of the error terms.

By Lemma B.13 and union bound, we have that if \(B_{\tau}\geq\frac{\Theta(1)\mathcal{T}_{1}\cdot T^{2}Q^{4}N^{5}\mathcal{T}_{1} \log^{2}(TK_{Q})}{\delta_{\tau}\min\left\{K_{P}^{2},K_{Q}^{3},1\right\}}\), then with probability at least \(1-\delta_{\tau}/2\), the following holds for all \(t\leq\mathcal{T}_{1}\):

\[\max\left\{\left\|\bm{h}_{V,\tau}\right\|_{\mu},\left\|\bm{h}_{A,\tau}\right\| _{\mu}\right\}\leq\frac{\Theta(1)\min\left\{K_{Q}^{1/2},K_{P}^{1/2},\frac{1}{Q ^{2}N^{3/2}}\right\}\min\left\{K_{Q},K_{P}\right\}}{\sqrt{T}\log TK_{Q}}\]By Lemma B.12 and union bound, we have that if \(B_{\tau}\geq\frac{\Theta(1)\mathcal{T}_{1}\cdot T^{2}\max\{N^{2},\bm{Q}^{2}\}N^{ 4}\log\left(\frac{\|\bm{h}_{\bm{Q}}\left(\bm{T}\bm{K}_{Q}\right)}{\delta_{\tau }\eta}\right)}{K_{P}^{2}}\), then with probability at least \(1-\delta_{\tau}/2\), the following holds for all \(t\leq\mathcal{T}_{1}\):

\[\left|\frac{\left\langle\bm{h}_{\bm{V}},\bm{P}\right\rangle_{\mu}}{K_{P}K_{Q}} \right|\leq\frac{1}{4TK_{Q}},\ \left|\frac{\left\langle\bm{h}_{\bm{A}},\bm{Q}\right\rangle_{\mu}}{K_{P}K_{Q}} \right|\leq\frac{1}{4TK_{Q}}.\]

And by union bound, we have that with probability at least \(1-\delta_{\tau}\), all the bounds above hold for all \(t\leq\mathcal{T}_{1}\). Therefore, we conclude the proof of Lemma D.1.

Stage 2: learning the model

In this Stage 2, we use a positive \(\lambda\) for the \(\ell_{1}\)-regularization. In this case, we can write the update rule of each \(\bm{a}^{(k)}\) as

\[\bm{a}^{(k,^{\prime})}_{\tau+1} =\bm{a}^{(k)}_{\tau}-\frac{\eta_{A}}{\mu_{k}}\nabla^{(B_{\tau})}_{ \bm{a}^{(k)}}I, \text{(gradient descent step)},\] (14) \[a^{(k,^{\prime\prime})}_{\tau+1,t} =\begin{cases}a^{(k,^{\prime})}_{\tau+1,t}-\lambda,&\text{if }a^{(k,^{\prime})}_{\tau+1,t}\geq \lambda,\\ 0,&\text{if }\left|a^{(k,^{\prime})}_{\tau+1,t}\right|\leq\lambda,\end{cases} \text{(proximal step)},\] \[\bm{a}^{(k)}_{\tau+1} =\bm{a}^{(k,^{\prime\prime})}_{\tau+1}+\left(1-1^{\tau}\bm{a}^{(k,^{\prime\prime})}_{\tau+1}\right)\frac{\bm{1}}{T}, \text{(projection step)}.\]

For notational simplicity, we define

\[\bm{g}^{(k)}_{\tau}:=-\eta_{\tau}^{-1}(\bm{a}^{(k)}_{\tau+1}-\bm{a}^{(k)}_{ \tau}).\]

We further define \(\bm{G}_{\lambda,\tau}=-\eta_{A}^{-1}(\bm{A}_{\tau+1}-\bm{A}_{\tau})\) as the full gradient of the matrix \(\bm{A}\).

First, we will show that with appropriate rounding at the beginning of Stage 2, we can ensure \(\bm{g}^{(k)}_{\tau}\approx\eta\operatorname{\mathbb{E}}\hat{\nabla}_{\bm{a}^{( k)}}l\) using only \(B_{\tau}\propto\log(T)\) fresh samples at each step (Section E.1).

### Rounding and gradient denoising

Recall that the first step of the Stage 2 is rounding each \(\bm{a}^{(k)}\) by setting all small coordinates to 0 and then projecting it back to the affine space the probability simplex lies. Since after Stage 1, there will be a separation between \(a^{(k)}_{t}\) with \(t\in\bm{q}^{(k)}\) and \(t\notin\bm{q}^{(k)}\), this rounding step makes all \(a^{(k)}_{t}\) with \(t\notin\bm{q}^{(k)}\) have the same small value.

Also recall that we use \(\ell_{1}\)-regularization and proximal gradients in the Stage 2. Effectively, the \(\ell_{1}\)-regularization ensures those useless \(a^{(k)}_{t}\) are always 0 (before projection). Then, similar to the first rounding step, projection will again make then have the same small value.

In this subsection, we formalize the above argument. We show that the rounding step can recover the support of \(\bm{q}^{(k)}\), analyze its influence on \(\alpha_{A}\) and the distance to the population subspace. Then, we analyze the effect of use of the proximal gradients and show that with \(\operatorname{poly}(N,Q)\log(T)\) fresh samples at each step, we can make sure the difference between update and the population update is small with high probability.

**Lemma E.1** (Separation between noise and signal).: _Assume that at the beginning of Stage 2, we have_

\[\alpha_{V} \geq\Theta\left(\frac{Q}{T}+Q\sqrt{N}\left\lVert\bm{\Lambda}_{ \bm{A}}\right\rVert_{\mu}\right).\]

_Then, we can choose a threshold \(\theta_{\texttt{Tmp}}=\Theta(\alpha_{V}/Q)\) s.t. \(a^{(k)}_{t}\leq\theta_{\texttt{Tmp}}\) iff \(\sigma^{(k)}_{t}=0\)._

Proof.: Note that there exists some universal constant \(c>0\) such that \(\bm{q}^{(k)}_{t}\geq c/Q\) for all nonzero \(q^{(k)}_{t}\) and \(\mu_{k}\geq c/N\) for all \(k\in[N]\). Recall that the population process \(\tilde{A}=\alpha_{A}\bm{Q}+(1-\alpha_{A})\bm{1}_{T}\bm{1}^{\top}_{N}/T\). Hence, for all \(k\in[N]\) and \(t\in[T]\),

\[\tilde{a}^{(k)}_{t} \leq 1/T, \text{if }t\notin\bm{q}^{(k)},\] \[\tilde{a}^{(k)}_{t} \geq c\alpha_{V}/Q, \text{if }t\in\bm{q}^{(k)}.\]

Then, note that

\[\left\lVert\bm{\Lambda}_{\bm{A}}\right\rVert_{\mu}^{2} =\sum_{t=1}^{T}\sum_{k=1}^{N}\left(a^{(k)}_{t}-\tilde{a}^{(k)}_{t }\right)^{2}\mu_{k}\] \[\geq\frac{c}{N}\sum_{t=1}^{T}\sum_{k=1}^{N}\left(a^{(k)}_{t}- \tilde{a}^{(k)}_{t}\right)^{2}\geq\frac{c}{N}\left\lVert\operatorname{Vec}( \tilde{\bm{A}}-\bm{A})\right\rVert_{2}^{2}\geq\frac{c}{N}\left\lVert \operatorname{Vec}(\tilde{\bm{A}}-\bm{A})\right\rVert_{\infty}^{2}.\]Hence, for any \(k\in[N]\) and \(t\in[T]\), we have \(\left|a_{t}^{(k)}-\bar{a}_{t}^{(k)}\right|\leq\left\|\mathbf{A}_{A}\right\|_{ \mu}\sqrt{N/c}\). Combine these together, and we obtain

\[a_{t}^{(k)}\leq 1/T+\left\|\mathbf{A}_{A}\right\|_{\mu}\sqrt{N/c}, \text{if }t\not\in\boldsymbol{q}^{(k)},\] \[a_{t}^{(k)}\geq c\alpha_{V}/Q-\left\|\mathbf{A}_{A}\right\|_{ \mu}\sqrt{N/c}, \text{if }t\in\boldsymbol{q}^{(k)}.\]

Hence, in order to get a separation,

\[1/T+\left\|\mathbf{A}_{A}\right\|_{\mu}\sqrt{N/c}\leq\frac{1}{2}\left(c\alpha _{V}/Q-\left\|\mathbf{A}_{A}\right\|_{\mu}\sqrt{N/c}\right) \quad\Leftq\quad\frac{2Q}{cT}+\frac{3Q\sqrt{N}}{c^{1.5}}\left\|\mathbf{A}_{A }\right\|_{\mu}\leq\alpha_{V}.\]

**Lemma E.2** (Effect of rounding).: _Under the conditions of Lemma E.1, choose \(\lambda\) as in Lemma E.1, and set_

\[\boldsymbol{a}^{(k)} \leftarrow\left(\boldsymbol{I}-\frac{\mathbf{1}\mathbf{1}^{\top}} {T}\right)\boldsymbol{a}^{(k)}\odot\left(\mathbbm{1}\{a_{t}^{(k)}\geq\lambda \}\right)_{t=1}^{T}+\frac{\mathbf{1}}{T}\] \[=\boldsymbol{a}^{(k)}\odot\left(\mathbbm{1}\{a_{t}^{(k)}\geq \lambda\}\right)_{t=1}^{T}+\left(1-\sum_{t\in\boldsymbol{q}^{(k)}}a_{t}^{(k)} \right)\frac{\mathbf{1}}{T}.\]

_We have \(\alpha_{A}\leftarrow\alpha_{A}+O(1)/T\) and \(\left\|\mathbf{A}_{A}\right\|_{\mu}^{2}\leftarrow\left\|\mathbf{A}_{A}\right\| _{\mu}^{2}+O(1)/T.\)_

Proof.: For notational simplicity, put \(\boldsymbol{b}^{(k)}=\boldsymbol{a}^{(k)}\odot\left(\mathbbm{1}\{a_{t}^{(k)} \geq\lambda\}\right)_{t=1}^{T}\). By Lemma E.1, we know \(\boldsymbol{b}^{(k)}\) is supported within \(\boldsymbol{q}^{(k)}\). Set \(b^{(k)}=\sum_{t=1}^{T}b_{t}^{(k)}\). Then, we can write

\[\boldsymbol{a}^{(k)}\leftarrow\boldsymbol{b}^{(k)}+\left(1-b^{(k)}\right) \frac{\mathbf{1}}{T}.\]

Recall that \(\alpha_{A}=K_{AQ}/K_{Q}\) where \(K_{AQ}=\left\langle\boldsymbol{A},\boldsymbol{Q}\right\rangle_{\mu}=\sum_{k=1} ^{N}\mu_{k}\left\langle\boldsymbol{a}^{(k)},\boldsymbol{q}^{(k)}\right\rangle\). Hence, for each \(k\in[N]\), we have

\[\left\langle\boldsymbol{a}^{(k)},\boldsymbol{q}^{(k)}\right\rangle \leftarrow\left\langle\boldsymbol{b}^{(k)},\boldsymbol{q}^{(k)} \right\rangle+\left(1-b^{(k)}\right)\left\langle\frac{\mathbf{1}}{T}, \boldsymbol{q}^{(k)}\right\rangle\] \[\leftarrow\left\langle\boldsymbol{a}^{(k)},\boldsymbol{q}^{(k)} \right\rangle+\left(1-b^{(k)}\right)\frac{\mathbf{1}}{T}.\]

As a result,

\[\alpha_{A}\leftarrow\alpha_{A}+\frac{1}{T}\sum_{k=1}^{N}\mu_{k}\left(1-b^{(k) }\right)=\alpha_{A}+\frac{O(1)}{T}.\]

Now, consider the effect of projection on the distance to the population subspace. We will use subscript new to indicate values after rounding and use notations such as \(\boldsymbol{a}^{(k)}\) to denote the values before rounding. Recall that \(\left\|\mathbf{A}_{A}\right\|_{\mu}^{2}=\sum_{k=1}^{N}\mu_{k}\left\|\boldsymbol {a}^{(k)}-\bar{\boldsymbol{a}}^{(k)}\right\|^{2}\). We have

\[\left\|\boldsymbol{a}_{\text{new}}^{(k)}-\bar{\boldsymbol{a}}_{ \text{new}}^{(k)}\right\|^{2} =\left\|\boldsymbol{b}^{(k)}+(1-b^{(k)})\frac{\mathbf{1}}{T}- \frac{\mathbf{1}}{T}-\alpha_{A,\text{new}}\left(\boldsymbol{q}^{(k)}-\frac{ \mathbf{1}}{T}\right)\right\|^{2}\] \[=\left\|\boldsymbol{b}^{(k)}-\alpha_{A,\text{new}}\boldsymbol{q}^{( k)}-\left(b^{(k)}-\alpha_{A,\text{new}}\right)\frac{\mathbf{1}}{T}\right\|^{2}\] \[=\left\|\boldsymbol{b}^{(k)}-\alpha_{A,\text{new}}\boldsymbol{q}^{ (k)}\right\|^{2}+\left(b^{(k)}-\alpha_{A,\text{new}}\right)^{2}\frac{1}{T}\] \[\qquad-2\left(b^{(k)}-\alpha_{A,\text{new}}\right)\left\langle \boldsymbol{b}^{(k)}-\alpha_{A,\text{new}}\boldsymbol{q}^{(k)},\frac{\mathbf{1 }}{T}\right\rangle\] \[=\left\|\boldsymbol{b}^{(k)}-(\alpha_{A}+O(1)/T)\boldsymbol{q}^{( k)}\right\|^{2}-\left(b^{(k)}-\alpha_{A,\text{new}}\right)^{2}\frac{1}{T}.\]

Note that

\[\left\|\boldsymbol{a}^{(k)}-\bar{\boldsymbol{a}}^{(k)}\right\|^{2} =\left\|\boldsymbol{a}^{(k)}-\alpha_{A}\boldsymbol{q}^{(k)}-(1-\alpha_{A}) \frac{\mathbf{1}}{T}\right\|^{2}=\left\|\boldsymbol{a}^{(k)}-\alpha_{A} \boldsymbol{q}^{(k)}\right\|^{2}-(1-\alpha_{A})^{2}\frac{1}{T}\]\[\geq\left\|\bm{b}^{(k)}-\alpha_{A}\bm{q}^{(k)}\right\|^{2}-(1-\alpha_{A})^{2} \frac{1}{T}.\]

Hence,

\[\left\|\bm{a}^{(k)}_{\text{new}}-\bar{\bm{a}}^{(k)}_{\text{new}} \right\|^{2}-\left\|\bm{a}^{(k)}-\bar{\bm{a}}^{(k)}\right\|^{2}\\ \leq\left\|\bm{b}^{(k)}-\alpha_{A}\bm{q}^{(k)}-\frac{O(1)}{T}\bm {q}^{(k)}\right\|^{2}-\left\|\bm{b}^{(k)}-\alpha_{A}\bm{q}^{(k)}\right\|^{2}+ \frac{O(1)}{T}\leq\frac{O(1)}{T}.\]

Thus, \(\left\|\Delta_{A}\right\|_{\mu}^{2}\leftarrow\left\|\Delta_{A}\right\|_{\mu}^ {2}+O(1)/T\). 

As we have seen in Stage 1, the norm of \(\nabla_{\bm{a}^{(k)}}l\) can scale linearly with \(T\). Hence, in order to make \(\bm{h}_{\bm{a}^{(k)},\,\tau}\) has size \(O(1)\) in terms of \(\left\|\cdot\right\|_{2}\), it is necessary to use \(\text{poly}(T)\) samples, which is undesirable. However, note that all entries of \(\nabla_{\bm{a}^{(k)}}l\) are bounded, and therefore are subgaussian. Hence, for each entry of \(\nabla_{\bm{a}^{(k)}}l\), with \(O(\log T)\) samples, we can make sure the relative error is small with probability at least \(1-1/\text{poly}(T)\). By union bound, this means the \(\left\|\cdot\right\|_{\infty}\) error can be made small using only \(\log(T)\) samples. Note that there is a separation between the signal and noise parts of \(\mathbb{E}\,\nabla_{\bm{a}^{(k)}}l\). This implies that we can distinguish them using \(\log(T)\) samples and directly remove the noise part. Formally, we have the following lemma.

**Lemma E.3** (Gradient denoising).: _Given \(\varepsilon\in\left(\Theta\Big{(}\frac{Q^{2}N^{3}}{\sqrt{T}}\Big{)},0.1\right)\). Suppose that for any \(k,m,n\in[N]\), \(|\bm{a}^{(k)}_{t}|\leq 1/T\ ift\notin\bm{q}^{(k)}\), \(|V_{n,m}|\leq O(1)\), and \(\left\|\Delta_{A}\right\|_{\mu}\leq c(1-\alpha_{V})/(\sqrt{N}Q)\) and \(\left\|\Delta_{V}\right\|_{\mu}^{2}\leq c(1-\alpha_{V})K_{P}\) for some small constant \(c>0\). For the target accuracy \(\varepsilon_{\top\mathrm{mp}}=\Theta(\frac{\varepsilon}{QN^{2}})\), we have with probability \(1-\delta_{\tau}\). If we choose_

\[B_{\tau}\geq C\frac{N^{8}Q^{4}}{\varepsilon^{2}\alpha_{V}^{2}K_{P}^{2}}\log \left(\frac{CNT}{\delta_{\tau}}\right),\]

_for some large constant \(C>0\). Then, for each \(k\in[N]\), with probability at least \(1-\delta_{\top\mathrm{mp}}\), we have_

\[\partial_{a^{(k)}_{t}}^{(B_{\tau})}l =\left(1\pm\varepsilon_{\top\mathrm{mp}}\right)\mathbb{E}\, \partial_{a^{(k)}_{t}}l\geq\Theta\left(\frac{\alpha_{V}K_{P}}{NQ}\right) \forall t\in\bm{q}^{(k)},\] \[\partial_{a^{(k)}_{t}}^{(B_{\tau})}l =O\left(\frac{1}{T}+\varepsilon_{\top\mathrm{mp}}\frac{\alpha_{V} K_{P}}{NQ}\right)=O\left(\frac{\varepsilon K_{P}}{N^{3}Q^{2}}\right) \forall t\notin\bm{q}^{(k)}.\]

Proof.: For \(s\in[T]\), recall that

\[\partial_{a^{(k)}_{s}}l =\mathbbm{1}\left\{x_{T+1}=k\right\}\left(\bm{V}\bm{e}_{x_{s}} \right)^{\top}\left(\bm{V}\bm{X}\bm{a}-\bm{e}_{x_{o}}\right),\] \[\mathbb{E}\,\partial_{a^{(k)}_{s}}l =\mu_{k}K_{V}a_{s}-\mu_{k}K_{VP}q_{s}.\]

First, consider the expectations. If \(s\notin\bm{q}^{(k)}\), then by our assumption, we have \(\left|\,\mathbb{E}\,\partial_{a^{(k)}_{s}}l\right|=\mu_{k}K_{V}a_{s}=O(K_{V}/( NT))\). Meanwhile, for \(s\in\bm{q}^{(k)}\), we have

\[-\mathbb{E}\,\partial_{a^{(k)}_{s}}l \geq\mu_{k}K_{VP}(q_{s}-a_{s})+\mu_{k}(K_{V}-K_{VP})a_{s}\] \[\geq\mu_{k}\left(\alpha_{V}(1-\alpha_{V})K_{P}q_{s}-\alpha_{V}K_{ P}\left\|\Delta_{A}\right\|_{\mu}\sqrt{N}-\left\|\Delta_{V}\right\|_{\mu}^{2}a_{s} \right).\]

As a result, we have for any \(k\in[N]\) and \(s\in\bm{q}^{(k)}\),

\[-\mathbb{E}\,\partial_{a^{(k)}_{s}}l\geq c\frac{\alpha_{V}K_{P}}{NQ}\gg O \left(\frac{K_{V}}{NT}\right) \quad\Leftq\quad\left\{\begin{aligned} &\left\|\Delta_{A}\right\|_{\mu} \leq c\frac{1-\alpha_{V}}{Q\sqrt{N}},\\ &\left\|\Delta_{V}\right\|_{\mu}^{2}\leq c(1-\alpha_{V})K_{P}, \end{aligned}\right.\]

for some small constant \(c>0\). Then, for the size of each entry, we have

\[\left|\partial_{a^{(k)}_{s}}l\right|\leq\left|\left\langle\bm{V}\bm{e}_{x_{s}} \right\rangle^{\top}\bm{V}\bm{X}\bm{a}\right|+\left|\left(\bm{V}\bm{e}_{x_{s}} \right)^{\top}\bm{e}_{x_{o}}\right|\leq\sum_{t\in\bm{q}^{(k)}}a_{t}\sum_{n=1} ^{N}\left|V_{n,x_{s}}V_{n,x_{t}}\right|+\left|V_{x_{o},x_{s}}\right|\leq N.\]Therefore, \(\partial_{a_{s}^{(k)}}l\) is \(N^{2}K_{\texttt{Tmp}}^{4}\)-subgaussian, whence \(\partial_{a_{s}^{(k)}}^{(B_{\tau})}l\) is \(N^{2}K_{\texttt{Tmp}}^{4}/B_{\tau}\)-subgaussian. As a result, for each \(\xi>0\), we have

\[\mathbb{P}\left\|\partial_{a_{s}^{(k)}}^{(B_{\tau})}l-\mathbb{B}\,\partial_{a _{s}^{(k)}}l\right|\geq\xi\right\rfloor\leq 2\exp\left(\frac{-\xi^{2}B_{\tau}}{N ^{2}}\right).\]

Apply union bound and we get

\[\mathbb{P}\left[\|\nabla_{\bm{A}}l-\mathbb{E}\,\nabla_{\bm{A}}l\|_{\infty} \geq\xi\right]\leq 2TN\exp\left(\frac{-\xi^{2}B_{\tau}}{N^{2}}\right)=\exp \left(\log(2NT)-\frac{\xi^{2}B_{\tau}}{N^{2}}\right).\]

Recall that the separation between the expectations is \(c\alpha_{V}K_{P}/(NQ)\). Hence, it suffices to choose \(\xi=c\alpha_{V}K_{P}/(2NQ)\). Then, to make the failure probability at most \(\delta_{\texttt{Tmp}}\), we can choose \(B_{\tau}\) as follows:

\[\exp\left(\log(2NT)-\frac{\xi^{2}B_{\tau}}{N^{2}}\right)\leq\delta_{\tau} \quad\Leftarrow\quad B_{\tau}\geq C\frac{N^{4}Q^{2}}{\alpha_{V}^{2}K_{P}^{2} }\log\left(\frac{CNT}{\delta_{\tau}}\right),\]

for some large constant \(C>0\). Then, to boost the accuracy from \(1/2\) to \(\varepsilon_{\texttt{Tmp}}\), it suffices to increase the batch size to \(C\frac{N^{4}Q^{2}}{\varepsilon_{\texttt{Tmp}}^{2}\alpha_{V}^{2}K_{P}^{2}}\log \left(\frac{CNT}{\delta_{\tau}}\right)\). 

Using this lemma, we can pick \(\lambda=\Theta(\frac{\varepsilon K_{P}}{Q^{2}N^{3}})\) to sparsify our proximal gradient. Notice that our proximal gradient is a biased estimate of the true preconditioned gradient, but the separation guarantees that it is possible to make the error controllable. The following lemma calculates the error each proximal step introduces. Here we define \(\hat{\bm{h}}_{\bm{A},\tau}=\bm{G}_{\lambda,\tau}^{(k)}-\mathbb{E}\,\hat{\nabla }_{\bm{A}}l\) instead of \(\bm{h}\) because of the bias introduced by the proximal gradient.

**Lemma E.4**.: _Under the same setting of Lemma E.3, if the batch size_

\[B_{\tau}\geq\max\Bigg{\{}C\frac{N^{8}Q^{4}}{\varepsilon^{2}\alpha_{V}^{2}K_{P }^{2}}\log\left(\frac{2CNT}{\delta_{\tau}}\right),\frac{\Theta(N^{6}Q^{3})}{ \delta\varepsilon^{2}}\Bigg{\}},\]

_the noise attention score \(|a_{t}^{(k)}|\leq O(1/T)\) for all \(t\notin\bm{q}^{(k)}\) and all \(k\in[N]\), and \(\lambda=\Theta\Big{(}\frac{\varepsilon K_{P}}{Q^{2}N^{3}}\Big{)}\), then with probability \(1-\delta_{\tau}\), the gradient error at iteration \(\tau\)_

\[\|\hat{\bm{h}}_{\bm{A},\tau}\|_{\mu}\coloneqq\|\bm{G}_{\lambda,\tau}-\mathbb{E }\,\hat{\nabla}_{\bm{A}}l\|_{\mu}\leq O\left(\frac{\varepsilon}{QN^{2}}\right).\]

Proof.: For notational simplicity, we drop the superscript \(k\). The goal is to estimate the difference between \(\mathbb{E}\,\hat{\nabla}_{\bm{a}}l\) and \(\bm{g}_{\lambda,\tau}\) by calculating the magnitude of the bias of the proximal gradient together with the concentration error.

We consider the population gradient first. Since we have \(\{a_{t,\tau}\}_{t\notin\bm{q}}\) are all the same in Stage 2, we can write

\[\bm{a}_{\tau}=\left[\bm{a}_{\tau}\right]_{\bm{q}}+\frac{(1-b_{\tau})\bm{1}_{ \bm{q}^{c}}}{T-Q}\quad\text{where}\quad b_{\tau}=\sum_{t\in\bm{q}}a_{t},\]

and recall the projected preconditioned gradient for \(\bm{A}\).

\[\mathbb{E}\,\hat{\nabla}_{\bm{a}}l=\left(\|\bm{V}\|_{\mu}^{2}-\|\bm{\mu}\|^{2} \right)\left(\bm{a}^{(k)}-\frac{\bm{1}}{T}\right)-\left(\langle\bm{V},\bm{P} \rangle_{\mu}-\|\bm{\mu}\|^{2}\right)\left(\bm{q}^{(k)}-\frac{\bm{1}}{T}\right).\]

Therefore, we have

\[\mathbb{E}\,\hat{\nabla}_{\bm{a}}l=\left[\mathbb{E}\,\hat{\nabla}_{\bm{a}}l \right]_{\bm{q}}+K_{\bm{V}}\frac{(1-b_{\tau})\bm{1}_{\bm{q}^{c}}}{T-Q}+(\|\bm{V} \|_{\mu}^{2}-\langle\bm{V},\bm{P}\rangle_{\mu})\frac{\bm{1}_{\bm{q}^{c}}}{T}.\]

Now, we consider \(\bm{g}\) by calculating the expression of \(\bm{a}_{\tau+1}\). First, note that by Lemma E.3, we have \(a_{t,\tau+1}^{\prime\prime}=\left(a_{t,\tau+1}^{\prime}-\lambda\right)\, \mathbb{I}\,\{t\in\bm{q}\}.\) This implies that \(\{a_{t,\tau+1}\}_{t\notin\bm{q}}\) are all the same and the value is at most \(1/T\). Moreover, it also implies that it suffices to focus on \([\bm{a}_{\tau+1}^{\prime\prime}]_{\bm{q}}\), for which we have

\[[\bm{a}_{\tau+1}^{\prime\prime}]_{\bm{q}}=[\bm{a}_{\tau+1}^{\prime}]_{\bm{q}}- \lambda\bm{1}_{\bm{q}}=[\bm{a}_{\tau}]_{\bm{q}}-\frac{\eta}{\mu_{k}}\left[ \nabla_{\bm{a}}^{(B_{\tau})}l\right]_{\bm{q}}-\lambda\bm{1}_{\bm{q}}.\]Therefore, \(\sum_{t\in\bm{q}}a^{\prime}_{t,\tau+1}=b_{\tau}-\frac{\eta}{\mu_{k}}\sum_{t\in\bm{q }}\partial_{a_{t}}^{(B_{\tau})}l-Q\lambda\) and

\[\bm{a}_{\tau+1} =\left[\bm{a}_{\tau}\right]_{\bm{q}}-\frac{\eta}{\mu_{k}}\left[ \nabla_{\bm{a}}^{(B_{\tau})}l\right]_{\bm{q}}-\lambda\bm{1}_{\bm{q}}+\left(1-b _{\tau}+\frac{\eta}{\mu_{k}}\sum_{t\in\bm{q}}\partial_{a_{t}}^{(B_{\tau})}l+Q \lambda\right)\frac{\bm{1}}{T}\] \[=\bm{a}_{\tau}-\frac{(1-b_{\tau})\bm{1}_{q^{c}}}{T-Q}-\frac{\eta} {\mu_{k}}\left[\nabla_{\bm{a}}^{(B_{\tau})}l\right]_{\bm{q}}-\lambda\bm{1}_{ \bm{q}}+\left(1-b_{\tau}+\frac{\eta}{\mu_{k}}\sum_{t\in\bm{q}}\partial_{a_{t} }^{(B_{\tau})}l+Q\lambda\right)\frac{\bm{1}}{T}.\]

Thus, we can write an explicit update

\[\bm{g}_{\lambda,\tau} =\frac{1}{\mu_{k}}\left[\nabla_{\bm{a}}^{(B_{\tau})}l\right]_{ \bm{q}}+\frac{\lambda}{\eta}\bm{1}_{\bm{q}}-\left(1-b_{\tau}+\frac{\eta}{\mu_ {k}}\sum_{t\in\bm{q}}\partial_{a_{t}}^{(B_{\tau})}l+Q\lambda\right)\frac{\bm{1 }}{\eta T}+\frac{(1-b_{\tau})\bm{1}_{\bm{q}^{c}}}{\eta(T-Q)}\] \[=\left[\hat{\nabla}_{\bm{a}}^{(B_{\tau})}l\right]_{\bm{q}}+\frac{ \bm{1}_{\bm{q}}\bm{1}^{\top}\nabla_{\bm{a}}^{(B_{\tau})}l}{\mu_{k}T}-\left(1- b_{\tau}+\frac{\eta}{\mu_{k}}\sum_{t\in\bm{q}}\partial_{a_{t}}^{(B_{\tau})}l+Q \lambda\right)\frac{\bm{1}}{\eta T}\] \[\quad+\frac{(1-b_{\tau})\bm{1}_{\bm{q}^{c}}}{\eta(T-Q)}+\frac{ \lambda}{\eta}\bm{1}_{\bm{q}}\]

Then the gradient error at step \(\tau\) can be decomposed into:

\[\bm{g}_{\lambda,\tau}-\mathbb{E}\,\hat{\nabla}_{\bm{a}}l =\left[\hat{\nabla}_{\bm{a}}^{(B_{\tau})}l-\mathbb{E}\,\hat{ \nabla}_{\bm{a}}l\right]_{\bm{q}}\] (Concentration error) \[\quad+\frac{\bm{1}_{\bm{q}}\bm{1}^{\top}\nabla_{\bm{a}}^{(B_{ \tau})}l}{\mu_{k}T}-\left(1-b_{\tau}+\frac{\eta}{\mu_{k}}\sum_{t\in\bm{q}} \partial_{a_{t}}^{(B_{\tau})}l+Q\lambda\right)\frac{\bm{1}}{\eta T}+\frac{ \lambda}{\eta}\bm{1}_{\bm{q}}\] \[\quad+\frac{(1-b_{\tau})\bm{1}_{\bm{q}^{c}}}{\eta(T-Q)}-K_{\bm{V} }\frac{(1-b_{\tau})\bm{1}_{\bm{q}^{c}}}{T-Q}-(\left\|V\right\|_{\mu}^{2}- \left\langle\bm{V},\bm{P}\right\rangle_{\mu})\frac{\bm{1}_{\bm{q}^{c}}}{T} \quad\text{(Gradient bias error)}\]

Here the gradient bias error can be further simplified to

\[\left[\frac{1}{\mu_{k}T}\sum_{t\notin\bm{q}}\partial_{a_{t}}^{(B_ {\tau})}l-\frac{1-b_{\tau}+Q\lambda}{\eta T}+\frac{\lambda}{\eta}\right]\bm{1}_ {\bm{q}}\] (1*) \[+\left[\frac{Q(1-b_{\tau}-Q\lambda)-Q\lambda T-\eta TK_{V}}{\eta T (T-Q)}-\frac{\sum_{t\in\bm{q}}\partial_{a_{t}}^{(B_{\tau})}l}{\mu_{k}T}- \frac{\left\|\bm{V}\right\|_{\mu}^{2}-\left\langle\bm{V},\bm{P}\right\rangle_{ \mu}}{T}\right]\bm{1}_{\bm{q}^{c}}\] (2*)

First, we estimate the concentration error. Similar to Lemma B.10, we first upper bound the infinity norm of the gradient. Consider the maximum absolute value in the original gradients. For \(\nabla_{\bm{a}^{(k)}}l\), we have

\[\left\|\mathbbm{1}\{x_{\mathcal{T}+1}=k\}(\bm{V}\bm{X})^{\top}( \bm{V}\bm{X}\bm{a}^{(k)}-\bm{e}_{x_{\alpha}})\right\|_{\infty}\] \[\leq\left\|\mathbbm{1}\{x_{\mathcal{T}+1}=k\}(\bm{V}\bm{X})^{ \top}(\bm{V}\bm{X}\bm{a}^{(k)})\right\|_{\infty}+\left\|\mathbbm{1}\{x_{ \mathcal{T}+1}=k\}(\bm{V}\bm{X})^{\top}(\bm{e}_{x_{\alpha}})\right\|_{\infty}\] \[\leq\max_{s\in[T]}\left|\sum_{t=1}^{T}a_{t}(\bm{V}\bm{e}_{x_{ \alpha}})^{\top}\bm{V}\bm{e}_{x_{\alpha}}\right|+\max_{s\in[T]}\left|(\bm{V} \bm{e}_{x_{\alpha}})^{\top}\bm{e}_{x_{\alpha}}\right|\]

The first term can be upper-bounded in the following way:

\[\max_{s\in[T]}\left|\sum_{t=1}^{T}a_{t}(\bm{V}\bm{e}_{x_{\alpha} })^{\top}\bm{V}\bm{e}_{x_{t}}\right| \leq\left(\sum_{t\in\bm{q}}|a_{t}|+\sum_{t\notin\bm{q}}|a_{t}| \right)\max_{s,t}\left|(\bm{V}\bm{e}_{x_{\alpha}})^{\top}\bm{V}\bm{e}_{x_{ \alpha}}\right|\] \[\leq\Theta(1)\max_{s,t}\left|(\bm{V}\bm{e}_{x_{\alpha}})^{\top}\bm {V}\bm{e}_{x_{\alpha}}\right|\]

The second inequality is due to \(|a_{t}^{(k)}|\leq O(1/T)\) for \(t\notin\bm{q}\). Since \(\bm{V}_{n,m}\leq O(1)\), we have \(\max_{s,t}\left|(\bm{V}\bm{e}_{x_{\alpha}})^{\top}\bm{V}\bm{e}_{x_{t}}\right|\) upper bounded by \(O(1)\). Therefore

\[\max_{s\in[T]}\left|\sum_{t=1}^{T}a_{t}(\bm{V}\bm{e}_{x_{\alpha}})^{\top}\bm{V} \bm{e}_{x_{\alpha}}\right|\leq O(1)\]And similarly, the second term \(\max_{s\in[T]}\left|\left(\bm{V}\bm{e}_{\bm{x}_{s}}\right)^{\top}\bm{e}_{\bm{x}_{ s}}\right|\) can be bounded by \(O(1)\) because the infinity norm of \(\bm{V}\) is also upper bounded by \(O(1)\). Therefore, we know \(\|\nabla_{\bm{a}^{(k)}}l\|_{\infty}\leq O(1)\).

Now we consider the preconditioned gradient \(\tilde{\bm{\nabla}}_{\bm{a}}^{(B_{\tau})}l\):

\[\|\tilde{\bm{\nabla}}_{\bm{a}}^{(B_{\tau})}l\|_{\infty} =\left\|\frac{1}{\mu_{k}}\left(\bm{I}_{T}-\frac{\bm{1}_{T}\bm{1}_ {T}^{\top}}{T}\right)\left(\nabla_{\bm{a}^{(k)}}^{(B_{\tau})}l\right)\right\|_ {\infty}\] \[\leq\left\|\frac{1}{\mu_{k}}\bm{I}_{T}\left(\nabla_{\bm{a}^{(k)} }^{(B_{\tau})}l\right)\right\|_{\infty}+\left\|\frac{1}{\mu_{k}}\left(\frac{ \bm{1}_{T}\bm{1}_{T}^{\top}}{T}\right)\left(\nabla_{\bm{a}^{(k)}}^{(B_{\tau} )}l\right)\right\|_{\infty}\leq O\left(N\right)\]

since \(\mu_{k}\geq\frac{\varepsilon}{N}\) for all \(k\in[N]\). Now since \(\left[\tilde{\bm{\nabla}}_{\bm{a}}^{(B_{\tau})}l\right]_{\bm{q}}\) is \(Q\)-sparse, we have \(\mathbb{E}\left\|\left[\tilde{\bm{\nabla}}_{A}l\right]_{\bm{q}}\right\|_{\mu} ^{2}\leq O(QN^{2})\). By Lemma B.9, when \(B_{\tau}\geq\frac{\Theta(N^{\ell}Q^{3})}{\delta\varepsilon^{2}}\), with probability \(1-\frac{\delta_{\tau}}{2}\),

\[\left\|\left[\tilde{\bm{\nabla}}_{\bm{a}}^{(B_{\tau})}l-\mathbb{E}\,\tilde{ \bm{\nabla}}_{\bm{a}}l\right]_{\bm{q}}\right\|\leq O\left(\frac{\varepsilon} {QN^{2}}\right)\]

Then, consider the gradient bias term. With the selected \(\lambda=\Theta\left(\frac{\varepsilon K_{P}}{Q^{2}N^{3}}\right)\) and \(\left\|\partial_{a_{t}}^{(B_{\tau})}l\right\|\leq O\left(\frac{\varepsilon K_ {P}}{N^{3}Q^{2}}\right)\) for \(t\notin\bm{q}\), with probability \(1-\delta_{\tau}/2\) we have the \(\mu\)-norm of first term (since \(K_{P}\leq O(N)\)):

\[\|\left(1^{*}\right)\| \leq\left(\left\|\frac{1}{\mu_{k}T}\sum_{t\notin\bm{q}}\partial_{ a_{t}}^{(B_{\tau})}l\right\|+\frac{Q\lambda}{T}+\lambda\right)\cdot\sqrt{Q}\] \[\leq O\left(\frac{\varepsilon}{QN^{2}}\right)+O\left(\frac{ \varepsilon}{TN^{2}\sqrt{Q}}\right)+O\left(\frac{\varepsilon}{Q^{3/2}N^{2}} \right)\leq O\left(\frac{\varepsilon}{QN^{2}}\right).\]

and the second term can be upper-bounded by

\[\|\left(2^{*}\right)\|\leq\left(O\left(\frac{QN}{T}\right)+O\left(\frac{QN}{ T}\right)+O\left(\frac{N}{T}\right)\right)\cdot\sqrt{T}\leq O\left(\frac{ \varepsilon}{QN^{2}}\right).\]

since \(\frac{1}{\sqrt{T}}\leq O\left(\frac{\varepsilon}{Q^{2}N^{3}}\right)\), \(\partial_{a_{t}}^{(B_{\tau})}l=O(1)\), and \(\|\bm{V}\|_{\mu}^{2}\leq N\).

Combine all three terms and by union bound, we have with probability \(1-\delta_{\tau}\)

\[\left\|\hat{\bm{h}}_{A,\tau}\right\| =\left\|\bm{G}_{A,\tau}^{(k)}-\mathbb{E}\,\hat{\bm{\nabla}}_{A}l \right\|_{\mu}\] \[=\sqrt{\sum_{k=1}^{N}\mu_{k}\|\bm{g}_{A,\tau}^{(k)}-\mathbb{E}\, \hat{\bm{\nabla}}_{\bm{a}^{(k)}}l\|^{2}}\leq O\left(\frac{\varepsilon}{QN^{2}}\right)\]

since \(\mu_{k}=\Theta(1/N)\). 

### Model aligning and the decrease of the errors

First, we show that the signal will continue to grow and approximation error will decrease. This decouples the error at the end of Stage 1 and the final error. In particular, we show that eventually we will have \(\alpha_{V}+\alpha_{A}\approx 2\), \(\|\bm{A}_{A}\|_{\mu}^{2}\approx 0\) and \(\|\bm{\Lambda}_{V}\|_{\mu}^{2}\approx 0\)5.

Footnote 5: However, we cannot ensure \(\alpha_{A}\approx\alpha_{V}\) since \(\alpha_{A}-\alpha_{V}\) is not contractive toward the end of training due to the magnitude of gradient noise.This issue can be fixed by a final rounding stage (See Appendix F).

For notational simplicity, define \(\delta_{A}^{2}=\|\bm{\Lambda}_{A}\|_{\mu}^{2}/K_{Q}\) and \(\delta_{V}^{2}=\|\bm{\Lambda}_{V}\|_{\mu}^{2}/K_{P}\). Recall Lemma C.5 and Lemma C.6 and that we choose \(\eta_{V}=\eta/K_{Q}\), \(\eta_{A}=\eta/K_{P}\). The dynamics of the signals and the errors can be described using6

Footnote 6: Here \(\bm{h}_{A,\tau}\rightarrow\hat{\bm{h}}_{A,\tau}\) because each gradient step is changed to the \(\ell_{1}\)-regularized gradient. It does not change the main parts in the population process.

\[\alpha_{V,\tau+1}=\alpha_{V,\tau}+\eta\left(1-\alpha_{A}\alpha_{V}\right)\alpha_ {A}+\frac{\eta}{K_{Q}}\frac{1-\alpha_{V}}{T}-\eta\alpha_{V}\delta_{A}^{2}-\eta \frac{\left\langle\bm{h}_{V,\tau},\bm{P}\right\rangle_{\mu}}{K_{P}K_{Q}},\]\[\alpha_{A,\tau+1}=\alpha_{A,\tau}+\eta\left(1-\alpha_{V}\alpha_{A}\right)\alpha_{V}- \eta\alpha_{A}\delta_{V}^{2}-\eta\frac{\left\langle\hat{\bm{h}}_{A,\tau},\bm{Q} \right\rangle_{\mu}}{K_{P}K_{Q}},\]

and

\[\delta_{A,\tau+1}^{2}=\left(1-\eta\alpha_{V}^{2}-\eta\delta_{A}^{2} \right)^{2}\delta_{A}^{2}-2\eta\left(1-\eta\alpha_{V}^{2}-\eta\delta_{V}^{2} \right)\frac{\left\langle\mathbf{A}_{A},\hat{\bm{h}}_{A,\tau}\right\rangle_{ \mu}}{K_{P}K_{Q}}\] \[\qquad\qquad-\eta^{2}\frac{\left\langle\hat{\bm{h}}_{A,\tau},\bm{ Q}\right\rangle_{\mu}^{2}}{K_{P}^{2}K_{Q}^{2}}+\eta^{2}\frac{\left\|\hat{\bm{h}}_{A, \tau}\right\|_{\mu}^{2}}{K_{P}^{2}K_{Q}},\] \[\delta_{V,\tau+1}^{2}=\left(1-\eta\left(\alpha_{A}^{2}+\frac{1}{ K_{Q}T}+\delta_{A}^{2}\right)\right)^{2}\delta_{V}^{2}+2\eta\left(1-\eta \left(\alpha_{A}^{2}+\frac{1}{K_{Q}T}+\delta_{A}^{2}\right)\right)\frac{ \left\langle\mathbf{A}_{V},\bm{h}_{V}\right\rangle_{\mu}}{K_{P}K_{Q}}\] \[\qquad\qquad-\eta^{2}\frac{\left\langle\bm{P},\bm{h}_{V}\right\rangle _{\mu}^{2}}{K_{Q}^{2}K_{P}^{2}}+\eta^{2}\frac{\left\|\hat{\bm{h}}_{V}\right\|_ {\mu}^{2}}{K_{P}K_{Q}^{2}}.\]

#### e.2.1 Lemmas for the dynamics

Before we come to the final convergence analysis, we first simplify the dynamics with some basic lemmas.

**Lemma E.5** (Dynamics of the errors).: _For the errors, we have_

\[\delta_{A,\tau+1}^{2}\leq\exp\left(-2\eta\alpha_{V}^{2}\right) \delta_{A,\tau}^{2}+3\eta\left(\delta_{A}+\eta\frac{\left\|\hat{\bm{h}}_{A} \right\|_{\mu}}{K_{P}\sqrt{K_{Q}}}\right)\frac{\left\|\hat{\bm{h}}_{A}\right\| _{\mu}}{K_{P}\sqrt{K_{Q}}},\] \[\delta_{V,\tau+1}^{2}\leq\exp\left(-2\eta\alpha_{A}^{2}\right) \delta_{V,\tau}^{2}+3\eta\left(\delta_{V}+\eta\frac{\left\|\bm{h}_{V}\right\| _{\mu}}{\sqrt{K_{P}}K_{Q}}\right)\frac{\left\|\bm{h}_{V}\right\|_{\mu}}{\sqrt{ K_{P}}K_{Q}}.\]

Proof.: First, we write

\[\delta_{A,\tau+1}^{2}=\left(1-\eta\alpha_{V}^{2}-\eta\delta_{A}^{ 2}\right)^{2}\delta_{A}^{2}-2\eta\left(1-\eta\alpha_{V}^{2}-\eta\delta_{V}^{2} \right)\frac{\left\langle\mathbf{A}_{A},\hat{\bm{h}}_{A}\right\rangle_{\mu}}{ K_{P}K_{Q}}\] \[\qquad\qquad-\eta^{2}\frac{\left\langle\hat{\bm{h}}_{A,\tau},\bm {Q}\right\rangle_{\mu}^{2}}{K_{P}^{2}K_{Q}^{2}}+\eta^{2}\frac{\left\|\hat{\bm{h }}_{A}\right\|_{\mu}^{2}}{K_{P}^{2}K_{Q}}\] \[\qquad\qquad\leq\left(1-\eta\alpha_{V}^{2}-\eta\delta_{A}^{2} \right)^{2}\delta_{A}^{2}+2\eta\frac{\delta_{A}\left\|\hat{\bm{h}}_{A}\right\| _{\mu}}{K_{P}\sqrt{K_{Q}}}+3\eta^{2}\frac{\left\|\hat{\bm{h}}_{A,\tau}\right\| _{\mu}^{2}}{K_{P}^{2}K_{Q}}\] \[\qquad\qquad\leq\left(1-\eta\alpha_{V}^{2}-\eta\delta_{A}^{2} \right)^{2}\delta_{A}^{2}+3\eta\left(\delta_{A}+\frac{\eta}{K_{P}}\frac{\left\| \hat{\bm{h}}_{A}\right\|_{\mu}}{\sqrt{K_{Q}}}\right)\frac{\left\|\hat{\bm{h}}_{A }\right\|_{\mu}}{K_{P}\sqrt{K_{Q}}}.\]

For the first term, we have

\[\left(1-\eta\alpha_{V}^{2}-\eta\delta_{A}^{2}\right)^{2}\leq\exp\left(-\eta \alpha_{V}^{2}-\eta\delta_{A}^{2}\right)^{2}\leq\exp\left(-2\eta\alpha_{V}^{2} \right).\]

Thus, for \(\delta_{A}\), we have

\[\delta_{A,\tau+1}^{2}\leq\exp\left(-2\eta\alpha_{V}^{2}\right)\delta_{A,\tau}^ {2}+3\eta\left(\delta_{A}+\eta\frac{\left\|\hat{\bm{h}}_{A}\right\|_{\mu}}{K_{P} \sqrt{K_{Q}}}\right)\frac{\left\|\hat{\bm{h}}_{A}\right\|_{\mu}}{K_{P}\sqrt{K_ {Q}}}.\]Similarly, for \(\delta_{V}\), we have

\[\delta_{V,\,\tau+1}^{2} \leq\left(1-\eta\left(\alpha_{A}^{2}+\frac{1}{K_{Q}T}+\delta_{A}^{2 }\right)\right)^{2}\delta_{V}^{2}+3\eta\frac{\delta_{V}\left\|\boldsymbol{h}_{V }\right\|_{\mu}}{\sqrt{K_{P}}K_{Q}}+3\eta^{2}\frac{\left\|\boldsymbol{h}_{V} \right\|_{\mu}^{2}}{K_{P}K_{Q}^{2}}\] \[\leq\exp\left(-2\eta\alpha_{A}^{2}\right)\delta_{V}^{2}+3\eta \left(\delta_{V}+\eta\frac{\left\|\boldsymbol{h}_{V}\right\|_{\mu}}{\sqrt{K_{P }}K_{Q}}\right)\frac{\left\|\boldsymbol{h}_{V}\right\|_{\mu}}{\sqrt{K_{P}}K_{ Q}}\]

**Lemma E.6** (Dynamics of \(\alpha_{A}-\alpha_{V}\)).: _The difference between the signals evolves as follows_

\[\left(\alpha_{V,\,\tau+1}-\alpha_{A,\,\tau+1}\right)^{2} \leq\exp\left(-2\eta\left(1-\alpha_{A}\alpha_{V}\right)\right) \left(\alpha_{V}-\alpha_{A}\right)^{2}\] \[\quad+8\eta\left(\frac{1}{K_{Q}T}+\delta_{A}^{2}+\delta_{V}^{2}+ \frac{\left\|\boldsymbol{h}_{V,\,\tau}\right\|_{\mu}}{\sqrt{K_{P}}K_{Q}}+ \frac{\left\|\boldsymbol{\hat{h}}_{A,\,\tau}\right\|_{\mu}}{K_{P}\sqrt{K_{Q}} }\right).\]

Proof.: First, we write

\[\alpha_{V,\,\tau+1}-\alpha_{A,\,\tau+1} =\alpha_{V,\,\tau}-\alpha_{A,\,\tau}-\eta\left(1-\alpha_{A} \alpha_{V}\right)\left(\alpha_{V}-\alpha_{A}\right)\] \[\quad+\frac{\eta}{K_{Q}}\frac{1-\alpha_{V}}{T}-\eta\alpha_{V} \delta_{A}^{2}-\eta\frac{\left\langle\boldsymbol{h}_{V,\,\tau},\boldsymbol{P} \right\rangle_{\mu}}{K_{P}K_{Q}}+\eta\alpha_{A}\delta_{V}^{2}+\eta\frac{\left \langle\boldsymbol{\hat{h}}_{A,\,\tau},\boldsymbol{Q}\right\rangle_{\mu}}{K_{ P}K_{Q}}\] \[=:\left(1-\eta\left(1-\alpha_{A}\alpha_{V}\right)\right)\left( \alpha_{V}-\alpha_{A}\right)+\mathtt{Tmp}.\]

Therefore, we have

\[\left(\alpha_{V,\,\tau+1}-\alpha_{A,\,\tau+1}\right)^{2} =\left(\left(1-\eta\left(1-\alpha_{A}\alpha_{V}\right)\right) \left(\alpha_{V}-\alpha_{A}\right)+\mathtt{Tmp}\right)^{2}\] \[=\left(1-\eta\left(1-\alpha_{A}\alpha_{V}\right)\right)^{2}\left( \alpha_{V}-\alpha_{A}\right)^{2}\] \[\quad+2\left(1-\eta\left(1-\alpha_{A}\alpha_{V}\right)\right) \left(\alpha_{V}-\alpha_{A}\right)\mathtt{Tmp}+\mathtt{Tmp}^{2}\] \[\leq\exp\left(-2\eta\left(1-\alpha_{A}\alpha_{V}\right)\right) \left(\alpha_{V}-\alpha_{A}\right)^{2}\] \[\quad+3|\alpha_{V}-\alpha_{A}||\mathtt{Tmp}|+\mathtt{Tmp}^{2}.\]

Then, for \(\mathtt{Tmp}\), we compute

\[0.5\eta^{-1}|\mathtt{Tmp}| \leq\frac{1}{K_{Q}T}+\delta_{A}^{2}+\delta_{V}^{2}+\frac{\left\| \boldsymbol{h}_{V,\,\tau}\right\|_{\mu}}{\sqrt{K_{P}}K_{Q}}+\frac{\left\| \boldsymbol{\hat{h}}_{A,\,\tau}\right\|_{\mu}}{K_{P}\sqrt{K_{Q}}}.\]

In particular, this implies \(|\mathtt{Tmp}|\leq 1\). Thus, we have

\[\left(\alpha_{V,\,\tau+1}-\alpha_{A,\,\tau+1}\right)^{2} \leq\exp\left(-2\eta\left(1-\alpha_{A}\alpha_{V}\right)\right) \left(\alpha_{V}-\alpha_{A}\right)^{2}+4|\mathtt{Tmp}|\] \[\leq\exp\left(-2\eta\left(1-\alpha_{A}\alpha_{V}\right)\right) \left(\alpha_{V}-\alpha_{A}\right)^{2}\] \[\quad+8\eta\left(\frac{1}{K_{Q}T}+\delta_{A}^{2}+\delta_{V}^{2}+ \frac{\left\|\boldsymbol{h}_{V,\,\tau}\right\|_{\mu}}{\sqrt{K_{P}}K_{Q}}+\frac{ \left\|\boldsymbol{\hat{h}}_{A,\,\tau}\right\|_{\mu}}{K_{P}\sqrt{K_{Q}}}\right).\]

**Lemma E.7**.: _Suppose that both \(\alpha_{V},\alpha_{A}\) are at most \(1\). Then, we have_

\[1-\frac{\alpha_{V,\,\tau+1}+\alpha_{A,\,\tau+1}}{2} \leq\left(1-\eta\frac{\alpha_{V}+\alpha_{A}}{2}\right)\left(1- \frac{\alpha_{V}+\alpha_{A}}{2}\right)+\eta\frac{\alpha_{V}+\alpha_{A}}{2} \left(\delta_{A}^{2}+\delta_{V}^{2}\right)\] \[\quad+\frac{\eta}{2}\frac{\left\|\boldsymbol{h}_{V,\,\tau}\right\| _{\mu}}{\sqrt{K_{P}}K_{Q}}+\frac{\eta}{2}\frac{\left\|\boldsymbol{\hat{h}}_{A,\, \tau}\right\|_{\mu}}{K_{P}\sqrt{K_{Q}}}.\]Proof.: First, we write

\[\alpha_{V,\tau+1}+\alpha_{A,\tau+1} =\alpha_{V,\tau}+\alpha_{A,\tau}+\eta\left(1-\alpha_{A}\alpha_{V} \right)\left(\alpha_{V}+\alpha_{A}\right)\] \[\qquad+\frac{\eta}{K_{Q}}\frac{1-\alpha_{V}}{T}-\eta\alpha_{V} \delta_{A}^{2}-\eta\alpha_{A}\delta_{V}^{2}-\eta\frac{\left\langle\hat{\bm{h}}_ {A,\tau},\bm{P}\right\rangle_{\mu}}{K_{P}K_{Q}}-\eta\frac{\left\langle\hat{\bm{ h}}_{A,\tau},\bm{Q}\right\rangle_{\mu}}{K_{P}K_{Q}}\] \[=:\alpha_{V,\tau}+\alpha_{A,\tau}+\eta\mathbb{Tm}_{\text{sig}}+ \eta\mathbb{Tm}_{\text{err}}.\]

For the signal growth, note that \(\alpha_{A}\alpha_{V}\leq(\alpha_{V}^{2}+\alpha_{A}^{2})/2\leq(\alpha_{V}+ \alpha_{A})/2\). Hence,

\[\left(1-\alpha_{A}\alpha_{V}\right)\left(\alpha_{V}+\alpha_{A}\right)\geq \frac{1}{2}\left(\alpha_{V}+\alpha_{A}\right)\left(2-\alpha_{V}-\alpha_{A} \right).\]

For the error terms, we have

\[\left|\frac{\left\langle\hat{\bm{h}}_{V,\tau},\bm{P}\right\rangle_{\mu}}{K_{P }K_{Q}}+\frac{\left\langle\hat{\bm{h}}_{A,\tau},\bm{Q}\right\rangle_{\mu}}{K_{ P}K_{Q}}\right|\leq\frac{\left\|\hat{\bm{h}}_{V,\tau}\right\|_{\mu}}{\sqrt{K_{P}}K_{Q} }+\frac{\left\|\hat{\bm{h}}_{A,\tau}\right\|_{\mu}}{K_{P}\sqrt{K_{Q}}}.\]

Thus, we have

\[\alpha_{V,\tau+1}+\alpha_{A,\tau+1} \geq\alpha_{V,\tau}+\alpha_{A,\tau}+\eta\left(\alpha_{V}+\alpha_{A }\right)\left(1-\frac{\alpha_{V}+\alpha_{A}}{2}-\delta_{A}^{2}-\delta_{V}^{2}\right)\] \[\qquad-\eta\frac{\left\|\hat{\bm{h}}_{V,\tau}\right\|_{\mu}}{ \sqrt{K_{P}}K_{Q}}-\eta\frac{\left\|\hat{\bm{h}}_{A,\tau}\right\|_{\mu}}{K_{P} \sqrt{K_{Q}}},\]

and, therefore,

\[1-\frac{\alpha_{V,\tau+1}+\alpha_{A,\tau+1}}{2} \leq\left(1-\eta\frac{\alpha_{V}+\alpha_{A}}{2}\right)\left(1- \frac{\alpha_{V}+\alpha_{A}}{2}\right)+\eta\frac{\alpha_{V}+\alpha_{A}}{2} \left(\delta_{A}^{2}+\delta_{V}^{2}\right)\] \[\qquad+\frac{\eta}{2}\frac{\left\|\hat{\bm{h}}_{A,\tau}\right\|_{ \mu}}{\sqrt{K_{P}}K_{Q}}+\frac{\eta}{2}\frac{\left\|\hat{\bm{h}}_{A,\tau} \right\|_{\mu}}{K_{P}\sqrt{K_{Q}}}.\]

**Lemma E.8**.: _Put \(\varepsilon_{A}=1-\alpha_{A}\) and \(\varepsilon_{V}=1-\alpha_{V}\). When \(|\varepsilon_{A}|,|\varepsilon_{V}|\leq 1/2\), we have_

\[\left(\varepsilon_{A,\tau+1}+\varepsilon_{V,\tau+1}\right)^{2} \leq\exp\left(-2\eta\right)\left(\varepsilon_{A}+\varepsilon_{V} \right)^{2}+8\eta|\varepsilon_{A}+\varepsilon_{V}|\varepsilon_{A}\varepsilon_ {V}+16\eta^{2}\varepsilon_{A}^{2}\varepsilon_{V}^{2}\] \[\qquad+8\eta|\varepsilon_{A}+\varepsilon_{V}|\left(\frac{1}{K_{Q} T}+\delta_{A}^{2}+\delta_{V}^{2}+\frac{\left\|\hat{\bm{h}}_{V,\tau}\right\|_{ \mu}}{\sqrt{K_{P}}K_{Q}}+\frac{\left\|\hat{\bm{h}}_{A,\tau}\right\|_{\mu}}{K_{ P}\sqrt{K_{Q}}}\right).\]

Proof.: Similar to the proof of the previous lemma, we write

\[\alpha_{V,\tau+1}+\alpha_{A,\tau+1} =\alpha_{V,\tau}+\alpha_{A,\tau}+\eta\left(1-\alpha_{A}\alpha_{V} \right)\left(\alpha_{V}+\alpha_{A}\right)\] \[\qquad+\frac{\eta}{K_{Q}}\frac{1-\alpha_{V}}{T}-\eta\alpha_{V} \delta_{A}^{2}-\eta\alpha_{A}\delta_{V}^{2}-\eta\frac{\left\langle\hat{\bm{h}}_ {V,\tau},\bm{P}\right\rangle_{\mu}}{K_{P}K_{Q}}-\eta\frac{\left\langle\hat{\bm {h}}_{A,\tau},\bm{Q}\right\rangle_{\mu}}{K_{P}K_{Q}}\] \[=:\alpha_{V,\tau}+\alpha_{A,\tau}+\eta\mathbb{Tm}_{\text{sig}}+ \eta\mathbb{Tm}_{\text{err}}.\]

For the signal term, we have

\[\mathbb{Tm}_{\text{sig}} =\left(1-(1-\varepsilon_{A})(1-\varepsilon_{V})\right)\left(2- \varepsilon_{A}-\varepsilon_{V}\right)\] \[=\left(2-\varepsilon_{A}-\varepsilon_{V}\right)\left(\varepsilon_{ A}+\varepsilon_{V}\right)-\varepsilon_{A}\varepsilon_{V}\left(2-\varepsilon_{A}- \varepsilon_{V}\right).\]

For the error term, we have

\[\left|\mathbb{Tm}_{\text{err}}\right|\leq\frac{1}{K_{Q}T}+2\delta_{A}^{2}+2 \delta_{V}^{2}+\frac{2\left\|\hat{\bm{h}}_{V,\tau}\right\|_{\mu}}{\sqrt{K_{P}}K_ {Q}}+\frac{2\left\|\hat{\bm{h}}_{A,\tau}\right\|_{\mu}}{K_{P}\sqrt{K_{Q}}}.\]Combine these together, and we obtain

\[\varepsilon_{A,\tau+1}+\varepsilon_{V,\tau+1} =\varepsilon_{A,\tau}+\varepsilon_{V,\tau}-\eta\left(2-\varepsilon_ {A}-\varepsilon_{V}\right)\left(\varepsilon_{A}+\varepsilon_{V}\right)\] \[\qquad+\eta\varepsilon_{A}\varepsilon_{V}\left(2-\varepsilon_{A} -\varepsilon_{V}\right)\pm 2\eta\left(\frac{1}{K_{Q}T}+\delta_{A}^{2}+\delta_{V}^{2}+ \frac{\left\|\boldsymbol{h}_{V,\tau}\right\|_{\mu}}{\sqrt{K_{P}}K_{Q}}+\frac{ \left\|\boldsymbol{\hat{h}}_{A,\tau}\right\|_{\mu}}{K_{P}\sqrt{K_{Q}}}\right)\] \[=:\left(1-\eta\left(2-\varepsilon_{A}-\varepsilon_{V}\right) \right)\left(\varepsilon_{A}+\varepsilon_{V}\right)+\texttt{Tmp}.\]

Thus,

\[(\varepsilon_{A,\tau+1}+\varepsilon_{V,\tau+1})^{2} =\left(\left(1-\eta\left(2-\varepsilon_{A}-\varepsilon_{V} \right)\right)\left(\varepsilon_{A}+\varepsilon_{V}\right)+\texttt{Tmp} \right)^{2}\] \[\leq\exp\left(-2\eta\left(2-\varepsilon_{A}-\varepsilon_{V} \right)\right)\left(\varepsilon_{A}+\varepsilon_{V}\right)^{2}+2|\varepsilon _{A}+\varepsilon_{V}||\texttt{Tmp}|+\texttt{Tmp}^{2}.\]

Note that

\[|\texttt{Tmp}| \leq 4\eta\left(\varepsilon_{A}\varepsilon_{V}+\frac{1}{K_{Q}T}+ \delta_{A}^{2}+\delta_{V}^{2}+\frac{\left\|\boldsymbol{h}_{V,\tau}\right\|_{ \mu}}{\sqrt{K_{P}}K_{Q}}+\frac{\left\|\boldsymbol{\hat{h}}_{A,\tau}\right\|_{ \mu}}{K_{P}\sqrt{K_{Q}}}\right).\]

Recall \(|\varepsilon_{A}|,|\varepsilon_{V}|\leq 1/2\). Thus,

\[(\varepsilon_{A,\tau+1}+\varepsilon_{V,\tau+1})^{2} \leq\exp\left(-2\eta\right)\left(\varepsilon_{A}+\varepsilon_{V} \right)^{2}\] \[\qquad+8\eta|\varepsilon_{A}+\varepsilon_{V}|\left(\varepsilon_ {A}\varepsilon_{V}+\frac{1}{K_{Q}T}+\delta_{A}^{2}+\delta_{V}^{2}+\frac{ \left\|\boldsymbol{h}_{V,\tau}\right\|_{\mu}}{\sqrt{K_{P}}K_{Q}}+\frac{ \left\|\boldsymbol{h}_{A,\tau}\right\|_{\mu}}{K_{P}\sqrt{K_{Q}}}\right)\] \[\leq\exp\left(-2\eta\right)\left(\varepsilon_{A}+\varepsilon_{V} \right)^{2}+8\eta|\varepsilon_{A}+\varepsilon_{V}|\varepsilon_{A}\varepsilon_ {V}+16\eta^{2}\varepsilon_{A}^{2}\varepsilon_{V}^{2}\] \[\qquad+8\eta|\varepsilon_{A}+\varepsilon_{V}|\left(\frac{1}{K_{Q }T}+\delta_{A}^{2}+\delta_{V}^{2}+\frac{\left\|\boldsymbol{h}_{V,\tau}\right\|_ {\mu}}{\sqrt{K_{P}}K_{Q}}+\frac{\left\|\boldsymbol{h}_{A,\tau}\right\|_{\mu}}{ K_{P}\sqrt{K_{Q}}}\right).\]

**Lemma E.9**.: _Suppose that \((X_{\tau})_{\tau}\) satisfies \(X_{\tau+1}\leq e^{-A}X_{\tau}+B\) for some \(A\in(0,1]\), \(B\geq 0\). If \(X_{0}\leq 2B/A\), then we have \(X_{\tau}\leq 3B/A\) for all \(\tau\geq 0\). If \(X_{0}\geq 2B/A\), then we have \(X_{\tau}\leq 3B/A\) for all \(\tau\geq\frac{6}{A}\log\left(\frac{X_{0}A}{3B}\right)\)._

Proof.: Since \(e^{-A}\leq 1-A/2\) for \(A\in(0,1]\), we have \(X_{\tau+1}\leq X_{\tau}-AX_{\tau}/2+B\). Hence, whenever \(X_{\tau}\geq 2B/A\), we will have \(X_{\tau+1}\leq X_{\tau}\). Moreover, if \(X_{\tau}<2B/A\), we have \(X_{\tau+1}\leq 2B/A+B\leq 3B/A\). This proves the first part of the lemma.

Now, suppose that \(X_{0}\geq 2B/A\). When \(X_{\tau}\geq 3B/A\), we have

\[X_{\tau+1}\leq X_{\tau}-AX_{\tau}/2+B\leq X_{\tau}-AX_{\tau}/6\leq e^{-A/6}X_{ \tau}.\]

Thus, it takes at most \(\frac{6}{A}\log\left(\frac{X_{0}A}{3B}\right)\) steps to reduce \(X_{\tau}\) from \(X_{0}\) to \(3B/A\). After that, the previous analysis applies. 

#### e.2.2 Main lemma of Stage 2

We split the analysis of Stage 2 into two substage. Let \(c_{\alpha}\in(0,0.05)\) be a small constant. Define

\[\mathcal{T}_{2.1}:=\inf\left\{\tau\geq\mathcal{T}_{1}\,:\,(\alpha_{V,\tau}+ \alpha_{A,\tau})/2\geq 1-c_{\alpha}\right\}.\]

We call \(\{\tau\,:\,\tau\leq\mathcal{T}_{2.1}\}\) stage 2.1 and \(\{\tau\,:\,\tau\geq\mathcal{T}_{2.1}\}\) stage 2.2. For notational simplicity, we define

\[\text{Err}_{\text{small}}=\max_{\tau}\left\{\frac{1}{K_{Q}T}+\frac{\left\| \boldsymbol{h}_{V,\tau}\right\|_{\mu}}{\sqrt{K_{P}}K_{Q}}+\frac{\left\| \boldsymbol{\hat{h}}_{A,\tau}\right\|_{\mu}}{K_{P}\sqrt{K_{Q}}}\right\}.\]

Note that this can be made essentially arbitrarily small by choosing a large enough batch size.

**Lemma E.10**.: _Suppose that the following hold at the beginning of Stage 2 (after thresholding and projection):_

* \(\alpha_{V},\alpha_{A}\geq\alpha^{(2)}\)__
* \(\delta_{A}^{2}+\delta_{V}^{2}\leq(\delta^{(2)})^{2}\)_._

_Let \(\delta_{*}\) be our target value for \(\delta_{A}\) and \(\delta_{V}\). Choose \(\lambda\) as in Lemma E.4. Suppose that_

\[\max\left\{\delta^{(2)},\operatorname{Err_{small}}\right\} \operatorname{Err_{small}}\leq\delta_{*}^{2},\quad\operatorname{Err_{small} }\leq O(\alpha^{(2)}),\] \[\max\left\{(\alpha_{V,\mathcal{T}_{1}}-\alpha_{A,\mathcal{T}_{1 }})^{2},\delta^{(2)},\operatorname{Err_{small}}\right\}\leq O\left(\frac{1}{ \log(1/\delta_{*})}\right).\]

_Then, within \(O(1/(\eta\alpha^{(2)})+\log(1/\delta_{*})/\eta)\) steps, we will have \(\delta_{A}^{2},\delta_{V}^{2}\leq\delta_{*}^{2}\) and \(\alpha_{V},\alpha_{A}\in(0.9,1.1)\)._

**Remark**.: Note that our conditions on \(\alpha_{V},\alpha_{A}\) and \(\delta^{(2)}\) are much weaker that what one can obtain from Stage 1. This allows us to apply the analysis here to transfer learning. \(\blacktriangle\)

The following proof should be treated as a large induction argument though we do not explicitly write down the induction as in the proof of Stage 1. In particular, we will show (by induction) that the approximation errors \(\delta_{A}\) and \(\delta_{V}\) are small, so that most of the naive bounds on the entries of \(\tilde{A}\) and \(\tilde{V}\) can be transferred to \(A\) and \(V\). In particular, \(|V_{n,m}|=O(1)\) for all \(n,m\in[N]\) so that our bounds in Section E.1 are valid, and \(|a_{t}^{(k)}|=O(1)\) for all \(k\in[N]\), \(t\in[N]\), which implies that after the projection step, \(a_{t}^{(k)}=O(1/T)\) for all \(t\notin\boldsymbol{q}^{(k)}\).

Proof of the Lemma E.10

Common results for Stage 2.1 and 2.2First, we prove some basic results that hold for both Stage 2.1 and 2.2. First, we show (by induction) that \(\alpha_{V},\alpha_{A}\geq\alpha^{(2)}\) and \(\delta_{V}^{2}+\delta_{A}^{2}\leq\delta^{(2)}\) hold throughout Stage 2. Recall from Lemma E.5 that

\[\delta_{A,\tau+1}^{2} \leq\exp\left(-2\eta\alpha_{V}^{2}\right)\delta_{A,\tau}^{2}+3 \eta\left(\delta_{A}+\eta\frac{\left\|\hat{\boldsymbol{h}}_{A}\right\|_{ \mu}}{K_{P}\sqrt{K_{Q}}}\right)\frac{\left\|\hat{\boldsymbol{h}}_{A}\right\|_{ \mu}}{K_{P}\sqrt{K_{Q}}}\] \[\leq\exp\left(-2\eta(\alpha^{(2)})^{2}\right)\delta_{A,\tau}^{2} +\eta\operatorname{Err_{small}}.\]

Hence, as long as \(\operatorname{Err_{small}}\leq O(1)\delta^{(2)}/(\alpha^{(2)})^{2}\), we can ensure \(\delta_{A,\tau+1}^{2}+\delta_{V,\tau+1}^{2}\leq(\delta^{(2)})^{2}\) always hold.

Stage 2.1: signal growthBy Lemma E.7, we have

\[1-\frac{\alpha_{V,\tau+1}+\alpha_{A,\tau+1}}{2}\leq\left(1-\eta\frac{\alpha_ {V}+\alpha_{A}}{2}\right)\left(1-\frac{\alpha_{V}+\alpha_{A}}{2}\right)+\eta \frac{\alpha_{V}+\alpha_{A}}{2}\left(\delta_{A}^{2}+\delta_{V}^{2}\right)+ \eta\operatorname{Err_{small}}.\]

When \((\alpha_{V}+\alpha_{A})/2\leq 1-c_{\alpha}\) and \(\alpha_{V},\alpha_{A}\geq\alpha^{(2)}\), we have

\[\eta\frac{\alpha_{V}+\alpha_{A}}{2}\left(1-\frac{\alpha_{V}+\alpha_{A}}{2} \right)\geq\eta\frac{\alpha_{V}+\alpha_{A}}{2}c_{\alpha}\geq\eta\alpha^{(2)} c_{\alpha}.\]

Hence, as long as \(\operatorname{Err_{small}}\leq\alpha^{(2)}c_{\alpha}/2\) and \(\delta^{(2)}\leq c_{\alpha}/2\), we have

\[1-\frac{\alpha_{V,\tau+1}+\alpha_{A,\tau+1}}{2}\leq\left(1-\frac{\eta}{2} \frac{\alpha_{V}+\alpha_{A}}{2}\right)\left(1-\frac{\alpha_{V}+\alpha_{A}}{2} \right)\leq\exp\left(-\frac{\eta\alpha^{(2)}}{2}\right)\left(1-\frac{\alpha_{V }+\alpha_{A}}{2}\right).\]

Thus, stage 2.1 takes at most \(O(1/(\eta\alpha^{(2)}))\) steps.

Stage 2.1: difference between the \(\alpha^{*}\)'sBy Lemma E.6, we have

\[(\alpha_{V,\tau+1}-\alpha_{A,\tau+1})^{2}\leq\exp\left(-2\eta\left(1-\alpha_{A} \alpha_{V}\right)\right)\left(\alpha_{V}-\alpha_{A}\right)^{2}+8\eta\left(( \delta^{(2)})^{2}+\mathrm{Err}_{\mathrm{small}}\right).\]

By the AM-GM inequality, we have \(\alpha_{A}\alpha_{V}\leq((\alpha_{A}+\alpha_{V})/2)^{2}\leq(1-c_{\alpha})^{2}\). Therefore, \(1-\alpha_{A}\alpha_{V}\geq c_{\alpha}\) and the above inequality can be further rewritten as

\[(\alpha_{V,\tau+1}-\alpha_{A,\tau+1})^{2}\leq\exp\left(-2c_{\alpha}\eta\right) \left(\alpha_{V}-\alpha_{A}\right)^{2}+8\eta\left((\delta^{(2)})^{2}+\mathrm{ Err}_{\mathrm{small}}\right).\]

Thus, by (the proof of) Lemma E.9, we have

\[(\alpha_{V,\tau}-\alpha_{A,\tau})^{2}\leq\max\left\{2(\alpha_{V,\mathcal{T}_{ 1}}-\alpha_{A,\mathcal{T}_{2}})^{2},\frac{4\left((\delta^{(2)})^{2}+\mathrm{ Err}_{\mathrm{small}}\right)}{c_{\alpha}}\right\}.\]

Stage 2.2: error decreaseBy Lemma E.5, we have

\[\delta_{A,\tau+1}^{2} \leq\exp\left(-2\eta\alpha_{V}^{2}\right)\delta_{A,\tau}^{2}+3 \eta\max\left\{\delta^{(2)},\mathrm{Err}_{\mathrm{small}}\right\}\mathrm{ Err}_{\mathrm{small}}\] \[\leq\exp\left(-\eta\right)\delta_{A,\tau}^{2}+3\eta\max\left\{ \delta^{(2)},\mathrm{Err}_{\mathrm{small}}\right\}\mathrm{Err}_{\mathrm{small }}.\]

Thus, by Lemma E.9, we have

\[\delta_{A,\tau}^{2}\leq O\left(1\right)\max\left\{\delta^{(2)},\mathrm{Err}_{ \mathrm{small}}\right\}\mathrm{Err}_{\mathrm{small}}\leq\delta_{*}^{2},\qquad \forall\tau\geq O\left(\frac{\log\left(1/\delta_{*}\right)}{\eta}\right).\]

In other words, Stage 2.2 takes at most \(O\left(\frac{\log\left(1/\delta_{*}\right)}{\eta}\right)\) steps.

Stage 2.2: stability of \(\alpha_{V}\pm\alpha_{A}\)Recall from Lemma E.8 and Lemma E.6 that

\[(\varepsilon_{A,\tau+1}+\varepsilon_{V,\tau+1})^{2} \leq\exp\left(-2\eta\right)\left(\varepsilon_{A}+\varepsilon_{V} \right)^{2}+8\eta|\varepsilon_{A}+\varepsilon_{V}|\varepsilon_{A}\varepsilon_ {V}+16\eta^{2}\varepsilon_{A}^{2}\varepsilon_{V}^{2}\] \[\quad\quad\quad+8\eta|\varepsilon_{A}+\varepsilon_{V}|\left( \delta^{(2)}+\mathrm{Err}_{\mathrm{small}}\right),\] \[(\alpha_{V,\tau+1}-\alpha_{A,\tau+1})^{2} \leq\exp\left(-2\eta\left(1-\alpha_{A}\alpha_{V}\right)\right) \left(\alpha_{V}-\alpha_{A}\right)^{2}+8\eta\left(\delta^{(2)}+\mathrm{Err}_ {\mathrm{small}}\right).\]

We wish to maintain the induction hypotheses \(|\alpha_{V}-\alpha_{A}|=|\varepsilon_{V}-\varepsilon_{A}|=\theta_{-}\) for some \(\theta_{-}=o\left(1\right)\) and \((\alpha_{A}+\alpha_{V})/2\leq 1+c/\log(1/\delta_{*})=:1+\theta_{+}\).

First, assume these conditions are true. Then, we have

\[(\alpha_{V,\tau+1}-\alpha_{A,\tau+1})^{2} \leq\exp\left(O(1)\eta/\log(1/\delta_{*})\right)\left(\alpha_{V} -\alpha_{A}\right)^{2}+8\eta\left(\delta^{(2)}+\mathrm{Err}_{\mathrm{small}} \right).\]

Since Stage 2.2 takes at most \(O\left(\log(1/\delta_{*})/\eta\right)\) steps, when the constant \(c\) is small, we have

\[(\alpha_{V,\tau}-\alpha_{A,\tau})^{2} \leq 2\left((\alpha_{V,\mathcal{T}_{2,1}}-\alpha_{A,\mathcal{T}_{2,1} })^{2},+8\left(\delta^{(2)}+\mathrm{Err}_{\mathrm{small}}\right)\right)\] \[\leq O\left(1\right)\max\left\{(\alpha_{V,\mathcal{T}_{2,1}}- \alpha_{A,\mathcal{T}_{2,1}})^{2},\delta^{(2)},\mathrm{Err}_{\mathrm{small}} \right\}=:\theta_{-}.\]

We can choose the parameters appropriately so that \(\theta_{-}<o(\theta_{+})\). Then, when \(\varepsilon_{A}+\varepsilon_{V}\in(-2\theta_{+},-\theta_{+})\), we have, for some large universal constant \(C>0\),

\[(\varepsilon_{A,\tau+1}+\varepsilon_{V,\tau+1})^{2} \leq\exp\left(-2\eta\right)\theta_{+}^{2}+C\eta\theta_{+}^{3}+C \eta^{2}\theta_{+}^{4}+C\eta\theta_{+}\left(\delta^{(2)}+\mathrm{Err}_{ \mathrm{small}}\right)\] \[\leq\exp\left(-2\eta\right)\theta_{+}^{2}+C\eta\theta_{+}^{3}+C \eta\theta_{+}\theta_{-}\] \[\leq\theta_{+}^{2}.\]

This establishes the induction hypotheses on \(\alpha_{V}\pm\alpha_{A}\).

Stage 3: Final Convergence

As mentioned last section, we cannot ensure \(\alpha_{A}\approx\alpha_{V}\) since \(\alpha_{A}-\alpha_{V}\) is not contractive toward the end of training. However, we can add a final rounding step and then continue train the model to recover the ground-truth with \(\varepsilon\)-error.

First, we formally define our rounding procedure. Let \(c>0\) be a small constant (cf. the proof of Lemma F.1). For each \(k\in[N]\), define

\[\hat{\bm{a}}^{(k)}:=\left[a_{t}^{(k)}\mathbbm{1}\left\{a_{t}^{(k)}\geq c/Q \right\}\right]_{t\in[T]}\quad\text{and}\quad\bm{a}^{(*,k)}:=\frac{\hat{\bm{a }}^{(k)}}{\mathbf{1}^{\top}\hat{\bm{a}}^{(k)}}\,.\]

This \(\bm{A}^{*}:=[\bm{a}^{(*,k)}]_{k\in[N]}\) is our rounded version of \(\bm{A}\). For the error between \(\bm{A}^{*}\) and \(\bm{Q}\), we have the following lemma.

**Lemma F.1** (Rounding _A_).: _Let \(\varepsilon\in\left(\Theta(Q^{2}/T^{2}),0.1\right)\) be our target accuracy. Suppose that \(\alpha_{A}=1-\varepsilon_{A}\) for some \(|\varepsilon_{A}|\leq 0.1\) and \(\left\|\Delta_{A}\right\|_{\mu}^{2}\leq\delta_{A}^{2}\) for some \(0<\delta_{A}\ll 1/(Q\sqrt{N})\). Then, after rounding, we have_

\[\left\|\bm{A}_{*}-\bm{Q}\right\|_{\mu}^{2}\leq O\left(\frac{Q^{2}}{T^{2}}+ \delta_{A}^{2}NQ\right)\,.\]

_In particular, to achieve \(\varepsilon\) accuracy in terms of \(\left\|\cdot\right\|_{\mu}\), we only need \(|\varepsilon_{A}|\leq 0.1\) and \(\delta_{A}^{2}\leq O\left(\varepsilon/\sqrt{NQ}\right)\)._

**Remark**. In particular, this lemma implies that as long as \(\varepsilon_{A}\) is not too large, after rounding, the error depends solely on \(\left\|\Delta_{A}\right\|_{\mu}^{2}\). 

Proof.: For notational simplicity, we omit the superscript \(k\) for now. Write

\[\bm{a}=\tilde{\bm{a}}+\bm{\Delta}_{\bm{a}}=\alpha_{V}\bm{q}+(1-\alpha_{V}) \frac{\mathbf{1}}{T}+\bm{\Delta}_{\bm{a}}=(1-\varepsilon_{A})\bm{q}+ \varepsilon_{A}\frac{\mathbf{1}}{T}+\bm{\Delta}_{\bm{a}}.\]

Note that \(\left\|\bm{\Delta}_{\bm{a}}\right\|_{\infty}\leq\left\|\bm{\Delta}_{\bm{a}} \right\|_{2}\leq O(1)\sqrt{N}\left\|\bm{\Delta}_{\bm{A}}\right\|_{\mu}\leq O( \sqrt{N}\delta_{A})\). Since all nonzero \(q_{s}\) are lower bounded by \(\Omega(1/Q)\), we have, for any \(s\in\bm{q}\) and \(t\notin\bm{q}\),

\[a_{s} \geq\frac{\Omega(1)}{Q}-\frac{|\varepsilon_{A}|}{T}-O\left(\sqrt{N} \delta_{A}\right)=\frac{\Omega(1)}{Q},\] \[|a_{t}| \leq\frac{|\varepsilon_{A}|}{T}+O\left(\sqrt{N}\delta_{A}\right) \ll\frac{1}{Q}.\]

Hence, we can choose a small constant \(c>0\), so that

\[\hat{\bm{a}}:=\left[a_{t}\mathbbm{1}\{|a_{t}|\geq c/Q\}\right]_{t\in[T]}=(1- \varepsilon_{A})\bm{q}+\varepsilon_{A}\frac{\mathbf{1}_{\bm{q}}}{T}+[\bm{ \Delta}_{\bm{a}}]_{\bm{q}},\]

where for \(\bm{v}\in\mathbb{R}^{T}\), \(\bm{v}_{\bm{q}}\in\mathbb{R}^{T}\) is defined as \([v_{t}\mathbbm{1}\{t\in\bm{q}\}]_{t\in[T]}\) here. Now, consider the difference between \(\bm{q}\) and \(\hat{\bm{a}}/\mathbf{1}^{\top}\hat{\bm{a}}\). We have

\[\mathbf{1}^{\top}\hat{\bm{a}}=1-\varepsilon_{A}+\frac{\varepsilon_{A}Q}{T} \pm O\left(Q\sqrt{N}\delta_{A}\right),\]

and therefore,

\[\bm{a}_{*}:=\frac{\hat{\bm{a}}}{\mathbf{1}^{\top}\hat{\bm{a}}} =\frac{(1-\varepsilon_{A})\bm{q}+\varepsilon_{A}\mathbf{1}_{\bm{q}} /T+[\bm{\Delta}_{\bm{a}}]_{\bm{q}}}{(1-\varepsilon_{A})+\varepsilon_{A}Q/T\pm O \left(Q\sqrt{N}\delta_{A}\right)}\] \[=\frac{(1-\varepsilon_{A})\bm{q}+\varepsilon_{A}\mathbf{1}_{\bm{ q}}/T+[\bm{\Delta}_{\bm{a}}]_{\bm{q}}}{(1-\varepsilon_{A})}\left(1\pm O\left( \varepsilon_{A}Q/T+Q\sqrt{N}\delta_{A}\right)\right)\] \[=\bm{q}\pm O_{2}\left(\varepsilon_{A}Q/T+\sqrt{QN}\delta_{A} \right).\]

Thus,

\[\left\|\bm{A}_{*}-\bm{Q}\right\|_{\mu}^{2}=\sum_{k=1}^{N}\mu_{k}\left\|\bm{a}_{ *}^{(k)}-\bm{q}^{(k)}\right\|^{2}=O\left(\frac{\varepsilon_{A}^{2}Q^{2}}{T^{2 }}+\delta_{A}^{2}NQ\right).\]

**Lemma F.2**.: _Let \(\varepsilon\in(\Theta(1)/(K_{Q}T),0.1)\) be our target accuracy. Suppose that \(\left\|\bm{A}-\bm{Q}\right\|_{\mu}\leq\delta_{A,*}\leq 0.01\varepsilon\) and \(\left\|\bm{\Lambda}_{V}\right\|_{\mu}\leq\delta_{V}\leq 0.01\) at the beginning of Stage 3, and \(\left\|\bm{h}_{V}\right\|_{\mu}\leq c\varepsilon\sqrt{K_{P}}K_{Q}\) for all \(\tau\) and a sufficiently small constant \(c\). Then, we have \(\left\|\bm{V}-\bm{P}\right\|_{\mu}^{2}\leq\varepsilon\) for all \(\tau\geq\mathcal{T}_{2}+\Theta(\log(1/\varepsilon)/\eta)\)._

Proof.: Under the condition \(\left\|\bm{A}-\bm{Q}\right\|_{\mu}\leq\delta_{A,*}\), we have \(\left\|\bm{\Lambda}_{A}\right\|_{\mu}\leq\left\|\bm{A}-\bm{Q}\right\|_{\mu} \leq\delta_{A,*}\) and

\[\alpha_{A}=\frac{1}{K_{Q}}\left(\left\langle\bm{A},\bm{Q}\right\rangle_{\mu}- \frac{1}{T}\right)=\frac{1}{K_{Q}}\left(K_{Q}+\left\langle\bm{\Lambda}_{A}, \bm{Q}\right\rangle_{\mu}\right)=1\pm O\left(\sqrt{Q}\delta_{A,*}\right).\]

Recall that we only train \(\bm{V}\) in Stage 3. Note that by Lemma C.3,

\[\left\|\bm{V}-\bm{P}\right\|_{\mu}^{2}=\left\|\tilde{\bm{V}}-\bm{P}\right\|_{ \mu}^{2}+\left\|\bm{\Lambda}_{V}\right\|_{\mu}^{2}=(1-\alpha_{V})^{2}K_{P}+ \left\|\bm{\Lambda}_{V}\right\|_{\mu}^{2}\leq(1-\alpha_{V})^{2}+\left\|\bm{ \Lambda}_{V}\right\|_{\mu}^{2}.\]

Hence, to get \(\varepsilon\) accuracy, it suffices to have \((1-\alpha_{V})^{2}\leq\varepsilon/2\) and \(\left\|\bm{\Lambda}_{V}\right\|_{\mu}^{2}\leq\varepsilon/2\).

First, for \(\alpha_{V}\), by Lemma C.5 and \(\eta_{V}=\eta/K_{Q}\), we have

\[\alpha_{V,\tau+1} =\alpha_{V,\tau}+\eta_{V}K_{Q}\left(1-\alpha_{V}\alpha_{A}\right) \alpha_{V}+\eta_{V}\frac{1-\alpha_{V}}{T}-\eta_{V}\alpha_{V}\left\|\bm{ \Lambda}_{A}\right\|_{\mu}^{2}-\frac{\eta_{V}}{K_{P}}\left\langle\bm{h}_{V, \tau},\bm{P}\right\rangle_{\mu}\] \[=\alpha_{V,\tau}+\eta\left(1-\alpha_{V}\right)\alpha_{V}\pm\eta O \left(\frac{1}{K_{Q}T}+\delta_{A,*}\alpha_{V}\right)\pm\eta O\left(\frac{ \left\langle\bm{h}_{V,\tau},\bm{P}\right\rangle_{\mu}}{K_{P}K_{Q}}\right).\]

Hence,

\[\left(1-\alpha_{V,\tau+1}\right)^{2} =\left(\left(1-\eta\alpha_{V}\right)\left(1-\alpha_{V,\tau} \right)\pm\eta O\left(\frac{1}{K_{Q}T}+\delta_{A,*}\alpha_{V}\right)\pm\eta O \left(\frac{\left\langle\bm{h}_{V,\tau},\bm{P}\right\rangle_{\mu}}{K_{P}K_{Q} }\right)\right)^{2}\] \[\leq\exp\left(-2\eta\alpha_{V}\right)\left(1-\alpha_{V,\tau} \right)^{2}+\eta O\left(\frac{1}{K_{Q}T}+\delta_{A,*}\alpha_{V}\right)+\eta O \left(\frac{\left\langle\bm{h}_{V,\tau},\bm{P}\right\rangle_{\mu}}{K_{P}K_{Q} }\right)\] \[\leq\exp\left(-\eta\right)\left(1-\alpha_{V,\tau}\right)^{2}+0.1 \eta\varepsilon.\]

For \(\left\|\bm{\Lambda}_{A}\right\|_{\mu}^{2}\), by (the proof of) Lemma E.5, we have

\[\left\|\bm{\Lambda}_{V,\tau+1}\right\|_{\mu}^{2} \leq\exp\left(-2\eta\alpha_{A}^{2}\right)\left\|\bm{\Lambda}_{V, \tau}\right\|_{\mu}^{2}+3\eta\left(\left\|\bm{\Lambda}_{V,\tau}\right\|_{\mu}+ \eta\frac{\left\|\bm{h}_{V}\right\|_{\mu}}{\sqrt{K_{P}}K_{Q}}\right)\frac{ \left\|\bm{h}_{V}\right\|_{\mu}}{\sqrt{K_{P}}K_{Q}}\] \[\leq\exp\left(-\eta\right)\left\|\bm{\Lambda}_{V,\tau}\right\|_{ \mu}^{2}+0.1\eta\varepsilon.\]

Thus, by Lemma E.9, we have \((1-\alpha_{V})^{2}\leq\varepsilon/2\) and \(\left\|\bm{\Lambda}_{V}\right\|_{\mu}^{2}\leq\varepsilon/2\) for all \(\tau\geq\mathcal{T}_{2}+\Theta\left(\log(1/\varepsilon)/\eta\right)\). 

**Corollary F.3**.: _Let \(\varepsilon\in(\Theta(1)/(K_{Q}T),0.1)\) be our target accuracy. Suppose that \(\alpha_{A}\in(0.9,1.1)\), \(\left\|\bm{\Lambda}_{A}\right\|_{\mu}^{2}\leq O(\varepsilon/(Q\sqrt{N}))\), and \(\left\|\bm{\Lambda}_{V}\right\|_{\mu}^{2}\leq 0.01\). Then with \(\operatorname{poly}(N,Q,1/\varepsilon)\) samples, we have with high probability that \(\left\|\bm{A}-\bm{Q}\right\|_{\mu}^{2}\leq\varepsilon\) and \(\left\|\bm{V}-\bm{P}\right\|_{\mu}^{2}\leq\varepsilon\) after Stage 3, which takes \(O(\log(1/\varepsilon)/\eta)\) steps._

Proof.: It suffices to combine the previous two lemmas, the concentration results in Section B, and apply union bound. 

## Appendix G Proof of the main theorem

In this section, we combine the results from the last three sections and prove the following formal version of Theorem 3.1.

**Theorem G.1**.: _Let \(\varepsilon>0\) be our target accuracy and \(\mathcal{T}_{1}=\min\{\tau\geq 0\,:\,\max\{\alpha_{V,\tau},\alpha_{A,\tau}\}\geq \Theta(1/(QN))\}\). We can choose the hyperparameters in Algorithm 1 such that within \(O\left(\log(T)/\eta_{1}+1/(\eta\alpha^{(2)})+\log(1/\varepsilon)/\eta\right)\) steps, we have \(\left\|\bm{A}-\bm{Q}\right\|_{\mu}^{2}\leq\varepsilon\) and \(\left\|\bm{V}-\bm{P}\right\|_{\mu}^{2}\leq\varepsilon\) with probability at least \(1-\delta\) and the number of samples used before and after \(\mathcal{T}_{1}\) are \(\operatorname{poly}(T,\delta)\) and \(\operatorname{poly}(N,Q,1/\varepsilon,\log T,\delta)\), respectively._Proof.: The results for Stage 1 follow directly from Lemma D.1. Now, consider the results for Stage 2 and 3. First, by Corollary F.3, it suffices to make sure at time \(\mathcal{T}_{2}\), we have \(\alpha_{A}\in(0.9,1.1)\), \(\left\|\Delta_{A}\right\|_{\mu}^{2}\leq O(\varepsilon/(Q\sqrt{N}))\) and \(\left\|\Delta_{V}\right\|_{\mu}^{2}\leq 0.01\) (with high probability). By Lemma D.1, we know the following hold at time \(\mathcal{T}_{1}\) w.h.p:

\[\alpha_{A},\alpha_{V}=\Theta(1/(QN))\quad\text{and}\quad\left\| \mathbf{\Lambda}_{A}\right\|_{\mu}^{2},\left\|\mathbf{\Lambda}_{V}\right\|_{ \mu}^{2}\leq O(1/T).\]

Therefore, by Lemma E.1, if we choose the threshold to be \(\Theta(1/(Q^{2}N))\), then after thresholding and projection, we have \(a_{t}^{(k)}=O(1/T)\) for all \(t\notin\boldsymbol{q}^{(k)}\). Thus, by Lemma E.3 and Lemma E.4, with \(\mathrm{poly}(Q,N,1/\varepsilon,\log(T))\) samples, we have with high probability that \(a_{t}^{(k)}=O(1/T)\) for all \(t\notin\boldsymbol{q}^{(k)}\) holds and \(\left\|\hat{\boldsymbol{\mathrm{f}}}_{A}\right\|_{\mu}\) satisfies the requirements in Lemma E.10 throughout Stage 2. Thus, by Lemma E.10 with \(\delta_{*}^{2}=O(\varepsilon/Q\sqrt{N})\), at the end of Stage 2, we have with high probability that \(\alpha_{A}\in(0.9,1.1)\), \(\left\|\Delta_{A}\right\|_{\mu}^{2}\leq O(\varepsilon/(Q\sqrt{N}))\) and \(\left\|\mathbf{\Lambda}_{V}\right\|_{\mu}^{2}\leq 0.01\). When combined with Corollary F.3, this completes the proof. 

## Appendix H Transfer learning

**Lemma H.1** (Initialization).: _Suppose that we have learned \(\hat{\boldsymbol{P}}\) and \(\left\langle\hat{\boldsymbol{P}},\boldsymbol{P}\right\rangle_{\mu}\geq 2 \left\|\boldsymbol{\mu}\right\|^{2}\), \(\left\|\hat{\boldsymbol{P}}\right\|_{\mu}^{2}=\Theta(1)\left\|\boldsymbol{P} \right\|_{\mu}^{2}\). Let \(\boldsymbol{V}=\theta\hat{\boldsymbol{P}}+(1-\theta)\boldsymbol{\mu}\boldsymbol {1}^{\top}\) for some \(\theta\in(0,1)\). We have_

\[\alpha_{V}\in\left[\Theta\left(\frac{\theta}{NK_{P}}\right), \Theta\left(\theta\right)\right]\quad\text{and}\quad\left\|\mathbf{\Lambda}_ {V}\right\|_{\mu}^{2}\leq\Theta(1)\theta^{2}K_{P}.\]

Proof.: First, consider \(\mathbf{\Lambda}_{V}\). Since \(\left\|\mathbf{\Lambda}_{V}\right\|_{\mu}\) is the distance to a projection, we have

\[\left\|\mathbf{\Lambda}_{V}\right\|_{\mu}^{2}\leq\left\|\boldsymbol{V}-\left( \theta\boldsymbol{P}+(1-\theta)\boldsymbol{\mu}\boldsymbol{1}^{\top}\right) \right\|_{\mu}^{2}=\theta^{2}\left\|\hat{\boldsymbol{P}}-\boldsymbol{P} \right\|_{\mu}^{2}\leq\Theta(1)\theta^{2}\left\|\boldsymbol{P}\right\|_{\mu}^{2} =\Theta(1)\theta^{2}K_{P}.\]

For \(\alpha_{V}\), we compute

\[\left\langle\boldsymbol{V},\boldsymbol{P}\right\rangle_{\mu}- \left\|\boldsymbol{\mu}\right\|^{2}=\theta\left(\left\langle\hat{\boldsymbol{ P}},\boldsymbol{P}\right\rangle_{\mu}-\left\|\boldsymbol{\mu}\right\|^{2} \right)\geq\theta\left\|\boldsymbol{\mu}\right\|^{2}\geq\Theta(1)\theta/N.\]

In particular, this implies \(\alpha_{V}\geq\Theta\left(\frac{\theta}{NK_{P}}\right)\). 

**Lemma H.2** (First gradient step).: _Let \(\boldsymbol{A}=\boldsymbol{1}\boldsymbol{1}^{\top}/T\) and \(\boldsymbol{V}\) given by Lemma H.1. Let \(\varepsilon_{\texttt{Top}}\leq O(1/(NK_{P}))\). Run one gradient step with \(\mathrm{poly}(N,Q,\log T,1/\varepsilon_{\texttt{Top}})\) samples and \(\eta=1\), remove all entries of \(\boldsymbol{a}^{(k)}\) with \(|a_{t}^{(k)}|\leq\Theta(\theta/(NK_{P}))\) and the replace \(\boldsymbol{a}^{(k)}\) with the projection \((\boldsymbol{I}-\boldsymbol{1}\boldsymbol{1}^{\top}/T)\boldsymbol{a}^{(k)}\). With high probability, we have \(\alpha_{A}=(1\pm O(\varepsilon_{\texttt{Top}}))\alpha_{V}\) and \(\left\|\mathbf{\Lambda}_{A}\right\|_{\mu}^{2}\leq O\left(\frac{\varepsilon_{ \texttt{Top}}^{2}\alpha_{V}^{2}}{Q}+\frac{1}{T}\right)\)._

Proof.: The proof idea is essentially the same as Lemma E.3, though the reinitialization of the first layer allows better estimations in several places. Recall that for each \(s\in[T]\), we have

\[\partial_{a_{s}^{(k)}}l =\mathbb{1}\left\{x_{T+1}=k\right\}(\boldsymbol{V}\boldsymbol{e} _{x_{s}})^{\top}\left(\boldsymbol{V}\boldsymbol{X}\boldsymbol{1}/T- \boldsymbol{e}_{x_{\alpha}}\right),\] \[\mathbb{E}\,\partial_{a_{s}^{(k)}}l =\mu_{k}K_{V}/T-\mu_{k}K_{VP}q_{s}.\]

Also recall from Lemma C.3 that \(K_{VP}=\alpha_{V}K_{P}\) and \(K_{V}=\alpha_{V}^{2}K_{P}+\left\|\mathbf{\Lambda}_{V}\right\|_{\mu}^{2}\). For any \(s\in\boldsymbol{q}^{(k)}\), we have

\[-\mathbb{E}\,\partial_{a_{s}^{(k)}}l =\mu_{k}\left(\alpha_{V}K_{P}q_{s}-\frac{\alpha_{V}^{2}K_{P}+ \left\|\mathbf{\Lambda}_{V}\right\|_{\mu}^{2}}{T}\right)\geq\frac{\mu_{k} \alpha_{V}K_{P}q_{s}}{2}\]

where the inequality comes from \(\mu_{k}\alpha_{V}K_{P}q_{s}\geq\Omega(\alpha_{V}/N^{2}/Q)\gg 1/T\). Meanwhile, for any \(s\notin[T]\), we have \(\mathbb{E}\,\partial_{a_{s}^{(k)}}l=O(1/T)\).

[MISSING_PAGE_EMPTY:46]

experiment with larger \(N\). As for other hyperparameters, \(\lambda\) is chosen based on our theoretical results (Theorem 3.1 and G.1): \(\lambda\sim\Theta(\epsilon K_{P}/Q^{2}N^{3})\) in Lemma E.4. The batch size can be chosen from standard \(\{64,128,256\}\), while smaller batch size will lead to divergence for both SGD and regularized GD. \(\eta\) is chosen as the largest learning rate without divergence.

Besides the original parameters, we consider the approximation error after the normalization step (stage 3) in real-time. That is thresholding and normalizing the attention block

\[\forall k\in[n],\hat{\bm{a}}^{(k)}=[a_{t}^{(k)}\mathds{1}\{a_{t}^{(k)}\geq \Omega(1/Q)\}]_{t}.\ \ \bm{a}^{(k)}\leftarrow\hat{\bm{a}}^{(k)}/\mathbf{1}^{\mathsf{T}}\hat{\bm{a}}^{( k)}\]

and we do further gradient descent to recover \(\bm{V}\). In this case, we will directly use the linear regression solution on population loss for \(\bm{V}\).

Here we report in addition: (1) original signal projection on the population process trajectory \(\alpha_{A}\), \(\alpha_{V}\) and the distance to the trajectory \(\bm{\Delta_{A}},\bm{\Delta_{V}}\). (2) The approximation error/similarity before and after normalization for both SGD and proximal gradient descent. We conclude that in all metrics proximal gradient descent performs better than the vanilla gradient descent with a small batch size (when the noise is large).

We tried different orders of state number \(N\) and show that \(\ell_{1}\) regularization is necessary and outperforms SGD when batch size is small (gradient noise is large). Due to computation limitation, we experiment with real batched gradient on \(N\leq 20,T\leq 5000\), and do SGD simulation by combining our population gradient + Gaussian noise (to mimic the batch gradient noise) for \(N\leq 500,T\leq 100000\).

We also corroborate our previous experiments with the new test loss plot to show the convergence of training. Note that since there are multiple global minima for the linear attention, \(\ell_{1}\) regularized dynamics eventually will make \(A\) and \(Q\) deviate from the ground-truth while representing the same function. That is why the loss converges but the distance to the ground-truth increases after some

Figure 4: **Similarity with the ground-truth. The figure shows after Stage 1, normalization helps further improve the solution of the proximal method. Meanwhile, with or without normalization, our proximal method always outperforms the vanilla SGD, which fails to recover the ground-truth.**

Figure 3: **Signals \(\alpha_{A},\alpha_{V}\) and the distance to population process \(\bm{\Delta_{A}},\bm{\Delta_{V}}\). For the SGD, the distance to the population process of the attention matrix \(\bm{A}\) keeps growing and dominates the signal term. That explains the failure to learn the correct attention pattern, which leads to saturation of the signal. In comparison, our proximal methods dramatically help reduce the gradient noise and keep close to the population process. Though \(\|\bm{\Delta_{A}}\|\) eventually grows up due to the bias of the gradient estimate (the original signal growth is also slowed down), after normalization it can still approximately learn the correct pattern. Both \(\|\bm{\Delta_{V}}\|\) stay small empirically.**

point, making the final normalization step essential to recover the ground-truth. Another point is that according to our theory, the regularization will eventually distort the learned pattern when trained for too many iterations. Empirically, the loss also increases a little after it converges. Therefore, we must stop early and normalize before the distortion happens.

Figure 5: **Convergence analysis. We plot the distance to the ground-truth and the test loss for \(N=3,10,20\) (from top to bottom). It shows that when gradient noise is large, \(\ell_{1}\) regularized algorithm with normalization and early-stopping can almost perfectly recover the ground-truth (the star), while SGD struggles to learn the target function. Figure 3 (Appendix I) also shows when the gradient noise is large, SGD never learns ground-truth \(Q\) even with normalization.**

Figure 6: **Simulation with larger \(N\) and \(T\). We simulate the SGD/\(\ell_{1}\) regularized dynamics by replacing the batched noise with Gaussian noise in the dynamics formula in Lemma C.5 and C.6. The gaussian noise variance scales with the inverse of batch size. The experiments show that the conclusions drawn from the small \(N\) cases still hold in those simulations: when \(T=100000,N=100/500\), our \(\ell_{1}\) regularized algorithm can recover the ground-truth since the distance to the population trajectory (\(\Delta_{A},\Delta_{V}\)) stays very small, while the error along SGD trajectories quickly increases with the same batch size.**

### NeurIPS Paper Checklist

1. **Claims** Question: Do the main claims made in the abstract and introduction accurately reflect the paper's contributions and scope? Answer: [Yes] Justification: We accurately summarized our claims and contributions in the abstract as well as the introduction. Guidelines: * The answer NA means that the abstract and introduction do not include the claims made in the paper. * The abstract and/or introduction should clearly state the claims made, including the contributions made in the paper and important assumptions and limitations. A No or NA answer to this question will not be perceived well by the reviewers. * The claims made should match theoretical and experimental results, and reflect how much the results can be expected to generalize to other settings. * It is fine to include aspirational goals as motivation as long as it is clear that these goals are not attained by the paper.
2. **Limitations** Question: Does the paper discuss the limitations of the work performed by the authors? Answer: [Yes] Justification: It is included in Appendix A. Guidelines: * The answer NA means that the paper has no limitation while the answer No means that the paper has limitations, but those are not discussed in the paper. * The authors are encouraged to create a separate "Limitations" section in their paper. * The paper should point out any strong assumptions and how robust the results are to violations of these assumptions (e.g., independence assumptions, noiseless settings, model well-specification, asymptotic approximations only holding locally). The authors should reflect on how these assumptions might be violated in practice and what the implications would be. * The authors should reflect on the scope of the claims made, e.g., if the approach was only tested on a few datasets or with a few runs. In general, empirical results often depend on implicit assumptions, which should be articulated. * The authors should reflect on the factors that influence the performance of the approach. For example, a facial recognition algorithm may perform poorly when image resolution is low or images are taken in low lighting. Or a speech-to-text system might not be used reliably to provide closed captions for online lectures because it fails to handle technical jargon. * The authors should discuss the computational efficiency of the proposed algorithms and how they scale with dataset size. * If applicable, the authors should discuss possible limitations of their approach to address problems of privacy and fairness. * While the authors might fear that complete honesty about limitations might be used by reviewers as grounds for rejection, a worse outcome might be that reviewers discover limitations that aren't acknowledged in the paper. The authors should use their best judgment and recognize that individual actions in favor of transparency play an important role in developing norms that preserve the integrity of the community. Reviewers will be specifically instructed to not penalize honesty concerning limitations.
3. **Theory Assumptions and Proofs** Question: For each theoretical result, does the paper provide the full set of assumptions and a complete (and correct) proof? Answer: [Yes]Justification: The assumptions and conditions are included in the Setup section 2. Guidelines: * The answer NA means that the paper does not include theoretical results. * All the theorems, formulas, and proofs in the paper should be numbered and cross-referenced. * All assumptions should be clearly stated or referenced in the statement of any theorems. * The proofs can either appear in the main paper or the supplemental material, but if they appear in the supplemental material, the authors are encouraged to provide a short proof sketch to provide intuition. * Inversely, any informal proof provided in the core of the paper should be complemented by formal proofs provided in appendix or supplemental material. * Theorems and Lemmas that the proof relies upon should be properly referenced.
4. **Experimental Result Reproducibility** Question: Does the paper fully disclose all the information needed to reproduce the main experimental results of the paper to the extent that it affects the main claims and/or conclusions of the paper (regardless of whether the code and data are provided or not)? Answer: [Yes] Justification: All information is included in Section 5 and Appendix I. Guidelines: * The answer NA means that the paper does not include experiments. * If the paper includes experiments, a No answer to this question will not be perceived well by the reviewers: Making the paper reproducible is important, regardless of whether the code and data are provided or not. * If the contribution is a dataset and/or model, the authors should describe the steps taken to make their results reproducible or verifiable. * Depending on the contribution, reproducibility can be accomplished in various ways. For example, if the contribution is a novel architecture, describing the architecture fully might suffice, or if the contribution is a specific model and empirical evaluation, it may be necessary to either make it possible for others to replicate the model with the same dataset, or provide access to the model. In general. releasing code and data is often one good way to accomplish this, but reproducibility can also be provided via detailed instructions for how to replicate the results, access to a hosted model (e.g., in the case of a large language model), releasing of a model checkpoint, or other means that are appropriate to the research performed. * While NeurIPS does not require releasing code, the conference does require all submissions to provide some reasonable avenue for reproducibility, which may depend on the nature of the contribution. For example 1. If the contribution is primarily a new algorithm, the paper should make it clear how to reproduce that algorithm. 2. If the contribution is primarily a new model architecture, the paper should describe the architecture clearly and fully. 3. If the contribution is a new model (e.g., a large language model), then there should either be a way to access this model for reproducing the results or a way to reproduce the model (e.g., with an open-source dataset or instructions for how to construct the dataset). 4. We recognize that reproducibility may be tricky in some cases, in which case authors are welcome to describe the particular way they provide for reproducibility. In the case of closed-source models, it may be that access to the model is limited in some way (e.g., to registered users), but it should be possible for other researchers to have some path to reproducing or verifying the results.
5. **Open access to data and code** Question: Does the paper provide open access to the data and code, with sufficient instructions to faithfully reproduce the main experimental results, as described in supplemental material?Answer: [Yes] Justification: We will upload the codes in the supplementary materials. Guidelines:

* The answer NA means that paper does not include experiments requiring code.
* Please see the NeurIPS code and data submission guidelines (https://nips.cc/public/guides/CodeSubmissionPolicy) for more details.
* While we encourage the release of code and data, we understand that this might not be possible, so "No" is an acceptable answer. Papers cannot be rejected simply for not including code, unless this is central to the contribution (e.g., for a new open-source benchmark).
* The instructions should contain the exact command and environment needed to run to reproduce the results. See the NeurIPS code and data submission guidelines (https://nips.cc/public/guides/CodeSubmissionPolicy) for more details.
* The authors should provide instructions on data access and preparation, including how to access the raw data, preprocessed data, intermediate data, and generated data, etc.
* The authors should provide scripts to reproduce all experimental results for the new proposed method and baselines. If only a subset of experiments are reproducible, they should state which ones are omitted from the script and why.
* At submission time, to preserve anonymity, the authors should release anonymized versions (if applicable).
* Providing as much information as possible in supplemental material (appended to the paper) is recommended, but including URLs to data and code is permitted.
6. **Experimental Setting/Details** Question: Does the paper specify all the training and test details (e.g., data splits, hyperparameters, how they were chosen, type of optimizer, etc.) necessary to understand the results? Answer: [Yes] Justification: All information is included in Section 5 and Appendix I. Guidelines: * The answer NA means that the paper does not include experiments. * The experimental setting should be presented in the core of the paper to a level of detail that is necessary to appreciate the results and make sense of them. * The full details can be provided either with the code, in appendix, or as supplemental material.
7. **Experiment Statistical Significance** Question: Does the paper report error bars suitably and correctly defined or other appropriate information about the statistical significance of the experiments? Answer: [No] Justification: Our experiments are for dynamics simulations. We do not include performance/accuracy results. Guidelines: * The answer NA means that the paper does not include experiments. * The authors should answer "Yes" if the results are accompanied by error bars, confidence intervals, or statistical significance tests, at least for the experiments that support the main claims of the paper. * The factors of variability that the error bars are capturing should be clearly stated (for example, train/test split, initialization, random drawing of some parameter, or overall run with given experimental conditions). * The method for calculating the error bars should be explained (closed form formula, call to a library function, bootstrap, etc.) * The assumptions made should be given (e.g., Normally distributed errors).

* It should be clear whether the error bar is the standard deviation or the standard error of the mean.
* It is OK to report 1-sigma error bars, but one should state it. The authors should preferably report a 2-sigma error bar than state that they have a 96% CI, if the hypothesis of Normality of errors is not verified.
* For asymmetric distributions, the authors should be careful not to show in tables or figures symmetric error bars that would yield results that are out of range (e.g. negative error rates).
* If error bars are reported in tables or plots, The authors should explain in the text how they were calculated and reference the corresponding figures or tables in the text.
8. **Experiments Compute Resources** Question: For each experiment, does the paper provide sufficient information on the computer resources (type of compute workers, memory, time of execution) needed to reproduce the experiments? Answer: [Yes] Justification: All information is included in Section 5 and Appendix I. Guidelines: * The answer NA means that the paper does not include experiments. * The paper should indicate the type of compute workers CPU or GPU, internal cluster, or cloud provider, including relevant memory and storage. * The paper should provide the amount of compute required for each of the individual experimental runs as well as estimate the total compute. * The paper should disclose whether the full research project required more compute than the experiments reported in the paper (e.g., preliminary or failed experiments that didn't make it into the paper).
9. **Code Of Ethics** Question: Does the research conducted in the paper conform, in every respect, with the NeurIPS Code of Ethics https://neurips.cc/public/EthicsGuidelines? Answer: [Yes] Justification: This work is a pure theory paper without potential harmful effect. Guidelines: * The answer NA means that the authors have not reviewed the NeurIPS Code of Ethics. * If the authors answer No, they should explain the special circumstances that require a deviation from the Code of Ethics. * The authors should make sure to preserve anonymity (e.g., if there is a special consideration due to laws or regulations in their jurisdiction).
10. **Broader Impacts** Question: Does the paper discuss both potential positive societal impacts and negative societal impacts of the work performed? Answer: [NA] Justification: This work is a theoretical paper without direct societal impact. Guidelines: * The answer NA means that there is no societal impact of the work performed. * If the authors answer NA or No, they should explain why their work has no societal impact or why the paper does not address societal impact. * Examples of negative societal impacts include potential malicious or unintended uses (e.g., disinformation, generating fake profiles, surveillance), fairness considerations (e.g., deployment of technologies that could make decisions that unfairly impact specific groups), privacy considerations, and security considerations.

* The conference expects that many papers will be foundational research and not tied to particular applications, let alone deployments. However, if there is a direct path to any negative applications, the authors should point it out. For example, it is legitimate to point out that an improvement in the quality of generative models could be used to generate deepfakes for disinformation. On the other hand, it is not needed to point out that a generic algorithm for optimizing neural networks could enable people to train models that generate Deepfakes faster.
* The authors should consider possible harms that could arise when the technology is being used as intended and functioning correctly, harms that could arise when the technology is being used as intended but gives incorrect results, and harms following from (intentional or unintentional) misuse of the technology.
* If there are negative societal impacts, the authors could also discuss possible mitigation strategies (e.g., gated release of models, providing defenses in addition to attacks, mechanisms for monitoring misuse, mechanisms to monitor how a system learns from feedback over time, improving the efficiency and accessibility of ML).
11. **Safeguards** Question: Does the paper describe safeguards that have been put in place for responsible release of data or models that have a high risk for misuse (e.g., pretrained language models, image generators, or scraped datasets)? Answer: [NA] Justification: This paper is a theoretical work without such risks. Guidelines: * The answer NA means that the paper poses no such risks. * Released models that have a high risk for misuse or dual-use should be released with necessary safeguards to allow for controlled use of the model, for example by requiring that users adhere to usage guidelines or restrictions to access the model or implementing safety filters. * Datasets that have been scraped from the Internet could pose safety risks. The authors should describe how they avoided releasing unsafe images. * We recognize that providing effective safeguards is challenging, and many papers do not require this, but we encourage authors to take this into account and make a best faith effort.
12. **License for existing assets** Question: Are the creators or original owners of assets (e.g., code, data, models), used in the paper, properly credited and are the license and terms of use explicitly mentioned and properly respected? Answer: [NA] Justification: The paper does not use existing assets. Guidelines: * The answer NA means that the paper does not use existing assets. * The authors should cite the original paper that produced the code package or dataset. * The authors should state which version of the asset is used and, if possible, include a URL. * The name of the license (e.g., CC-BY 4.0) should be included for each asset. * For scraped data from a particular source (e.g., website), the copyright and terms of service of that source should be provided. * If assets are released, the license, copyright information, and terms of use in the package should be provided. For popular datasets, paperswithcode.com/datasets has curated licenses for some datasets. Their licensing guide can help determine the license of a dataset. * For existing datasets that are re-packaged, both the original license and the license of the derived asset (if it has changed) should be provided.

* If this information is not available online, the authors are encouraged to reach out to the asset's creators.
* **New Assets*
* Question: Are new assets introduced in the paper well documented and is the documentation provided alongside the assets? Answer: [NA] Justification: The paper does not release new assets. Guidelines:
* The answer NA means that the paper does not release new assets.
* Researchers should communicate the details of the dataset/code/model as part of their submissions via structured templates. This includes details about training, license, limitations, etc.
* The paper should discuss whether and how consent was obtained from people whose asset is used.
* At submission time, remember to anonymize your assets (if applicable). You can either create an anonymized URL or include an anonymized zip file.
* **Crowdsourcing and Research with Human Subjects*
* Question: For crowdsourcing experiments and research with human subjects, does the paper include the full text of instructions given to participants and screenshots, if applicable, as well as details about compensation (if any)? Answer: [NA] Justification: The paper does not involve crowdsourcing nor research with human subjects. Guidelines:
* The answer NA means that the paper does not involve crowdsourcing nor research with human subjects.
* Including this information in the supplemental material is fine, but if the main contribution of the paper involves human subjects, then as much detail as possible should be included in the main paper.
* According to the NeurIPS Code of Ethics, workers involved in data collection, curation, or other labor should be paid at least the minimum wage in the country of the data collector.
* **Institutional Review Board (IRB) Approvals or Equivalent for Research with Human Subjects*
* Question: Does the paper describe potential risks incurred by study participants, whether such risks were disclosed to the subjects, and whether Institutional Review Board (IRB) approvals (or an equivalent approval/review based on the requirements of your country or institution) were obtained? Answer: [NA] Justification: The paper does not involve crowdsourcing nor research with human subjects. Guidelines:
* The answer NA means that the paper does not involve crowdsourcing nor research with human subjects.
* Depending on the country in which research is conducted, IRB approval (or equivalent) may be required for any human subjects research. If you obtained IRB approval, you should clearly state this in the paper.
* We recognize that the procedures for this may vary significantly between institutions and locations, and we expect authors to adhere to the NeurIPS Code of Ethics and the guidelines for their institution.
* For initial submissions, do not include any information that would break anonymity (if applicable), such as the institution conducting the review.