# Max-Margin Token Selection in Attention Mechanism

 Davoud Ataee Tarzanagh

University of Pennsylvania

tarzanaq@upenn.edu

Yingcong Li  Xuechen Zhang

University of California, Rivers

{yli692,xzhan394}@ucr.edu

Samet Oymak

University of Michigan

UC Rivers

oymak@umich.edu

###### Abstract

Attention mechanism is a central component of the transformer architecture which led to the phenomenal success of large language models. However, the theoretical principles underlying the attention mechanism are poorly understood, especially its nonconvex optimization dynamics. In this work, we explore the seminal softmax-attention model \(f(\bm{X})=\langle\bm{Xv},\bm{\mathsf{softmax}}(\bm{XWp})\rangle\), where \(\bm{X}\) is the token sequence and \((\bm{v},\bm{W},\bm{p})\) are trainable parameters. We prove that running gradient descent on \(\bm{p}\), or equivalently \(\bm{W}\), converges in direction to a max-margin solution that separates _locally-optimal_ tokens from non-optimal ones. This clearly formalizes attention as an optimal token selection mechanism. Remarkably, our results are applicable to general data and precisely characterize _optimality_ of tokens in terms of the value embeddings \(\bm{Xv}\) and problem geometry. We also provide a broader regularization path analysis that establishes the margin maximizing nature of attention even for nonlinear prediction heads. When optimizing \(\bm{v}\) and \(\bm{p}\) simultaneously with logistic loss, we identify conditions under which the regularization paths directionally converge to their respective hard-margin SVM solutions where \(\bm{v}\) separates the input features based on their labels. Interestingly, the SVM formulation of \(\bm{p}\) is influenced by the support vector geometry of \(\bm{v}\). Finally, we verify our theoretical findings via numerical experiments and provide insights.

## 1 Introduction

Since its introduction in the seminal work [1], attention mechanism has played an influential role in advancing natural language processing, and more recently, large language models [2, 3, 4, 5]. Initially introduced for encoder-decoder RNN architectures, attention allows the decoder to focus on the most relevant parts of the input sequence, instead of relying solely on a fixed-length hidden state. Attention mechanism has taken the center stage in the transformers [6], where the self-attention layer - which calculates softmax similarities between input tokens - serves as the backbone of the architecture. Since their inception, transformers have revolutionized natural language processing, from models like BERT [7] to ChatGPT [8], and have also become the architecture of choice for foundation models [9] addressing diverse challenges in generative modeling [3, 10], computer vision [11, 12], and reinforcement learning [13, 14, 15].

The prominence of the attention mechanism motivates a fundamental theoretical understanding of its role in optimization and learning. While it is well-known that attention enables the model to focus on the relevant parts of the input sequence, the precise mechanism by which this is achieved is far from clear. To this end, we ask

**Q:** What are the optimization dynamics and inductive biases of the attention mechanism?

We study this question using the fundamental attention model \(f(\bm{X})=\langle\bm{Xv},\mathbb{S}(\bm{XW^{\top}p})\rangle\). Here, \(\bm{X}\) is the sequence of input tokens, \(\bm{v}\) is the prediction head, \(\bm{W}\) is the trainable key-query weights, and \(\mathbb{S}\)denotes the softmax nonlinearity. For transformers, \(\bm{p}\) corresponds to the \(\llbracket\mathsf{CLS}\rrbracket\) token or tunable prompt [16, 17, 18], whereas for RNN architectures [1], \(\bm{p}\) corresponds to the hidden state. Given training data \((Y_{i},\bm{X}_{i})_{i=1}^{n}\) with labels \(Y_{i}\in\{-1,1\}\) and inputs \(\bm{X}_{i}\in\mathbb{R}^{T\times d}\), we consider the empirical risk minimization with a decreasing loss function \(\ell(\cdot):\mathbb{R}\to\mathbb{R}\),

\[\mathcal{L}(\bm{v},\bm{p},\bm{W})=\frac{1}{n}\sum_{i=1}^{n}\ell(Y_{i}\cdot f( \bm{X}_{i})),\ \ \text{where}\ \ f(\bm{X}_{i})=\bm{v}^{\top}\bm{X}_{i}^{\top}\mathbb{S}(\bm{X}_{i}\bm{W}^{ \top}\bm{p}).\] (1)

At a high-level, this work establishes fundamental equivalences between the optimization trajectories of (1) and hard-margin SVM problems. Our main contributions are as follows:

\(\bullet\)**Optimization geometry of attention (Sec 2):** We first show that gradient iterations of \(\bm{p}\) and \(\bm{W}\) admit a one-to-one mapping, thus we focus on optimizing \(\bm{p}\) without losing generality. In Theorem 3, we prove that, under proper initialization:

Gradient descent on \(\bm{p}\) converges in direction to a max-margin solution - namely

(ATT-SVM) - that separates locally-optimal tokens from non-optimal ones.

We call these Locally-optimal \(\mathsf{Max}\)-\(\mathsf{Margin}\) (\(\mathsf{LMM}\)) directions and show that these thoroughly characterize the viable convergence directions of attention when the norm of its weights grows to infinity. We also identify conditions under which (algorithm-independent) regularization path and gradient descent path converge to Globally-optimal \(\mathsf{Max}\)-\(\mathsf{Margin}\) (\(\mathsf{GMM}\)) direction in Theorems 1 and 2, respectively. A central feature of our results is precisely quantifying _optimality_ in terms of _token scores_\(\bm{\gamma}_{i}=Y\cdot\bm{v}^{\top}\bm{x}_{t}\) where \(\bm{x}_{t}\) is the \(t^{\text{th}}\) token of the input sequence \(\bm{X}\). _Locally-optimal_ tokens are those with higher scores than their nearest neighbors determined by the SVM solution. These are illustrated in Figure 1.

\(\bullet\)**Optimize attention \(\bm{p}\) and prediction-head \(\bm{v}\) jointly (Sec 3):** We study the joint problem under logistic loss function. We use regularization path analysis where (ERM) is solved under ridge constraints and we study the solution trajectory as the constraints are relaxed. Since the problem is linear in \(\bm{v}\), if the attention features \(\bm{x}_{i}^{att}=\bm{X}_{i}^{\top}\mathbb{S}(\bm{X}_{i}\bm{W}^{\top}\bm{p})\) are separable based on their labels \(Y_{i}\), \(\bm{v}\) would implement a max-margin classifier. Building on this, we prove that \(\bm{p}\) and \(\bm{v}\) converges to their respective max-margin solutions under proper geometric conditions (Theorem 5). Relaxing these conditions, we obtain a more general solution where margin constraints on \(\bm{p}\) are relaxed on the inputs whose attention features are not support vectors of \(\bm{v}\) (Theorem 6). Figure 3 illustrates these outcomes.

The next section introduces the preliminary concepts, Section 4 presents numerical experiments1, Section 5 discusses related literature, and Section 6 highlights limitations and future work.

Footnote 1: The code for experiments can be found at https://github.com/ucr-optml/max_margin_attention.

### Preliminaries

Notations.For any integer \(N\geq 1\), let \([N]:=\{1,\ldots,N\}\). We use lower-case and upper-case bold letters (e.g. \(\bm{a}\) and \(\bm{A}\)) to represent vectors and matrices, respectively. The entries of \(\bm{a}\) are denoted as \(\bm{a}_{i}\). We use \(\vec{\sigma}(\bm{A})\) to denote the maximum singular value of \(\bm{A}\). We denote the minimum of two numbers \(a\), \(b\) as \(a\wedge b\), and the maximum as \(a\lor b\). Big-O notation \(\mathcal{O}(\cdot)\) hides the universal constants. Throughout, we will use \(\mathcal{L}(\bm{p})\) and \(\mathcal{L}(\bm{v},\bm{p})\) to denote Objective (1) with fixed \((\bm{v},\bm{W})\) and \(\bm{W}\), respectively.

**Optimization.** Given an objective function \(\mathcal{L}:\mathbb{R}^{d}\to\mathbb{R}\) and an \(\ell_{2}\)-norm bound \(R\), define the regularized solution as

Figure 1: The convergence behavior of the gradient descent on the attention weights \(\bm{p}\) using the logistic loss in (ERM). The arrows (——) represent trajectories from different initializations. Here, (- - -) and (- - -) denote the globally- and locally-optimal \(\mathsf{max}\)-\(\mathsf{margin}\) directions (\(\mathsf{GMM}\), \(\mathsf{LMM}\)). \(\gamma\) denotes the _score_ of a token per Definition 1. Discussion is provided under Theorems 2 and 3.

\[\bm{\bar{p}}(R):=\arg\min_{\|\bm{\mu}\|\leq R}\mathcal{L}(\bm{p}).\] (2)

Regularization path - the evolution of \(\bm{\bar{p}}(R)\) as \(R\) grows - is known to capture the spirit of gradient descent as the ridge constraint \(R\) provides a proxy for the number of gradient descent iterations. For instance, [19, 20, 21] study the implicit bias of logistic regression and rigorously connect the directional convergence of regularization path (i.e. \(\lim_{R\to\infty}\bm{\bar{p}}(R)/R\)) and gradient descent. For gradient descent, we assume the objective \(\mathcal{L}(\bm{p})\) is smooth and describe the gradient descent process as

\[\bm{p}(t+1)=\bm{p}(t)-\eta(t)\nabla\mathcal{L}(\bm{p}(t)),\] (3)

where \(\eta(t)\) is the stepsize at time \(t\) and \(\nabla\mathcal{L}(\bm{p}(t))\) is the gradient of \(\mathcal{L}\) at \(\bm{p}(t)\).

**Attention in Transformers.** Next, we will discuss the connection between our model and the attention mechanism used in transformers. Our exposition borrows from [17], where the authors analyze the same attention model using gradient-based techniques on specific contextual datasets.

\(\bullet\)**Self-attention** is the core building block of transformers [6]. Given an input consisting of \(T\) tokens \(\bm{X}=[\bm{x}_{1},\dots,\bm{x}_{T}]^{\top}\in\mathbb{R}^{T\times d}\), self-attention with key-query matrix \(\bm{W}\in\mathbb{R}^{d\times d}\), and value matrix \(\bm{V}\in\mathbb{R}^{d\times v}\), the self-attention model is defined as follows:

\[f_{\text{ss}}(\bm{X})=\mathbb{S}(\bm{X}\bm{W}\bm{X}^{\top})\bm{X}\bm{V}.\] (4)

Here, \(\mathbb{S}(\cdot)\) is the softmax nonlinearity that applies row-wise on the similarity matrix \(\bm{X}\bm{W}\bm{X}^{\top}\).

\(\bullet\)**Tunable tokens: [CLS] and prompt-tuning.** In practice, we append additional tokens to the raw input features \(\bm{X}\): For instance, a [CLS] token is used for classification purposes [7] and prompt vectors can be appended for adapting a pretrained model to new tasks [16, 18]. Let \(\bm{p}\in\mathbb{R}^{d}\) be the tunable token ([CLS] or prompt vector) and concatenate it to \(\bm{X}\) to obtain \(\bm{X}_{\bm{p}}:=[\bm{p}\bm{X}^{\top}]^{\top}\in\mathbb{R}^{(T+1)\times d}\). Consider the cross-attention features obtained from \(\bm{X}_{\bm{p}}\) and \(\bm{X}\) given by

\[\begin{bmatrix}f^{\top}_{\text{ss}}(\bm{X})\\ f^{\top}_{\text{ss}}(\bm{X})\end{bmatrix}=\mathbb{S}(\bm{X}_{\bm{p}}\bm{W}\bm{X }^{\top})\bm{X}\bm{V}=\begin{bmatrix}\mathbb{S}(\bm{p}^{\top}\bm{W}\bm{X}^{ \top})\\ \mathbb{S}(\bm{X}\bm{W}\bm{X}^{\top})\end{bmatrix}\bm{X}\bm{V}.\]

The beauty of cross-attention is that it isolates the contribution of \(\bm{p}\) under the upper term \(f_{\text{cls}}(\bm{X})=\bm{V}^{\top}\bm{X}^{\top}\mathbb{S}(\bm{X}\bm{W}^{ \top}\bm{p})\in\mathbb{R}^{v}\). In this work, we use the value weights for classification, thus we set \(v=1\), and denote \(\bm{v}=\bm{V}\in\mathbb{R}^{d}\). This brings us to our attention model of interest:

\[f(\bm{X})=\bm{v}^{\top}\bm{X}^{\top}\mathbb{S}(\bm{K}\bm{p}),\quad\text{where} \quad\bm{K}=\bm{X}\bm{W}^{\top}.\] (5)

Here, \((\bm{v},\bm{W},\bm{p})\) are the tunable model parameters and \(\bm{K}\) is the key embeddings. Note that \(\bm{W}\) and \(\bm{p}\) are playing the same role within softmax, thus, it is intuitive that they exhibit similar optimization dynamics. Confirming this, the next lemma shows that gradient iterations of \(\bm{p}\) (after setting \(\bm{W}\leftarrow\text{Identity}\)) and \(\bm{W}\) admit a one-to-one mapping.

**Lemma 1**: _Fix \(\bm{u}\in\mathbb{R}^{d}\setminus\{\bm{0}\}\). Let \(\psi:\mathbb{R}^{d}\to\mathbb{R}\) and \(\ell:\mathbb{R}\to\mathbb{R}\) be differentiable functions. On the same training data \((Y_{i},\bm{X}_{i})_{i=1}^{n}\), define \(\tilde{\mathcal{L}}(\bm{p}):=1/n\sum_{i=1}^{n}\ell(Y_{i}\cdot\psi(\bm{X}_{i}^{ \top}\mathbb{S}(\bm{X}_{i}\bm{p})))\) and \(\mathcal{L}(\bm{W}):=1/n\sum_{i=1}^{n}\ell(Y_{i}\cdot\psi(\bm{X}_{i}^{\top} \mathbb{S}(\bm{X}_{i}\bm{W}^{\top}\mathbb{n})))\). Consider the gradient descent iterations on \(\bm{p}\) and \(\bm{W}\) with initial values \(\bm{p}(0)\) and \(\bm{W}(0)=\bm{u}\bm{p}(0)^{\top}/\|\bm{u}\|^{2}\) and stepsizes \(\eta\) and \(\eta/\|\bm{u}\|^{2}\), respectively:_

\[\bm{p}(t+1) =\bm{p}(t)-\eta\nabla\tilde{\mathcal{L}}(\bm{p}(t)),\] \[\bm{W}(t+1) =\bm{W}(t)-\frac{\eta}{\|\bm{u}\|^{2}}\nabla\mathcal{L}(\bm{W}(t)).\]

_We have that \(\bm{W}(t)=\bm{u}\bm{p}(t)^{\top}/\|\bm{u}\|^{2}\) for all \(t\geq 0\)._

This lemma directly characterizes the optimization dynamics of \(\bm{W}\) through the dynamics of \(\bm{p}\), allowing us to reconstruct \(\bm{W}\) from \(\bm{p}\) using their gradient iterations. Therefore, we will fix \(\bm{W}\) and concentrate on optimizing \(\bm{p}\) in Section 2 and the joint optimization of \((\bm{v},\bm{p})\) in Section 3.

**Problem definition:** Throughout, \((Y_{i},\bm{X}_{i})_{i=1}^{n}\) denotes training dataset where \(Y_{i}\in\{-1,1\}\) and \(\bm{X}_{i}\in\mathbb{R}^{T\times d}\). We denote the key embeddings of \(\bm{X}_{i}\) via \(\bm{K}_{i}=\bm{X}_{i}W^{\top}\) and explore the training risk

\[\mathcal{L}(\bm{v},\bm{p})=\frac{1}{n}\sum_{i=1}^{n}\ell\left(Y_{i}\cdot\bm{v}^{ \top}\bm{X}_{i}^{\top}\mathbb{S}(\bm{K}_{i}\bm{p})\right).\] (ERM)

Importantly, our results apply to general tuples \((Y_{i},\bm{X}_{i},\bm{K}_{i})\) and do not assume that \((\bm{X}_{i},\bm{K}_{i})\) are tied via \(\bm{W}\). Finally, the \(t^{th}\) tokens of \(\bm{X}_{i},\bm{K}_{i}\) are denoted by \(\bm{x}_{it},\bm{k}_{it}\in\mathbb{R}^{d}\), respectively, for \(t\in[T]\).

The highly nonlinear and nonconvex nature of the softmax operation makes the training problem in (ERM) a challenging nonconvex optimization problem for \(\bm{p}\), even with a fixed \(\bm{v}\). In the next section, we will introduce a set of assumptions to demonstrate the global and local convergence of gradient descent for margin maximization in the attention mechanism.

## 2 Global and Local Margin Maximization with Attention

In this section, we present the main results of this paper (Theorems 2 and 3) by examining the implicit bias of gradient descent on learning \(\bm{p}\in\mathbb{R}^{d}\) given a fixed choice of \(\bm{v}\in\mathbb{R}^{d}\). Notably, our results apply to general _decreasing loss functions without requiring convexity_. This generality is attributed to margin maximization arising from the exponentially-tailed nature of softmax within attention, rather than \(\ell\). We maintain the following assumption on the loss function throughout this section.

**Assumption A (Well-behaved Loss)**: _Over any bounded interval: (1) \(\ell:\mathbb{R}\rightarrow\mathbb{R}\) is strictly decreasing. (2) \(\ell^{\prime}\) is \(M_{0}\)-Lipschitz continuous and \(|\ell^{\prime}(u)|\leq M_{1}\)._

Assumption A includes many common loss functions, including the logistic loss \(\ell\left(u\right)=\log\left(1+e^{-u}\right)\), exponential loss \(\ell\left(u\right)=e^{-u}\), and correlation loss \(\ell(u)=-u\). Assumption A implies that \(\mathcal{L}\left(\bm{p}\right)\) is \(L_{p}\)-smooth (see Lemma 6 in Supplementary), where

\[L_{p}:=\frac{1}{n}\sum_{i=1}^{n}\left(M_{0}\|\bm{v}\|^{2}\|\bm{W}\|^{2}\|\bm{ X}_{i}\|^{4}+3M_{1}\|\bm{v}\|\ \|\bm{W}\|^{2}\|\bm{X}_{i}\|^{3}\right).\] (6)

We now introduce a convex hard-margin SVM problem that separates one token of the input sequence from the rest, jointly solved over all inputs. We will show that this problem captures the optimization properties of softmax-attention. Fix indices \(\bm{\alpha}=(\alpha_{i})_{i=1}^{n}\) and consider

\[\boxed{\bm{p}^{mm}(\bm{\alpha})=\arg\min_{\bm{p}}\|\bm{p}\|\quad\text{subject to}\quad\min_{\bm{p}\neq\alpha_{i}}\ \bm{p}^{\top}(\bm{k}_{i\alpha_{i}}-\bm{k}_{i})\geq 1,\ \text{ for all}\quad 1\leq i\leq n.\ \ \text{(ATT-SVM)}}\]

Note that existence of \(\bm{p}^{mm}(\bm{\alpha})\) implies the separability of tokens \(\bm{\alpha}\) from the others. Specifically, choosing direction \(\bm{p}^{mm}(\bm{\alpha})\) will exactly select tokens \((\bm{x}_{i\alpha_{i}})_{i=1}^{n}\) at the attention output for each input sequence, that is, \(\lim_{R\rightarrow\infty}\bm{X}_{i}^{\top}\mathbb{S}(R\cdot\bm{K}_{i}\bm{p}^{ mm}(\bm{\alpha}))=\bm{x}_{i\alpha_{i}}\). We are now ready to introduce our main results that characterize the global and local convergence of the attention weights \(\bm{p}\) via (ATT-SVM).

### Global convergence of the attention weights \(\bm{p}\)

We first identify the conditions that guarantee the global convergence of gradient descent for \(\bm{p}\). The intuition is that, in order for attention to exhibit implicit bias, the softmax nonlinearity should be forced to select the _optimal token within each input sequence_. Fortunately, the optimal tokens that achieve the smallest training objective under decreasing loss function \(\ell(\cdot)\) have a clear definition.

**Definition 1** (Token Scores, Optimality & GM): _The score of token \(\bm{x}_{i}\) of input \(\bm{X}_{i}\) is defined as \(\bm{\gamma}_{it}:=Y_{i}\cdot\bm{v}^{\top}\bm{x}_{it}\). The optimal tokens for input \(\bm{X}_{i}\) are those tokens with highest scores given by_

\[\mathsf{opt}_{i}\in\arg\max_{t\in[T]}\bm{\gamma}_{it}.\]

_Globally-optimal max-margin (GM) direction is defined as the solution of (ATT-SVM) with optimal indices \((\mathsf{opt}_{i})_{i=1}^{n}\) by \(\bm{p}^{mm\star}\)._

It is worth noting that score definition simply uses the _value embeddings_\(\bm{v}^{\top}\bm{x}_{it}\) of the tokens. Note that multiple tokens within an input might attain the same score, thus \(\mathsf{opt}_{i}\) or \(\bm{p}^{mm\star}\) may not be unique. The theorem below provides our regularization path guarantee on the global convergence of attention.

**Theorem 1** (Regularization Path): _Suppose Assumption A on the loss function holds, and for all \(i\in[n]\) and \(t\neq\mathsf{opt}_{i}\), the scores obey \(\bm{\gamma}_{it}<\bm{\gamma}_{i\mathsf{opt}_{i}}\). Then, the regularization path \(\tilde{\bm{p}}(R)=\arg\min_{\|\bm{p}\|\leq R}\mathcal{L}(\bm{p})\) converges to the GM direction i.e. \(\lim_{R\rightarrow\infty}\tilde{\bm{p}}(R)/R=\bm{p}^{mm\star}/\|\bm{p}^{mm\star}\|\)._

Theorem 1 shows that as the regularization strength \(R\) increases towards the ridgeless problem \(\min_{\bm{p}}\mathcal{L}(\bm{p})\), the optimal direction \(\tilde{\bm{p}}(R)\) aligns more closely with the max-margin solution \(\bm{p}^{mm\star}\). Since this theorem allows for arbitrary token scores, it demonstrates that _max-margin token separation is an essential feature of the attention mechanism_. In fact, it is a corollary of Theorem 8, which applies to the generalized model \(f(\bm{X})=\psi(\bm{X}^{\top}\mathbb{S}(\bm{X}\bm{W}^{\top}\bm{p}))\) and accommodates multiple optimal tokens per input. However, while regularization path analysis captures the global behavior, gradient descent lacks general global convergence guarantees. In Section 2.2, we show that due to the nonconvex landscape and softmax nonlinearity, gradient descent often converges to local optima. We first establish that when (ERM) is trained with gradient descent, the norm of the parameters will diverge. For the restrictive setting of \(n=1\), gradient descent also exhibits a global convergence guarantee.

**Assumption B**: _For all \(i\in[n]\) and \(t,\tau\neq\mathsf{opt}_{i}\), the scores per Definition 1 obey \(\bm{\gamma}_{it}=\bm{\gamma}_{it}<\bm{\gamma}_{iopt_{i}}\)._

**Theorem 2** (Global Convergence of Gradient Descent): _Suppose Assumption \(A\) on the loss function \(\ell\) and Assumption \(B\) on the tokens' score hold. Then, the gradient descent iterates \(\bm{p}(t+1)=\bm{p}(t)-\eta\nabla\mathcal{L}(\bm{p}(t))\) on (ERM), with the stepsize \(\eta\leq 1/L_{p}\) and any starting point \(\bm{p}(0)\) satisfy \(\lim_{t\to\infty}\|\bm{p}(t)\|=\infty\). If \(n=1\), we also have \(\lim_{t\to\infty}\bm{p}(t)/\|\bm{p}(t)\|=\bm{p}^{\text{mm}\star}/\|\bm{p}^{ \text{mm}\star}\|\)._

Theorem 2 shows that gradient descent will diverge in norm, and when \(n=1\), the normalized predictor \(\bm{p}(t)/\|\bm{p}(t)\|\) converges towards \(\bm{p}^{\text{mm}\star}\), the separator of the globally optimal token. While \(n=1\) is a stringent condition, this requirement is in fact tight as discussed in Appendix E. To illustrate this theorem, we have conducted synthetic experiments. Let us first explain the setup used in Figure 1. We set \(d=3\) as the dimension, with each token having three entries \(\bm{x}=[x_{1},x_{2},x_{3}]\). We reserve the first two coordinates as key embeddings \(\bm{k}=[x_{1},x_{2},0]\) by setting \(\bm{W}=\text{diag}([1,1,0])\). This is what we display in our figures as token positions. Finally, in order to assign scores to the tokens we use the last coordinate by setting \(\bm{v}=[0,0,1]\). This way score becomes \(Y\cdot\bm{v}^{\top}\bm{x}=Y\cdot x_{3}\), allowing us to assign any score (regardless of key embedding).

In Figure 1(a), the gray paths represent gradient descent trajectories from different initializations. The points \((0,0)\) and \((1,0)\) correspond to non-optimal tokens, while the point \((-0.1,1)\) represents the optimal token. Notably, gradient descent iterates with various starting points converge towards the direction of the max-margin solution \(\bm{p}^{\text{mm}\star}\) (depicted by - - -). Moreover, as the iteration count \(t\) increases, the inner product \(\langle\bm{p}(t)/\|\bm{p}(t)\|,\bm{p}^{\text{mm}\star}/\|\bm{p}^{\text{mm} \star}\|\rangle\) consistently increases. Figure 1(c) also depicts the directional convergence of gradient descent from various initializations on multiple inputs, with the gray dotted line representing the separating hyperplane. These emphasize the gradual alignment between the evolving predictor and the max-margin solution throughout the optimization.

**Lemma 2**: _Suppose for all \(i\in[n]\) and \(t\neq\mathsf{opt}_{i}\), \(Y_{i}=1\) and \(\bm{\gamma}_{it}<\bm{\gamma}_{iopt_{i}}\). Also assume \(\bm{W}\in\mathbb{R}^{d\times d}\) is full-rank. Then \(\bm{p}^{\text{mm}\star}\) exists - i.e. (ATT-SVM) is feasible for optimal indices \(\alpha_{i}\leftarrow\mathsf{opt}_{i}\)._

### Local convergence of the attention weights \(\bm{p}\)

Theorem 2 on the global convergence of gradient descent serves as a prelude to the general behavior of the optimization. Once we relax Assumption B by allowing for arbitrary token scores, we will show that \(\bm{p}\) can converge (in direction) to a locally-optimal solution. However, this locally-optimal solution is still characterized in terms of (ATT-SVM) which separates _locally-optimal_ tokens from the rest. Our theory builds on two new concepts: locally-optimal tokens and neighbors of these tokens.

**Definition 2** (SVM-Neighbor and Locally-Optimal Tokens): _Fix token indices \(\bm{\alpha}=(\alpha_{i})_{i=1}^{n}\) for which (ATT-SVM) is feasible to obtain \(\bm{p}^{\text{mm}}=\bm{p}^{\text{mm}}(\bm{\alpha})\). Consider tokens \(\mathcal{T}_{i}\subset[T]\) such that \((k_{i\alpha_{i}}-k_{i})^{\top}\bm{p}^{\text{mm}}=1\) for all \(t\in\mathcal{T}_{i}\). We refer to \(\mathcal{T}_{i}\) as SVM-neighbors of \(\bm{k}_{i\alpha_{i}}\). Additionally, tokens with indices \(\bm{\alpha}=(\alpha_{i})_{i=1}^{n}\) are called locally-optimal if for all \(i\in[n]\) and \(t\in\mathcal{T}_{i}\) scores per Definition 1 obey \(\bm{\gamma}_{i\alpha_{i}}>\bm{\gamma}_{it}\). Associated \(\bm{p}^{\text{mm}}\) is called a locally-optimal max-margin (LIM) direction._

To provide a basis for discussing local convergence, we provide some preliminary definitions regarding cones. For a given \(\bm{q}\) and a scalar \(\mu>0\), we define \(\mathsf{cone}_{\mu}(\bm{q})\) as the set of vectors \(\bm{p}\in\mathbb{R}^{d}\) such that the correlation coefficient between \(\bm{p}\) and \(\bm{q}\) is at least \(1-\mu\) :

\[\mathsf{cone}_{\mu}(\bm{q}):=\left\{\bm{p}\in\mathbb{R}^{d}\;\middle|\;\left\langle \frac{\bm{p}}{\|\bm{p}\|}\cdot\frac{\bm{q}}{\|\bm{q}\|}\right\rangle\geq 1-\mu \right\}.\] (7)

Given \(R>0\), the intersection of \(\mathsf{cone}_{\mu}(\bm{q})\) and the set \(\{\bm{p}\in\mathbb{R}^{d}\;\middle|\;\middle|\bm{p}\|\geq R\}\) is denoted as \(\mathcal{C}_{\mu,R}(\bm{q})\):

\[\mathcal{C}_{\mu,R}(\bm{q}):=\mathsf{cone}_{\mu}(\bm{q})\cap\left\{\bm{p}\in \mathbb{R}^{d}\;\middle|\;\middle|\bm{p}\|\geq R\right\}.\] (8)

Figure 2: Gradient descent initialization \(\bm{p}(0)\) inside the cone containing the locally-optimal solution \(\bm{p}^{\text{mm}}\).

Next, we demonstrate the existence of parameters \(\mu=\mu(\bm{\alpha})>0\) and \(R>0\) such that when \(R\) is sufficiently large, there are no stationary points within \(\mathcal{C}_{\mu,R}(\bm{p}^{\text{mm}})\). Further, the gradient descent initialized within \(\mathcal{C}_{\mu,R}(\bm{p}^{\text{mm}})\) converges in direction to \(\bm{p}^{\text{mm}}/\|\bm{p}^{\text{mm}}\|\); refer to Figure 2 for a visualization.

**Theorem 3** (Local Convergence of Gradient Descent): _Suppose Assumption 1 on the loss function \(\ell\) holds and assume \(\bm{\alpha}=(\alpha_{i})_{i=1}^{n}\) are indices of locally-optimal tokens per Definition 2. Then, there is a constant \(\mu=\mu(\bm{\alpha})\in(0,1)\) and \(R>0\) such that \(\mathcal{C}_{\mu,R}(\bm{p}^{\text{mm}})\) does not contain any stationary points. Further, for any starting point \(\bm{p}(0)\in\mathcal{C}_{\mu,R}(\bm{p}^{\text{mm}})\), gradient descent iterates \(\bm{p}(t+1)=\bm{p}(t)-\eta\nabla\mathcal{L}(\bm{p}(t))\) on (_ERM_) with stepsize \(\eta\leq 1/L_{p}\) satisfies \(\lim_{t\to\infty}\|\bm{p}(t)\|=\infty\) and \(\lim_{t\to\infty}\bm{p}(t)/\|\bm{p}(t)\|=\bm{p}^{\text{mm}}/\|\bm{p}^{\text{ mm}}\|\)._

To further illustrate Theorem 3, we can consider Figure 1(b) where \(n=1\) and \(T=3\). In this figure, the point \((0,0)\) represents the non-optimal tokens, while \((1,0)\) represents the locally optimal token. Additionally, the gray paths represent the trajectories of gradient descent initiated from different points. By observing the figure, we can see that gradient descent, when properly initialized, converges towards the direction of \(\bm{p}^{\text{mm}}\) (depicted by - - -). This direction of convergence effectively separates the locally optimal tokens \((1,0)\) from the non-optimal token \((0,0)\).

### Regularization paths can only converge to locally-optimal max-margin directions

An important question arises regarding whether our definition of LMM (Definition 2) encompasses all possible convergence paths of the attention mechanism when \(\|\bm{p}\|\to\infty\). To address this, we introduce the set of LMM directions as follows:

\[\bm{p}^{\text{mm}}:=\left\{\frac{\bm{p}^{\text{mm}}(\bm{\alpha})}{\|\bm{p}^{ \text{mm}}(\bm{\alpha})\|}\ \middle|\ \bm{\alpha}\text{ is locally-optimal per Definition 2}\right\}.\]

The following theorem establishes the tightness of these directions: It demonstrates that for any candidate \(\bm{q}\notin\mathcal{P}^{\text{mm}}\), its local regularization path within an arbitrarily small neighborhood will provably not converge in the direction of \(\bm{q}\).

**Theorem 4**: _Fix \(\bm{q}\notin\mathcal{P}^{\text{mm}}\) with unit \(\ell_{2}\) norm. Assume that token scores are distinct (namely \(\bm{\gamma}_{it}\neq\bm{\gamma}_{ir}\) for \(t\neq\tau\)) and key embeddings \(\bm{k}_{it}\) are in general position (see Theorem 7). Fix arbitrary \(\epsilon>0,R_{0}>0\). Define the local regularization path of \(\bm{q}\) as its \((\epsilon,R_{0})\)-conic neighborhood:_

\[\bm{\tilde{p}}(R)=\operatorname*{arg\,min}_{\bm{p}\in\mathcal{C}_{\epsilon,R_ {0}}(\bm{q})\|\bm{p}\|\leq R}\mathcal{L}(\bm{p}),\ \ \text{where}\ \ \ \mathcal{C}_{\epsilon,R_{0}}(\bm{q})=\bm{\text{con}}\bm{e}_{\epsilon}(\bm{q}) \cap\left\{\bm{p}\in\mathbb{R}^{d}\middle|\|\bm{p}\|\geq R_{0}\right|.\] (9)

_Then, either \(\lim_{R\to\infty}\|\bm{\tilde{p}}(R)\|<\infty\) or \(\lim_{R\to\infty}\bm{\tilde{p}}(R)/\|\bm{\tilde{p}}(R)\|\neq\bm{q}\). In both scenarios \(\lim_{R\to\infty}\bm{\tilde{p}}(R)/R\neq\bm{q}\)._

The result above nicely complements Theorem 3, which states that when gradient descent is initialized above a threshold (\(\|\bm{p}(0)\|\geq R_{0}\)) in an LMM direction, \(\|\bm{p}(t)\|\) diverges but the direction converges to LMM. In contrast, Theorem 4 shows that regardless of how small the cone is (in terms of angle and norm lower bound \(\|\bm{p}\|\geq R_{0}\)), the optimal solution path will not converge along \(\bm{q}\notin\mathcal{P}^{\text{mm}}\).

## 3 Joint Convergence of Head \(\bm{v}\) and Attention Weights \(\bm{p}\)

In this section, we extend the preceding results to the general case of joint optimization of head \(\bm{v}\) and attention weights \(\bm{p}\) using a logistic loss function. To this aim, we focus on regularization path analysis, which involves solving (ERM) under ridge constraints and examining the solution trajectory as the constraints are relaxed.

**High-level intuition.** Since the prediction is linear as a function of \(\bm{v}\), logistic regression in \(\bm{v}\) can exhibit its own implicit bias to a max-margin solution. Concretely, define the attention features \(\bm{x}_{i}^{\bm{p}}=\bm{X}_{i}^{\top}\mathbb{S}(\bm{K}_{i}\bm{p})\) and define the dataset \(\mathcal{D}^{\bm{p}}=(Y_{i},\bm{x}_{i}^{\bm{p}})_{i=1}^{n}\). If this dataset \(\mathcal{D}^{\bm{p}}\) is linearly separable, then fixing \(\bm{p}\) and optimizing only \(\bm{v}\) will converge in the direction of the standard max-margin classifier

\[\bm{v}^{\text{mm}}=\operatorname*{arg\,min}_{\bm{v}\in\mathbb{R}^{d}}\|\bm{v} \|\ \ \ \text{subject to}\ \ \ Y_{i}\cdot\bm{v}^{\top}\bm{r}_{i}\geq 1,\ \ \text{for all}\ \ \ 1\leq i\leq n,\] (SVM)

after setting inputs to the attention features \(\bm{r}_{i}\leftarrow\bm{x}_{i}^{\bm{p}}\)[22]. This motivates a clear question:

_Under what conditions, optimizing \(\bm{v}\), \(\bm{p}\) jointly will converge to their respective max-margin solutions?_

We study this question in two steps. Loosely speaking: **(1)** We will first assume that, at the optimal tokens \(\bm{x}_{i_{\alpha}},i\in[n]\) selected by \(\bm{p}\), when solving (SVM) with \(\bm{r}_{i}\leftarrow\bm{x}_{i_{\alpha}}\), all of these tokens become support vectors of (SVM). **(2)** We will then relax this condition to uncover a more general implicit bias for \(\bm{p}\) that distinguish support vs non-support vectors. Throughout, we assume that the joint problem is separable and there exists \((\bm{v},\bm{p})\) asymptotically achieving zero training loss.

### When all attention features are support vectors

In (SVM), define _label margin_ to be \(1/\|\bm{v}^{\text{mm}}\|\). Our first insight in quantifying the joint implicit bias is that, **optimal tokens** admit a natural definition: _Those that maximize the downstream label margin when selected._ This is formalized below where we assume that: (1) Selecting the token indices \(\bm{\alpha}=(\alpha_{i})_{i=1}^{n}\) from each input data achieves the largest label margin. (2) The optimality of the \(\bm{\alpha}\) choice is strict in the sense that mixing other tokens will shrink the label margin in (SVM).

**Assumption C (Optimal Tokens)**: _Let \(\Gamma>0\) be the label margin when solving (SVM) with \(\bm{r}_{i}\leftarrow\bm{x}_{i\alpha_{i}}\). There exists \(\nu>0\) such that for all \(\bm{p}\), solving (SVM) with \(\bm{r}_{i}\leftarrow\bm{x}_{i}^{\bm{p}}\) results in a label margin of at most \(\Gamma-\nu\cdot\max_{i\in[n]}(1-\bm{s}_{i\alpha_{i}})\) where \(\bm{s}_{i}=\mathbb{S}(\bm{K}_{i}\bm{p})\)._

**Example:** To gain intuition, let us fix \(\bm{a}\in\mathbb{R}^{d}\) and consider the dataset obeying \(\bm{x}_{i1}=Y_{i}\cdot\bm{a}\) and \(\|\bm{x}_{i1}\|<\|\bm{a}\|\) for all \(t\geq 2\) and all \(i\in[n]\). For this dataset, we can choose \(\alpha_{i}=1\), \(\bm{v}^{\text{mm}}=\bm{a}/\|\bm{a}\|^{2}\), \(\Gamma=1/\|\bm{v}^{\text{mm}}\|=\|\bm{a}\|\) and \(\nu=\|\bm{a}\|-\sup_{i\in[n],t\geq 2}\|\bm{x}_{i1}\|\).

**Theorem 5**: _Consider the ridge-constrained solutions \((\bm{v}_{r},\bm{p}_{R})\) of (ERM) defined as_

\[(\bm{v}_{r},\bm{p}_{R})=\operatorname*{arg\,min}_{\|\bm{v}\|\leq \mathcal{E},\|\bm{p}\|\leq R}\mathcal{L}(\bm{v},\bm{p}).\]

_Suppose there are token indices \(\bm{\alpha}=(\alpha_{i})_{i=1}^{n}\) for which \(\|\bm{p}^{\text{mm}}(\bm{\alpha})\|\) exists (ATT-SVM is feasible) and Assumption C holds for some \(\Gamma,\nu>0\). Then, \(\lim_{\bm{\alpha}\rightarrow\infty}\bm{p}_{R}/R=\bm{p}^{\text{mm}}/\|\bm{p}^ {\text{mm}}\|\), where \(\bm{p}^{\text{mm}}\) is the solution of (ATT-SVM); and \(\lim_{r\rightarrow\infty}\bm{v}_{r}/r=\bm{v}^{\text{mm}}/\|\bm{v}^{\text{mm}}\|\), where \(\bm{v}^{\text{mm}}\) is the solution of (SVM) with \(\bm{r}_{i}=\bm{x}_{i\alpha_{i}}\)._

As further discussion, consider Figure 3(a) where we set \(n=3,T=d=2\) and \(\bm{W}=\text{Identity}\). All three inputs share the point \((0,0)\) which corresponds to their non-optimal tokens. The optimal tokens (denoted by \(\star\)) are all support vectors of the (SVM) since \(\bm{v}^{\text{mm}}=[0,1]\) is the optimal classifier direction (depicted by - - -). Because of this, \(\bm{p}^{\text{mm}}\) will separate optimal \(\star\) tokens from tokens at the \((0,0)\) coordinate via (ATT-SVM) and its direction is dictated by yellow and teal colored \(\star\)s which are the support vectors.

### General solution when selecting one token per input

Can we relax Assumption C, and if so, what is the resulting behavior? Consider the scenario where the optimal \(\bm{p}\) diverges to \(\infty\) and ends up selecting one token per input. Suppose this \(\bm{p}\) selects some coordinates \(\bm{\alpha}=(\alpha_{i})_{i=1}^{n}\). Let \(\mathcal{S}\subset[n]\) be the set of indices where the associated token \(\bm{x}_{i\alpha_{i}}\) is a support vector when solving (SVM). Set \(\bar{\mathcal{S}}=[n]-\mathcal{S}\). Our intuition is as follows: Even if we slightly perturb this \(\bm{p}\) choice and mix other tokens \(t\neq\alpha_{i}\) over the input set \(\bar{\mathcal{S}}\subset[n]\), since \(\bar{\mathcal{S}}\) is not support vector for (SVM), we can preserve the label margin (by only preserving the support vectors \(\mathcal{S}\)). This means that \(\bm{p}\) may not have to enforce _max-margin_ constraint over inputs \(i\in\bar{\mathcal{S}}\), instead, it suffices to just select

Figure 3: **(a)** and **(b)** Joint convergence of attention weights \(\bm{p}\) (——) and classifier head \(\bm{v}\) (——) to max-margin directions. **(c)** Averaged softmax probability evolution of optimal tokens and logistic probability evolution of output in **(a)**.

these tokens (asymptotically). This results in the following **relaxed SVM** problem:

\[\bm{p}^{\text{relax}}=\arg\min_{\bm{p}}\|\bm{p}\|\quad\text{such that}\quad\bm{p}^{\top}(\bm{k}_{i_{\alpha_{i}}}-\bm{k}_{it})\geq\begin{cases}1&\text{for all}\quad t\neq\alpha_{i},\ i\in\mathcal{S}\\ 0&\text{for all}\quad t\neq\alpha_{i},\ i\in\bar{\mathcal{S}}\end{cases}\quad.\] (10)

Here, \(\bm{p}^{\top}(\bm{k}_{i_{\alpha_{i}}}-\bm{k}_{it})\geq 0\) corresponds to the _selection_ idea. Building on this intuition, the following theorem captures the generalized behavior of the joint regularization path.

**Theorem 6**: _Consider the same (ERM) problem as discussed in Theorem 5. Suppose \(\mathbb{S}(\bm{K}_{i}\bm{p}_{R})_{\alpha_{i}}\to 1\), i.e., the tokens \((\alpha_{i})_{i=1}^{n}\) are asymptotically selected. Let \(\bm{v}^{\text{mm}}\) be the solution of (SVM) with \(\bm{r}_{i}=\bm{x}_{i_{\alpha_{i}}}\) and \(\mathcal{S}\) be its set of support vector indices. Suppose Assumption C holds over \(\mathcal{S}\) i.e. having \(\bm{s}_{i_{\alpha_{i}}}<1\) shrinks the margin when (SVM) is only solved over \(\mathcal{S}\subset[n]\). Then, \(\lim_{r\to\infty}\bm{v}_{r}/r=\bm{v}^{\text{mm}}/\|\bm{v}^{\text{mm}}\|\) and \(\lim_{R\to\infty}\bm{p}_{R}/R=\bm{p}^{\text{relax}}/\|\bm{p}^{\text{relax}}\|\), where \(\bm{p}^{\text{relax}}\) is the solution of (10) with \((\alpha_{i})_{i=1}^{n}\) choices._

To illustrate this numerically, consider Figure 2(b) which modifies Figure 2(a) by pushing the yellow \(\star\) to the northern position \((0.5,1.5)\). We still have \(\bm{v}^{\text{mm}}=[0,1]\) however the yellow \(\star\) is no longer a support vector of (SVM). Thus, \(\bm{p}\) solves the relaxed problem (10) which separates green and teal \(\star\)'s by enforcing the max-margin constraint on \(\bm{p}\) (which is the red direction). Instead, yellow \(\star\) only needs to achieve positive correlation with \(\bm{p}\) (unlike Figure 2(a) where it dictates the direction). We also display the direction of \(\bm{p}^{\text{mm}}\) using a gray dashed line.

We further investigate the evolution of softmax and logistic output probabilities throughout the training process of Figure 2(a), and the results are illustrated in Figure 2(c). The averaged softmax probability of optimal tokens is represented by the red curve and is calculated as \(\frac{1}{n}\sum_{i=1}^{n}\max_{t\in[T]}\mathbb{S}(\bm{K}_{i}\bm{p})_{t}\). An achievement of 1 for this probability indicates that the attention mechanism successfully selects the optimal tokens. On the other hand, the logistic probability of the output is represented by the blue curve and is determined by \(1/n\sum_{i=1}^{n}1/(1+e^{-\tilde{\bm{Y}}_{i}\cdot f(\bm{X}_{i})})\). This probability also reaches a value of 1, suggesting that the inputs are correctly classified.

## 4 Experiments

**Sparsity of softmax and evolution of attention weights.** It is well known that, in practice, attention maps often exhibit sparsity and highlight salient tokens that aid inference. Our results provide a formal explanation of this when tokens are separable: Since attention selects a locally-optimal token within the input sequence and suppresses the rest, the associated attention map \(\mathbb{S}(\bm{X}\bm{p})\) will (eventually) be a sparse vector. Additionally, the sparsity should arise in tandem with the increasing norm of attention weights. We provide empirical evidence to support these findings.

_Synthetic experiments._ Figures 3(a) and 3(b) show the evolution of the largest softmax probability and attention weights over time when using either normalized gradient or a fixed stepsize \(\eta\) for training. The dataset model follows Figure 2(c). The softmax probability shown in Figure 3(a) is defined as \(\frac{1}{n}\sum_{i=1}^{n}\max_{t\in[T]}\mathbb{S}(\bm{K}_{i}\bm{p})_{t}\). When this average probability reaches the value of 1, it means attention selects only a single token per input. The attention norm in Figure 3(b), is simply equal to \(\|\bm{p}\|\).

The red curves in both figures represent the normalized gradient method, which updates the model parameters \(\bm{p}\) using \(\bm{p}(t+1)=\bm{p}(t)-\eta\nabla\mathcal{L}(\bm{p}(t))/\|\nabla\mathcal{L}( \bm{p}(t))\|\) with \(\eta=0.1\). The blue curves correspond to gradient descent with constant learning rate given by \(\bm{p}(t+1)=\bm{p}(t)-\eta\nabla\mathcal{L}(\bm{p}(t))\) with \(\eta=1\). Observe that the normalized gradient method achieves a softmax probability of 1 quicker as vanilla GD suffers from vanishing gradients. This is visible in Figure 4(b) where blue norm curve levels off.

_Real experiments._ To study softmax sparsity and the evolution of attention weights throughout training, we train a vision transformer (ViT-base) model [23] from scratch, utilizing the CIFAR-10 dataset [24] for 400 epochs with fixed learning rate \(3\times 10^{-3}\). ViT tokenizes an image into \(16\times 16\) patches, thus, its softmax attention maps can be easily visualized. We examine the average attention map - associated with the [CLS] token - computed from all 12 attention heads within the model. Figure 6 provides a visual representation of the resulting attention weights (\(16\times 16\) grids) corresponding to the original patch locations within the image. During the initial epochs of training, the attention weights are randomly distributed and exhibit a dense pattern. However, as the training progresses, the attention map gradually becomes sparser and the attention mechanism begins to concentrate on fewer salient patches within the image that possess distinct features that aid classification. This illustrates the evolution of attention from a random initial state to a more focused and sparse representation. These salient patches highlighted by attention conceptually corresponds to the optimal tokens within our theory.

We quantify the sparsity of the attention map via a soft-sparsity measure, denoted by \(\overline{\text{nnz}}(\bm{s})\) where \(\bm{s}\) is the softmax probability vector. The soft-sparsity is computed as the ratio of the \(\ell_{1}\)-norm to the squared \(\ell_{2}\)-norm, defined as \(\overline{\text{nnz}}(\bm{s})=\|\bm{s}\|_{1}/\|\bm{s}\|^{2}\). \(\overline{\text{nnz}}(\bm{s})\) takes values between 1 to \(T=256\) and a smaller value indicates a sparser vector. Also note that \(\|\bm{s}\|_{1}=\sum_{t=1}^{T}\bm{s}_{t}=1\). Together with sparsity, Figure 7 also displays the Frobenius norm of the combined key-query matrix \(\bm{W}\) of the last attention layer over epochs. The theory suggests that the increase in sparsity is associated with the growth of attention weights - which converge directionally. The results in Figure 7 align with the theory, demonstrating the progressive sparsification of the attention map as \(\|\bm{W}\|_{F}\) grows.

**Transient optimization dynamics and the influence of the loss function.** Theorem 2 shows that the asymptotic direction of gradient descent is determined by \(\bm{p}^{\text{nnz}}\). However, it is worth noting that transient dynamics can exhibit bias towards certain input examples and their associated optimal tokens. We illustrate this idea in Fig 5(a), which displays the trajectories of the gradients for different scores and loss functions. We consider two optimal tokens (\(\star\)) with scores \(\bm{\gamma}_{1}=1\) and \(\bm{\gamma}_{2}=C\), where \(C\) varies. For our analysis, we examine the correlation loss \(\ell(x)=-x\) and the logistic loss \(\ell(x)=\log(1+e^{-x})\).

In essence, as \(C\) increases, we can observe that the correlation loss \(\ell(x)=-x\) exhibits a bias towards the token with a high score, while the logistic loss is biased towards the token with a low score. The underlying reason for this behavior can be observed from the gradients of individual inputs: \(\nabla\mathcal{L}_{i}(\bm{p})=\ell_{i}^{\prime}\cdot\bm{K}_{i}^{\top}\mathbb{ S}^{\prime}(\bm{X}\bm{p})\bm{X}\bm{v}\), where \(\mathbb{S}^{\prime}(\cdot)\) represents the derivative of the softmax function and \(\ell_{i}^{\prime}:=\ell^{\prime}(Y_{i}\cdot\bm{v}^{\top}\bm{X}_{i}^{\top}\mathbb{ S}(\bm{X}_{i}\bm{p}))\). Assuming that \(\bm{p}\) (approximately) selects the optimal tokens, this

Figure 6: Illustration of the progressive change in attention weights of the [CLS] token during training in the transformer model, using a specific input image shown in Figure 6(a).

Figure 7: Red curve is the sparsity level \(\overline{\text{nnz}}(\bm{s})/T\) of the average attention map which takes values on [0,1]. A sparser vector implies that few key tokens receive significantly higher attention, while the majority of the tokens receive minimal attention. Blue curve is the Frobenius norm of attention weights \(\|\bm{W}\|_{F}\) of the final layer. We display their evolutions over epochs.

simplifies to \(\ell^{\prime}_{i}\approx\ell^{\prime}(\bm{\gamma}_{i})\) and \(\|\bm{\nabla}\mathcal{L}_{i}(\bm{p})\|\propto|\ell^{\prime}(\bm{\gamma}_{i})| \cdot\bm{\gamma}_{i}\). With the correlation loss, \(|\ell^{\prime}|=1\), resulting in \(\|\bm{\nabla}\mathcal{L}_{i}(\bm{p})\|\propto\bm{\gamma}_{i}\), meaning that a larger score induces a larger gradient. On the other hand, the logistic loss behaves similarly to the exponential loss under separable data, i.e., \(|\ell^{\prime}|=e^{-x}/(1+e^{-x})\approx e^{-x}\). Consequently, \(\|\bm{\nabla}\mathcal{L}_{i}(\bm{p})\|\propto\bm{\gamma}_{i}e^{-\bm{\gamma}_{ i}}\approx e^{-\bm{\gamma}_{i}}\), indicating that a smaller score leads to a larger gradient. These observations explain the empirical behavior we observe.

## 5 Related Work

**Implicit Regularization.** The implicit bias of gradient descent in classification tasks involving separable data has been extensively examined by [22; 25; 26; 27; 28; 29]. These works typically use logistic loss or, more generally, exponentially-tailed losses to make connections to margin maximization. These results are also extended to non-separable data by [30; 31; 21]. Furthermore, there have been notable investigations into the implicit bias in regression problems/losses utilizing techniques such as mirror descent [32; 25; 33; 34; 35; 36]. In addition, several papers have explored the implicit bias of stochastic gradient descent [37; 38; 39; 40; 41; 42], as well as adaptive and momentum-based methods [43; 44; 45; 46]. Although there are similarities between our optimization approach for \(\bm{v}\) and existing works, the optimization of \(\bm{p}\) stands out as significantly different. Firstly, our optimization problem is nonconvex, introducing new challenges and complexities. Secondly, it necessitates the introduction of novel concepts such as locally-optimal tokens and requires a fresh analysis specifically tailored to the cones surrounding them.

**Attention Mechanism.** Transformers, introduced by [6], revolutionized the field of NLP and machine translation, with earlier works on self-attention by [47; 48; 49; 50]. Self-attention differs from traditional models like MLPs and CNNs by leveraging global interactions for feature representations, showing exceptional empirical performance. However, the underlying mechanisms and learning processes of the attention layer remain unknown. Recent studies such as [51; 52; 53; 54; 23] have focused on specific aspects like representing sparse functions, convex-relaxations, and expressive power. In contrast to our nonconvex (ERM), [52] studies self-attention with linear activation instead of softmax, while [53] approximates softmax using a linear operation with unit simplex constraints. Their main objective is to derive convex reformulations for ERM-based training problem. [55; 56] have developed initial results to characterize the optimization and generalization dynamics of attention. [17] is another closely related work where the authors analyze the same attention model (ERM) as us. Specifically, they jointly optimize \(\bm{v},\bm{p}\) for three gradient iterations for a contextual dataset model. However, all of these works make stringent assumptions on the data, namely, tokens are tightly clusterable or can be clearly split into clear relevant and irrelevant sets. Additionally [56] requires assumptions on initialization and [55] considers a simplified attention structure where the attention matrix is not directly parameterized with respect to the input. Our work links attention models to hard-margin SVM problems and pioneers the study of gradient descent's implicit bias in these models.

## 6 Discussion

We have provided a thorough optimization-theoretic characterization of the fundamental attention model \(f(\bm{X})=\bm{v}^{\top}\bm{X}^{\top}\mathbb{S}(\bm{X}\bm{W}\bm{p})\) by formally connecting it to max-margin problems. We first established the convergence of gradient descent on \(\bm{p}\) (or equivalently \(\bm{W}\)) in isolation. We also explored joint convergence of \((\bm{v},\bm{p})\) via regularization path which revealed surprising implicit biases such as (10). These findings motivate several exciting avenues for future research. An immediate open problem is characterizing the (local) convergence of gradient descent for joint optimization of \((\bm{v},\bm{p})\). Another major direction is to extend similar analysis to study self-attention layer (4) or to allow for multiple tunable tokens (where \(\bm{p}\) becomes a matrix). Either setting will enrich the problem by allowing the attention to discover multiple hyperplanes to separate tokens. While our convergence guarantees apply when tokens are separable, it would be interesting to characterize the non-separable geometry by leveraging results developed for logistic regression analysis [31; 22]. Ideas from such earlier results can also be useful for characterizing the non-asymptotic/transient dynamics of how gradient descent aligns with the max-margin direction. Overall, we believe that max-margin token selection is a fundamental characteristic of attention mechanism and the theory developed in this work lays the groundwork of these future extensions.

## Acknowledgements

This work was supported by the NSF grants CCF-2046816 and CCF-2212426, Google Research Scholar award, and Army Research Office grant W911NF2110312.

The authors express their gratitude for the valuable feedback provided by the anonymous reviewers and Christos Thrampoulidis, which has significantly improved this paper.

## References

* [1] Dzmitry Bahdanau, Kyunghyun Cho, and Yoshua Bengio. Neural machine translation by jointly learning to align and translate. _The International Conference on Learning Representations_, 2015.
* [2] Tom Brown, Benjamin Mann, Nick Ryder, Melanie Subbiah, Jared D Kaplan, Prafulla Dhariwal, Arvind Neelakantan, Pranav Shyam, Girish Sastry, Amanda Askell, and et al. Language models are few-shot learners. In _Advances in neural information processing systems_, volume 33, pages 1877-1901, 2020.
* [3] Mark Chen, Jerry Tworek, Heewoo Jun, Qiming Yuan, Henrique Ponde de Oliveira Pinto, Jared Kaplan, Harri Edwards, Yuri Burda, Nicholas Joseph, Greg Brockman, et al. Evaluating large language models trained on code. _arXiv preprint arXiv:2107.03374_, 2021.
* [4] Alec Radford, Jeffrey Wu, Rewon Child, David Luan, Dario Amodei, Ilya Sutskever, et al. Language models are unsupervised multitask learners. _OpenAI blog_, 1(8):9, 2019.
* [5] Aakanksha Chowdery, Sharan Narang, Jacob Devlin, Maarten Bosma, Gaurav Mishra, Adam Roberts, Paul Barham, Hyung Won Chung, Charles Sutton, Sebastian Gehrmann, et al. Palm: Scaling language modeling with pathways. _arXiv preprint arXiv:2204.02311_, 2022.
* [6] Ashish Vaswani, Noam Shazeer, Niki Parmar, Jakob Uszkoreit, Llion Jones, Aidan N Gomez, Lukasz Kaiser, and Illia Polosukhin. Attention is all you need. In _Advances in neural information processing systems_, volume 30, 2017.
* [7] Jacob Devlin, Ming-Wei Chang, Kenton Lee, and Kristina Toutanova. BERT: Pre-training of deep bidirectional transformers for language understanding. In _Proceedings of the 2019 Conference of the North American Chapter of the Association for Computational Linguistics: Human Language Technologies, Volume 1 (Long and Short Papers)_, pages 4171-4186, Minneapolis, Minnesota, June 2019. Association for Computational Linguistics.
* [8] OpenAI. Gpt-4 technical report. _arXiv preprint arXiv:2303.08774_, 2023.
* [9] Rishi Bommasani, Drew A Hudson, Ehsan Adeli, Russ Altman, Simran Arora, Sydney von Arx, Michael S Bernstein, Jeannette Bohg, Antoine Bosselut, Emma Brunskill, et al. On the opportunities and risks of foundation models. _arXiv preprint arXiv:2108.07258_, 2021.
* [10] Aditya Ramesh, Mikhail Pavlov, Gabriel Goh, Scott Gray, Chelsea Voss, Alec Radford, Mark Chen, and Ilya Sutskever. Zero-shot text-to-image generation. In _International Conference on Machine Learning_, pages 8821-8831. PMLR, 2021.
* [11] Alexey Dosovitskiy, Lucas Beyer, Alexander Kolesnikov, Dirk Weissenborn, Xiaohua Zhai, Thomas Unterthiner, Mostafa Dehghani, Matthias Minderer, Georg Heigold, Sylvain Gelly, Jakob Uszkoreit, and Neil Houlsby. An image is worth 16x16 words: Transformers for image recognition at scale. In _International Conference on Learning Representations_, 2021.
* [12] Alec Radford, Jong Wook Kim, Chris Hallacy, Aditya Ramesh, Gabriel Goh, Sandhini Agarwal, Girish Sastry, Amanda Askell, Pamela Mishkin, Jack Clark, et al. Learning transferable visual models from natural language supervision. In _International conference on machine learning_, pages 8748-8763. PMLR, 2021.
* [13] Danny Driess, Fei Xia, Mehdi SM Sajjadi, Corey Lynch, Aakanksha Chowdery, Brian Ichter, Ayzaan Wahid, Jonathan Tompson, Quan Vuong, Tianhe Yu, et al. Palm-e: An embodied multimodal language model. _arXiv preprint arXiv:2303.03378_, 2023.

* Chen et al. [2021] Lili Chen, Kevin Lu, Aravind Rajeswaran, Kimin Lee, Aditya Grover, Misha Laskin, Pieter Abbeel, Aravind Srinivas, and Igor Mordatch. Decision transformer: Reinforcement learning via sequence modeling. In _Advances in Neural Information Processing Systems_, volume 34, pages 15084-15097, 2021.
* Reed et al. [2022] Scott Reed, Konrad Zolna, Emilio Parisotto, Sergio Gomez Colmenarejo, Alexander Novikov, Gabriel Barth-Maron, Mai Gimenez, Yury Sulsky, Jackie Kay, Jost Tobias Springenberg, et al. A generalist agent. _arXiv preprint arXiv:2205.06175_, 2022.
* Lester et al. [2021] Brian Lester, Rami Al-Rfou, and Noah Constant. The power of scale for parameter-efficient prompt tuning. In _Proceedings of the 2021 Conference on Empirical Methods in Natural Language Processing_, pages 3045-3059, 2021.
* Oymak et al. [2023] Samet Oymak, Ankit Singh Rawat, Mahdi Soltanolkotabi, and Christos Thrampoulidis. On the role of attention in prompt-tuning. In _International Conference on Machine Learning_, 2023.
* Li and Liang [2021] Xiang Lisa Li and Percy Liang. Prefix-tuning: Optimizing continuous prompts for generation. _arXiv preprint arXiv:2101.00190_, 2021.
* Rosset et al. [2003] Saharon Rosset, Ji Zhu, and Trevor Hastie. Margin maximizing loss functions. _Advances in neural information processing systems_, 16, 2003.
* Suggala et al. [2018] Arun Suggala, Adarsh Prasad, and Pradeep K Ravikumar. Connecting optimization and regularization paths. _Advances in Neural Information Processing Systems_, 31, 2018.
* Ji et al. [2020] Ziwei Ji, Miroslav Dudik, Robert E Schapire, and Matus Telgarsky. Gradient descent follows the regularization path for general losses. In _Conference on Learning Theory_, pages 2109-2136. PMLR, 2020.
* Soudry et al. [2018] Daniel Soudry, Elad Hoffer, Mor Shpigel Nacson, Suriya Gunasekar, and Nathan Srebro. The implicit bias of gradient descent on separable data. _The Journal of Machine Learning Research_, 19(1):2822-2878, 2018.
* Dong et al. [2021] Yihe Dong, Jean-Baptiste Cordonnier, and Andreas Loukas. Attention is not all you need: Pure attention loses rank doubly exponentially with depth. In _International Conference on Machine Learning_, pages 2793-2803. PMLR, 2021.
* Krizhevsky et al. [2014] Alex Krizhevsky, Vinod Nair, and Geoffrey Hinton. The cifar-10 dataset. _online: http://www. cs. toronto. edu/kriz/cifar. html_, 55(5), 2014.
* Gunasekar et al. [2018] Suriya Gunasekar, Jason Lee, Daniel Soudry, and Nathan Srebro. Characterizing implicit bias in terms of optimization geometry. In _International Conference on Machine Learning_, pages 1832-1841. PMLR, 2018.
* Nacson et al. [2019] Mor Shpigel Nacson, Jason Lee, Suriya Gunasekar, Pedro Henrique Pamplona Savarese, Nathan Srebro, and Daniel Soudry. Convergence of gradient descent on separable data. In _The 22nd International Conference on Artificial Intelligence and Statistics_, pages 3420-3428. PMLR, 2019.
* Ji and Telgarsky [2021] Ziwei Ji and Matus Telgarsky. Characterizing the implicit bias via a primal-dual analysis. In _Algorithmic Learning Theory_, pages 772-804. PMLR, 2021.
* Moroshko et al. [2020] Edward Moroshko, Blake E Woodworth, Suriya Gunasekar, Jason D Lee, Nati Srebro, and Daniel Soudry. Implicit bias in deep linear classification: Initialization scale vs training accuracy. _Advances in neural information processing systems_, 33:22182-22193, 2020.
* Ji and Telgarsky [2020] Ziwei Ji and Matus Telgarsky. Directional convergence and alignment in deep learning. In H. Larochelle, M. Ranzato, R. Hadsell, M. F. Balcan, and H. Lin, editors, _Advances in Neural Information Processing Systems_, volume 33, pages 17176-17186. Curran Associates, Inc., 2020.
* Ji and Telgarsky [2018] Ziwei Ji and Matus Telgarsky. Risk and parameter convergence of logistic regression. _arXiv preprint arXiv:1803.07300_, 2018.

* [31] Ziwei Ji and Matus Telgarsky. The implicit bias of gradient descent on nonseparable data. In _Conference on Learning Theory_, pages 1772-1798. PMLR, 2019.
* [32] Blake Woodworth, Suriya Gunasekar, Jason D Lee, Edward Moroshko, Pedro Savarese, Itay Golan, Daniel Soudry, and Nathan Srebro. Kernel and rich regimes in overparametrized models. In _Conference on Learning Theory_, pages 3635-3673. PMLR, 2020.
* [33] Chulhee Yun, Shankar Krishnan, and Hossein Mobahi. A unifying view on implicit bias in training linear neural networks. _arXiv preprint arXiv:2010.02501_, 2020.
* [34] Tomas Vaskevicius, Varun Kanade, and Patrick Rebeschini. Implicit regularization for optimal sparse recovery. _Advances in Neural Information Processing Systems_, 32:2972-2983, 2019.
* [35] Ehsan Amid and Manfred K Warmuth. Winnowing with gradient descent. In _Conference on Learning Theory_, pages 163-182. PMLR, 2020.
* [36] Ehsan Amid and Manfred KK Warmuth. Reparameterizing mirror descent as gradient descent. _Advances in Neural Information Processing Systems_, 33:8430-8439, 2020.
* [37] Yuanzhi Li, Colin Wei, and Tengyu Ma. Towards explaining the regularization effect of initial large learning rate in training neural networks. _arXiv preprint arXiv:1907.04595_, 2019.
* [38] Guy Blanc, Neha Gupta, Gregory Valiant, and Paul Valiant. Implicit regularization for deep neural networks driven by an ornstein-uhlenbeck like process. In _Conference on learning theory_, pages 483-513. PMLR, 2020.
* [39] Jeff Z HaoChen, Colin Wei, Jason D Lee, and Tengyu Ma. Shape matters: Understanding the implicit bias of the noise covariance. _arXiv preprint arXiv:2006.08680_, 2020.
* [40] Zhiyuan Li, Tianhao Wang, and Sanjeev Arora. What happens after SGD reaches zero loss? -a mathematical framework. In _International Conference on Learning Representations_, 2022.
* [41] Alex Damian, Tengyu Ma, and Jason Lee. Label noise sgd provably prefers flat global minimizers. _arXiv preprint arXiv:2106.06530_, 2021.
* [42] Difan Zou, Jingfeng Wu, Vladimir Braverman, Quanquan Gu, Dean P Foster, and Sham Kakade. The benefits of implicit regularization from sgd in least squares problems. _Advances in Neural Information Processing Systems_, 34:5456-5468, 2021.
* [43] Qian Qian and Xiaoyuan Qian. The implicit bias of adagrad on separable data. _Advances in Neural Information Processing Systems_, 32, 2019.
* [44] Bohan Wang, Qi Meng, Huishuai Zhang, Ruoyu Sun, Wei Chen, and Zhi-Ming Ma. Momentum doesn't change the implicit bias. _arXiv preprint arXiv:2110.03891_, 2021.
* [45] Bohan Wang, Qi Meng, Wei Chen, and Tie-Yan Liu. The implicit bias for adaptive optimization algorithms on homogeneous neural networks. In _International Conference on Machine Learning_, pages 10849-10858. PMLR, 2021.
* [46] Ziwei Ji, Nathan Srebro, and Matus Telgarsky. Fast margin maximization via dual acceleration. In _International Conference on Machine Learning_, pages 4860-4869. PMLR, 2021.
* [47] Jianpeng Cheng, Li Dong, and Mirella Lapata. Long short-term memory-networks for machine reading. In _Proceedings of the 2016 Conference on Empirical Methods in Natural Language Processing_, pages 551-561, Austin, Texas, November 2016. Association for Computational Linguistics.
* [48] Ankur Parikh, Oscar Tackstrom, Dipanjan Das, and Jakob Uszkoreit. A decomposable attention model for natural language inference. In _Proceedings of the 2016 Conference on Empirical Methods in Natural Language Processing_, pages 2249-2255, Austin, Texas, November 2016. Association for Computational Linguistics.

* [49] Romain Paulus, Caiming Xiong, and Richard Socher. A deep reinforced model for abstractive summarization. In _International Conference on Learning Representations_, 2018.
* [50] Zhouhan Lin, Minwei Feng, Cicero Nogueira dos Santos, Mo Yu, Bing Xiang, Bowen Zhou, and Yoshua Bengio. A structured self-attentive sentence embedding. In _International Conference on Learning Representations_, 2017.
* [51] Benjamin L Edelman, Surbhi Goel, Sham Kakade, and Cyril Zhang. Inductive biases and variable creation in self-attention mechanisms. In _International Conference on Machine Learning_, pages 5793-5831. PMLR, 2022.
* [52] Arda Sahiner, Tolga Ergen, Batu Ozturkler, John Pauly, Morteza Mardani, and Mert Pilanci. Unraveling attention via convex duality: Analysis and interpretations of vision transformers. In _International Conference on Machine Learning_, pages 19050-19088. PMLR, 2022.
* [53] Tolga Ergen, Behnam Neyshabur, and Harsh Mehta. Convexifying transformers: Improving optimization and understanding of transformer networks. _arXiv:2211.11052_, 2022.
* [54] Pierre Baldi and Roman Vershynin. The quarks of attention. _arXiv:2202.08371_, 2022.
* [55] Samy Jelassi, Michael Eli Sander, and Yuanzhi Li. Vision transformers provably learn spatial structure. In Alice H. Oh, Alekh Agarwal, Danielle Belgrave, and Kyunghyun Cho, editors, _Advances in Neural Information Processing Systems_, 2022.
* [56] Hongkang Li, Meng Wang, Sijia Liu, and Pin-Yu Chen. A theoretical understanding of shallow vision transformers: Learning, generalization, and sample complexity. _arXiv preprint arXiv:2302.06015_, 2023.
* [57] Simon Du, Jason Lee, Haochuan Li, Liwei Wang, and Xiyu Zhai. Gradient descent finds global minima of deep neural networks. In _International Conference on Machine Learning_, pages 1675-1685. PMLR, 2019.
* [58] Arthur Jacot, Franck Gabriel, and Clement Hongler. Neural tangent kernel: Convergence and generalization in neural networks. _arXiv preprint arXiv:1806.07572_, 2018.
* [59] Samet Oymak and Mahdi Soltanolkotabi. Toward moderate overparameterization: Global convergence guarantees for training shallow neural networks. _IEEE Journal on Selected Areas in Information Theory_, 1(1):84-105, 2020.
* [60] Zeyuan Allen-Zhu, Yuanzhi Li, and Zhao Song. A convergence theory for deep learning via over-parameterization. In _International Conference on Machine Learning_, pages 242-252. PMLR, 2019.
* [61] Vladimir Vapnik. _Estimation of dependences based on empirical data_. Springer Science & Business Media, 2006.
* [62] Peter Bartlett. For valid generalization the size of the weights is more important than the size of the network. _Advances in neural information processing systems_, 9, 1996.
* [63] Albert B Novikoff. On convergence proofs for perceptrons. Technical report, STANFORD RESEARCH INST MENLO PARK CA, 1963.
* [64] Peter Bartlett, Yoav Freund, Wee Sun Lee, and Robert E Schapire. Boosting the margin: A new explanation for the effectiveness of voting methods. _The annals of statistics_, 26(5):1651-1686, 1998.
* [65] Tong Zhang and Bin Yu. Boosting with early stopping: Convergence and consistency. _Annals of Statistics_, page 1538, 2005.
* [66] Matus Telgarsky. Margins, shrinkage, and boosting. In _International Conference on Machine Learning_, pages 307-315. PMLR, 2013.

* [67] Ganesh Ramachandra Kini, Orestis Paraskevas, Samet Oymak, and Christos Thrampoulidis. Label-imbalanced and group-sensitive classification under overparameterization. _Advances in Neural Information Processing Systems_, 34:18970-18983, 2021.
* [68] Mahdi Soltanolkotabi, Dominik Stoger, and Changzhi Xie. Implicit balancing and regularization: Generalization and convergence guarantees for overparameterized asymmetric matrix sensing. _arXiv:2303.14244_, 2023.
* [69] Hossein Taheri and Christos Thrampoulidis. On generalization of decentralized learning with separable data. In _International Conference on Artificial Intelligence and Statistics_, pages 4917-4945. PMLR, 2023.
* [70] Samet Oymak and Mahdi Soltanolkotabi. Overparameterized nonlinear learning: Gradient descent takes the shortest path? In _International Conference on Machine Learning_, pages 4951-4960. PMLR, 2019.
* [71] Ziwei Ji and Matus Telgarsky. Gradient descent aligns the layers of deep linear networks. _arXiv preprint arXiv:1810.02032_, 2018.
* [72] Sanjeev Arora, Nadav Cohen, Wei Hu, and Yuping Luo. Implicit regularization in deep matrix factorization. _Advances in Neural Information Processing Systems_, 32, 2019.
* [73] Kaifeng Lyu and Jian Li. Gradient descent maximizes the margin of homogeneous neural networks. _arXiv preprint arXiv:1906.05890_, 2019.
* [74] Lenaic Chizat and Francis Bach. Implicit bias of gradient descent for wide two-layer neural networks trained with the logistic loss. In _Conference on Learning Theory_, pages 1305-1338. PMLR, 2020.
* [75] Spencer Frei, Gal Vardi, Peter L Bartlett, and Nathan Srebro. Benign overfitting in linear classifiers and leaky relu networks from kkt conditions for margin maximization. _arXiv e-prints_, pages arXiv-2303, 2023.
* [76] Gal Vardi, Ohad Shamir, and Nati Srebro. On margin maximization in linear and relu networks. _Advances in Neural Information Processing Systems_, 35:37024-37036, 2022.
* [77] Navid Azizan, Sahin Lale, and Babak Hassibi. Stochastic mirror descent on overparameterized nonlinear models. _IEEE Transactions on Neural Networks and Learning Systems_, 33(12):7717-7727, 2021.
* [78] Navid Azizan and Babak Hassibi. Stochastic gradient/mirror descent: Minimax optimality and implicit regularization. In _International Conference on Learning Representations_.
* [79] Guorui Zhou, Xiaoqiang Zhu, Chenru Song, Ying Fan, Han Zhu, Xiao Ma, Yanghui Yan, Junqi Jin, Han Li, and Kun Gai. Deep interest network for click-through rate prediction. In _Proceedings of the 24th ACM SIGKDD International Conference on Knowledge Discovery & Data Mining_, pages 1059-1068, 2018.
* [80] Qiwei Chen, Huan Zhao, Wei Li, Pipei Huang, and Wenwu Ou. Behavior sequence transformer for e-commerce recommendation in alibaba. In _Proceedings of the 1st International Workshop on Deep Learning Practice for High-Dimensional Sparse Data_, pages 1-4, 2019.
* [81] Fei Sun, Jun Liu, Jian Wu, Changhua Pei, Xiao Lin, Wenwu Ou, and Peng Jiang. Bert4rec: Sequential recommendation with bidirectional encoder representations from transformer. In _Proceedings of the 28th ACM International Conference on Information and Knowledge Management_, pages 1441-1450, 2019.
* [82] Mia Xu Chen, Orhan Firat, Ankur Bapna, Melvin Johnson, Wolfgang Macherey, George Foster, Llion Jones, Mike Schuster, Noam Shazeer, Niki Parmar, Ashish Vaswani, Jakob Uszkoreit, Lukasz Kaiser, Zhifeng Chen, Yonghui Wu, and Macduff Hughes. The best of both worlds: Combining recent advances in neural machine translation. In _Proceedings of the 56th Annual Meeting of the Association for Computational Linguistics (Volume 1: Long Papers)_, pages 76-86, Melbourne, Australia, July 2018. Association for Computational Linguistics.

* [83] Michael Janner, Qiyang Li, and Sergey Levine. Reinforcement learning as one big sequence modeling problem. In _ICML 2021 Workshop on Unsupervised Reinforcement Learning_, 2021.
* [84] Qinqing Zheng, Amy Zhang, and Aditya Grover. Online decision transformer. In _Proceedings of the 39th International Conference on Machine Learning_, 2022.
* [85] Alexey Dosovitskiy, Lucas Beyer, Alexander Kolesnikov, Dirk Weissenborn, Xiaohua Zhai, Thomas Unterthiner, Mostafa Dehghani, Matthias Minderer, Georg Heigold, Sylvain Gelly, et al. An image is worth 16x16 words: Transformers for image recognition at scale. In _International Conference on Learning Representations_, 2020.
* [86] Hugo Touvron, Matthieu Cord, Matthijs Douze, Francisco Massa, Alexandre Sablayrolles, and Herve Jegou. Training data-efficient image transformers & distillation through attention. In _International Conference on Machine Learning_, pages 10347-10357. PMLR, 2021.
* [87] Zi-Hang Jiang, Qibin Hou, Li Yuan, Daquan Zhou, Yujun Shi, Xiaojie Jin, Anran Wang, and Jiashi Feng. All tokens matter: Token labeling for training better vision transformers. In _Advances in Neural Information Processing Systems_, volume 34, pages 18590-18602, 2021.
* [88] Hyunjik Kim, George Papamakarios, and Andriy Mnih. The lipschitz constant of self-attention. In _International Conference on Machine Learning_, pages 5562-5571. PMLR, 2021.
* [89] Jiri Hron, Yasaman Bahri, Jascha Sohl-Dickstein, and Roman Novak. Infinite attention: Nngp and ntk for deep attention networks. In _International Conference on Machine Learning_, pages 4376-4386. PMLR, 2020.
* [90] Greg Yang. Tensor programs ii: Neural tangent kernel for any architecture. _arXiv preprint arXiv:2006.14548_, 2020.
* [91] Mostafa Dehghani, Stephan Gouws, Oriol Vinyals, Jakob Uszkoreit, and Lukasz Kaiser. Universal transformers. In _International Conference on Learning Representations_, 2018.
* [92] Chulhee Yun, Srinadh Bhojanapalli, Ankit Singh Rawat, Sashank Reddi, and Sanjiv Kumar. Are transformers universal approximators of sequence-to-sequence functions? In _International Conference on Learning Representations_, 2019.
* [93] Angeliki Giannou, Shashank Rajput, Jy-yong Sohn, Kangwook Lee, Jason D Lee, and Dimitris Papailiopoulos. Looped transformers as programmable computers. _arXiv:2301.13196_, 2023.
* [94] Yoav Levine, Noam Wies, Or Sharir, Hofit Bata, and Amnon Shashua. Limits to depth efficiencies of self-attention. In _Advances in Neural Information Processing Systems_, volume 33, pages 22640-22651, 2020.
* [95] Charlie Snell, Ruiqi Zhong, Dan Klein, and Jacob Steinhardt. Approximating how single head attention learns. _arXiv preprint arXiv:2103.07601_, 2021.
* [96] Jason Wei, Maarten Bosma, Vincent Y Zhao, Kelvin Guu, Adams Wei Yu, Brian Lester, Nan Du, Andrew M Dai, and Quoc V Le. Finetuned language models are zero-shot learners. _arXiv preprint arXiv:2109.01652_, 2021.
* [97] Ekin Akyurek, Dale Schuurmans, Jacob Andreas, Tengyu Ma, and Denny Zhou. What learning algorithm is in-context learning? investigations with linear models. _arXiv:2211.15661_, 2022.
* [98] Shivam Garg, Dimitris Tsipras, Percy S Liang, and Gregory Valiant. What can transformers learn in-context? a case study of simple function classes. _Advances in Neural Information Processing Systems_, 35:30583-30598, 2022.
* [99] Yingcong Li, M Emrullah Ildiz, Dimitris Papailiopoulos, and Samet Oymak. Transformers as algorithms: Generalization and stability in in-context learning. In _International Conference on Machine Learning_, 2023.

* [100] Jason Wei, Xuezhi Wang, Dale Schuurmans, Maarten Bosma, Ed Chi, Quoc Le, and Denny Zhou. Chain of thought prompting elicits reasoning in large language models. _arXiv preprint arXiv:2201.11903_, 2022.
* [101] Guhao Feng, Yuntian Gu, Bohang Zhang, Haotian Ye, Di He, and Liwei Wang. Towards revealing the mystery behind chain of thought: a theoretical perspective. _arXiv preprint arXiv:2305.15408_, 2023.
* [102] Yingcong Li, Kartik Sreenivasan, Angeliki Giannou, Dimitris Papailiopoulos, and Samet Oymak. Dissecting chain-of-thought: A study on compositional in-context learning of mlps. _arXiv preprint arXiv:2305.18869_, 2023.
* [103] Yuandong Tian, Yiping Wang, Beidi Chen, and Simon Du. Scan and snap: Understanding training dynamics and token composition in 1-layer transformer. _arXiv:2305.16380_, 2023.
* [104] Tan Minh Nguyen, Tam Minh Nguyen, Nhat Ho, Andrea L Bertozzi, Richard Baraniuk, and Stanley Osher. A primal-dual framework for transformers and neural networks. In _The Eleventh International Conference on Learning Representations_, 2023.
* [105] Davoud Ataee Tarzanagh, Yingcong Li, Christos Thrampoulidis, and Samet Oymak. Transformers as support vector machines. _arXiv preprint arXiv:2308.16898_, 2023.

Roadmap.The appendix is organized as follows: Section A provides basic facts about the training risk. Section B presents the proof of local and global gradient descent and regularized path for learning \(\bm{p}\in\mathbb{R}^{d}\) with a fixed \(\bm{v}\in\mathbb{R}^{d}\) choice. Section C provides the proof of regularized path applied to the general case of joint optimization of head \(\bm{v}\) and attention weights \(\bm{p}\) using a logistic loss function. Section D presents the regularized path applied to a more general model \(f(\bm{X})=\psi(\bm{X}^{\top}\mathbb{S}(\bm{X}\bm{W}^{\top}\bm{p}))\) with a nonlinear head \(\psi\). Section E provides implementation details. Finally, Section F discusses additional related work on implicit bias and self-attention.

## Appendix A Addendum to Section 1

### Preliminaries on the Training Risk

By our assumption \(\psi:\mathbb{R}^{d}\rightarrow\mathbb{R}\) and \(\ell:\mathbb{R}\rightarrow\mathbb{R}\) are differentiable functions. Recall the objective

\[\mathcal{L}(\bm{p},\bm{W})=\frac{1}{n}\sum_{i=1}^{n}\ell\left(Y_{i}\cdot\psi( \bm{X}_{i}^{\top}\mathbb{S}(\bm{K}_{i}\bm{p}))\right)\] (11)

with the generic prediction model \(\psi(\bm{X}^{\top}\mathbb{S}(\bm{K}\bm{p}))\) and \(\bm{K}=\bm{X}\bm{W}^{\top}\).

Here, we write down the gradients of \(\bm{W}\) and \(\bm{p}\) in (11) to highlight the connection. Set \(\bm{q}:=\bm{W}^{\top}\bm{p}\), \(\bm{z}[\bm{X}]:=\bm{X}^{\top}\mathbb{S}(\bm{K}\bm{p})\), and \(\bm{a}[\bar{\bm{X}}]:=\bm{K}\bm{p}\). Given \(\bm{X}\) and using \(\bm{K}=\bm{X}\bm{W}^{\top}\), we have that

\[\nabla_{\bm{q}}\psi(\bm{p},\bm{W}) =\bm{X}^{\top}\mathbb{S}^{\prime}(\bm{a}[\bm{X}])\bm{X}\cdot\psi^{ \prime}(z[\bm{X}]),\] (12a) \[\nabla_{\bm{p}}\psi(\bm{p},\bm{W}) =\bm{W}\nabla_{\bm{q}}\psi(\bm{p},\bm{W}),\] (12b) \[\nabla_{\bm{W}}\psi(\bm{p},\bm{W}) =\bm{p}\nabla_{\bm{q}}^{\top}\psi(\bm{p},\bm{W}),\] (12c)

where

\[\mathbb{S}^{\prime}(\bm{a}[\bm{X}])=\mathrm{diag}(\mathbb{S}(\bm{a}[\bm{X}]) )-\mathbb{S}(\bm{a}[\bm{X}])\mathbb{S}(\bm{a}[\bm{X}])^{\top}\in\mathbb{R}^{ \top\times T}.\]

Setting \(\psi(\bm{z})=\bm{v}^{\top}\bm{z}\) for linear head, we obtain

\[\nabla_{\bm{q}}\psi(\bm{p},\bm{W}) =\bm{X}^{\top}\mathbb{S}^{\prime}(\bm{a}[\bm{X}])\bm{\gamma},\] (13a) \[\nabla_{\bm{p}}\psi(\bm{p},\bm{W}) =\bm{W}\nabla_{\bm{q}}\psi(\bm{p},\bm{W})=\bm{K}^{\top}\mathbb{S} ^{\prime}(\bm{a}[\bm{X}])\bm{\gamma},\] (13b) \[\nabla_{\bm{W}}\psi(\bm{p},\bm{W}) =\bm{p}\nabla_{\bm{q}}^{\top}\psi(\bm{p},\bm{W})=\bm{p}\bm{v}^{ \top}\bm{X}^{\top}\mathbb{S}^{\prime}(\bm{a}[\bm{X}])\bm{X}.\] (13c)

Recalling (12b) and (12c), and defining \(\ell_{i}^{\prime}:=\ell^{\prime}(Y_{i}\cdot\psi(\bm{z}[\bm{X}_{i}]))\in\mathbb{R}\), we have that

\[\nabla_{\bm{p}}\mathcal{L}(\bm{p},\bm{W}) =\frac{1}{n}\sum_{i=1}^{n}\ell_{i}^{\prime}\cdot Y_{i}\cdot\bm{W} \nabla_{\bm{q}}\psi(\bm{p},\bm{W}),\] (14a) \[\nabla_{\bm{W}}\mathcal{L}(\bm{p},\bm{W}) =\frac{1}{n}\sum_{i=1}^{n}\ell_{i}^{\prime}\cdot Y_{i}\cdot\bm{p} \nabla_{\bm{q}}^{\top}\psi(\bm{p},\bm{W}).\] (14b)

Setting \(\psi(\bm{z})=\bm{v}^{\top}\bm{z}\) for linear head and \(\bm{\gamma}_{i}=Y_{i}\cdot\bm{X}_{i}\bm{v}\), we obtain

\[\nabla_{\bm{p}}\mathcal{L}(\bm{p},\bm{W}) =\frac{1}{n}\sum_{i=1}^{n}\ell_{i}^{\prime}\cdot\bm{K}_{i}^{\top }\mathbb{S}^{\prime}(\bm{a}[\bm{X}_{i}])\bm{\gamma}_{i},\] (15a) \[\nabla_{\bm{W}}\mathcal{L}(\bm{p},\bm{W}) =\bm{p}\Bigg{(}\frac{1}{n}\sum_{i=1}^{n}\ell_{i}^{\prime}\cdot \bm{\gamma}_{i}^{\top}\mathbb{S}^{\prime}(\bm{a}[\bm{X}_{i}])\bm{X}_{i}\Bigg{)}.\] (15b)

**Lemma 3** (Key Lemma): _For any \(\bm{p},\bm{q}\in\mathbb{R}^{d}\), let \(\bm{a}=\bm{K}\bm{q}\), \(\bm{s}=\mathbb{S}(\bm{K}\bm{p})\), and \(\bm{\gamma}=\bm{X}\bm{v}\). Set_

\[\Gamma=\sup_{t,\tau\in[T]}|\bm{\gamma}_{t}-\bm{\gamma}_{\tau}|\ \ \text{and}\ \ \ A=\sup_{t\in[T]}\|\bm{k}_{t}\|\cdot\|\bm{q}\|.\]

_We have that_

\[\left|\bm{a}^{\top}\mathrm{diag}(\bm{s})\bm{\gamma}-\bm{a}^{\top}\bm{s}\bm{s}^ {\top}\bm{\gamma}-\sum_{t\geq 2}^{T}(\bm{a}_{1}-\bm{a}_{t})\bm{s}_{t}(\bm{ \gamma}_{1}-\bm{\gamma}_{t})\right|\leq 2\Gamma A(1-\bm{s}_{1})^{2}.\]

**Proof.** Set \(\bar{\gamma}=\sum_{t=1}^{T}\bm{\gamma}_{t}\bm{s}_{t}\). We have

\[\bm{\gamma}_{1}-\bar{\gamma}=\sum_{t\geq 2}^{T}(\bm{\gamma}_{1}-\bm{\gamma}_{t}) \bm{s}_{t},\ \ \text{and}\ \ |\bm{\gamma}_{1}-\bar{\gamma}|\leq\Gamma(1-\bm{s}_{1}).\]

Then,

\[\bm{a}^{\top}\mathrm{diag}(\bm{s})\bm{\gamma}-\bm{a}^{\top}\bm{s} \bm{s}^{\top}\bm{\gamma} =\sum_{t=1}^{T}\bm{a}_{t}\bm{\gamma}_{t}\bm{s}_{t}-\sum_{t=1}^{T} \bm{a}_{t}\bm{s}_{t}\sum_{t=1}^{T}\bm{\gamma}_{t}\bm{s}_{t}\] \[=\bm{a}_{1}\bm{s}_{1}(\bm{\gamma}_{1}-\bar{\gamma})-\sum_{t\geq 2}^{T} \bm{a}_{t}\bm{s}_{t}(\bar{\gamma}-\bm{\gamma}_{t}).\] (16)

Since

\[\left|\sum_{t\geq 2}^{T}\bm{a}_{t}\bm{s}_{t}(\bar{\gamma}-\bm{\gamma}_{t})-\sum_{t \geq 2}^{T}\bm{a}_{t}\bm{s}_{t}(\bm{\gamma}_{1}-\bm{\gamma}_{t})\right|\leq A \Gamma(1-\bm{s}_{1})^{2},\]we obtain2

Footnote 2: For simplicity, we use \(\pm\) on the right hand side to denote the upper and lower bounds.

\[\bm{a}^{\top}\mathrm{diag}(\bm{s})\bm{\gamma}-\bm{a}^{\top}\bm{s} \bm{s}^{\top} \bm{\gamma} =\bm{a}_{1}\bm{s}_{1}(\bm{\gamma}_{1}-\bar{\bm{\gamma}})-\sum_{t \geq 2}^{T}\bm{a}_{t}\bm{s}_{t}(\bm{\gamma}_{1}-\bm{\gamma}_{t})\pm A\Gamma(1- \bm{s}_{1})^{2}\] \[=\bm{a}_{1}\bm{s}_{1}\sum_{t\geq 2}^{T}(\bm{\gamma}_{1}-\bm{\gamma}_ {t})\bm{s}_{t}-\sum_{t\geq 2}^{T}\bm{a}_{t}\bm{s}_{t}(\bm{\gamma}_{1}-\bm{ \gamma}_{t})\pm A\Gamma(1-\bm{s}_{1})^{2}\] \[=\sum_{t\geq 2}^{T}(\bm{a}_{1}\bm{s}_{1}-\bm{a}_{t})\bm{s}_{t}( \bm{\gamma}_{1}-\bm{\gamma}_{t})\pm A\Gamma(1-\bm{s}_{1})^{2}\] \[=\sum_{t\geq 2}^{T}(\bm{a}_{1}-\bm{a}_{t})\bm{s}_{t}(\bm{\gamma}_ {1}-\bm{\gamma}_{t})\pm 2A\Gamma(1-\bm{s}_{1})^{2}.\]

Here, \(\pm\) on the right handside uses the fact that

\[\left|\sum_{t\geq 2}^{T}(\bm{a}_{1}\bm{s}_{1}-\bm{a}_{1})\bm{s}_{t}(\bm{ \gamma}_{1}-\bm{\gamma}_{t})\right|\leq(1-\bm{s}_{1})A\Gamma\sum_{t\geq 2}^{T} \bm{s}_{t}=(1-\bm{s}_{1})^{2}A\Gamma.\]

### Proof of Lemma 1

**Proof.** Let us prove the result for a general step size sequence \((\eta_{t})_{t\geq 0}\). On the same training data \((Y_{i},\bm{X}_{i})_{i=1}^{n}\), recall the objectives \(\tilde{\mathcal{L}}(\bm{p})=\frac{1}{n}\sum_{i=1}^{n}\ell(Y_{i}\cdot\psi(\bm{X }_{i}^{\top}\mathbb{S}(\bm{X}_{i}\bm{p})))\) and \(\mathcal{L}(\bm{W})=\frac{1}{n}\sum_{i=1}^{n}\ell(Y_{i}\cdot\psi(\bm{X}_{i}^{ \top}\mathbb{S}(\bm{X}_{i}\bm{W}^{\top}\bm{u})))\). Suppose claim is true till iteration \(t\). For iteration \(t+1\), using \(\bm{W}(t)^{\top}\bm{u}=\bm{p}(t)\), define and observe that

\[\bm{S}_{i}=\mathbb{S}^{\prime}(\bm{X}_{i}\bm{W}(t)^{\top}\bm{u} )=\mathbb{S}^{\prime}(\bm{X}_{i}\bm{p}(t)),\] \[\bm{s}_{i}=\mathbb{S}(\bm{X}_{i}\bm{W}(t)^{\top}\bm{u})=\mathbb{ S}(\bm{X}_{i}\bm{p}(t)),\] \[\bm{z}[\bm{X}_{i}]=\bm{X}_{i}^{\top}\mathbb{S}(\bm{X}_{i}\bm{p}(t ))=\bm{X}_{i}^{\top}\mathbb{S}(\bm{X}_{i}\bm{W}(t)^{\top}\bm{u}),\]

for all \(i\in[n]\).

Thus, using (14), we have that

\[\nabla\tilde{\mathcal{L}}(\bm{p}(t)) =\frac{1}{n}\sum_{i=1}^{n}\ell_{i}^{\prime}\cdot Y_{i}\cdot\bm{X }_{i}^{\top}\bm{S}_{i}\bm{X}_{i}\cdot\psi^{\prime}(\bm{z}[\bm{X}_{i}]),\] \[\nabla\mathcal{L}(\bm{W}(t)) =\bm{u}\left(\frac{1}{n}\sum_{i=1}^{n}\ell_{i}^{\prime}\cdot Y_{i }\cdot\bm{X}_{i}^{\top}\bm{S}_{i}\bm{X}_{i}\cdot\psi^{\prime}(\bm{z}[\bm{X}_ {i}])\right)^{\top}.\]

Consequently, we found that gradient is rank-1 with left singular space equal to \(\bm{u}\), i.e.,

\[\nabla\mathcal{L}(\bm{W}(t))=\bm{u}\nabla^{\top}\tilde{\mathcal{L}}(\bm{p}(t)).\]

Since \(\bm{W}(t)\)'s left singular space is guaranteed to be in \(\bm{u}\) (including \(\bm{W}(0)\) by initialization), we only need to study the right singular vector. Using the induction till \(t\), this yields

\[\bm{W}(t+1)^{\top}\bm{u} =\bm{W}(t)^{\top}\bm{u}-\eta_{t}\|\bm{u}\|^{-2}\nabla^{\top} \mathcal{L}(\bm{W}(t))\bm{u}\] \[=\bm{p}(t)-\eta_{t}\|\bm{u}\|^{-2}\bm{u}^{\top}\bm{u}\nabla\tilde {\mathcal{L}}(\bm{p}(t))\] \[=\bm{p}(t+1).\]

This concludes the induction.

Addendum to Section 2

### Descent and Gradient Correlation Conditions

The lemma below identifies conditions under which \(\bm{p}^{\text{mm}\bm{\star}}\) is a global descent direction for \(\mathcal{L}(\bm{p})\).

**Lemma 4**: _Suppose \(\ell(\cdot)\) is a strictly decreasing differentiate loss function and Assumption 2 holds. Then, for all \(\bm{p}\in\mathbb{R}^{d}\), the training loss (\(\mathrm{ERM}\)) obeys \(\left\langle\nabla\mathcal{L}(\bm{p}),\bm{p}^{\text{mm}\bm{\star}}\right\rangle<0\)._

* Set \[\bm{\gamma}_{i}=Y_{i}\cdot\bm{X}_{i}\bm{v},\ \ \bm{a}_{i}=\bm{K}_{i}\bm{p},\ \ \bm{\bar{a}}_{i}=\bm{K}_{i}\bm{p}^{\text{mm}\bm{\star}},\ \ \text{and}\ \ \ell_{i}^{\prime}=\ell^{\prime}\left(\bm{\gamma}_{i}^{\top} \mathbb{S}(\bm{K}_{i}\bm{p})\right).\] (17) Let us recall the gradient evaluated at \(\bm{p}\) which is given by \[\nabla\mathcal{L}(\bm{p})=\frac{1}{n}\sum_{i=1}^{n}\ell_{i}^{\prime}\cdot\bm {K}_{i}^{\top}\mathbb{S}^{\prime}(\bm{a}_{i})\bm{\gamma}_{i}.\] (18) This implies that \[\left\langle\nabla\mathcal{L}(\bm{p}),\bm{p}^{\text{mm}\bm{\star}}\right\rangle =\frac{1}{n}\sum_{i=1}^{n}\ell_{i}^{\prime}\cdot\left\langle\bm{ \bar{a}}_{i},\mathbb{S}^{\prime}(\bm{a}_{i})\bm{\gamma}_{i}\right\rangle.\] (19) To proceed, we will prove that individual summands are all strictly negative. To show that, without losing generality, let us focus on the first input and drop the subscript \[i\] for cleaner notation. This yields \[\left\langle\bm{\bar{a}},\mathbb{S}^{\prime}(\bm{a})\bm{\gamma}\right\rangle =\bm{\bar{a}}^{\top}\mathrm{diag}(\mathbb{S}(\bm{a}))\bm{\gamma}-\bm{\bar{a} }^{\top}\mathbb{S}(\bm{a})\mathbb{S}(\bm{a})^{\top}\bm{\gamma}.\] (20) Without losing generality, assume optimal token is the first one and \[\bm{\gamma}_{i}\] is a constant for all \[t\geq 2\]. To proceed, we will prove the following: Suppose \[\gamma=\bm{\gamma}_{t\geq 2}\] is constant, \[\bm{\gamma}_{1},\bm{\bar{a}}_{1}\] are the largest indices of \[\bm{\gamma},\bm{\bar{a}}\]. Then, for any \[s\] obeying \[\sum_{i\in[T]}\bm{s}_{t}=1,\bm{s}_{t}\geq 0\], we have that \[\bm{\bar{a}}^{\top}\mathrm{diag}(s)\bm{\gamma}-\bm{\bar{a}}^{\top}ss^{\top} \bm{\gamma}>0\]. To see this, we write \[\bm{\bar{a}}^{\top}\mathrm{diag}(\bm{s})\bm{\gamma}-\bm{\bar{a}}^{ \top}\bm{s}s^{\top}\bm{\gamma} =\sum_{t=1}^{T}\bm{\bar{a}}_{t}\bm{\gamma}_{t}\bm{s}_{t}-\sum_{t= 1}^{T}\bm{\bar{a}}_{t}\bm{s}_{t}\sum_{t=1}^{T}\bm{\gamma}_{t}\bm{s}_{t}\] \[=\left\{\bm{\bar{a}}_{1}\bm{\gamma}_{1}\bm{s}_{1}+\gamma\sum_{t \geq 2}^{T}\bm{\bar{a}}_{t}\bm{s}_{t}\right\}-\left(\bm{\gamma}_{1}\bm{s}_{1 }+\gamma(1-\bm{s}_{1})\right)\left(\bm{\bar{a}}_{1}\bm{s}_{1}+\sum_{t\geq 2}^{T}\bm{ \bar{a}}_{t}\bm{s}_{t}\right)\] \[=\bm{\bar{a}}_{1}(\bm{\gamma}_{1}-\gamma)\bm{s}_{1}(1-\bm{s}_{1}) +\left(\gamma-(\bm{\gamma}_{1}\bm{s}_{1}+\gamma(1-\bm{s}_{1}))\right)\sum_{t \geq 2}^{T}\bm{\bar{a}}_{t}\bm{s}_{t}\] (21) \[=\bm{\bar{a}}_{1}(\bm{\gamma}_{1}-\gamma)\bm{s}_{1}(1-\bm{s}_{1} )-(\bm{\gamma}_{1}-\gamma)\bm{s}_{1}\sum_{t\geq 2}^{T}\bm{\bar{a}}_{t}\bm{s}_{t}\] \[=(\bm{\gamma}_{1}-\gamma)(1-\bm{s}_{1})\bm{s}_{1}\left[\bm{\bar{a} }_{1}-\frac{\sum_{t\geq 2}^{T}\bm{\bar{a}}_{t}\bm{s}_{t}}{\sum_{t\geq 2}^{T}\bm{s}_{t}} \right].\] To proceed, let \[\bm{\gamma}_{\text{gap}}=\bm{\gamma}_{1}-\gamma\text{ and }\bm{a}_{\text{gap}}=\bm{\bar{a}}_{1}-\max_{t\geq 2}\bm{a}_{t}.\] With these, we obtain \[\bm{\bar{a}}^{\top}\mathrm{diag}(\bm{s})\bm{\gamma}-\bm{\bar{a}}^{\top}\bm{ s}\bm{s}^{\top}\bm{\gamma}\geq\bm{a}_{\text{gap}}\bm{\gamma}_{\text{gap}}\bm{s}_{1}(1- \bm{s}_{1}).\] (22) Note that \[\bm{a}_{\text{gap}}^{i}\geq\inf_{t\neq\text{opt}_{i}}(\bm{k}_{i \text{opt}_{i}}-\bm{k}_{ii})^{\top}\bm{p}^{\text{mm}\bm{\star}}\geq 1,\] \[\bm{\gamma}_{\text{gap}}^{i}=\inf_{t\neq\text{opt}_{i}}\bm{\gamma}_{i \text{opt}_{i}}-\bm{\gamma}_{ii}>0,\] \[\bm{s}_{i1}(1-\bm{s}_{i1})>0.\] On the other hand, by our assumption \[\ell_{i}^{\prime}<0\]. Hence, infimum'ing ( 22 ) over all inputs, multiplying by \[\ell_{i}^{\prime}\] and using ( 19 ) give the desired result.

[MISSING_PAGE_EMPTY:22]

**Lemma 6**: _Under Assumption A, the function \(\mathcal{L}(\bm{p})\) is \(L_{p}\)-smooth, where_

\[L_{p}:=\frac{1}{n}\sum_{i=1}^{n}\left(M_{0}\|\bm{v}\|^{2}\|\bm{W}\|^{2}\|\bm{X}_{ i}\|^{4}+3M_{1}\|\bm{v}\|\ \|\bm{W}\|^{2}\|\bm{X}_{i}\|^{3}\right).\] (24)

_Furthermore, if \(\eta\leq 1/L_{p}\), then, for any initialization \(\bm{p}(0)\), with the GD sequence \(\bm{p}(t+1)=\bm{p}(t)-\eta\nabla\mathcal{L}(\bm{p}(t))\), we have_

\[\mathcal{L}(\bm{p}(t+1))-\mathcal{L}(\bm{p}(t))\leq-\frac{\eta}{2}\left\| \nabla\mathcal{L}(\bm{p}(t))\right\|^{2},\] (25)

_for all \(t\geq 0\). This implies that_

\[\sum_{i=0}^{\infty}\left\|\nabla\mathcal{L}\left(\bm{p}(t)\right)\right\|^{2 }<\infty,\ \ \text{and}\ \ \lim_{i\to\infty}\left\|\nabla\mathcal{L}\left(\bm{p}(t)\right)\right\|^{2}=0.\] (26)

**Proof.** Recall that we defined \(\bm{\gamma}_{i}=Y_{i}\cdot\bm{X}_{i}\bm{v}\) and \(\bm{a}_{i}=\bm{K}_{i}\bm{p}\). The gradient of \(\mathcal{L}(\bm{p})\) is given by

\[\nabla\mathcal{L}(\bm{p})=\frac{1}{n}\sum_{i=1}^{n}\ell^{\prime}\left(\bm{ \gamma}_{i}^{\top}\mathbb{S}(\bm{K}_{i}\bm{p})\right)\cdot\bm{K}_{i}^{\top} \mathbb{S}^{\prime}(\bm{a}_{i})\bm{\gamma}_{i}.\]

Note that for any \(\bm{p}\in\mathbb{R}^{d}\), the Jacobian of \(\mathbb{S}(\bm{K}_{i}\bm{p})\) is given by

\[\frac{\partial\mathbb{S}(\bm{K}_{i}\bm{p})}{\partial\bm{p}}=\mathbb{S}^{ \prime}(\bm{K}_{i}\bm{p})\bm{K}_{i}=\left(\operatorname{diag}(\mathbb{S}(\bm {K}_{i}\bm{p}))-\mathbb{S}(\bm{K}_{i}\bm{p})\mathbb{S}(\bm{K}_{i}\bm{p})^{\top }\right)\bm{K}_{i}.\] (27)

The Jacobian (27) together with the definition of the softmax function \(\mathbb{S}(\cdot)\) implies that \(\|\partial\mathbb{S}(\bm{K}_{i}\bm{p})/\partial\bm{p}\|\leq\|\bm{K}_{i}\|\). Hence, for any \(\bm{p},\,\dot{\bm{p}}\in\mathbb{R}^{d}\), we have

\[\left\|\mathbb{S}(\bm{K}_{i}\bm{p})-\mathbb{S}(\bm{K}_{i}\dot{\bm{p}})\right\| \leq\left\|\bm{K}_{i}\right\|\|\bm{p}-\dot{\bm{p}}\|,\] (28a) and \[\left\|\mathbb{S}^{\prime}(\bm{K}_{i}\bm{p})-\mathbb{S}^{\prime }(\bm{K}_{i}\dot{\bm{p}})\right\| \leq\left\|\operatorname{diag}(\mathbb{S}(\bm{K}_{i}\bm{p}))- \operatorname{diag}(\mathbb{S}(\bm{K}_{i}\dot{\bm{p}}))\right\|\] \[+\left\|\mathbb{S}(\bm{K}_{i}\bm{p})\mathbb{S}(\bm{K}_{i}\bm{p})^{ \top}-\mathbb{S}(\bm{K}_{i}\dot{\bm{p}})\mathbb{S}(\bm{K}_{i}\dot{\bm{p}})^{ \top}\right\|\] \[\leq 3\|\bm{K}_{i}\|\,\|\bm{p}-\dot{\bm{p}}\|.\] (28b)

Here, the last inequality uses the fact that \(|ab-cd|\leq|d|ah-cd|+|a||b-d|\).

Next, for any \(\bm{p},\dot{\bm{p}}\in\mathbb{R}^{d}\), we have

\[\left\|\nabla\mathcal{L}(\bm{p})-\nabla\mathcal{L}(\dot{\bm{p}})\right\| \leq\frac{1}{n}\sum_{i=1}^{n}\left\|\ell^{\prime}\left(\bm{ \gamma}_{i}^{\top}\mathbb{S}(\bm{K}_{i}\bm{p})\right)\cdot\bm{K}_{i}^{\top} \mathbb{S}^{\prime}(\bm{K}_{i}\bm{p})\bm{\gamma}_{i}-\ell^{\prime}\left(\bm{ \gamma}_{i}^{\top}\mathbb{S}(\bm{K}_{i}\dot{\bm{p}})\right)\cdot\bm{K}_{i}^{ \top}\mathbb{S}^{\prime}(\bm{K}_{i}\dot{\bm{p}})\bm{\gamma}_{i}\right\|\] \[\leq\frac{1}{n}\sum_{i=1}^{n}\left\|\bm{K}_{i}^{\top}\mathbb{S}^{ \prime}(\bm{K}_{i}\dot{\bm{p}})\bm{\gamma}_{i}\right\|\ \left|\ell^{\prime}\left(\bm{\gamma}_{i}^{\top}\mathbb{S}(\bm{K}_{i}\bm{p}) \right)-\ell^{\prime}\left(\bm{\gamma}_{i}^{\top}\mathbb{S}(\bm{K}_{i}\dot{\bm{p }})\right)\right\|\] \[+\frac{1}{n}\sum_{i=1}^{n}\left|\ell^{\prime}(\bm{\gamma}_{i}^{ \top}\mathbb{S}(\bm{K}_{i}\bm{p}))\right|\ \left\|\bm{K}_{i}^{\top}\mathbb{S}^{\prime}(\bm{K}_{i}\bm{p})\bm{\gamma}_{i}- \bm{K}_{i}^{\top}\mathbb{S}^{\prime}(\bm{K}_{i}\dot{\bm{p}})\bm{\gamma}_{i}\right\|\] \[\leq\frac{1}{n}\sum_{i=1}^{n}M_{0}\|\bm{\gamma}_{i}\|^{2}\left\| \bm{K}_{i}\right\|\ \left\|\mathbb{S}(\bm{K}_{i}\bm{p})-\mathbb{S}(\bm{K}_{i}\dot{\bm{p}})\right\|\] \[+\frac{1}{n}\sum_{i=1}^{n}M_{1}\|\bm{\gamma}_{i}\|\ \|\bm{K}_{i}\|\ \left\| \mathbb{S}^{\prime}(\bm{K}_{i}\bm{p})-\mathbb{S}^{\prime}(\bm{K}_{i}\dot{\bm{p}}) \right\|,\] (29)

where the second inequality follows from the fact that \(|ab-cd|\leq|d||a-c|+|a||b-d|\) and the third inequality uses Assumption A.

Substituting (28a) and (28b) into (29), we get

\[\left\|\nabla\mathcal{L}(\bm{p})-\nabla\mathcal{L}(\dot{\bm{p}})\right\| \leq\frac{1}{n}\sum_{i=1}^{n}\left(M_{0}\|\bm{\gamma}_{i}\|^{2}\| \bm{K}_{i}\|^{2}+3M_{1}\|\bm{K}_{i}\|^{2}\|\bm{\gamma}_{i}\|\right)\|\bm{p}-\dot{ \bm{p}}\|\] \[\leq\frac{1}{n}\sum_{i=1}^{n}\left(M_{0}\|\bm{v}\|^{2}\|\bm{W}\|^{2 }\|\bm{X}_{i}\|^{4}+3M_{1}\|\bm{v}\|\|\bm{W}\|^{2}\|\bm{X}_{i}\|^{3}\right)\|\bm{p}- \dot{\bm{p}}\|\] \[\leq L_{p}\|\bm{p}-\dot{\bm{p}}\|,\]where \(L_{p}\) is defined in (24).

The remaining proof follows standard gradient descent analysis (see e.g. [22, Lemma 10]). Since \(\mathcal{L}\left(\bm{p}\right)\) is \(L_{p}\)-smooth, we get

\[\mathcal{L}\left(\bm{p}\left(t+1\right)\right) \leq\mathcal{L}\left(\bm{p}\left(t\right)\right)+\nabla\mathcal{L }\left(\bm{p}\left(t\right)\right)^{\top}\left(\bm{p}\left(t+1\right)-\bm{p} \left(t\right)\right)+\frac{L_{p}}{2}\left\|\bm{p}\left(t+1\right)-\bm{p} \left(t\right)\right\|^{2}\] \[=\mathcal{L}\left(\bm{p}\left(t\right)\right)-\eta\left\|\nabla \mathcal{L}\left(\bm{p}\left(t\right)\right)\right\|^{2}+\frac{L_{p}\eta^{2}} {2}\left\|\nabla\mathcal{L}\left(\bm{p}\left(t\right)\right)\right\|^{2}\] \[=\mathcal{L}\left(\bm{p}\left(t\right)\right)-\eta\left(1-\frac{ L_{p}\eta}{2}\right)\left\|\nabla\mathcal{L}\left(\bm{p}\left(t\right)\right) \right\|^{2}\] \[\leq\mathcal{L}\left(\bm{p}\left(t\right)\right)-\frac{\eta}{2} \left\|\nabla\mathcal{L}\left(\bm{p}\left(t\right)\right)\right\|^{2},\]

where the last inequality follows from our assumption on the stepsize.

The above inequality implies that

\[\sum_{t=0}^{\infty}\left\|\nabla\mathcal{L}\left(\bm{p}\left(t\right)\right) \right\|^{2}\leq\frac{2}{\eta}\left(\mathcal{L}\left(\bm{p}\left(0\right) \right)-\mathcal{L}^{*}\right),\] (30)

where the right hand side is upper bounded by a finite constant. This is because, by Assumption A, \(\mathcal{L}\left(\bm{p}\left(0\right)\right)<\infty\) and \(\mathcal{L}^{*}\leq\mathcal{L}\left(\bm{p}\left(t\right)\right)\), where \(\mathcal{L}^{*}\) denotes the minimum objective.

Finally, (30) yields the expression (26).

In the following lemma, we demonstrate the existence of parameters \(\mu=\mu(\bm{\alpha})>0\) and \(R_{\mu}>0\) such that when \(R_{\mu}\) is sufficiently large, there are no stationary points within \(C_{\mu,R_{\mu}}(\bm{p}^{mm})\). Additionally, we provide the local gradient correlation condition.

**Lemma 7** (Local Gradient Condition): _Suppose Assumption A on the loss function \(\ell\) holds. Let \(\bm{\alpha}=(\alpha_{i})_{i=1}^{n}\) be indices of locally-optimal tokens per Definition 2._

**L1**.: _There exists a positive scalar \(\mu=\mu(\bm{\alpha})>0\) such that for sufficiently large \(\bar{R}_{\mu}\), no stationary point exists within \(C_{\mu,R_{\mu}}(\bm{p}^{mm})\), where \(C_{\mu,R_{\mu}}\) is defined in (8)._

**L2**.: _For all \(\bm{q},\bm{p}\in\mathsf{cone}_{\mu}(\bm{p}^{mm})\) with \(\left\|\bm{q}\right\|=\left\|\bm{p}^{mm}\right\|\) and \(\left\|\bm{p}\right\|\geq\bar{R}_{\mu}\) with same \(\bar{R}_{\mu}\) choice as (**L1**.), there exist dataset dependent constants \(C,c>0\) such that_

\[C\cdot\frac{1}{n}\sum_{i\in[n]}\{1-\mathbb{S}(\bm{K}_{i}\bm{p}) _{\alpha_{i}}\}\geq-\left\langle\nabla\mathcal{L}(\bm{p}),\bm{q}\right\rangle \geq c\cdot\frac{1}{n}\sum_{i\in[n]}\{1-\mathbb{S}(\bm{K}_{i}\bm{p})_{\alpha_{ i}}\}>0,\] (31a) \[\left\|\nabla\mathcal{L}(\bm{p})\right\|\leq\bar{A}C\cdot\frac{1} {n}\sum_{i\in[n]}\{1-\mathbb{S}(\bm{K}_{i}\bm{p})_{\alpha_{i}}\}\leq\bar{A} CTe^{-\bar{R}_{\mu}\Theta/2}.\] (31b) \[-\left\langle\frac{\bm{q}}{\left\|\bm{q}\right\|},\frac{\nabla \mathcal{L}(\bm{p})}{\left\|\nabla\mathcal{L}(\bm{p})\right\|}\right\rangle \geq\frac{c\bar{\Theta}}{C\bar{A}}>0,\] (31c)

_Here, \(\bar{A}=\max_{i\in[n],x\in[7]}\left\|\bm{k}_{\mu}-\bm{k}_{\mu}\right\|\) and \(\Theta=1/\left\|\bm{p}^{mm}\right\|\)._

**L3**.: _For any \(\pi>0\), there exists \(R_{\pi}\) such that \(R_{\pi}\geq\bar{R}_{\mu}\) and all \(\bm{p}\in\mathcal{C}_{\mu,R_{\pi}}(\bm{p}^{mm})\) obeys_

\[\left\langle\nabla\mathcal{L}(\bm{p}),\frac{\bm{p}}{\left\|\bm{p}\right\|} \right\rangle\geq(1+\pi)\left\langle\nabla\mathcal{L}(\bm{p}),\frac{\bm{p}^{ mm}}{\left\|\bm{p}^{mm}\right\|}\right\rangle.\]

**Proof.** Let \(\bm{p}^{mm}=\bm{p}^{mm}(\bm{\alpha})\) be the solution of (ATT-SVM). Recall

\[C_{\mu,\bar{R}_{\mu}}(\bm{p}^{mm})=\mathsf{cone}_{\mu}(\bm{p}^{mm})\bigcap \left\{\bm{p}\,\left\|\,\left\|\bm{p}\right\|\geq\bar{R}_{\mu}\right\}.\]Let \((\mathcal{T}_{i})_{i=1}^{n}\) be the sets of all SVM-neighbors per Definition 2. Let \(\bar{\mathcal{T}}_{i}=[T]-\mathcal{T}_{i}-\{\alpha_{i}\}\) be the set of non-SVM-neighbor tokens, \(i\in[n]\). Let

\[\Theta=1/\|\bm{p}^{\mathrm{mm}}\|,\] \[\delta=0.5\min_{i\in[n]}\min_{t\in\mathcal{T}_{i},\tau\in\bar{ \mathcal{T}}_{i}}(\bm{k}_{it}-\bm{k}_{it})^{\top}\bm{p}^{\mathrm{mm}},\] \[A=\max_{i\in[n],i\in[T]}\|\bm{k}_{it}\|/\Theta,\] (32) \[\mu\leq\mu(\delta)=\frac{1}{8}\left(\frac{\min(0.5,\delta)}{A} \right)^{2}.\]

When \(\bar{\mathcal{T}}_{i}=\emptyset\) for all \(i\in[n]\) (i.e. globally-optimal indices), we set \(\delta=\infty\) as all non-neighbor related terms will disappear. Since \(\bm{p}^{\mathrm{mm}}\) is the max-margin model ensuring \((\bm{k}_{it}-\bm{k}_{it})^{\top}\bm{p}^{\mathrm{mm}}\geq 1\) for all \(i\in[n]\), the following inequalities hold for all \(\bm{q}\in\mathsf{cone}_{\mu}(\bm{p}^{\mathrm{mm}})\), \(\|\bm{q}\|=\|\bm{p}^{\mathrm{mm}}\|\) and all \(i\in[n],t\in\mathcal{T}_{i},\tau\in\bar{\mathcal{T}}_{i}\):

\[(\bm{k}_{it}-\bm{k}_{it})^{\top}\bm{q}\geq\delta>0,\] \[(\bm{k}_{it}-\bm{k}_{it})^{\top}\bm{q}\geq 1+\delta,\] (33) \[3/2\geq(\bm{k}_{it}-\bm{k}_{it})^{\top}\bm{q}\geq 1/2.\]

Here, we used \(\|\bm{q}-\bm{p}^{\mathrm{mm}}\|^{2}/\|\bm{p}^{\mathrm{mm}}\|^{2}\leq 2\mu\) which implies \(\|\bm{q}-\bm{p}^{\mathrm{mm}}\|\leq\sqrt{2\mu}/\Theta\).

**L1.** and **L2.**. Now that the choice of local cone is determined, we need to prove the main claims. We will lower bound \(-\bm{q}^{\top}\nabla\mathcal{L}(\bm{p})\) and establish its strict positivity for \(\|\bm{p}\|\geq R\), where \(R=\bar{R}_{\mu}\). This will show that there is no stationary point as a by product.

Consider any \(\bm{q}\in\mathbb{R}^{d}\) satisfying \(\|\bm{q}\|=\|\bm{p}^{\mathrm{mm}}\|\). To proceed, we write the gradient correlation following (18) and (21)

\[\left\langle\nabla\mathcal{L}(\bm{p}),\bm{q}\right\rangle=\frac{1}{n}\sum_{i= 1}^{n}\ell_{i}^{\prime}\cdot\left\langle\bm{a}_{i},\mathbb{S}^{\prime}(\bm{a} _{i}^{\prime})\bm{\gamma}_{i}\right\rangle,\] (34)

where we denoted \(\ell_{i}^{\prime}=\ell^{\prime}(Y_{i}\cdot\bm{v}^{\top}\bm{X}_{i}^{\top} \mathbb{S}(\bm{K}_{i}\bm{p}))\), \(\bm{a}_{i}=\bm{K}_{i}\bm{q}\), \(\bm{a}_{i}^{\prime}=\bm{K}_{i}\bm{p}\), \(\bm{s}_{i}=\mathbb{S}(\bm{K}_{i}\bm{p})\).

Using (33), for all \(t\in\mathcal{T}_{i},\tau\in\bar{\mathcal{T}}_{i}\), for all \(\bm{p}\in C_{\mu,R}(\bm{p}^{\mathrm{mm}})\), we have that

\[\bm{a}_{it_{1}}^{\prime}-\bm{a}_{it}^{\prime}\geq R\Theta(1+\delta),\quad \text{and}\quad\bm{a}_{it}^{\prime}-\bm{a}_{it}^{\prime}\geq R\Theta\delta.\]

Consequently, we can bound the softmax probabilities \(\bm{s}_{i}=\mathbb{S}(\bm{K}_{i}\bm{p})\) as follows: For all \(i\in[n]\),

\[S_{i}:=\sum_{\tau\in\bar{\mathcal{T}}_{i}}\bm{s}_{it}\leq 1-\bm{s}_{ i\alpha_{i}}=\sum_{t\neq\alpha_{i}}\bm{s}_{it}\leq Te^{-R\Theta/2}\bm{s}_{i \alpha_{i}}\leq Te^{-R\Theta/2},\] \[Q_{i}:=\sum_{\tau\in\bar{\mathcal{T}}_{i}}\bm{s}_{it}\leq Te^{-R \Theta\delta}\bm{s}_{i\alpha_{i}}\leq Te^{-R\Theta\delta}\bm{S}_{i},\ \ \forall t_{i}\in\mathcal{T}_{i}.\] (35)

Recall scores \(\bm{\gamma}_{it}=Y_{i}\cdot\bm{v}^{\top}\bm{x}_{it}\). Define the score gaps over neighbors:

\[\gamma_{i}^{\mathrm{gap}}=\bm{\gamma}_{i\alpha_{i}}-\max_{t\in\mathcal{T}_{i}} \bm{\gamma}_{it},\ \ \text{and}\ \ \ \tilde{\gamma}_{i}^{\mathrm{gap}}=\bm{\gamma}_{i\alpha_{i}}-\min_{t\in\mathcal{T}_ {i}}\bm{\gamma}_{it}.\]

It follows from (32) that

\[A=\max_{i\in[n],i\in[n]}\|\bm{k}_{it}\|/\Theta\geq\max_{i\in[n],i\in[n]}\| \bm{a}_{it}\|=\|\bm{k}_{it}\bm{q}\|.\]

Define the \(\bm{\alpha}\)-dependent global scalar \(\Gamma=\sup_{i\in[n],i\in[n]}\|\bm{\gamma}_{it}-\bm{\gamma}_{it}\|\). Let us focus on a fixed datapoint \(i\in[n]\), assume (without losing generality) \(\alpha_{i}=1\), and drop subscripts \(i\), that is, \(\alpha:=\alpha_{i}=1\), \(\bm{X}:=\bm{X}_{i}\), \(Y:=Y_{i}\), \(\bm{K}:=\bm{K}_{i}\), \(\bm{a}^{\prime}=\bm{K}\bm{p}\), \(\bm{a}=\bm{K}\bm{q}\), \(\bm{s}=\mathbb{S}(\bm{K}\bm{p})\), \(\bm{\gamma}=Y\cdot\bm{X}\bm{v}\), \(\gamma^{\mathrm{gap}}:=\gamma_{i}^{\mathrm{gap}}\), \(\gamma^{\mathrm{gap}}:=\gamma_{i}^{\mathrm{gap}}\), \(Q:=Q_{i}\), and \(S:=S_{i}\). Directly applying Lemma 3, we obtain

\[\left|\bm{a}^{\top}\mathrm{diag}(\bm{s})\bm{\gamma}-\bm{a}^{\top}\bm{s}\bm{s}^{ \top}\bm{\gamma}-\sum_{t\geq 2}^{T}(\bm{a}_{1}-\bm{a}_{t})\bm{s}_{t}(\bm{\gamma}_{1}-\bm{ \gamma}_{t})\right|\leq 2\Gamma A(1-\bm{s}_{1})^{2}.\]

To proceed, let us decouple the non-neighbors within \(\sum_{t\geq 2}^{T}(\bm{a}_{1}-\bm{a}_{t})\bm{s}_{t}(\bm{\gamma}_{1}-\bm{\gamma} _{t})\) via

\[\big{|}\sum_{t\in\bar{\mathcal{T}}}(\bm{a}_{1}-\bm{a}_{t})\bm{s}_{t}(\bm{\gamma} _{1}-\bm{\gamma}_{t})\big{|}\leq 2Q\Gamma A.\]Aggregating these, we found

\[\left|\bm{a}^{\top}\mathrm{diag}(\bm{s})\bm{\gamma}-\bm{a}^{\top}\bm{s}s^{\top} \bm{\gamma}-\sum_{t\in\mathcal{T}_{i}}(\bm{a}_{1}-\bm{a}_{t})\bm{s}_{i}(\bm{ \gamma}_{1}-\bm{\gamma}_{t})\right|\leq 2\Gamma A((1-\bm{s}_{1})^{2}+Q).\] (36)

To proceed, let us upper/lower bound the gradient correlation. We use two bounds depending on \(\bm{q}\in\mathsf{cone}_{\mu}(\bm{p}^{\mathrm{mm}})\) (Case 1) or general \(\bm{q}\in\mathbb{R}^{d}\) (Case 2).

\(\bullet\) Case 1: \(\bm{q}\in\mathsf{cone}_{\mu}(\bm{p}^{\mathrm{mm}})\). Since \(1.5\geq\bm{a}_{1}-\bm{a}_{t}\geq 0.5\) following (33), we find

\[1.5\cdot S\cdot\tilde{\gamma}^{\mathrm{gap}}\geq\sum_{t\in\mathcal{T}_{i}}( \bm{a}_{1}-\bm{a}_{t})\bm{s}_{i}(\bm{\gamma}_{1}-\bm{\gamma}_{t})\geq 0.5 \cdot S\cdot\gamma^{\mathrm{gap}}.\]

Next we claim that \(S\) dominates \(((1-\bm{s}_{1})^{2}+Q)\) for large \(R\). Specifically, we wish for

\[S\cdot\gamma^{\mathrm{gap}}/4\geq 4\Gamma A\max((1-\bm{s}_{1})^{2},Q)\iff S \geq 16\frac{\Gamma A}{\gamma^{\mathrm{gap}}}\max((1-\bm{s}_{1})^{2},Q).\] (37)

Now choose \(R\geq\delta^{-1}\log(T)/\Theta\) to ensure \(Q\leq S\) since \(Q\leq Te^{-R\Theta\delta}S\). Consequently

\[(1-\bm{s}_{1})^{2}=(Q+S)^{2}\leq 4S^{2}\leq 4STe^{-R\Theta/2}.\]

Combining these, what we wish is ensured by guaranteeing

\[S\geq 16\frac{\Gamma A}{\gamma^{\mathrm{gap}}}\max(4STe^{-R\Theta/2},Te^{-R \Theta\delta}S).\] (38)

This in turn is ensured for all inputs \(i\in[n]\) by choosing

\[R=\frac{\max(2,\delta^{-1})}{\Theta}\log\left(\frac{64T\Gamma A}{\gamma^{ \mathrm{gap}}_{\mathrm{min}}}\right),\] (39)

where \(\gamma^{\mathrm{gap}}_{\mathrm{min}}=\min_{i\in[n]}\gamma^{\mathrm{gap}}_{i}\) is the global scalar which is the worst case score gap over all inputs. With the above choice of \(R\) we guaranteed

\[2(1-\bm{s}_{1})\cdot\tilde{\gamma}^{\mathrm{gap}}\geq 2\cdot S\cdot\tilde{ \gamma}^{\mathrm{gap}}\geq\bm{a}^{\top}\mathrm{diag}(\bm{s})\bm{\gamma}-\bm{ a}^{\top}\bm{s}\bm{s}^{\top}\bm{\gamma}\geq\frac{S\cdot\gamma^{\mathrm{gap}}}{4} \geq\frac{(1-\bm{s}_{1})\gamma^{\mathrm{gap}}}{8}.\]

Since this holds over all inputs, going back to the gradient correlation (34) and averaging above over all inputs \(i\in[n]\) and plugging back the indices \(i\), we obtain the advertised bound by setting \(q_{i}=1-\bm{s}_{i\alpha_{i}}\) (where we set \(\alpha_{i}=1\) above without losing generality)

\[\frac{2}{n}\sum_{i\in[n]}-\ell_{i}^{\prime}\cdot q_{i}\cdot\tilde{\gamma}_{i} ^{\mathrm{gap}}\geq-\langle\nabla\mathcal{L}(\bm{p}),\bm{q}\rangle\geq\frac{1 }{8n}\sum_{i\in[n]}-\ell_{i}^{\prime}\cdot q_{i}\cdot\gamma_{i}^{\mathrm{gap}}.\] (40)

Let \(-\ell_{\min/\max}^{\prime}\) be the \(\min/\max\) values negative loss derivative admits over the ball \([-B,B]\) for \(B=\|\nu\|\cdot\max_{i,t}\|\bm{x}_{ii}\|\) and note that \(\max_{i\in[n]}\tilde{\gamma}_{i}^{\mathrm{gap}}>0\) and \(\min_{i\in[n]}\gamma_{i}^{\mathrm{gap}}>0\) are dataset dependent constants. Then, we declare the constants \(C=-2\ell_{\max}^{\prime}\cdot\max_{i\in[n]}\tilde{\gamma}_{i}^{\mathrm{gap}}>0\), \(c=-(1/8)\ell_{\min}^{\prime}\cdot\min_{i\in[n]}\gamma_{i}^{\mathrm{gap}}>0\) to obtain the bound

\[\frac{C}{n}\sum_{i\in[n]}q_{i}\geq-\langle\nabla\mathcal{L}(\bm{p}),\bm{q} \rangle\geq\frac{c}{n}\sum_{i\in[n]}q_{i},\] (41)

which is the desired statement in (31a).

\(\bullet\) Case 2: \(\bm{q}\in\mathbb{R}^{d}\) and \(\|\bm{q}\|=\|\bm{p}^{\mathrm{mm}}\|\). Define \(\tilde{A}=\max_{i\in[n],t,\in[T]}\|\bm{k}_{ii}-\bm{k}_{ii}\|\). For any \(\|\bm{q}\|=\|\bm{p}^{\mathrm{mm}}\|\), we use the fact that

\[\|\bm{a}_{1}-\bm{a}_{t}\|\leq\|\bm{k}_{1}-\bm{k}_{t}\|\cdot\|\bm{q}\|\leq\frac {\tilde{A}}{\Theta}.\]

Note that by definition \(\frac{\tilde{A}}{\Theta}\geq 1\). To proceed, we can upper bound

\[\frac{\tilde{A}}{\Theta}\cdot S\cdot\tilde{\gamma}^{\mathrm{gap}}\geq\sum_{t \in\mathcal{T}}(\bm{a}_{1}-\bm{a}_{t})\bm{s}_{t}(\bm{\gamma}_{1}-\bm{\gamma}_{ t}).\] (42)By choosing the same \(R\) as in (39) to ensure \(S\) dominates (\((1-s_{1})^{2}+Q\)) and since \(\frac{\tilde{A}}{\Theta}\geq 1\), we guaranteed

\[\frac{2\tilde{A}}{\Theta}\cdot S\cdot\tilde{\gamma}^{gap}\geq\bm{a}^{\top}\mathrm{ diag}(\bm{s})\bm{\gamma}-\bm{a}^{\top}\bm{s}\bm{s}^{\top}\bm{\gamma}.\]

Going back to the gradient correlation (34) and averaging above over all inputs \(i\in[n]\), with the same definition of \(C>0\), we obtain

\[\frac{\tilde{A}C}{\Theta n}\sum_{i\in[n]}q_{i}\geq-\langle\nabla\mathcal{L}( \bm{p}),\bm{q}\rangle\,.\] (43)

To proceed, since (43) holds for any \(\bm{q}\in\mathbb{R}^{d}\) and \(\|\bm{q}\|=\|\bm{p}^{mm}\|\), we observe that when choosing \(\bm{q}=\frac{\|\bm{p}^{mm}\|}{\|\nabla\mathcal{L}(\bm{p})\|}\cdot\nabla \mathcal{L}(\bm{p})\), this implies that

\[\langle\nabla\mathcal{L}(\bm{p}),\bm{q}\rangle=\|\nabla\mathcal{L}(\bm{p})\| \cdot\|\bm{p}^{mm}\|\leq\frac{\tilde{A}C}{\Theta n}\sum_{i\in[n]}q_{i}.\]

Simplifying \(\Theta=1/\|\bm{p}^{mm}\|\) on both sides yields (31b). Incorporating (35) in the bound above provides the exponential upper bound that decay with \(R\).

Combining this with (41), we obtain that for all \(\bm{q},\bm{p}\in\mathsf{cone}_{\mu}(\bm{p}^{mm})\) and \(\|\bm{q}\|\geq\tilde{R}_{\mu}\)

\[-\left\langle\frac{\bm{q}}{\|\bm{q}\|},\frac{\nabla\mathcal{L}(\bm{p})}{\| \nabla\mathcal{L}(\bm{p})\|}\right\rangle\geq\frac{c\Theta}{C\tilde{A}}.\]

This gives the desired result in (31c).

### Establishing gradient correlation.

Our final goal is establishing gradient comparison between \(\bm{p},\bm{p}^{mm}\) for the same choice of \(\mu>0\) provided in (32). Define \(\bm{\bar{p}}=\|\bm{p}^{mm}\|\bm{p}/\|\bm{p}\|\) to be the normalized vector. Set notations \(\bm{a}_{i}=\bm{K}_{i}\bm{\bar{p}}\), \(\bm{\bar{a}}_{i}=\bm{K}_{i}\bm{p}^{mm}\), and \(\bm{\gamma}_{i}=\bm{Y}_{i}\cdot\bm{\bar{X}}_{i}\bm{v}\).

To establish the result, using (34), we will prove that, for any \(\pi>0\), there is sufficiently large \(R=R_{\pi}\) such that for any \(\bm{p}\in\mathcal{C}_{\mu,R}(\bm{p}^{mm})\):

\[\left\langle-\nabla\mathcal{L}(\bm{p}),\frac{\bm{p}}{\|\bm{p}\|}\right\rangle =-\frac{1}{n}\sum_{i=1}^{n}\ell_{i}^{\prime}\cdot\langle\bm{a}_{i },\mathbb{S}^{\prime}(\bm{K}_{i}\bm{p})\bm{\gamma}_{i}\rangle\] \[\leq-\frac{1+\pi}{n}\sum_{i=1}^{n}\ell_{i}^{\prime}\cdot\langle \bm{\bar{a}}_{i},\mathbb{S}^{\prime}(\bm{K}_{i}\bm{p})\bm{\gamma}_{i}\rangle=( 1+\pi)\left\langle-\nabla\mathcal{L}(\bm{p}),\frac{\bm{p}^{mm}}{\|\bm{p}^{mm} \|}\right\rangle.\] (44)

Following (36), for all \(i\in[n]\), for all \(\bm{q}\in\mathsf{cone}_{\mu}(\bm{p}^{mm})\) with \(\|\bm{q}\|=\|\bm{p}^{mm}\|\), \(\bm{a}^{\prime}=\bm{K}\bm{q}\) and \(\bm{s}=\mathbb{S}(\bm{K}\bm{p})\), we have found

\[\left|\bm{a}_{i}^{\top}\mathrm{diag}(\bm{s}_{i})\bm{\gamma}-\bm{a}_{i}^{\top} \bm{s}_{i}\bm{s}_{i}^{\top}\bm{\gamma}_{i}-\sum_{i\in\mathcal{T}_{i}}(\bm{a }_{i1}^{\prime}-\bm{a}_{i\prime}^{\prime})\bm{s}_{i\prime}(\bm{\gamma}_{i1}- \bm{\gamma}_{i\prime})\right|\leq 2\Gamma A((1-\bm{s}_{i1})^{2}+Q_{i}).\] (45)

Plugging in \(\bm{a}_{i},\bm{\bar{a}}_{i}\) in the bound above and assuming \(\pi\leq 1\) (w.l.o.g.), (44) is implied by the following stronger inequality

\[-\frac{1}{n}\sum_{i=1}^{n}\ell_{i}^{\prime}\cdot\left(6\Gamma A( (1-\bm{s}_{i1})^{2}+Q_{i})+\sum_{i\in\mathcal{T}_{i}}(\bm{a}_{i1}-\bm{a}_{i \prime})\bm{s}_{i\prime}(\bm{\gamma}_{i1}-\bm{\gamma}_{i\prime})\right)\] \[\quad\leq-\frac{1+\pi}{n}\sum_{i=1}^{n}\ell_{i}^{\prime}\cdot \sum_{i\in\mathcal{T}_{i}}(\bm{\bar{a}}_{i1}-\bm{\bar{a}}_{i\prime})\bm{s}_{i \prime}(\bm{\gamma}_{i1}-\bm{\gamma}_{i\prime})\] \[\quad=-\frac{1+\pi}{n}\sum_{i=1}^{n}\ell_{i}^{\prime}\cdot\sum_{i \in\mathcal{T}_{i}}\bm{s}_{i\prime}(\bm{\gamma}_{i1}-\bm{\gamma}_{i\prime}).\]

First, we claim that \(0.5\pi\sum_{i\in\mathcal{T}_{i}}\bm{s}_{i\prime}(\bm{\gamma}_{i1}-\bm{\gamma}_{ i\prime})\geq 6\Gamma A((1-\bm{s}_{i1})^{2}+Q_{i})\) for all \(i\in[n]\). The proof of this claim directly follows the earlier argument, namely, following (37), (38) and (39) which leads to the choice

\[R\geq\frac{\max(2,\delta^{-1})}{\Theta}\log\left(\frac{C_{0}\cdot T\Gamma A}{ \pi\gamma_{\min}^{gap}}\right),\] (46)for some constant \(C_{0}>0\). Here, we choose sufficiently large \(C_{0}\geq 64\pi\) to ensure \(R=R_{\pi}\geq\bar{R}_{\mu}\).

Following this control over the perturbation term \(6\Gamma A((1-\bm{s}_{i1})^{2}+Q_{i})\), to conclude with the result, what remains is proving the comparison

\[-\frac{1}{n}\sum_{i=1}^{n}\ell_{i}^{\prime}\cdot\sum_{t\in\mathcal{T}_{i}}( \bm{a}_{i1}-\bm{a}_{i2})\bm{s}_{it}(\bm{\gamma}_{i1}-\bm{\gamma}_{it})\leq- \frac{1+0.5\pi}{n}\sum_{i=1}^{n}\ell_{i}^{\prime}\cdot\sum_{t\in\mathcal{T}_{i }}\bm{s}_{it}(\bm{\gamma}_{i1}-\bm{\gamma}_{it}).\] (47)

To proceed, we split the problem into two scenarios.

**Scenario 1:**\(\|\bm{\bar{p}}-\bm{p}^{mm}\|\leq\epsilon=\frac{\pi}{44\Theta}\) for some \(\epsilon>0\). In this scenario, for any token, we find that

\[|\bm{a}_{it}-\bm{\bar{a}}_{i}|=|\bm{k}_{it}^{\top}(\bm{\bar{p}}-\bm{p}^{mm})| \leq A\Theta\epsilon=\pi/4.\]

Consequently, we obtain

\[\bm{a}_{i1}-\bm{a}_{it}\leq\bm{\bar{a}}_{i1}-\bm{\bar{a}}_{it}+2A\Theta \epsilon=1+0.5\pi.\]

Similarly, \(\bm{a}_{i1}-\bm{a}_{it}\geq 1-0.5\pi\geq 0.5\). Since all terms \(\bm{a}_{i1}-\bm{a}_{it},\bm{s}_{it},\bm{\gamma}_{i1}-\bm{\gamma}_{it}\) in (47) are nonnegative and \((\bm{a}_{i1}-\bm{a}_{it})\bm{s}_{it}(\bm{\gamma}_{i1}-\bm{\gamma}_{it})\leq(1 +0.5\pi)\bm{s}_{it}(\bm{\gamma}_{i1}-\bm{\gamma}_{it})\), above implies the desired result (47).

**Scenario 2:**\(\|\bm{\bar{p}}-\bm{p}^{mm}\|\geq\epsilon=\frac{\pi}{44\Theta}\). Since \(\bm{\bar{p}}\) is not (locally) max-margin, in this scenario, for some \(i\in[n]\), \(\nu=\nu(\epsilon)>0\), and \(\tau\in\mathcal{T}_{i}\), we have that

\[\bm{\bar{p}}^{\top}(\bm{k}_{i1}-\bm{k}_{ir})=\bm{a}_{i1}-\bm{a}_{ir}\leq 1-2\nu.\]

Here \(\tau=\arg\max_{t\in\mathcal{T}_{i}}\bm{\bar{p}}^{\top}\bm{k}_{it}\) denotes the nearest point to \(\bm{k}_{1}\) (along the \(\bm{\bar{p}}\) direction). Note that a non-neighbor \(t\in\mathcal{T}_{i}\) cannot be nearest because \(\bm{\bar{p}}\in\mathsf{cone}_{i}(\bm{p}^{mm})\) and (33) holds. Recall that \(\bm{s}_{i}=\mathbb{S}(R\bm{a}_{i})\) where \(R=\|\bm{p}\|\Theta\geq R\Theta\). To proceed, let \(\underline{\bm{a}}_{i}:=\min_{t\in\mathcal{T}_{i}}\bm{a}_{i1}-\bm{a}_{it}\),

\[\mathcal{I}:=\left\{i\in[n]:\underline{\bm{a}}_{i}\leq 1-2\nu\right\},\qquad[n]- \mathcal{I}:=\left\{i\in[n]:1-2\nu<\underline{\bm{a}}_{i}\right\}.\]

For all \(i\in[n]-\mathcal{I}\),

\[\sum_{i\in\mathcal{T}_{i}}(\bm{a}_{i1}-\bm{a}_{it})\bm{s}_{it}( \bm{\gamma}_{i1}-\bm{\gamma}_{it}) -(1+0.5\pi)\sum_{t\in\mathcal{T}_{i}}\bm{s}_{it}(\bm{\gamma}_{i1} -\bm{\gamma}_{it})\] (48) \[\leq(2A-(1+0.5\pi))\,\Gamma\sum_{t\in\mathcal{T}_{i},\ \bm{a}_{it}-\bm{a}_{it}\geq 1+\frac{\pi}{2}}\bm{s}_{it}\] \[\leq(2A-(1+0.5\pi))\,\Gamma Te^{-\bar{R}(1+\frac{\pi}{2})}\] \[\leq 2A\Gamma Te^{-\bar{R}(1+\frac{\pi}{2})}.\]

For all \(i\in\mathcal{I}\), split the tokens into two groups: Let \(\mathcal{N}_{i}\) be the group of tokens obeying \(\bm{a}_{i1}-\bm{a}_{it}\leq 1-\nu\) and \(\mathcal{T}_{i}-\mathcal{N}_{i}\) be the rest of the neighbors. Observe that

\[\frac{\sum_{t\in\mathcal{T}_{i}-\mathcal{N}_{i}}\bm{s}_{it}}{\sum_{t\in \mathcal{T}_{i}}\bm{s}_{it}}\leq T\,\frac{e^{\nu\bar{R}}}{e^{2\nu\bar{R}}}=Te^ {-\bar{R}\nu}.\]

Thus, using \(|\bm{a}_{i1}-\bm{a}_{it}|\leq 2A\) and recalling the definition of \(\gamma_{\min}^{\text{gap}}\), observe that

\[\sum_{t\in\mathcal{T}_{i}-\mathcal{N}_{i}}(\bm{a}_{i1}-\bm{a}_{it})\bm{s}_{it}( \bm{\gamma}_{i1}-\bm{\gamma}_{it})\leq\frac{2\Gamma ATe^{-\bar{R}\nu}}{\gamma_ {\min}^{\text{gap}}}\sum_{t\in\mathcal{T}_{i}}\bm{s}_{it}(\bm{\gamma}_{i1}- \bm{\gamma}_{it}).\]

Thus,

\[\sum_{t\in\mathcal{T}_{i}}(\bm{a}_{i1}-\bm{a}_{it})\bm{s}_{it}( \bm{\gamma}_{i1}-\bm{\gamma}_{it}) =\sum_{t\in\mathcal{N}_{i}}(\bm{a}_{i1}-\bm{a}_{it})\bm{s}_{it}( \bm{\gamma}_{i1}-\bm{\gamma}_{it})+\sum_{t\in\mathcal{T}_{i}-\mathcal{N}_{i}}( \bm{a}_{i1}-\bm{a}_{it})\bm{s}_{it}(\bm{\gamma}_{i1}-\bm{\gamma}_{it})\] \[\leq\sum_{t\in\mathcal{N}_{i}}(1-\nu)\bm{s}_{it}(\bm{\gamma}_{i1} -\bm{\gamma}_{it})+\frac{2\Gamma ATe^{-\bar{R}\nu}}{\gamma_{\min}^{\text{gap}}} \sum_{t\in\mathcal{T}_{i}}\bm{s}_{it}(\bm{\gamma}_{i1}-\bm{\gamma}_{it})\] \[\leq\left(1-\nu+\frac{2\Gamma ATe^{-\bar{R}\nu}}{\gamma_{\min}^{ \text{gap}}}\right)\sum_{t\in\mathcal{T}_{i}}\bm{s}_{it}(\bm{\gamma}_{i1}-\bm{ \gamma}_{it})\] \[\leq\left(1+\frac{2\Gamma ATe^{-\bar{R}\nu}}{\gamma_{\min}^{\text{gap} }}\right)\sum_{t\in\mathcal{T}_{i}}\bm{s}_{it}(\bm{\gamma}_{i1}-\bm{\gamma}_{it}).\]Hence, choosing

\[R\geq\frac{1}{\nu\Theta}\log\left(\frac{8\Gamma AT}{\gamma_{\min}^{ \mathrm{gap}}\pi}\right)\] (49)

results in that

\[\sum_{t\in\mathcal{T}_{i}}(\bm{a}_{i1}-\bm{a}_{it})s_{it}(\bm{ \gamma}_{i1}-\bm{\gamma}_{it})-(1+\frac{\pi}{2})\sum_{t\in\mathcal{T}_{i}}\bm{s }_{it}(\bm{\gamma}_{i1}-\bm{\gamma}_{it})\] (50) \[\leq \left(\frac{2\Gamma ATe^{-\tilde{R}t}}{\gamma_{\min}^{\mathrm{ gap}}}-\frac{\pi}{2}\right)\sum_{t\in\mathcal{T}_{i}}\bm{s}_{it}(\bm{\gamma}_{i1}-\bm{ \gamma}_{it})\] \[\leq -\frac{\pi}{4}\sum_{t\in\mathcal{T}_{i}}\bm{s}_{it}(\bm{\gamma}_{ i1}-\bm{\gamma}_{it})\] \[\leq -\frac{\pi}{4T}\gamma_{\min}^{\mathrm{gap}}e^{-\tilde{R}(1-2\nu)}.\]

Here, the last inequality follows from the fact that \(\sum_{t\in\mathcal{T}_{i}}s_{it}\geq\max_{t\in\mathcal{T}_{i}}s_{it}\geq\frac {e^{-\tilde{R}(1-2\nu)}}{\sum_{t=1}^{T}e^{-\tilde{R}(1-2\nu)}}\geq e^{-\tilde{ R}(1-2\nu)}/T\). From Assumption A, we have \(c_{\min}\leq-\ell^{\prime}\leq c_{\max}\) for some positive constants \(c_{\min}\) and \(c_{\max}\). It follows from (48) and (50) that

\[-\frac{1}{n}\sum_{i}^{n}\ell^{\prime}_{i} \left(\sum_{t\in\mathcal{T}_{i}}(\bm{a}_{i1}-\bm{a}_{it})\bm{s}_{it }(\bm{\gamma}_{i1}-\bm{\gamma}_{it})-\sum_{t\in\mathcal{T}_{i}}(1+0.5\pi)s_{it }(\bm{\gamma}_{i1}-\bm{\gamma}_{it})\right)\] \[\leq c_{\max}2A\Gamma T\epsilon^{-\tilde{R}(1+\frac{\pi}{2})}- \frac{c_{\min}}{nT}\cdot\frac{\pi\gamma_{\min}^{\mathrm{gap}}}{4}e^{-\tilde{R }(1-2\nu)}\] \[\leq 0.\]

Combing with (49), this is guaranteed by choosing

\[R\geq\max\left\{\frac{1}{\nu\Theta}\log\left(\frac{8\Gamma AT}{ \gamma_{\min}^{\mathrm{gap}}\pi}\right),\frac{1}{(2\nu+\pi/2)\Theta}\log\left( \frac{8n\Gamma AT^{2}c_{\max}}{c_{\min}\gamma_{\min}^{\mathrm{gap}}\pi}\right) \right\},\]

where \(\nu=\nu(\frac{\pi}{4A\Theta})\) depends only on \(\pi\) and global problem variables.

Combining this with the prior \(R\) choice (46) (by taking maximum), we conclude with the statement.

### Proof of Theorem 1

**Proof.** This proof is a direct corollary of Lemma 14 which itself is a special case of the nonlinear head Theorem 8. Let us verify that \(f(\bm{X})=\bm{v}^{\top}\bm{X}^{\top}\mathbb{S}(\bm{X}\bm{p})\) satisfies the assumptions of Lemma 14 where we replace the nonlinear head with linear \(\bm{v}\). To see this, set the optimal sets to be the singletons \(\mathcal{O}_{i}=\{\mathsf{opt}_{i}\}\). Given \((\bm{X}_{i},\bm{Y}_{i})\), let \(\bm{s}_{i}=\mathbb{S}(\bm{K}_{i}\bm{p})\) and \(q_{i}=q_{i}^{\bm{p}}=\sum_{t\in\mathsf{opt}_{i}}\bm{s}_{it}\). Recalling score definition \(\bm{\gamma}_{i}=\bm{Y}_{i}\cdot\bm{X}_{i}\bm{v}\) and setting \(\bm{\gamma}_{i}:=\bm{\gamma}_{\mathsf{opt}_{i}}\) and \(\bm{Z}_{i}:=\sum_{t\in\mathsf{opt}_{i}}\bm{\gamma}_{it}s_{it}\), a particular prediction can be written as

\[Y_{i}\cdot\bm{v}^{\top}\bm{X}_{i}^{\top}\mathbb{S}(\bm{X}_{i}\bm{ p}) =\bm{\gamma}_{i}^{\top}s_{i}=\bm{\gamma}_{i\mathsf{opt}_{i}}(1-q_{i })+\sum_{t\in\mathsf{opt}_{i}}\bm{\gamma}_{it}\bm{s}_{it}\] \[=\nu_{i}(1-q_{i})+Z_{i}.\]

To proceed, we demonstrate the choices for \(\mathcal{C},\epsilon>0\). Let \(\mathcal{C}:=-\min_{i\in[n],\epsilon[T]}\bm{\gamma}_{it}\wedge 0\) and \(q_{\max}=\max_{i\in[n]}q_{i}\). Note that \(Z_{i}\geq\sum_{t\in\mathsf{opt}_{i}}\bm{\gamma}_{it}s_{it}\geq q_{i}\bm{ \gamma}_{\min}\geq-Cq_{\max}\). Now, using strict score optimality of \(\mathsf{opt}_{i}\)'s for all \(i\in[n]\), we set

\[\epsilon:=1-\sup_{i\in[n]}\frac{\sum_{t\in[n]}\frac{\sum_{t\in \mathsf{opt}_{i}}\bm{\gamma}_{it}s_{it}}{\nu_{i}q_{i}}}{\geq 1-\sup_{i\in[n]} \frac{\sup_{t\in\mathsf{opt}_{i}}\bm{\gamma}_{it}}{\bm{\gamma}_{i\mathsf{opt}_{ i}}}}>0.\]

We conclude by observing \(Z_{i}\leq\nu_{i}q_{i}\frac{\sum_{t\in\mathsf{opt}_{i}}\bm{\gamma}_{it}s_{it}}{ \nu_{i}q_{i}}\leq\nu_{i}q_{i}\epsilon\) as desired.

### Proof of Theorem 2

Proof.: We first show that \(\lim_{t\to\infty}\|\bm{p}\left(t\right)\|=\infty\). From Lemma 4, we have

\[\left\langle\nabla\mathcal{L}(\bm{p}),\bm{p}^{mm\star}\right\rangle=\frac{1}{n} \sum_{t=1}^{n}\ell^{\prime}(Y_{i}\cdot\bm{v}^{\top}\bm{X}_{i}^{\top}\mathbb{S}( \bm{K}_{i}\bm{p}))\cdot\left\langle\bm{K}_{i}\bm{p}^{mm\star},\mathbb{S}^{ \prime}(\bm{a}_{i})\bm{\gamma}_{i}\right\rangle,\]

where \(\bm{\gamma}_{i}=Y_{i}\cdot\bm{X}_{i}\bm{v}\) and \(\bm{a}_{i}=\bm{K}_{i}\bm{p}\).

It follows from Lemma 4 that \(\left\langle\nabla\mathcal{L}(\bm{p}),\bm{p}^{mm\star}\right\rangle<0\) for all \(\bm{p}\in\mathbb{R}^{d}\). Hence, for any finite \(\bm{p}\), \(\left\langle\nabla\mathcal{L}(\bm{p}),\bm{p}^{mm\star}\right\rangle\) cannot be equal to zero, as a sum of negative terms. Therefore, there are no finite critical points \(\bm{p}\), for which \(\nabla\mathcal{L}(\bm{p})=0\). On the other hand, Lemma 6 states \(\nabla\mathcal{L}(\bm{p}(t))\to 0\) which implies that \(\|\bm{p}\left(t\right)\|\to\infty\).

Next, we provide the directional convergence for the setting \(n=1\). Let us consider an arbitrary value of \(\epsilon\in(0,1)\) and set \(\pi=\epsilon/(1-\epsilon)\). As \(\lim_{t\to\infty}\|\bm{p}(t)\|=\infty\), we can select a specific \(t_{\epsilon}\) such that for all \(t\geq t_{\epsilon}\), it holds that \(\|\bm{p}(t)\|\geq R_{\epsilon}\lor 1/2\) for any choice of \(R_{\epsilon}\). To proceed, we choose \(R_{\epsilon}\) based on Lemma 5 so that for any \(t\geq t_{\epsilon}\), we have that

\[\left\langle-\nabla\mathcal{L}(\bm{p}(t)),\frac{\bm{p}^{mm\star}}{\|\bm{p}^{ mm\star}\|}\right\rangle\geq(1-\epsilon)\left\langle-\nabla\mathcal{L}(\bm{p}(t)), \frac{\bm{p}(t)}{\|\bm{p}(t)\|}\right\rangle.\]

Multiplying both sides by the stepsize \(\eta\) and using the gradient descent update, we get

\[\begin{split}\left\langle\bm{p}(t+1)-\bm{p}(t),\frac{\bm{p}^{ mm\star}}{\|\bm{p}^{mm\star}\|}\right\rangle&\geq(1-\epsilon)\left\langle \bm{p}(t+1)-\bm{p}(t),\frac{\bm{p}(t)}{\|\bm{p}(t)\|}\right\rangle\\ &=\frac{(1-\epsilon)}{2\|\bm{p}(t)\|}\left(\|\bm{p}(t+1)\|^{2}-\| \bm{p}(t)\|^{2}-\|\bm{p}(t+1)-\bm{p}(t)\|^{2}\right)\\ &\geq(1-\epsilon)\left(\frac{1}{2\|\bm{p}(t)\|}\left(\|\bm{p}(t+1) \|^{2}-\|\bm{p}(t)\|^{2}\right)-\|\bm{p}(t+1)-\bm{p}(t)\|^{2}\right)\\ &\geq(1-\epsilon)\left(\|\bm{p}(t+1)\|-\|\bm{p}(t)\|-\|\bm{p}(t+1 )-\bm{p}(t)\|^{2}\right)\\ &\geq(1-\epsilon)\Big{(}\|\bm{p}(t+1)\|-\|\bm{p}(t)\|-2\eta\left( \mathcal{L}(\bm{p}(t))-\mathcal{L}(\bm{p}(t+1))\right)\Big{)}.\end{split}\] (51)

Here, the second inequality is obtained from \(\|\bm{p}(t)\|\geq 1/2\); the third inequality follows since for any \(a,b>0\), we have \((a^{2}-b^{2})/(2b)-(a-b)\geq 0\); and the last inequality uses Lemma 6.

Summing the above inequality over \(t\geq t_{\epsilon}\) gives

\[\left\langle\frac{\bm{p}(t)}{\|\bm{p}(t)\|},\frac{\bm{p}^{mm\star}}{\|\bm{p}^{ mm\star}\|}\right\rangle\geq 1-\epsilon+\frac{C(\epsilon,\eta)}{\|\bm{p}(t)\|},\]

for some finite constant \(C(\epsilon,\eta)\) defined as

\[C(\epsilon,\eta):=\left\langle\bm{p}(t_{\epsilon}),\frac{\bm{p}^{mm\star}}{\| \bm{p}^{mm\star}\|}\right\rangle-(1-\epsilon)\|\bm{p}(t_{\epsilon})\|-2\eta(1 -\epsilon)\left(\mathcal{L}(\bm{p}(t_{\epsilon}))-\mathcal{L}^{*}\right),\] (52)

where \(\mathcal{L}^{*}\) denotes the minimum objective.

Since \(\|\bm{p}\left(t\right)\|\to\infty\), we get

\[\liminf_{t\to\infty}\left\langle\frac{\bm{p}(t)}{\|\bm{p}(t)\|},\frac{\bm{p}^{ mm\star}}{\|\bm{p}^{mm\star}\|}\right\rangle\geq 1-\epsilon.\]

Given that we can choose any value of \(\epsilon\in(0,1)\), we have \(\bm{p}(t)/\|\bm{p}(t)\|\to\bm{p}^{mm\star}/\|\bm{p}^{mm\star}\|\). 

### Proof of Theorem 3

Proof.: Following the proof of Lemma 7, let \((\mathcal{T}_{i})_{i=1}^{n}\) denote the sets of SVM-neighbors as defined in Definition 2. We define \(\bar{\mathcal{T}}_{i}=[T]-\mathcal{T}_{i}-\{\alpha_{i}\}\) as the tokens that are non-SVM neighbors. Additionally, let \(\mu\) be defined as in (32). Let us denote the initialization lower bound as \(R_{\mu}^{0}:=R\), where \(R\) is given in the Theorem 3's statement. Consider an arbitrary value of \(\epsilon\in(0,\mu/2)\) and let \(1/(1+\pi)=1-\epsilon\)We additionally denote \(R_{\epsilon}\gets R_{\pi}\lor 1/2\) where \(R_{\pi}\) was defined in Lemma 7(**L3.3**). At initialization \(\bm{p}(0)\), we set \(\epsilon=\mu/2\) to obtain \(R_{\mu}^{0}=R_{\mu/2}\) and provide the proof in four steps:

**Step 1: There are no stationary points within \(C_{\mu,R_{\rho}^{0}}(\bm{p^{mm}})\).** We begin by proving that there are no stationary points within \(C_{\mu,R_{\rho}^{0}}(\bm{p^{mm}})\). Then, since \(R_{\mu}^{0}\geq R_{\mu}\) per Lemma 7, we can apply (**L.2.**) to find that: For all \(\bm{q},\bm{p}\in\mathsf{cone}_{\mu}(\bm{p^{mm}})\) with \(\bm{q}\neq 0\) and \(\|\bm{p}\|\geq R_{\mu}^{0}\), we have that \(-\bm{q}^{\top}\nabla\mathcal{L}(\bm{p})\) is strictly positive.

**Step 2:** It follows from Lemma 7(**L3.3**) that, for all \(\epsilon\in(0,\mu/2)\), all \(\bm{p}\in C_{\mu,R_{\epsilon}}(\bm{p^{mm}})\) satisfy

\[\left\langle-\nabla\mathcal{L}(\bm{p}),\frac{\bm{p^{mm}}}{\|\bm{p^{mm}}\|} \right\rangle\geq(1-\epsilon)\left\langle-\nabla\mathcal{L}(\bm{p}),\frac{\bm {p}}{\|\bm{p}\|}\right\rangle.\] (53)

The argument above applies to a general \(\epsilon\in(0,\mu/2)\). However, at initialization \(\bm{p}(0)\), we set \(\epsilon=\mu/2\) to obtain our earlier \(R_{\mu}^{0}\) choice. To proceed, for any \(\epsilon\in(0,\mu/2)\), we will show that after gradient descent enters the conic set \(\mathcal{C}_{\mu,R_{\epsilon}}(\bm{p^{mm}})\) for the first time, it will never leave the set. Let \(t_{\epsilon}\) be the first time gradient descent enters \(C_{\mu,R_{\epsilon}}(\bm{p^{mm}})\). In **Step 4**, we will prove that such \(t_{\epsilon}\) is guaranteed to exist. Additionally, for \(\epsilon\leftarrow\mu/2\), note that \(t_{\epsilon}=0\) i.e. the point of initialization.

**Step 3: Updates remain inside the cone \(C_{\mu,R_{\epsilon}}(\bm{p^{mm}})\).** By leveraging the results from **Step 1** and **Step 2**, we demonstrate that the gradient iterates, with an appropriate constant step size, starting from \(\bm{p}(t_{\epsilon})\in C_{\mu,R_{\epsilon}}(\bm{p^{mm}})\), remain within this cone.

We proceed by induction. Suppose that the claim holds up to iteration \(t\geq t_{\epsilon}\). This implies that \(\bm{p}(t)\in C_{\mu,R_{\epsilon}}(\bm{p^{mm}})\). Hence, recalling cone definition, for \(\mu>0\) and \(R_{\epsilon}\), we have \(\left\langle\frac{\bm{p}(t)}{\|\bm{p}(t)\|},\frac{\bm{p^{mm}}}{\|\bm{p^{mm}} \|}\right\rangle\geq 1-\mu\) and \(\|\bm{p}(t)\|\geq R_{\epsilon}\). Let

\[\rho(t):=-\frac{1}{1-\epsilon}\left\langle\nabla\mathcal{L}(\bm{p}(t)),\frac{ \bm{p}^{mm}}{\|\bm{p^{mm}}\|}\right\rangle.\]

Note that \(\rho(t)>0\) due to **Step 1**. This together with the gradient descent update rule gives

\[\left\langle\frac{\bm{p}(t+1)}{\|\bm{p}(t)\|},\frac{\bm{p}^{mm}}{ \|\bm{p}^{mm}\|}\right\rangle =\left\langle\frac{\bm{p}(t)}{\|\bm{p}(t)\|}-\frac{\eta}{\|\bm{p} (t)\|}\nabla\mathcal{L}(\bm{p}(t)),\frac{\bm{p}^{mm}}{\|\bm{p}^{mm}\|}\right\rangle\] (54a) \[\geq 1-\mu-\frac{\eta}{\|\bm{p}(t)\|}\left\langle\nabla\mathcal{L}( \bm{p}(t)),\frac{\bm{p}^{mm}}{\|\bm{p}^{mm}\|}\right\rangle\] \[=1-\mu+\frac{\eta\rho(t)(1-\epsilon)}{\|\bm{p}(t)\|}.\]

Note that from Lemma 7, we have \(\left\langle\nabla\mathcal{L}(\bm{p}(t)),\bm{p}(t)\right\rangle<0\) which implies that \(\|\bm{p}(t+1)\|\geq\|\bm{p}(t)\|\). This together with \(R_{\epsilon}\) definition and \(\|\bm{p}(t)\|\geq 1/2\) implies that

\[\|\bm{p}(t+1)\| \leq\frac{1}{2\|\bm{p}(t)\|}\left(\|\bm{p}(t+1)\|^{2}+\|\bm{p}(t) \|^{2}\right)\] (54b) \[=\frac{1}{2\|\bm{p}(t)\|}\left(2\|\bm{p}(t)\|^{2}-2\eta\left\langle \nabla\mathcal{L}(\bm{p}(t)),\bm{p}(t)\right\rangle+\eta^{2}\|\nabla\mathcal{L }(\bm{p}(t))\|^{2}\right)\] \[\leq\|\bm{p}(t)\|-\frac{\eta}{\|\bm{p}(t)\|}\left\langle\nabla \mathcal{L}(\bm{p}(t)),\bm{p}(t)\right\rangle+\eta^{2}\|\nabla\mathcal{L}( \bm{p}(t))\|^{2}.\]

Hence, using (53)

\[\frac{\|\bm{p}(t+1)\|}{\|\bm{p}(t)\|} \leq 1-\frac{\eta}{\|\bm{p}(t)\|}\left\langle\nabla\mathcal{L}(\bm{ p}(t)),\frac{\bm{p}(t)}{\|\bm{p}(t)\|}\right\rangle+\eta^{2}\frac{\|\nabla \mathcal{L}(\bm{p}(t))\|^{2}}{\|\bm{p}(t)\|}\] (54c) \[\leq 1-\frac{\eta}{(1-\epsilon)\|\bm{p}(t)\|}\left\langle\nabla \mathcal{L}(\bm{p}(t)),\frac{\bm{p}^{mm}}{\|\bm{p}^{mm}\|}\right\rangle+\eta^{2} \frac{\|\nabla\mathcal{L}(\bm{p}(t))\|^{2}}{\|\bm{p}(t)\|}\] \[=1+\frac{\eta\rho(t)}{\|\bm{p}(t)\|}+\frac{\eta^{2}\|\nabla \mathcal{L}(\bm{p}(t))\|^{2}}{\|\bm{p}(t)\|}=:C_{1}(\rho(t),\eta).\]

Here, the second inequality follows from (53).

Now, it follows from (54a) and (54c) that

\[\begin{split}\left\langle\frac{\bm{p}(t+1)}{\|\bm{p}(t+1)\|},\frac{ \bm{p}^{mm}}{\|\bm{p}^{mm}\|}\right\rangle&\geq\frac{1}{C_{1}( \rho(t),\eta)}\left(1-\mu+\frac{\eta\rho(t)(1-\epsilon)}{\|\bm{p}(t)\|}\right) \\ &=1-\mu+\frac{1}{C_{1}(\rho(t),\eta)}\left((1-\mu)(1-C_{1}(\rho(t), \eta))+\frac{\eta\rho(t)(1-\epsilon)}{\|\bm{p}(t)\|}\right)\\ &=1-\mu+\frac{\eta}{C_{1}(\rho(t),\eta)}\left((\mu-1)(\frac{\rho( t)}{\|\bm{p}(t)\|}+\frac{\eta\|\nabla\mathcal{L}(\bm{p}(t))\|^{2}}{\|\bm{p}(t)\|} +\frac{\rho(t)(1-\epsilon)}{\|\bm{p}(t)\|}\right)\\ &=1-\mu+\frac{\eta}{C_{1}(\rho(t),\eta)}\left(\frac{\rho(t)(\mu- \epsilon)}{\|\bm{p}(t)\|}-\eta(1-\mu)\frac{\|\nabla\mathcal{L}(\bm{p}(t))\|^{ 2}}{\|\bm{p}(t)\|}\right)\\ &\geq 1-\mu,\end{split}\] (55)

where the last inequality uses our choice of stepsize \(\eta\leq 1/L_{p}\) in Theorem 3's statement. Specifically, we need \(\eta\) to be small to ensure the last inequality. We will guarantee this by choosing a proper \(R_{\epsilon}\) in Lemma 7. Specifically, Lemma 7 leaves the choice of \(C_{0}\) in \(R_{\epsilon}\) lower bound of (46) open (it can always be chosen larger). Here, by choosing \(C_{0}\gtrsim 1/L_{p}\) will ensure \(\eta\leq 1/L_{p}\) works well.

To proceed, we have that

\[\begin{split}\frac{(\mu-\epsilon)}{1-\mu}\frac{\rho(t)}{\|\nabla \mathcal{L}(\bm{p}(t))\|^{2}}&\geq\frac{\mu-\epsilon}{1-\mu} \frac{1}{1-\epsilon}\frac{c}{C}\frac{\Theta}{\tilde{A}}\frac{1}{\tilde{A}CT}e ^{R_{\epsilon}^{0}\Theta/2}\\ &\geq\frac{\mu-\epsilon}{2(1-\mu)(1-\frac{\mu}{2})}\frac{c}{C} \frac{\Theta}{\tilde{A}}\frac{1}{\tilde{A}CT}e^{R_{\epsilon}^{0}\Theta/2} \geq\eta.\end{split}\] (56)

Here, the second inequality uses our choice of \(\epsilon\in(0,\mu/2)\) (see **Step 2**), and the first inequality is obtained from Lemma 7 since

\[\begin{split}\frac{\rho(t)}{\|\nabla\mathcal{L}(\bm{p}(t))\|}& =-\frac{1}{1-\epsilon}\left\langle\frac{\nabla\mathcal{L}(\bm{p} (t))}{\|\nabla\mathcal{L}(\bm{p}(t))\|},\frac{\bm{p}^{mm}}{\|\bm{p}^{mm}\|} \right\rangle\geq\frac{1}{1-\epsilon}\frac{c}{C}\frac{\Theta}{\tilde{A}},\\ \frac{1}{\|\nabla\mathcal{L}(\bm{p}(t))\|}&\geq\frac{ 1}{AC_{n}^{1}\sum_{i=1}^{n}(1-s_{i\alpha_{i}})}\geq\frac{1}{\tilde{A}CTe^{-R_{ \epsilon}^{0}\Theta/2}}\end{split}\]

for some data dependent constants \(c\) and \(C\), \(\tilde{A}=\max_{i\in[n],t\in[T]}\|\bm{k}_{i}-\bm{k}_{i^{\prime}}\|\), and \(\Theta=1/\|\bm{p}^{mm}\|\).

Next, we will demonstrate that the choice of \(\eta\) in (56) does indeed meet our step size condition as stated in the theorem, i.e., \(\eta\leq 1/L_{p}\). Recall that \(1/(1+\pi)=1-\epsilon\), which implies that \(\pi=\epsilon/(1-\epsilon)\). Combining this with (46), we obtain:

\[\begin{split} R_{\pi}&\geq\frac{\max(2,\delta^{-1} )}{\Theta}\log\left(\frac{C_{0}TTA}{\pi\gamma_{\min}^{gap}}\right),\quad\text{ where}\quad C_{0}\geq 64\pi,\\ &\Rightarrow R_{\epsilon}\geq\frac{\max(2,\delta^{-1})}{\Theta} \log\left(\frac{(1-\epsilon)C_{0}TTA}{\epsilon\gamma_{\min}^{gap}}\right), \quad\text{where}\quad C_{0}\geq 64\frac{\epsilon}{1-\epsilon}.\end{split}\]

On the other hand, at the initialization, we have \(\epsilon=\mu/2\) which implies that

\[R_{\mu}^{0}\geq\frac{\max(2,\delta^{-1})}{\Theta}\log\left(\frac{(2-\mu)C_{0} TTA}{\mu\gamma_{\min}^{gap}}\right),\quad\text{where}\quad C_{0}\geq 64\frac{\mu}{(2-\mu)}.\] (57)

In the following, we will determine a lower bound on \(C_{0}\) such that our step size condition in Theorem 3's statement, i.e., \(\eta\leq 1/L_{p}\), is satisfied. Note that for the choice of \(\eta\) in (56) to meet the condition \(\eta\leq 1/L_{p}\), the following condition must hold:

\[\frac{1}{L_{p}}\leq\frac{\mu}{(2-\mu)}\frac{1}{C_{2}T}e^{R_{\epsilon}^{0} \Theta/2}\Rightarrow R_{\mu}^{0}\geq\frac{2}{\Theta}\log\left(\frac{1}{L_{p}} \frac{(2-\mu)}{\mu}C_{2}T\right),\] (58)

where \(C_{2}=(1-\mu)\frac{\tilde{A}^{2}C^{2}}{\Theta c}\).

This together with (57) implies that for sufficiently large

\[R_{\mu}^{0}\geq\frac{\max(2,\delta^{-1})}{\Theta}\log\left(\frac{(2-\mu)C_{3}T}{ \mu}\right),\quad\text{where}\quad C_{3}=\frac{C_{0}\Gamma A}{\gamma_{\min}^{ gap}}\vee\frac{C_{2}}{L_{p}},\]the step size bound in (56) ensures that \(\eta\leq 1/L_{p}\) guarantees (55). Hence, \(\bm{p}(t+1)\) remains within the cone, i.e., \(\bm{p}(t+1)\in\mathcal{C}_{\mu,R_{\epsilon}}(\bm{p}^{mm})\).

**Step 4: The correlation of \(\bm{p}(t)\) and \(\bm{p}^{mm}\) increases over \(t\).** The remainder is similar to the proof of Theorem 2. From Step 3, we have that all iterates remain within the initial conic set i.e. \(\bm{p}(t)\in\mathcal{C}_{\mu,R_{\epsilon}^{0}}(\bm{p}^{mm})\) for all \(t\geq 0\). Note that it follows from Lemma 7 that \(\langle\nabla\mathcal{L}(\bm{p}),\bm{p}^{mm}/\|\bm{p}^{mm}\|\rangle<0\), for any finite \(\bm{p}\in\mathcal{C}_{\mu,R_{\epsilon}^{0}}(\bm{p}^{mm})\). Hence, there are no finite critical points \(\bm{p}\in\mathcal{C}_{\mu,R_{\epsilon}^{0}}(\bm{p}^{mm})\), for which \(\nabla\mathcal{L}(\bm{p})=0\). Now, based on Lemma 6, which guarantees that \(\nabla\mathcal{L}(\bm{p}(t))\to 0\), this implies that \(\|\bm{p}(t)\|\to\infty\). Consequently, for any choice of \(\epsilon\in(0,\mu/2)\) there is a time \(t_{\epsilon}\) such that, for all \(t\geq t_{\epsilon}\), \(\bm{p}(t)\in\mathcal{C}_{\mu,R_{\epsilon}}(\bm{p}^{mm})\). Once within \(\mathcal{C}_{\mu,R_{\epsilon}}(\bm{p}^{mm})\), following similar steps in (51) and (52), for any \(t\geq t_{\epsilon}\),

\[\left\langle\frac{\bm{p}(t)}{\|\bm{p}(t)\|},\frac{\bm{p}^{mm}}{\|\bm{p}^{mm} \|}\right\rangle\geq 1-\epsilon+\frac{C_{2}(\epsilon,\eta)}{\|\bm{p}(t)\|}, \quad\bm{p}(t)\in C_{\mu,R_{\epsilon}}(\bm{p}^{mm}),\]

for some finite constant \(C_{2}(\epsilon,\eta)\). Consequently,

\[\liminf_{t\to\infty}\left\langle\frac{\bm{p}(t)}{\|\bm{p}(t)\|},\frac{\bm{p}^{mm}}{\|\bm{p}^{mm}\|}\right\rangle\geq 1-\epsilon,\ \ \text{where}\ \ \bm{p}(t)\in\mathcal{C}_{\mu,R_{\epsilon}}(\bm{p}^{mm}).\]

Since the choice of \(\epsilon\in(0,\mu/2)\) is arbitrary, we obtain \(\bm{p}(t)/\|\bm{p}(t)\|\to\bm{p}^{mm}/\|\bm{p}^{mm}\|\). 

### Proof of Theorem 4

#### b.5.1 Supporting Lemma

We present a lemma that will aid in simplifying our analysis. We begin with a definition.

**Definition 3** (**Selected-tokens, Neighbors, Margins, and Neighbor-optimality of a direction**):

_Let \(\bm{q}\in\mathbb{R}^{d}-\{\bm{0}\}\) and \((Y_{i},\bm{K}_{i},\bm{\lambda}_{i})_{i=1}^{n}\) be our dataset. We define the (possibly non-unique) selected-tokens of \(\bm{q}\) as follows:3_

Footnote 3: If \(\alpha_{i}\) is unique for all \(i\in[n]\), let us call it, unique selected tokens.

\[\alpha_{i}\in\arg\max_{t\in[T]}\bm{k}_{ii}^{\top}\bm{q}.\] (59)

_Next, we define the margin and directional-neighbors for \(\bm{q}\) as the minimum margin tokens to the selected-tokens, i.e.,_

\[\Gamma_{\bm{q}} =\min_{i\in[n]\neq\alpha_{i}}(\bm{k}_{ii_{i}}-\bm{k}_{ii})^{\top }\bm{q},\] (60) \[\mathcal{M}_{\bm{q}} =\left\{(i,i)\mid(\bm{k}_{ii_{i}}-\bm{k}_{ii})^{\top}\bm{q}=\Gamma _{\bm{q}}\right\}.\] (61)

_Finally, we say that \(\bm{q}\) is neighbor-optimal if the scores of its directional-neighbors are strictly less than the corresponding selected-token. Concretely, for all \((i,t)\in\mathcal{M}_{\bm{q}}\), we require that_

\[\bm{\gamma}_{ii}=Y_{i}\cdot\bm{x}_{ii}^{\top}\bm{v}<\bm{\gamma}_{ia_{i}}=Y_{i} \cdot\bm{x}_{ia_{i}}^{\top}\bm{v}.\]

**Lemma 8** (**When does one direction dominate another?**): _Suppose \(\bm{q},\bm{p}\in\mathbb{R}^{d}\) be two unit Euclidean norm vectors with identical selected tokens. Specifically, for each \(i\in[n]\), there exists unique \(\alpha_{i}\in[T]\) such that \(\alpha_{i}=\arg\max_{t\in[T]}\bm{k}_{ii}^{\top}\bm{q}=\arg\max_{t\in[T]}\bm{k}_ {ii}^{\top}\bm{p}\). Suppose directional margins obey \(\Gamma_{\bm{q}}<\Gamma_{\bm{p}}\) and set \(\delta_{\Gamma}=\Gamma_{\bm{p}}-\Gamma_{\bm{q}}\)._

* _Suppose_ \(\bm{q}\) _and_ \(\bm{p}\) _are both neighbor-optimal. Then, for some_ \(R(\delta_{\Gamma})\) _and all_ \(R>R(\delta_{\Gamma})\)_, we have that_ \(\mathcal{L}(R\cdot\bm{p})<\mathcal{L}(R\cdot\bm{q})\)_._
* _Suppose_ \(\bm{q}\) _has a unique directional-neighbor and is not neighbor-optimal (i.e. this neighbor has higher score). Let_ \(\delta_{\bm{q}}\) _be the margin difference between unique directional-neighbor and the second-most minimum-margin neighbor (i.e. the one after the unique one, see (_65_)) of_ \(\bm{q}\)_. Then, for some_ \(R(\delta_{\Gamma}\wedge\delta_{\bm{q}})\) _and all_ \(R>R(\delta_{\Gamma}\wedge\delta_{\bm{q}})\)_, we have that_ \(\mathcal{L}(R\cdot\bm{q})<\mathcal{L}(R\cdot\bm{p})\)_._

**Proof.** We prove these two statements in order. First define the directional risk baseline induced by letting \(R\to\infty\) and purely selecting the tokens \(\bm{\alpha}=(\alpha_{i})_{i=1}^{n}\). This is given by

\[\mathcal{L}_{\bm{\star}} :=\frac{1}{n}\sum_{i=1}^{n}\ell\left(Y_{i}\cdot\bm{v}^{\top}\bm{x }_{ia_{i}}\right).\]We evaluate \(\bm{q},\bm{p}\) with respect to \(\mathcal{L}_{\star}\). To proceed, let \(\bm{s}_{i}=\mathbb{S}(R\bm{K}_{i}\bm{q})\). Define \(\Gamma_{\bm{q}}^{u}=\bm{k}_{i_{\alpha}}^{T}\bm{q}-\bm{k}_{i_{\alpha}}^{T}\bm{q}\). Note that, the smallest value for \(t\neq\alpha_{i}\) is achieved for \(\Gamma_{\bm{q}}\). For sufficiently large \(R\gtrsim\mathcal{O}(\log(T)/\Gamma_{\bm{q}})\), observe that, for \(t\neq\alpha_{i}\)

\[e^{-R\Gamma_{\bm{q}}^{u}}\geq\bm{s}_{it}=\frac{e^{R\Gamma_{\bm{q}}^{u}\bm{q}} }{\sum_{t\in[T]}e^{R\Gamma_{\bm{q}}^{u}\bm{q}}}\geq 0.5e^{-R\Gamma_{\bm{q}}^{u}}.\] (62)

Recalling the score definition and let \(M_{+},M_{-}\) be the upper and lower bounds on \(-\ell^{\prime}\) over its bounded domain that scores fall on, respectively. Note that, for some intermediate \(M_{+}\geq M_{i}\geq M_{-}\) values, we have

\[\mathcal{L}(R\bm{q})-\mathcal{L}_{\star} =\frac{1}{n}\sum_{i=1}^{n}\ell(\sum_{t\in[T]}\bm{s}_{it}\bm{ \gamma}_{it})-\ell(\bm{\gamma}_{it_{i}})\] \[=\frac{1}{n}\sum_{i=1}^{n}M_{i}\sum_{t\neq\alpha_{i}}\bm{s}_{it}( \bm{\gamma}_{it_{i}}-\bm{\gamma}_{it}).\]

Now, using (62) for a refreshed \(M_{+}\geq M_{it}\geq 0.5M_{-}\) values, we can write

\[\mathcal{L}(R\bm{q})-\mathcal{L}_{\star} =\frac{1}{n}\sum_{i=1}^{n}\sum_{t\neq\alpha_{i}}M_{it}e^{-R\Gamma _{\bm{q}}^{u}}(\bm{\gamma}_{it_{i}}-\bm{\gamma}_{it}).\] (63)

The same bound also applies to \(\bm{p}\) with some \(M_{it}^{\prime}\), multipliers

\[\mathcal{L}(R\bm{p})-\mathcal{L}_{\star} =\frac{1}{n}\sum_{i=1}^{n}\sum_{t\neq\alpha_{i}}M_{it}^{\prime}e^ {-R\Gamma_{\bm{p}}^{u}}(\bm{\gamma}_{it_{i}}-\bm{\gamma}_{it}).\] (64)

We can now proceed with the proof.

**Case 1: \(\bm{q}\) and \(\bm{p}\) are both neighbor-optimal.** This means that \(\bm{\gamma}_{it_{i}}-\bm{\gamma}_{it}>0\) for all \(i\in[n],t\neq\alpha_{i}\). Let \(K_{+}>K_{-}>0\) be upper and lower bounds on \(\bm{\gamma}_{it_{i}}-\bm{\gamma}_{it}\) values. We can now upper bound the right hand side of (63) via

\[M_{+}K_{+}Te^{-R\Gamma_{\bm{q}}}\geq\mathcal{L}(R\bm{q})-\mathcal{L}_{\star} \geq\frac{1}{2n}M_{-}K_{-}e^{-R\Gamma_{\bm{q}}^{u}}.\]

Consequently, \(\mathcal{L}(R\bm{q})>\mathcal{L}(R\bm{p})\) as soon as \(\frac{1}{2n}M_{-}K_{-}e^{-R\Gamma_{\bm{q}}^{u}}>M_{+}K_{+}Te^{-R\Gamma_{\bm{p} }^{u}}\). Since \(M_{+},K_{+},n,T\) are global constants, this happens under the stated condition on the margin gap \(\Gamma_{\bm{p}}-\Gamma_{\bm{q}}\).

**Case 2: \(\bm{q}\) has a unique directional-neighbor and is not neighbor-optimal.** In this scenario, \(\mathcal{L}(R\bm{q})-\mathcal{L}_{\star}\) is actually negative for large \(R\). To proceed, define the maximum score difference \(K_{+}=\sup_{i\neq\alpha_{i}}|\bm{\gamma}_{it_{i}}-\bm{\gamma}_{it}|\). Also let \((j,\beta)\) be the unique directional neighbor achieving the minimum margin \(\Gamma_{\bm{q}}\). Then, \(\delta_{\bm{q}}\) - the margin difference between unique directional-neighbor and the second minimum-margin neighbor (i.e. the one after the unique one) of \(\bm{q}\) - is defined as

\[\delta_{\bm{q}}=\min_{i\in[n],\ t\neq\alpha_{i},\ (i,t)\neq(j,\beta)}\Gamma_{\bm{q}}^{u }-\Gamma_{\bm{q}}.\] (65)

To proceed, we can write

\[\mathcal{L}(R\bm{p})-\mathcal{L}_{\star}\geq-M_{+}K_{+}Te^{-R\Gamma_{\bm{q}}}.\]

On the other hand, setting \(\kappa=\bm{\gamma}_{j\beta}-\bm{\gamma}_{j\alpha_{i}}>0\), we can bound

\[\mathcal{L}(R\bm{q})-\mathcal{L}_{\star} =-\frac{1}{n}M_{j\beta}e^{-R\Gamma_{\bm{q}}}\kappa+\frac{1}{n} \sum_{i\in[n],\ t\neq\alpha_{i},\ (i,t)\neq(j,\beta)}M_{it}e^{-R\Gamma_{\bm{q}}^{u}}(\bm{\gamma}_{it_{i}}-\bm{ \gamma}_{it})\] \[\leq-\frac{1}{n}M_{-}e^{-R\Gamma_{\bm{q}}}\kappa+M_{+}K_{+}Te^{-R \Gamma_{\bm{q}}^{u}+\delta_{\bm{q}}}.\]

Consequently, we have found that \(\mathcal{L}(R\bm{p})>\mathcal{L}(R\bm{q})\) as soon as

\[\frac{1}{n}M_{-}e^{-R\Gamma_{\bm{q}}}\kappa\geq M_{+}K_{+}T(e^{-R(\Gamma_{\bm {q}}+\delta_{\bm{q}})}+e^{-R\Gamma_{\bm{p}}})\]

This happens when \(R\gtrsim\frac{1}{\delta_{\bm{p}}\kappa/(\Gamma_{\bm{p}}-\Gamma_{\bm{q}}^{u})}\) (up to logarithmic terms) establishing the desired statement.

#### b.5.2 Proof of Theorem 4

Define the locally-optimal unit directions

\[\mathcal{P}^{\mathrm{mm}}=\left\{\frac{\bm{p}^{\mathrm{mm}}(\bm{\alpha})}{\|\bm{p} ^{\mathrm{mm}}(\bm{\alpha})\|}\ \Big{|}\ \bm{\alpha}\ \text{is a locally-optimal set of indices}\right\}.\]

The theorem below shows that cone-restricted regularization paths can only directionally converge to an element of this set.

**Theorem 7** (Non-LOMM Regularization Paths Fail): _Fix a unit Euclidean norm vector \(\bm{q}\in\mathbb{R}^{d}\) such that \(\bm{q}\notin\mathcal{P}^{\mathrm{mm}}\). Assume that the token scores are distinct (i.e., \(\bm{\gamma}_{it}\neq\bm{\gamma}_{it}\) for \(t\neq\tau\)) and the key embeddings \(\bm{k}_{it}\) are in general position. Specifically, we require the following conditions to hold 4:_

Footnote 4: This requirement holds for general data because it is guaranteed by adding arbitrarily small independent gaussian perturbations to keys \(\bm{k}_{it}\).

* _When_ \(m=d\)_, all matrices_ \(\bm{\tilde{K}}\in\mathbb{R}^{m\times d}\) _where each row of_ \(\bm{\tilde{K}}\) _has the form_ \(\bm{k}_{it}-\bm{k}_{it}\)_, for a unique_ \((i,\alpha_{i},t\neq\alpha_{i})\) _tuple, are full-rank._
* _When_ \(m=d+1\)_, the vector of all ones is not in the range space of any such_ \(\bm{\tilde{K}}\) _matrix._

_Fix arbitrary \(\epsilon>0,R_{0}>0\). Define the local regularization path of \(\bm{q}\) as its \((\epsilon,R_{0})\)-conic neighborhood:_

\[\bm{\tilde{p}}(R)=\underset{\bm{p}\in\mathcal{C}_{\epsilon,R_{0}}(\bm{q}),\| \bm{p}\|\leq R}{\arg\min}\mathcal{L}(\bm{p}),\ \ \text{where}\ \ \ \mathcal{C}_{\epsilon,R_{0}}(\bm{q})=\mathsf{cone}_{\epsilon}(\bm{q})\cap\left\{ \bm{p}\in\mathbb{R}^{d}\right\}\|\bm{p}\|\geq R_{0}\right\}.\] (66)

_Then, either \(\lim_{R\to\infty}\|\bm{\tilde{p}}(R)\|<\infty\) or \(\lim_{R\to\infty}\bm{\tilde{p}}(R)/\|\bm{\tilde{p}}(R)\|\neq\bm{q}\). In both scenarios \(\lim_{R\to\infty}\bm{\tilde{p}}(R)/R\neq\bm{q}\)._

**Proof.** We will prove the result by dividing the problem into distinct cases. In each case, we will construct an alternative direction that achieves a strictly better objective than some \(\delta=\delta(\epsilon)>0\) neighborhood of \(\bm{q}\), thereby demonstrating the suboptimality of the \(\bm{q}\) direction. Let's define the \(\delta\) neighborhood as follows:

\[\mathcal{N}_{\delta}=\left\{\bm{p}\ \middle|\ \left\|\frac{\bm{p}}{\|\bm{p} \|}-\bm{q}\right\|\leq\delta\quad\text{and}\quad\|\bm{p}\|\geq R_{0}\right\}.\] (67)

Now, let's recall a few more definitions based on Definition 3. First, the tokens selected by \(\bm{q}\) are given by (59). To proceed, let's initially consider the scenario where \(\alpha_{i}\) is unique for all \(i\in[n]\), meaning that as we let \(c\to\infty\), \(c\cdot\bm{q}\) will choose a single token per input. Later, we will revisit the setting when \(\arg\max\) is not a singleton, and \(\bm{q}\) is allowed to select multiple tokens.

Additionally, it's important to note that \(\|\bm{\tilde{p}}(R)\|\) is non-decreasing by definition. Suppose it has a finite upper bound \(\|\bm{\tilde{p}}(R)\|\leq M\) for all \(R<\infty\). In that scenario, we have \(\lim_{R\to\infty}\frac{\bm{\tilde{p}}(R)}{R}=0\neq\bm{q}\).

\(\bullet\) **(A) \(\bm{q}\) selects a single token per input:** Given that the indices \(\bm{\alpha}=(\alpha_{i})_{i=1}^{n}\) defined in (59) are uniquely determined, we can conclude that the \(\bm{q}\) direction eventually selects tokens \(\bm{k}_{i\alpha_{i}}\). Recall the definition of the margin \(\Gamma_{\bm{q}}\) from (60) and the set of directional neighbors, which is defined as the indices that achieve \(\Gamma_{\bm{q}}\), as shown in (61). Let us refer to \(\bm{q}\) as _neighbor-optimal_ if \(\bm{\gamma}_{it}<\bm{\gamma}_{i\alpha_{i}}\) for all \((i,t)\in\mathcal{M}_{\bm{q}}\).

We will consider two cases for this scenario: when \(\bm{q}\) is neighbor-optimal and when \(\bm{q}\) is not neighbor-optimal.

\(\diamond\) **(A1) \(\bm{q}\) is neighbor-optimal.** In this case, we will argue that \(\max\)-margin direction \(\bm{\tilde{p}}^{\mathrm{mm}}:=\bm{p}^{\mathrm{mm}}(\bm{\alpha})/\|\bm{p}^{ \mathrm{mm}}(\bm{\alpha})\|\) can be used to construct a strictly better objective than \(\bm{q}\). Note that \(\bm{p}^{\mathrm{mm}}(\bm{\alpha})\) exists because \(\bm{q}\) is already a viable separating direction for tokens \(\bm{\alpha}\). Specifically, consider the direction \(\bm{q}^{\prime}=\frac{\bm{q}+\epsilon\bm{\tilde{p}}^{\mathrm{mm}}}{\|\bm{q}+ \epsilon\bm{\tilde{p}}^{\mathrm{mm}}\|}\). Observe that, \(\bm{q}^{\prime}\) lies within \(\mathsf{cone}_{2\epsilon}(\bm{q})\),5

Footnote 5: As a result, let us prove the result for \(\epsilon\gets 2\epsilon\) without losing generality.

\[\bm{q}^{\top}\bm{q}^{\prime}\geq\frac{1-\epsilon}{1+\epsilon}\geq 1-2\epsilon.\]

We now argue that, there exists \(\delta=\delta_{\epsilon}>0\) such that for all \(R>R_{\epsilon}\)

\[\min_{R_{\epsilon}\leq r\leq R}\mathcal{L}(r\cdot\bm{q}^{\prime})<\min_{\bm{p}\in \mathcal{N}_{\delta_{\epsilon}},R_{\epsilon}\leq\|\bm{p}\|\leq R}\mathcal{L}( \bm{p}).\] (68)To prove this, we study the margin \(\Gamma_{\bm{q}^{\prime}}\) induced by \(\bm{q}^{\prime}\) and the maximum margin \(\Gamma_{\delta}\) induced within \(\bm{p}\in\mathcal{N}_{\delta}\). Concretely, we will show that \(\Gamma_{\bm{q}^{\prime}}>\Gamma_{\delta}\) and directly apply the first statement of Lemma 8 to conclude with (68).

Let \(\Gamma=1/\|\bm{p}^{\text{mm}}(\bm{\alpha})\|\) be the margin induced by \(\bar{\bm{p}}^{\text{mm}}\). Note that \(\Gamma>\Gamma_{\bar{\bm{q}}}\) by the optimality of \(\bm{p}^{\text{mm}}(\bm{\alpha})\) and the fact that \(\bm{q}\neq\bm{p}^{\text{mm}}(\bm{\alpha})\). Consequently, we can lower and upper bound the margins via

\[\Gamma_{\bm{q}^{\prime}} =\min_{i\in[n]}\min_{i\neq\alpha_{i}}(\bm{k}_{i\alpha_{i}}-\bm{k} _{i})^{\top}\bm{q}^{\prime}\geq\frac{\Gamma_{\bm{q}}+\epsilon\Gamma}{1+ \epsilon}\geq\Gamma_{\bm{q}}+\frac{\epsilon}{2}(\Gamma-\Gamma_{\bm{q}}),\] \[\Gamma_{\delta} =\max_{\bm{p}\in\mathcal{N}_{\delta}}\min_{i\in[n]}\min_{i\neq \alpha_{i}}(\bm{k}_{i\alpha_{i}}-\bm{k}_{i})^{\top}\bm{p}/\|\bm{p}\|\] \[\leq\max_{\bm{p}\in\mathcal{N}_{\delta}}\min_{i\in[n]}\min_{i\neq \alpha_{i}}(\bm{k}_{i\alpha_{i}}-\bm{k}_{i})^{\top}(\bm{q}+\delta\bm{r})\] \[\leq\Gamma_{\bm{q}}+M\delta,\]

where \(M=\max_{i,t,\tau}\|\bm{k}_{it}-\bm{k}_{it}\|\).

Consequently, setting \(\delta=\frac{\epsilon}{4M}(\Gamma-\Gamma_{\bm{q}})\), we find that

\[\Gamma_{\bm{q}^{\prime}}\geq\Gamma_{\delta}+\frac{\epsilon}{4}(\Gamma-\Gamma_ {\bm{q}}).\]

Equipped with this inequality, we apply the first statement of Lemma 8 which concludes that6 for some \(R_{\epsilon}=R(\frac{\epsilon}{4}(\Gamma-\Gamma_{\bm{q}}))\) and all \(R>R_{\epsilon}\), (68) holds. This in turn implies that, within \(\mathcal{C}_{\epsilon}\), the optimal solution is

Footnote 6: Here, we apply this lemma to compare \(\bm{q}^{\prime}\) against all \(\bm{p}\in\mathcal{N}_{\delta}\). We can do this uniform comparison because the \(R\) requirement in Lemma 8 only depends on the margin difference and global problem variables and not the particular choice of \(\bm{p}\in\mathcal{N}_{\delta}\).

* either upper bounded by \(R_{\epsilon}\) in \(\ell_{2}\) norm (i.e. \(\lim_{R\to\infty}\|\bar{\bm{p}}(R)\|<\infty\)) or
* at least \(\delta=\delta(\epsilon)>0\) away from \(\bm{q}\) after \(\ell_{2}\)-normalization i.e. \(\|\frac{\bar{\bm{p}}(R)}{\|\bar{\bm{p}}(R)\|}-\bm{q}\|\geq\delta\).

In either scenario, we have proven that \(\lim\limits_{R\to\infty}\frac{\bar{\bm{p}}(R)}{R}\neq\bm{q}\).

\(\diamond\) **(A2) \(\bm{q}\) is not neighbor-optimal.** In this scenario, we will prove that \(\bar{\bm{p}}(R)\) is finite to obtain \(\lim_{R\to\infty}\bar{\bm{p}}(R)/R=0\neq\bm{q}\). To start, assume that conic neighborhood \(\epsilon\) of \(\bm{q}\) is small enough so that selected-tokens \(\bm{\alpha}\) remain unchanged within \(\mathcal{C}_{\epsilon}\). This is without generality because if directional convergence fails in a small neighborhood of \(\bm{q}\), it will fail in the larger neighborhood as well. Secondly, if \(\lim_{R\to\infty}\|\bar{\bm{p}}(R)\|\to\infty\) and \(\bar{\bm{p}}(R)\in\mathcal{C}_{\epsilon}\), since softmax will eventually perfectly select \(\bm{\alpha}\) (i.e. assigning probability 1 on token indices \((i,\alpha_{i})\)), we would have

\[\lim_{R\to\infty}\mathcal{L}(\bar{\bm{p}}(R))=\mathcal{L}_{\star}=\frac{1}{n} \sum_{i=1}^{n}\ell(\bm{\gamma}_{i\alpha_{i}}).\]

Note that, this is simply by selection of \(\bm{\alpha}\) and regardless of \(\bar{\bm{p}}(R)\) directionally converges to \(\bm{q}\). This means that, if there exists a finite \(\bm{p}\in\mathcal{C}_{\epsilon}\) such that \(\mathcal{L}(\bm{p})<\mathcal{L}_{\star}\) (i.e. outperforming the training loss of \(\|\bar{\bm{p}}(R)\|\to\infty\)), then \(\|\bar{\bm{p}}(R)\|<\infty\). This would conclude the proof.

Thus, we will simply find such a \(\bm{p}\) obeying \(\mathcal{L}(\bm{p})<\mathcal{L}_{\star}\). To this aim, we first prove the following lemma.

**Lemma 9**: _Given a fixed unit Euclidean norm vector \(\bm{p}\), if all directional neighbors of \(\bm{p}\) consistently have higher scores for their associated selected tokens, i.e., \(\bm{\gamma}_{i\alpha_{i}}<\bm{\gamma}_{i\beta}\) for all \((i,\alpha_{i})\) and directional neighbor \((i,\beta)\), then there exists \(\bar{R}\) such that for all \(R>\bar{R}\),_

\[\mathcal{L}(R\cdot\bm{p})<\mathcal{L}_{\star}=\lim_{R\to\infty}\mathcal{L}(R \cdot\bm{p}).\] (69)

**Proof.** Define the maximum score difference \(K_{+}=\sup_{i\in[n]\neq\alpha_{i}}|\bm{\gamma}_{i\alpha_{i}}-\bm{\gamma}_{i}|\). Also let \(\mathcal{M}_{\bm{p}}\) be the set of directional neighbors achieving the minimum margin \(\Gamma_{\bm{p}}\); see (61). Define \(\Gamma^{it}=\bm{k}_{i\alpha_{i}}^{\top}\bm{p}-\bm{k}_{it}^{\top}\bm{p}\). Define \(\delta_{\bm{p}}\) to be the margin difference between the directional-neighbors and the second-most minimum-margin neighbors defined as

\[\delta_{\bm{p}}=\min_{i\in[n]\neq\alpha_{i},(i,\lambda)\neq\mathcal{M}_{\bm{p}} }\Gamma^{it}_{\bm{p}}-\Gamma_{\bm{p}}.\] (70)To proceed, setting \(\kappa=\min_{(j,\beta)\in\mathcal{M}_{\bm{q}}}\bm{\gamma}_{j,\beta}-\bm{\gamma}_{ j,\alpha_{j}}>0\) and using (63), we can bound

\[\mathcal{L}(R\bm{p})-\mathcal{L}_{\bm{\star}} \leq-\frac{1}{n}\sum_{(j,\beta)\in\mathcal{M}_{\bm{q}}}M_{\beta}~ {}e^{-RT_{\bm{\star}}}\kappa+\frac{1}{n}\sum_{i\in[n]\neq\alpha_{i},(i,t)\notin \mathcal{M}_{\bm{p}}}M_{\tilde{m}}~{}e^{-RT_{\bm{p}}^{\tilde{m}}}(\bm{\gamma}_{ \alpha_{i}}-\bm{\gamma}_{it})\] \[\leq-\frac{1}{n}M_{-}e^{-RT_{\bm{\star}}}\kappa+M_{+}K_{+}Te^{-R \Gamma_{\bm{\star}}+\delta_{\bm{p}}}.\]

Consequently, we have found that \(\mathcal{L}(R\bm{p})<\mathcal{L}_{\bm{\star}}\) as soon as

\[\frac{1}{n}M_{-}e^{-RT_{\bm{\star}}}\kappa\geq M_{+}K_{+}Te^{-R(\Gamma_{\bm{ \star}}+\delta_{\bm{p}})}.\]

This happens when \(R\gtrsim 1/\delta_{\bm{q}}\) (up to logarithmic terms) establishing the desired statement.

Based on this lemma, what we need is constructing a perturbation to modify \(\bm{q}\)'s directional neighbors and make sure all of them have strictly better scores than their associated selected-tokens. Note that, once we construct a new candidate (say \(\bm{q}_{0}=\bm{q}+\text{perturbation}\)), all sufficiently large scalings of \(\bm{q}_{0}\) will achieve \(\mathcal{L}(R\cdot\bm{q}_{0})<\mathcal{L}_{\bm{\star}}\). Thus, we can find a strictly better solution than \(\mathcal{L}_{\bm{\star}}\) for any norm lower bound \(R_{0}\) - which is enforced within the definition of \(\mathcal{C}_{\bm{\epsilon}}\).

**Lemma 10**: _There are at most \(d\) directional neighbors i.e. \(|\mathcal{M}_{\bm{q}}|\leq d\)._

**Proof.** Directional neighbors are indices \((i,t)\) obeying the inequality

\[(\bm{k}_{i\alpha_{i}}-\bm{k}_{i\alpha})^{\top}\bm{q}=\Gamma_{\bm{q}}.\]

Declare \(\bm{D}\) to be the matrix with rows obtained by these key differences \(\bm{k}_{i\alpha}-\bm{k}_{i\alpha_{i}}\), \(\bm{D}\in\mathbb{R}^{M\times d}\) where \(M=|\mathcal{M}_{\bm{q}}|\). We then obtain \(\bm{D}\bm{q}=-\Gamma_{\bm{q}}\bm{1}_{M}\) where \(\bm{1}_{M}\) is the all ones vector. If \(M>d\), the equality \(\bm{D}\bm{q}=-\Gamma_{\bm{q}}\bm{1}_{M}\) cannot be satisfied because \(\bm{1}_{M}\) is not in the range space of \(\bm{D}\) by our assumption of general key embedding positions.

To proceed, \(|\mathcal{M}_{\bm{q}}|\leq d\) and let \(\bm{D}\) be as defined in the lemma above. \(\bm{D}\) is also full-rank by our assumption of general key positions. We use \(\bm{D}\) to construct a perturbation as follows. Let \(\mathcal{M}_{\bm{q}}^{+}\subset\mathcal{M}_{\bm{q}}\) be the set of directional neighbor with strictly higher scores than their associated selected-tokens. In other words, all \((j,\beta)\in\mathcal{M}_{\bm{q}}^{+}\) obeys

\[\bm{\gamma}_{j\beta}>\bm{\gamma}_{j\alpha_{j}}.\]

Define the score difference \(\kappa=\min_{(j,\beta)\in\mathcal{M}_{\bm{q}}^{+}}\bm{\gamma}_{j\beta}-\bm{ \gamma}_{j\alpha_{j}}>0\). We know \(\kappa>0\) because \(\bm{\alpha}\) is not neighbor-optimal. Finally, define the indicator vector of \(\bm{1}_{+}\) with same dimension as cardinality \(|\mathcal{M}_{\bm{q}}|\). \(\bm{1}_{+}\) is 1 for the rows of \(\bm{D}\) corresponding to \(\mathcal{M}_{\bm{q}}^{+}\) and is 0 otherwise. Finally, set the perturbation as

\[\bm{q}^{\perp}=\bm{D}^{\perp}\bm{1}_{+}.\]

where we used the full-rankness of \(\bm{D}\) during pseudo-inversion. To proceed, for a small \(\epsilon_{0}>0\), consider the candidate direction \(\bm{q}_{0}=\bm{q}+\epsilon_{0}\bm{q}^{\perp}\). We pick \(\epsilon_{0}=\mathcal{O}(\epsilon)\) sufficiently small to ensure \(\bm{q}_{0}\in\mathcal{C}_{\bm{\epsilon}}\). To finalize, let us consider the margins of the tokens within \(\bm{q}_{0}\). Similar to Lemma 9, set \(\delta_{\bm{q}}=\min_{i\in[n],\bm{\tau}\alpha_{i},(i,t)\notin\mathcal{M}_{\bm {q}}}\Gamma_{\bm{q}}^{i}-\Gamma_{\bm{q}}>0\). Let \(\tilde{\epsilon}_{0}=\|\bm{q}_{0}\|-1=\|\bm{q}+\epsilon_{0}\bm{q}^{\perp}\|-1\). Using definition of \(\bm{q}^{\perp}\), we have that

* For \((i,t)\in\mathcal{M}_{\bm{q}}^{+}\), we achieve a margin of \[(\bm{k}_{i\alpha_{i}}-\bm{k}_{i\alpha})^{\top}(\bm{q}+\epsilon_{0}\bm{q}^{ \perp})/(1+\tilde{\epsilon}_{0})=\frac{\Gamma_{\bm{q}}-\epsilon_{0}}{1+\tilde{ \epsilon}_{0}}.\]
* For \((i,t)\in\mathcal{M}_{\bm{q}}^{+}\), we achieve a margin of \(\frac{\Gamma_{\bm{\star}}}{1+\tilde{\epsilon}_{0}}\).
* For \((i,t)\notin\mathcal{M}_{\bm{q}}\), setting \(K=\|\bm{q}^{\perp}\|\cdot\sup_{i,t}\|\bm{k}_{i\alpha_{i}}-\bm{k}_{i\alpha}\|\), we achieve a margin of at most \[(\bm{k}_{i\alpha_{i}}-\bm{k}_{i\alpha})^{\top}(\bm{q}+\epsilon_{0}\bm{q}^{\perp}) /(1+\tilde{\epsilon}_{0})\geq\frac{\Gamma_{\bm{q}}+\delta_{\bm{q}}-\epsilon_{0} K}{1+\tilde{\epsilon}_{0}}.\]In short, since \(\bar{\epsilon}_{0}=\mathcal{O}(\epsilon_{0})\), setting \(\epsilon_{0}\) sufficiently small guarantees that \(\mathcal{M}_{\bm{q}}^{\dagger}\) is the set of directional neighbors of \(\bm{q}_{0}\). Since \(\mathcal{M}_{\bm{q}}^{\dagger}\) has strictly higher scores than their associated selected-tokens, applying Lemma 9 on \(\bm{q}_{0}\) shows that, \(\mathcal{L}(R\cdot\bm{q}_{0})<\mathcal{L}_{\star}\) for sufficiently large \(R\) implying \(\|\bar{\bm{p}}(R)\|<\infty\).

\(\bullet\) **(B) \(\bm{q}\) selects multiple tokens for some inputs \(i\in[n]\):** In this setting, we will again construct a perturbation to create a scenario where \(\bm{q}_{0}=\bm{q}+\epsilon\bm{q}^{\perp}\) selects a single token for each input \(i\in[n]\). We will then employ margin analysis (first statement of Lemma 8) to conclude that \(\bm{q}_{0}\) outperforms a \(\delta\ll\epsilon\) neighborhood of \(\bm{q}\).

Let \(\mathcal{I}\subset[n]\) be the set of inputs for which \(\bm{q}\) selects multiple tokens. Specifically, for each \(i\in\mathcal{I}\), there is \(\mathcal{T}_{i}\subset[T]\) such that \(|\mathcal{T}_{i}|\geq 2\) and for any \(i\in\mathcal{I}\) and \(\theta\in\mathcal{T}_{i}\),

\[\bm{k}_{i\theta}^{\top}\bm{q}=\arg\max_{t\in[T]}\bm{k}_{i}^{\top}\bm{q}.\]

From these multiply-selected token indices let us select the highest score one, namely, \(\beta_{i}=\arg\max_{\theta\in\mathcal{T}_{i}}\bm{\gamma}_{i\theta}\) for \(i\in\mathcal{I}\). Now, define the unique optimal tokens for each input as \(\bm{\alpha}\in\mathbb{R}^{\eta}\) where \(\alpha_{i}:=\beta_{i}\) for \(i\in\mathcal{I}\) and \(\alpha_{i}=\arg\max_{t\in[T]}\bm{k}_{i\theta}^{\top}\bm{q}\) for \(i\notin\mathcal{I}\). Define \(\mathcal{L}_{\star}=\frac{1}{n}\sum_{i=1}^{n}\ell(\mathcal{Y}_{i\alpha_{i}})\) as earlier.

Secondly, we construct a perturbation \(\bm{q}^{\perp}\) to show that \(\bm{q}_{0}=\bm{q}+\epsilon_{0}\bm{q}^{\perp}\) can select tokens \(\bm{\alpha}\) asymptotically. To see this, define the matrix \(\bm{D}\) where each (unique) row is given by \(\bm{k}_{i\alpha_{i}}-\bm{k}_{i\theta}\) where \(\theta\in\mathcal{T}_{i},\theta\neq\alpha_{i}\), \(i\in\mathcal{I}\). Now note that, \((\bm{k}_{i\alpha_{i}}-\bm{k}_{i\theta})^{\top}\bm{q}=0\) for all \(\theta\in\mathcal{T}_{i},\theta\neq\alpha_{i}\), \(i\in\mathcal{I}\). Since keys are in general positions, this implies that \(\bm{D}\) has at most \(d-1\) rows and, thus, its rows are linearly independent. Consequently, choose \(\bm{q}^{\perp}=\bm{D}^{\perp}\bm{1}\) where \(\dagger\) denotes pseudo-inverse and \(\bm{1}\) is the all ones vector. Also let \(\Gamma_{\bm{q}}\) be the margin of directional margin of \(\bm{q}\) that is

\[\Gamma_{\bm{q}}=\min_{i\in[n]\in\mathcal{T}_{i}}(\bm{k}_{i\alpha_{i}}-\bm{k}_ {i\dagger})^{\top}\bm{q}.\]

With this choice and setting \(K=\sup_{i,t,\tau}\|\bm{k}_{i\alpha_{i}}-\bm{k}_{i\dagger}\|\), we have that

* For \(\theta\in\mathcal{T}_{i},\theta\neq\alpha_{i}\): \((\bm{k}_{i\alpha_{i}}-\bm{k}_{i\theta})^{\top}\bm{q}_{0}=(\bm{k}_{i\alpha_{i} }-\bm{k}_{i\theta})^{\top}\bm{q}^{\perp}=\epsilon_{0}\).
* For all other \((i,t)\) with \(t\neq\alpha_{i}\): \((\bm{k}_{i\alpha_{i}}-\bm{k}_{i\dagger})^{\top}\bm{q}_{0}\geq\Gamma_{\bm{q}}- K\|\bm{q}^{\perp}\|\epsilon_{0}\).

Choosing \(\epsilon_{0}<\Gamma_{\bm{q}}/(1+K\|\bm{q}^{\perp}\|)\), together, these imply that,

* \(\bm{\alpha}=(\alpha_{i})_{i=1}^{n}\) is the selected-tokens of \(\bm{q}_{0}\),
* \(\bm{q}_{0}\) achieves a directional margin of \[\Gamma_{\bm{q}_{0}}=\frac{\epsilon_{0}}{\|\bm{q}_{0}\|}\geq\frac{\epsilon_{0}} {1+\epsilon_{0}\|\bm{q}^{\perp}\|},\]
* \(\bm{q}_{0}\) is neighbor-optimal because directional neighbors are \(\theta\in\mathcal{T}_{i},\theta\neq\alpha_{i}\) and \(\bm{\gamma}_{i\theta}<\bm{\gamma}_{i\alpha_{i}}\).

Note that, these conditions lay the groundwork for applying the first statement of Lemma 8 with \(\bm{p}\leftarrow\bm{q}_{0}\). We next explore the optimal directions within \(\mathcal{N}_{\delta}\) and show that \(\bm{q}_{0}\) strictly outperform them in terms of training loss.

To proceed, given small \(\delta\ll\epsilon_{0}\), let us study \(\mathcal{L}_{R}=\min_{\bm{p}\in\mathcal{N}_{\delta},\bm{p}\leq\|\bm{p}|<\infty }\mathcal{L}(\bm{p})\). Here, recall that \(\bm{p}\) has a \(\delta\)-small directional perturbation around \(\bm{q}\) which can modify the token selections by breaking the ties between the multiply-selected token indices by \(\bm{q}\). However, thanks to the distinct token score assumption, for large \(R\leq\|\bm{p}\|\), the optimal \(\bm{p}\in\mathcal{N}_{\delta}\) is guaranteed to (uniquely) select indices \(\alpha_{i}\in\mathcal{T}_{i}\). Because all other \(\bm{p}\) directions - which, asymptotically, either select other tokens \(\theta\in\mathcal{T}_{i},\theta\neq\alpha_{i}\) or split the probabilities equally across a subset of \(\mathcal{T}_{i}\) - achieve a larger loss. For instance, \(\bm{q}\) will split the probabilities equally across \(\mathcal{T}_{i}\) to achieve an asymptotic loss of

\[\mathcal{L}_{\star}^{\bm{q}}:=\lim_{R\to\infty}\mathcal{L}(R\cdot\bm{q})=\frac{1 }{n}\sum_{i\in\mathcal{I}}\ell(\bm{\gamma}_{i\alpha_{i}})+\frac{1}{n}\sum_{i\in \mathcal{I}}\ell\left(\frac{1}{|\mathcal{T}_{i}|}\sum_{\theta\in\mathcal{T}_{i} }\bm{\gamma}_{i\theta}\right)\]

Thus, \(\mathcal{L}_{\star}^{\bm{q}}>\mathcal{L}_{\star}\) because \(\ell\left(\frac{1}{|\mathcal{T}_{i}|}\sum_{\theta\in\mathcal{T}_{i}}\bm{\gamma} _{i\theta}\right)>\ell\left(\bm{\gamma}_{i\alpha_{i}}\right)=\ell(\bm{\gamma}_{ i\alpha_{i}})\) where \(\alpha_{i}\) has the highest score i.e. \(\bm{\gamma}_{i\alpha_{i}}>\frac{1}{|\mathcal{T}_{i}|}\sum_{\theta\in\mathcal{T}_{i} }\bm{\gamma}_{i\theta}\). Set \(\bar{\bm{p}}(R)=\arg\min_{\bm{p}\in\mathcal{N}_{\delta},\|\bm{p}\|\leq R}\mathcal{ L}(\bm{p})\). Consequently, there are two scenarios are:

* \(\lim_{R\to\infty}\|\bar{\bm{p}}(R)\|\) is finite. This already proves the statement of the theorem as \(\bar{\bm{p}}(R)/R\to 0\) within \(\delta<\epsilon\) neighborhood of \(\bm{q}\).

* For sufficiently large \(R\), the selected-tokens of \(\bar{\bm{p}}(R)\) are \(\bm{\alpha}=(\alpha_{i})_{i=1}^{n}\).

Proceeding with the second (remaining scenario), we study the directional margin of \(\bar{\bm{p}}(R)\). More broadly, for any \(\bm{p}\in\mathcal{N}_{\delta}\) and \(\bar{\bm{p}}=\bm{p}/\|\bm{p}\|\) with selected-tokens \(\bm{\alpha}\), using the fact that \(\|\bar{\bm{p}}-\bm{q}\|\leq\delta\ll\epsilon_{0}\), we can bound the directional margin as

* For \(\theta\in\mathcal{T}_{i},\theta\neq\alpha_{i}\): \((\bm{k}_{i_{\alpha i}}-\bm{k}_{i\theta})^{\top}\bar{\bm{p}}=(\bm{k}_{i_{\alpha i }}-\bm{k}_{i\theta})^{\top}(\bar{\bm{p}}-\bm{q})\leq K\delta\).
* For all other \((i,t)\) with \(t\neq\alpha_{i}\): \((\bm{k}_{i_{\alpha i}}-\bm{k}_{i\theta})^{\top}\bar{\bm{p}}\geq\Gamma_{\bm{q} }-K\delta\).

This means that, any such \(\bar{\bm{p}}\in\mathcal{N}_{\delta}\) achieves a directional margin of at most

\[\Gamma_{\bm{p}}\leq K\delta.\]

Applying Lemma 8 and setting \(\delta=\mathcal{O}(\epsilon_{0})\), this implies that for

\[R\gtrsim\frac{1}{\Gamma_{\bm{q}_{0}}-\Gamma_{\bar{\bm{p}}}}=\frac{1}{\frac{ \epsilon_{0}}{1+\epsilon_{0}\|\bm{q}^{2}\|}-K\delta}=\mathcal{O}(\frac{1}{ \epsilon_{0}}),\]

we have that \(\mathcal{L}(R\cdot\bm{q}_{0})<\min_{[\bm{p}]=R,\bm{p}\in\mathcal{N}_{\delta}} \mathcal{L}(\bm{p})\). Since this holds for all \(R\), (68) holds (similar to Case **(A1)**)) and we conclude that whenever \(\|\bar{\bm{p}}(R)\|\to\infty\), it doesn't directionally converge within \(\mathcal{N}_{\delta}\) (i.e. \(\delta>0\) neighborhood of \(\bm{q}\)) proving the advertised result. 

### Proof of Lemma 2

We prove a slightly general restatement where we require \(\bm{v}\in\operatorname{range}(\bm{W}^{\top})-\text{instead of full-rank }\bm{W}\).

**Lemma 11**: _Suppose for all \(i\in[n]\) and \(t\neq\operatorname{\mathsf{opt}}_{i}\), \(Y_{i}=1\) and \(\bm{\gamma}_{i}<\bm{\gamma}_{i\operatorname{opt}_{i}}\). Also suppose \(\bm{v}\in\operatorname{range}(\bm{W}^{\top})\). Then, \(\bm{p}^{\text{mm}\star}\) exists - i.e. (ATT-SVM) is feasible for optimal indices \(\alpha_{i}\leftarrow\operatorname{\mathsf{opt}}_{i}\)._

**Proof.** To establish the existence of \(\bm{p}^{\text{mm}\star}\), we only need to find a direction that demonstrates the feasibility of (ATT-SVM), i.e. we need to find \(\bm{p}\) that satisfies the margin constraints. To begin, let's define the minimum score difference:

\[\underline{\gamma}=\min_{i\in[n],t\neq\operatorname{\mathsf{opt}}_{i}}\bm{ \gamma}_{i\operatorname{\mathsf{opt}}_{i}}-\bm{\gamma}_{it}.\]

We then set \(\bm{p}=\underline{\gamma}^{-1}(\bm{W}^{\top})^{\dagger}\bm{v}\) where \(\dagger\) denotes pseudo-inverse. By assumption \(\bm{W}^{\top}\bm{p}=\underline{\gamma}^{-1}\bm{v}\). To conclude, observe that \(\bm{p}\) is a feasible solution since \(\bm{k}_{it}=\bm{W}\bm{x}_{it}\) and for all \(i\in[n]\) and \(t\neq\operatorname{\mathsf{opt}}_{i}\), we have that

\[(\bm{k}_{i\operatorname{\mathsf{opt}}_{i}}-\bm{k}_{it})^{\top}\bm{ p}=(\bm{x}_{i\operatorname{\mathsf{opt}}_{i}}-\bm{x}_{it})^{\top}\bm{W}^{\top}\bm{p} =\underline{\gamma}^{-1}(\bm{x}_{i\operatorname{\mathsf{opt}}_{i}}-\bm{x}_{it })^{\top}\bm{W}^{\top}(\bm{W}^{\top})^{\dagger}\bm{v}\] \[=\underline{\gamma}^{-1}(\bm{x}_{i\operatorname{\mathsf{opt}}_{i} }-\bm{x}_{it})^{\top}\bm{v}\geq 1,\]

which together with the constraints in (ATT-SVM) completes the proof. 

## Appendix C Addendum to Section 3

### Proof of Theorem 5

**Proof.** Suppose the claim is incorrect and either \(\bm{p}_{R}/R\) or \(\bm{v}_{r}/r\) fails to converge as \(R,r\) grows. Set \(\Xi=1/\|\bm{p}^{\text{mm}}\|\), \(\Gamma=1/\|\bm{v}^{\text{mm}}\|\), \(\bar{\bm{p}}^{\text{mm}}=R\Xi\bm{p}^{\text{mm}}\) and \(\bar{\bm{v}}^{\text{mm}}=r\Gamma\bm{v}^{\text{mm}}\). The proof strategy is obtaining a contradiction by proving that \((\bar{\bm{v}}^{\text{mm}},\bar{\bm{p}}^{\text{mm}})\) is a strictly better solution compared to \((\bm{v}_{r},\bm{p}_{R})\) for large \(R,r\). Without losing generality, we will set \(\alpha_{i}=1\) for all \(i\in[n]\) as the problem is invariant to tokens' permutation. Define \(q_{i}^{\bm{p}}=1-\bm{s}_{i1}^{\bm{p}}\) to be the amount of non-optimality (cumulative probability of non-first tokens) where \(\bm{s}_{i}^{\bm{p}}=\mathbb{S}(\bm{K}_{i}\bm{p})\) is the softmax probabilities.

\(\bullet\)**Case 1: \(\bm{p}_{R}/R\) does not converge.** Under this scenario there exists \(\delta,\gamma=\gamma(\delta)>0\) such that we can find arbitrarily large \(R\) with \(\|\bm{p}_{R}/R-\bar{\bm{p}}^{\text{mm}}/R\|\geq\delta\) and margin induced by \(\bm{p}_{R}/R\) is at most \(\Xi(1-\gamma)\) (from strong convexity of (ATT-SVM)). Following \(q_{i}^{\bm{p}}\) definition above, set \(\tilde{q}_{\max}=\sup_{i\in[\alpha_{i}]}q_{i}^{\bm{p}_{R}}\) to be worst non-optimality in \(\bm{p}_{R}\) and \(q^{\star}_{\max}=\sup_{i\in[n]}q^{\hat{p}^{\min}}_{i}\) to be the same for \(\hat{p}^{\min}\). Repeating the identical argument in Theorem 8 (specifically (84)), we can bound the non-optimality amount \(q^{\hat{p}^{\min}}_{i}\) of \(\hat{p}^{\min}\) as

\[q^{\hat{p}^{\max}}_{i}=\frac{\sum_{i\neq\alpha_{i}}\exp(\bm{k}^{\top}_{i}\hat{p }^{\min})}{\sum_{i\in[T]}\exp(\bm{k}^{\top}_{i}\hat{p}^{\min})}\leq\frac{\sum_{ i\neq\alpha_{i}}\exp(\bm{k}^{\top}_{i}\hat{p}^{\min})}{\exp(\bm{k}^{\top}_{i \alpha_{i}}\hat{p}^{\min})}\leq T\exp(-R\Xi).\] (71)

Thus, \(q^{\star}_{\max}=\max_{i\in[n]}q^{\hat{p}^{\min}}_{i}\leq T\exp(-R\Xi)\). Next without losing generality, assume first margin constraint is \(\gamma\)-violated by \(\bm{p}_{R}\) and \(\min_{i\neq\alpha_{1}}(\bm{k}_{1\alpha_{1}}-\bm{k}_{1\alpha_{1}})^{\top}\bm{ p}_{R}\leq\Xi R(1-\gamma)\). Denoting the amount of non-optimality of the first input as \(q^{\bm{p}_{R}}_{1}\), we find

\[q^{\bm{p}_{R}}_{1}=\frac{\sum_{i\neq\alpha_{1}}\exp(\bm{k}^{\top}_{i}\bm{p}_{ R})}{\sum_{i\in[T]}\exp(\bm{k}^{\top}_{1i}\bm{p}_{R})}\geq\frac{1}{T}\frac{\sum_{ i\neq\alpha_{1}}\exp(\bm{k}^{\top}_{i}\bm{p}_{R})}{\exp(\bm{k}^{\top}_{1 \alpha_{1}}\bm{p}_{R})}\geq T^{-1}\exp(-(1-\gamma)R\Xi).\] (72)

We similarly have \(q^{\star}_{\max}\geq T^{-1}\exp(-R\Xi)\) to find that

\[\log(\hat{q}_{\max}) \geq-(1-\gamma)\Xi R-\log T,\] \[-\Xi R-\log T\leq\log(q^{\star}_{\max}) \leq-\Xi R+\log T.\] (73)

In words, \(\hat{p}^{\min}\) contains exponentially less non-optimality compared to \(\bm{p}_{R}\) as \(R\) grows. The remainder of the proof differs from Theorem 8 as we need to upper/lower bound the logistic loss of \((\hat{v}^{\min},\hat{p}^{\min})\) and \((\bm{v}_{r},\bm{p}_{R})\) respectively to conclude with the contradiction.

First, let us upper bound the logistic loss of \((\bar{v}^{\min},\hat{p}^{\min})\). Set \(\bm{r}_{i}=\bm{X}^{\top}_{i}\mathbb{S}(\bm{K}_{i}\hat{p}^{\min})\). Observe that if \(\|\bm{r}_{i}-\bm{x}_{i1}\|\leq\epsilon_{i}\), we have that \(\bm{v}^{\min}\) satisfies the SVM constraints on \(\bm{r}_{i}\) with \(\bm{Y}_{i}\cdot\bm{r}^{\top}_{i}\bm{v}^{\min}\geq 1-\epsilon_{i}/\Gamma\). Consequently, setting \(\epsilon_{\max}=\sup_{i\in[n]}\epsilon_{i}\), \(\bm{v}^{\min}\) achieves a label-margin of \(\Gamma-\epsilon_{\max}\) on the dataset \((Y_{i},\bm{r}_{i})_{i\in[n]}\). With this, we upper bound the logistic loss of \((\bar{v}^{\min},\hat{p}^{\min})\) as follows. Let \(M=\sup_{i\in[n],\tau\in[T]}\|\bm{x}_{it}-\bm{x}_{it}\|\). Let us recall the fact (73) that worst-case perturbation is

\[\epsilon_{\max}\leq M\exp(-\Xi R+\log T)=MT\exp(-\Xi R).\]

This implies that

\[\mathcal{L}(\bar{v}^{\min},\tilde{p}^{\min}) \leq\max_{i\in[n]}\log(1+\exp(-Y_{i}\bm{r}^{\top}_{i}\bar{v}^{ \min})).\] \[\leq\max_{i\in[n]}\exp(-Y_{i}\bm{r}^{\top}_{i}\bar{v}^{\min})\] \[\leq\exp(-r\Gamma+r\epsilon_{\max})\] \[\leq e^{rMT\exp(-\Xi R)}e^{-r\Gamma}.\] (74)

Conversely, we obtain a lower bound for \((\bm{v}_{r},\bm{p}_{R})\). Set \(\bm{r}_{i}=\bm{X}^{\top}_{i}\mathbb{S}(\bm{K}_{i}\bm{p}_{R})\). Using Assumption C, we find that solving (SVM) on \((Y_{i},\bm{r}_{i})_{i\in[n]}\) achieves at most \(\Gamma-\nu e^{-(1-\gamma)\Xi R}/T\) margin. Consequently, we have

\[\mathcal{L}(\bm{v}_{r},\bm{p}_{R}) \geq\frac{1}{n}\max_{i\in[n]}\log(1+\exp(-Y_{i}\bm{r}^{\top}_{i} \bm{v}_{r}))\] \[\geq\frac{1}{2n}\max_{i\in[n]}\exp(-Y_{i}\bm{r}^{\top}_{i}\bm{v}_ {r})\wedge\log 2\] \[\geq\frac{1}{2n}\exp(-r(\Gamma-\nu e^{-(1-\gamma)\Xi R}/T))\wedge\log 2\] \[\geq\frac{1}{2n}e^{r(\nu/T)\exp(-(1-\gamma)\Xi R)}e^{-r\Gamma} \wedge\log 2.\] (75)

Observe that, this lower bound dominates the previous upper bound when \(R\) is large, namely, when (ignoring the multiplier \(1/2n\) for brevity)

\[(\nu/T)e^{-(1-\gamma)\Xi R}\geq MTe^{-\Xi R}\iff R\geq R_{0}:=\frac{1}{\gamma \Xi}\log\left(\frac{MT^{2}}{\nu}\right).\]

Thus, we indeed obtain the desired contradiction since such large \(R\) is guaranteed to exist when \(\bm{p}_{R}/R\to\bm{p}^{\min}\).

\(\bullet\)**Case 2: \(\bm{v}_{r}/r\) does not converge.** This is the simpler scenario: There exists \(\delta>0\) such that we can find arbitrarily large \(r\) obeying \(\|\bm{v}_{r}/r-\bm{v}^{\min}\|\bm{v}^{\min}\|\geq\delta\). If \(\|\bm{p}_{R}/R-\Xi\bm{p}^{\min}\|\to 0\), then "Case\(1^{n}\) applies. Otherwise, we have \(\|\bm{p}_{R}/R-\Xi\bm{p}^{\rm mm}\|\to 0\), thus we can assume \(\|\bm{p}_{R}/R-\Xi\bm{p}^{\rm mm}\|\leq\epsilon\) for arbitrary choice of \(\epsilon>0\).

On the other hand, due to the strong convexity of (SVM), for some \(\gamma:=\gamma(\delta)>0\), \(\bm{v}_{r}\) achieves a margin of at most \((1-\gamma)\Gamma r\) on the dataset \((Y_{i},\bm{x}_{i1})_{i\in[n]}\). Additionally, since \(\|\bm{p}_{R}/R-\Xi\bm{p}^{mm}\|\leq\epsilon\), \(\bm{p}_{R}\) strictly separates all optimal tokens (for small enough \(\epsilon>0\)) and \(\hat{q}_{\max}:=f(\epsilon)\to 0\) as \(R\to\infty\). Consequently, setting \(\bm{r}_{i}=\bm{X}_{i}^{\top}\mathbb{S}(\bm{K}_{i}\bm{p}_{R})\), for sufficiently large \(R>0\) setting \(M=\sup_{i\in[n],\bm{v}\in[T]}\|\bm{x}_{i1}\|\), we have that

\[\min_{i\in[n]}Y_{i}\bm{v}_{r}^{\top}\bm{r}_{i} \leq\min_{i\in[n]}Y_{i}\bm{v}_{r}^{\top}\bm{x}_{i1}+\sup_{i\in[n] }\bm{v}_{r}^{\top}(\bm{r}_{i}-\bm{x}_{i1})\|\] \[\leq(1-\gamma)\Gamma r+Mf(\epsilon)r\] \[\leq(1-\gamma/2)\Gamma r.\] (76)

This in turn implies that logistic loss is lower bounded by (following (75)),

\[\mathcal{L}(\bm{v}_{r},\bm{p}_{R})\geq\frac{1}{2n}e^{\gamma\Gamma r/2}e^{- \Gamma r}\wedge\log 2.\]

Going back to (74), this exponentially dominates the upper bound of \((\bm{\bar{p}}^{\rm mm},\bm{\bar{v}}^{\rm mm})\) whenever \(rMT\exp(-\Xi R)<r\gamma\Gamma/2\), (that is, whenever \(R,r\) are sufficiently large), again concluding the proof.

### Proof of Theorem 6

We will prove this result in two steps. Our first claim restricts the optimization to the particular quadrant induced by \(\min_{t\neq\alpha_{i}}(\bm{k}_{i\alpha_{i}}-\bm{k}_{i})^{\top}\bm{p}_{R}\geq 0\) under the theorem's condition \(\mathbb{S}(\bm{K}_{i}\bm{p}_{R})_{\alpha_{i}}\to 1\).

**Lemma 12**: _Suppose \(\mathbb{S}(\bm{K}_{i}\bm{p}_{R})_{\alpha_{i}}\to 1\). Then, there exists \(R_{0}\) such that for all \(R\geq R_{0}\), we have that,_

\[\min_{t\neq\alpha_{i}}\ (\bm{k}_{i\alpha_{i}}-\bm{k}_{i})^{\top}\bm{p}_{R}\geq 0,\quad\text{for all}\quad i\in[n].\] (77)

**Proof.** Suppose the claim does not hold. Set \(\bm{s}_{i}^{R}=\mathbb{S}(\bm{K}_{i}\bm{p}_{R})\). Fix \(R_{0}\) such that \(\bm{s}_{i\alpha_{i}}^{R}\geq 0.9\) for all \(R\geq R_{0}\). On the other hand, there exists arbitrarily large \(R\) for which \((\bm{k}_{i\alpha_{i}}-\bm{k}_{i})^{\top}\bm{p}_{R}<0\) for some \(t\neq\alpha_{i}\in[T]\) and \(i\in[n]\). At this \((R,i,t)\) choices, we have that \(\bm{s}_{i}^{R}\geq\bm{s}_{i\alpha_{i}}^{R}\). Since \(\bm{s}_{i\alpha}^{R}+\bm{s}_{i\alpha_{i}}^{R}\leq 1\), we find \(\bm{s}_{i\alpha_{i}}^{R}<0.5\) which contradicts with \(\bm{s}_{i\alpha_{i}}^{R}\geq 0.9\).

Let \(\mathcal{Q}\) be the set of \(\bm{p}\) satisfying the quadrant constraint (77) - i.e. indices \((\alpha_{i})_{i=1}^{n}\) are selected. Let \(\bm{h}_{R}\) be the solution of regularization path of \((\bm{v},\bm{p})\) subject to the constraint \(\bm{p}\in\mathcal{Q}\). From Lemma 12, we know that, for some \(R_{0}\) and all \(R\geq R_{0}\), \(\bm{h}_{R}=\bm{p}_{R}\). Thus, if the limit exists, we have that \(\lim_{R\to\infty}\bm{h}_{R}/R=\lim_{R\to\infty}\bm{p}_{R}/R\).

To proceed, we will prove that \(\lim_{R\to\infty}\bm{h}_{R}/R\) exists and is equal to \(\bm{p}^{\rm relax}/\|\bm{p}^{\rm relax}\|\) and simultaneously establish \(\bm{v}_{r}/r\to\bm{v}^{\rm mm}/\|\bm{v}^{\rm mm}\|\).

**Lemma 13**: \(\lim_{R\to\infty}\bm{h}_{R}/R=\bm{p}^{\rm relax}/\|\bm{p}^{\rm relax}\|\) _and \(\lim_{r\to\infty}\bm{v}_{r}/r=\bm{v}^{\rm mm}/\|\bm{v}^{\rm mm}\|\)._

**Proof.** The proof will be similar to that of Theorem 5. As usual, we aim to show that SVM-solutions constitute the most competitive direction. Set \(\Xi=1/\|\bm{p}^{\rm relax}\|\).

\(\bullet\)**Case 1: \(\bm{h}_{R}/R\) does not converge.** Under this scenario there exists \(\delta,\gamma=\gamma(\delta)>0\) such that we can find arbitrarily large \(R\) with \(\|\bm{h}_{R}/R-\Xi\bm{p}^{\rm relax}\|\geq\delta\). This implies that margin induced by \(\bm{h}_{R}/R\) is at most \(\Xi(1-\gamma)\) over the support vectors \(\mathcal{S}\) (from strong convexity of (10)). The reason is that, \(\bm{h}_{R}\) satisfies \(\bm{h}_{R}^{\top}(\bm{k}_{i\alpha_{i}}-\bm{k}_{i})\geq 0\) for all \(t\neq\alpha_{i}\) by construction as \(\bm{h}_{R}\in\mathcal{Q}\). Thus, a constraint over the support vectors have to be violated (when normalized to the same \(\ell_{2}\) norm as \(\|\bm{p}^{\rm relax}\|=1/\Xi\)).

As usual, we will construct a solution strictly superior to \(\bm{h}_{R}\) and contradicts with its optimality.

**Construction of competitor:** Rather than using \(\bm{p}^{\rm relax}\) direction, we will choose a slightly deviating direction that ensures the selection of the correct tokens over non-supports \(\tilde{\mathcal{S}}\). Specifically, consider the solution of (10) where we tighten the non-support constraints by arbitrarily small \(\epsilon>0\).

\[\bm{p}^{\epsilon\cdot t\mathbb{x}}=\arg\min_{\bm{p}}\|\bm{p}\|\quad\text{such that}\quad\bm{p}^{\top}(\bm{k}_{i\alpha_{i}}-\bm{k}_{i})\geq\begin{cases}1& \text{for all}\quad t\neq\alpha_{i},\ i\in\mathcal{S}\\ \epsilon&\text{for all}\quad t\neq\alpha_{i},\ i\in\tilde{\mathcal{S}}\end{cases}.\] (78)Let \(\bm{p}^{mm}\) be the solution of (ATT-SVM) with \(\bm{\alpha}=(\alpha_{i})_{i=1}^{n}\) (which was assumed to be separable). Observe that \(\bm{p}^{mm}_{\epsilon}=\epsilon\bm{p}^{mm}+(1-\epsilon)\bm{p}^{\epsilon\text{ max}}_{i}\) satisfies the constraints of (78). Additionally, \(\bm{p}^{mm}_{\epsilon}\) would achieve a margin of \(\frac{\Delta}{(1-\epsilon)/\Xi+\epsilon/\Delta}=\frac{\Delta\Xi}{\Delta+ \epsilon(\Xi-\Delta)}\) where \(\Delta=1/\|\bm{p}^{mm}\|\). Using optimality of \(\bm{p}^{\epsilon\text{-}t\text{rk}}\), this implies that the reduced margin \(\Xi_{\epsilon}=1/\|\bm{p}^{\epsilon\text{-}t\text{rk}}\|\) (by enforcing \(\epsilon\) over non-support) over the support vectors is a Lipschitz function of \(\epsilon\). That is \(\Xi_{\epsilon}\geq\Xi-\epsilon M\) for some \(M\geq 0\). To proceed, choose an \(\epsilon>0\) such that, it is strictly superior to margin induced by \(\bm{h}_{R}\), that is,

\[\Xi_{\epsilon}\geq\Xi\left(1-\frac{\gamma}{2}\right).\]

To proceed, set \(\tilde{\bm{p}}^{\epsilon\text{-}t\text{rk}}=R\Xi_{\epsilon}\bm{p}^{\epsilon \text{-}t\text{rk}}\). Let us recall the following notation from the proof of Theorem 5: \(\bm{s}^{p}_{i}=\mathbb{S}(\bm{K}_{i}\bm{p})\) and \(\bm{q}^{p}_{i}=1-\bm{s}_{i_{0}}\). Set \(\hat{q}_{\max}=\max_{i\in\mathcal{S}}q^{\bm{h}_{R}}_{i}\) to be worst non-optimality of \(\bm{h}_{R}\) over **support set**. Similarly, define \(q^{\star}_{\max}=\max_{i\in\mathcal{S}}q^{\bm{p}^{\epsilon\text{-}t\text{rk}}}_ {i}\) to be the same for \(\tilde{\bm{p}}^{\epsilon\text{-}t\text{rk}}\). Repeating the identical arguments to (71), (72), (73), and using the fact that \(\bm{p}^{\epsilon\text{-}t\text{rk}}\) achieves a margin \(\Xi(1-\frac{\gamma}{2})\leq\Xi_{\epsilon}\leq\Xi\), we end up with the lines

\[\log(\hat{q}_{\max}) \geq-(1-\gamma)\Xi R-\log T,\] (79a) \[-\Xi R-\log T\leq\log(q^{\star}_{\max}) \leq-\Xi(1-0.5\gamma)R+\log T.\] (79b)

In what follows, we will prove that \(\tilde{\bm{p}}^{\epsilon\text{-}t\text{rk}}\) achieves a strictly smaller logistic loss contradicting with the optimality of \(\bm{p}_{R}\) (whenever \(\|\bm{h}_{R}/R-\Xi\bm{p}^{\epsilon\text{relax}}\|\geq\delta\)).

**Upper bounding logistic loss.** Let us now upper bound the logistic loss of \((\tilde{\bm{v}}^{mm},\tilde{\bm{p}}^{\epsilon\text{-}t\text{rk}})\) where \(\tilde{\bm{v}}^{mm}=r\Gamma\bm{v}^{mm}\) with \(\bm{v}^{mm}\) being the solution of (SVM) with \(\bm{r}_{i}\leftarrow\bm{x}_{i_{\alpha}}\) and \(\Gamma=1/\|\bm{v}^{mm}\|\). Set \(\bm{r}_{i}=\bm{X}_{i}^{\top}\mathbb{S}(\bm{K}_{i}\tilde{\bm{p}}^{\epsilon \text{-}t\text{rk}})\). Set \(\nu=\min_{i\in\mathcal{S}}Y_{i}\cdot\bm{x}_{i_{\alpha}}^{\top}\bm{v}^{mm}-1\) to be the additional margin buffer that non-support vectors have access to. Also set \(M=\sup_{t\in[n],t\in[\gamma]}\|\bm{x}_{it}-\bm{x}_{it}\|\). Observe that we can write

\[\bm{x}_{i_{\alpha_{i}}}-\bm{r}_{i}=\sum_{t\neq\alpha_{i}}\bm{s}_{i_{\alpha}}( \bm{x}_{i_{\alpha_{i}}}-\bm{x}_{it})\implies\|\bm{x}_{i_{\alpha_{i}}}-\bm{r}_{ i}\|\leq q_{i}M.\]

Non-supports achieve strong label-margin: Using above and (78) for all \(i\in\tilde{\mathcal{S}}\) and \(t\neq\alpha_{i}\), we have that \(\bm{s}_{it}\leq e^{-\epsilon\Xi,R}\bm{s}_{i_{\alpha_{i}}}\leq e^{-\epsilon\Xi (1-\gamma/2)R}\bm{s}_{i_{\alpha_{i}}}\). Consequently, whenever \(R\geq\bar{R}_{0}:=(\epsilon\Xi(1-\gamma/2))^{-1}\log(\frac{TM}{\Gamma\nu})\),

\[q^{\tilde{\bm{p}}^{\epsilon\text{-}t\text{rk}}}_{i}\leq\frac{\sum_{t\neq \alpha_{i}}\bm{s}_{it}}{\bm{s}_{i_{\alpha_{i}}}}\leq Te^{-\epsilon\Xi(1- \gamma/2)R}\leq\frac{\Gamma\nu}{M}.\]

This implies that, on \(i\in\tilde{\mathcal{S}}\)

\[Y_{i}\cdot\bm{r}_{i}^{\top}\bm{v}^{mm}\geq 1+\nu+Y_{i}\cdot(\bm{r}_{i}-\bm{x}_{ i_{\alpha}})^{\top}\bm{v}^{mm}\geq 1+\nu-q_{i}M\|\bm{v}^{mm}\|\geq 1.\] (80)

_In words:_ Above a fixed \(\bar{R}_{0}\) that only depends on \(\gamma=\gamma(\delta)\), features \(\bm{r}_{i}\) induced by all non-support indices \(i\in\tilde{\mathcal{S}}\) achieve margin at least \(1\). What remains is analyzing the margin shrinkage over the support vectors as in Theorem 5.

Controlling support margin and combining bounds: Over \(\mathcal{S}\), suppose \(\bm{v}^{mm}\) satisfies the SVM constraints on \(\bm{r}_{i}\) with \(Y_{i}\cdot\bm{r}_{i}^{\top}\bm{v}^{mm}\geq 1-\epsilon_{i}/\Gamma\). Consequently, setting \(\epsilon_{\max}=\sup_{i\in[n]}\epsilon_{i}\), \(\bm{v}^{mm}\) achieves a label-margin of \(\Gamma-\epsilon_{\max}\) on the dataset \((Y_{i},\bm{r}_{i})_{i\in[n]}\). Next, we recall the fact (79b) that worst-case perturbation is \(\epsilon_{\max}\leq M\exp(-\Xi(1-0.5\gamma)R+\log T)=MT\exp(-\Xi(1-0.5\gamma)R)\). With this and (80), we upper bound the logistic loss of \((\tilde{\bm{v}}^{mm},\tilde{\bm{p}}^{\epsilon\text{-}t\text{rk}})\) as follows.

\[\mathcal{L}(\tilde{\bm{v}}^{mm},\tilde{\bm{p}}^{mm}) \leq\max_{i\in[n]}\log(1+\exp(-Y_{i}\bm{r}_{i}^{\top}\tilde{\bm{v}}^{ mm})).\] \[\leq\max_{i\in[n]}\exp(-Y_{i}\bm{r}_{i}^{\top}\tilde{\bm{v}}^{mm})\] \[\leq\exp(-r\Gamma+r\epsilon_{\max})\] \[\leq e^{\epsilon MT\exp(-\Xi(1-0.5\gamma)R)}e^{-r\Gamma}.\] (81)

Conversely, we obtain a lower bound for \((\bm{v}_{r},\bm{h}_{R})\). Set \(\bm{r}_{i}=\bm{X}_{i}^{\top}\mathbb{S}(\bm{K}_{i}\bm{h}_{R})\). Recall the lower bound (79a) over the support vector set \(\mathcal{S}\). Combining this with our Assumption C over the support vectors

[MISSING_PAGE_EMPTY:43]

**Assumption D (Mixing non-optimal tokens hurt)**: _There exists sets \((\bm{O}_{i})_{i=1}^{n}\subset[T]\) as follows. Let \(q_{i}^{p}=\sum_{\bm{v}\in\tilde{\mathcal{O}}_{i}}\bm{s}_{i}^{p}\) be the sum of softmax similarities over the non-optimal set for \(\bm{p}\). Set \(q_{\max}^{p}=\max_{i\in[n]}q_{i}^{p}\). For any \(\Delta>0\), there exists \(\rho<0\) such that:_

\[\text{For all }\bm{p},\bm{p}^{\prime}\in\mathbb{R}^{d},\ \ \text{if}\ \ \log(q_{\max}^{p}) \leq(1+\Delta)\log(q_{\max}^{p^{\prime}})\wedge\rho,\ \ \text{ then }\mathcal{L}(\bm{p})<\mathcal{L}(\bm{p}^{\prime}).\]

This assumption is titled _mixing hurts_ because the attention output \(\bm{X}_{i}^{\top}s_{i}^{p}\) is mixing the tokens of \(\bm{X}_{i}\) and our condition is that, to achieve optimal risk, this mixture should not contain any non-optimal tokens. In particular, we require that, a model \(\bm{p}\) that contains _exponentially less non-optimality_ (quantified via \(\log(q_{\max})\)) compared to \(\bm{p}^{\prime}\) is strictly preferable. As we discuss in the supplementary material, Theorem 1 is in fact a concrete instance (with linear head \(\bm{v}\)) satisfying this condition.

Before stating our generic theorem, we need to introduce the max-margin separator towards which regularization path of attention will converge. This is a slightly general version of Section 2's (ATT-SVM) problem where we allow for a set of optimal tokens \(\mathcal{O}_{i}\) for each input.

\[\bm{p}^{\text{mm}}=\arg\min_{\bm{p}}\|\bm{p}\|\quad\text{subject to}\quad\max_{ \alpha\in\mathcal{O}_{i}}\min_{\beta\in\mathcal{O}_{i}}\bm{p}^{\top}(\bm{k}_{ i\alpha}-\bm{k}_{i\beta})\geq 1,\quad\text{for all}\quad i\in[n].\] (ATT-SVM')

Unlike (ATT-SVM), this problem is not necessarily convex when the optimal set \(\mathcal{O}_{i}\) is not a singleton. To see this, imagine \(n=d=1\) and \(T=3\): Set the two optimal tokens as \(\bm{k}_{1}=1\) and \(\bm{k}_{2}=-1\) and the non-optimal token as \(\bm{k}_{3}=0\). The solution set of (ATT-SVM') is \(\bm{p}^{\text{mm}}\in\{-1,1\}\) whereas their convex combination \(\bm{p}=0\) violates the constraints. To proceed, our final result establishes the convergence of regularization path to the solution set of (ATT-SVM') under Assumption D.

**Theorem 8**: _Let \(\mathcal{G}^{\text{mm}}\) be the set of global minima of (ATT-SVM'). Suppose its margin \(\Xi:=1/\|\bm{p}^{\text{mm}}\|>0\) and Assumption D holds. Let \(\texttt{dist}(\cdot,\cdot)\) denote the \(\ell_{2}\)-distance between a vector and a set. Following (83), define \(\bar{\bm{p}}(R)=\arg\min_{|\bm{p}|\leq R}\mathcal{L}(\bm{p})\). We have that \(\lim_{R\to\infty}\texttt{dist}\left(\frac{\bar{\bm{p}}(R)}{\Xi R},\mathcal{G}^ {\text{mm}}\right)=0\)._

We note that Theorem 1 is a corollary of this result where \(\mathcal{O}_{i}\)'s and \(\mathcal{G}^{\text{mm}}\) are singleton. Based on this result, with multiple optimal tokens, Theorem 1 would gracefully generalize to solve (ATT-SVM').

### Proof of Theorem 8

**Proof.** The key idea is showing that, thanks to the exponential tail of softmax-attention, (harmful) contribution of the non-optimal token with the minimum margin can dominate the contribution of all other tokens as \(R\to\infty\). This high-level approach is similar to earlier works on implicit bias of gradient descent with logistic loss [31, 22].

Pick \(\bm{p}^{\text{mm}}\in\mathcal{G}^{\text{mm}}\) and set \(\bm{p}_{R}^{\star}=R\frac{\bm{p}^{\text{mm}}}{\|\bm{p}^{\text{mm}}\|}\). This will be the baseline model that \(\bm{p}_{R}\) has to compete against. Also let \(\bar{\bm{p}}_{R}=\frac{\bm{p}_{R}}{\Xi R}\). Now suppose \(\texttt{dist}(\bar{\bm{p}}_{R},\mathcal{G}^{\text{mm}})\to 0\) as \(R\to\infty\). Then, there exists \(\delta>0\) such that, we can always find arbitrarily large \(R\) obeying \(\texttt{dist}(\bar{\bm{p}}_{R},\mathcal{G}^{\text{mm}})\geq\delta\).

Since \(\bar{\bm{p}}_{R}\) is \(\delta>0\) bounded away from \(\mathcal{G}^{\text{mm}}\), and \(\|\bar{\bm{p}}_{R}\|=\|\bm{p}^{\text{mm}}\|\), \(\bar{\bm{p}}_{R}\) strictly violates at least one of the inequality constraints in (ATT-SVM'). Otherwise, we would have \(\bar{\bm{p}}_{R}\in\mathcal{G}^{\text{mm}}\). Without losing generality, suppose \(\bar{\bm{p}}_{R}\) violates the first margin constraint, that is, for some \(\gamma:=\gamma(\delta)>0\), \(\max_{\alpha\in\mathcal{O}_{1}}\min_{\beta\in\mathcal{O}_{1}}\bar{\bm{p}}_{R}^ {\star}(\bm{k}_{1\alpha}-\bm{k}_{\beta})\leq 1-\gamma\). Now, we will argue that this will lead to a contradiction as \(R\to\infty\) since we will show that \(\mathcal{L}(\bm{p}_{R}^{\star})<\mathcal{L}(\bm{p}_{R})\) for sufficiently large \(R\).

First, let us control \(\mathcal{L}(\bm{p}_{R}^{\star})\). We study \(\bm{s}_{i}^{\star}=\mathbb{S}(\bm{k}_{i}\bm{p}_{R}^{\star})\) and let \(\alpha_{i}\in\mathcal{O}_{i}\) be the index \(\alpha\) in (ATT-SVM') for which \(\operatorname{margin}_{i}=\max_{\alpha\in\mathcal{O}_{i}}\min_{\beta\in\mathcal{O }_{i}}(\bm{k}_{i\alpha}-\bm{k}_{i\beta})^{\top}\bm{p}^{\text{mm}}\geq 1\) is attained. Then, we bound the non-optimality amount \(q_{i}^{\star}\) of \(\bm{p}_{R}^{\star}\) as

\[q_{i}^{\star}=\frac{\sum_{\bm{v}\in\mathcal{O}_{i}}\exp(\bm{k}_{i}^{\top}\bm{p}_ {R}^{\star})}{\sum_{t\in[T]}\exp(\bm{k}_{i}^{\top}\bm{p}_{R}^{\star})}\leq \frac{\sum_{\bm{v}\in\mathcal{O}_{i}}\exp(\bm{k}_{i\alpha_{i}}^{\top}\bm{p}_{R}^{ \star})}{\exp(\bm{k}_{i\alpha_{i}}^{\top}\bm{p}_{R}^{\star})}\leq T\exp(-\Xi R).\]

Thus, \(q_{\max}^{\star}=\max_{\bm{v}\in[n]}q_{i}^{\star}\leq T\exp(-\Xi R)\). Secondly, we wish to control \(\mathcal{L}(\bm{p}_{R})\) by lower bounding the non-optimality in \(\bm{p}_{R}\). Focusing on the first margin constraint, let \(\alpha\in\mathcal{O}_{1}\) be the index in (ATT-SVM') for which \(\operatorname{margin}_{1}\leq 1-\gamma\) is attained. Denoting the amount of non-optimality of the first input as \(\hat{q}_{1}\), we find7

Footnote 7: Here, we assumed margin is non-negative i.e. \(\bm{k}_{1\alpha}^{\top}\bm{p}_{R}\geq\sup_{\eta\in\mathcal{O}_{1}}\bm{k}_{1 \alpha}^{\top}\bm{p}_{R}\). Otherwise, \(\sup_{\bm{v}\in\mathcal{T}}k_{1\alpha}^{\top}\bm{p}_{R}\) is attained in \(\tilde{Q}_{1}\) which implies \(\hat{q}_{1}\geq T^{-1}\). Thus, we can still use the identical inequality (84) with the choice \(\gamma=1\).

\[\hat{q}_{1}=\frac{\sum_{\bm{v}\in\tilde{\mathcal{O}}_{1}}\exp(\bm{k}_{1\mu}^{ \top}\bm{p}_{R})}{\sum_{t\in[T]}\exp(\bm{k}_{1\mu}^{\top}\bm{p}_{R})}\geq \frac{1}{T}\frac{\sum_{\bm{v}\in\tilde{\mathcal{O}}_{1}}\exp(\bm{k}_{1\mu}^{ \top}\bm{p}_{R})}{\exp(\bm{k}_{1\alpha}^{\top}\bm{We similarly have \(q^{\star}_{\max}\geq T^{-1}\exp(-\Xi R)\). In conclusion, for \(\bm{p}_{R},\bm{p}^{\star}_{R}\), denoting maximum non-optimality by \(\hat{q}_{\max}\geq\hat{q}_{1}\) and \(q^{\star}_{\max}\), we respectively obtained

\[\log(\hat{q}_{\max}) \geq-(1-\gamma)(\Xi R)-\log T,\] \[-(\Xi R)-\log T\leq\log(q^{\star}_{\max}) \leq-(\Xi R)+\log T.\] (84)

The above inequalities satisfy Assumption D as follows where \(\bm{p}\leftarrow\bm{p}^{\star}_{R}\) and \(\bm{p}^{\prime}\leftarrow\bm{p}_{R}\): Set \(R_{0}=3\gamma^{-1}\Xi^{-1}\log T\) so that \(\log T=\frac{\gamma\Xi R_{0}}{3}\). Secondly, set \(\rho_{0}=-\Xi R_{0}-\log T\). This way, \(\rho_{0}\geq\log(q^{\star}_{\max})\) implies \(R\geq R_{0}\) and \(\log T\leq\frac{\gamma\Xi R}{3}\). Using the latter inequality, we bound the \(\log T\) terms to obtain

* \(\log(\hat{q}_{\max})\geq-(1-2\gamma/3)(\Xi R)\), and
* \(\log(q^{\star}_{\max})\leq-(1-\gamma/3)(\Xi R)\).

To proceed, we pick \(1+\Delta=\frac{1-\gamma/3}{1-2\gamma/3}\) implying \(\Delta:=\frac{\gamma}{3-2\gamma}\). Finally, for this \(\Delta\), there exists \(\rho(\Delta)\) which we need to ensure \(\log(\hat{q}_{\max})\leq\rho(\Delta)\). This can be guaranteed by picking sufficiently large \(R\) that ensures \(\log(q^{\star}_{\max})\leq-(1-\gamma/3)(\Xi R)\leq\rho(\Delta)\) to satisfy all conditions of Assumption D. Since such large \(R\) exists by initial assumption \(\texttt{dist}\left(\tilde{\bm{p}}_{R},\mathcal{G}^{\text{mm}}\right)\to 0\), Assumption D in turn implies that \(\mathcal{L}(\bm{p}^{\star}_{R})<\mathcal{L}(\bm{p}_{R})\) contradicting with the optimality of \(\bm{p}_{R}\) in (83). 

### Application to Linearly-mixed Labels

The following example shows that if non-optimal tokens result in reduced score (in terms of the alignment of prediction and label), Assumption D holds. The high-level idea behind this lemma is that, if the optimal risk is achieved by setting \(q^{\bm{p}}_{\max}=0\), then, Assumption D will hold.

**Lemma 14** (Linear label mixing): _Recall \(q^{\bm{p}}_{i}=\sum_{t\in\partial_{i}}\bm{s}^{\bm{p}}_{it}\) from Assumption D. Suppose \(Y_{i}\in\{-1,1\}\) and_

\[Y_{i}\cdot\psi(\bm{X}^{\top}_{i}\bm{s}^{\bm{p}}_{i})=\nu_{i}(1-q^{\bm{p}}_{i} )+Z_{i},\]

_for some \((\nu_{i})_{i=1}^{n}>0\). Here \(Z_{i}=Z_{i}(\bm{p})\) is the contribution of non-optimal tokens to prediction. For some \(\mathcal{C},\epsilon>0\) and for all \(\bm{p}\in\mathbb{R}^{d}\), assume_

\[-Cq^{\bm{p}}_{\max}\leq Z_{i}\leq(1-\epsilon)\nu_{i}q^{\bm{p}}_{i}.\] (85)

_Then, Assumption D holds for \(\mathcal{L}(\bm{p})=\frac{1}{n}\sum_{i=1}^{n}\ell(Y_{i}\cdot\psi(\bm{X}^{\top }_{i}\bm{s}^{\bm{p}}_{i}))\) when \(\ell(\cdot)\) is a strictly decreasing loss function with continuous derivative._

**Proof.** Recall the assumption \(Y_{i}\cdot\psi(\bm{X}^{\top}_{i}\bm{s}^{\bm{p}}_{i})=\nu_{i}(1-q^{\bm{p}}_{i} )+Z_{i}\) with \(Z_{i}\) obeying (85). Let us also write the loss function

\[\mathcal{L}(\bm{p})=\frac{1}{n}\sum_{i=1}^{n}\ell(\nu_{i}(1-s^{\bm{p}}_{i})+Z _{i}).\]

Define \(q^{\bm{p}}_{\max}=\sup_{i\leq[n]}q^{\bm{p}}_{i}\). Let \(M\) be the maximum absolute value of score over tokens. Let

\[B=\max_{|i|\leq M}-\ell^{\prime}(x)\geq A=\min_{|i|\leq M}-\ell^{\prime}(x)>0.\]

Through Taylor's Theorem (integral remainder), we have that

\[B(q^{\bm{p}}_{i}\nu_{i}-Z_{i})\geq\ell(\nu_{i}(1-q^{\bm{p}}_{i})+Z_{i})-\ell( \nu_{i})\geq A(q^{\bm{p}}_{i}\nu_{i}-Z_{i})\geq\epsilon Av_{i}q^{\bm{p}}_{i}.\]

Set \(\mathcal{L}_{\star}=\frac{1}{n}\sum_{i=1}^{n}\ell(\nu_{i})\). Set \(C_{+}=B(C+\max_{i\in[n]}\nu_{i})\) and \(C_{-}=n^{-1}A\epsilon\min_{i\in[n]}\nu_{i}\). This also implies

\[C_{+}q^{\bm{p}}_{\max}\geq\frac{1}{n}\sum_{i\in[n]}B(q^{\bm{p}}_{i }\nu_{i}-Z_{i})\geq\mathcal{L}(\bm{p})-\mathcal{L}_{\star} \geq\frac{1}{n}\sum_{i\in[n]}A(q^{\bm{p}}_{i}\nu_{i}-Z_{i})\] \[\geq\frac{1}{n}\sum_{i\in[n]}\epsilon A\nu_{i}q^{\bm{p}}_{i}\geq C _{-}q^{\bm{p}}_{\max}.\]

Thus, to prove \(\mathcal{L}(\bm{p}^{\prime})>\mathcal{L}(\bm{p})\), we simply need to establish the stronger statement \(C_{-}q^{\bm{p}^{\prime}}_{\max}>C_{+}q^{\bm{p}}_{\max}\).

Going back to the condition of Assumption D, any \(\log(q^{\bm{p}}_{\max})\leq(1+\Delta)\log(q^{\bm{p}}_{\max})\) obeys \(q^{\bm{p}}_{\max}\leq(q^{\bm{p}^{\prime}}_{\max})^{1+\Delta}\) i.e. \(q^{\bm{p}^{\prime}}_{\max}\geq(q^{\bm{p}^{\prime}}_{\max})^{(1+\Delta)^{-1}}\). Following above, we wish to ensure \(q^{\bm{p}^{\prime}}_{\max}>\Theta q^{\bm{p}}_{\max}\) for such \((\bm{p},\bm{p}^{\prime})\) pairs where \(\Theta=C_{+}/C_{-}>1\). This is guaranteed by

\[(q^{\bm{p}}_{\max})^{(1+\Delta)^{-1}-1}>\Theta\iff\frac{\Delta}{1+\Delta}\log (q^{\bm{p}}_{\max})<-\log(\Theta).\]

The above is satisfied by choosing a \(\rho(\Delta):=-2(1+\Delta^{-1})\log(\Theta)\) in Assumption D. Thus, all \(\bm{p},\bm{p}^{\prime}\) with \(\log(q^{\bm{p}}_{\max})\leq\rho=\rho(\Delta)\) satisfies the condition of Assumption D finishing the proof. 

## Appendix E Implementation Details and Additional Experiments

In this section, we provide implementation details and additional experiments.

\(\bullet\) We build one attention layer using PyTorch. During training, we use SGD optimizer with learning rate 0.1 and train the model for 1000 iterations. To better visualize the convergence path, we normalize the gradient of \(\bm{p}\) (and \(\bm{v}\)) at each iteration.

\(\bullet\) Next, given the gradient solution \(\bm{p}\), we determine locally-optimal indices to be those with the highest softmax scores. Using these optimal indices, we utilize python package cvxopt to build and solve (ATT-SVM), and then get solution \(\bm{p}^{mm}\). After obtaining \(\bm{p}^{mm}\), we also verify that these indices satisfy our local-optimal definition. The examples we use in the paper are all trivial to verify (by construction).

\(\bullet\) In Figures 3(a) and 3(b), \(\bm{v}^{mm}\) (blue dashed) is solved using python package sklearn.svm via (SVM) based on the given label information, and red dashed line represents \(\bm{p}^{relax}\) direction instead, which is the solution of (10). Note that in both figures, \(\bm{v}^{mm}/\|\bm{v}^{mm}\|=[0,1]\). Therefore, in Figure 3(a) all optimal tokens are support vectors and \(\bm{p}^{relax}=\bm{p}^{mm}\). Whereas in Figure 3(b), yellow \(\star\) is not a support vector and only needs to satisfy positive correlation with \(\bm{p}\). Gray dashed line displays the \(\bm{p}^{mm}\) direction.

**Failure of gradient descent's global convergence when \(n\geq 2\) (refer to Theorem 2)**. Figure 8 provides a counter-example demonstrating that the \(n=1\) restriction is indeed necessary and tight to guarantee global convergence of the gradient descent iterates \(\bm{p}(t+1)=\bm{p}(t)-\eta\nabla\mathcal{L}(\bm{p}(t))\) on (ERM). For this example, we use logistic loss in (ERM). We set \(n=T=d=2\), implying that there is only one non-optimal token, thus Assumption B is satisfied. The red and blue lines represent GMM and LMM solutions, respectively. We note that the green star and teal square indicate the locally-optimal tokens. Specifically, referring to the local optimality definition (Definition 2), for LMM solution (\(\bm{p}^{mm}\)) represented by the blue line, the square teal token does not have any SVM-neighbors. The arrows indicate the two trajectories originating from different initializations. This demonstrates that the gradient descent iterates \(\bm{p}(t+1)=\bm{p}(t)-\eta\nabla\mathcal{L}(\bm{p}(t))\) on (ERM) with two different initializations converge to two different SVM solutions (GMM and LMM). Results validate the necessity of \(n=1\) in Theorem 2 to provide the gradient descent convergence to \(\bm{p}^{mm\star}\) from any initialization.

**The convergence behavior of gradient descent under over-parameterization.** To illustrate Theorems 3 & 4, we have investigated the convergence behavior of \(\bm{p}(t)\) generated by gradient descent in Figure 9(a), using \(n=4\), \(T=6\), and conducted 1,000 random trials for varying \(d\in\{2,5,10,100,300,500\}\). These experiments use normalized gradient descent with learning rate 1 for 1000 iterations. Inputs \(\bm{x}_{it}\) and the linear head \(\bm{v}\) are uniformly sampled from the unit sphere, while \(Y_{i}\) is uniformly \(\pm 1\), and \(\bm{W}\) is set to \(\bm{I}\).

The bar plot in Figure 9(a) distinguishes between _non-saturated_ softmax (red bars) and _saturated_ softmax (other bars). Saturation is defined as average softmax probability over tokens selected by gradient descent are at least \(1-10^{-5}\) and implies that attention selects one token per input. Note that, whenever the norm of gradient descent solution is finite, softmax will be non-saturated. For

Figure 8: The convergence behavior of the gradient descent on the attention weights \(\bm{p}\) using the logistic loss in (ERM) with \(n=T=d=2\).

small \(d\) (e.g., \(d=2\)), problem has small degrees of freedom to separate optimal tokens from the rest (i.e. no SVM solution for LMM directions) - especially due to label randomness. This results in a tall red bar capturing the finite-norm solutions. However, for larger \(d\), we observe that softmax saturates (i.e. \(\|\bm{p}(t)\|\to\infty\)) and we observe that the selected tokens \(\bm{\alpha}\) almost always converges to an LMM direction (blue bar) - this is in line with Theorems 3 & 4. We also study the convergence to the globally-optimal GMM which is represented by the green bar: GMM is a strict subset of LMM however as \(d\) increases, we observe that the probability of GMM convergence increases as well. This behavior is in line with what one would expect from over-parameterized deep learning theory [57, 58, 59, 60] and motivates future research. The average correlation coefficient between \(\bm{p}(t)\) and its associated LMM/GMM direction is \(0.997\), suggesting that, whenever softmax saturates, gradient descent indeed directionally converges to a LMM solution \(\bm{p}\in\mathcal{P}^{mm}\), confirming Theorem 4.

Furthermore, we found that there exist problem instances, with saturated softmax and \(\|\bm{p}(t)\|\to\infty\), that do not converge to either LMM or GMM. We analyzed this phenomenon using the minimum score gap, \(\gamma:=\min_{i\in[n]\in\mathcal{T}_{i}}\gamma_{i\alpha_{i}}-\gamma_{i}\), where \(\mathcal{T}_{i},i\in[n]\), represents the sets of SVM-neighbor tokens. Figure 9(b) provides the probability distribution of \(\underline{\gamma}\) (with bins of width \(<0.01\)) and demonstrates the rarity of such cases. Specifically, we found this happens less than \(1\%\) of the problems, that is, \(\text{Prob}(\underline{\gamma}<0)<0.01\). Figure 9(b) also reveals that, in these scenarios, even if \(\underline{\gamma}<0\), it is typically close to zero i.e. even if there exists a SVM-neighbor with a higher score, it is only slightly so. This is not surprising since when token scores are close, we need a large number of gradient iterations to distinguish them. For all practical purposes, the optimization will treat both tokens equally and rather than solving (ATT-SVM), the more refined formulation (ATT-SVM') developed in Section D will be a better proxy. Confirming this intuition, we have verified that, over the instances \(\underline{\gamma}<0\), gradient descent solution is still \(>0.99\) correlated with the max-margin solution in average.

\(\bullet\) In Figure 9, we again applied normalized gradient descent with a learning rate equal to \(1\). Each trial involved randomly generated data and training for \(1000\) iterations as discussed in Theorem 4. The tokens selected by \(\bm{p}\) were denoted as \((\alpha_{i})_{i=1}^{n}\), where \(\alpha_{i}=\arg\max_{i\in[T]}\mathbb{S}(\bm{X}_{i}\bm{p})_{i}\). The averaged softmax probabilities were calculated as \(\bar{s}:=\frac{1}{n}\sum_{i=1}^{n}\mathbb{S}(\bm{X}_{i}\bm{p})_{\alpha_{i}}\) (same as Figure 3(c)). The red bars in Figure 9(b) represent the values of \(\mathbb{P}(\bar{s}\leq 1-10^{-5})\) for each choice of \(d\). Figure 10 displays the cumulative probability distribution of \(\underline{\gamma}\) from Figure 9(b), with the gray dashed line indicating \(\underline{\gamma}=0\). From this figure, we observe that the minimal score gap exhibit a sharp transition at zero (\(<\)1% of the instances have \(\underline{\gamma}<0\)), demonstrating that, in most random problem instances with \(\|\bm{p}\|\to\infty\) (\(\bar{s}\to 1\)), problem directionally converges to an LMM i.e. \(\bm{p}(t)/\|\bm{p}(t)\|\to\bm{p}^{mm}/\|\bm{p}^{mm}\|\). We believe the rare occurrence of a negative score gap is due to small score differences (so that optimal token is not clearly distinguished) and finite number of gradient iterations we run. Interestingly, even in the negative score gap scenarios, gradient descent is aligned with \(\bm{p}^{mm}(\bm{\alpha})\) (even if \(\bm{p}^{mm}(\bm{\alpha})\) is not LMM) which can be predicted from our Section D which handles the scenario where there are multiple optimal tokens per input.

## Appendix F Addendum to Section 5

We provide an overview of the current literature on implicit regularization and attention mechanism.

### Related Work on Implicit Regularization

The introduction of Support Vector Machines (SVM), which utilize explicit regularization to choose maximum margin classifiers, represents one of the earliest relevant literature in this field [61]. The concept of maximizing the margin was later connected to generalization performance [62]. From a practical perspective, exponential losses with decaying regularization exhibit asymptotic behavior similar to SVMs, as demonstrated in [22]. While the analysis of the perceptron [63] originally introduced the concept of margins, the method itself does not possess an inherent bias as it terminates with zero classification error. However, establishing a meaningful lower bound for the attained margin is not possible. Initial empirical investigations highlighting the implicit bias of descent methods focused on \(\ell_{1}\)-regularization, revealing that coordinate descent, when combined with the exponential loss, exhibits an inherent inclination towards \(\ell_{1}\)-regularized solutions [64].

This work draws extensively from the literature on implicit bias and regularization, which has provided valuable techniques and inspiration. A common observation in these studies is the convergence to a specific optimal solution over the training set. This phenomenon has been observed in various approaches, including coordinate descent [65, 66], gradient descent [30, 67, 25, 68, 69, 22, 70], deep linear networks [71, 72], ReLU networks [73, 74, 29, 75, 76], mirror descent [77, 78, 33, 36], and many others. The implicit bias of gradient descent in classification tasks involving separable data has been extensively examined by [22, 25, 26, 27, 28, 29]. The works on classification typically utilize logistic loss or exponentially-tailed losses to establish connections to margin maximization. The results have also been extended to non-separable data by [30, 31, 21]. Additionally, several papers have explored the implicit bias of stochastic gradient descent [37, 38, 41, 42], as well as adaptive and momentum-based methods [43, 44, 45, 46].

While there are some similarities between our optimization approach for \(\bm{v}\) and existing works, the optimization of \(\bm{p}\) presents notable differences. Firstly, our optimization problem is nonconvex and involves a composition of loss and softmax, which introduces new challenges and complexities. The presence of softmax adds a nonlinearity to the problem, requiring specialized techniques for analysis and optimization. Secondly, our analysis introduces the concept of locally-optimal tokens, which refers to tokens that achieve locally optimal solutions in their respective attention cones. This concept is crucial for understanding the behavior of the attention mechanism and its convergence properties. By focusing on the cones surrounding locally-optimal tokens, we provide a tailored analysis that captures the unique characteristics of the attention model. Overall, our work offers novel insights into the optimization of attention-based models and sheds light on the behavior of the attention mechanism during training.

### Related Work on Attention Mechanism

As the backbone of Transformers [6], the self-attention mechanism [47, 48, 49, 50] plays a crucial role in computing feature representations by globally modeling long-range interactions within the input. Transformers have achieved remarkable empirical success in various domains, including natural language processing [4, 2], recommendation systems [79, 80, 81], and reinforcement learning [82, 83, 84]. With the introduction of Vision Transformer (ViT) [85], Transformer-based models [86, 87] have become a strong alternative to convolutional neural networks (CNN) and become prevalent in vision tasks.

However, the theoretical foundation of Transformers and self-attention mechanisms has remained largely unexplored. Some studies have established important results, including the Lipschitz constant of self-attention [88], properties of the neural tangent kernel [89, 90], and the expressive power and Turing-completeness of Transformers [91, 92, 93, 51, 23, 94] with statistical guarantees [95, 96]. There is also a growing effort towards a theoretical understanding of emergent abilities of language models - such as in-context learning [97, 98, 99] and chain-of-thought [100, 101, 102] - which are inherently related to the models ability to attend to the relevant information within the input sequence.

Focusing on the self-attention component, Edelman et al. [51] theoretically shows that a single self-attention head can represent a sparse function of the input with a sample complexity for the generalization gap between the training loss and the test loss. However, they did not delve into the algorithmic aspects of training Transformers to achieve desirable loss. Sahiner et al. [52] and Ergen et al. [53] further explored the analysis of convex relaxations for self-attention, investigating potential optimization techniques and properties. The former work applies to self-attention with linear activation (rather than softmax) whereas the latter work attempts to approximate softmax via a linear operation with unit simplex constraints. In contrast, we directly study softmax and characterize its non-convex geometry. In terms of expressive ability, Baldi and Vershynin [54] investigated the capacity of attention layers to capture complex patterns and information, while Dong et al. [23] illustrates the propensity of attention networks to degenerate during the training process, with the result often being an output that is approximately a rank-1 matrix.

Recent works have made progress in characterizing the optimization and generalization dynamics of attention [55, 56, 103, 17, 104]. Jelassi et al. [55] studied gradient-based methods from random initialization and provided a theoretical analysis of the empirical finding that Vision Transformers learn position embeddings that recapitulate the spatial structure of the training data, even though this spatial structure is no longer explicitly represented after the image is split into patches. Li et al. [56] provided theoretical results on training three-layer ViTs for classification tasks. They quantified the importance of self-attention in terms of sample complexity for achieving zero generalization error, as well as the sparsity of attention maps when trained by stochastic gradient descent (SGD). In another related work, Nguyen et al. [104] proposed a primal-dual optimization framework that focuses on deriving attention as the dual expansion of a primal neural network layer. By solving a support vector regression problem, they gained a deeper understanding and explanation of various attention mechanisms. This framework also enables the creation of novel attention mechanisms, offering flexibility and customization in designing attention-based models. In another closely related work, Oymak et al. [17] analyzed the same attention model as ours, denoted by (ERM). Specifically, they jointly optimize \(\bm{v},\bm{p}\) for three gradient iterations for a contextual dataset model. This is in contrast to our emphasis on infinite-iteration behavior of \(\bm{p}\)-only optimization. However, it is important to note that all of these works make certain assumptions about the data. Specifically, they assume that tokens are tightly clusterable or can be clearly split into relevant and irrelevant sets. Additionally, Li et al. [56] require specific assumptions on the initialization of the model, while Jelassi et al. [55] consider a simplified attention structure where the attention matrix is not directly parameterized with respect to the input.

In contrast, our work offers a comprehensive optimization-theoretic analysis of the attention model, establishing a formal connection to max-margin problems. While comparable works make assumptions on the dataset model, our results apply under minimal assumptions for general data and realistic conditions. Our analysis based on max-margin-equivalence allows us to gain a deeper understanding of the optimization geometry of attention and its behavior during the training process. As articulated in our experiments, our results lead to novel insights even for \(n=1,2\) samples, \(T=2,3\) tokens and \(d=2\), 3 dimensions (in contrast to [55, 56, 103, 17]). Notably, our work also presents the first theoretical understanding of the implicit bias exhibited by gradient descent methods in the context of the attention model. We remark that recent work [105] expands the theory presented in this work to 1-layer transformers. By uncovering the underlying optimization principles and thoroughly characterizing the directional convergence of attention, we provide valuable insights into the dynamics and generalization properties of attention-based models opening the path for future research.